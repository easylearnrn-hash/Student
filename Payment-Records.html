<!doctype html>
<html lang="en">
  <!--
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  ARNOMA PAYMENT RECORDS MODULE v1.1.0                            â•‘
    â•‘  Glassmorphism + Neon Prism Hybrid Design                        â•‘
    â•‘  âš¡ PERFORMANCE OPTIMIZED                                         â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    âœ… Features:
    - Advanced filter toolbar (search, date range, method, type, group, amount)
    - Neon-glass card grid for payment display
    - Slide-in details panel with edit capabilities
    - Credit history timeline
    - Real-time statistics dashboard

    ðŸŽ¨ Design Language:
    - Glassmorphism + Neon Prism hybrid
    - Frosted glass cards with backdrop blur
    - Neon cyan/indigo/purple borders
    - Prism gradient backgrounds
    - 3D layered shadows
    - Smooth hover animations

    âš¡ Performance Optimizations:
    - Zero backdrop-blur on cards/panels (GPU-friendly)
    - Deferred jsPDF loading (only when needed)
    - Optimized data fetching (300 max records, 100 initial render)
    - GPU-accelerated animations (will-change hints)
    - 250ms search debounce (reduced CPU load)
    - Smart caching (5-min TTL)
    - Virtual scrolling via pagination
    
    ðŸ“ Note: For production, minify this file with:
       - CSS: cssnano or clean-css
       - JS: terser or uglify-js
       This will reduce file size by ~40-60%
-->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
    <meta name="version" content="1.1.0-performance" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>ARNOMA - Payment Records</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png">

  <!-- Supabase Configuration -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1"></script>
  <script src="shared-auth.js"></script>
    
  <!-- Flatpickr for Custom Dark Date Picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
  <!-- jsPDF for PDF Export - DEFERRED: Only needed when user clicks Export PDF button -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
      /* ðŸ”’ SECURITY: Hide page until admin verified */
      body {
        display: none !important;
        visibility: hidden !important;
      }
      
      body.admin-verified {
        display: block !important;
        visibility: visible !important;
      }
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* ============================================================
         MOBILE TOUCH OPTIMIZATIONS
         ============================================================ */
      @media (max-width: 768px) {
        /* Remove tap highlight on iOS */
        * {
          -webkit-tap-highlight-color: transparent;
          -webkit-touch-callout: none;
        }

        /* Smooth scrolling on mobile */
        html {
          -webkit-overflow-scrolling: touch;
        }

        /* Better touch targets */
        button, a, input, select, textarea {
          touch-action: manipulation;
        }

        /* Prevent text selection on interactive elements */
        button, .btn, .nav-btn {
          -webkit-user-select: none;
          user-select: none;
        }
      }

      /* ============================================================
         CORE ANIMATIONS
         ============================================================ */
      @keyframes breathe {
        0%,
        100% {
          opacity: 0.4;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.1);
        }
      }

      @keyframes prismGlow {
        0%,
        100% {
          box-shadow:
            0 0 20px rgba(102, 126, 234, 0.3),
            0 0 40px rgba(118, 75, 162, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        50% {
          box-shadow:
            0 0 30px rgba(102, 126, 234, 0.5),
            0 0 60px rgba(118, 75, 162, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes shimmer {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }

      /* ============================================================
         PERFORMANCE: CSS VARIABLES FOR BLUR OPTIMIZATION
         ============================================================ */
      :root {
        --panel-blur: 0px;      /* Headers, toolbars, navigation - OPTIMIZED: removed blur */
        --card-blur: 0px;       /* Payment cards, data cards - OPTIMIZED: removed blur */
        --modal-blur: 3px;      /* Modals, detail panels - OPTIMIZED: reduced from 14px */
        --list-blur: 0px;       /* List items, table rows */
      }

      /* ============================================================
         BASE LAYOUT
         ============================================================ */
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', sans-serif;
        background: linear-gradient(135deg, #0b0b10 0%, #1a1a2e 100%) !important;
        min-height: 100vh;
        padding: 12px;
        position: relative;
        overflow-x: hidden;
        color: rgba(255, 255, 255, 0.9);
      }

      /* Static gradient blobs (animation removed for GPU savings) */
      body::before {
        content: '';
        position: fixed;
        width: 800px;
        height: 800px;
        background: radial-gradient(circle, rgba(138, 180, 255, 0.1) 0%, transparent 70%);
        top: -300px;
        right: -200px;
        border-radius: 50%;
        filter: blur(100px);
        pointer-events: none;
        z-index: 0;
        animation: none;
      }

      body::after {
        content: '';
        position: fixed;
        width: 900px;
        height: 900px;
        background: radial-gradient(circle, rgba(168, 85, 247, 0.08) 0%, transparent 70%);
        bottom: -250px;
        left: -250px;
        border-radius: 50%;
        filter: blur(100px);
        pointer-events: none;
        z-index: 0;
        animation: none;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }

      /* ============================================================
         DATE RANGE PICKER
         ============================================================ */
      .date-picker-weekdays {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 6px;
        margin-bottom: 8px;
      }

      .date-picker-weekday {
        text-align: center;
        font-size: 10px;
        color: rgba(255, 255, 255, 0.6);
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .date-picker-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        grid-template-rows: repeat(6, 48px);
        gap: 6px;
        min-height: 288px;
      }

      .date-picker-day {
        appearance: none;
        -webkit-appearance: none;
        outline: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 12px;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: none;
        width: 100%;
        height: 100%;
        padding: 0;
        background-clip: padding-box;
      }

      .date-picker-day:hover:not(.is-placeholder) {
        background: rgba(138, 180, 255, 0.2);
        border-color: rgba(138, 180, 255, 0.5);
      }

      .date-picker-day.is-today:not(.is-selected) {
        border-color: rgba(138, 180, 255, 0.45);
      }

      .date-picker-day.is-range {
        background: rgba(138, 180, 255, 0.15);
        border-color: rgba(138, 180, 255, 0.35);
        box-shadow: 0 0 8px rgba(138, 180, 255, 0.2);
      }

      .date-picker-day.is-selected {
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.6), rgba(168, 85, 247, 0.6));
        border-color: rgba(138, 180, 255, 0.85);
        box-shadow:
          0 0 12px rgba(138, 180, 255, 0.6),
          0 0 20px rgba(138, 180, 255, 0.35);
        font-weight: 700;
      }

      .date-picker-day.is-placeholder {
        opacity: 0;
        pointer-events: none;
        border: none;
        background: transparent;
      }

      /* ============================================================
         GLASS HEADER
         ============================================================ */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding: 16px 20px;
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.08), rgba(99, 102, 241, 0.08));
        backdrop-filter: blur(var(--panel-blur));
        -webkit-backdrop-filter: blur(var(--panel-blur));
        border: 1px solid rgba(138, 180, 255, 0.2);
        border-radius: 20px;
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.05), transparent);
        pointer-events: none;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
        z-index: 1;
      }

      .header-icon {
        font-size: 24px;
        filter: drop-shadow(0 0 12px rgba(138, 180, 255, 0.6));
      }

      .header-info h1 {
        font-size: 20px;
        font-weight: 900;
        background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 2px;
        letter-spacing: -0.3px;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .header-subtitle {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.6);
        font-weight: 500;
      }

      .header-stats {
        display: flex;
        gap: 8px;
        position: relative;
        z-index: 1;
      }

      .stat-pill {
        padding: 6px 12px;
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.15), rgba(168, 85, 247, 0.15));
        backdrop-filter: blur(var(--panel-blur));
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 12px;
        font-size: 12px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.95);
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(138, 180, 255, 0.2);
      }

      .stat-pill.portal-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 20px;
        background: linear-gradient(135deg, #1d2141 0%, #2f1f55 100%);
        border: 1px solid rgba(99, 102, 241, 0.7);
        box-shadow: 0 6px 18px rgba(99, 102, 241, 0.4);
        text-decoration: none;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      }

      .stat-pill.portal-link:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 24px rgba(99, 102, 241, 0.55);
      }

      .stat-pill.portal-link:active {
        transform: translateY(0);
      }

      .stat-pill .stat-value {
        color: #8ab4ff;
        font-weight: 900;
      }

      /* Enhanced month stats visibility */
      .month-stats-container .stat-pill {
        padding: 10px 18px;
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.25), rgba(168, 85, 247, 0.25));
        border: 1px solid rgba(138, 180, 255, 0.5);
        box-shadow: 0 6px 20px rgba(138, 180, 255, 0.3);
      }

      .month-stats-container .stat-label {
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.7);
        margin-right: 6px;
      }

      .month-stats-container .stat-value {
        font-size: 16px;
        font-weight: 900;
        color: #3b82f6;
        text-shadow: 0 0 12px rgba(59, 130, 246, 0.6);
      }

      .month-stats-container .stat-value-usd {
        color: #3b82f6;
        text-shadow: 0 0 12px rgba(59, 130, 246, 0.6);
      }

      .month-stats-container .stat-value-amd {
        color: #3b82f6;
        text-shadow: 0 0 12px rgba(59, 130, 246, 0.6);
      }

      /* Blur effect for payment totals */
      .stat-value-blurred {
        filter: blur(8px);
        user-select: none;
        cursor: pointer;
        transition: filter 0.3s ease;
      }

      .stat-value-blurred:hover {
        filter: blur(6px);
      }

      .month-stats-container .search-pill {
        flex: 1.5;
        padding: 8px 14px;
      }

      .month-stats-container .search-input-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
      }

      .month-stats-container .search-input-wrapper svg {
        width: 16px;
        height: 16px;
        color: rgba(255, 255, 255, 0.5);
        flex-shrink: 0;
      }

      .month-stats-container .search-input-wrapper input {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: rgba(255, 255, 255, 0.95);
        font-size: 13px;
        font-weight: 600;
        min-width: 0;
      }

      .month-stats-container .search-input-wrapper input::placeholder {
        color: rgba(255, 255, 255, 0.4);
      }

      /* Clear search button */
      .search-clear-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        padding: 4px;
        display: none;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 18px;
        line-height: 1;
        transition: all 0.2s ease;
        border-radius: 4px;
      }

      .search-clear-btn:hover {
        color: rgba(255, 255, 255, 0.9);
        background: rgba(255, 255, 255, 0.1);
      }

      .search-clear-btn.visible {
        display: flex;
      }

      /* Export PDF Button */
      .export-pdf-btn {
        padding: 10px 16px;
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.15), rgba(192, 132, 252, 0.15));
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(var(--panel-blur));
        -webkit-backdrop-filter: blur(var(--panel-blur));
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .export-pdf-btn:hover {
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.25), rgba(192, 132, 252, 0.25));
        border-color: rgba(138, 180, 255, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(138, 180, 255, 0.3);
      }

      .export-pdf-btn:active {
        transform: translateY(0);
      }

      .export-pdf-btn svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
      }

      .export-pdf-btn.exporting {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
      }

      .export-pdf-btn.exporting svg {
        animation: spin 1s linear infinite;
      }

      /* ============================================================
         MONTH SELECTOR BAR (REDESIGNED - MATCHES HEADER STYLE)
         ============================================================ */
      .month-total-section {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        padding: 16px 24px;
        background: linear-gradient(135deg, rgba(30, 30, 46, 0.95), rgba(42, 42, 62, 0.95));
        backdrop-filter: blur(var(--panel-blur));
        -webkit-backdrop-filter: blur(var(--panel-blur));
        border: 1px solid rgba(138, 180, 255, 0.2);
        border-radius: 20px;
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        position: relative;
        overflow: hidden;
        margin: 0 0 20px 0;
      }

      .month-total-section::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.05), transparent);
        pointer-events: none;
      }

      .month-selector-wrapper {
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .month-selector-wrapper .search-input-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        border-radius: 14px;
        background: rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(138, 180, 255, 0.15);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
        transition: border 0.25s ease;
        width: 280px;
        height: 40px;
      }

      .month-selector-wrapper .search-input-wrapper:focus-within {
        border-color: rgba(138, 180, 255, 0.45);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.1),
          0 0 0 3px rgba(138, 180, 255, 0.12);
      }

      .month-selector-wrapper .search-input-wrapper svg {
        width: 16px;
        height: 16px;
        color: rgba(255, 255, 255, 0.5);
        flex-shrink: 0;
      }

      .month-selector-wrapper .search-input-wrapper input {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: rgba(255, 255, 255, 0.95);
        font-size: 13px;
        font-weight: 600;
        min-width: 0;
      }

      .month-selector-wrapper .search-input-wrapper input::placeholder {
        color: rgba(255, 255, 255, 0.4);
      }

      .month-selector {
        padding: 8px 16px;
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.15), rgba(168, 85, 247, 0.15));
        backdrop-filter: blur(var(--panel-blur));
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 12px;
        font-size: 13px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.95);
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(138, 180, 255, 0.2);
        transition: all 0.2s ease;
        outline: none;
      }

      .month-selector:hover {
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.25), rgba(168, 85, 247, 0.25));
        border-color: rgba(138, 180, 255, 0.5);
        box-shadow: 0 6px 16px rgba(138, 180, 255, 0.3);
      }

      .month-selector option {
        background: rgba(30, 30, 46, 0.98);
        color: rgba(255, 255, 255, 0.95);
      }

      .month-stats-container {
        display: flex;
        gap: 8px;
        position: relative;
        z-index: 1;
      }

      /* ============================================================
         PAYMENT GRID
         ============================================================ */
      .payments-grid {
        display: flex;
        flex-direction: column;
        gap: 1px;
        margin-bottom: 16px;
        background: rgba(138, 180, 255, 0);
        border-radius: 12px;
        overflow: hidden;
      }

      .grid-pagination {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        margin: 12px auto 32px;
        text-align: center;
      }

      .grid-load-more-btn {
        padding: 12px 32px;
        border-radius: 999px;
        border: 1px solid rgba(138, 180, 255, 0.4);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(168, 85, 247, 0.3));
        color: rgba(255, 255, 255, 0.95);
        font-weight: 700;
        letter-spacing: 0.02em;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.35);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .grid-load-more-btn:hover:not([disabled]) {
        transform: translateY(-1px);
        box-shadow: 0 16px 40px rgba(59, 130, 246, 0.35);
      }

      .grid-load-more-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .grid-pagination-hint {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.65);
        font-weight: 600;
      }

      .payment-groups-wrapper {
        display: flex;
        flex-direction: column;
        gap: 32px;
      }

      .payments-date-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .date-separator {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(59, 130, 246, 0.05));
        border-left: 4px solid #3b82f6;
        border-radius: 12px;
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
      }

      .date-separator-date {
        font-size: 15px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.95);
      }

      .date-separator-total {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 700;
        color: rgba(229, 231, 235, 0.9);
      }

      .total-usd {
        color: #3b82f6;
        font-weight: 700;
        font-size: 16px;
      }

      .total-separator {
        color: rgba(255, 255, 255, 0.3);
      }

      .total-amd {
        color: rgba(255, 255, 255, 0.6);
        font-size: 14px;
        font-weight: 600;
      }

      .date-group-shell {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 18px;
        backdrop-filter: blur(var(--card-blur));
        -webkit-backdrop-filter: blur(var(--card-blur));
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
        overflow: hidden;
      }

      .date-group-header {
        display: grid;
        grid-template-columns: 140px 1fr 1fr 80px 200px 160px 1fr 40px;
        gap: 12px;
        padding: 12px 20px;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 12px;
        font-weight: 700;
        color: rgba(148, 163, 184, 0.9);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .date-group-header > div:nth-child(4) {
        text-align: center; /* Center GROUP column header */
      }

      .payment-rows-container {
        display: flex;
        flex-direction: column;
      }

      .payments-table-header {
        display: grid;
        grid-template-columns: 140px 1fr 1fr 80px 200px 160px 1fr 40px;
        gap: 12px;
        padding: 16px 20px;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid rgba(138, 180, 255, 0.2);
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(var(--card-blur));
        -webkit-backdrop-filter: blur(var(--card-blur));
      }

      .header-cell {
        color: rgba(255, 255, 255, 0.5);
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      .payment-card {
        display: block;
        background: rgba(30, 35, 50, 0.6);
        backdrop-filter: blur(var(--list-blur));
        -webkit-backdrop-filter: blur(var(--list-blur));
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding: 0;
        transition: all 0.2s;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .payment-card:hover {
        background: rgba(40, 45, 65, 0.8);
        transform: scale(1.005);
      }

      .payment-card-row {
        display: grid;
        grid-template-columns: 140px 1fr 1fr 80px 200px 160px 1fr 40px;
        gap: 12px;
        padding: 12px 20px;
        align-items: center;
      }

      .payment-cell {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
      }

      .payment-message {
        color: rgba(255, 255, 255, 0.6);
        font-size: 13px;
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.4;
      }

      .payment-time,
      .payment-payer,
      .payment-student,
      .payment-amount,
      .payment-group,
      .payment-actions {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .payment-time {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.7);
      }

      .payment-payer,
      .payment-student {
        font-weight: 600;
      }

      .payment-group {
        display: flex;
        justify-content: center;
      }

      .group-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 10px;
        font-weight: 800;
        font-size: 15px;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
      }

      /* Group A - Blue */
      .group-badge[data-group="A"] {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), rgba(96, 165, 250, 0.4));
        border: 2px solid rgba(59, 130, 246, 0.7);
        color: #60a5fa;
      }

      /* Group B - Purple */
      .group-badge[data-group="B"] {
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.4), rgba(192, 132, 252, 0.4));
        border: 2px solid rgba(168, 85, 247, 0.7);
        color: #c084fc;
      }

      /* Group C - Green */
      .group-badge[data-group="C"] {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.4), rgba(16, 185, 129, 0.4));
        border: 2px solid rgba(34, 197, 94, 0.7);
        color: #10b981;
      }

      /* Group D - Pink */
      .group-badge[data-group="D"] {
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.4), rgba(244, 114, 182, 0.4));
        border: 2px solid rgba(236, 72, 153, 0.7);
        color: #f472b6;
      }

      /* Group E - Orange */
      .group-badge[data-group="E"] {
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.4), rgba(251, 146, 60, 0.4));
        border: 2px solid rgba(249, 115, 22, 0.7);
        color: #fb923c;
      }

      /* Group F - Cyan */
      .group-badge[data-group="F"] {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.4), rgba(34, 211, 238, 0.4));
        border: 2px solid rgba(6, 182, 212, 0.7);
        color: #22d3ee;
      }

      /* Default - Original blue-purple */
      .group-badge:not([data-group]) {
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.4), rgba(168, 85, 247, 0.4));
        border: 2px solid rgba(138, 180, 255, 0.7);
        color: #8ab4ff;
      }

      .payment-amount {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
      }

      .amount-usd {
        color: #3b82f6;
        font-weight: 700;
        font-size: 16px;
      }

      .amount-separator {
        color: rgba(255, 255, 255, 0.3);
      }

      .amount-amd {
        color: rgba(255, 255, 255, 0.6);
        font-size: 14px;
        font-weight: 600;
      }

      .payment-menu-btn {
        width: 32px;
        height: 32px;
        background: rgba(138, 180, 255, 0.1);
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 8px;
        color: rgba(138, 180, 255, 0.9);
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .payment-menu-btn:hover {
        background: rgba(138, 180, 255, 0.2);
        border-color: rgba(138, 180, 255, 0.5);
        transform: scale(1.1);
      }

      /* ============================================================
         FOR CLASS DATE PICKERS STYLING
         ============================================================ */
      .payment-for-class {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-start;
      }

      .for-class-input-row {
        position: relative;
        display: inline-block;
        margin-bottom: 6px;
      }

      .for-class-date-input {
        width: 140px;
        padding: 8px 42px 8px 12px; /* Extra right padding for buttons */
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(138, 180, 255, 0.2);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 13px;
        font-weight: 500;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        outline: none;
        transition: all 0.2s ease;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .for-class-date-input.is-dirty {
        border-color: rgba(74, 222, 128, 0.6);
        box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.12);
      }

      .for-class-date-input:hover {
        background: rgba(0, 0, 0, 0.5);
        border-color: rgba(138, 180, 255, 0.4);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      }

      .for-class-date-input:focus {
        background: rgba(0, 0, 0, 0.6);
        border-color: rgba(59, 130, 246, 0.6);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), 0 4px 20px rgba(0, 0, 0, 0.5);
      }

      .for-class-date-input::-webkit-calendar-picker-indicator {
        filter: invert(0.8) brightness(1.4);
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
        width: 18px;
        height: 18px;
      }

      .for-class-date-input::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
      }

      .for-class-date-input::placeholder {
        color: rgba(255, 255, 255, 0.4);
      }

      .for-class-date-input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: rgba(255, 255, 255, 0.02);
      }

      .for-class-actions {
        position: absolute;
        right: 4px;
        top: 50%;
        transform: translateY(-50%);
        display: inline-flex;
        gap: 2px;
        pointer-events: none; /* Allow calendar picker to work */
      }

      .for-class-action-btn {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        color: rgba(255, 255, 255, 0.8);
        font-size: 11px;
        font-weight: 700;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
        pointer-events: all; /* Re-enable for buttons */
      }

      .for-class-action-btn:disabled {
        opacity: 0.35;
        cursor: not-allowed;
      }

      .for-class-action-btn.save {
        color: #22c55e;
        border-color: rgba(34, 197, 94, 0.45);
      }

      .for-class-action-btn.cancel {
        color: #f87171;
        border-color: rgba(248, 113, 113, 0.45);
      }

      .for-class-action-btn:not(:disabled):hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.1);
      }

      .for-class-empty {
        color: rgba(255, 255, 255, 0.4);
        font-size: 13px;
        font-style: italic;
      }

      /* ============================================================
         FLATPICKR CUSTOM DARK THEME
         ============================================================ */
      .flatpickr-calendar {
        background: rgba(15, 20, 35, 0.95) !important;
        backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(138, 180, 255, 0.2) !important;
        border-radius: 16px !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6) !important;
      }

      .flatpickr-months {
        background: transparent !important;
        padding: 12px 0 !important;
      }

      .flatpickr-current-month {
        color: rgba(255, 255, 255, 0.95) !important;
        font-size: 16px !important;
        font-weight: 600 !important;
      }

      .flatpickr-month {
        color: rgba(255, 255, 255, 0.95) !important;
      }

      .flatpickr-monthDropdown-months {
        background: rgba(15, 20, 35, 0.95) !important;
        color: rgba(255, 255, 255, 0.95) !important;
        border: 1px solid rgba(138, 180, 255, 0.2) !important;
      }

      .flatpickr-prev-month,
      .flatpickr-next-month {
        fill: rgba(255, 255, 255, 0.7) !important;
      }

      .flatpickr-prev-month:hover,
      .flatpickr-next-month:hover {
        fill: rgba(255, 255, 255, 0.95) !important;
      }

      .flatpickr-weekdays {
        background: transparent !important;
      }

      span.flatpickr-weekday {
        color: rgba(138, 180, 255, 0.7) !important;
        font-weight: 600 !important;
        font-size: 11px !important;
      }

      .flatpickr-days {
        background: transparent !important;
      }

      .flatpickr-day {
        color: rgba(255, 255, 255, 0.85) !important;
        border-radius: 8px !important;
        font-weight: 500 !important;
      }

      .flatpickr-day:hover {
        background: rgba(138, 180, 255, 0.15) !important;
        border-color: rgba(138, 180, 255, 0.3) !important;
        color: rgba(255, 255, 255, 0.95) !important;
      }

      .flatpickr-day.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border-color: rgba(138, 180, 255, 0.5) !important;
        color: white !important;
        font-weight: 600 !important;
      }

      .flatpickr-day.today {
        border: 2px solid rgba(59, 130, 246, 0.6) !important;
        background: rgba(59, 130, 246, 0.1) !important;
        color: rgba(255, 255, 255, 0.95) !important;
      }

      .flatpickr-day.today:hover {
        background: rgba(59, 130, 246, 0.2) !important;
      }

      .flatpickr-day.prevMonthDay,
      .flatpickr-day.nextMonthDay {
        color: rgba(255, 255, 255, 0.3) !important;
      }

      .flatpickr-day.disabled {
        color: rgba(255, 255, 255, 0.2) !important;
      }

      .flatpickr-time {
        border-top: 1px solid rgba(138, 180, 255, 0.2) !important;
      }

      .flatpickr-time input {
        background: rgba(255, 255, 255, 0.05) !important;
        color: rgba(255, 255, 255, 0.95) !important;
        border: 1px solid rgba(138, 180, 255, 0.2) !important;
      }

      .numInputWrapper span {
        border-color: rgba(138, 180, 255, 0.2) !important;
      }

      .numInputWrapper span:hover {
        background: rgba(138, 180, 255, 0.1) !important;
      }

      .numInputWrapper span.arrowUp:after {
        border-bottom-color: rgba(255, 255, 255, 0.7) !important;
      }

      .numInputWrapper span.arrowDown:after {
        border-top-color: rgba(255, 255, 255, 0.7) !important;
      }

      .payment-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(138, 180, 255, 0.05), transparent);
        transition: left 0.5s;
      }

      .payment-card:hover::before {
        left: 100%;
      }

      /* Gmail Button Styles */
      .gmail-btn {
        padding: 6px 12px;
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.15), rgba(168, 85, 247, 0.15));
        backdrop-filter: blur(var(--panel-blur));
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(138, 180, 255, 0.2);
        white-space: nowrap;
        position: relative;
      }

      .gmail-btn::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: white;
        transition: all 0.3s;
      }

      .gmail-btn::after {
        content: '';
        position: absolute;
        bottom: -4px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 3px;
        background: #22c55e;
        border-radius: 3px;
        filter: blur(4px);
        box-shadow: 0 0 16px rgba(34, 197, 94, 0.9), 0 0 24px rgba(34, 197, 94, 0.6);
        transition: width 0.3s ease;
      }

      /* Timezone active class removed - always uses LA timezone now */
      /* timezoneGlow animation removed - no longer needed */

      .gmail-btn:hover {
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.25), rgba(168, 85, 247, 0.25));
      }

      .gmail-btn.connected::before {
        background: #22c55e;
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
      }

      .gmail-btn.syncing {
        animation: syncPulse 1.5s ease-in-out infinite;
      }

      .gmail-btn.syncing::before {
        animation: syncSpin 1s linear infinite;
      }

      @keyframes syncPulse {
        0%, 100% {
          box-shadow: 0 4px 12px rgba(138, 180, 255, 0.2);
        }
        50% {
          box-shadow: 0 4px 20px rgba(138, 180, 255, 0.5), 0 0 30px rgba(138, 180, 255, 0.3);
        }
      }

      @keyframes syncSpin {
        0% {
          transform: rotate(0deg);
          background: #8ab4ff;
        }
        50% {
          background: #a855f7;
        }
        100% {
          transform: rotate(360deg);
          background: #8ab4ff;
        }
      }

      /* Toggle Slider Styles */
      .toggle-slider::before {
        content: "";
        position: absolute;
        height: 16px;
        width: 16px;
        left: 3px;
        bottom: 3px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        transition: 0.3s;
      }

      input:checked + .toggle-slider {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.8), rgba(16, 185, 129, 0.8)) !important;
        border-color: rgba(34, 197, 94, 0.6) !important;
      }

      input:checked + .toggle-slider::before {
        transform: translateX(20px);
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
      }

      .auto-refresh-btn {
        padding: 6px 12px;
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.15), rgba(168, 85, 247, 0.15));
        backdrop-filter: blur(var(--panel-blur));
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(138, 180, 255, 0.2);
        white-space: nowrap;
        min-width: 65px;
      }

      .auto-refresh-btn::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: white;
        transition: all 0.3s;
      }

      .auto-refresh-btn:hover {
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.25), rgba(168, 85, 247, 0.25));
      }

      .auto-refresh-btn.active::before {
        background: #22c55e;
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
      }

      /* Sync Today Button */
      .sync-today-btn {
        padding: 8px 12px;
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.15), rgba(168, 85, 247, 0.15));
        backdrop-filter: blur(var(--panel-blur));
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.95);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(138, 180, 255, 0.2);
        position: relative;
        overflow: visible;
      }

      .sync-today-btn:hover {
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.25), rgba(168, 85, 247, 0.25));
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(138, 180, 255, 0.3);
      }

      .sync-today-btn:active {
        transform: translateY(0);
      }

      .sync-today-btn.syncing {
        pointer-events: none;
        opacity: 0.8;
        cursor: wait;
      }

      .cloud-icon {
        width: 20px;
        height: 20px;
        stroke-width: 2;
        display: block;
        transition: transform 0.3s ease;
      }

      .sync-today-btn.syncing .cloud-icon {
        animation: spin 1s linear infinite !important;
        transform-origin: center center;
      }

      .payment-method-icon {
        font-size: 16px;
      }

      .payment-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        position: relative;
        z-index: 1;
      }

      .payment-detail-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .payment-detail-label {
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: rgba(255, 255, 255, 0.5);
      }

      .payment-detail-value {
        font-size: 12px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.85);
      }

      .payment-note {
        margin-top: 8px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.02);
        border-left: 2px solid rgba(102, 126, 234, 0.4);
        border-radius: 6px;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        font-style: italic;
        position: relative;
        z-index: 1;
      }

      /* ============================================================
         DETAILS PANEL (SLIDE-IN)
         ============================================================ */
      .details-panel-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(var(--list-blur));
        z-index: 998;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .details-panel-overlay.active {
        opacity: 1;
        pointer-events: all;
      }

      .details-panel {
        position: fixed;
        top: 0;
        right: 0;
        width: 420px;
        max-width: 90vw;
        height: 100vh;
        background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow:
          -10px 0 60px rgba(0, 0, 0, 0.5),
          inset 1px 0 0 rgba(255, 255, 255, 0.05);
        z-index: 999;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .details-panel.active {
        transform: translateX(0);
      }

      .details-panel-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.12), rgba(168, 85, 247, 0.12));
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .details-panel-title {
        font-size: 18px;
        font-weight: 900;
        background: linear-gradient(135deg, #8ab4ff, #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.3px;
      }

      .details-panel-close {
        width: 28px;
        height: 28px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .details-panel-close:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.4);
        color: #ef4444;
      }

      .details-panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px 20px;
      }

      .detail-section {
        margin-bottom: 20px;
      }

      .detail-section-title {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 12px;
      }

      .detail-field {
        margin-bottom: 12px;
      }

      .detail-field-label {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 4px;
      }

      .detail-field-value {
        font-size: 13px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .detail-edit-input {
        width: 100%;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 13px;
        transition: all 0.3s;
        outline: none;
      }

      .detail-edit-input:focus {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(102, 126, 234, 0.6);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
      }

      .detail-group-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .detail-group-btn {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        outline: none;
      }

      .detail-group-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        border-color: rgba(102, 126, 234, 0.5);
        color: rgba(255, 255, 255, 0.95);
      }

      .detail-group-btn.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
        border-color: rgba(102, 126, 234, 0.8);
        color: white;
        box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
      }

      .detail-group-custom {
        flex: 1;
        min-width: 100px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 13px;
        outline: none;
      }

      .detail-group-custom:focus {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(102, 126, 234, 0.6);
      }

      .detail-amount-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .detail-amount-btn {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        outline: none;
      }

      .detail-amount-btn:hover {
        background: rgba(16, 185, 129, 0.1);
        border-color: rgba(16, 185, 129, 0.5);
        color: rgba(255, 255, 255, 0.95);
      }

      .detail-amount-btn.active {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3));
        border-color: rgba(16, 185, 129, 0.8);
        color: white;
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
      }

      .detail-amount-custom {
        flex: 1;
        min-width: 80px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 13px;
        outline: none;
      }

      .detail-amount-custom:focus {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(16, 185, 129, 0.6);
      }

      .credit-timeline {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .credit-timeline-item {
        padding: 10px;
        background: rgba(255, 255, 255, 0.04);
        border-left: 3px solid rgba(59, 130, 246, 0.5);
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .credit-timeline-info {
        flex: 1;
      }

      .credit-timeline-date {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 2px;
      }

      .credit-timeline-action {
        font-size: 12px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.85);
      }

      .credit-timeline-amount {
        font-size: 14px;
        font-weight: 700;
        color: #3b82f6;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 16px;
      }

      .btn-primary,
      .btn-secondary {
        flex: 1;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid;
        text-align: center;
      }

      .btn-primary {
        background: linear-gradient(135deg, #8ab4ff, #a855f7);
        border-color: rgba(138, 180, 255, 0.5);
        color: white;
        box-shadow: 0 4px 16px rgba(138, 180, 255, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 24px rgba(138, 180, 255, 0.5);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
      }

      /* ============================================================
         LOADING & EMPTY STATES
         ============================================================ */
      .loading-state {
        display: none !important; /* Hidden - silent loading */
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(102, 126, 234, 0.2);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.3;
      }

      .empty-state-title {
        font-size: 16px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 6px;
      }

      .empty-state-subtitle {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.4);
      }

      /* ============================================================
         PAYER ACTIONS POPUP
         ============================================================ */
      .payer-actions-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(var(--panel-blur));
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .payer-actions-overlay.active {
        opacity: 1;
        pointer-events: all;
      }

      .payer-actions-popup {
        background: linear-gradient(
          135deg,
          rgba(30, 30, 45, 0.95) 0%,
          rgba(20, 20, 35, 0.98) 100%
        );
        backdrop-filter: blur(var(--modal-blur));
        -webkit-backdrop-filter: blur(var(--modal-blur));
        border-radius: 24px;
        border: 1px solid rgba(138, 180, 255, 0.3);
        box-shadow:
          0 0 60px rgba(59, 130, 246, 0.3),
          0 0 100px rgba(168, 85, 247, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        width: 90%;
        max-width: 600px;
        max-height: 85vh;
        overflow-y: auto;
        transform: scale(0.9) translateY(20px);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        animation: prismGlow 3s ease-in-out infinite;
        will-change: transform, opacity, box-shadow;
      }

      .payer-actions-overlay.active .payer-actions-popup {
        transform: scale(1) translateY(0);
      }

      .payer-actions-header {
        padding: 28px 32px;
        border-bottom: 1px solid rgba(138, 180, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .payer-actions-title {
        font-size: 22px;
        font-weight: 700;
        background: linear-gradient(135deg, #8ab4ff 0%, #a78bfa 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .payer-actions-close {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: rgba(255, 255, 255, 0.6);
        font-size: 20px;
        padding: 0;
        font-family: inherit;
        line-height: 1;
      }

      .payer-actions-close:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.4);
        color: #ef4444;
        transform: rotate(90deg);
      }

      .payer-actions-body {
        padding: 32px;
      }

      .payer-summary {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1) 0%,
          rgba(168, 85, 247, 0.05) 100%
        );
        border: 1px solid rgba(138, 180, 255, 0.2);
        border-radius: 18px;
        padding: 24px;
        margin-bottom: 28px;
      }

      .payer-summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .payer-summary-row:last-child {
        border-bottom: none;
      }

      .payer-summary-label {
        font-size: 13px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .payer-summary-value {
        font-size: 15px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
      }

      .payer-summary-value.amount {
        color: #3b82f6;
        font-weight: 700;
        font-size: 18px;
      }

      .payer-summary-value.message {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
        max-width: 350px;
        text-align: right;
        word-wrap: break-word;
      }

      .payer-actions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
      }

      .payer-action-btn {
        padding: 18px 24px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.08) 0%,
          rgba(255, 255, 255, 0.04) 100%
        );
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 14px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-align: center;
      }

      .payer-action-btn:hover {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.2) 0%,
          rgba(168, 85, 247, 0.15) 100%
        );
        border-color: rgba(138, 180, 255, 0.6);
        transform: translateY(-2px);
        box-shadow:
          0 0 20px rgba(59, 130, 246, 0.4),
          0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .payer-action-btn.danger {
        border-color: rgba(239, 68, 68, 0.4);
      }

      .payer-action-btn.danger:hover {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.2) 0%,
          rgba(220, 38, 38, 0.15) 100%
        );
        border-color: rgba(239, 68, 68, 0.7);
        box-shadow:
          0 0 20px rgba(239, 68, 68, 0.4),
          0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .payer-action-btn svg,
      .payer-action-btn .icon {
        width: 18px;
        height: 18px;
        opacity: 0.8;
      }

      .payer-name {
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }

      .payer-name:hover {
        color: #3b82f6;
        text-decoration: underline;
      }

      /* ============================================================
         CUSTOM ALERT/PROMPT MODAL
         ============================================================ */
      .custom-alert-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(var(--panel-blur));
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .custom-alert-overlay.active {
        opacity: 1;
        pointer-events: all;
      }

      .custom-alert-modal {
        background: linear-gradient(
          135deg,
          rgba(30, 30, 45, 0.98) 0%,
          rgba(20, 20, 35, 0.98) 100%
        );
        backdrop-filter: blur(var(--modal-blur));
        -webkit-backdrop-filter: blur(var(--modal-blur));
        border-radius: 24px;
        border: 1px solid rgba(138, 180, 255, 0.3);
        box-shadow:
          0 0 60px rgba(59, 130, 246, 0.3),
          0 0 100px rgba(168, 85, 247, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        width: 90%;
        max-width: 500px;
        padding: 32px;
        transform: scale(0.9) translateY(20px);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .custom-alert-overlay.active .custom-alert-modal {
        transform: scale(1) translateY(0);
      }

      .custom-alert-title {
        font-size: 20px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 16px;
      }

      .custom-alert-modal.link-student-modal {
        max-width: 520px;
        padding: 28px;
      }

      .link-summary-box {
        margin-bottom: 18px;
        padding: 14px;
        border-radius: 12px;
        border-left: 3px solid rgba(138, 180, 255, 0.8);
        background: rgba(138, 180, 255, 0.08);
      }

      .student-search-input {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(138, 180, 255, 0.35);
        background: rgba(13, 17, 28, 0.85);
        color: #fff;
        font-size: 15px;
        padding: 12px 14px;
        margin-bottom: 12px;
      }

      .students-list {
        max-height: 320px;
        overflow-y: auto;
        border-radius: 14px;
        border: 1px solid rgba(138, 180, 255, 0.15);
        background: rgba(15, 20, 35, 0.8);
      }

      .student-select-item {
        padding: 14px 18px;
        border-bottom: 1px solid rgba(138, 180, 255, 0.08);
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .student-select-item:hover {
        background: rgba(138, 180, 255, 0.1);
      }

      .student-select-item:last-child {
        border-bottom: none;
      }

      .custom-alert-message {
        font-size: 15px;
        color: rgba(255, 255, 255, 0.8);
        line-height: 1.6;
        margin-bottom: 24px;
        white-space: pre-line;
      }

      .custom-alert-input {
        width: 100%;
        padding: 14px 18px;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(138, 180, 255, 0.3);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 15px;
        margin-bottom: 24px;
        outline: none;
        transition: all 0.2s ease;
      }

      .custom-alert-input:focus {
        border-color: rgba(138, 180, 255, 0.6);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
      }

      .custom-alert-input::placeholder {
        color: rgba(255, 255, 255, 0.4);
      }

      .custom-alert-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .custom-alert-btn {
        padding: 12px 28px;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        outline: none;
      }

      .custom-alert-btn.cancel {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.8);
      }

      .custom-alert-btn.cancel:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .custom-alert-btn.ok {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.8) 0%,
          rgba(168, 85, 247, 0.8) 100%
        );
        border: 1px solid rgba(138, 180, 255, 0.5);
        color: white;
      }

      .custom-alert-btn.ok:hover {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 1) 0%,
          rgba(168, 85, 247, 1) 100%
        );
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        transform: translateY(-1px);
      }

      .custom-alert-btn.danger {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.8) 0%,
          rgba(220, 38, 38, 0.8) 100%
        );
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: white;
      }

      .custom-alert-btn.danger:hover {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 1) 0%,
          rgba(220, 38, 38, 1) 100%
        );
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        transform: translateY(-1px);
      }

      /* ============================================================
         MODULE POPUP OVERLAY SYSTEM
         ============================================================ */
      .module-popup-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(var(--panel-blur));
        z-index: 100000;
        display: none;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      .module-popup-overlay.active {
        display: flex;
      }

      .module-popup-container {
        position: relative;
        width: 100%;
        height: 100%;
        max-width: 100vw;
        max-height: 100vh;
        background: transparent;
        border-radius: 0;
        overflow: hidden;
        box-shadow: none;
        animation: slideUpModule 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
      }

      @keyframes slideUpModule {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .module-popup-close {
        position: fixed;
        top: 24px;
        right: 24px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.3));
        border: 2px solid rgba(239, 68, 68, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 100001;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        pointer-events: auto;
      }

      /* Hide module close button when notification center is open (it has its own close) */
      .module-popup-overlay.notification-center-open .module-popup-close {
        display: none;
      }

      .module-popup-close:hover {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.5), rgba(220, 38, 38, 0.5));
        transform: scale(1.1) rotate(90deg);
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.7);
      }

      .module-popup-close svg {
        width: 24px;
        height: 24px;
        stroke: #fca5a5;
        stroke-width: 3;
      }

      .module-popup-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: transparent;
        pointer-events: auto;
      }

      /* ============================================================
         RESPONSIVE DESIGN
         ============================================================ */
      @media (max-width: 1200px) {
        .payments-grid {
          grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 8px;
        }

        .header {
          flex-direction: column;
          gap: 16px;
          padding: 16px;
        }

        .header-stats {
          width: 100%;
          flex-wrap: wrap;
          gap: 12px;
        }

        .stat-card {
          min-width: calc(50% - 6px);
          padding: 12px;
        }

        .stat-label {
          font-size: 11px;
        }

        .stat-value {
          font-size: 18px;
        }

        /* Month selector section - mobile optimized */
        .month-total-section {
          flex-direction: column;
          gap: 12px;
          padding: 12px 16px;
          margin: 0 0 16px 0;
        }

        .month-selector-wrapper {
          width: 100%;
          flex-direction: column;
          gap: 12px;
        }

        .month-selector-wrapper .search-input-wrapper {
          width: 100%;
          height: 44px;
          padding: 10px 14px;
        }

        .month-selector {
          width: 100%;
          padding: 10px 16px;
          font-size: 14px;
          height: 44px;
        }

        .month-stats-container {
          width: 100%;
          flex-direction: column;
          gap: 8px;
        }

        /* Payment grid - mobile card layout */
        .payments-grid {
          grid-template-columns: 1fr;
          gap: 12px;
        }

        .payment-card {
          border-radius: 12px;
          border: 1px solid rgba(255, 255, 255, 0.08);
          margin-bottom: 0;
        }

        .payment-card-row {
          grid-template-columns: 1fr;
          gap: 10px;
          padding: 14px 16px;
        }

        /* Mobile card layout - stack elements vertically */
        .payment-time,
        .payment-payer,
        .payment-student,
        .payment-amount,
        .payment-group,
        .payment-for-class,
        .payment-message {
          white-space: normal;
          text-overflow: clip;
          overflow: visible;
        }

        .payment-time {
          font-size: 13px;
          margin-bottom: 4px;
        }

        .payment-payer,
        .payment-student {
          font-size: 15px;
          line-height: 1.4;
        }

        .payment-amount {
          margin-top: 8px;
          padding-top: 8px;
          border-top: 1px solid rgba(255, 255, 255, 0.08);
          justify-content: space-between;
        }

        .amount-usd {
          font-size: 18px;
        }

        /* For Class date pickers - mobile responsive */
        .payment-for-class {
          margin-top: 8px;
          padding-top: 8px;
          border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .for-class-date-input {
          width: 100%;
          max-width: 200px;
          font-size: 14px;
          padding: 8px 12px;
        }

        .for-class-action-btn {
          width: 26px;
          height: 26px;
          font-size: 13px;
        }

        .payment-group {
          justify-content: flex-start;
          margin-top: 8px;
        }

        .group-badge {
          width: 36px;
          height: 36px;
          font-size: 16px;
        }

        .payment-menu-btn {
          position: absolute;
          top: 12px;
          right: 12px;
          width: 36px;
          height: 36px;
        }

        /* Details panel - full screen on mobile */
        .details-panel {
          width: 100%;
          max-width: 100%;
          left: 0;
          right: 0;
          border-radius: 20px 20px 0 0;
        }

        /* Mobile: Always visible with full opacity */
        .floating-nav {
          bottom: 12px;
          right: 12px;
          transform: translateX(0) !important;
          opacity: 1 !important;
          padding: 12px 16px;
          border-radius: 16px;
          gap: 10px;
        }

        .floating-nav.auto-hide {
          transform: translateX(0) !important;
          opacity: 1 !important;
        }

        .floating-nav.expanded {
          padding: 12px 16px;
        }

        .nav-btn, .nav-btn-placeholder {
          width: 44px;
          height: 44px;
          --nav-btn-size: 44px;
        }

        .nav-btn svg {
          width: 22px;
          height: 22px;
        }

        .nav-badge {
          font-size: 11px;
          min-width: 20px;
          height: 20px;
          padding: 0 6px;
        }

        .nav-context-menu {
          min-width: 260px;
          bottom: 70px;
          right: 12px;
        }

        /* Buttons and interactive elements - larger touch targets */
        button, .btn {
          min-height: 44px;
          min-width: 44px;
        }

        /* Gmail button */
        .gmail-btn {
          padding: 10px 16px;
          font-size: 14px;
        }

        /* Export button */
        .export-pdf-btn {
          padding: 10px 16px;
          font-size: 14px;
        }

        /* Improve text readability */
        .payment-cell {
          font-size: 15px;
        }

        .payment-message {
          font-size: 14px;
          line-height: 1.5;
        }
      }

    /* ============================================================
      FLOATING NAVIGATION BAR - HORIZONTAL COLLAPSIBLE
      ============================================================ */
    body:not(.admin-verified) .floating-nav {
      display: none !important;
    }

      .floating-nav {
        position: fixed;
        bottom: 80px;
        right: 0;
        transform: translateX(0); /* Always fully visible */
        z-index: 9999;
        display: flex;
        flex-direction: row;
        gap: 8px;
        background: linear-gradient(
          135deg,
          rgba(30, 30, 46, 0.98), /* Increased opacity */
          rgba(42, 42, 62, 0.98)
        );
        backdrop-filter: blur(var(--modal-blur));
        -webkit-backdrop-filter: blur(var(--modal-blur));
        border: 1px solid rgba(138, 180, 255, 0.25);
        border-radius: 20px 0 0 20px;
        padding: 10px 14px; /* Always use expanded padding */
        box-shadow:
          -8px 0 32px rgba(0, 0, 0, 0.5),
          inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        /* Remove all transitions and animations */
        transition: none;
        will-change: auto;
      }

      @media (prefers-reduced-motion: reduce) {
        .floating-nav {
          transition: none;
        }
      }

      /* Expanded state when auto-hide is off - NO PADDING CHANGE TO PREVENT JUMP */
      .floating-nav.expanded {
        transform: translateX(0) !important;
        /* padding removed - use base padding to prevent layout shift */
      }

      /* Remove collapsed state neon glows */
      .floating-nav:not(.expanded):has(#navCountdownTimer.time-safe) {
        border-color: rgba(138, 180, 255, 0.25);
        box-shadow:
          -8px 0 32px rgba(0, 0, 0, 0.5),
          inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      .floating-nav:not(.expanded):has(#navCountdownTimer.time-upcoming) {
        border-color: rgba(138, 180, 255, 0.25);
        box-shadow:
          -8px 0 32px rgba(0, 0, 0, 0.5),
          inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      .floating-nav:not(.expanded):has(#navCountdownTimer.time-warning) {
        border-color: rgba(138, 180, 255, 0.25);
        box-shadow:
          -8px 0 32px rgba(0, 0, 0, 0.5),
          inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      .floating-nav:not(.expanded):has(#navCountdownTimer.time-critical) {
        border-color: rgba(138, 180, 255, 0.25);
        box-shadow:
          -8px 0 32px rgba(0, 0, 0, 0.5),
          inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      /* Prevent collapse on button interaction */
      .floating-nav.interacting {
        transform: translateX(0) !important;
      }

      .nav-row {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .nav-row-top {
        display: flex;
        gap: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(138, 180, 255, 0.15);
        transition: all 0.2s ease;
      }

      .nav-row-top.drag-over {
        background: rgba(138, 180, 255, 0.1);
        border-radius: 8px;
        padding: 8px;
        border-bottom-color: rgba(138, 180, 255, 0.4);
      }

      .nav-row-main {
        display: flex;
        gap: 12px;
        transition: all 0.2s ease;
      }

      .nav-row-main.drag-over {
        background: rgba(138, 180, 255, 0.1);
        border-radius: 8px;
        padding: 8px;
      }

      .nav-btn, .nav-btn-placeholder {
        width: var(--nav-btn-size, 40px);
        height: var(--nav-btn-size, 40px);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.12);
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 18px;
        font-weight: 400;
        position: relative;
        overflow: visible;
        user-select: none;
      }

      .nav-btn.dragging, .nav-btn-placeholder.dragging {
        opacity: 0.5;
        transform: scale(0.95);
        cursor: pointer;
      }

      .nav-btn.drag-over, .nav-btn-placeholder.drag-over {
        background: rgba(138, 180, 255, 0.3);
        border-color: rgba(138, 180, 255, 0.6);
        transform: scale(1.1);
      }

      .nav-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(138, 180, 255, 0.3), transparent);
        transform: translate(-50%, -50%);
        transition: width 0.4s ease, height 0.4s ease;
      }

      .nav-btn:hover::before {
        width: 120%;
        height: 120%;
      }

      .nav-btn-placeholder {
        background: rgba(255, 255, 255, 0.02);
        color: rgba(255, 255, 255, 0.3);
        border: 1px dashed rgba(255, 255, 255, 0.1);
        font-size: 16px;
      }

      .nav-btn-placeholder:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(138, 180, 255, 0.3);
        border-style: solid;
        transform: scale(1.05);
        cursor: pointer;
      }

      .nav-btn svg {
        width: calc(var(--nav-btn-size, 40px) * 0.5);
        height: calc(var(--nav-btn-size, 40px) * 0.5);
        stroke: currentColor;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        z-index: 1;
      }

      .nav-btn:hover {
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.25), rgba(168, 85, 247, 0.25));
        color: #fff;
        border-color: rgba(138, 180, 255, 0.5);
        transform: translateY(-4px) scale(1.08);
        box-shadow: 0 12px 24px rgba(138, 180, 255, 0.5);
      }

      .nav-btn:hover svg {
        transform: scale(1.15) rotate(-5deg);
        filter: drop-shadow(0 0 8px rgba(138, 180, 255, 0.6));
      }

      .nav-btn.refreshing {
        opacity: 0.65;
        pointer-events: none;
        cursor: default;
        background: rgba(138, 180, 255, 0.18);
        border-color: rgba(138, 180, 255, 0.45);
        box-shadow: inset 0 0 12px rgba(138, 180, 255, 0.25);
        transform: none !important;
      }

      .nav-btn.refreshing::before {
        width: 0;
        height: 0;
      }

      .nav-btn.refreshing svg {
        transform: none;
        filter: none;
        animation: spin 1s linear infinite;
      }

      .nav-btn:active {
        transform: translateY(-2px) scale(1.02);
        transition: all 0.1s ease;
      }

      .nav-btn.active {
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.35), rgba(168, 85, 247, 0.35));
        color: #8ab4ff;
        border-color: rgba(138, 180, 255, 0.7);
        box-shadow:
          0 0 20px rgba(138, 180, 255, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }

      /* Navigation badge for active filters */
      .nav-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: linear-gradient(135deg, #8ab4ff, #a855f7);
        color: white;
        font-size: 9px;
        font-weight: 700;
        padding: 2px 5px;
        border-radius: 10px;
        min-width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(138, 180, 255, 0.6);
        animation: pulseNavBadge 2s ease-in-out infinite;
        z-index: 100;
        pointer-events: none;
      }

      /* ============================================================
         FLOATING NAV COUNTDOWN TIMER
         ============================================================ */
      #navCountdownTimer {
        height: var(--nav-btn-size, 40px);
        min-width: 100px;
        padding: 0 16px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: linear-gradient(
          135deg,
          rgba(138, 180, 255, 0.12),
          rgba(168, 85, 247, 0.12)
        );
        border: 1px solid rgba(138, 180, 255, 0.3);
        color: rgba(255, 255, 255, 0.9);
        font-size: 13px;
        font-weight: 700;
        letter-spacing: 0.5px;
        white-space: nowrap;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(var(--panel-blur));
        -webkit-backdrop-filter: blur(var(--panel-blur));
        box-shadow:
          0 4px 12px rgba(138, 180, 255, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      #navCountdownTimer::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(138, 180, 255, 0.3),
          transparent
        );
        transition: left 0.6s ease;
      }

      #navCountdownTimer:hover::before {
        left: 100%;
      }

      #navCountdownTimer:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow:
          0 6px 16px rgba(138, 180, 255, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.15);
      }

      #navCountdownTimer .timer-icon {
        font-size: 16px;
        filter: drop-shadow(0 0 4px currentColor);
        transition: transform 0.3s ease, filter 0.3s ease;
      }

      #navCountdownTimer .timer-text {
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        transition: opacity 0.2s ease;
      }

      /* State: Normal (> 24h) */
      #navCountdownTimer.time-safe {
        background: linear-gradient(
          135deg,
          rgba(0, 255, 160, 0.3),
          rgba(34, 197, 94, 0.3)
        );
        border-color: rgba(0, 255, 160, 0.8);
        color: #00ffa0;
        box-shadow:
          0 0 25px rgba(0, 255, 160, 0.6),
          0 0 50px rgba(0, 255, 160, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.15);
      }

      /* State: Upcoming (12-24h) */
      #navCountdownTimer.time-upcoming {
        background: linear-gradient(
          135deg,
          rgba(255, 230, 0, 0.3),
          rgba(251, 191, 36, 0.3)
        );
        border-color: rgba(255, 230, 0, 0.9);
        color: #ffe600;
        animation: prismGlow 2s ease-in-out infinite;
        will-change: box-shadow;
        box-shadow:
          0 0 25px rgba(255, 230, 0, 0.7),
          0 0 50px rgba(255, 230, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.15);
      }

      /* State: Warning (6-12h) */
      #navCountdownTimer.time-warning {
        background: linear-gradient(
          135deg,
          rgba(255, 140, 0, 0.35),
          rgba(255, 100, 0, 0.35)
        );
        border-color: rgba(255, 140, 0, 0.9);
        color: #ff8c00;
        animation: prismGlow 1.5s ease-in-out infinite;
        box-shadow:
          0 0 30px rgba(255, 140, 0, 0.7),
          0 0 60px rgba(255, 140, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.15);
      }

      #navCountdownTimer.time-warning .timer-icon {
        animation: breathe 1.5s ease-in-out infinite;
        will-change: opacity, transform;
      }

      /* State: Critical (<6h) */
      #navCountdownTimer.time-critical {
        background: linear-gradient(
          135deg,
          rgba(255, 30, 30, 0.4),
          rgba(239, 68, 68, 0.4)
        );
        border-color: rgba(255, 30, 30, 0.95);
        color: #ff1e1e;
        animation: prismGlow 1s ease-in-out infinite;
        will-change: box-shadow;
        box-shadow:
          0 0 35px rgba(255, 30, 30, 0.8),
          0 0 70px rgba(255, 30, 30, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }

      #navCountdownTimer.time-critical .timer-icon {
        animation: breathe 1s ease-in-out infinite;
        will-change: opacity, transform;
      }

      /* State: LIVE NOW */
      #navCountdownTimer.time-live {
        background: linear-gradient(
          135deg,
          rgba(168, 85, 247, 0.3),
          rgba(236, 72, 153, 0.3)
        );
        border-color: rgba(168, 85, 247, 0.8);
        color: rgba(236, 72, 153, 1);
        animation: prismGlow 0.8s ease-in-out infinite;
        will-change: box-shadow;
      }

      #navCountdownTimer.time-live .timer-icon {
        animation: breathe 0.8s ease-in-out infinite;
        will-change: opacity, transform;
      }

      /* No upcoming classes */
      #navCountdownTimer.time-none {
        background: rgba(255, 255, 255, 0.04);
        border-color: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.4);
        font-style: italic;
        width: var(--nav-btn-size, 40px);
        min-width: var(--nav-btn-size, 40px);
        padding: 0;
      }

      #navCountdownTimer.time-none .timer-text {
        display: none;
      }

      #navCountdownTimer.time-none .timer-icon {
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* ============================================================
         COUNTDOWN POPUP MODAL
         ============================================================ */
      .countdown-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(var(--panel-blur));
        -webkit-backdrop-filter: blur(var(--panel-blur));
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
      }

      .countdown-popup {
        width: 90%;
        max-width: 700px;
        max-height: 85vh;
        background: rgba(30, 30, 40, 0.95);
        backdrop-filter: blur(var(--card-blur));
        -webkit-backdrop-filter: blur(var(--card-blur));
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 24px;
        box-shadow:
          0 12px 40px rgba(0, 0, 0, 0.8),
          0 0 0 1px rgba(255, 255, 255, 0.2);
        display: flex;
        flex-direction: column;
        animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        overflow: hidden;
        transition: all 0.8s ease-in-out;
      }

      /* Time-based color tints for popup */
      .countdown-popup.time-safe {
        background: rgba(0, 65, 50, 1);
        border-color: rgba(0, 255, 160, 1);
        box-shadow:
          0 12px 40px rgba(0, 0, 0, 0.8),
          0 0 35px rgba(0, 255, 160, 0.6),
          0 0 60px rgba(0, 255, 160, 0.3);
      }

      .countdown-popup.time-upcoming {
        background: rgba(75, 70, 0, 1);
        border-color: rgba(255, 230, 0, 1);
        box-shadow:
          0 12px 40px rgba(0, 0, 0, 0.8),
          0 0 35px rgba(255, 230, 0, 0.6),
          0 0 60px rgba(255, 230, 0, 0.3);
      }

      .countdown-popup.time-warning {
        background: rgba(75, 55, 20, 1);
        border-color: rgba(255, 160, 50, 0.95);
        box-shadow:
          0 12px 40px rgba(0, 0, 0, 0.8),
          0 0 55px rgba(255, 160, 50, 0.85);
      }

      .countdown-popup.time-critical {
        background: rgba(85, 20, 20, 1);
        border-color: rgba(255, 40, 40, 1);
      }

      /* Gradual blinking for critical state (<6h) */
      .countdown-popup.time-critical.pulse-slow {
        animation: redPulseSlow 2.5s ease-in-out infinite;
      }

      .countdown-popup.time-critical.pulse-medium {
        animation: redPulseMedium 1.5s ease-in-out infinite;
      }

      .countdown-popup.time-critical.pulse-fast {
        animation: redPulseFast 1s ease-in-out infinite;
      }

      @keyframes redPulseSlow {
        0%, 100% {
          border-color: rgba(255, 40, 40, 0.95);
          box-shadow:
            0 12px 40px rgba(0, 0, 0, 0.8),
            0 0 40px rgba(255, 40, 40, 0.6),
            0 0 70px rgba(255, 40, 40, 0.4);
        }
        50% {
          border-color: rgba(255, 40, 40, 1);
          box-shadow:
            0 12px 40px rgba(0, 0, 0, 0.8),
            0 0 50px rgba(255, 40, 40, 0.7),
            0 0 85px rgba(255, 40, 40, 0.5);
        }
      }

      @keyframes redPulseMedium {
        0%, 100% {
          border-color: rgba(255, 35, 35, 0.95);
          box-shadow:
            0 12px 40px rgba(0, 0, 0, 0.8),
            0 0 45px rgba(255, 35, 35, 0.65),
            0 0 75px rgba(255, 35, 35, 0.45);
        }
        50% {
          border-color: rgba(255, 35, 35, 1);
          box-shadow:
            0 12px 40px rgba(0, 0, 0, 0.8),
            0 0 55px rgba(255, 35, 35, 0.75),
            0 0 90px rgba(255, 35, 35, 0.55);
        }
      }

      @keyframes redPulseFast {
        0%, 100% {
          border-color: rgba(255, 30, 30, 1);
          box-shadow:
            0 12px 40px rgba(0, 0, 0, 0.8),
            0 0 50px rgba(255, 30, 30, 0.7),
            0 0 80px rgba(255, 30, 30, 0.5);
        }
        50% {
          border-color: rgba(255, 30, 30, 1);
          box-shadow:
            0 12px 40px rgba(0, 0, 0, 0.8),
            0 0 60px rgba(255, 30, 30, 0.8),
            0 0 95px rgba(255, 30, 30, 0.6);
        }
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-50px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .countdown-popup-header {
        display: flex;
        align-items: center;
        padding: 32px 36px;
        border-bottom: 2px solid rgba(138, 180, 255, 0.25);
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.12), rgba(168, 85, 247, 0.12));
      }

      .countdown-popup-icon {
        font-size: 28px;
        margin-right: 16px;
        filter: drop-shadow(0 0 12px rgba(138, 180, 255, 0.8));
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .countdown-popup-title {
        flex: 1;
        font-size: 24px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.98);
        letter-spacing: 0.5px;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .countdown-popup-close {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.08);
        border: 2px solid rgba(255, 255, 255, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: rgba(255, 255, 255, 0.7);
        font-size: 24px;
        padding: 0;
        font-family: inherit;
        line-height: 1;
      }

      .countdown-popup-close:hover {
        background: rgba(239, 68, 68, 0.25);
        border-color: rgba(239, 68, 68, 0.5);
        color: #ef4444;
        transform: rotate(90deg) scale(1.1);
      }

      .countdown-popup-body {
        flex: 1;
        overflow-y: auto;
        padding: 32px 36px;
        max-height: calc(85vh - 120px);
      }

      .countdown-popup-body::-webkit-scrollbar {
        width: 10px;
      }

      .countdown-popup-body::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.04);
        border-radius: 5px;
      }

      .countdown-popup-body::-webkit-scrollbar-thumb {
        background: rgba(138, 180, 255, 0.4);
        border-radius: 5px;
      }

      .countdown-popup-body::-webkit-scrollbar-thumb:hover {
        background: rgba(138, 180, 255, 0.6);
      }

      .countdown-class-item {
        padding: 28px 32px;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.06);
        border: 2px solid rgba(138, 180, 255, 0.2);
        border-radius: 20px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      }

      .countdown-class-item:hover {
        background: rgba(138, 180, 255, 0.12);
        border-color: rgba(138, 180, 255, 0.4);
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(138, 180, 255, 0.3);
      }

      .countdown-class-item:last-child {
        margin-bottom: 0;
      }

      /* Color-coded class states based on time remaining */
      .countdown-class-item.class-safe {
        background: rgba(0, 255, 160, 0.12);
        border-color: rgba(0, 255, 160, 0.4);
      }

      .countdown-class-item.class-safe:hover {
        background: rgba(0, 255, 160, 0.16);
        border-color: rgba(0, 255, 160, 0.6);
        box-shadow: 0 8px 24px rgba(0, 255, 160, 0.3);
      }

      .countdown-class-item.class-upcoming {
        background: rgba(255, 220, 50, 0.12);
        border-color: rgba(255, 220, 50, 0.4);
      }

      .countdown-class-item.class-upcoming:hover {
        background: rgba(255, 220, 50, 0.16);
        border-color: rgba(255, 220, 50, 0.6);
        box-shadow: 0 8px 24px rgba(255, 220, 50, 0.3);
      }

      .countdown-class-item.class-warning {
        background: rgba(255, 160, 50, 0.12);
        border-color: rgba(255, 160, 50, 0.4);
      }

      .countdown-class-item.class-warning:hover {
        background: rgba(255, 160, 50, 0.16);
        border-color: rgba(255, 160, 50, 0.6);
        box-shadow: 0 8px 24px rgba(255, 160, 50, 0.3);
      }

      .countdown-class-item.class-critical {
        background: rgba(255, 60, 60, 0.16);
        border-color: rgba(255, 60, 60, 0.5);
        animation: pulseRed 2s ease-in-out infinite;
      }

      .countdown-class-item.class-critical:hover {
        background: rgba(255, 60, 60, 0.2);
        border-color: rgba(255, 60, 60, 0.7);
        box-shadow: 0 8px 24px rgba(255, 60, 60, 0.4);
      }

      /* Pulsing animation for critical classes */
      @keyframes pulseRed {
        0%, 100% {
          border-color: rgba(255, 60, 60, 0.5);
          box-shadow: 0 0 25px rgba(255, 60, 60, 0.4);
        }
        50% {
          border-color: rgba(255, 60, 60, 0.8);
          box-shadow: 0 0 40px rgba(255, 60, 60, 0.6);
        }
      }

      .countdown-class-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }

      .countdown-class-name {
        font-size: 26px;
        font-weight: 900;
        color: rgba(138, 180, 255, 1);
        text-shadow: 0 2px 8px rgba(138, 180, 255, 0.4);
        letter-spacing: 0.3px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: geometricPrecision;
      }

      .countdown-class-time {
        font-size: 24px;
        font-weight: 900;
        color: #ffffff;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px 20px;
        border-radius: 12px;
        border: 2.5px solid rgba(255, 255, 255, 0.8);
        text-shadow: none;
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui, sans-serif;
        letter-spacing: 1px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: geometricPrecision;
        backdrop-filter: blur(var(--panel-blur));
      }

      .countdown-class-details {
        display: flex;
        gap: 24px;
        font-size: 16px;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .countdown-class-detail {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.04);
        padding: 10px 16px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .countdown-class-detail-icon {
        font-size: 18px;
        opacity: 0.9;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .countdown-no-classes {
        text-align: center;
        padding: 100px 36px;
        color: rgba(255, 255, 255, 0.6);
      }

      .countdown-no-classes-icon {
        font-size: 72px;
        margin-bottom: 24px;
        opacity: 0.4;
        filter: drop-shadow(0 4px 12px rgba(138, 180, 255, 0.3));
      }

      .countdown-no-classes-text {
        font-size: 20px;
        font-weight: 600;
        letter-spacing: 0.3px;
      }

      /* Navigation Settings Context Menu */
      .nav-context-menu {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none;
        background: linear-gradient(135deg, rgba(30, 30, 46, 0.98), rgba(42, 42, 62, 0.98));
        backdrop-filter: blur(var(--panel-blur));
        -webkit-backdrop-filter: blur(var(--panel-blur));
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 16px;
        padding: 20px;
        min-width: 320px;
        max-width: 400px;
        z-index: 10001;
        box-shadow:
          0 20px 60px rgba(0, 0, 0, 0.8),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .nav-context-menu.show {
        display: block;
        opacity: 1;
      }

      /* Backdrop overlay for context menu */
      .nav-context-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(var(--panel-blur));
        z-index: 10000;
        display: none;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .nav-context-menu-overlay.show {
        display: block;
        opacity: 1;
      }

      .nav-settings-title {
        font-size: 11px;
        font-weight: 700;
        color: #8ab4ff;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(138, 180, 255, 0.2);
      }

      .nav-setting-item {
        margin-bottom: 12px;
      }

      .nav-setting-label {
        font-size: 12px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.85);
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .nav-setting-value {
        color: #8ab4ff;
        font-size: 11px;
      }

      .nav-slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
        outline: none;
        -webkit-appearance: none;
        appearance: none;
        cursor: pointer;
      }

      .nav-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8ab4ff, #a855f7);
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(138, 180, 255, 0.5);
        transition: all 0.2s ease;
      }

      .nav-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 12px rgba(138, 180, 255, 0.7);
      }

      .nav-slider::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8ab4ff, #a855f7);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 8px rgba(138, 180, 255, 0.5);
        transition: all 0.2s ease;
      }

      .nav-slider::-moz-range-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 12px rgba(138, 180, 255, 0.7);
      }

      .nav-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
      }

      .nav-toggle-switch {
        position: relative;
        width: 42px;
        height: 22px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 11px;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.15);
      }

      .nav-toggle-switch::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .nav-toggle input {
        display: none;
      }

      .nav-toggle input:checked + .nav-toggle-switch {
        background: linear-gradient(135deg, #8ab4ff, #a855f7);
        border-color: rgba(138, 180, 255, 0.4);
      }

      .nav-toggle input:checked + .nav-toggle-switch::after {
        left: 22px;
        background: white;
      }

      .nav-selector {
        width: 100%;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        outline: none;
        transition: all 0.2s ease;
      }

      .nav-selector:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(138, 180, 255, 0.5);
      }

      .nav-selector:focus {
        border-color: rgba(138, 180, 255, 0.7);
        box-shadow: 0 0 0 2px rgba(138, 180, 255, 0.2);
      }

      .nav-selector option {
        background: #1a1f2e;
        color: white;
        padding: 8px;
      }

      /* Auto-hide state */
      .floating-nav.auto-hide {
        transform: translateX(0); /* Always visible */
      }

      .floating-nav.auto-hide:hover,
      .floating-nav.auto-hide.expanded {
        transform: translateX(0);
      }

      .floating-nav:not(.auto-hide) {
        transform: translateX(0);
      }

      /* Disable badge pulse animation */
      @keyframes pulseNavBadge {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 2px 8px rgba(138, 180, 255, 0.6);
        }
        50% {
          transform: scale(1);
          box-shadow: 0 2px 8px rgba(138, 180, 255, 0.6);
        }
      }

      /* ============================================================
         EMAIL PREVIEW MODAL
         ============================================================ */
      .email-preview-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        z-index: 10001;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 40px;
        animation: fadeIn 0.2s ease;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .email-preview-overlay.active {
        display: flex;
        opacity: 1;
      }

      .email-preview-panel {
        width: 100%;
        max-width: 700px;
        max-height: 90vh;
        background: linear-gradient(135deg, rgba(31, 20, 60, 0.98), rgba(20, 15, 40, 0.98));
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 24px;
        box-shadow:
          0 0 50px rgba(138, 180, 255, 0.4),
          0 0 100px rgba(168, 85, 247, 0.3),
          0 30px 80px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        animation: slideDown 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: hidden;
      }

      .email-preview-header {
        padding: 24px 28px;
        border-bottom: 1px solid rgba(138, 180, 255, 0.2);
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.08), rgba(168, 85, 247, 0.08));
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .email-preview-title {
        font-size: 18px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.95);
      }

      .email-preview-close {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: rgba(255, 255, 255, 0.6);
        font-size: 20px;
        padding: 0;
        font-family: inherit;
        line-height: 1;
      }

      .email-preview-close:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.4);
        color: #ef4444;
        transform: rotate(90deg);
      }

      .email-preview-body {
        flex: 1;
        overflow-y: auto;
        padding: 28px;
      }

      .email-preview-body::-webkit-scrollbar {
        width: 8px;
      }

      .email-preview-body::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 4px;
      }

      .email-preview-body::-webkit-scrollbar-thumb {
        background: rgba(138, 180, 255, 0.3);
        border-radius: 4px;
      }

      .email-preview-body::-webkit-scrollbar-thumb:hover {
        background: rgba(138, 180, 255, 0.5);
      }

      .email-meta {
        margin-bottom: 24px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(138, 180, 255, 0.15);
        border-radius: 16px;
      }

      .email-meta-row {
        display: flex;
        margin-bottom: 12px;
        gap: 12px;
      }

      .email-meta-row:last-child {
        margin-bottom: 0;
      }

      .email-meta-label {
        font-size: 12px;
        font-weight: 700;
        color: rgba(138, 180, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 100px;
      }

      .email-meta-value {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.85);
        font-weight: 600;
      }

      .email-body-content {
        padding: 20px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(138, 180, 255, 0.1);
        border-radius: 16px;
        color: rgba(255, 255, 255, 0.85);
        line-height: 1.6;
        font-size: 14px;
      }

      .email-body-content h1,
      .email-body-content h2,
      .email-body-content h3 {
        color: rgba(255, 255, 255, 0.95);
        margin-top: 1em;
        margin-bottom: 0.5em;
      }

      .email-body-content p {
        margin-bottom: 1em;
      }

      .email-body-content a {
        color: #60a5fa;
        text-decoration: none;
      }

      .email-body-content a:hover {
        text-decoration: underline;
      }

      .email-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
      }

      .email-action-btn {
        flex: 1;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .email-action-btn.primary {
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.2), rgba(168, 85, 247, 0.2));
        border-color: rgba(138, 180, 255, 0.4);
        color: #8ab4ff;
      }

      .email-action-btn.primary:hover {
        background: linear-gradient(135deg, rgba(138, 180, 255, 0.3), rgba(168, 85, 247, 0.3));
        border-color: rgba(138, 180, 255, 0.6);
        box-shadow: 0 0 20px rgba(138, 180, 255, 0.3);
      }

      .email-action-btn.secondary {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.7);
      }

      .email-action-btn.secondary:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.3);
      }

      /* ============================================================
         CUSTOM CONFIRMATION MODAL
         ============================================================ */
      .confirm-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(var(--panel-blur));
        z-index: 10002;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.2s ease;
      }

      .confirm-modal-overlay.active {
        display: flex;
      }

      .confirm-modal-panel {
        width: 100%;
        max-width: 420px;
        background: linear-gradient(135deg, rgba(31, 20, 60, 0.98), rgba(20, 15, 40, 0.98));
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 24px;
        backdrop-filter: blur(var(--card-blur));
        box-shadow:
          0 0 50px rgba(138, 180, 255, 0.4),
          0 0 100px rgba(168, 85, 247, 0.3),
          0 30px 80px rgba(0, 0, 0, 0.5);
        padding: 32px;
        text-align: center;
        animation: modalBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      @keyframes modalBounce {
        0% {
          opacity: 0;
          transform: scale(0.7) translateY(-20px);
        }
        100% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .confirm-modal-icon {
        font-size: 48px;
        margin-bottom: 16px;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .confirm-modal-title {
        font-size: 20px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 12px;
      }

      .confirm-modal-message {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.6;
        margin-bottom: 28px;
      }

      .confirm-modal-actions {
        display: flex;
        gap: 12px;
      }

      .confirm-modal-btn {
        flex: 1;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid;
      }

      .confirm-modal-cancel {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.8);
      }

      .confirm-modal-cancel:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
      }

      .confirm-modal-confirm {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
        border-color: rgba(239, 68, 68, 0.5);
        color: #ef4444;
      }

      .confirm-modal-confirm:hover {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.3));
        border-color: rgba(239, 68, 68, 0.7);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
      }

      .confirm-modal-btn:active {
        transform: translateY(0);
      }

      /* SQL Help Modal Styles */
      .sql-section {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(138, 180, 255, 0.2);
        border-radius: 16px;
        padding: 25px;
      }

      .sql-query-block {
        margin-bottom: 20px;
      }

      .sql-query-block:last-child {
        margin-bottom: 0;
      }

      .sql-query-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px 15px;
        background: rgba(138, 180, 255, 0.1);
        border-radius: 8px;
      }

      .sql-copy-btn {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.2));
        border: 1px solid rgba(34, 197, 94, 0.4);
        color: #22c55e;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .sql-copy-btn:hover {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(22, 163, 74, 0.3));
        border-color: rgba(34, 197, 94, 0.6);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      }

      .sql-copy-btn.copied {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
        border-color: rgba(59, 130, 246, 0.4);
        color: #3b82f6;
      }

      .sql-copy-btn:active {
        transform: translateY(0);
      }

      /* Scrollbar styling for SQL modal */
      #sqlHelpModal::-webkit-scrollbar {
        width: 12px;
      }

      #sqlHelpModal::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
      }

      #sqlHelpModal::-webkit-scrollbar-thumb {
        background: rgba(138, 180, 255, 0.4);
        border-radius: 6px;
      }

      #sqlHelpModal::-webkit-scrollbar-thumb:hover {
        background: rgba(138, 180, 255, 0.6);
      }
    </style>
  </head>

  <body>
    <div id="globalBlurLayer" class="global-blur-layer" aria-hidden="true"></div>
    <div class="container">
      <!-- HEADER -->
      <div class="header">
        <div class="header-left">
          <div class="header-info">
            <h1>Payment Records</h1>
            <div class="header-subtitle" id="recordCount">Loading records...</div>
          </div>
        </div>
        <div class="header-stats">
          <button id="gmailBtn" class="gmail-btn" onclick="toggleGmailConnection()">
            <span id="gmailBtnText">Gmail</span>
          </button>
          <button id="autoRefreshToggle" class="auto-refresh-btn" onclick="toggleAutoRefresh()"
                  title="Toggle 1-minute auto-refresh (currently OFF)">
            60s
          </button>
          <button id="syncBtn" class="gmail-btn" onclick="openSyncModal()">
            <span>Sync</span>
          </button>
          <button id="syncTodayBtn" class="sync-today-btn" onclick="syncTodayPayments()" title="Sync today's payments only">
            <svg class="cloud-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
            </svg>
          </button>
          <a class="stat-pill portal-link" id="sqlHelpBtn" onclick="openSQLHelpModal(); return false;" style="cursor: pointer; text-decoration: none;">
            Help
          </a>
          <a href="Student-Portal-Admin.html" class="stat-pill portal-link" id="portalSystemBtn" target="_blank" rel="noopener">
            Portal
          </a>
        </div>
      </div>

      <!-- PAYMENT SUMMARY (ALWAYS VISIBLE) -->
      <div class="month-total-section">
        <div class="month-selector-wrapper">
          <select id="monthSelector" class="month-selector" onchange="handleMonthSelectorChange()">
            <option value="current">This Month</option>
            <option value="2025-11">November 2025</option>
            <option value="2025-10">October 2025</option>
            <option value="2025-09">September 2025</option>
            <option value="2025-08">August 2025</option>
            <option value="ytd">Year to Date</option>
            <option value="all" selected="">All Time</option>
          </select>

          <div class="search-input-wrapper">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input
              id="paymentsSearchInput"
              type="text"
              placeholder="Search by name, 'Group A', or message..."
              autocomplete="off"
              spellcheck="false"
            />
            <button class="search-clear-btn" id="paymentsSearchClear" onclick="clearPaymentsSearch()" title="Clear search">âœ•</button>
          </div>

          <!-- Export PDF Button -->
          <button class="export-pdf-btn" id="exportPdfBtn" title="Export to PDF">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </button>
        </div>

        <div class="month-stats-container">
          <div class="stat-pill">
            <span class="stat-label">PAYMENTS:</span>
            <span class="stat-value" id="monthTotalCount">0</span>
          </div>
          <div class="stat-pill">
            <span class="stat-label">USD:</span>
            <span class="stat-value stat-value-usd" id="monthTotalUSD">0 $</span>
          </div>
          <div class="stat-pill">
            <span class="stat-label">AMD:</span>
            <span class="stat-value stat-value-amd" id="monthTotalAMD">0 Ö</span>
          </div>
        </div>
      </div>

      <!-- PAYMENTS GRID -->
      <div id="paymentsGrid" class="payments-grid">
        <!-- Loading state -->
        <div class="loading-state" id="loadingState">
          <div class="loading-spinner"></div>
          <div style="color: rgba(255, 255, 255, 0.6); font-weight: 600">Loading payment records...</div>
        </div>
      </div>

      <div class="grid-pagination" id="gridLoadMoreWrapper" style="display: none;">
        <button id="gridLoadMoreBtn" class="grid-load-more-btn" type="button">
          Load more
        </button>
        <div class="grid-pagination-hint" id="gridLoadMoreHint">Showing latest payments</div>
      </div>

      <!-- EMPTY STATE (hidden by default) -->
      <div class="empty-state" id="emptyState" style="display: none">
        <div class="empty-state-icon">ðŸ”</div>
        <div class="empty-state-title">No Payment Records Found</div>
        <div class="empty-state-subtitle">Try adjusting your filters</div>
      </div>

    <!-- DETAILS PANEL OVERLAY -->
    <div class="details-panel-overlay" id="detailsOverlay"></div>

    <!-- DETAILS PANEL (SLIDE-IN) -->
    <div class="details-panel" id="detailsPanel">
      <div class="details-panel-header">
        <h2 class="details-panel-title">Payment Details</h2>
        <button class="details-panel-close" id="closeDetailsPanel">âœ•</button>
      </div>

      <div class="details-panel-body" id="detailsPanelBody">
        <!-- Content loaded dynamically -->
        <div class="detail-section">
          <div class="detail-section-title">ðŸ’³ Payment Information</div>
          <div class="detail-field">
            <div class="detail-field-label">Payment ID</div>
            <div class="detail-field-value" id="detailPaymentId">â€”</div>
          </div>
          <div class="detail-field">
            <div class="detail-field-label">Amount</div>
            <div class="detail-field-value" id="detailAmount">â€”</div>
          </div>
          <div class="detail-field">
            <div class="detail-field-label">Payment Method</div>
            <div class="detail-field-value" id="detailMethod">â€”</div>
          </div>
          <div class="detail-field">
            <div class="detail-field-label">Transaction Date</div>
            <div class="detail-field-value" id="detailDate">â€”</div>
          </div>
          <div class="detail-field">
            <div class="detail-field-label">Sender Name (Payer)</div>
            <div class="detail-field-value" id="detailPayer">â€”</div>
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-section-title">ðŸ‘¤ Student Information</div>
          <div class="detail-field">
            <div class="detail-field-label">Student Name</div>
            <input type="text" class="detail-edit-input" id="detailStudentName" placeholder="Student name...">
          </div>
          <div class="detail-field">
            <div class="detail-field-label">Email</div>
            <textarea class="detail-edit-input" id="detailEmail" rows="2" placeholder="email@example.com (one per line)"></textarea>
          </div>
          <div class="detail-field">
            <div class="detail-field-label">Phone</div>
            <input type="text" class="detail-edit-input" id="detailPhone" placeholder="000-000-0000">
          </div>
          <div class="detail-field">
            <div class="detail-field-label">Group</div>
            <div class="detail-group-buttons" id="detailGroupButtons">
              <button class="detail-group-btn" data-group="A">A</button>
              <button class="detail-group-btn" data-group="B">B</button>
              <button class="detail-group-btn" data-group="C">C</button>
              <button class="detail-group-btn" data-group="D">D</button>
              <button class="detail-group-btn" data-group="E">E</button>
              <button class="detail-group-btn" data-group="F">F</button>
              <input type="text" class="detail-group-custom" id="detailGroupCustom" placeholder="Custom">
            </div>
          </div>
          <div class="detail-field">
            <div class="detail-field-label">Status</div>
            <select class="detail-edit-input" id="detailStatus">
              <option value="active">Active</option>
              <option value="paused">Paused</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-section-title">ðŸ’° Payment Settings</div>
          <div class="detail-field">
            <div class="detail-field-label">Monthly Payment</div>
            <div class="detail-amount-buttons" id="detailAmountButtons">
              <button class="detail-amount-btn" data-amount="25">$25</button>
              <button class="detail-amount-btn" data-amount="50">$50</button>
              <button class="detail-amount-btn" data-amount="75">$75</button>
              <button class="detail-amount-btn" data-amount="100">$100</button>
              <input type="number" class="detail-amount-custom" id="detailPayCustom" placeholder="Custom $" min="0">
            </div>
          </div>
          <div class="detail-field">
            <div class="detail-field-label">Credit Balance</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="number" class="detail-edit-input" id="detailCredit" placeholder="0" style="flex: 1;">
              <span style="font-size: 20px; color: #fbbf24;">$</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-section-title">ðŸ“ Additional Information</div>
          <div class="detail-field">
            <div class="detail-field-label">Aliases (comma-separated)</div>
            <textarea class="detail-edit-input" id="detailAliases" rows="2" placeholder="Nickname, Alternative name, etc."></textarea>
          </div>
          <div class="detail-field">
            <div class="detail-field-label">Notes</div>
            <textarea class="detail-edit-input" id="detailNotes" rows="4" placeholder="Add notes about the student..."></textarea>
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-section-title">ðŸŽ Credit History</div>
          <div class="credit-timeline" id="creditTimeline">
            <!-- Timeline items loaded dynamically -->
            <div style="color: rgba(255, 255, 255, 0.5); font-size: 13px; text-align: center">
              No credit history available
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn-primary" id="saveDetailsBtn">ðŸ’¾ Save All Changes</button>
          <button class="btn-secondary" id="cancelDetailsBtn">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ============================================================
         FLOATING NAVIGATION BAR
         ============================================================ -->
    <div class="floating-nav expanded">
      <div class="nav-row">
        <!-- Top Row - Module Buttons -->
        <div class="nav-row-top">
          <button class="nav-btn" id="navEmailSystemBtn" onclick="openModulePopup('Email-System.html', 'ðŸ“§ Email System')" title="Email System">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
          </button>
          <button class="nav-btn" id="navGroupManagerBtn" onclick="openModulePopup('Group-Manager.html', 'ðŸ‘¥ Group Manager')" title="Group Manager">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </button>
          <button class="nav-btn" id="navStudentManagerBtn" onclick="openModulePopup('Student-Manager.html', 'ðŸ‘¨â€ðŸŽ“ Student Manager')" title="Student Manager">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
              <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
            </svg>
          </button>
          <button class="nav-btn" id="navCalendarBtn" onclick="openModulePopup('Calendar.html', 'ðŸ“… Smart Calendar')" title="Smart Payment Calendar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </button>
          <button class="nav-btn" id="navEarningForecastBtn" onclick="openModulePopup('Earning-Forecast.html', 'ðŸ’° Earning Forecast')" title="Earning Forecast Overview">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
          </button>
          <button id="navQuickViewBtn" class="nav-btn" onclick="openModulePopup('Group-Schedule-Quick-View.html', 'ðŸ“… Group Schedules')" title="Quick View â€“ Group Schedules" data-bound="1">â—ˆ</button>
        </div>

        <!-- Main Row - Existing Buttons -->
        <div class="nav-row-main">
          <!-- Countdown Timer -->
          <div id="navCountdownTimer" class="time-none" draggable="true" title="Loading countdown...">
            <span class="timer-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M12 12 L12 3 A9 9 0 0 1 21 12 Z" fill="currentColor" opacity="0.3"/>
                <line x1="12" y1="12" x2="12" y2="5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <line x1="12" y1="12" x2="18" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            <span class="timer-text"></span>
          </div>

          <button class="nav-btn" id="navTopBtn" title="Scroll to Top">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="18 15 12 9 6 15"></polyline>
            </svg>
          </button>
          <button class="nav-btn" id="navRefreshBtn" title="Refresh Data">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="23 4 23 10 17 10"></polyline>
              <polyline points="1 20 1 14 7 14"></polyline>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
          </button>
          <button class="nav-btn" id="notificationBellBtn" onclick="openModulePopup('Notification-Center.html', 'ðŸ”” Notifications')" title="Notifications">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <span id="notificationBadge" class="nav-badge" style="display: none;">0</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Navigation Settings Backdrop -->
    <div class="nav-context-menu-overlay" id="navContextMenuOverlay"></div>

    <!-- Navigation Settings Context Menu -->
    <div class="nav-context-menu" id="navContextMenu">
      <div class="nav-settings-title">âš™ï¸ Navigation Settings</div>

      <div class="nav-setting-item">
        <div class="nav-setting-label">
          <span>Size</span>
          <span class="nav-setting-value" id="sizeValue">40px</span>
        </div>
        <input type="range" class="nav-slider" id="navSizeSlider" min="30" max="60" value="40" step="5" />
      </div>

      <div class="nav-setting-item">
        <div class="nav-setting-label">
          <span>Opacity</span>
          <span class="nav-setting-value" id="opacityValue">95%</span>
        </div>
        <input type="range" class="nav-slider" id="navOpacitySlider" min="1" max="100" value="95" step="1" />
      </div>

      <div class="nav-setting-item">
        <div class="nav-setting-label">
          <span>Position</span>
          <span class="nav-setting-value" id="positionValue">80px</span>
        </div>
        <input type="range" class="nav-slider" id="navPositionSlider" min="20" max="200" value="80" step="10" />
      </div>

      <div class="nav-setting-item">
        <div class="nav-setting-label">
          <span>Handle Size</span>
          <span class="nav-setting-value" id="handleSizeValue">16px</span>
        </div>
        <input type="range" class="nav-slider" id="navHandleSizeSlider" min="6" max="40" value="16" step="2" />
      </div>

      <div class="nav-setting-item">
        <div class="nav-setting-label">
          <span>Navbar Location</span>
          <span class="nav-setting-value" id="locationValue">Right Bottom</span>
        </div>
        <select class="nav-selector" id="navLocationSelect">
          <option value="right-bottom">Right Bottom</option>
          <option value="right-top">Right Top</option>
          <option value="left-bottom">Left Bottom</option>
          <option value="left-top">Left Top</option>
          <option value="top-left">Top Left</option>
          <option value="top-right">Top Right</option>
          <option value="bottom-left">Bottom Left</option>
          <option value="bottom-right">Bottom Right</option>
        </select>
      </div>

      <div class="nav-setting-item">
        <label class="nav-toggle">
          <input type="checkbox" id="navAutoHideToggle" />
          <span class="nav-toggle-switch"></span>
          <span class="nav-setting-label" style="margin: 0">Auto-hide</span>
        </label>
      </div>

      <div class="nav-setting-item">
        <label class="nav-toggle">
          <input type="checkbox" id="navStayExpandedToggle" />
          <span class="nav-toggle-switch"></span>
          <span class="nav-setting-label" style="margin: 0">Stay Expanded on Hover</span>
        </label>
      </div>

      <div class="nav-setting-item">
        <label class="nav-toggle">
          <input type="checkbox" id="navLockButtonsToggle" />
          <span class="nav-toggle-switch"></span>
          <span class="nav-setting-label" style="margin: 0">ðŸ”’ Lock Button Positions</span>
        </label>
      </div>

      <div class="nav-setting-item">
        <button 
          id="addNewNavButton" 
          style="width: 100%; padding: 12px; background: linear-gradient(135deg, rgba(138,180,255,0.2), rgba(168,85,247,0.2)); border: 1px solid rgba(138,180,255,0.4); border-radius: 10px; color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s ease;"
          onmouseover="this.style.background='linear-gradient(135deg, rgba(138,180,255,0.3), rgba(168,85,247,0.3))'"
          onmouseout="this.style.background='linear-gradient(135deg, rgba(138,180,255,0.2), rgba(168,85,247,0.2))'"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          <span>Add New Button</span>
        </button>
      </div>
    </div>

    <!-- Sync Date Range Modal -->
    <div class="nav-context-menu-overlay" id="syncModalOverlay" style="display: none;"></div>
  <div class="nav-context-menu" id="syncModal" style="display: none; max-width: 520px;">
      <div class="nav-settings-title">ðŸ“… Sync Gmail Payments</div>

      <div class="nav-setting-item">
        <div id="dateRangePicker" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(138,180,255,0.3); border-radius: 12px; padding: 16px; min-height: 360px;">
          <!-- Calendar will be generated here -->
        </div>
      </div>

      <div style="display: flex; gap: 12px; padding: 12px; background: rgba(138,180,255,0.1); border-radius: 8px; margin-top: 16px;">
        <div style="flex: 1;">
          <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-bottom: 4px;">FROM</div>
          <div id="selectedFromDate" style="font-size: 13px; font-weight: 700; color: #8ab4ff;">-</div>
        </div>
        <div style="flex: 1;">
          <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-bottom: 4px;">TO</div>
          <div id="selectedToDate" style="font-size: 13px; font-weight: 700; color: #8ab4ff;">-</div>
        </div>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button
          class="nav-btn"
          id="startSyncBtn"
          onclick="startDateRangeSync()"
          style="flex: 1; padding: 10px; background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(16,185,129,0.2)); border: 1px solid rgba(34,197,94,0.4); border-radius: 10px; color: #22c55e; cursor: pointer; font-weight: 600;"
        >
          Sync
        </button>
        <button
          class="nav-btn"
          id="cancelSyncBtn"
          onclick="closeSyncModal()"
          style="flex: 1; padding: 10px; background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(220,38,38,0.2)); border: 1px solid rgba(239,68,68,0.4); border-radius: 10px; color: #ef4444; cursor: pointer; font-weight: 600;"
        >
          Cancel
        </button>
      </div>
    </div>

    <!-- Gmail Timezone Context Menu -->
    <!-- Gmail context menu removed - now always uses LA timezone -->

    <!-- SQL Help Modal -->
    <div id="sqlHelpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 10000; overflow-y: auto; padding: 40px 20px;">
      <div style="max-width: 1200px; margin: 0 auto; background: linear-gradient(135deg, rgba(20,20,40,0.98), rgba(30,30,60,0.98)); border-radius: 20px; border: 1px solid rgba(138,180,255,0.3); box-shadow: 0 20px 60px rgba(0,0,0,0.5); padding: 30px;">
        
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid rgba(138,180,255,0.3);">
          <h2 style="color: #fff; margin: 0; font-size: 28px; font-weight: 700;">
            ðŸ“š Supabase SQL Help Guide
          </h2>
          <button onclick="closeSQLHelpModal()" style="background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); color: #ef4444; border-radius: 10px; padding: 10px 20px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
            âœ• Close
          </button>
        </div>

        <!-- Content Sections -->
        <div style="display: grid; gap: 25px;">
          
          <!-- Section 1: Database Structure -->
          <div class="sql-section">
            <h3 style="color: #8ab4ff; margin: 0 0 15px 0; font-size: 20px; font-weight: 600;">
              1ï¸âƒ£ Database Structure Queries
            </h3>
            <p style="color: #ccc; margin-bottom: 15px; font-size: 14px;">See what tables exist and their column structure</p>
            
            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">ðŸ” COMPLETE DATABASE SCHEMA (All tables + columns + constraints)</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT \n    c.table_name,\n    c.column_name,\n    c.ordinal_position,\n    c.data_type,\n    c.udt_name AS postgres_type,\n    c.character_maximum_length,\n    c.is_nullable,\n    c.column_default,\n    tc.constraint_type,\n    tc.constraint_name\nFROM information_schema.columns c\nLEFT JOIN information_schema.key_column_usage kcu\n    ON c.table_name = kcu.table_name\n   AND c.column_name = kcu.column_name\n   AND c.table_schema = kcu.table_schema\nLEFT JOIN information_schema.table_constraints tc\n    ON tc.constraint_name = kcu.constraint_name\n   AND tc.table_schema = kcu.table_schema\nWHERE c.table_schema = 'public'\nORDER BY c.table_name, c.ordinal_position;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT 
    c.table_name,
    c.column_name,
    c.ordinal_position,
    c.data_type,
    c.udt_name AS postgres_type,
    c.character_maximum_length,
    c.is_nullable,
    c.column_default,
    tc.constraint_type,
    tc.constraint_name
FROM information_schema.columns c
LEFT JOIN information_schema.key_column_usage kcu
    ON c.table_name = kcu.table_name
   AND c.column_name = kcu.column_name
   AND c.table_schema = kcu.table_schema
LEFT JOIN information_schema.table_constraints tc
    ON tc.constraint_name = kcu.constraint_name
   AND tc.table_schema = kcu.table_schema
WHERE c.table_schema = 'public'
ORDER BY c.table_name, c.ordinal_position;</pre>
              <p style="color: #4ade80; font-size: 12px; margin-top: 8px; font-weight: 600;">â­ MAIN HELPER: Shows complete database schema with all details including primary keys, foreign keys, and constraints</p>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">See ALL tables in your database</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT table_name \nFROM information_schema.tables \nWHERE table_schema = 'public' \nORDER BY table_name;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;</pre>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">See structure of a specific table</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT column_name, data_type, is_nullable, column_default\nFROM information_schema.columns \nWHERE table_name = 'students' \nORDER BY ordinal_position;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns 
WHERE table_name = 'students' 
ORDER BY ordinal_position;</pre>
              <p style="color: #aaa; font-size: 12px; margin-top: 8px; font-style: italic;">ðŸ’¡ Replace 'students' with any table name</p>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">Count rows in each table</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT \n  schemaname,\n  tablename,\n  n_tup_ins as total_rows\nFROM pg_stat_user_tables\nORDER BY tablename;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT 
  schemaname,
  tablename,
  n_tup_ins as total_rows
FROM pg_stat_user_tables
ORDER BY tablename;</pre>
            </div>
          </div>

          <!-- Section 2: Timezone Offset -->
          <!-- Timezone offset section removed - now always uses LA timezone -->

          <!-- Section 3: Admin Accounts -->
          <div class="sql-section">
            <h3 style="color: #8ab4ff; margin: 0 0 15px 0; font-size: 20px; font-weight: 600;">
              3ï¸âƒ£ Admin Accounts Queries
            </h3>
            <p style="color: #ccc; margin-bottom: 15px; font-size: 14px;">View and manage admin access</p>
            
            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">See ALL admin accounts</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT email, auth_user_id \nFROM admin_accounts \nORDER BY email;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT email, auth_user_id 
FROM admin_accounts 
ORDER BY email;</pre>
              <p style="color: #aaa; font-size: 12px; margin-top: 8px; font-style: italic;">ðŸ’¡ Table has 2 main columns: auth_user_id (PK, FK to auth.users), email (UNIQUE)</p>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">Check if specific email is admin</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT * FROM admin_accounts \nWHERE email = 'hrachfilm@gmail.com';`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT * FROM admin_accounts 
WHERE email = 'hrachfilm@gmail.com';</pre>
            </div>
          </div>

          <!-- Section 4: Students -->
          <div class="sql-section">
            <h3 style="color: #8ab4ff; margin: 0 0 15px 0; font-size: 20px; font-weight: 600;">
              4ï¸âƒ£ Students Queries
            </h3>
            <p style="color: #ccc; margin-bottom: 15px; font-size: 14px;">View and filter student data</p>
            
            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">See ALL students</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT id, name, email, group_name, balance, show_in_grid, price_per_class\nFROM students \nORDER BY name;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT id, name, email, group_name, balance, show_in_grid, price_per_class
FROM students 
ORDER BY name;</pre>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">See only ACTIVE students (show_in_grid = true)</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT id, name, email, group_name, balance\nFROM students \nWHERE show_in_grid = true\nORDER BY name;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT id, name, email, group_name, balance
FROM students 
WHERE show_in_grid = true
ORDER BY name;</pre>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">See students with negative balance (owe money)</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT id, name, email, balance\nFROM students \nWHERE balance < 0\nORDER BY balance;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT id, name, email, balance
FROM students 
WHERE balance < 0
ORDER BY balance;</pre>
            </div>
          </div>

          <!-- Section 5: Payment Records -->
          <div class="sql-section">
            <h3 style="color: #8ab4ff; margin: 0 0 15px 0; font-size: 20px; font-weight: 600;">
              5ï¸âƒ£ Payment Records Queries
            </h3>
            <p style="color: #ccc; margin-bottom: 15px; font-size: 14px;">Track manual payment records and revenue</p>
            
            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">See ALL payment records</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT id, student_name, amount, status, date, notes\nFROM payment_records \nORDER BY date DESC;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT id, student_name, amount, status, date, notes
FROM payment_records 
ORDER BY date DESC;</pre>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">See only PAID records</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT id, student_name, amount, date\nFROM payment_records \nWHERE status = 'paid'\nORDER BY date DESC;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT id, student_name, amount, date
FROM payment_records 
WHERE status = 'paid'
ORDER BY date DESC;</pre>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">Calculate total revenue from paid records</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT \n  COUNT(*) as total_payments,\n  SUM(amount) as total_revenue\nFROM payment_records \nWHERE status = 'paid';`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT 
  COUNT(*) as total_payments,
  SUM(amount) as total_revenue
FROM payment_records 
WHERE status = 'paid';</pre>
            </div>
          </div>

          <!-- Section 6: Zelle Payments -->
          <div class="sql-section">
            <h3 style="color: #8ab4ff; margin: 0 0 15px 0; font-size: 20px; font-weight: 600;">
              6ï¸âƒ£ Zelle Payments Queries
            </h3>
            <p style="color: #ccc; margin-bottom: 15px; font-size: 14px;">View Gmail-imported Zelle payments and matching status</p>
            
            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">See ALL Zelle payments</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT id, sender_name, amount, timestamp, student_id, resolved_student_name\nFROM payments \nORDER BY timestamp DESC;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT id, sender_name, amount, timestamp, student_id, resolved_student_name
FROM payments 
ORDER BY timestamp DESC;</pre>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">See UNMATCHED Zelle payments (not linked to students)</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT id, sender_name, amount, timestamp\nFROM payments \nWHERE student_id IS NULL AND resolved_student_name IS NULL\nORDER BY timestamp DESC;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT id, sender_name, amount, timestamp
FROM payments 
WHERE student_id IS NULL AND resolved_student_name IS NULL
ORDER BY timestamp DESC;</pre>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">See MATCHED Zelle payments (linked to students)</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT id, sender_name, amount, timestamp, resolved_student_name\nFROM payments \nWHERE student_id IS NOT NULL OR resolved_student_name IS NOT NULL\nORDER BY timestamp DESC;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT id, sender_name, amount, timestamp, resolved_student_name
FROM payments 
WHERE student_id IS NOT NULL OR resolved_student_name IS NOT NULL
ORDER BY timestamp DESC;</pre>
            </div>
          </div>

          <!-- Section 7: Quick Actions -->
          <div class="sql-section">
            <h3 style="color: #8ab4ff; margin: 0 0 15px 0; font-size: 20px; font-weight: 600;">
              7ï¸âƒ£ Quick Reference Commands
            </h3>
            <p style="color: #ccc; margin-bottom: 15px; font-size: 14px;">Common one-liners you'll use often</p>
            
            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">Count total students</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT COUNT(*) as total_students FROM students;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT COUNT(*) as total_students FROM students;</pre>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">Count active students</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT COUNT(*) as active_students FROM students WHERE show_in_grid = true;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT COUNT(*) as active_students FROM students WHERE show_in_grid = true;</pre>
            </div>

            <div class="sql-query-block">
              <div class="sql-query-header">
                <span style="color: #fff; font-size: 13px; font-weight: 600;">Get database size</span>
                <button class="sql-copy-btn" onclick="copySQLQuery(this, `SELECT pg_size_pretty(pg_database_size(current_database())) as database_size;`)">ðŸ“‹ Copy</button>
              </div>
              <pre style="background: rgba(0,0,0,0.4); border: 1px solid rgba(138,180,255,0.2); border-radius: 8px; padding: 15px; margin: 10px 0 0 0; overflow-x: auto; color: #8ab4ff; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">SELECT pg_size_pretty(pg_database_size(current_database())) as database_size;</pre>
            </div>
          </div>

        </div>

        <!-- Footer Note -->
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(138,180,255,0.2); text-align: center; color: #aaa; font-size: 13px;">
          ðŸ’¡ <strong>Tip:</strong> Copy any query and paste it into Supabase SQL Editor to run it
        </div>

      </div>
    </div>

    <!-- Module Assignment Modal -->
    <div class="nav-context-menu" id="moduleAssignmentModal" style="display: none;">
      <div class="nav-settings-title">ðŸ”§ Assign Module to Button</div>

      <div class="nav-setting-item">
        <div class="nav-setting-label">
          <span>Choose Module:</span>
        </div>
        <select class="nav-selector" id="moduleSelect">
          <option value="">-- Select Module --</option>
          <option value="index">ðŸ  Main Dashboard (index.html)</option>
          <option value="index.mobile">ðŸ“± Mobile Dashboard (index.mobile.html)</option>
          <option value="email-system">âœ‰ï¸ Email System (email-system-complete.html)</option>
          <option value="payment-records">ðŸ’³ Payment Records (payment-records-new.html)</option>
        </select>
      </div>

      <div class="nav-setting-item" style="margin-top: 16px;">
        <div class="nav-setting-label">
          <span>Custom Icon (optional):</span>
        </div>
        <input
          type="text"
          id="moduleIcon"
          placeholder="Emoji or Unicode (e.g., ðŸ )"
          style="width: 100%; padding: 8px; background: rgba(255,255,255,0.08); border: 1px solid rgba(138,180,255,0.3); border-radius: 8px; color: white; outline: none;"
        />
      </div>

      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button
          class="nav-btn"
          id="assignModuleBtn"
          style="flex: 1; padding: 10px; background: linear-gradient(135deg, rgba(138,180,255,0.2), rgba(168,85,247,0.2)); border: 1px solid rgba(138,180,255,0.4); border-radius: 10px; color: white; cursor: pointer; font-weight: 600;"
        >
          âœ… Assign
        </button>
        <button
          class="nav-btn"
          id="cancelAssignBtn"
          style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: rgba(255,255,255,0.7); cursor: pointer; font-weight: 600;"
        >
          âŒ Cancel
        </button>
      </div>
    </div>

    <!-- ============================================================
         COUNTDOWN TIMER POPUP MODAL
         ============================================================ -->
    <div id="countdownPopupOverlay" class="countdown-popup-overlay" style="display: none;">
      <div id="countdownPopup" class="countdown-popup">
        <div class="countdown-popup-header">
          <span class="countdown-popup-title">Upcoming Classes</span>
          <button class="countdown-popup-close" id="closeCountdownPopup">âœ•</button>
        </div>
        <div class="countdown-popup-body" id="countdownPopupBody">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <script>
      // ============================================================
      // SUPABASE INITIALIZATION
      // ============================================================
      const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';

      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      // Make supabaseClient globally accessible
      window.supabaseClient = supabaseClient;

      if (window.ArnomaAuth?.attachAuthListener) {
        window.ArnomaAuth.attachAuthListener(supabaseClient);
      }

      let currentAdminSession = null;
      let adminSessionPromise = null;

      function requireAdminSession() {
        if (!adminSessionPromise) {
          adminSessionPromise = (async () => {
            try {
              const session = window.ArnomaAuth
                ? await window.ArnomaAuth.ensureSession(supabaseClient, { redirectToLogin: true })
                : (await supabaseClient.auth.getSession()).data.session;

              if (!session?.user?.email) {
                console.error('âŒ No authenticated session');
                window.location.href = 'index.html';
                throw new Error('NO_SESSION');
              }

              // Check if user is in admin_accounts table
              const { data: adminCheck, error: adminError } = await supabaseClient
                .from('admin_accounts')
                .select('email')
                .eq('email', session.user.email)
                .maybeSingle();

              if (adminError || !adminCheck) {
                console.error('âŒ Access denied - not an admin:', session.user.email);
                alert('Access Denied\n\nThis page is for administrators only.\n\nRedirecting to student portal...');
                await supabaseClient.auth.signOut();
                window.location.href = 'student-portal.html';
                throw new Error('ACCESS_DENIED');
              }

              // Admin verified
              document.body.classList.add('admin-verified');
              currentAdminSession = session;
              debugLog('âœ… Admin access verified for', session.user.email);
              return session;
            } catch (error) {
              console.error('âŒ Admin session verification failed:', error);
              if (error.message !== 'ACCESS_DENIED' && error.message !== 'NO_SESSION') {
                window.location.href = 'index.html';
              }
              throw error;
            }
          })();
        }

        return adminSessionPromise;
      }

      // ============================================================
      // ðŸŒ LA TIMEZONE UTILITIES (EXACT COPY FROM CALENDAR.HTML)
      // ============================================================
      
      // Create formatter for LA timezone
      const laDateTimeFormatter = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/Los_Angeles',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        weekday: 'long',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });

      /**
       * Get date/time parts in LA timezone from any Date object
       * Returns: { year: '2025', month: '12', day: '08', weekday: 'Sunday', hour: '16', minute: '43', second: '00' }
       */
      function getLAParts(dateInput) {
        const date = dateInput instanceof Date ? dateInput : new Date(dateInput);
        const parts = {};
        laDateTimeFormatter.formatToParts(date).forEach(part => {
          parts[part.type] = part.value;
        });
        return parts;
      }

      /**
       * Get current date/time parts in LA timezone
       * Returns: { year: '2025', month: '12', day: '08', weekday: 'Sunday', hour: '16', minute: '43', second: '00' }
       */
      function getTodayLAParts() {
        return getLAParts(new Date());
      }

      // ============================================================
      // âš¡ PERFORMANCE UTILITIES
      // ============================================================
      
      // Production mode - set to false to disable debug logging
      const DEBUG_MODE = false;
      
      // Legacy debug flags (kept for compatibility but ignored when DEBUG_MODE = false)
      const PAYMENT_RECORDS_DEBUG = DEBUG_MODE && (
        window?.PAYMENT_RECORDS_DEBUG === true ||
        localStorage.getItem('paymentRecords:debug') === 'true'
      );

      const PAYMENT_RECORDS_LEGACY_ALIASES =
        window?.PAYMENT_RECORDS_USE_LEGACY_ALIASES === true ||
        localStorage.getItem('paymentRecords:useLegacyAliasesTable') === 'true';

      // Debug logging wrapper (only logs when DEBUG_MODE is true)
      const debugLog = (...args) => {
        if (DEBUG_MODE) {
          console.log(...args);
        }
      };

      const debugWarn = (...args) => {
        if (DEBUG_MODE) {
          console.warn(...args);
        }
      };

      // Global blur manager ensures background blur toggles cleanly across overlays
      const BlurManager = {
        refCount: 0,
        layer: null,
        ensureLayer() {
          if (!this.layer || !document.body.contains(this.layer)) {
            this.layer = document.getElementById('globalBlurLayer');
          }
          return this.layer;
        },
        enable(strength = 14) {
          const layer = this.ensureLayer();
          if (!layer) return;
          this.refCount += 1;
          layer.classList.add('active');
        },
        disable(force = false) {
          const layer = this.ensureLayer();
          if (!layer) return;
          if (force) {
            this.refCount = 0;
          } else {
            this.refCount = Math.max(0, this.refCount - 1);
          }
          if (this.refCount === 0) {
            layer.classList.remove('active');
          }
        },
        reset() {
          const layer = this.ensureLayer();
          if (!layer) return;
          this.refCount = 0;
          layer.classList.remove('active');
        }
      };
      
      // DOM Cache
      const DOMCache = {
        paymentsGrid: null,
        searchInput: null,
        
        init() {
          this.paymentsGrid = document.getElementById('paymentsGrid');
          this.searchInput = document.getElementById('searchInput');
          debugLog('âœ… Payment Records DOM Cache initialized');
        },
        
        get(key) {
          return this[key] || document.getElementById(key);
        }
      };
      
      // Data Cache
      const DataCache = {
        payments: null,
        students: null,
        lastFetch: {},
        TTL: 5 * 60 * 1000,
        
        set(key, value) {
          this[key] = value;
          this.lastFetch[key] = Date.now();
        },
        
        get(key) {
          const age = Date.now() - (this.lastFetch[key] || 0);
          if (age > this.TTL) {
            this[key] = null;
            delete this.lastFetch[key];
            return null;
          }
          return this[key];
        }
      };

      // ============================================================
      // PERFORMANCE CONFIG & STATE ENGINE
      // ============================================================
      const PaymentRecordsEngine = (() => {
        const config = {
          pageSize: 500,
          maxRecords: 300, // âš¡ OPTIMIZED: Reduced from 600 for faster initial load (pagination handles more)
          cacheTTL: 5 * 60 * 1000, // âš¡ Increased to 5 minutes for lightning-fast reloads
          defaultUsdToAmd: 387.5,
          initialRenderLimit: 100, // âš¡ OPTIMIZED: Reduced from 200 for even snappier initial load
          renderBatchSize: 100 // âš¡ OPTIMIZED: Reduced from 150 for smoother incremental loading
        };

        const dom = {
          grid: null,
          rowsHost: null,
          loading: null,
          empty: null,
          recordCountLabel: null,
          totalRecords: null,
          filteredRecords: null,
          monthSelector: null,
          monthTotalCount: null,
          monthTotalUSD: null,
          monthTotalAMD: null,
          searchInput: null,
          loadMoreWrapper: null,
          loadMoreBtn: null,
          loadMoreHint: null
        };

        const formatCache = {
          dateLabel: new Map(),
          timeLabel: new Map()
        };

        const templates = {
          paymentCard: null,
          dateGroupShell: null // âš¡ New: Pre-built date group template for speed
        };

        const state = {
          initialized: false,
          loadingPromise: null,
          payments: [],
          filtered: [],
          paymentLookup: new Map(),
          referenceCache: null,
          paymentsCache: null, // Cache for payments data
          totalsCache: null, // Cache for grand totals
          totalsCacheTime: null, // Timestamp for totals cache
          students: new Map(),
          groups: new Map(),
          aliasMap: new Map(),
          studentNameMap: new Map(),
          creditPaymentsByStudent: new Map(),
          usdToAmdRate: Number(localStorage.getItem('paymentRecords:usdToAmdRate')) || config.defaultUsdToAmd,
          filters: {
            search: '',
            methods: new Set(),
            groups: new Set(),
            statuses: new Set(),
            dateFrom: null,
            dateTo: null,
            monthFilter: 'all' // Match UI default
          },
          indexes: {
            payer: new Map(),
            student: new Map(),
            memo: new Map(),
            month: new Map(),
            amount: new Map(),
            date: new Map()
          },
          renderWindow: {
            visibleCount: 0,
            totalCount: 0,
            lastChunkSize: 0,
            renderedCount: 0
          }
        };

        function initDomRefs() {
          if (dom.grid) return;
          dom.grid = document.getElementById('paymentsGrid');
          if (dom.grid) {
            dom.rowsHost = document.getElementById('paymentRowsContainer');
            if (!dom.rowsHost) {
              dom.rowsHost = document.createElement('div');
              dom.rowsHost.className = 'payment-groups-wrapper';
              dom.rowsHost.id = 'paymentRowsContainer';
              dom.grid.appendChild(dom.rowsHost);
            }
          }
          dom.loading = document.getElementById('loadingState');
          dom.empty = document.getElementById('emptyState');
          dom.recordCountLabel = document.getElementById('recordCount');
          dom.totalRecords = document.getElementById('totalRecords');
          dom.filteredRecords = document.getElementById('filteredRecords');
          dom.monthSelector = document.getElementById('monthSelector');
          dom.monthTotalCount = document.getElementById('monthTotalCount');
          dom.monthTotalUSD = document.getElementById('monthTotalUSD');
          dom.monthTotalAMD = document.getElementById('monthTotalAMD');
          dom.searchInput = document.getElementById('paymentsSearchInput');
          dom.loadMoreWrapper = document.getElementById('gridLoadMoreWrapper');
          dom.loadMoreBtn = document.getElementById('gridLoadMoreBtn');
          dom.loadMoreHint = document.getElementById('gridLoadMoreHint');
        }

        function ensureTemplates() {
          if (templates.paymentCard && templates.dateGroupShell) return;
          
          // âš¡ Payment card template (existing)
          const cardTemplate = document.createElement('template');
          cardTemplate.innerHTML = `
            <article class="payment-card" role="listitem">
              <div class="payment-card-row">
                <div class="payment-cell payment-time" data-field="time"></div>
                <div class="payment-cell payment-payer">
                  <span class="payer-name" data-role="payer-button" role="button" tabindex="0"></span>
                </div>
                <div class="payment-cell payment-student" data-field="student"></div>
                <div class="payment-cell payment-group">
                  <span class="group-badge" data-field="group"></span>
                </div>
                <div class="payment-cell payment-amount">
                  <span class="amount-usd" data-field="amountUsd"></span>
                  <span class="amount-separator">â€”</span>
                  <span class="amount-amd" data-field="amountAmd"></span>
                </div>
                <div class="payment-cell payment-for-class" data-field="forClass"></div>
                <div class="payment-cell payment-message" data-field="message"></div>
                <div class="payment-cell payment-actions">
                  <button class="payment-menu-btn" data-role="action-menu" type="button">â‹®</button>
                </div>
              </div>
            </article>
          `;
          templates.paymentCard = cardTemplate;
          
          // âš¡ NEW: Date group shell template for ultra-fast rendering
          const dateGroupTemplate = document.createElement('template');
          dateGroupTemplate.innerHTML = `
            <section class="payments-date-group">
              <div class="date-separator">
                <div class="date-separator-date" data-label></div>
                <div class="date-separator-total">
                  <span style="color: rgba(229, 231, 235, 0.9);">Total:</span>
                  <span class="total-usd" data-usd></span>
                  <span class="total-separator">â€”</span>
                  <span class="total-amd" data-amd></span>
                </div>
              </div>
              <div class="date-group-shell">
                <div class="date-group-header">
                  <div>TIME</div>
                  <div>PAYER NAME</div>
                  <div>STUDENT NAME</div>
                  <div>GROUP</div>
                  <div>AMOUNT (USD â€” AMD)</div>
                  <div>FOR CLASS</div>
                  <div>MESSAGE</div>
                  <div>â‹®</div>
                </div>
                <div class="payment-rows-container"></div>
              </div>
            </section>
          `;
          templates.dateGroupShell = dateGroupTemplate;
        }

        function showLoading(show) {
          // Silent loading - no visible spinner
          if (dom.grid) {
            dom.grid.setAttribute('aria-busy', show ? 'true' : 'false');
          }
        }

        function showEmptyState(show) {
          if (dom.empty) {
            dom.empty.style.display = show ? 'block' : 'none';
          }
        }

        function formatDateKey(timestampMs) {
          // Use LA timezone for date grouping (not UTC)
          const laParts = getLAParts(new Date(timestampMs));
          return `${laParts.year}-${laParts.month}-${laParts.day}`;
        }

        function getDateLabel(dateKey) {
          if (formatCache.dateLabel.has(dateKey)) {
            const cached = formatCache.dateLabel.get(dateKey);
            if (typeof cached === 'string') {
              const fallback = {
                html: cached,
                text: cached.replace(/<[^>]+>/g, '').trim()
              };
              formatCache.dateLabel.set(dateKey, fallback);
              return fallback;
            }
            return cached;
          }
          const [year, month, day] = dateKey.split('-').map(Number);
          const date = new Date(year, month - 1, day);
          const dateFormatter = new Intl.DateTimeFormat('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric'
          });
          const dayFormatter = new Intl.DateTimeFormat('en-US', {
            weekday: 'long'
          });
          const html = `${dateFormatter.format(date)} - <span style="color: #60a5fa;">${dayFormatter.format(date)}</span>`;
          const text = `${dateFormatter.format(date)} - ${dayFormatter.format(date)}`;
          const parts = { html, text };
          formatCache.dateLabel.set(dateKey, parts);
          return parts;
        }

        function getTimeLabel(timestampMs) {
          if (formatCache.timeLabel.has(timestampMs)) {
            return formatCache.timeLabel.get(timestampMs);
          }
          const date = new Date(timestampMs);
          debugLog('ðŸ• getTimeLabel called:', {
            input: timestampMs,
            dateObj: date.toString(),
            dateISO: date.toISOString()
          });

          // Force LA timezone display - shows LA time regardless of browser location
          const formatter = new Intl.DateTimeFormat('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true,
            timeZone: 'America/Los_Angeles'
          });
          const label = formatter.format(date);
          formatCache.timeLabel.set(timestampMs, label);
          return label;
        }

        function formatUsd(value) {
          const amount = Math.round(Number(value || 0));
          return `${amount.toLocaleString()} $`;
        }

        function formatAmd(value) {
          const amount = Math.round(Number(value || 0));
          return `${amount.toLocaleString()} Ö`;
        }

        function tokenize(value) {
          if (!value) return [];
          return value
            .toString()
            .toLowerCase()
            .replace(/[\u2019\u2018]/g, "'")
            .split(/[^a-z0-9]+/)
            .filter(Boolean);
        }

        function getMonthTokens(timestampMs) {
          const date = new Date(timestampMs);
          const monthNum = date.getMonth(); // 0-11
          const monthNames = {
            0: ['jan', 'january'],
            1: ['feb', 'february'],
            2: ['mar', 'march'],
            3: ['apr', 'april'],
            4: ['may'],
            5: ['jun', 'june'],
            6: ['jul', 'july'],
            7: ['aug', 'august'],
            8: ['sep', 'september', 'sept'],
            9: ['oct', 'october'],
            10: ['nov', 'november'],
            11: ['dec', 'december']
          };
          return monthNames[monthNum] || [];
        }

        function getAmountTokens(amountUSD) {
          const tokens = [];
          const rounded = Math.round(amountUSD);
          // Add exact amount
          tokens.push(rounded.toString());
          // Add formatted version without dollar sign (e.g., "100" for $100)
          if (amountUSD > 0) {
            tokens.push(Math.floor(amountUSD).toString());
          }
          return tokens;
        }

        function getDateTokens(timestampMs) {
          const date = new Date(timestampMs);
          const monthNum = date.getMonth(); // 0-11
          const day = date.getDate(); // 1-31
          const year = date.getFullYear();
          
          const monthNames = {
            0: ['jan', 'january'],
            1: ['feb', 'february'],
            2: ['mar', 'march'],
            3: ['apr', 'april'],
            4: ['may'],
            5: ['jun', 'june'],
            6: ['jul', 'july'],
            7: ['aug', 'august'],
            8: ['sep', 'september', 'sept'],
            9: ['oct', 'october'],
            10: ['nov', 'november'],
            11: ['dec', 'december']
          };
          
          const tokens = [];
          const monthTokens = monthNames[monthNum] || [];
          
          // Add "month day" tokens (e.g., "july 21", "jul 21")
          monthTokens.forEach(month => {
            tokens.push(`${month} ${day}`);
          });
          
          // Add "month day year" tokens (e.g., "july 21 2025", "jul 21 2025")
          monthTokens.forEach(month => {
            tokens.push(`${month} ${day} ${year}`);
          });
          
          // Add numeric date formats
          tokens.push(`${monthNum + 1}/${day}`); // "7/21"
          tokens.push(`${monthNum + 1}/${day}/${year}`); // "7/21/2025"
          
          return tokens;
        }

        function registerTokens(index, tokens, key) {
          tokens.forEach(token => {
            if (!token) return;
            if (!index.has(token)) {
              index.set(token, new Set());
            }
            index.get(token).add(key);
          });
        }

        function rebuildIndexes(records) {
          state.indexes.payer.clear();
          state.indexes.student.clear();
          state.indexes.memo.clear();
          state.indexes.month.clear();
          state.indexes.amount.clear();
          state.indexes.date.clear();
          records.forEach(record => {
            registerTokens(state.indexes.payer, record.tokens.payer, record.uniqueKey);
            registerTokens(state.indexes.student, record.tokens.student, record.uniqueKey);
            registerTokens(state.indexes.memo, record.tokens.memo, record.uniqueKey);
            registerTokens(state.indexes.month, record.tokens.month, record.uniqueKey);
            registerTokens(state.indexes.amount, record.tokens.amount, record.uniqueKey);
            registerTokens(state.indexes.date, record.tokens.date, record.uniqueKey);
          });
        }

        async function fetchReferenceData(force = false) {
          if (!force && state.referenceCache && Date.now() - state.referenceCache.ts < config.cacheTTL) {
            return state.referenceCache.data;
          }

          const [studentsRes, groupsRes, creditRes, aliasRes] = await Promise.all([
            supabaseClient
              .from('students')
              .select('*')
              .order('name', { ascending: true }),
            supabaseClient
              .from('groups')
              .select('*'),
            supabaseClient
              .from('credit_payments')
              .select('*')
              .order('class_date', { ascending: false })
              .limit(1000),
            fetchAliasPairs()
          ]);

          if (studentsRes.error) throw studentsRes.error;
          if (groupsRes.error) throw groupsRes.error;
          if (creditRes.error) throw creditRes.error;

          const result = {
            students: new Map(),
            groups: new Map(),
            aliasMap: new Map(),
            studentNameMap: new Map(),
            creditPaymentsByStudent: new Map()
          };

          (studentsRes.data || []).forEach(student => {
            result.students.set(student.id, student);

            const primaryNameKey = normalizeNameKey(student.name || student.display_name || '');
            if (primaryNameKey) {
              result.studentNameMap.set(primaryNameKey, student.id);
            }

            if (student.aliases) {
              const aliases = Array.isArray(student.aliases)
                ? student.aliases
                : student.aliases.includes('|||')
                  ? student.aliases.split('|||')
                  : student.aliases.split(',');
              aliases
                .map(normalizeNameKey)
                .filter(Boolean)
                .forEach(alias => {
                  result.aliasMap.set(alias, student.id);
                });
            }
          });

          (groupsRes.data || []).forEach(group => {
            result.groups.set(group.id || group.name, group);
          });

          (creditRes.data || []).forEach(payment => {
            if (!payment.student_id) return;
            if (!result.creditPaymentsByStudent.has(payment.student_id)) {
              result.creditPaymentsByStudent.set(payment.student_id, []);
            }
            result.creditPaymentsByStudent.get(payment.student_id).push(payment);
          });

          aliasRes.forEach(alias => {
            if (!alias || !alias.payer_name) return;
            const aliasKey = normalizeNameKey(alias.payer_name);
            if (aliasKey) {
              result.aliasMap.set(aliasKey, alias.student_id);
            }
          });

          state.referenceCache = { ts: Date.now(), data: result };
          return result;
        }

        async function fetchAliasPairs() {
          // Skip alias table queries if not explicitly enabled
          if (!PAYMENT_RECORDS_LEGACY_ALIASES) {
            return [];
          }

          const tableCandidates = ['payer_aliases', 'aliases'];
          for (const tableName of tableCandidates) {
            try {
              const { data, error } = await supabaseClient
                .from(tableName)
                .select('payer_name, student_id, student_name')
                .limit(1000);
              if (error) {
                // Silently skip if table doesn't exist (42P01) or any other error
                continue;
              }
              if (data && data.length) {
                return data;
              }
            } catch (err) {
              // Silently continue on any error including network/404
              continue;
            }
          }
          return [];
        }

        async function fetchPayments(force = false) {
          // âš¡ Use cache if available and fresh (5 minutes TTL for lightning speed)
          if (!force && state.paymentsCache && Date.now() - state.paymentsCache.ts < config.cacheTTL) {
            debugLog('âš¡ Using cached payments (age: ' + Math.round((Date.now() - state.paymentsCache.ts) / 1000) + 's) ðŸš€');
            return state.paymentsCache.data;
          }

          debugLog('ðŸ”„ Fetching fresh payments from Supabase...');
          // console.log('ðŸ” Starting payment fetch...'); 
          
          // First, get list of ignored payment IDs
          const { data: ignoredPayments } = await supabaseClient
            .from('ignored_fuchsia_payments')
            .select('payment_id');
          const ignoredIds = new Set((ignoredPayments || []).map(p => p.payment_id));
          debugLog(`ðŸ“› Found ${ignoredIds.size} ignored payments`);
          
          const payments = [];
          let rangeStart = 0;
          while (payments.length < config.maxRecords) {
            const rangeEnd = rangeStart + config.pageSize - 1;
            // console.log(`ðŸ“¥ Fetching range ${rangeStart}-${rangeEnd}...`);
            // âš¡ Optimized query: Uses indexed columns for fastest possible retrieval
            const { data, error } = await supabaseClient
              .from('payments')
              .select('*')
              .order('email_date', { ascending: false, nullsLast: false })
              .order('created_at', { ascending: false, nullsLast: false })
              .range(rangeStart, rangeEnd);

            if (error) {
              console.error('âŒ Error fetching payments:', error);
              alert(`âŒ Failed to fetch payments: ${error.message}`); // ALERT USER
              throw error;
            }
            
            if (!data || data.length === 0) {
              // console.log('âœ… No more data to fetch');
              break;
            }

            // console.log(`âœ… Received ${data.length} payments in this batch`);
            // Filter out ignored payments
            const filtered = data.filter(p => !ignoredIds.has(p.id));
            payments.push(...filtered);
            if (data.length < config.pageSize) break;
            rangeStart += config.pageSize;
          }
          
          // console.log(`âœ… TOTAL: Fetched ${payments.length} payments from Supabase`);
          debugLog(`âœ… Fetched ${payments.length} payments (${ignoredIds.size} ignored) from Supabase`);
          
          // Cache the results
          state.paymentsCache = { ts: Date.now(), data: payments };
          
          return payments;
        }

        function preparePayments(rawPayments) {
          const prepared = [];
          const lookup = new Map();

          rawPayments.forEach(raw => {
            const record = transformPayment(raw);
            prepared.push(record);
            lookup.set(record.uniqueKey, record);
          });

          prepared.sort((a, b) => b.timestampMs - a.timestampMs);
          state.paymentLookup = lookup;
          return prepared;
        }

        function normalizeNameKey(value) {
          return value
            ? value
                .toString()
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9\s]/gi, '')
                .replace(/\s+/g, ' ')
            : '';
        }

        function normalizeWellsFargoPayerName(name = '') {
          return String(name)
            .replace(/^\s*wells\s+fargo\s+home\s+page\s*/i, '')
            .replace(/^\s*wells\s+fargo\s*/i, '')
            .replace(/\s+sent\s+you.*$/i, '')
            .replace(/\s+/g, ' ')
            .trim();
        }

        function resolveStudentFromAlias(payerName, studentNameHint) {
          const normalizedPayer = normalizeWellsFargoPayerName(payerName);
          const candidates = [payerName, normalizedPayer, studentNameHint]
            .flat()
            .filter(Boolean)
            .map(normalizeNameKey)
            .filter(Boolean);

          for (const candidate of candidates) {
            const aliasId = state.aliasMap.get(candidate);
            if (aliasId && state.students.get(aliasId)) {
              return state.students.get(aliasId);
            }
          }

          for (const candidate of candidates) {
            const studentId = state.studentNameMap.get(candidate);
            if (studentId && state.students.get(studentId)) {
              return state.students.get(studentId);
            }
          }

          return null;
        }

        function extractWellsFargoMemo(text = '') {
          if (!text) return '';
          const memoPattern = /Memo:\s*([^\n\r]+?)(?:We\s+deposited|Go\s+to\s+accounts|Have\s+any\s+questions|$)/i;
          const memoMatch = String(text).match(memoPattern);
          return memoMatch ? memoMatch[1].trim() : '';
        }

        function cleanPaymentMemo(text) {
          if (!text) return '';

          let cleaned = String(text)
            .replace(/[^\x20-\x7E\n\r\t]/g, '') // Remove non-printable chars
            .replace(/\s+/g, ' ') // Collapse whitespace
            .trim();

          // Remove email footer junk
          cleaned = cleaned
            .replace(/\*?\s*If\s+you'?d?\s+rather\s+not\s+follow\s+links.*/gi, '')
            .replace(/\*?\s*The\s+money\s+is\s+ready\s+for\s+use.*/gi, '')
            .replace(/\*?\s*Pay\s+it\s+forward.*/gi, '')
            .replace(/\*?\s*Thanks\s+for\s+using\s+Zelle.*/gi, '')
            .replace(/\*?\s*You\s+can\s+add\s+a\s+note.*/gi, '')
            .replace(/\*?\s*View\s+transaction\s+details.*/gi, '')
            .replace(/http[s]?:\/\/[^\s]+/gi, '') // Remove URLs
            .trim();

          // If only footer/junk remains, return empty
          if (
            !cleaned ||
            cleaned.length < 3 ||
            /^[\*\s\-â€”.]+$/.test(cleaned) ||
            /^(The money|Pay it|If you|Thanks|You can|View)+$/i.test(cleaned)
          ) {
            return '';
          }

          // Limit to 150 chars
          if (cleaned.length > 150) {
            cleaned = cleaned.substring(0, 150).trim() + '...';
          }

          return cleaned;
        }

        function transformPayment(raw) {
          const iso = raw.email_date || raw.emaildate || raw.created_at || raw.date || new Date().toISOString();
          const timestampMs = Date.parse(iso);
          const dateKey = formatDateKey(timestampMs);
          const dateLabelParts = getDateLabel(dateKey);

          const studentNameHint = raw.student_name || raw.resolved_student_name || raw.studentname || raw.studentNameFromMessage;
          const studentIdCandidate = raw.linked_student_id || raw.student_id || raw.derived_student_id || null;
          const numericStudentId = studentIdCandidate && !Number.isNaN(Number(studentIdCandidate))
            ? Number(studentIdCandidate)
            : null;
          const studentLookupId = numericStudentId ?? studentIdCandidate;
          const payerRawInput = raw.payer_name || raw.payer || raw.payer_name_raw || raw.payername || '';
          const student = (studentLookupId ? state.students.get(studentLookupId) : null) ||
            resolveStudentFromAlias(payerRawInput, studentNameHint) || null;

          const payerOriginal = (payerRawInput || 'Unknown Payer').trim() || 'Unknown Payer';
          const payerNormalized = normalizeWellsFargoPayerName(payerOriginal) || payerOriginal;
          const payerName = formatPayerDisplayName(payerNormalized) || payerNormalized;
          const studentName = student?.name || raw.student_name || raw.resolved_student_name || raw.studentname || '';
          const amountUSD = Number(raw.amount || 0);
          const amountAMD = Math.round(amountUSD * state.usdToAmdRate);
          
          // Clean memo - prioritize memo field, fallback to message, then clean it
          const memoSource = raw.memo || raw.message || '';
          const memoFromBody = extractWellsFargoMemo(memoSource);
          const memo = cleanPaymentMemo(memoFromBody || memoSource);
          
          const groupHint = student?.group_name || raw.derived_student_group || raw.group_id || raw.groupid || '';
          const paymentMethod = (raw.payment_method || raw.method || 'unspecified').toLowerCase();
          const groupLetter = (() => {
            if (!groupHint) return '';
            const normalized = groupHint.trim();
            const match = normalized.match(/([A-F])$/i);
            if (match) return match[1].toUpperCase();
            return normalized.charAt(0).toUpperCase();
          })();
          const uniqueKey = raw.id ? `supabase:${raw.id}` : `gmail:${raw.gmail_id || raw.gmailid || iso}`;

          // âš¡ NEW: Calculate for_class_dates based on payment amount and student's price per class
          const studentPricePerClass = Number(student?.price_per_class || 0);
          const forClassDates = raw.for_class_dates || [];
          const calculatedClassCount = studentPricePerClass > 0 
            ? Math.floor(amountUSD / studentPricePerClass)
            : 0;

          return {
            id: raw.id || null,
            uniqueKey,
            source: raw.id ? 'supabase' : 'gmail',
            paymentId: raw.id || '',
            gmailId: raw.gmail_id || raw.gmailid || '',
            payerName,
            payerNameRaw: payerOriginal,
            studentName: studentName || 'â€”',
            studentId: student?.id || numericStudentId || studentIdCandidate || raw.studentid || '',
            status: raw.status || 'unmatched',
            resolutionSource: raw.resolution_source || raw.resolutionsource || 'none',
            paymentMethod,
            memo,
            timestampMs,
            isoTimestamp: iso,
            dateKey,
            dateLabel: dateLabelParts.html,
            dateLabelText: dateLabelParts.text,
            timeLabel: getTimeLabel(timestampMs),
            amountUSD,
            amountAMD,
            amountUSDLabel: formatUsd(amountUSD),
            amountAMDLabel: formatAmd(amountAMD),
            groupLetter: groupLetter || 'â€”',
            paymentMethodSlug: paymentMethod,
            studentPricePerClass,
            forClassDates,
            calculatedClassCount,
            tokens: {
              payer: tokenize(payerName),
              student: tokenize(studentName),
              memo: tokenize(memo),
              month: getMonthTokens(timestampMs),
              amount: getAmountTokens(timestampMs),
              date: getDateTokens(timestampMs)
            },
            searchBlob: `${payerName} ${studentName} ${memo} group ${groupLetter || ''}`.toLowerCase(),
            dataset: {
              paymentKey: uniqueKey,
              paymentId: raw.id || '',
              payer: payerName,
              payerRaw: payerOriginal,
              amount: amountUSD,
              amountAmd: amountAMD,
              message: memo || 'No message',
              date: dateKey,
              studentId: student?.id || raw.student_id || ''
            }
          };
        }

        function applyFilters() {
          let records = state.payments;
          const { search, dateFrom, dateTo, methods } = state.filters;

          if (search) {
            const searchLower = search.toLowerCase().trim();
            const tokens = tokenize(search);
            
            if (tokens.length) {
              // Check if search is specifically for a month or date
              const monthNames = ['jan', 'january', 'feb', 'february', 'mar', 'march', 'apr', 'april', 'may', 
                                  'jun', 'june', 'jul', 'july', 'aug', 'august', 'sep', 'sept', 'september', 
                                  'oct', 'october', 'nov', 'november', 'dec', 'december'];
              const isMonthSearch = tokens.length === 1 && monthNames.includes(tokens[0]);
              const isDateSearch = state.indexes.date.has(searchLower);
              
              // If searching for a specific month or date, ONLY search month/date indexes
              if (isMonthSearch || isDateSearch) {
                const dateOnlyMatches = new Set();
                
                if (isMonthSearch) {
                  // Search only the month index
                  const monthMatches = state.indexes.month.get(tokens[0]);
                  if (monthMatches) {
                    monthMatches.forEach(key => dateOnlyMatches.add(key));
                  }
                } else if (isDateSearch) {
                  // Search only the date index
                  const directDateMatch = state.indexes.date.get(searchLower);
                  if (directDateMatch) {
                    directDateMatch.forEach(key => dateOnlyMatches.add(key));
                  }
                }
                
                if (dateOnlyMatches.size) {
                  records = [...dateOnlyMatches]
                    .map(key => state.paymentLookup.get(key))
                    .filter(Boolean)
                    .sort((a, b) => b.timestampMs - a.timestampMs);
                } else {
                  records = [];
                }
              } else {
                // Regular multi-strategy search for non-date queries
                const phraseMatches = new Set();
                const dateMatches = new Set();
                const tokenMatches = new Set();
                
                // Strategy 1: Check if full search phrase appears in searchBlob
                state.payments.forEach(record => {
                  if (record.searchBlob && record.searchBlob.includes(searchLower)) {
                    phraseMatches.add(record.uniqueKey);
                  }
                });
                
                // Strategy 2: Check if search phrase is a date pattern
                const directDateMatch = state.indexes.date.get(searchLower);
                if (directDateMatch) {
                  directDateMatch.forEach(key => dateMatches.add(key));
                }
                
                // Strategy 3: Token-based search
                let matchingKeys = null;
                tokens.forEach(token => {
                  const bucket = new Set();
                  const payerMatches = state.indexes.payer.get(token);
                  const studentMatches = state.indexes.student.get(token);
                  const memoMatches = state.indexes.memo.get(token);
                  const monthMatches = state.indexes.month.get(token);
                  const amountMatches = state.indexes.amount.get(token);
                  const dateTokenMatches = state.indexes.date.get(token);
                  [payerMatches, studentMatches, memoMatches, monthMatches, amountMatches, dateTokenMatches].forEach(set => {
                    if (set) {
                      set.forEach(key => bucket.add(key));
                    }
                  });
                  if (!bucket.size) {
                    matchingKeys = new Set();
                  } else {
                    matchingKeys = matchingKeys
                      ? new Set([...matchingKeys].filter(key => bucket.has(key)))
                      : bucket;
                  }
                });
                
                if (matchingKeys) {
                  matchingKeys.forEach(key => tokenMatches.add(key));
                }
                
                // Combine all strategies (union - phrase match OR date match OR token match)
                const combinedMatches = new Set([...phraseMatches, ...dateMatches, ...tokenMatches]);
                
                if (combinedMatches.size) {
                  records = [...combinedMatches]
                    .map(key => state.paymentLookup.get(key))
                    .filter(Boolean)
                    .sort((a, b) => b.timestampMs - a.timestampMs);
                } else {
                  records = [];
                }
              }
            }
          }

          if (dateFrom || dateTo) {
            const fromTime = typeof dateFrom === 'number' ? dateFrom : (dateFrom ? new Date(dateFrom).getTime() : null);
            const toTime = typeof dateTo === 'number' ? dateTo : (dateTo ? new Date(dateTo).getTime() : null);
            records = records.filter(record => {
              if (fromTime && record.timestampMs < fromTime) return false;
              if (toTime && record.timestampMs > toTime) return false;
              return true;
            });
          }

          // Apply month filter from month selector
          if (state.filters.monthFilter && state.filters.monthFilter !== 'all') {
            const value = state.filters.monthFilter;
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-indexed (0 = Jan, 11 = Dec)
            let fromTime, toTime;

            switch (value) {
              case 'current':
                {
                  // Start of current month at midnight (using UTC to match stored timestamps)
                  const startOfMonth = new Date(Date.UTC(currentYear, currentMonth, 1, 0, 0, 0, 0));
                  fromTime = startOfMonth.getTime();
                  toTime = null; // No end limit for current month (ongoing)
                }
                break;
              case 'ytd':
                {
                  // Start of current year at midnight (using UTC to match stored timestamps)
                  const startOfYear = new Date(Date.UTC(currentYear, 0, 1, 0, 0, 0, 0));
                  fromTime = startOfYear.getTime();
                  toTime = null; // No end limit for YTD (ongoing)
                }
                break;
              default:
                if (/^\d{4}-\d{2}$/.test(value)) {
                  const [year, month] = value.split('-').map(Number);
                  
                  // Start of selected month at midnight UTC (month is 1-indexed in string, convert to 0-indexed)
                  const startOfMonth = new Date(Date.UTC(year, month - 1, 1, 0, 0, 0, 0));
                  
                  // End of selected month: last millisecond of the last day in UTC
                  // Date.UTC(year, month, 0) gives us the last day of the previous month
                  // which is the last day of our target month
                  const endOfMonth = new Date(Date.UTC(year, month, 0, 23, 59, 59, 999));
                  
                  fromTime = startOfMonth.getTime();
                  toTime = endOfMonth.getTime();
                  
                  debugLog(`Month filter: ${value} â†’ ${new Date(fromTime).toLocaleString()} to ${new Date(toTime).toLocaleString()}`);
                }
                break;
            }

            if (fromTime !== undefined || toTime !== undefined) {
              records = records.filter(record => {
                if (fromTime && record.timestampMs < fromTime) return false;
                if (toTime && record.timestampMs > toTime) return false;
                return true;
              });
            }
          }

          if (methods && methods.size) {
            records = records.filter(record => {
              const method = record.paymentMethodSlug || (record.paymentMethod || '').toLowerCase();
              return methods.has(method);
            });
          }

          state.filtered = records;
          return state.filtered;
        }

        // âš¡ OPTIMIZED: Use requestAnimationFrame for buttery-smooth rendering
        function render(records, options = {}) {
          if (!dom.rowsHost) return;
          ensureTemplates();
          const list = Array.isArray(records) ? records : [];
          const { mode = 'replace' } = options;

          if (!list.length) {
            if (mode === 'replace') {
              requestAnimationFrame(() => {
                dom.rowsHost.replaceChildren();
                showEmptyState(true);
                state.renderWindow.renderedCount = 0;
                updateCounters();
                updateLoadMoreControls();
              });
            }
            return;
          }

          if (mode === 'append') {
            requestAnimationFrame(() => {
              showEmptyState(false);
              list.forEach(record => insertRecordIntoDom(record));
              state.renderWindow.renderedCount += list.length;
              updateCounters();
              updateLoadMoreControls();
            });
            return;
          }

          // âš¡ Batch DOM updates in single animation frame for 60fps rendering
          requestAnimationFrame(() => {
            showEmptyState(false);
            const fragment = document.createDocumentFragment();
            let currentGroup = null;

            list.forEach(record => {
              if (!currentGroup || currentGroup.dateKey !== record.dateKey) {
                if (currentGroup) {
                  fragment.appendChild(buildDateGroup(currentGroup));
                }
                currentGroup = {
                  dateKey: record.dateKey,
                  dateLabel: record.dateLabel,
                  totalUsd: 0,
                  totalAmd: 0,
                  rows: []
                };
              }
              currentGroup.totalUsd += record.amountUSD;
              currentGroup.totalAmd += record.amountAMD;
              currentGroup.rows.push(record);
            });

            if (currentGroup) {
              fragment.appendChild(buildDateGroup(currentGroup));
            }

            dom.rowsHost.replaceChildren(fragment);
            state.renderWindow.renderedCount = list.length;
            updateCounters();
            updateLoadMoreControls();
          });
        }

        function buildDateGroup(group) {
          // âš¡ OPTIMIZED: Clone pre-built template instead of creating 15+ DOM elements
          const wrapper = templates.dateGroupShell.content.firstElementChild.cloneNode(true);
          
          // Set data attributes
          wrapper.dataset.dateKey = group.dateKey;
          wrapper.dataset.totalUsd = Number(group.totalUsd || 0).toString();
          wrapper.dataset.totalAmd = Number(group.totalAmd || 0).toString();

          // âš¡ Single query for date label and totals (cached structure)
          wrapper.querySelector('[data-label]').innerHTML = group.dateLabel;
          wrapper.querySelector('[data-usd]').textContent = formatUsd(group.totalUsd);
          wrapper.querySelector('[data-amd]').textContent = formatAmd(group.totalAmd);

          // âš¡ Batch append payment cards using DocumentFragment
          const rowsContainer = wrapper.querySelector('.payment-rows-container');
          const fragment = document.createDocumentFragment();
          group.rows.forEach(record => {
            fragment.appendChild(buildPaymentCard(record));
          });
          rowsContainer.appendChild(fragment);

          return wrapper;
        }

        /**
         * Renders date picker inputs for the "For Class" column
         * @param {HTMLElement} container - The cell container element
         * @param {Object} record - The payment record
         */
        function renderForClassDatePickers(container, record) {
          if (!container) return;
          
          // Clear existing content
          container.innerHTML = '';
          
          const classCount = record.calculatedClassCount || 0;
          
          // If no classes can be calculated (no student price or amount too small), show empty state
          if (classCount === 0) {
            const emptySpan = document.createElement('span');
            emptySpan.className = 'for-class-empty';
            emptySpan.textContent = 'â€”';
            container.appendChild(emptySpan);
            return;
          }
          
          // Parse existing dates from record (JSONB array)
          let existingDates = [];
          try {
            if (Array.isArray(record.forClassDates)) {
              existingDates = record.forClassDates;
            } else if (typeof record.forClassDates === 'string') {
              existingDates = JSON.parse(record.forClassDates);
            }
          } catch (e) {
            debugLog('âš ï¸ Failed to parse for_class_dates:', e);
            existingDates = [];
          }
          
          // Ensure array length matches calculated class count (preserve existing, pad with empty strings)
          while (existingDates.length < classCount) {
            existingDates.push('');
          }
          if (existingDates.length > classCount) {
            existingDates = existingDates.slice(0, classCount);
          }
          
          // Render date picker inputs
          existingDates.forEach((dateValue, index) => {
            const row = document.createElement('div');
            row.className = 'for-class-input-row';

            const input = document.createElement('input');
            input.type = 'text'; // Changed from 'date' to 'text' for Flatpickr
            input.className = 'for-class-date-input';
            input.value = dateValue || '';
            input.placeholder = 'Select date...';
            input.dataset.paymentId = record.paymentId || '';
            input.dataset.dateIndex = index;
            input.dataset.originalValue = input.value;
            input.readOnly = true; // Prevent keyboard input, only allow picker selection

            const actions = document.createElement('div');
            actions.className = 'for-class-actions';

            const saveBtn = document.createElement('button');
            saveBtn.type = 'button';
            saveBtn.className = 'for-class-action-btn save';
            saveBtn.textContent = 'âœ“';
            saveBtn.disabled = true;

            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.className = 'for-class-action-btn cancel';
            cancelBtn.textContent = 'âœ•';
            cancelBtn.disabled = true;

            const setDirtyState = (isDirty) => {
              saveBtn.disabled = !isDirty;
              cancelBtn.disabled = !isDirty;
              input.classList.toggle('is-dirty', isDirty);
            };

            // Initialize Flatpickr on this input
            const fp = flatpickr(input, {
              dateFormat: 'Y-m-d',
              defaultDate: dateValue || null,
              onChange: (selectedDates, dateStr) => {
                setDirtyState(dateStr !== input.dataset.originalValue);
              },
              onClose: () => {
                // Auto-focus save button when picker closes if dirty
                if (!saveBtn.disabled) {
                  saveBtn.focus();
                }
              }
            });

            saveBtn.addEventListener('click', async (e) => {
              e.stopPropagation();
              await handleForClassDateChange(input, record);
              // Update original value after successful save
              input.dataset.originalValue = input.value;
              setDirtyState(false);
              fp.setDate(input.value, false); // Update Flatpickr without triggering onChange
            });

            cancelBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const originalValue = input.dataset.originalValue || '';
              input.value = originalValue;
              fp.setDate(originalValue, false); // Revert Flatpickr without triggering onChange
              setDirtyState(false);
            });

            // Prevent event bubbling to avoid triggering card click
            input.addEventListener('click', (e) => {
              e.stopPropagation();
            });

            // Assemble: row contains input, then actions overlay on top
            actions.appendChild(saveBtn);
            actions.appendChild(cancelBtn);
            row.appendChild(input);
            row.appendChild(actions);
            container.appendChild(row);
          });
        }

        /**
         * Handles date picker change and updates Supabase
         * @param {HTMLInputElement} input - The date input element
         * @param {Object} record - The payment record
         */
        async function handleForClassDateChange(input, record) {
          const paymentId = input.dataset.paymentId;
          const dateIndex = parseInt(input.dataset.dateIndex, 10);
          const newDate = input.value;
          
          if (!paymentId) {
            debugLog('âš ï¸ Cannot update for_class_dates: missing payment ID');
            return;
          }
          
          debugLog(`ðŸ“… Updating for_class_dates[${dateIndex}] = "${newDate}" for payment ${paymentId}`);
          
          // Get all date inputs for this payment
          const container = input.parentElement;
          const allInputs = container.querySelectorAll('.for-class-date-input');
          const updatedDates = Array.from(allInputs).map(inp => inp.value || '');
          
          try {
            // Update Supabase with new dates array
            // ALSO update old for_class column with first date (for Calendar backward compatibility)
            const firstDate = updatedDates.find(d => d) || null;
            const { error } = await supabaseClient
              .from('payments')
              .update({ 
                for_class_dates: updatedDates,
                for_class: firstDate  // Keep old column synced for Calendar
              })
              .eq('id', paymentId);
            
            if (error) {
              debugLog('âŒ Failed to update for_class_dates:', error);
              customAlert('Update Failed', `Could not save class date: ${error.message}`);
              // Revert input value on error
              input.value = record.forClassDates[dateIndex] || '';
              return;
            }
            
            // Update local record
            record.forClassDates = updatedDates;
            
            // Update lookup map
            if (state.paymentLookup.has(record.uniqueKey)) {
              state.paymentLookup.get(record.uniqueKey).forClassDates = updatedDates;
            }

            input.dataset.originalValue = newDate || '';
            input.classList.remove('is-dirty');
            const actionWrap = input.parentElement?.querySelector('.for-class-actions');
            if (actionWrap) {
              actionWrap.querySelectorAll('button').forEach(btn => {
                btn.disabled = true;
              });
            }
            
            // Clear Calendar cache if it exists (forces reload)
            if (window.paymentsCache) {
              window.paymentsCache = null;
              debugLog('ðŸ”„ Cleared Calendar payment cache to force reload');
            }
            
            debugLog('âœ… Successfully updated for_class_dates');
            
          } catch (err) {
            debugLog('âŒ Exception updating for_class_dates:', err);
            customAlert('Update Failed', `An error occurred: ${err.message}`);
            // Revert input value on error
            input.value = record.forClassDates[dateIndex] || '';
          }
        }

        /**
         * Recalculates for_class_dates array when payment amount or student price changes
         * Preserves existing dates when possible, trims or pads as needed
         * @param {string} paymentId - The payment ID
         * @param {number} newAmount - The new payment amount
         * @param {number} studentPricePerClass - Student's price per class
         * @param {Array<string>} existingDates - Existing for_class_dates array
         * @returns {Array<string>} Updated dates array
         */
        async function recalculateForClassDates(paymentId, newAmount, studentPricePerClass, existingDates = []) {
          const newClassCount = studentPricePerClass > 0 
            ? Math.floor(newAmount / studentPricePerClass)
            : 0;
          
          debugLog(`ðŸ”„ Recalculating for_class_dates: ${existingDates.length} dates â†’ ${newClassCount} classes`);
          
          let updatedDates = [...existingDates];
          
          // If reduced: trim excess dates
          if (updatedDates.length > newClassCount) {
            updatedDates = updatedDates.slice(0, newClassCount);
            debugLog(`âœ‚ï¸ Trimmed ${existingDates.length - newClassCount} excess dates`);
          }
          
          // If increased: pad with empty strings
          while (updatedDates.length < newClassCount) {
            updatedDates.push('');
          }
          
          // Update Supabase
          if (paymentId) {
            try {
              // ALSO update old for_class column with first date (for Calendar backward compatibility)
              const firstDate = updatedDates.find(d => d) || null;
              const { error } = await supabaseClient
                .from('payments')
                .update({ 
                  for_class_dates: updatedDates,
                  for_class: firstDate  // Keep old column synced for Calendar
                })
                .eq('id', paymentId);
              
              if (error) {
                debugLog('âŒ Failed to recalculate for_class_dates:', error);
              } else {
                debugLog('âœ… Successfully recalculated for_class_dates');
              }
            } catch (err) {
              debugLog('âŒ Exception recalculating for_class_dates:', err);
            }
          }
          
          return updatedDates;
        }

        function buildPaymentCard(record) {
          const card = templates.paymentCard.content.firstElementChild.cloneNode(true);
          card.dataset.paymentKey = record.uniqueKey;
          card.dataset.paymentId = record.paymentId || '';
          card.dataset.timestamp = record.timestampMs;
          card.dataset.studentId = record.studentId || '';

          // âš¡ OPTIMIZED: Cache all querySelector results in single pass
          const fields = {
            time: card.querySelector('[data-field="time"]'),
            student: card.querySelector('[data-field="student"]'),
            group: card.querySelector('[data-field="group"]'),
            amountUsd: card.querySelector('[data-field="amountUsd"]'),
            amountAmd: card.querySelector('[data-field="amountAmd"]'),
            forClass: card.querySelector('[data-field="forClass"]'),
            message: card.querySelector('[data-field="message"]'),
            payerButton: card.querySelector('[data-role="payer-button"]')
          };

          // âš¡ Batch assign textContent (faster than individual operations)
          fields.time.textContent = record.timeLabel;
          fields.student.textContent = record.studentName;
          fields.group.textContent = record.groupLetter || 'â€”';
          fields.group.dataset.group = record.groupLetter || '';
          fields.amountUsd.textContent = record.amountUSDLabel;
          fields.amountAmd.textContent = record.amountAMDLabel;
          fields.message.textContent = record.memo || 'â€”';
          fields.payerButton.textContent = record.payerName;
          
          // âš¡ NEW: Render For Class date pickers
          renderForClassDatePickers(fields.forClass, record);
          
          // Assign payer button dataset
          Object.entries(record.dataset).forEach(([key, value]) => {
            fields.payerButton.dataset[key] = value;
          });

          return card;
        }

        function addRecordsToIndexes(records = []) {
          records.forEach(record => {
            registerTokens(state.indexes.payer, record.tokens.payer, record.uniqueKey);
            registerTokens(state.indexes.student, record.tokens.student, record.uniqueKey);
            registerTokens(state.indexes.memo, record.tokens.memo, record.uniqueKey);
            registerTokens(state.indexes.month, record.tokens.month, record.uniqueKey);
            registerTokens(state.indexes.amount, record.tokens.amount, record.uniqueKey);
            registerTokens(state.indexes.date, record.tokens.date, record.uniqueKey);
          });
        }

        function parseAmountToNumber(value = '') {
          if (value === null || value === undefined) return 0;
          const numeric = value.toString().replace(/[^0-9.\-]/g, '');
          return Number(numeric) || 0;
        }

        function updateDateGroupTotals(wrapper, deltaUsd = 0, deltaAmd = 0) {
          if (!wrapper) return;
          const totalUsdEl = wrapper.querySelector('.total-usd');
          const totalAmdEl = wrapper.querySelector('.total-amd');
          const prevUsd = Number(wrapper.dataset.totalUsd || parseAmountToNumber(totalUsdEl?.textContent));
          const prevAmd = Number(wrapper.dataset.totalAmd || parseAmountToNumber(totalAmdEl?.textContent));
          const nextUsd = prevUsd + deltaUsd;
          const nextAmd = prevAmd + deltaAmd;
          wrapper.dataset.totalUsd = nextUsd.toString();
          wrapper.dataset.totalAmd = nextAmd.toString();
          if (totalUsdEl) totalUsdEl.textContent = formatUsd(nextUsd);
          if (totalAmdEl) totalAmdEl.textContent = formatAmd(nextAmd);
        }

        function ensureDateGroup(dateKey, dateLabel) {
          initDomRefs();
          if (!dom.rowsHost) return {};

          let wrapper = dom.rowsHost.querySelector(`.payments-date-group[data-date-key="${dateKey}"]`);
          if (wrapper) {
            const rowsContainer = wrapper.querySelector('.payment-rows-container');
            return { wrapper, rowsContainer };
          }

          // âš¡ OPTIMIZED: Use pre-built template instead of 15+ createElement calls
          const section = templates.dateGroupShell.content.firstElementChild.cloneNode(true);
          section.dataset.dateKey = dateKey;
          section.dataset.totalUsd = '0';
          section.dataset.totalAmd = '0';

          // âš¡ Update labels using cached selectors
          section.querySelector('[data-label]').innerHTML = dateLabel;
          section.querySelector('[data-usd]').textContent = formatUsd(0);
          section.querySelector('[data-amd]').textContent = formatAmd(0);

          const rowsContainer = section.querySelector('.payment-rows-container');

          // âš¡ Optimized insertion - find correct position
          const existingGroups = Array.from(dom.rowsHost.querySelectorAll('.payments-date-group'));
          const insertBefore = existingGroups.find(el => (el.dataset.dateKey || '') < dateKey);
          dom.rowsHost.insertBefore(section, insertBefore || null);

          return { wrapper: section, rowsContainer };
        }

        function insertRecordIntoDom(record) {
          showEmptyState(false);
          ensureTemplates();
          const { wrapper, rowsContainer } = ensureDateGroup(record.dateKey, record.dateLabel);
          if (!rowsContainer) return;

          const card = buildPaymentCard(record);
          const siblings = Array.from(rowsContainer.children);
          const insertBefore = siblings.find(el => Number(el.dataset.timestamp) < record.timestampMs);
          rowsContainer.insertBefore(card, insertBefore || null);
          updateDateGroupTotals(wrapper, record.amountUSD, record.amountAMD);
        }

        function removeOldestRenderedCards(count = 0) {
          if (!dom.rowsHost || count <= 0) return 0;
          let removed = 0;
          while (removed < count) {
            const lastGroup = dom.rowsHost.lastElementChild;
            if (!lastGroup) break;
            const rowsContainer = lastGroup.querySelector('.payment-rows-container');
            if (!rowsContainer) {
              dom.rowsHost.removeChild(lastGroup);
              continue;
            }

            const lastCard = rowsContainer.lastElementChild;
            if (!lastCard) {
              dom.rowsHost.removeChild(lastGroup);
              continue;
            }

            rowsContainer.removeChild(lastCard);
            const record = state.paymentLookup.get(lastCard.dataset.paymentKey);
            if (record) {
              updateDateGroupTotals(lastGroup, -record.amountUSD, -record.amountAMD);
            }
            removed += 1;
            state.renderWindow.renderedCount = Math.max(0, state.renderWindow.renderedCount - 1);

            if (!rowsContainer.children.length) {
              dom.rowsHost.removeChild(lastGroup);
            }
          }
          return removed;
        }

        function enforceRenderWindowLimit() {
          if (!dom.rowsHost) return;
          const overflow = state.renderWindow.renderedCount - state.renderWindow.visibleCount;
          if (overflow > 0) {
            removeOldestRenderedCards(overflow);
          }
        }

        function insertIntoSortedList(list, record) {
          if (!Array.isArray(list)) return -1;
          const index = list.findIndex(item => item.timestampMs < record.timestampMs);
          if (index === -1) {
            list.push(record);
            return list.length - 1;
          } else {
            list.splice(index, 0, record);
            return index;
          }
        }

        function recordMatchesCurrentFilters(record) {
          const { search, dateFrom, dateTo, methods } = state.filters;
          if (search) {
            const tokens = tokenize(search);
            if (tokens.length) {
              const blob = (record.searchBlob || '').toLowerCase();
              const hasAllTokens = tokens.every(token => blob.includes(token));
              if (!hasAllTokens) return false;
            }
          }

          const fromTime = typeof dateFrom === 'number' ? dateFrom : (dateFrom ? new Date(dateFrom).getTime() : null);
          const toTime = typeof dateTo === 'number' ? dateTo : (dateTo ? new Date(dateTo).getTime() : null);

          if (fromTime && record.timestampMs < fromTime) return false;
          if (toTime && record.timestampMs > toTime) return false;

          if (methods && methods.size) {
            const methodSlug = record.paymentMethodSlug || (record.paymentMethod || '').toLowerCase();
            if (!methods.has(methodSlug)) return false;
          }

          return true;
        }

        function updateCounters() {
          if (dom.totalRecords) {
            dom.totalRecords.textContent = state.payments.length.toString();
          }
          if (dom.filteredRecords) {
            dom.filteredRecords.textContent = state.filtered.length.toString();
          }
          if (dom.recordCountLabel) {
            dom.recordCountLabel.textContent = `${state.payments.length} records loaded`;
          }
        }

        function updateLoadMoreControls() {
          if (!dom.loadMoreWrapper) return;
          const total = state.renderWindow.totalCount || 0;
          const visible = state.renderWindow.visibleCount || 0;
          const remaining = Math.max(0, total - visible);
          const hasRecords = total > 0;
          const hasMore = remaining > 0;

          dom.loadMoreWrapper.style.display = hasRecords ? 'flex' : 'none';

          if (dom.loadMoreBtn) {
            dom.loadMoreBtn.style.display = hasMore ? 'inline-flex' : 'none';
            dom.loadMoreBtn.disabled = !hasMore;
            dom.loadMoreBtn.setAttribute('aria-disabled', hasMore ? 'false' : 'true');
          }

          if (dom.loadMoreHint) {
            if (!hasRecords) {
              dom.loadMoreHint.textContent = 'No payments to display';
            } else if (!hasMore) {
              dom.loadMoreHint.textContent = `Showing all ${total.toLocaleString()} payments`;
            } else {
              dom.loadMoreHint.textContent = `Showing ${visible.toLocaleString()} of ${total.toLocaleString()} payments`;
            }
          }
        }

        async function updateMonthTotals() {
          // ðŸ” FILTERED TOTALS: If filters are active, calculate from filtered records
          const hasActiveFilters = state.filters.search || 
                                   state.filters.dateFrom || 
                                   state.filters.dateTo || 
                                   (state.filters.methods && state.filters.methods.size > 0) ||
                                   (state.filters.monthFilter && state.filters.monthFilter !== 'all');
          
          if (hasActiveFilters && state.filtered && state.filtered.length >= 0) {
            // Calculate totals from filtered records
            let count = 0;
            let usd = 0;
            let amd = 0;

            state.filtered.forEach(record => {
              count += 1;
              usd += record.amountUSD;
              amd += record.amountAMD;
            });

            if (dom.monthTotalCount) dom.monthTotalCount.textContent = count.toString();
            if (dom.monthTotalUSD) dom.monthTotalUSD.textContent = formatUsd(usd);
            if (dom.monthTotalAMD) dom.monthTotalAMD.textContent = formatAmd(amd);

            debugLog(`ðŸ’° Filtered Totals: ${count} payments, ${formatUsd(usd)}, ${formatAmd(amd)}`);
            return;
          }

          // âš¡ GRAND TOTALS: Check cache first (5-minute TTL) - only when no filters
          const TOTALS_CACHE_TTL = 5 * 60 * 1000; // 5 minutes
          const now = Date.now();
          
          if (state.totalsCache && state.totalsCacheTime && (now - state.totalsCacheTime) < TOTALS_CACHE_TTL) {
            // Use cached totals
            if (dom.monthTotalCount) dom.monthTotalCount.textContent = state.totalsCache.count.toString();
            if (dom.monthTotalUSD) dom.monthTotalUSD.textContent = formatUsd(state.totalsCache.usd);
            if (dom.monthTotalAMD) dom.monthTotalAMD.textContent = formatAmd(state.totalsCache.amd);
            debugLog(`ðŸ’° Grand Totals (cached): ${state.totalsCache.count} payments, ${formatUsd(state.totalsCache.usd)}, ${formatAmd(state.totalsCache.amd)}`);
            return;
          }

          // âš¡ GRAND TOTALS: Fetch true totals from ALL payments in database
          // This is separate from the paginated display data
          try {
            const { data, error } = await supabaseClient
              .from('payments')
              .select('amount, email_date');

            if (error) throw error;

            let count = 0;
            let usd = 0;
            let amd = 0;

            if (data && data.length > 0) {
              data.forEach(record => {
                const amountUSD = Number(record.amount) || 0;
                count += 1;
                usd += amountUSD;
                amd += amountUSD * state.usdToAmdRate;
              });
            }

            // Cache the results
            state.totalsCache = { count, usd, amd };
            state.totalsCacheTime = now;

            if (dom.monthTotalCount) dom.monthTotalCount.textContent = count.toString();
            if (dom.monthTotalUSD) dom.monthTotalUSD.textContent = formatUsd(usd);
            if (dom.monthTotalAMD) dom.monthTotalAMD.textContent = formatAmd(amd);

            debugLog(`ðŸ’° Grand Totals: ${count} payments, ${formatUsd(usd)}, ${formatAmd(amd)}`);
          } catch (error) {
            console.error('âŒ Error calculating grand totals:', error);
            // Fallback to counting loaded records
            const recordsToCount = state.filtered && state.filtered.length > 0 ? state.filtered : state.payments;
            let count = 0;
            let usd = 0;
            let amd = 0;

            recordsToCount.forEach(record => {
              count += 1;
              usd += record.amountUSD;
              amd += record.amountAMD;
            });

            if (dom.monthTotalCount) dom.monthTotalCount.textContent = count.toString();
            if (dom.monthTotalUSD) dom.monthTotalUSD.textContent = formatUsd(usd);
            if (dom.monthTotalAMD) dom.monthTotalAMD.textContent = formatAmd(amd);
          }
        }

        function resetRenderWindow(totalCount = 0) {
          const limit = totalCount === 0
            ? 0
            : Math.min(totalCount, config.initialRenderLimit) || totalCount;
          state.renderWindow.totalCount = totalCount;
          state.renderWindow.visibleCount = limit;
          state.renderWindow.lastChunkSize = limit;
          state.renderWindow.renderedCount = 0;
        }

        function renderInitialWindow() {
          const total = Array.isArray(state.filtered) ? state.filtered.length : 0;
          resetRenderWindow(total);
          const limit = state.renderWindow.visibleCount || total;
          const initialSlice = limit ? state.filtered.slice(0, limit) : [];
          render(initialSlice, { mode: 'replace' });
          updateLoadMoreControls();
        }

        function loadMoreRecords() {
          if (!Array.isArray(state.filtered) || !state.filtered.length) {
            return { added: 0, hasMore: false };
          }

          const total = state.renderWindow.totalCount = state.filtered.length;
          const previousVisible = state.renderWindow.visibleCount;
          if (previousVisible >= total) {
            updateLoadMoreControls();
            return { added: 0, hasMore: false };
          }

          const nextVisible = Math.min(previousVisible + config.renderBatchSize, total);
          const chunk = state.filtered.slice(previousVisible, nextVisible);
          state.renderWindow.visibleCount = nextVisible;
          state.renderWindow.lastChunkSize = chunk.length;

          if (chunk.length) {
            render(chunk, { mode: 'append' });
          } else {
            updateLoadMoreControls();
          }

          return { added: chunk.length, hasMore: nextVisible < total };
        }

        function handleMonthSelectorChange() {
          if (!dom.monthSelector) return;
          state.filters.monthFilter = dom.monthSelector.value;
          
          // Clear search when month filter changes (to avoid confusion)
          if (dom.searchInput) {
            dom.searchInput.value = '';
            state.filters.search = '';
          }
          
          applyFilters();
          renderInitialWindow();
          updateMonthTotals();
        }

        async function init(force = false, options = {}) {
          initDomRefs();
          ensureTemplates();
          state.initialized = true;
          return load(force, options);
        }

        async function load(force = false, options = {}) {
          const { silent = false } = options || {};
          if (state.loadingPromise && !force) {
            return state.loadingPromise;
          }
          state.loadingPromise = (async () => {
            try {
              if (!silent) {
                showLoading(true);
              }
              const [reference, payments] = await Promise.all([
                fetchReferenceData(force),
                fetchPayments(force)
              ]);

              state.students = reference.students;
              state.groups = reference.groups;
              state.aliasMap = reference.aliasMap;
              state.studentNameMap = reference.studentNameMap;
              state.creditPaymentsByStudent = reference.creditPaymentsByStudent;

              state.payments = preparePayments(payments);
              rebuildIndexes(state.payments);
              applyFilters();
              renderInitialWindow();
              updateMonthTotals();
            } catch (error) {
              console.error('âŒ PaymentRecords load failed:', error);
              showNotification('âŒ Failed to load payment data. See console for details.', 'error');
            } finally {
              if (!silent) {
                showLoading(false);
              }
              state.loadingPromise = null;
            }
          })();

          return state.loadingPromise;
        }

        function ingestLivePayments(livePayments = [], options = {}) {
          const { incremental = false } = options || {};
          if (!livePayments.length) {
            return { added: 0, displayed: 0 };
          }

          const normalized = livePayments
            .map(lp => transformPayment(lp))
            .filter(Boolean);

          if (!normalized.length) {
            return { added: 0, displayed: 0 };
          }

          const newRecords = normalized.filter(record => !state.paymentLookup.has(record.uniqueKey));
          if (!newRecords.length) {
            debugLog('â„¹ï¸ PaymentRecords: Ignoring duplicate payments (no UI changes).');
            return { added: 0, displayed: 0 };
          }

          newRecords.forEach(record => state.paymentLookup.set(record.uniqueKey, record));
          state.payments = [...newRecords, ...state.payments].sort((a, b) => b.timestampMs - a.timestampMs);

          if (state.payments.length > config.maxRecords) {
            const removed = state.payments.splice(config.maxRecords);
            const removedKeys = new Set(removed.map(record => record.uniqueKey));
            removed.forEach(record => state.paymentLookup.delete(record.uniqueKey));
            if (Array.isArray(state.filtered) && state.filtered.length) {
              state.filtered = state.filtered.filter(record => !removedKeys.has(record.uniqueKey));
            }
          }

          state.paymentsCache = {
            ts: Date.now(),
            data: state.payments.slice(0, config.maxRecords)
          };

          if (!incremental || !state.initialized || !dom.rowsHost) {
            if (incremental) {
              console.warn('âš ï¸ Incremental ingest requested before grid initialization. Falling back to full render.');
            }
            rebuildIndexes(state.payments);
            state.filtered = state.payments.slice();
            renderInitialWindow();
            updateMonthTotals();
            updateCounters();
            return { added: newRecords.length, displayed: newRecords.length };
          }

          addRecordsToIndexes(newRecords);
          if (!Array.isArray(state.filtered)) {
            state.filtered = [];
          }

          const matchingRecords = newRecords
            .filter(recordMatchesCurrentFilters)
            .sort((a, b) => b.timestampMs - a.timestampMs);

          const inserted = matchingRecords.map(record => ({
            record,
            index: insertIntoSortedList(state.filtered, record)
          }));

          state.renderWindow.totalCount = state.filtered.length;

          if (!state.renderWindow.visibleCount && state.renderWindow.totalCount) {
            renderInitialWindow();
            updateCounters();
            updateMonthTotals();
            return { added: newRecords.length, displayed: matchingRecords.length };
          }

          let displayed = 0;
          inserted.forEach(({ record, index }) => {
            if (index > -1 && index < state.renderWindow.visibleCount) {
              insertRecordIntoDom(record);
              state.renderWindow.renderedCount += 1;
              displayed += 1;
            }
          });

          enforceRenderWindowLimit();
          updateLoadMoreControls();
          updateCounters();
          updateMonthTotals();

          return { added: newRecords.length, displayed };
        }

        function setSearchTerm(term) {
          state.filters.search = term || '';
          applyFilters();
          renderInitialWindow();
          updateMonthTotals();
        }

        function setDateRange(from, to) {
          state.filters.dateFrom = from ? (from instanceof Date ? from.getTime() : from) : null;
          state.filters.dateTo = to ? (to instanceof Date ? to.getTime() : to) : null;
          applyFilters();
          renderInitialWindow();
          updateMonthTotals();
        }

        function setPaymentMethods(methods = []) {
          state.filters.methods = new Set((methods || []).map(method => method.toLowerCase()));
          applyFilters();
          renderInitialWindow();
          updateMonthTotals();
        }

        function resetFilters() {
          state.filters.search = '';
          state.filters.dateFrom = null;
          state.filters.dateTo = null;
          state.filters.methods = new Set();
          state.filters.groups = new Set();
          state.filters.statuses = new Set();
          state.filtered = state.payments.slice();
          renderInitialWindow();
          updateMonthTotals();
        }

        function getActiveFilterCount() {
          let count = 0;
          if (state.filters.search) count++;
          if (state.filters.dateFrom || state.filters.dateTo) count++;
          if (state.filters.methods.size) count++;
          if (state.filters.groups.size) count++;
          if (state.filters.statuses.size) count++;
          return count;
        }

        return {
          init,
          load,
          ingestLivePayments,
          setSearchTerm,
          setDateRange,
          setPaymentMethods,
          resetFilters,
          getActiveFilterCount,
          updateMonthTotals,
          handleMonthSelectorChange,
          loadMoreRecords,
          recalculateForClassDates,
          state
        };
      })();

      let selectedPayment = null;

      // âš¡ PERFORMANCE: Debounce utility for throttling expensive operations
      // Default 100ms provides responsive feel while reducing CPU load
      const debounce = (fn, delay = 100) => {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(null, args), delay);
        };
      };

      // ============================================================
      // INITIALIZATION
      // ============================================================
  document.addEventListener('DOMContentLoaded', async () => {
  debugLog('ðŸ’³ ARNOMA Payment Records Module v1.1.0');

        try {
          await requireAdminSession();
        } catch (error) {
          debugWarn('Admin auth required. Halting Payment Records initialization.', error);
          return;
        }

        // Handle OAuth callback if present
        await handleOAuthCallback();

        // Update Gmail button state
        const connection = getGmailConnection();
        updateGmailButtonState(!!connection);

        // Restore auto-refresh state (default to OFF)
        const toggleBtn = document.getElementById('autoRefreshToggle');
        if (toggleBtn) {
          if (autoRefreshEnabled) {
            toggleBtn.classList.add('active');
            toggleBtn.title = 'Auto-refresh ON (every 60s) - Click to disable';
            const started = startAutoRefresh();
            if (started) {
              startCountdown();
            } else {
              stopCountdown({ label: 'Paused' });
            }
          } else {
            toggleBtn.classList.remove('active');
            toggleBtn.title = 'Auto-refresh OFF - Click to enable';
          }
        }

        // Initialize sync date inputs with current month
        const today = new Date();
        const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const syncFromDate = document.getElementById('syncFromDate');
        const syncToDate = document.getElementById('syncToDate');
        if (syncFromDate && syncToDate) {
          syncFromDate.value = firstOfMonth.toISOString().split('T')[0];
          syncToDate.value = today.toISOString().split('T')[0];
        }

  await loadData();
  setupEventListeners();
  // Gmail context menu setup removed - now always uses LA timezone
  initScrollBehavior();
  loadNavButtonOrder();
  // Force immediate initialization of nav context menu (don't wait for lazy trigger)
  ensureNavEnhancementsInitialized();
  ensureFloatingCountdownInitialized();
      });

      // ============================================================
      // SCROLL BEHAVIOR
      // ============================================================
      function initScrollBehavior() {
        // Navigation now only appears on hover - no scroll behavior needed
  debugLog('ðŸ“Š Navigation set to hover-only mode');

        // Collapse navbar when clicking outside
        const nav = document.querySelector('.floating-nav');

        document.addEventListener('click', (e) => {
          // Check if click is outside the nav
          if (nav && !nav.contains(e.target)) {
              if (typeof nav.__collapseNav === 'function') {
                nav.__collapseNav(true);
              } else {
                nav.classList.remove('expanded');
              }
            nav.classList.remove('interacting');
          }
        });

        // Keep nav expanded when hovering
        if (nav) {
          nav.addEventListener('mouseenter', () => {
            nav.classList.add('interacting');
          });

          nav.addEventListener('mouseleave', () => {
            nav.classList.remove('interacting');
          });
        }
      }

      function attachLazyNavInitTriggers() {
        const nav = document.querySelector('.floating-nav');
        if (!nav) return;

        const triggerInit = () => {
          ensureNavEnhancementsInitialized();
        };

        ['pointerenter', 'focusin', 'touchstart'].forEach(evt => {
          nav.addEventListener(evt, triggerInit, { once: true });
        });

        const countdownBtn = document.getElementById('navCountdownTimer');
        if (countdownBtn) {
          countdownBtn.addEventListener('click', () => ensureNavEnhancementsInitialized());
        }
      }

      function ensureNavEnhancementsInitialized() {
        if (ensureNavEnhancementsInitialized.__done) return;
        ensureNavEnhancementsInitialized.__done = true;
        debugLog('âš™ï¸ Lazy-loading floating nav enhancements');
        setupNavContextMenu();
        ensureFloatingCountdownInitialized();
      }

      // ============================================================
      // FLOATING NAV COUNTDOWN TIMER - EXACT LOGIC FROM INDEX.HTML
      // ============================================================

      // Timezone Utilities (from index.html ClassCountdownTimer)
      const TimezoneUtils = {
        getCurrentTimeInZone(timezone) {
          const now = new Date();
          const formatter = new Intl.DateTimeFormat('en-US', {
            timeZone: timezone,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });

          const parts = {};
          formatter.formatToParts(now).forEach(part => {
            parts[part.type] = part.value;
          });

          return {
            year: parseInt(parts.year),
            month: parseInt(parts.month),
            day: parseInt(parts.day),
            hours: parseInt(parts.hour),
            minutes: parseInt(parts.minute),
            seconds: parseInt(parts.second),
            getDay: () => new Date(parseInt(parts.year), parseInt(parts.month) - 1, parseInt(parts.day)).getDay()
          };
        },

        getTimezoneOffset(timezone) {
          const now = new Date();
          const utc = new Date(now.toLocaleString('en-US', { timeZone: 'UTC' }));
          const tz = new Date(now.toLocaleString('en-US', { timeZone: timezone }));
          return (tz - utc) / 3600000;
        },

        convertLATimeToYerevan(laTimeStr) {
          if (!laTimeStr) return { time: '', dayShift: 0 };

          const match = laTimeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
          if (!match) return { time: laTimeStr, dayShift: 0 };

          let hours = parseInt(match[1]);
          const minutes = match[2];
          const period = match[3].toUpperCase();

          if (period === 'PM' && hours !== 12) hours += 12;
          if (period === 'AM' && hours === 12) hours = 0;

          const laOffset = this.getTimezoneOffset('America/Los_Angeles');
          const yerevanOffset = this.getTimezoneOffset('Asia/Yerevan');
          const diff = Math.round(yerevanOffset - laOffset);

          let yerevanHours = hours + diff;
          let dayShift = 0;

          if (yerevanHours >= 24) {
            yerevanHours -= 24;
            dayShift = 1;
          } else if (yerevanHours < 0) {
            yerevanHours += 24;
            dayShift = -1;
          }

          const period12 = yerevanHours >= 12 ? 'PM' : 'AM';
          let hours12 = yerevanHours % 12;
          if (hours12 === 0) hours12 = 12;

          return {
            time: `${hours12}:${minutes} ${period12}`,
            dayShift: dayShift
          };
        }
      };

      // Helper functions
      function formatDateYYYYMMDD(date) {
        if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
          console.error('[formatDateYYYYMMDD] Invalid date:', date);
          return 'Invalid-Date';
        }
        // Match index.html: use toISOString().split('T')[0]
        return date.toISOString().split('T')[0];
      }

      function ensureAMPMFormatLocal(timeStr) {
        if (!timeStr) return '';
        if (/AM|PM/i.test(timeStr)) return timeStr;

        const match = timeStr.match(/^(\d{1,2}):(\d{2})$/);
        if (!match) return timeStr;

        let hours = parseInt(match[1]);
        const minutes = match[2];
        const period = hours >= 12 ? 'PM' : 'AM';

        if (hours > 12) hours -= 12;
        if (hours === 0) hours = 12;

        return `${hours}:${minutes} ${period}`;
      }

      function parseScheduleString(scheduleStr) {
        if (!scheduleStr) return [];

        const sessions = [];
        const parts = scheduleStr.split(',').map(s => s.trim());

        parts.forEach(part => {
          const slashMatch = part.match(/^([A-Za-z/]+)\s+(.+)$/);
          if (slashMatch) {
            const daysStr = slashMatch[1];
            const time = slashMatch[2];
            const days = daysStr.split('/').map(d => d.trim());

            days.forEach(day => {
              const normalized = normalizeDay(day);
              if (normalized) {
                sessions.push({ day: normalized, time: ensureAMPMFormatLocal(time) });
              }
            });
          } else {
            const spaceMatch = part.match(/^([A-Za-z]+)\s+(.+)$/);
            if (spaceMatch) {
              const day = normalizeDay(spaceMatch[1]);
              const time = spaceMatch[2];
              if (day) {
                sessions.push({ day: day, time: ensureAMPMFormatLocal(time) });
              }
            }
          }
        });

        return sessions;

        function normalizeDay(day) {
          if (!day || typeof day !== 'string') return '';
          const map = {
            'sun': 'Sunday', 'sunday': 'Sunday',
            'mon': 'Monday', 'monday': 'Monday',
            'tue': 'Tuesday', 'tues': 'Tuesday', 'tuesday': 'Tuesday',
            'wed': 'Wednesday', 'weds': 'Wednesday', 'wednesday': 'Wednesday',
            'thu': 'Thursday', 'thur': 'Thursday', 'thurs': 'Thursday', 'thursday': 'Thursday',
            'fri': 'Friday', 'friday': 'Friday',
            'sat': 'Saturday', 'saturday': 'Saturday'
          };
          return map[day.toLowerCase()] || day;
        }
      }

      function hasValidRecurringSchedule(schedule) {
        if (!schedule) return false;

        if (typeof schedule === 'string') {
          return schedule.replace(/[\s,]/g, '').length > 0;
        }

        if (Array.isArray(schedule)) {
          return schedule.some(slot => {
            if (!slot || !slot.time) return false;
            const hasDay = Array.isArray(slot.days) && slot.days.some(day => typeof day === 'string' && day.trim().length > 0);
            return hasDay;
          });
        }

        return false;
      }

      function formatCountdown(secondsRemaining) {
        if (secondsRemaining < 0) secondsRemaining = 0;

        const hours = Math.floor(secondsRemaining / 3600);
        const minutes = Math.floor((secondsRemaining % 3600) / 60);
        const seconds = secondsRemaining % 60;

        if (hours > 24) {
          const days = Math.floor(hours / 24);
          const remainingHours = hours % 24;
          return `${days}d ${remainingHours}h`;
        } else if (hours > 0) {
          return `${hours}h ${minutes}m`;
        } else if (minutes > 0) {
          return `${minutes}m ${seconds}s`;
        } else {
          return `${seconds}s`;
        }
      }

      // Find next class - loads DIRECTLY from Supabase
      async function findNextClass() {
        try {
          // Load groups directly from Supabase
          const groups = await loadGroupsFromSupabase();
          if (!groups || groups.length === 0) return null;

          const nowLA = TimezoneUtils.getCurrentTimeInZone('America/Los_Angeles');
          const currentTimeInSeconds = nowLA.hours * 3600 + nowLA.minutes * 60 + nowLA.seconds;
          const nowLADate = new Date(nowLA.year, nowLA.month - 1, nowLA.day, nowLA.hours, nowLA.minutes, nowLA.seconds);

          let closestClass = null;
          let minSeconds = Infinity;

          // Check next 7 days
          for (let daysAhead = 0; daysAhead <= 7; daysAhead++) {
            const checkDayIndex = (nowLA.getDay() + daysAhead) % 7;
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const checkDayName = dayNames[checkDayIndex];

            const checkDate = new Date(nowLADate);
            checkDate.setDate(checkDate.getDate() + daysAhead);
            const checkDateStr = formatDateYYYYMMDD(checkDate);

            groups.forEach(group => {
              let sessions = [];

              // Use regular schedule (no one-time schedules in payment-records)
              if (typeof group.schedule === 'string') {
                sessions = parseScheduleString(group.schedule);
              } else if (Array.isArray(group.schedule)) {
                group.schedule.forEach(slot => {
                  if (!slot || !slot.days || !slot.time) return;
                  const timeFormatted = ensureAMPMFormatLocal(slot.time);
                  slot.days.forEach(day => {
                    if (day) {
                      const normalized = normalizeDay(day);
                      if (normalized) {
                        sessions.push({ day: normalized, time: timeFormatted });
                      }
                    }
                  });
                });
              }

              sessions.forEach(session => {
                if (session.day !== checkDayName) return;

                const match = session.time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (!match) return;

                let hours = parseInt(match[1]);
                const minutes = parseInt(match[2]);
                const period = match[3].toUpperCase();

                if (period === 'PM' && hours !== 12) hours += 12;
                if (period === 'AM' && hours === 12) hours = 0;

                const classTimeInSeconds = hours * 3600 + minutes * 60;

                let totalDiffSeconds;
                if (daysAhead === 0) {
                  totalDiffSeconds = classTimeInSeconds - currentTimeInSeconds;
                } else {
                  totalDiffSeconds = daysAhead * 86400 - currentTimeInSeconds + classTimeInSeconds;
                }

                // Skip if more than 2 hours past (class is over)
                if (totalDiffSeconds < -7200) return;

                // Only consider future classes
                if (totalDiffSeconds > 0 && totalDiffSeconds < minSeconds) {
                  minSeconds = totalDiffSeconds;

                  let dayLabel = '';
                  if (daysAhead === 0) dayLabel = 'Today';
                  else if (daysAhead === 1) dayLabel = 'Tomorrow';
                  else dayLabel = checkDayName;

                  const groupDisplayName = group.name && group.name.length === 1 ? `Group ${group.name}` : group.name || 'Unknown Group';

                  closestClass = {
                    groupName: groupDisplayName,
                    actualGroupName: group.name,
                    dayName: dayLabel,
                    laTime: session.time,
                    secondsRemaining: totalDiffSeconds,
                    actualDay: checkDayName,
                    classDate: checkDateStr
                  };
                }
              });
            });
          }

          return closestClass;

          function normalizeDay(day) {
            if (!day || typeof day !== 'string') return '';
            const map = {
              'sun': 'Sunday', 'sunday': 'Sunday',
              'mon': 'Monday', 'monday': 'Monday',
              'tue': 'Tuesday', 'tues': 'Tuesday', 'tuesday': 'Tuesday',
              'wed': 'Wednesday', 'weds': 'Wednesday', 'wednesday': 'Wednesday',
              'thu': 'Thursday', 'thur': 'Thursday', 'thurs': 'Thursday', 'thursday': 'Thursday',
              'fri': 'Friday', 'friday': 'Friday',
              'sat': 'Saturday', 'saturday': 'Saturday'
            };
            return map[day.toLowerCase()] || day;
          }
        } catch (error) {
          console.error('[FloatingCountdown] Error in findNextClass:', error);
          return null;
        }
      }

  let navCountdownInterval = null;
  let cachedGroups = null;
  let groupsCacheTime = null;
  const GROUPS_CACHE_TTL = 5 * 60 * 1000; // 5 minutes
  let floatingCountdownInitialized = false;

        function ensureFloatingCountdownInitialized() {
          if (floatingCountdownInitialized) return;
          floatingCountdownInitialized = true;
          initFloatingCountdown();
        }

      /**
       * Initialize the floating navigation countdown timer
       * PERFORMANCE FIX: Update every 30s instead of 1s - massive CPU savings
       */
    function initFloatingCountdown() {
  debugLog('â³ Initializing floating nav countdown timer...');
        updateFloatingCountdownUI();
        if (navCountdownInterval) clearInterval(navCountdownInterval);
        navCountdownInterval = setInterval(updateFloatingCountdownUI, 30000); // 30s instead of 1s
  debugLog('âœ… Countdown timer initialized (30s interval)');
      }

      /**
       * Update the floating countdown timer UI
       */
      function updateFloatingCountdownUI() {
        // Use async wrapper to handle promises
        (async () => {
          const btn = document.getElementById('navCountdownTimer');
          if (!btn) return;

          const nextClass = await findNextClass();
          const iconSpan = btn.querySelector('.timer-icon');
          const textSpan = btn.querySelector('.timer-text');

          if (!nextClass) {
            btn.className = 'time-none';
            iconSpan.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/>
              <path d="M12 12 L12 3 A9 9 0 0 1 21 12 Z" fill="currentColor" opacity="0.3"/>
              <line x1="12" y1="12" x2="12" y2="5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <line x1="12" y1="12" x2="18" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>`;
            iconSpan.style.filter = '';
            textSpan.textContent = '';
            return;
          }

          const seconds = nextClass.secondsRemaining;
          const hours = Math.floor(seconds / 3600);
          const displayText = formatCountdown(seconds);

          // Set state based on time remaining (matching popup color logic: 24h/12h/6h)
          if (seconds <= 0) {
            btn.className = 'time-live';
            iconSpan.textContent = 'ðŸ”´';
          } else if (hours > 24) {
            btn.className = 'time-safe';
            iconSpan.textContent = 'â³';
          } else if (hours > 12) {
            btn.className = 'time-upcoming';
            iconSpan.textContent = 'âš¡';
          } else if (hours > 6) {
            btn.className = 'time-warning';
            iconSpan.textContent = 'âš ï¸';
          } else {
            btn.className = 'time-critical';
            iconSpan.textContent = 'ðŸ”¥';
          }

          textSpan.textContent = displayText;
          btn.title = `Next: ${nextClass.groupName} - ${nextClass.dayName}`;
        })();
      }

      /**
       * Calculate next upcoming class - LEGACY function kept for compatibility
       * Uses findNextClass() internally
       */
      function getNextClassTime() {
        const nextClass = findNextClass();
        if (!nextClass) return null;

        return {
          groupName: nextClass.groupName,
          timeRemaining: formatCountdown(nextClass.secondsRemaining),
          dayName: nextClass.dayName
        };
      }

      /**
       * Load groups from Supabase ONLY - no localStorage
       * Uses in-memory cache with 5-minute TTL to avoid excessive DB calls
       */
      async function loadGroupsFromSupabase() {
        try {
          // Check cache first
          const now = Date.now();
          if (cachedGroups && groupsCacheTime && (now - groupsCacheTime) < GROUPS_CACHE_TTL) {
            return cachedGroups;
          }

          debugLog('â° Countdown Timer: Loading groups from Supabase...');
          const { data, error } = await supabaseClient
            .from('groups')
            .select('*')
            .order('id', { ascending: true });

          if (error) throw error;

          if (data && data.length > 0) {
            const normalizedGroups = data.map(g => {
              const normalizedStatus = (g.status || g.state || '').toString().toLowerCase();
              const isActive = g.active !== false && normalizedStatus !== 'inactive' && normalizedStatus !== 'archived';
              return {
                id: g.id,
                name: g.group_name || g.name || `Group ${g.id}`,
                schedule: g.schedule || '',
                one_time_schedules: g.one_time_schedules || [],
                active: isActive
              };
            });

            const filteredGroups = normalizedGroups.filter(group => group.active && hasValidRecurringSchedule(group.schedule));

            if (normalizedGroups.length !== filteredGroups.length) {
              debugLog(`â„¹ï¸ Countdown Timer: Filtered out ${normalizedGroups.length - filteredGroups.length} inactive/unscheduled groups`);
            }

            cachedGroups = filteredGroups;
            groupsCacheTime = now;

            debugLog(`âœ… Countdown Timer: Loaded ${filteredGroups.length} groups from Supabase`);
            return filteredGroups;
          }

          return [];
        } catch (e) {
          console.error('âŒ Countdown Timer: Error loading groups from Supabase:', e);
          // Return cached data if available, even if expired
          return cachedGroups || [];
        }
      }

      /**
       * Get all upcoming class sessions (up to 7 days ahead)
       * Loads DIRECTLY from Supabase - no localStorage
       */
      async function getAllUpcomingSessions() {
        try {
          // Load groups directly from Supabase
          const groups = await loadGroupsFromSupabase();
          if (!groups || groups.length === 0) return [];

          const allClasses = [];
          const nowLA = TimezoneUtils.getCurrentTimeInZone('America/Los_Angeles');
          const currentTimeInSeconds = nowLA.hours * 3600 + nowLA.minutes * 60 + nowLA.seconds;
          const nowLADate = new Date(nowLA.year, nowLA.month - 1, nowLA.day, nowLA.hours, nowLA.minutes, nowLA.seconds);

          for (let daysAhead = 0; daysAhead <= 7; daysAhead++) {
            const checkDayIndex = (nowLA.getDay() + daysAhead) % 7;
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const checkDayName = dayNames[checkDayIndex];

            const checkDate = new Date(nowLADate);
            checkDate.setDate(checkDate.getDate() + daysAhead);
            const checkDateStr = formatDateYYYYMMDD(checkDate);

            groups.forEach(group => {
              let sessions = [];

              if (typeof group.schedule === 'string') {
                sessions = parseScheduleString(group.schedule);
              } else if (Array.isArray(group.schedule)) {
                group.schedule.forEach(slot => {
                  if (!slot || !slot.days || !slot.time) return;
                  const timeFormatted = ensureAMPMFormatLocal(slot.time);
                  slot.days.forEach(day => {
                    if (day) {
                      const normalized = normalizeDay(day);
                      if (normalized) {
                        sessions.push({ day: normalized, time: timeFormatted });
                      }
                    }
                  });
                });
              }

              sessions.forEach(session => {
                if (session.day !== checkDayName) return;

                const match = session.time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (!match) return;

                let hours = parseInt(match[1]);
                const minutes = parseInt(match[2]);
                const period = match[3].toUpperCase();

                if (period === 'PM' && hours !== 12) hours += 12;
                if (period === 'AM' && hours === 12) hours = 0;

                const classTimeInSeconds = hours * 3600 + minutes * 60;

                let totalDiffSeconds;
                if (daysAhead === 0) {
                  totalDiffSeconds = classTimeInSeconds - currentTimeInSeconds;
                } else {
                  totalDiffSeconds = daysAhead * 86400 - currentTimeInSeconds + classTimeInSeconds;
                }

                if (totalDiffSeconds < -7200) return;

                if (totalDiffSeconds > 0) {
                  let dayLabel = '';
                  if (daysAhead === 0) dayLabel = 'Today';
                  else if (daysAhead === 1) dayLabel = 'Tomorrow';
                  else dayLabel = checkDayName;

                  const groupDisplayName = group.name && group.name.length === 1 ? `Group ${group.name}` : group.name || 'Unknown Group';

                  allClasses.push({
                    groupName: groupDisplayName,
                    dayName: dayLabel,
                    time: session.time,
                    seconds: totalDiffSeconds,
                    date: checkDate,
                    laTime: session.time,
                    secondsRemaining: totalDiffSeconds,
                    minutesAway: Math.floor(totalDiffSeconds / 60)
                  });
                }
              });
            });
          }

          allClasses.sort((a, b) => a.seconds - b.seconds);
          return allClasses.slice(0, 10);

          function normalizeDay(day) {
            if (!day || typeof day !== 'string') return '';
            const map = {
              'sun': 'Sunday', 'sunday': 'Sunday',
              'mon': 'Monday', 'monday': 'Monday',
              'tue': 'Tuesday', 'tues': 'Tuesday', 'tuesday': 'Tuesday',
              'wed': 'Wednesday', 'weds': 'Wednesday', 'wednesday': 'Wednesday',
              'thu': 'Thursday', 'thur': 'Thursday', 'thurs': 'Thursday', 'thursday': 'Thursday',
              'fri': 'Friday', 'friday': 'Friday',
              'sat': 'Saturday', 'saturday': 'Saturday'
            };
            return map[day.toLowerCase()] || day;
          }
        } catch (error) {
          console.error('[FloatingCountdown] Error in getAllUpcomingSessions:', error);
          return [];
        }
      }

      /**
       * Open countdown popup modal
       */
      async function openCountdownPopup() {
        ensureFloatingCountdownInitialized();
        const overlay = document.getElementById('countdownPopupOverlay');
        const body = document.getElementById('countdownPopupBody');
        const popup = overlay?.querySelector('.countdown-popup');

        if (!overlay || !body || !popup) return;

        // Get all upcoming sessions
        const sessions = await getAllUpcomingSessions();

        // Determine overall popup color state based on nearest class
        let popupTimeClass = 'time-safe';
        let popupPulseClass = '';
        
        if (sessions.length > 0) {
          const nearestSession = sessions[0];
          const hoursRemaining = nearestSession.secondsRemaining / 3600;
          
          if (hoursRemaining > 24) {
            popupTimeClass = 'time-safe';
          } else if (hoursRemaining > 12) {
            popupTimeClass = 'time-upcoming';
          } else if (hoursRemaining > 6) {
            popupTimeClass = 'time-warning';
          } else {
            popupTimeClass = 'time-critical';
            // Progressive pulsing based on urgency (matching index.html timing)
            if (hoursRemaining > 4) {
              popupPulseClass = 'pulse-slow';
            } else if (hoursRemaining > 2) {
              popupPulseClass = 'pulse-medium';
            } else {
              popupPulseClass = 'pulse-fast';
            }
          }
        }

        // Apply color class to popup
        popup.className = 'countdown-popup ' + popupTimeClass + ' ' + popupPulseClass;

        // Populate popup
        if (sessions.length === 0) {
          body.innerHTML = `
            <div class="countdown-no-classes">
              <div class="countdown-no-classes-icon">â—Œ</div>
              <div class="countdown-no-classes-text">No upcoming classes scheduled</div>
            </div>
          `;
        } else {
          body.innerHTML = sessions.map(session => {
            const countdown = formatCountdown(session.secondsRemaining);
            const yerevanData = TimezoneUtils.convertLATimeToYerevan(session.laTime);
            
            // Determine class item color based on time remaining
            const hoursRemaining = session.secondsRemaining / 3600;
            let classItemColor = 'class-safe';
            
            if (hoursRemaining > 24) {
              classItemColor = 'class-safe';
            } else if (hoursRemaining > 12) {
              classItemColor = 'class-upcoming';
            } else if (hoursRemaining > 6) {
              classItemColor = 'class-warning';
            } else {
              classItemColor = 'class-critical';
            }

            return `
              <div class="countdown-class-item ${classItemColor}">
                <div class="countdown-class-header">
                  <div class="countdown-class-name">${session.groupName}</div>
                  <div class="countdown-class-time">${countdown}</div>
                </div>
                <div class="countdown-class-details">
                  <div class="countdown-class-detail">
                    <span class="countdown-class-detail-icon">â—†</span>
                    <span>${session.dayName}</span>
                  </div>
                  <div class="countdown-class-detail">
                    <span class="countdown-class-detail-icon">â—‰</span>
                    <span>${session.laTime} LA</span>
                  </div>
                  <div class="countdown-class-detail">
                    <span class="countdown-class-detail-icon">â—Ž</span>
                    <span>${yerevanData.time} Yerevan</span>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }

        // Show overlay and prevent body scrolling
        overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }

      /**
       * Close countdown popup modal
       */
      function closeCountdownPopup() {
        const overlay = document.getElementById('countdownPopupOverlay');
        if (overlay) {
          overlay.style.display = 'none';
          document.body.style.overflow = '';
        }
      }

      // Setup countdown popup event listeners
      document.addEventListener('DOMContentLoaded', () => {
        // Click countdown timer to open popup
        const countdownTimer = document.getElementById('navCountdownTimer');
        if (countdownTimer) {
          countdownTimer.addEventListener('click', openCountdownPopup);
        }

        // Close button
        const closeBtn = document.getElementById('closeCountdownPopup');
        if (closeBtn) {
          closeBtn.addEventListener('click', closeCountdownPopup);
        }

        // Click overlay to close
        const overlay = document.getElementById('countdownPopupOverlay');
        if (overlay) {
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              closeCountdownPopup();
            }
          });
        }

        // ESC key to close
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            closeCountdownPopup();
          }
        });
      });

      // ============================================================
      // EXPOSE COUNTDOWN FUNCTIONS TO WINDOW FOR TESTING/DEBUGGING
      // ============================================================
      window.TimezoneUtils = TimezoneUtils;
      window.findNextClass = findNextClass;
      window.getAllUpcomingSessions = getAllUpcomingSessions;
      window.updateFloatingCountdownUI = updateFloatingCountdownUI;
      window.formatCountdown = formatCountdown;
      window.openCountdownPopup = openCountdownPopup;
      window.closeCountdownPopup = closeCountdownPopup;

      // ============================================================
      // DATA LOADING & ENGINE BRIDGE
      // ============================================================
      async function loadData(force = false, options = {}) {
  debugLog('ðŸ“Š Loading payments via PaymentRecordsEngine...');
        await PaymentRecordsEngine.init(force, options);
      }

      // ============================================================
      // GMAIL INTEGRATION
      // ============================================================
  const GMAIL_CLIENT_ID = '67231383915-4kpdv0k6u517admvhl7jlejku7qtbsjj.apps.googleusercontent.com';
  const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/gmail.send';
  const GMAIL_CONNECTION_KEY = 'gmail-connection';
  const GMAIL_SEARCH_SENDER = 'alerts@notify.wellsfargo.com';
  const GMAIL_SEARCH_SUBJECT = "";
  const GMAIL_LOOKBACK_HOURS = 48; // Default lookback window

      let gmailAccessToken = localStorage.getItem('gmail_access_token');
      let gmailTokenExpiry = localStorage.getItem('gmail_token_expiry');
      const GMAIL_FETCH_CONCURRENCY = 5;

      const delay = (ms = 0) => new Promise(resolve => setTimeout(resolve, ms));

      function buildGmailSearchQuery(options = {}) {
        const { lookbackHours = GMAIL_LOOKBACK_HOURS, afterDate = null } = options;

        let effectiveAfterDate = afterDate;
        if (!effectiveAfterDate) {
          const since = new Date(Date.now() - (lookbackHours * 60 * 60 * 1000));
          effectiveAfterDate = Math.floor(since.getTime() / 1000);
        }

        // Build query - only add subject if it's not empty
        let queryParts = [`from:${GMAIL_SEARCH_SENDER}`];
        if (GMAIL_SEARCH_SUBJECT && GMAIL_SEARCH_SUBJECT.trim()) {
          queryParts.push(`subject:${GMAIL_SEARCH_SUBJECT}`);
        }
        queryParts.push(`after:${effectiveAfterDate}`);

        return {
          query: queryParts.join(' '),
          afterDate: effectiveAfterDate,
          lookbackHours
        };
      }

      function buildKnownGmailIdSet() {
        const lookup = PaymentRecordsEngine?.state?.paymentLookup;
        if (!lookup) return new Set();
        const ids = new Set();
        lookup.forEach((record, key) => {
          if (record?.gmailId) {
            ids.add(record.gmailId);
          }
          if (typeof key === 'string' && key.startsWith('gmail:')) {
            ids.add(key.replace('gmail:', ''));
          }
        });
        return ids;
      }

      async function fetchAndParseGmailMessages(messages = [], options = {}) {
        const {
          skipIds = null,
          onProgress = null,
          progressLabel = 'Gmail fetch'
        } = options;

        if (!messages.length) {
          return { payments: [], processed: 0, filtered: 0 };
        }

        const headers = { 'Authorization': `Bearer ${gmailAccessToken}` };
        const payments = [];
        let processed = 0;
        let filtered = 0;

        for (let i = 0; i < messages.length; i += GMAIL_FETCH_CONCURRENCY) {
          const slice = messages.slice(i, i + GMAIL_FETCH_CONCURRENCY);
          const originalChunkSize = slice.length;
          const chunk = skipIds ? slice.filter(meta => !skipIds.has(meta.id)) : slice;

          if (!chunk.length) {
            processed += originalChunkSize;
            if (typeof onProgress === 'function') {
              onProgress(Math.min(processed, messages.length), messages.length, progressLabel);
            }
            continue;
          }

          const chunkResults = await Promise.all(chunk.map(async (message) => {
            const messageUrl = `https://gmail.googleapis.com/gmail/v1/users/me/messages/${message.id}`;
            const response = await fetch(messageUrl, { headers });
            if (!response.ok) {
              return null;
            }
            const messageData = await response.json();
            return parseZelleEmail(messageData);
          }));

          chunkResults.forEach(result => {
            if (result) {
              payments.push(result);
            } else {
              filtered++;
            }
          });

          processed += originalChunkSize;

          if (typeof onProgress === 'function') {
            onProgress(Math.min(processed, messages.length), messages.length, progressLabel);
          }

          if (i + GMAIL_FETCH_CONCURRENCY < messages.length) {
            await delay(100);
          }
        }

        return { payments, processed, filtered };
      }

      function getGmailConnection() {
        const stored = localStorage.getItem(GMAIL_CONNECTION_KEY);
        if (!stored) return null;

        try {
          const connection = JSON.parse(stored);
          if (connection.expiry_date && Date.now() >= connection.expiry_date) {
            debugLog('Gmail token expired');
            localStorage.removeItem(GMAIL_CONNECTION_KEY);
            return null;
          }
          return connection;
        } catch (e) {
          console.error('Error parsing Gmail connection:', e);
          return null;
        }
      }

      function saveGmailConnection(token, expiresIn, userEmail = null) {
        const connection = {
          access_token: token,
          expiry_date: Date.now() + expiresIn * 1000,
          user_email: userEmail,
          connected_at: new Date().toISOString()
        };

        localStorage.setItem(GMAIL_CONNECTION_KEY, JSON.stringify(connection));
        localStorage.setItem('gmail_access_token', token);
        localStorage.setItem('gmail_token_expiry', connection.expiry_date.toString());

        gmailAccessToken = token;
        gmailTokenExpiry = connection.expiry_date.toString();
      }

      function clearGmailConnection() {
        localStorage.removeItem(GMAIL_CONNECTION_KEY);
        localStorage.removeItem('gmail_access_token');
        localStorage.removeItem('gmail_token_expiry');
        gmailAccessToken = null;
        gmailTokenExpiry = null;
      }

      async function ensureGmailTokenValid() {
  debugLog('ðŸ” Checking Gmail token validity...');

        if (!gmailAccessToken) {
          debugLog('âš ï¸ No token in memory, reloading from storage...');
          const connection = getGmailConnection();

          if (connection && connection.access_token) {
            gmailAccessToken = connection.access_token;
            gmailTokenExpiry = connection.expiry_date.toString();
            debugLog('âœ… Gmail token reloaded from storage');
          } else {
            console.error('âŒ No token available');
            return false;
          }
        }

        const expiry = parseInt(gmailTokenExpiry || '0');
        const now = Date.now();
        const fiveMinutes = 5 * 60 * 1000;

        if (expiry && expiry - now < fiveMinutes) {
          debugLog('ðŸ”„ Gmail token expiring soon, refreshing...');

          try {
            const response = await fetch(`${SUPABASE_URL}/functions/v1/gmail-refresh-token`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
              },
              body: JSON.stringify({ userId: 'admin' })
            });

            if (!response.ok) throw new Error('Token refresh failed');

            const { access_token, expires_at } = await response.json();
            const expiresIn = Math.floor((new Date(expires_at).getTime() - Date.now()) / 1000);

            saveGmailConnection(access_token, expiresIn);
            debugLog('âœ… Gmail token refreshed successfully');
            return true;
          } catch (error) {
            debugWarn('âŒ Token refresh failed:', error);
            return false;
          }
        }

        return true;
      }

      function initiateGmailAuth() {
        const redirectUri = window.location.origin + window.location.pathname;
        const authUrl =
          `https://accounts.google.com/o/oauth2/v2/auth?` +
          `client_id=${GMAIL_CLIENT_ID}&` +
          `redirect_uri=${encodeURIComponent(redirectUri)}&` +
          `response_type=code&` +
          `scope=${encodeURIComponent(GMAIL_SCOPES)}&` +
          `access_type=offline&` +
          `prompt=consent`;

  debugLog('ðŸ”„ Initiating Gmail OAuth...');
        window.location.href = authUrl;
      }

      async function handleOAuthCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
          try {
            debugLog('ðŸ”„ Exchanging authorization code for tokens...');

            const redirectUri = window.location.origin + window.location.pathname;
            const response = await fetch(`${SUPABASE_URL}/functions/v1/gmail-oauth-callback`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
              },
              body: JSON.stringify({
                code: code,
                redirect_uri: redirectUri,
                userId: 'admin'
              })
            });

            if (!response.ok) {
              const error = await response.text();
              throw new Error(`Token exchange failed: ${error}`);
            }

            const { access_token, expires_at } = await response.json();
            const expiresIn = Math.floor((new Date(expires_at).getTime() - Date.now()) / 1000);

            saveGmailConnection(access_token, expiresIn);
            updateGmailButtonState(true);
            showNotification('âœ… Gmail connected successfully!', 'success');

            window.history.replaceState(null, '', window.location.pathname);

            debugLog('ðŸ“¥ Auto-fetching payments after connection...');
            setTimeout(() => fetchPaymentsFromGmail(), 1000);
          } catch (error) {
            console.error('âŒ OAuth callback error:', error);
            showNotification('âŒ Failed to connect Gmail: ' + error.message, 'error');
            window.history.replaceState(null, '', window.location.pathname);
          }
        }
      }

      function updateGmailButtonState(connected) {
        const btn = document.getElementById('gmailBtn');
        const text = document.getElementById('gmailBtnText');
        if (!btn || !text) return;

        if (connected) {
          btn.classList.add('connected');
          text.textContent = 'Gmail';
        } else {
          btn.classList.remove('connected');
          text.textContent = 'Gmail';
        }
      }

      async function toggleGmailConnection() {
        if (gmailAccessToken) {
          const confirmed = await customConfirm(
            'ðŸ”Œ Disconnect Gmail?',
            'This will stop automatic payment email checking.',
            true
          );
          if (confirmed) {
            clearGmailConnection();
            updateGmailButtonState(false);
            showNotification('Gmail disconnected', 'info');
          }
        } else {
          initiateGmailAuth();
        }
      }

      async function fetchPaymentsFromGmail(options = {}) {
        const { silent = false, incremental = false, lookbackHours = GMAIL_LOOKBACK_HOURS } = options || {};
        // console.log(`ðŸ“ž fetchPaymentsFromGmail() called - silent: ${silent}, incremental: ${incremental}, lookbackHours: ${lookbackHours}`);
        
        if (isSyncing) {
          console.log('â­ï¸ Skipping fetch - manual sync in progress');
          debugLog('â­ï¸ Skipping fetch - manual sync in progress');
          return;
        }

        const isValid = await ensureGmailTokenValid();
        // console.log('ðŸ” Gmail token valid:', isValid, 'gmailAccessToken:', !!gmailAccessToken);
        
        if (!isValid || !gmailAccessToken) {
          console.warn('âš ï¸ Gmail not connected, skipping auto-refresh');
          debugLog('âš ï¸ Gmail not connected, skipping auto-refresh');
          return;
        }

        const queryMeta = buildGmailSearchQuery({ lookbackHours });
        // console.log(`ðŸ”„ [${silent ? 'Auto-Refresh' : 'Manual'}] Checking for payment emails from last ${queryMeta.lookbackHours}h...`);
        debugLog(`ðŸ”„ [${silent ? 'Auto-Refresh' : 'Manual'}] Checking for payment emails from last ${queryMeta.lookbackHours}h...`);

        try {
          const { query, afterDate, lookbackHours: resolvedLookbackHours } = queryMeta;
          // console.log(`ðŸ“§ Gmail query: "${query}"`);
          // console.log(`ðŸ“§ After timestamp: ${afterDate} (${new Date(afterDate * 1000).toLocaleString()}) | Lookback window: last ${resolvedLookbackHours}h`);
          
          const searchUrl = `https://gmail.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent(query)}&maxResults=100`;

          const searchResponse = await fetch(searchUrl, {
            headers: { 'Authorization': `Bearer ${gmailAccessToken}` }
          });

          if (!searchResponse.ok) {
            if (searchResponse.status === 401) {
              clearGmailConnection();
              updateGmailButtonState(false);
              console.warn('ðŸ”’ Gmail session expired. Please reconnect.');
              return;
            }
            throw new Error(`Gmail API error: ${searchResponse.status}`);
          }

          const searchData = await searchResponse.json();
          // console.log(`ðŸ“¬ Gmail API returned ${searchData.messages?.length || 0} total messages`);

          if (!searchData.messages || searchData.messages.length === 0) {
            console.log(`ðŸ“­ [${silent ? 'Auto-Refresh' : 'Manual'}] No payment emails found in last ${resolvedLookbackHours}h`);
            debugLog(`ðŸ“­ [${silent ? 'Auto-Refresh' : 'Manual'}] No payment emails found in last ${resolvedLookbackHours}h`);
            return;
          }

          // console.log(`ðŸ“§ [${silent ? 'Auto-Refresh' : 'Manual'}] Found ${searchData.messages.length} messages within last ${resolvedLookbackHours}h, parsing...`);
          debugLog(`ðŸ“§ [${silent ? 'Auto-Refresh' : 'Manual'}] Found ${searchData.messages.length} messages within last ${resolvedLookbackHours}h, parsing...`);
          const knownIds = buildKnownGmailIdSet();
          // console.log(`ðŸ” Known Gmail IDs in database: ${knownIds.size}`);
          // console.log(`ðŸ” Known IDs:`, Array.from(knownIds));
          
          const { payments } = await fetchAndParseGmailMessages(searchData.messages, {
            skipIds: knownIds,
            progressLabel: silent ? 'Auto-refresh' : 'Manual refresh'
          });

          if (payments.length > 0) {
            // console.log(`âœ… [${silent ? 'Auto-Refresh' : 'Manual'}] Parsed ${payments.length} NEW payments (after filtering known IDs)`);
            debugLog(`âœ… [${silent ? 'Auto-Refresh' : 'Manual'}] Parsed ${payments.length} payments:`, payments);

            const { error } = await savePaymentsToSupabase(payments, 'Auto-Refresh');
            if (error) {
              console.error('[Auto-Refresh] Supabase save failed');
            }

            // Always force reload to refresh student emails AND payment data
            await PaymentRecordsEngine.load(true, { silent });
          } else {
            // console.log(`ðŸ“­ [${silent ? 'Auto-Refresh' : 'Manual'}] No NEW payments (all ${searchData.messages.length} emails already in database)`);
            debugLog(`ðŸ“­ [${silent ? 'Auto-Refresh' : 'Manual'}] No new payments found`);
          }
        } catch (error) {
          console.error('[Auto-Refresh] Error fetching payments:', error);
        }
      }

      function decodeBase64Unicode(raw = '') {
        try {
          if (!raw) return '';
          const normalized = raw.replace(/-/g, '+').replace(/_/g, '/');
          const binary = atob(normalized);
          const bytes = Uint8Array.from(binary, char => char.charCodeAt(0));
          return new TextDecoder('utf-8').decode(bytes);
        } catch (error) {
          console.warn('âš ï¸ Failed to decode base64 email body:', error);
          return '';
        }
      }

      function cleanEmailBody(text = '') {
        if (!text) return '';
        return text
          .replace(/<style[\s\S]*?<\/style>/gi, ' ')
          .replace(/<script[\s\S]*?<\/script>/gi, ' ')
          .replace(/<[^>]*>/g, ' ')
          .replace(/&nbsp;/gi, ' ')
          .replace(/&amp;/gi, '&')
          .replace(/&quot;/gi, '"')
          .replace(/&apos;/gi, "'")
          .replace(/&#39;/g, "'")
          .replace(/\s+/g, ' ')
          .trim();
      }

      function parseZelleEmail(messageData) {
        try {
          const headers = messageData.payload.headers;
          const dateHeader = headers.find(h => h.name === 'Date');
          
          // Get Gmail's timestamp (already in UTC) - we'll display it in LA timezone
          const gmailTimestamp = dateHeader ? new Date(dateHeader.value) : new Date();

          // Store the UTC timestamp directly (no conversion needed)
          const timestampStr = gmailTimestamp.toISOString();
          
          // Get LA time components just for the date grouping
          const laParts = getLAParts(gmailTimestamp);
          const dateStr = `${laParts.year}-${laParts.month}-${laParts.day}`;

          let bodyText = '';
          if (messageData.payload.body && messageData.payload.body.data) {
            bodyText = decodeBase64Unicode(messageData.payload.body.data);
          } else if (messageData.payload.parts) {
            // Try to get text/plain first
            const textPart = messageData.payload.parts.find(p => p.mimeType === 'text/plain');
            if (textPart && textPart.body && textPart.body.data) {
              bodyText = decodeBase64Unicode(textPart.body.data);
            } else {
              // Fallback to text/html if no plain text available
              const htmlPart = messageData.payload.parts.find(p => p.mimeType === 'text/html');
              if (htmlPart && htmlPart.body && htmlPart.body.data) {
                bodyText = decodeBase64Unicode(htmlPart.body.data);
              }
            }
          }

          if (!bodyText && messageData.snippet) {
            bodyText = messageData.snippet;
          }

          if (!bodyText) {
            console.warn('âš ï¸ No body text for email:', messageData.id);
            return null;
          }

          // Strip ALL HTML tags and normalize whitespace/entities
          bodyText = cleanEmailBody(bodyText);

          console.log('ðŸ“§ Parsing email body:', bodyText.substring(0, 300));

          const bodyTextLower = bodyText.toLowerCase();

          // âœ… Wells Fargo Zelle payment pattern: "SENDER NAME sent you $AMOUNT"
          // Look for pattern in body text - match only capital letter words before "sent you"
          const wellsFargoPattern = /([A-Za-z][A-Za-z\s]+?)\s+sent\s+you\s+\$?([\d,]+\.\d{2})/;
          const patternMatch = bodyText.match(wellsFargoPattern);

          console.log('ðŸ“§ Parsing email body:', bodyText.substring(0, 300));
          console.log('ðŸ” Wells Fargo pattern match:', patternMatch);

          if (!patternMatch) {
            console.warn('âš ï¸ Wells Fargo payment pattern not found in email:', messageData.id);
            console.warn('Body preview:', bodyText.substring(0, 500));
            return null;
          }

          // Extract sender name and amount from the pattern
          let senderName = patternMatch[1].trim();
          const amount = parseFloat(patternMatch[2].replace(/[,]/g, ''));

          // Clean up sender name
          senderName = senderName
            .replace(/^Wells\s+Fargo\s+home\s+page\s*/i, '')
            .replace(/^Wells\s+Fargo\s*/i, '')
            .replace(/\s+/g, ' ')
            .trim();

          if (!senderName || senderName.length < 2) {
            console.warn('âš ï¸ Unable to parse sender name from email:', messageData.id, 'Body preview:', bodyText.slice(0, 120));
            return null;
          }

          if (/[<>{}[\]\\\/]/.test(senderName)) {
            console.warn('âš ï¸ Invalid sender name detected, skipping email:', messageData.id, 'Name:', senderName);
            return null;
          }

          // Keep names comfortably below index limits
          if (senderName.length > 120) {
            console.warn('âš ï¸ Sender name too long, truncating:', senderName.substring(0, 80) + '...');
            senderName = senderName.substring(0, 120).trim();
          }

          // Parse date from Wells Fargo email - look for "Date: MM/DD/YYYY" pattern
          let emailDate = dateStr; // Default to email received date
          const datePattern = /Date:\s*(\d{2}\/\d{2}\/\d{4})/i;
          const dateMatch = bodyText.match(datePattern);
          
          if (dateMatch) {
            // Parse MM/DD/YYYY format
            const [month, day, year] = dateMatch[1].split('/');
            emailDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
          }

          // Parse memo/message from Wells Fargo email
          let memo = '';
          const memoPattern = /Memo:\s*([^\n\r]+?)(?:We\s+deposited|Go\s+to\s+accounts|Have\s+any\s+questions|$)/i;
          const memoMatch = bodyText.match(memoPattern);
          if (memoMatch) {
            memo = memoMatch[1].trim();
          }

          // Fallback: use confirmation number if memo is missing
          if (!memo) {
            const confirmationPattern = /Confirmation:\s*([A-Z0-9]+)/i;
            const confirmationMatch = bodyText.match(confirmationPattern);
            if (confirmationMatch) {
              memo = `Confirmation: ${confirmationMatch[1]}`;
            }
          }

          // Limit memo to 500 characters to avoid database issues
          if (memo.length > 500) {
            memo = memo.substring(0, 500);
          }

          if (!amount || !senderName) return null;

          const payerDisplayName = formatPayerDisplayName(senderName) || senderName;

          return {
            id: messageData.id,
            gmailId: messageData.id,
            payer: payerDisplayName,
            amount: amount,
            date: emailDate, // Use parsed date from email body
            timestamp: timestampStr,
            email_date: timestampStr,
            memo: memo,
            status: 'unmatched'
          };
        } catch (error) {
          console.error('Error parsing Wells Fargo Zelle email:', error);
          return null;
        }
      }

      // Sync Recent Gmail Payments (manual button)
      async function syncTodayPayments() {
        const btn = document.getElementById('syncTodayBtn');

        // Check if already syncing
        if (btn.classList.contains('syncing')) {
          console.log('â­ï¸ Already syncing recent Gmail payments');
          debugLog('â­ï¸ Already syncing recent Gmail payments');
          return;
        }

        // Check Gmail connection
        const isValid = await ensureGmailTokenValid();
        console.log('ðŸ” Gmail token valid:', isValid, 'gmailAccessToken exists:', !!gmailAccessToken);
        
        if (!isValid || !gmailAccessToken) {
          console.warn('âš ï¸ Gmail not connected - isValid:', isValid, 'token:', !!gmailAccessToken);
          showNotification('âš ï¸ Please connect Gmail first', 'warning');
          return;
        }

        // Start syncing animation
        btn.classList.add('syncing');
        const startTime = Date.now();
        const { query, afterDate, lookbackHours } = buildGmailSearchQuery();
        console.log(`â˜ï¸ Syncing Gmail payments from last ${lookbackHours}h...`);
        console.log(`ðŸ“§ Gmail search query: "${query}"`);
        console.log(`ðŸ“§ After timestamp: ${afterDate} (${new Date(afterDate * 1000).toLocaleString()}) | Lookback window: last ${lookbackHours}h`);
        debugLog(`â˜ï¸ Syncing Gmail payments from last ${lookbackHours}h...`);

        try {
          const searchUrl = `https://gmail.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent(query)}&maxResults=100`;
          console.log(`ðŸŒ Fetching from Gmail API: ${searchUrl}`);

          const searchResponse = await fetch(searchUrl, {
            headers: { 'Authorization': `Bearer ${gmailAccessToken}` }
          });

          console.log(`ðŸ“¬ Gmail API response status: ${searchResponse.status}`);

          if (!searchResponse.ok) {
            if (searchResponse.status === 401) {
              clearGmailConnection();
              updateGmailButtonState(false);
              throw new Error('Gmail session expired. Please reconnect.');
            }
            throw new Error(`Gmail API error: ${searchResponse.status}`);
          }

          const searchData = await searchResponse.json();
          console.log(`ðŸ“§ Gmail API returned ${searchData.messages?.length || 0} messages`);
          console.log('ðŸ“§ Raw search data:', searchData);

          if (!searchData.messages || searchData.messages.length === 0) {
            console.log(`ðŸ“­ No payments found in last ${lookbackHours}h`);
            showNotification(`ðŸ“­ No payments found in last ${lookbackHours}h`, 'info');
            btn.classList.remove('syncing');
            btn.title = `Sync recent payments (last ${lookbackHours}h)`;
            return;
          }

          console.log(`ðŸ“§ Found ${searchData.messages.length} messages (last ${lookbackHours}h), parsing...`);
          debugLog(`ðŸ“§ Found ${searchData.messages.length} messages (last ${lookbackHours}h), parsing...`);
          const { payments } = await fetchAndParseGmailMessages(searchData.messages, {
            onProgress: (current, total) => {
              btn.title = `Syncing ${current}/${total}`;
            },
            progressLabel: 'Sync Recent'
          });

          if (payments.length > 0) {
            debugLog(`âœ… Parsed ${payments.length} payments from last ${lookbackHours}h`);
            renderPayments(payments);
            const { data, error } = await savePaymentsToSupabase(payments, 'Manual Sync - Recent');
            if (error) {
              showNotification('âŒ Failed to save payments to Supabase. See console for details.', 'error');
            } else {
              showNotification(`âœ… Synced ${data.length} payment${data.length !== 1 ? 's' : ''} from last ${lookbackHours}h`, 'success');
              // Force reload to refresh both payments AND student emails
              await PaymentRecordsEngine.load(true, { silent: false });
            }
          } else {
            showNotification(`ðŸ“­ No valid payments found in last ${lookbackHours}h`, 'info');
          }
        } catch (error) {
          console.error('âŒ Error syncing recent Gmail payments:', error);
          showNotification('âŒ Failed to sync: ' + error.message, 'error');
        } finally {
          // Remove syncing state after operation completes
          btn.classList.remove('syncing');
          btn.title = `Sync recent payments (last ${lookbackHours}h)`;
          debugLog('âœ… Sync recent payments operation completed');
        }
      }

      // Test function to verify animation works
      window.testSyncAnimation = function() {
        const btn = document.getElementById('syncTodayBtn');
        btn.classList.add('syncing');
        debugLog('ðŸ§ª Sync button animation test started - icon should spin for 5 seconds');
        setTimeout(() => {
          btn.classList.remove('syncing');
          debugLog('ðŸ§ª Sync button animation test complete');
        }, 5000);
      };

      // Test navbar refresh animation
      window.testNavRefreshAnimation = function() {
        const btn = document.getElementById('navRefreshBtn');
        const svg = btn.querySelector('svg');
        debugLog('ðŸ§ª Nav refresh button:', btn);
        debugLog('ðŸ§ª Nav refresh SVG:', svg);
        debugLog('ðŸ§ª Button classes before:', btn.className);
        
        btn.classList.add('refreshing');
        debugLog('ðŸ§ª Button classes after:', btn.className);
        debugLog('ðŸ§ª Nav refresh animation test started - icon should spin for 5 seconds');
        
        const computedStyle = window.getComputedStyle(svg);
        debugLog('ðŸ§ª SVG animation:', computedStyle.animation);
        debugLog('ðŸ§ª SVG animationName:', computedStyle.animationName);
        
        setTimeout(() => {
          btn.classList.remove('refreshing');
          debugLog('ðŸ§ª Nav refresh animation test complete');
        }, 5000);
      };

      function renderPayments(payments = []) {
  debugLog('ðŸ“Š renderPayments (Gmail ingest) called with:', payments.length, 'payments');
        if (!payments || payments.length === 0) {
          showNotification('ðŸ“­ No new payments found to display', 'info');
          return;
        }
        PaymentRecordsEngine.ingestLivePayments(payments);
      }

      async function savePaymentsToSupabase(payments = [], contextLabel = 'Manual Sync') {
        if (!payments.length) {
          return { data: [], error: null };
        }

        // Load all students for matching
        const { data: allStudents, error: studentsError } = await supabaseClient
          .from('students')
          .select('id, name, email, aliases');
        
        if (studentsError) {
          console.error('Error loading students for matching:', studentsError);
        }

        // Match each payment to a student ID - ONLY by payer name, NEVER by message text
        const supabasePayments = payments.map(p => {
          let linked_student_id = null;
          let matched_student_name = null;
          
          // Only match by PAYER name, never by message/memo content
          if (p.payer && allStudents) {
            const payerName = p.payer.toLowerCase();
            
            // Try exact name match first
            let matchedStudent = allStudents.find(s => 
              s.name && s.name.toLowerCase() === payerName
            );
            
            // Try partial name match (all words in payer name appear in student name)
            if (!matchedStudent) {
              matchedStudent = allStudents.find(s => {
                if (!s.name) return false;
                const name = s.name.toLowerCase();
                const nameParts = payerName.split(/\s+/);
                return nameParts.every(part => name.includes(part));
              });
            }
            
            // Try aliases match
            if (!matchedStudent) {
              matchedStudent = allStudents.find(s => {
                if (!s.aliases) return false;
                let aliases = [];
                try {
                  aliases = typeof s.aliases === 'string' ? JSON.parse(s.aliases) : s.aliases;
                } catch (e) {
                  aliases = [s.aliases];
                }
                return aliases.some(alias => 
                  alias && alias.toLowerCase() === payerName
                );
              });
            }
            
            if (matchedStudent) {
              linked_student_id = matchedStudent.id;
              matched_student_name = matchedStudent.name;
              debugLog(`âœ… Matched payer "${p.payer}" â†’ Student "${matchedStudent.name}" (ID: ${linked_student_id})`);
            } else {
              debugLog(`âš ï¸ No match for payer "${p.payer}" - will show as Unmatched`);
            }
          }
          
          return {
            id: p.gmailId,
            gmail_id: p.gmailId,
            payer_name: p.payer,
            amount: p.amount,
            date: p.date,
            email_date: p.timestamp,
            memo: p.memo,
            student_name: matched_student_name, // Only set if matched, otherwise null
            linked_student_id: linked_student_id,
            status: linked_student_id ? 'matched' : 'unmatched'
          };
        });

        // Filter out payments that are already ignored OR already exist in payments table
        const paymentIds = supabasePayments.map(p => p.id);
        console.log('ðŸ’¾ Payment IDs (gmail_ids) to check:', paymentIds);
        
        // Check for ignored payments
        const { data: ignoredPayments } = await supabaseClient
          .from('ignored_fuchsia_payments')
          .select('payment_id')
          .in('payment_id', paymentIds);
        
        console.log('ðŸš« Ignored payments from DB:', ignoredPayments);
        
        const ignoredIds = new Set((ignoredPayments || []).map(p => p.payment_id));
        console.log('ðŸš« Ignored IDs Set:', Array.from(ignoredIds));
        
        // CRITICAL FIX: Check for existing gmail_ids in payments table to prevent re-insertion
        const { data: existingGmailPayments } = await supabaseClient
          .from('payments')
          .select('gmail_id, memo')
          .in('gmail_id', paymentIds);
        
        const existingGmailIds = new Set((existingGmailPayments || []).map(p => p.gmail_id));
        const existingMemoById = new Map((existingGmailPayments || []).map(p => [p.gmail_id, p.memo || '']));
        console.log(`ðŸ“‹ Existing gmail_ids in payments table: ${existingGmailIds.size} found`);
        
        const isMeaningfulMemo = (value = '') => {
          const trimmed = String(value || '').trim();
          if (!trimmed) return false;
          return !/^confirmation:/i.test(trimmed);
        };
        
        const memoUpdates = supabasePayments
          .filter(p => existingGmailIds.has(p.id))
          .map(p => {
            const newMemo = String(p.memo || '').trim();
            const existingMemo = String(existingMemoById.get(p.id) || '').trim();
            if (!newMemo || newMemo === existingMemo) return null;
            if (isMeaningfulMemo(newMemo) && !isMeaningfulMemo(existingMemo)) {
              return { gmail_id: p.id, memo: newMemo };
            }
            return null;
          })
          .filter(Boolean);
        
        if (memoUpdates.length > 0) {
          console.log(`ðŸ“ Updating memo for ${memoUpdates.length} existing payments`);
          await Promise.all(
            memoUpdates.map(update =>
              supabaseClient
                .from('payments')
                .update({ memo: update.memo })
                .eq('gmail_id', update.gmail_id)
            )
          );
        }
        
        const paymentsToInsert = supabasePayments.filter(p => !ignoredIds.has(p.id) && !existingGmailIds.has(p.id));
        console.log(`âœ… Payments to insert after filtering: ${paymentsToInsert.length} out of ${supabasePayments.length} (${ignoredIds.size} ignored, ${existingGmailIds.size} already exist)`);
        
        if (paymentsToInsert.length === 0) {
          debugLog(`â­ï¸ [${contextLabel}] All ${supabasePayments.length} payments are already ignored or exist in DB, skipping insert`);
          return { data: [], error: null };
        }
        
        if (ignoredIds.size > 0 || existingGmailIds.size > 0) {
          debugLog(`â­ï¸ [${contextLabel}] Skipping ${ignoredIds.size} ignored + ${existingGmailIds.size} existing payments, inserting ${paymentsToInsert.length}`);
        }

        // CRITICAL FIX: Check for existing (student_id, for_class) combinations to avoid unique constraint violation
        // Note: New payment objects use 'linked_student_id', but database uses 'student_id'
        const getForClassCandidate = (payment) => payment.for_class || payment.date || null;
        const paymentsWithStudent = paymentsToInsert.filter(p => (p.linked_student_id || p.student_id) && getForClassCandidate(p));
        if (paymentsWithStudent.length > 0) {
          // Build a list of all student_ids and for_class dates
          const studentIds = [...new Set(paymentsWithStudent.map(p => p.linked_student_id || p.student_id))];
          const forClassDates = [...new Set(paymentsWithStudent.map(p => getForClassCandidate(p)))];
          
          debugLog(`ðŸ” [${contextLabel}] Checking ${paymentsWithStudent.length} payments for duplicate (student_id, for_class) pairs`);
          debugLog(`ðŸ“Š [${contextLabel}] Student IDs: ${studentIds.join(', ')}`);
          debugLog(`ðŸ“… [${contextLabel}] for_class dates: ${forClassDates.join(', ')}`);
          
          // Query for all existing payments with these student_ids and dates
          const { data: existingPayments } = await supabaseClient
            .from('payments')
            .select('id, student_id, for_class')
            .in('student_id', studentIds)
            .in('for_class', forClassDates)
            .not('student_id', 'is', null)
            .not('for_class', 'is', null);
          
          if (existingPayments && existingPayments.length > 0) {
            debugLog(`ðŸ“‹ [${contextLabel}] Found ${existingPayments.length} existing (student_id, for_class) pairs in database`);
            
            // Create a Set of existing (student_id, for_class) combinations
            const existingPairs = new Set(
              existingPayments.map(p => `${p.student_id}|${p.for_class}`)
            );
            
            // Filter out payments that would violate the unique constraint
            const beforeFilterCount = paymentsToInsert.length;
            const filteredPayments = paymentsToInsert.filter(p => {
              const studentId = p.linked_student_id || p.student_id;
              const forClassCandidate = getForClassCandidate(p);
              if (!studentId || !forClassCandidate) return true; // Keep payments without both fields
              const pairKey = `${studentId}|${forClassCandidate}`;
              const isDuplicate = existingPairs.has(pairKey);
              if (isDuplicate) {
                debugLog(`ðŸš« [${contextLabel}] Filtering duplicate: student_id=${studentId}, for_class=${forClassCandidate}`);
              }
              return !isDuplicate; // Only keep if pair doesn't exist
            });
            
            const duplicateCount = beforeFilterCount - filteredPayments.length;
            if (duplicateCount > 0) {
              console.log(`âš ï¸ [${contextLabel}] Filtered out ${duplicateCount} duplicate (student_id, for_class) pairs BEFORE insert`);
              paymentsToInsert.length = 0;
              paymentsToInsert.push(...filteredPayments);
            }
          } else {
            debugLog(`âœ… [${contextLabel}] No existing (student_id, for_class) pairs found - safe to insert`);
          }
        }

        if (paymentsToInsert.length === 0) {
          debugLog(`â­ï¸ [${contextLabel}] All payments are duplicates or ignored, skipping insert`);
          return { data: [], error: null };
        }

        // CRITICAL: Use ignoreDuplicates=true to skip updates of existing gmail_id records
        // This prevents overwriting manually-assigned student_id/for_class values
        // which would violate the unique_student_class_payment constraint
        console.log(`ðŸ’¾ [${contextLabel}] Inserting ${paymentsToInsert.length} payment(s) with ignoreDuplicates=true`);
        
        const { data, error } = await supabaseClient
          .from('payments')
          .upsert(paymentsToInsert, { 
            onConflict: 'gmail_id',
            ignoreDuplicates: true  // Skip updates if gmail_id already exists
          })
          .select();

        if (error) {
          console.error(`[${contextLabel}] Error saving to Supabase:`, error);
          if (error.code === '23505') {
            // This should not happen with ignoreDuplicates=true, but handle gracefully
            console.warn(`âš ï¸ [${contextLabel}] Constraint violation - skipping duplicate`);
            return { data: data || [], error: null };
          }
          return { data: null, error };
        }
        
        console.log(`âœ… [${contextLabel}] Successfully processed ${paymentsToInsert.length} payment(s), ${data?.length || 0} inserted`);


        const matchedCount = supabasePayments.filter(p => p.linked_student_id).length;
        debugLog(`ðŸ’¾ [${contextLabel}] Saved ${data.length} payments to Supabase (${matchedCount} matched to students)`);
        return { data, error: null };
      }

      function showNotification(message, type = 'info') {
  debugLog(`[${type.toUpperCase()}] ${message}`);
        // TODO: Implement toast notification UI
      }

      // ============================================================
      // CUSTOM ALERT/PROMPT/CONFIRM FUNCTIONS
      // ============================================================

      function customAlert(title, message) {
        return new Promise((resolve) => {
          const overlay = document.getElementById('customAlertOverlay');
          const titleEl = document.getElementById('customAlertTitle');
          const messageEl = document.getElementById('customAlertMessage');
          const inputEl = document.getElementById('customAlertInput');
          const buttonsEl = document.getElementById('customAlertButtons');
          const okBtn = document.getElementById('customAlertOk');
          const cancelBtn = document.getElementById('customAlertCancel');

          titleEl.textContent = title;
          messageEl.textContent = message;
          inputEl.style.display = 'none';
          cancelBtn.style.display = 'none';
          okBtn.textContent = 'OK';
          okBtn.className = 'custom-alert-btn ok';

          const handleOk = () => {
            overlay.classList.remove('active');
            okBtn.removeEventListener('click', handleOk);
            resolve(true);
          };

          // Remove any existing listeners before adding new one
          okBtn.replaceWith(okBtn.cloneNode(true));
          const newOkBtn = document.getElementById('customAlertOk');
          newOkBtn.addEventListener('click', handleOk);
          overlay.classList.add('active');
        });
      }

      function customPrompt(title, message, placeholder = '', defaultValue = '') {
        return new Promise((resolve) => {
          const overlay = document.getElementById('customAlertOverlay');
          const titleEl = document.getElementById('customAlertTitle');
          const messageEl = document.getElementById('customAlertMessage');
          const inputEl = document.getElementById('customAlertInput');
          const okBtn = document.getElementById('customAlertOk');
          const cancelBtn = document.getElementById('customAlertCancel');

          titleEl.textContent = title;
          messageEl.textContent = message;
          inputEl.style.display = 'block';
          inputEl.placeholder = placeholder;
          inputEl.value = defaultValue;
          cancelBtn.style.display = 'inline-block';
          okBtn.textContent = 'OK';
          okBtn.className = 'custom-alert-btn ok';

          const handleOk = () => {
            const value = inputEl.value;
            overlay.classList.remove('active');
            resolve(value);
          };

          const handleCancel = () => {
            overlay.classList.remove('active');
            resolve(null);
          };

          // Remove any existing listeners by cloning buttons
          const newOkBtn = okBtn.cloneNode(true);
          const newCancelBtn = cancelBtn.cloneNode(true);
          okBtn.replaceWith(newOkBtn);
          cancelBtn.replaceWith(newCancelBtn);
          
          // Get fresh references after replacement
          const okButton = document.getElementById('customAlertOk');
          const cancelButton = document.getElementById('customAlertCancel');
          
          okButton.addEventListener('click', handleOk);
          cancelButton.addEventListener('click', handleCancel);
          overlay.classList.add('active');

          // Focus input
          setTimeout(() => inputEl.focus(), 100);
        });
      }

      // âš¡ PERFORMANCE FIX: Removed duplicate customAlert() function (was defined twice)
      // Original definition at line ~8226 is kept, this duplicate removed

      function customConfirm(title, message, isDanger = false) {
        return new Promise((resolve) => {
          const overlay = document.getElementById('customAlertOverlay');
          const titleEl = document.getElementById('customAlertTitle');
          const messageEl = document.getElementById('customAlertMessage');
          const inputEl = document.getElementById('customAlertInput');
          const okBtn = document.getElementById('customAlertOk');
          const cancelBtn = document.getElementById('customAlertCancel');

          titleEl.textContent = title;
          messageEl.textContent = message;
          inputEl.style.display = 'none';
          cancelBtn.style.display = 'inline-block';
          okBtn.textContent = 'OK';
          okBtn.className = isDanger ? 'custom-alert-btn danger' : 'custom-alert-btn ok';

          const handleOk = () => {
            overlay.classList.remove('active');
            resolve(true);
          };

          const handleCancel = () => {
            overlay.classList.remove('active');
            resolve(false);
          };

          // Remove any existing listeners by cloning buttons
          const newOkBtn = okBtn.cloneNode(true);
          const newCancelBtn = cancelBtn.cloneNode(true);
          okBtn.replaceWith(newOkBtn);
          cancelBtn.replaceWith(newCancelBtn);
          
          // Get fresh references after replacement and re-apply styling
          const okButton = document.getElementById('customAlertOk');
          const cancelButton = document.getElementById('customAlertCancel');
          okButton.className = isDanger ? 'custom-alert-btn danger' : 'custom-alert-btn ok';
          
          okButton.addEventListener('click', handleOk);
          cancelButton.addEventListener('click', handleCancel);
          overlay.classList.add('active');
        });
      }

      // Close on overlay click
      document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('customAlertOverlay');
        if (overlay) {
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              // Trigger cancel
              const cancelBtn = document.getElementById('customAlertCancel');
              if (cancelBtn.style.display !== 'none') {
                cancelBtn.click();
              } else {
                document.getElementById('customAlertOk').click();
              }
            }
          });
        }
      });

      // ============================================================
      // PAYER ACTIONS POPUP FUNCTIONALITY
      // ============================================================

      let currentPaymentData = null;

      function openPayerActionsPopup(paymentData) {
  debugLog('ðŸ” Opening Payer Actions popup with data:', paymentData);

        const record = paymentData?.paymentKey
          ? PaymentRecordsEngine.state.paymentLookup.get(paymentData.paymentKey)
          : null;

        currentPaymentData = record || { ...paymentData };

        const amountUsd = record?.amountUSD ?? Number(paymentData.amount || paymentData.amountUsd || 0);
        const amountAmd = record?.amountAMD ?? Number(paymentData.amountAmd || (amountUsd * PaymentRecordsEngine.state.usdToAmdRate));

        const payerDisplayName = record?.payerName || paymentData.payer || 'â€”';
        const payerRaw = record?.payerNameRaw || paymentData.payerRaw || payerDisplayName;
        currentPaymentData.payerRaw = payerRaw;
        currentPaymentData.payerName = payerDisplayName;
        document.getElementById('payerSummaryName').textContent = payerDisplayName;
        document.getElementById('payerSummaryAmountUSD').textContent = `${Math.round(amountUsd)} $`;
        document.getElementById('payerSummaryAmountAMD').textContent = `${Math.round(amountAmd).toLocaleString()} Ö`;
  const dateLabelText = record?.dateLabelText || (record?.dateLabel ? record.dateLabel.replace(/<[^>]+>/g, '').trim() : null);
  document.getElementById('payerSummaryDate').textContent = dateLabelText || paymentData.date || 'â€”';
        document.getElementById('payerSummaryMessage').textContent = record?.memo || paymentData.message || 'No message';

        // Show popup
        const overlay = document.getElementById('payerActionsOverlay');
        overlay.classList.add('active');

  debugLog('âœ… Payer Actions popup opened');
      }

      function closePayerActionsPopup() {
  debugLog('ðŸ” Closing Payer Actions popup');

        const overlay = document.getElementById('payerActionsOverlay');
        overlay.classList.remove('active');

        currentPaymentData = null;

  debugLog('âœ… Payer Actions popup closed');
      }

      // Close on overlay click
      document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('payerActionsOverlay');
        if (overlay) {
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              closePayerActionsPopup();
            }
          });
        }
      });

      async function createPayerAlias() {
  debugLog('ðŸ·ï¸ Creating payer alias for:', currentPaymentData?.payer);

        if (!currentPaymentData) {
          showNotification('No payment data selected', 'error');
          return;
        }

        const payerName = currentPaymentData.payer;

        // Prompt for student selection or create unmatched alias
        const studentName = await customPrompt(
          `Create alias for "${payerName}"`,
          'Enter student name (or leave blank for unmatched):',
          'Student name...'
        );

        if (studentName === null) return; // Cancelled

        try {
          // TODO: Integrate with Supabase aliases table
          // For now, just show confirmation
          showNotification(`Alias created: "${payerName}" â†’ "${studentName || 'Unmatched'}"`, 'success');
          closePayerActionsPopup();
        } catch (error) {
          console.error('âŒ Error creating alias:', error);
          showNotification('Failed to create alias', 'error');
        }
      }

      async function changePaymentDate() {
  debugLog('ðŸ“… Changing payment date for:', currentPaymentData?.paymentId);

        if (!currentPaymentData) {
          showNotification('No payment data selected', 'error');
          return;
        }

        const newDate = await customPrompt(
          'Change payment date',
          `Current: ${currentPaymentData.date}\n\nEnter new date (YYYY-MM-DD):`,
          'YYYY-MM-DD'
        );

        if (!newDate) return; // Cancelled

        try {
          // TODO: Update Supabase
          // const { error } = await supabaseClient
          //   .from('payments')
          //   .update({ created_at: newDate })
          //   .eq('id', currentPaymentData.paymentId);

          showNotification(`Payment date updated to ${newDate}`, 'success');
          closePayerActionsPopup();
          // Refresh data
          loadData();
        } catch (error) {
          console.error('âŒ Error updating date:', error);
          showNotification('Failed to update date', 'error');
        }
      }

      async function deletePayment() {
  debugLog('ðŸ—‘ï¸ Deleting payment:', currentPaymentData?.paymentId);

        if (!currentPaymentData) {
          showNotification('No payment data selected', 'error');
          return;
        }

        const confirmed = await customConfirm(
          'Delete this payment?',
          `Payer: ${currentPaymentData.payer}\nAmount: ${currentPaymentData.amount} $\n\nThis action cannot be undone.`,
          true // isDanger
        );

        if (!confirmed) return;

        try {
          // TODO: Delete from Supabase
          // const { error } = await supabaseClient
          //   .from('payments')
          //   .delete()
          //   .eq('id', currentPaymentData.paymentId);

          showNotification('Payment deleted successfully', 'success');
          closePayerActionsPopup();
          // Refresh data
          loadData();
        } catch (error) {
          console.error('âŒ Error deleting payment:', error);
          showNotification('Failed to delete payment', 'error');
        }
      }

      async function ignorePayment() {
  debugLog('ðŸ‘ï¸ Ignoring payment:', currentPaymentData?.paymentId);

        if (!currentPaymentData) {
          showNotification('No payment data selected', 'error');
          return;
        }

        try {
          // Insert into ignored_fuchsia_payments table
          const { error } = await supabaseClient
            .from('ignored_fuchsia_payments')
            .insert({
              payment_id: String(currentPaymentData.paymentId),
              student_id: currentPaymentData.studentId || null,
              ignored_by: 'admin'
            });

          if (error) {
            // If already ignored, update the timestamp
            if (error.code === '23505') { // Unique constraint violation
              showNotification('Payment already ignored', 'info');
            } else {
              throw error;
            }
          } else {
            showNotification('Payment marked as ignored', 'success');
          }

          closePayerActionsPopup();
          
          // Clear cache to force fresh fetch with updated ignored list
          PaymentRecordsEngine.state.paymentsCache = null;
          
          // Refresh data
          await PaymentRecordsEngine.load(true, { silent: false });
        } catch (error) {
          console.error('âŒ Error ignoring payment:', error);
          showNotification('Failed to ignore payment', 'error');
        }
      }

      async function ignoreAllFromPayer() {
  debugLog('ðŸš« Ignoring all payments from:', currentPaymentData?.payer);

        if (!currentPaymentData) {
          showNotification('No payment data selected', 'error');
          return;
        }

        const confirmed = await customConfirm(
          'Ignore all payments from this payer?',
          `This will mark all existing and future payments from "${currentPaymentData.payer}" as ignored.`,
          true // isDanger
        );

        if (!confirmed) return;

        try {
          // TODO: Update Supabase
          // const { error } = await supabaseClient
          //   .from('payments')
          //   .update({ ignored: true })
          //   .eq('payer', currentPaymentData.payer);

          showNotification(`All payments from "${currentPaymentData.payer}" marked as ignored`, 'success');
          closePayerActionsPopup();
          // Refresh data
          loadData();
        } catch (error) {
          console.error('âŒ Error ignoring payments:', error);
          showNotification('Failed to ignore payments', 'error');
        }
      }

      function splitAliasList(value) {
        if (!value) return [];
        if (Array.isArray(value)) {
          return value.map(alias => alias.trim()).filter(Boolean);
        }
        const text = value.toString();
        const delimiter = text.includes('|||') ? '\\|\\|\\|' : ',';
        return text
          .split(new RegExp(delimiter, 'g'))
          .map(alias => alias.trim())
          .filter(Boolean);
      }

      function joinAliasList(list, existingRaw = '') {
        if (!list || list.length === 0) {
          return null;
        }
        const prefersPipes = existingRaw.includes('|||') || list.some(alias => alias.includes(','));
        return prefersPipes ? list.join('|||') : list.join(', ');
      }

      function formatPayerDisplayName(value = '') {
        if (!value) return '';
        const normalized = value
          .toString()
          .replace(/\s+/g, ' ')
          .trim()
          .toLowerCase();
        if (!normalized) return '';
        return normalized.replace(/\b([a-z])/g, (char) => char.toUpperCase());
      }

      function sanitizeAliasForStorage(value) {
        if (!value) return '';
        return value
          .toString()
          .replace(/&/g, ' and ')
          .replace(/[^A-Za-z0-9\s'-]/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      }

      function normalizeAliasKey(value) {
        return value
          ? value
              .toString()
              .trim()
              .toLowerCase()
              .replace(/[^a-z0-9\s]/gi, '')
              .replace(/\s+/g, ' ')
          : '';
      }

      function extractGroupLetter(groupName = '') {
        if (!groupName) return '';
        const trimmed = groupName.trim();
        if (!trimmed) return '';
        const match = trimmed.match(/([A-F])$/i);
        if (match) return match[1].toUpperCase();
        return trimmed.charAt(0).toUpperCase();
      }

      async function ensurePayerAliasLinked(studentId, payerName) {
        const aliasRaw = (payerName || '').trim();
        if (!studentId || !aliasRaw) return false;

        const normalizedAlias = normalizeAliasKey(aliasRaw);
        if (!normalizedAlias) return false;

        const sanitizedAlias = sanitizeAliasForStorage(aliasRaw);
        if (!sanitizedAlias) {
          console.warn('âš ï¸ Alias sanitized to empty, skipping alias save for', aliasRaw);
          return false;
        }

        const studentsMap = PaymentRecordsEngine?.state?.students;
        let studentRecord = null;
        if (studentsMap) {
          studentRecord = studentsMap.get(Number(studentId)) || studentsMap.get(studentId) || null;
        }

        let existingAliases = splitAliasList(studentRecord?.aliases);
        const hasAliasAlready = existingAliases.some(alias => normalizeAliasKey(alias) === normalizedAlias);

        if (hasAliasAlready) {
          if (PaymentRecordsEngine?.state?.aliasMap) {
            PaymentRecordsEngine.state.aliasMap.set(normalizedAlias, studentRecord?.id || studentId);
          }
          return false;
        }

        existingAliases = [...existingAliases, sanitizedAlias];
        const aliasPayload = joinAliasList(existingAliases, studentRecord?.aliases || '');

        const { data, error } = await supabaseClient
          .from('students')
          .update({ aliases: aliasPayload })
          .eq('id', studentId)
          .select();

        if (error) {
          throw error;
        }

        if (data && data[0]) {
          if (studentsMap) {
            studentsMap.set(data[0].id, { ...studentsMap.get(data[0].id), ...data[0] });
          }
          if (PaymentRecordsEngine?.state?.aliasMap) {
            PaymentRecordsEngine.state.aliasMap.set(normalizedAlias, data[0].id);
          }
          if (PaymentRecordsEngine?.state) {
            PaymentRecordsEngine.state.referenceCache = null;
          }
        }

        return true;
      }

      async function bulkAssignPayerPaymentsToStudent(studentId, payerName, studentName = '', groupName = '') {
        if (!studentId || !payerName) return 0;

        debugLog('ðŸ“¦ Bulk assigning all payments from:', payerName, 'to student:', studentId);

        const payload = {
          student_id: studentId,
          status: 'matched',
        };

        if (studentName) {
          payload.student_name = studentName;
        }

        if (groupName) {
          payload.derived_student_group = extractGroupLetter(groupName);
        }

        const updatedIds = new Set();

        // Update all payments where payer_name matches (exact match)
        const updateAndTrack = async (column) => {
          const { data, error } = await supabaseClient
            .from('payments')
            .update(payload)
            .eq(column, payerName) // Exact match
            .select('id');

          if (error) {
            console.error(`âŒ Error updating ${column}:`, error);
            throw error;
          }

          if (Array.isArray(data)) {
            debugLog(`âœ… Updated ${data.length} payments via ${column}`);
            data.forEach(row => updatedIds.add(row.id));
          }
        };

        // Update payments by payer_name column only
        try {
          await updateAndTrack('payer_name');
        } catch (err) {
          console.error('âŒ Error updating payer_name column:', err);
          throw err; // Re-throw to indicate failure
        }

        debugLog(`âœ… Total unique payments updated: ${updatedIds.size}`);
        return updatedIds.size;
      }

      async function linkPaymentToStudent() {
        debugLog('ðŸ”— Link to Student button clicked!');
        
        // Use currentPaymentRecord (from details panel) or currentPaymentData (from payer popup)
        const payment = currentPaymentRecord || currentPaymentData;
        
        if (!payment) {
          console.error('âŒ No payment data found');
          showNotification('No payment data selected', 'error');
          return;
        }

        debugLog('âœ… Current payment data:', payment);

        // Get the payment ID from the record structure
        const paymentId = payment.id || payment.paymentId || payment.gmailId;
        if (!paymentId) {
          console.error('âŒ No payment ID found in:', currentPaymentData);
          showNotification('Payment ID not found', 'error');
          debugLog('âŒ No payment ID in currentPaymentData:', currentPaymentData);
          return;
        }

        debugLog('ðŸ’¾ Using payment ID:', paymentId);

        // Load students from Supabase
        debugLog('ðŸ“š Loading students from Supabase...');
        const { data: students, error: studentsError } = await supabaseClient
          .from('students')
          .select('id, name, group_name')
          .order('name', { ascending: true });

        if (studentsError) {
          console.error('âŒ Error loading students:', studentsError);
          showNotification('Error loading students: ' + studentsError.message, 'error');
          return;
        }
        
        if (!students || students.length === 0) {
          console.warn('âš ï¸ No students found in database');
          showNotification('No students found', 'error');
          return;
        }
        
        debugLog(`âœ… Loaded ${students.length} students`);

  // Get payer and amount info
  const payerRaw = payment.payerNameRaw || payment.payerRaw || payment.payerName || payment.payer || 'Unknown';
  const payerName = formatPayerDisplayName(payerRaw) || payerRaw || 'Unknown';
  const amount = payment.amountUSD || payment.amount || 0;

        // Show searchable student selector modal
        const overlay = document.getElementById('customAlertOverlay');
        if (!overlay.dataset.defaultContent) {
          overlay.dataset.defaultContent = overlay.innerHTML;
        }
        overlay.innerHTML = `
          <div class="custom-alert-modal link-student-modal">
            <div class="custom-alert-title">ðŸ”— Link payment to student</div>
            <div class="link-summary-box">
              <div style="margin-bottom: 6px;"><strong>Payer:</strong> ${payerName}</div>
              <div><strong>Amount:</strong> ${Math.round(amount)} $</div>
            </div>
            <div style="position: relative; display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <input type="text" id="studentSearchInput" class="student-search-input" placeholder="ðŸ” Search by name or 'Group A'..." style="flex: 1; padding-right: 36px;">
              <button class="search-clear-btn" id="studentSearchClear" onclick="clearStudentSearch()" title="Clear search" style="position: absolute; right: 8px;">âœ•</button>
            </div>
            <div id="studentsList" class="students-list"></div>
            <div class="custom-alert-buttons" style="justify-content: flex-end; margin-top: 16px; gap: 12px;">
              <button id="customAlertOk" class="custom-alert-btn ok" style="display: none;">OK</button>
              <button id="customAlertCancel" class="custom-alert-btn custom-alert-btn-secondary" onclick="closeCustomAlert()">Cancel</button>
            </div>
          </div>
        `;
        overlay.classList.add('active');

        let selectedStudentId = null;

        // Render filtered student list
        const renderStudents = (filter = '') => {
          const studentsList = document.getElementById('studentsList');
          const filterLower = filter.toLowerCase();
          const filtered = students.filter(s => {
            const name = (s.name || '').toLowerCase();
            const group = (s.group_name || '').toLowerCase();
            const groupLetter = extractGroupLetter(s.group_name);
            
            // Always match by name
            if (name.includes(filterLower)) return true;
            
            // Only match by group if search contains "group"
            if (filterLower.includes('group')) {
              return group.includes(filterLower) || 
                     (groupLetter && `group ${groupLetter}`.toLowerCase().includes(filterLower));
            }
            
            return false;
          });

          if (filtered.length === 0) {
            studentsList.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No students found</div>';
            return;
          }

          studentsList.innerHTML = filtered.map(s => `
            <div class="student-select-item" data-student-id="${s.id}">
              <div style="font-weight: 600; margin-bottom: 4px;">${s.name}</div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.6);">ðŸ“š Group: ${s.group_name || 'No group'}</div>
            </div>
          `).join('');

          // Add click handlers
          document.querySelectorAll('.student-select-item').forEach(item => {
            item.onclick = async () => {
              debugLog('ðŸ–±ï¸ Student item clicked!');
              selectedStudentId = item.dataset.studentId;
              const studentName = item.querySelector('div').textContent;
              const studentRecord = students.find(s => String(s.id) === String(selectedStudentId)) || null;
              const studentDisplayName = studentRecord?.name || studentName;
              
              debugLog('ðŸ“‹ Selected student:', {
                id: selectedStudentId,
                name: studentDisplayName,
                payerName: payerName
              });
              
              // Disable clicking while processing
              item.style.pointerEvents = 'none';
              item.style.opacity = '0.5';
              
              try {
                debugLog('ðŸ”— Starting bulk assignment...');
                debugLog('ðŸ”— Updating ALL payments from payer:', payerName, 'to student:', selectedStudentId);
                
                // Bulk assign ALL payments from this payer to the student
                const bulkUpdated = await bulkAssignPayerPaymentsToStudent(
                  selectedStudentId,
                  payerRaw,
                  studentRecord?.name || '',
                  studentRecord?.group_name || ''
                );

                debugLog('âœ… Bulk assignment complete. Updated:', bulkUpdated, 'payments');

                // Also ensure the payer alias is linked
                await ensurePayerAliasLinked(selectedStudentId, payerRaw);

                const totalLinked = bulkUpdated || 1;
                debugLog('âœ… Total linked:', totalLinked);
                
                showNotification(
                  `âœ… Linked ${totalLinked} payment${totalLinked === 1 ? '' : 's'} from ${payerName} to ${studentDisplayName}`,
                  'success'
                );
                
                debugLog('ðŸ”„ Closing popups and reloading data...');
                closePayerActionsPopup();
                closeCustomAlert();
                
                await loadData(true);
                debugLog('âœ… Data reload complete!');
                
              } catch (error) {
                console.error('âŒ Error linking payment:', error);
                showNotification('Failed to link payment: ' + error.message, 'error');
                item.style.pointerEvents = 'auto';
                item.style.opacity = '1';
              }
            };
          });
        };

        // Initial render
        renderStudents();

        // Search filter
        const studentSearchInput = document.getElementById('studentSearchInput');
        const studentClearBtn = document.getElementById('studentSearchClear');
        
        studentSearchInput.oninput = (e) => {
          renderStudents(e.target.value);
          // Show/hide clear button
          if (studentClearBtn) {
            studentClearBtn.classList.toggle('visible', e.target.value.length > 0);
          }
        };

        // Focus search input
        setTimeout(() => studentSearchInput?.focus(), 100);
      }

      /**
       * Clears the student search input in the modal
       */
      function clearStudentSearch() {
        const searchInput = document.getElementById('studentSearchInput');
        const clearBtn = document.getElementById('studentSearchClear');
        
        if (searchInput) {
          searchInput.value = '';
          searchInput.focus();
          // Trigger the input event to re-render the list
          searchInput.dispatchEvent(new Event('input'));
        }
        
        if (clearBtn) {
          clearBtn.classList.remove('visible');
        }
      }

      function closeCustomAlert() {
        const overlay = document.getElementById('customAlertOverlay');
        if (!overlay) return;
        overlay.classList.remove('active');
        setTimeout(() => {
          overlay.innerHTML = overlay.dataset.defaultContent || overlay.innerHTML;
        }, 250);
      }

      // ============================================================
      // SYNC MODAL FUNCTIONALITY
      // ============================================================

      let datePickerState = {
        currentMonth: new Date(),
        fromDate: null,
        toDate: null,
        selectingEnd: false
      };

      function openSyncModal() {
        const modal = document.getElementById('syncModal');
        const overlay = document.getElementById('syncModalOverlay');

        // Reset state
        datePickerState.fromDate = null;
        datePickerState.toDate = null;
        datePickerState.selectingEnd = false;
        datePickerState.currentMonth = new Date();

        // Show modal
        overlay.style.display = 'block';
        modal.style.display = 'block';
        setTimeout(() => {
          overlay.classList.add('show');
          modal.classList.add('show');
        }, 10);

        // Render calendar
        renderDateRangePicker();
      }

      function closeSyncModal() {
        const modal = document.getElementById('syncModal');
        const overlay = document.getElementById('syncModalOverlay');

        overlay.classList.remove('show');
        modal.classList.remove('show');

        setTimeout(() => {
          overlay.style.display = 'none';
          modal.style.display = 'none';
        }, 300);
      }

      function renderDateRangePicker() {
        const container = document.getElementById('dateRangePicker');
        if (!container) return;

        const currentMonth = datePickerState.currentMonth;
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const today = new Date();

        // Get first and last day of month
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

        const weekdayLabels = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];

        let html = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <button onclick="changeMonth(-1)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(138,180,255,0.3); border-radius: 6px; padding: 6px 12px; color: white; cursor: pointer; font-size: 14px;">
              â—€
            </button>
            <div style="font-weight: 700; font-size: 14px; color: #8ab4ff;">
              ${monthNames[month]} ${year}
            </div>
            <button onclick="changeMonth(1)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(138,180,255,0.3); border-radius: 6px; padding: 6px 12px; color: white; cursor: pointer; font-size: 14px;">
              â–¶
            </button>
          </div>

          <div class="date-picker-weekdays">
            ${weekdayLabels.map(label => `<div class="date-picker-weekday">${label}</div>`).join('')}
          </div>

          <div class="date-picker-grid">
        `;

        // Empty cells before month starts
        for (let i = 0; i < startingDayOfWeek; i++) {
          html += '<div class="date-picker-day is-placeholder"></div>';
        }

        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const dateStr = formatDateForComparison(date);
          const isToday = formatDateForComparison(today) === dateStr;
          const isFromDate = datePickerState.fromDate && formatDateForComparison(datePickerState.fromDate) === dateStr;
          const isToDate = datePickerState.toDate && formatDateForComparison(datePickerState.toDate) === dateStr;
          const isInRange = datePickerState.fromDate && datePickerState.toDate &&
                           date >= datePickerState.fromDate && date <= datePickerState.toDate;

          const classes = ['date-picker-day'];
          if (isFromDate || isToDate) classes.push('is-selected');
          if (isInRange) classes.push('is-range');
          if (isToday) classes.push('is-today');

          html += `
            <button
              type="button"
              class="${classes.join(' ')}"
              onclick="selectDate(new Date(${year}, ${month}, ${day}))"
              aria-label="${monthNames[month]} ${day}, ${year}"
            >
              ${day}
            </button>
          `;
        }

        const totalCells = startingDayOfWeek + daysInMonth;
        const trailingPlaceholders = (7 - (totalCells % 7)) % 7;
        for (let i = 0; i < trailingPlaceholders; i++) {
          html += '<div class="date-picker-day is-placeholder"></div>';
        }

        html += '</div>';
        container.innerHTML = html;

        // Update selected date displays
        updateDateDisplay();
      }

      function formatDateForComparison(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function formatDateForDisplay(date) {
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                           'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${monthNames[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
      }

      function selectDate(date) {
        if (!datePickerState.selectingEnd) {
          // First click - select FROM date
          datePickerState.fromDate = date;
          datePickerState.toDate = null;
          datePickerState.selectingEnd = true;
          debugLog('ðŸ“… Selected FROM date:', formatDateForDisplay(date));
        } else {
          // Second click - select TO date
          if (date < datePickerState.fromDate) {
            // If TO is before FROM, swap them
            datePickerState.toDate = datePickerState.fromDate;
            datePickerState.fromDate = date;
          } else {
            datePickerState.toDate = date;
          }
          datePickerState.selectingEnd = false;
          debugLog('ðŸ“… Selected TO date:', formatDateForDisplay(date));
        }

        renderDateRangePicker();
      }

      function updateDateDisplay() {
        const fromDisplay = document.getElementById('selectedFromDate');
        const toDisplay = document.getElementById('selectedToDate');

        if (fromDisplay) {
          fromDisplay.textContent = datePickerState.fromDate
            ? formatDateForDisplay(datePickerState.fromDate)
            : '-';
        }

        if (toDisplay) {
          toDisplay.textContent = datePickerState.toDate
            ? formatDateForDisplay(datePickerState.toDate)
            : '-';
        }
      }

      function changeMonth(direction) {
        const newMonth = new Date(datePickerState.currentMonth);
        newMonth.setMonth(newMonth.getMonth() + direction);
        datePickerState.currentMonth = newMonth;
        renderDateRangePicker();
      }

      async function startDateRangeSync() {
  debugLog('ðŸ”„ startDateRangeSync called');

        if (isSyncing) {
          debugLog('âš ï¸ Sync already in progress, skipping...');
          return;
        }

        if (!datePickerState.fromDate || !datePickerState.toDate) {
          console.warn('âš ï¸ Missing date selection:', { from: datePickerState.fromDate, to: datePickerState.toDate });
          showNotification('âš ï¸ Please select both FROM and TO dates', 'warning');
          return;
        }

  debugLog('ðŸ“… Date range:', {
          from: datePickerState.fromDate,
          to: datePickerState.toDate
        });

        const isValid = await ensureGmailTokenValid();
  debugLog('ðŸ”‘ Token valid:', isValid, 'Access token:', gmailAccessToken ? 'EXISTS' : 'MISSING');

        if (!isValid || !gmailAccessToken) {
          showNotification('âš ï¸ Please connect Gmail first', 'warning');
          closeSyncModal();
          return;
        }

        isSyncing = true; // Set sync flag

        const fromDate = formatDateForComparison(datePickerState.fromDate);
        const toDate = formatDateForComparison(datePickerState.toDate);

        // Format dates for Gmail API (YYYY/MM/DD)
        const fromDateStr = datePickerState.fromDate.toISOString().split('T')[0].replace(/-/g, '/');
        const toDateStr = datePickerState.toDate.toISOString().split('T')[0].replace(/-/g, '/');

        closeSyncModal();

        // Add syncing animation
        const syncBtn = document.getElementById('syncBtn');
        if (syncBtn) {
          syncBtn.classList.add('syncing');
          syncBtn.querySelector('span').textContent = 'Syncing...';
        }

        showNotification(`ðŸ” Syncing payments from ${formatDateForDisplay(datePickerState.fromDate)} to ${formatDateForDisplay(datePickerState.toDate)}...`, 'info');

        try {
          const query = `from:alerts@notify.wellsfargo.com after:${fromDateStr} before:${toDateStr}`;
          debugLog('ðŸ” Gmail query:', query);

          // Fetch ALL messages using pagination (no maxResults limit)
          let allMessages = [];
          let pageToken = null;
          let pageCount = 0;

          do {
            pageCount++;
            const searchUrl = `https://gmail.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent(query)}${pageToken ? `&pageToken=${pageToken}` : ''}`;

            debugLog(`ðŸ“¡ Fetching page ${pageCount} from Gmail API...`);
            const searchResponse = await fetch(searchUrl, {
              headers: { 'Authorization': `Bearer ${gmailAccessToken}` }
            });

            debugLog('ðŸ“¡ Response status:', searchResponse.status);

            if (!searchResponse.ok) {
              if (searchResponse.status === 401) {
                console.error('âŒ 401 Unauthorized - Token expired');
                clearGmailConnection();
                updateGmailButtonState(false);
                showNotification('ðŸ”’ Gmail session expired. Please reconnect.', 'error');
                // Remove syncing animation
                if (syncBtn) {
                  syncBtn.classList.remove('syncing');
                  syncBtn.querySelector('span').textContent = 'Sync';
                }
                return;
              }
              throw new Error(`Gmail API error: ${searchResponse.status}`);
            }

            const searchData = await searchResponse.json();
            
            if (searchData.messages && searchData.messages.length > 0) {
              allMessages = allMessages.concat(searchData.messages);
              debugLog(`ðŸ“§ Page ${pageCount}: Found ${searchData.messages.length} messages (Total: ${allMessages.length})`);
            }

            pageToken = searchData.nextPageToken;
          } while (pageToken);

          debugLog(`âœ… Fetched all ${allMessages.length} messages across ${pageCount} pages`);

          if (allMessages.length === 0) {
            debugLog('ðŸ“­ No messages found');
            showNotification('ðŸ“­ No payment emails found in the selected date range', 'info');
            // Remove syncing animation
            if (syncBtn) {
              syncBtn.classList.remove('syncing');
              syncBtn.querySelector('span').textContent = 'Sync';
            }
            return;
          }

          debugLog(`ðŸ“§ Found ${allMessages.length} messages, parsing...`);
          const { payments, filtered } = await fetchAndParseGmailMessages(allMessages, {
            onProgress: (current, total) => {
              if (syncBtn) {
                syncBtn.querySelector('span').textContent = `Sync - ${current}/${total}`;
              }
            },
            progressLabel: 'Date range sync'
          });

          debugLog(`âœ… Parsing complete: ${payments.length} payments, ${filtered} filtered out`);

          if (payments.length > 0) {
            debugLog(`âœ… Parsed ${payments.length} payments:`, payments);
            showNotification(`âœ… Found ${payments.length} payment${payments.length > 1 ? 's' : ''} from ${fromDate} to ${toDate}!`, 'success');

            renderPayments(payments);

            const { data, error } = await savePaymentsToSupabase(payments, 'Manual Sync - Date Range');
            if (error) {
              showNotification('âŒ Failed to save synced payments to Supabase. See console for details.', 'error');
            } else {
              showNotification(`ðŸ’¾ Saved ${data.length} payment${data.length !== 1 ? 's' : ''} to Supabase`, 'success');
              await PaymentRecordsEngine.load(true);
            }
          } else {
            showNotification('âœ… No new payments found in the selected date range', 'info');
          }
        } catch (error) {
          console.error('Error syncing payments:', error);
          showNotification('âŒ Error: ' + error.message, 'error');
        } finally {
          isSyncing = false; // Clear sync flag

          // Remove syncing animation
          const syncBtn = document.getElementById('syncBtn');
          if (syncBtn) {
            syncBtn.classList.remove('syncing');
            syncBtn.querySelector('span').textContent = 'Sync';
          }
        }
      }

      // Close sync modal when clicking overlay
      document.addEventListener('click', (e) => {
        const overlay = document.getElementById('syncModalOverlay');
        if (e.target === overlay) {
          closeSyncModal();
        }
      });

      // ============================================================
      // AUTO-REFRESH FUNCTIONALITY
      // ============================================================
      const AUTO_REFRESH_INTERVAL = 60 * 1000; // 60 seconds
      const AUTO_REFRESH_SECONDS = Math.round(AUTO_REFRESH_INTERVAL / 1000);
      // Default to OFF - user must explicitly enable
      let autoRefreshEnabled = localStorage.getItem('paymentEmailAutoRefresh') === 'true';
      let autoRefreshInterval = null;
      let countdownInterval = null;
      let autoRefreshInFlight = false;
      let isSyncing = false; // Flag to prevent concurrent syncs
      let autoRefreshPausedByVisibility = false;

      function setAutoRefreshButtonLabel(text) {
        const toggleBtn = document.getElementById('autoRefreshToggle');
        if (toggleBtn) {
          toggleBtn.textContent = text;
        }
      }

      function updateCountdown(secondsLeft) {
        if (autoRefreshEnabled) {
          setAutoRefreshButtonLabel(`${secondsLeft}s`);
        }
      }

      function startCountdown() {
        stopCountdown();
        let secondsLeft = AUTO_REFRESH_SECONDS;
        updateCountdown(secondsLeft);

        countdownInterval = setInterval(() => {
          secondsLeft--;
          if (secondsLeft <= 0) {
            secondsLeft = AUTO_REFRESH_SECONDS;
          }
          updateCountdown(secondsLeft);
        }, 1000);
      }

      function stopCountdown(options = {}) {
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
        const fallbackLabel = options.label || `${AUTO_REFRESH_SECONDS}s`;
        setAutoRefreshButtonLabel(fallbackLabel);
      }

      function toggleAutoRefresh() {
        autoRefreshEnabled = !autoRefreshEnabled;
        localStorage.setItem('paymentEmailAutoRefresh', autoRefreshEnabled.toString());

        const toggleBtn = document.getElementById('autoRefreshToggle');
        if (!toggleBtn) {
          console.error('autoRefreshToggle button not found');
          return;
        }

        if (autoRefreshEnabled) {
          toggleBtn.classList.add('active');
          toggleBtn.title = 'Auto-refresh ON (every 60s) - Click to disable';
          const started = startAutoRefresh();
          if (started) {
            startCountdown();
          } else {
            stopCountdown({ label: 'Paused' });
          }
          showNotification('âœ… Auto-refresh enabled (every 60 seconds)', 'success');
          debugLog('âœ… Auto-refresh ENABLED - will sync every 60 seconds');
        } else {
          toggleBtn.classList.remove('active');
          toggleBtn.title = 'Auto-refresh OFF - Click to enable';
          stopAutoRefresh();
          stopCountdown();
          showNotification('â¸ï¸ Auto-refresh disabled', 'info');
          debugLog('â¸ï¸ Auto-refresh DISABLED');
        }
      }

      async function runAutoRefreshCycle() {
        if (document.hidden) {
          debugLog('â¸ï¸ Skipping auto-refresh while tab is hidden.');
          return;
        }
        if (isSyncing || autoRefreshInFlight) {
          console.log('â­ï¸ Skipping auto-refresh - another sync in progress');
          debugLog('â­ï¸ Skipping auto-refresh - another sync in progress');
          return;
        }
        autoRefreshInFlight = true;
        try {
          // console.log('ðŸ”„ Auto-refreshing payments...');
          debugLog('ðŸ”„ Auto-refreshing payments...');
          await fetchPaymentsFromGmail({ silent: true });
        } finally {
          autoRefreshInFlight = false;
        }
      }

      function startAutoRefresh(options = {}) {
        const { skipImmediate = false } = options;
        // console.log('ðŸš€ startAutoRefresh() called');
        stopAutoRefresh();

        if (document.hidden) {
          autoRefreshPausedByVisibility = true;
          debugLog('ðŸ›‘ Tab hidden - deferring auto-refresh until visible');
          stopCountdown({ label: 'Paused' });
          return false;
        }

        autoRefreshPausedByVisibility = false;
        // console.log(`ðŸ”„ Setting up auto-refresh interval (${AUTO_REFRESH_SECONDS}s)...`);

        if (!skipImmediate) {
          // console.log('âš¡ Running immediate initial fetch...');
          runAutoRefreshCycle().then(() => {
            // console.log('âœ… Initial fetch complete');
          }).catch(err => {
            console.error('âŒ Initial fetch failed:', err);
          });
        }

        autoRefreshInterval = setInterval(runAutoRefreshCycle, AUTO_REFRESH_INTERVAL);
        // console.log('âœ… Auto-refresh interval started! Interval ID:', autoRefreshInterval);
        return true;
      }

      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
      }

      function handleVisibilityChange() {
        if (!autoRefreshEnabled) return;
        if (document.hidden) {
          autoRefreshPausedByVisibility = true;
          stopAutoRefresh();
          stopCountdown({ label: 'Paused' });
          debugLog('ðŸ›‘ Auto-refresh paused while tab hidden');
        } else if (autoRefreshPausedByVisibility) {
          debugLog('â–¶ï¸ Resuming auto-refresh after tab became visible');
          const started = startAutoRefresh({ skipImmediate: false });
          if (started) {
            startCountdown();
          }
        }
      }

      document.addEventListener('visibilitychange', handleVisibilityChange);

      // ============================================================
      // PAYMENT TOTALS BLUR PRIVACY
      // ============================================================
      /**
       * Initializes blur effect on USD and AMD payment totals for privacy.
       * Clicking on blurred values removes blur until page refresh.
       */
      function initializePaymentTotalsBlur() {
        const usdElement = document.getElementById('monthTotalUSD');
        const amdElement = document.getElementById('monthTotalAMD');

        if (!usdElement || !amdElement) return;

        // Apply blur on page load
        usdElement.classList.add('stat-value-blurred');
        amdElement.classList.add('stat-value-blurred');

        // Remove blur on click (persists until page refresh)
        const removeBlur = (element) => {
          element.classList.remove('stat-value-blurred');
          element.style.cursor = 'default';
        };

        usdElement.addEventListener('click', () => removeBlur(usdElement));
        amdElement.addEventListener('click', () => removeBlur(amdElement));
      }

      // ============================================================
      // EVENT LISTENERS
      // ============================================================
      function setupEventListeners() {
        // Close details panel
        document.getElementById('closeDetailsPanel').addEventListener('click', closeDetailsPanel);
        document.getElementById('detailsOverlay').addEventListener('click', closeDetailsPanel);
        document.getElementById('cancelDetailsBtn').addEventListener('click', closeDetailsPanel);

        // Navigation bar buttons
        setupNavigation();

        // Initialize blur effect for payment totals
        initializePaymentTotalsBlur();

        setupFilterToolbar();
        setupPaymentGridEvents();
        setupGridPaginationControls();
        
        // Setup PDF export button
        const exportBtn = document.getElementById('exportPdfBtn');
        if (exportBtn) {
          exportBtn.addEventListener('click', exportToPDF);
        }
      }

      function setupFilterToolbar() {
        const searchInput = document.getElementById('paymentsSearchInput');
        const clearBtn = document.getElementById('paymentsSearchClear');
        
        if (searchInput) {
          // âš¡ PERFORMANCE: 250ms debounce reduces CPU cycles on rapid typing
          const debouncedSearch = debounce((event) => {
            PaymentRecordsEngine.setSearchTerm(event.target.value.trim());
            // Show/hide clear button
            if (clearBtn) {
              clearBtn.classList.toggle('visible', event.target.value.length > 0);
            }
          }, 250);
          searchInput.addEventListener('input', debouncedSearch);
          
          // Initial state check
          if (clearBtn && searchInput.value.length > 0) {
            clearBtn.classList.add('visible');
          }
        }
      }

      /**
       * Clears the payments search input and updates the grid
       */
      function clearPaymentsSearch() {
        const searchInput = document.getElementById('paymentsSearchInput');
        const clearBtn = document.getElementById('paymentsSearchClear');
        
        if (searchInput) {
          searchInput.value = '';
          searchInput.focus();
          PaymentRecordsEngine.setSearchTerm('');
        }
        
        if (clearBtn) {
          clearBtn.classList.remove('visible');
        }
      }

      function setupPaymentGridEvents() {
        const grid = document.getElementById('paymentsGrid');
        if (!grid || grid.dataset.interactive === 'true') return;
        grid.dataset.interactive = 'true';

        grid.addEventListener('click', (event) => {
          const payerButton = event.target.closest('[data-role="payer-button"]');
          if (payerButton) {
            event.stopPropagation();
            openPayerActionsPopup(payerButton.dataset);
            return;
          }

          const card = event.target.closest('.payment-card');
          if (!card) return;
          const payment = PaymentRecordsEngine.state.paymentLookup.get(card.dataset.paymentKey);
          if (payment) {
            openDetailsPanel(payment);
          }
        });

        grid.addEventListener('keydown', (event) => {
          if (event.key !== 'Enter' && event.key !== ' ') return;
          const payerButton = event.target.closest('[data-role="payer-button"]');
          if (payerButton) {
            event.preventDefault();
            openPayerActionsPopup(payerButton.dataset);
          }
        });
      }

      function setupGridPaginationControls() {
        const loadMoreBtn = document.getElementById('gridLoadMoreBtn');
        if (!loadMoreBtn || loadMoreBtn.dataset.bound === 'true') return;
        loadMoreBtn.dataset.bound = 'true';

        loadMoreBtn.addEventListener('click', () => {
          if (loadMoreBtn.disabled || loadMoreBtn.dataset.loading === 'true') {
            return;
          }

          loadMoreBtn.dataset.loading = 'true';
          const originalLabel = loadMoreBtn.textContent;
          loadMoreBtn.textContent = 'Loadingâ€¦';

          const result = PaymentRecordsEngine.loadMoreRecords();

          requestAnimationFrame(() => {
            loadMoreBtn.textContent = originalLabel;
            loadMoreBtn.dataset.loading = 'false';
            if (!result?.hasMore) {
              loadMoreBtn.blur();
            }
          });
        });
      }

      // ============================================================
      // GMAIL CONTEXT MENU & TIMEZONE SETTINGS
      // ============================================================
      // Gmail timezone setup removed - now always uses LA timezone
      async function setupGmailContextMenu() {
        // Function removed - timezone is always LA now
      }

      // Update Gmail button glow - removed (no longer needed)
      async function updateGmailButtonGlow() {
        // Function removed
      }

      // Toggle LA offset - removed (no longer needed)
      async function setLAOffset(hours, isEnabled) {
        // Function removed
      }

      // Update toggle visual style - removed (no longer needed)
      function updateToggleStyle(toggle, isChecked) {
        // Function removed
      }

      // ============================================================
      // SQL HELP MODAL
      // ============================================================
      function openSQLHelpModal() {
        const modal = document.getElementById('sqlHelpModal');
        if (modal) {
          modal.style.display = 'block';
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
          debugLog('ðŸ“š SQL Help modal opened');
        }
      }

      function closeSQLHelpModal() {
        const modal = document.getElementById('sqlHelpModal');
        if (modal) {
          modal.style.display = 'none';
          document.body.style.overflow = ''; // Restore scrolling
          debugLog('âœ• SQL Help modal closed');
        }
      }

      async function copySQLQuery(button, query) {
        try {
          await navigator.clipboard.writeText(query);
          
          // Visual feedback
          const originalText = button.innerHTML;
          button.innerHTML = 'âœ“ Copied!';
          button.classList.add('copied');
          
          // Reset after 2 seconds
          setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('copied');
          }, 2000);
          
          debugLog('ðŸ“‹ SQL query copied to clipboard');
        } catch (err) {
          console.error('âŒ Failed to copy query:', err);
          
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = query;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          document.body.appendChild(textArea);
          textArea.select();
          
          try {
            document.execCommand('copy');
            button.innerHTML = 'âœ“ Copied!';
            button.classList.add('copied');
            setTimeout(() => {
              button.innerHTML = 'ðŸ“‹ Copy';
              button.classList.remove('copied');
            }, 2000);
          } catch (e) {
            console.error('âŒ Fallback copy failed:', e);
            button.innerHTML = 'âœ• Failed';
            setTimeout(() => {
              button.innerHTML = 'ðŸ“‹ Copy';
            }, 2000);
          }
          
          document.body.removeChild(textArea);
        }
      }

      // Close modal on backdrop click
      document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('sqlHelpModal');
        if (modal) {
          modal.addEventListener('click', (e) => {
            // Close if clicking the backdrop (not the content)
            if (e.target === modal) {
              closeSQLHelpModal();
            }
          });
        }
      });

      // ============================================================
      // NAVIGATION BAR
      // ============================================================
      function setupNavigation() {
        const nav = document.querySelector('.floating-nav');
        
        // Scroll to top
        document.getElementById('navTopBtn').addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Refresh data silently from floating nav
  const navRefreshBtn = document.getElementById('navRefreshBtn');
  if (!navRefreshBtn) return;

  navRefreshBtn.addEventListener('click', async () => {
          if (navRefreshBtn.classList.contains('refreshing')) {
            return;
          }

          navRefreshBtn.classList.add('refreshing');
          navRefreshBtn.setAttribute('aria-busy', 'true');

          try {
            // Fetch new Gmail payments without triggering global loaders
            await fetchPaymentsFromGmail({ silent: true });

            // Force-refresh cached data silently so the grid updates in place
            await loadData(true, { silent: true });
          } catch (error) {
            console.error('âŒ Floating nav refresh failed:', error);
            showNotification('Refresh failed. Please check the console for details.', 'error');
          } finally {
            navRefreshBtn.classList.remove('refreshing');
            navRefreshBtn.removeAttribute('aria-busy');
          }
        });

        // Scroll to top when clicking anywhere on collapsed nav
        nav.addEventListener('click', (e) => {
          if (!nav.classList.contains('expanded') && e.target === nav) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });
      }

      // ============================================================
      // NAVIGATION STORAGE HELPER (handles Private Browsing fallbacks)
      // ============================================================
      const navStorageHelper = (() => {
        const STORAGE_NAMES = ['localStorage', 'sessionStorage'];
        const TEST_KEY = '__arnoma_nav_storage_test__';
    let activeStorage = null;
    let activeName = null;
    let warningShown = false;
    let fallbackNoticeShown = false;
    let persistentStorageBlocked = false;

        const notifyUnavailable = (customMessage = null) => {
          if (warningShown) return;
          warningShown = true;
          const message = customMessage || 'Navbar changes can\'t be saved because browser storage is disabled (Private Browsing?).';
          console.warn(message);
          if (typeof showNotification === 'function') {
            showNotification(message, 'warning');
          }
        };

        const notifyFallback = () => {
          if (fallbackNoticeShown) return;
          fallbackNoticeShown = true;
          if (typeof showNotification === 'function') {
            showNotification('Navbar settings saved for this tab only (persistent storage blocked).', 'info');
          }
        };

        const getStorageByName = (name) => {
          try {
            return window[name];
          } catch (err) {
            return null;
          }
        };

        const tryActivate = (preferredNames = STORAGE_NAMES) => {
          for (const name of preferredNames) {
            const storage = getStorageByName(name);
            if (!storage) continue;
            try {
              storage.setItem(TEST_KEY, '1');
              storage.removeItem(TEST_KEY);
              activeStorage = storage;
              activeName = name;
              if (name === 'sessionStorage' && persistentStorageBlocked) {
                notifyFallback();
              }
              return true;
            } catch (err) {
              if (name === 'localStorage') {
                persistentStorageBlocked = true;
              }
              console.warn(`âš ï¸ ${name} unavailable for navbar persistence:`, err);
            }
          }
          activeStorage = null;
          activeName = null;
          return false;
        };

        const ensureStorage = () => {
          if (activeStorage) return true;
          if (tryActivate()) {
            return true;
          }
          notifyUnavailable();
          return false;
        };

        const attemptFallback = () => {
          const remaining = STORAGE_NAMES.filter(name => name !== activeName);
          if (!remaining.length) return false;
          if (tryActivate(remaining)) {
            notifyFallback();
            return true;
          }
          return false;
        };

        return {
          getItem(key) {
            if (!ensureStorage()) return null;
            try {
              return activeStorage.getItem(key);
            } catch (err) {
              console.error('âŒ Failed to read navbar setting:', err);
              return null;
            }
          },
          setItem(key, value) {
            if (!ensureStorage()) return false;
            try {
              activeStorage.setItem(key, value);
              return true;
            } catch (err) {
              console.warn(`âš ï¸ ${activeName || 'storage'} blocked navbar persistence:`, err);
              if (attemptFallback()) {
                try {
                  activeStorage.setItem(key, value);
                  return true;
                } catch (fallbackErr) {
                  console.error('âŒ Fallback storage also failed:', fallbackErr);
                }
              }
              notifyUnavailable();
              return false;
            }
          },
          removeItem(key) {
            if (!ensureStorage()) return;
            try {
              activeStorage.removeItem(key);
            } catch (err) {
              console.error('âŒ Failed to clear navbar setting:', err);
            }
          },
          getActiveBackend() {
            return activeName;
          },
          isAvailable() {
            return ensureStorage();
          }
        };
      })();

      // ============================================================
      // SUPABASE NAVBAR SETTINGS SYNC
      // ============================================================
      const navSupabaseSync = {
        async saveToSupabase(settings) {
          try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
              console.warn('âš ï¸ No session, skipping Supabase navbar sync');
              return false;
            }

            const { error } = await supabaseClient
              .from('user_preferences')
              .upsert({
                user_id: session.user.id,
                navbar_settings: settings,
                updated_at: new Date().toISOString()
              }, { onConflict: 'user_id' });

            if (error) {
              console.error('âŒ Failed to save navbar settings to Supabase:', error);
              return false;
            }

            debugLog('âœ… Navbar settings saved to Supabase');
            return true;
          } catch (err) {
            console.error('âŒ Error saving navbar settings to Supabase:', err);
            return false;
          }
        },

        async loadFromSupabase() {
          try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
              debugLog('âš ï¸ No session, using localStorage navbar settings');
              return null;
            }

            const { data, error } = await supabaseClient
              .from('user_preferences')
              .select('navbar_settings')
              .eq('user_id', session.user.id)
              .single();

            if (error) {
              if (error.code !== 'PGRST116') { // Not found is OK
                console.error('âŒ Failed to load navbar settings from Supabase:', error);
              }
              return null;
            }

            debugLog('âœ… Navbar settings loaded from Supabase');
            return data?.navbar_settings || null;
          } catch (err) {
            console.error('âŒ Error loading navbar settings from Supabase:', err);
            return null;
          }
        }
      };

      // ============================================================
      // NAVIGATION CONTEXT MENU & SETTINGS
      // ============================================================
      function setupNavContextMenu() {
        if (setupNavContextMenu.__initialized) {
          return;
        }
        setupNavContextMenu.__initialized = true;
        const nav = document.querySelector('.floating-nav');
        const contextMenu = document.getElementById('navContextMenu');
        const overlay = document.getElementById('navContextMenuOverlay');
        const sizeSlider = document.getElementById('navSizeSlider');
        const opacitySlider = document.getElementById('navOpacitySlider');
        const positionSlider = document.getElementById('navPositionSlider');
        const handleSizeSlider = document.getElementById('navHandleSizeSlider');
        const locationSelect = document.getElementById('navLocationSelect');
        const autoHideToggle = document.getElementById('navAutoHideToggle');
        const stayExpandedToggle = document.getElementById('navStayExpandedToggle');
        const lockButtonsToggle = document.getElementById('navLockButtonsToggle');
        const sizeValue = document.getElementById('sizeValue');
        const opacityValue = document.getElementById('opacityValue');
        const positionValue = document.getElementById('positionValue');
        const handleSizeValue = document.getElementById('handleSizeValue');
        const locationValue = document.getElementById('locationValue');

        if (!nav || !contextMenu || !overlay) {
          console.error('âŒ Nav context menu elements not found!');
          return;
        }

        debugLog('âš™ï¸ Setting up navbar context menu...');

        // Load saved settings from Supabase first, then localStorage
        async function loadNavbarSettings() {
          const supabaseSettings = await navSupabaseSync.loadFromSupabase();
          
          let savedSize, savedOpacity, savedPosition, savedHandleSize, savedLocation, savedAutoHide, savedStayExpanded, savedButtonsLocked;
          
          if (supabaseSettings) {
            // Use Supabase settings
            savedSize = supabaseSettings.btnSize || 40;
            savedOpacity = supabaseSettings.opacity || 1;
            savedPosition = supabaseSettings.position || 20;
            savedHandleSize = supabaseSettings.handleSize || 14;
            savedLocation = supabaseSettings.location || 'right-bottom';
            savedAutoHide = supabaseSettings.autoHide || false;
            savedStayExpanded = supabaseSettings.stayExpanded || false;
            savedButtonsLocked = supabaseSettings.buttonsLocked || false;
            
            // Also restore button order and module assignments
            if (supabaseSettings.buttonOrder) {
              navStorageHelper.setItem(NAV_ORDER_STORAGE_KEY, JSON.stringify(supabaseSettings.buttonOrder));
            }
            if (supabaseSettings.moduleAssignments) {
              navStorageHelper.setItem('navModuleAssignments', JSON.stringify(supabaseSettings.moduleAssignments));
            }
            
            debugLog('âœ… Loaded navbar settings from Supabase');
          } else {
            // Fall back to localStorage
            savedSize = Number(navStorageHelper.getItem('navBtnSize')) || 40;
            savedOpacity = Number(navStorageHelper.getItem('navOpacity')) || 1;
            savedPosition = Number(navStorageHelper.getItem('navPosition')) || 20;
            savedHandleSize = Number(navStorageHelper.getItem('navHandleSize')) || 14;
            savedLocation = navStorageHelper.getItem('navLocation') || 'right-bottom';
            const autoHideValue = navStorageHelper.getItem('navAutoHide');
            savedAutoHide = autoHideValue === null ? false : autoHideValue === 'true';
            savedStayExpanded = navStorageHelper.getItem('navStayExpanded') === 'true';
            savedButtonsLocked = navStorageHelper.getItem('navButtonsLocked') === 'true';
            debugLog('âœ… Loaded navbar settings from localStorage');
          }

          return { savedSize, savedOpacity, savedPosition, savedHandleSize, savedLocation, savedAutoHide, savedStayExpanded, savedButtonsLocked };
        }

        // Load settings asynchronously
        loadNavbarSettings().then(({ savedSize, savedOpacity, savedPosition, savedHandleSize, savedLocation, savedAutoHide, savedStayExpanded, savedButtonsLocked }) => {

        sizeSlider.value = savedSize;
        opacitySlider.value = savedOpacity;
        positionSlider.value = savedPosition;
        handleSizeSlider.value = savedHandleSize;
        locationSelect.value = savedLocation;
        autoHideToggle.checked = savedAutoHide;
        stayExpandedToggle.checked = savedStayExpanded;
        lockButtonsToggle.checked = savedButtonsLocked;

        const navState = {
          location: savedLocation,
          handleSize: Number(savedHandleSize),
          autoHide: savedAutoHide,
          stayExpanded: savedStayExpanded,
          expanded: !savedAutoHide || nav.classList.contains('expanded')
        };

        const computeCollapsedTransform = () => {
          const size = Number(navState.handleSize) || 16;
          switch (navState.location) {
            case 'right-bottom':
            case 'right-top':
              return `translateX(calc(100% - ${size}px))`;
            case 'left-bottom':
            case 'left-top':
              return `translateX(calc(-100% + ${size}px))`;
            case 'top-left':
            case 'top-right':
              return `translateY(calc(-100% + ${size}px))`;
            case 'bottom-left':
            case 'bottom-right':
              return `translateY(calc(100% - ${size}px))`;
            default:
              return 'translateX(0)';
          }
        };

        const updateNavTransform = (forceExpanded = null) => {
          if (typeof forceExpanded === 'boolean') {
            navState.expanded = forceExpanded;
          }

          if (!navState.autoHide) {
            navState.expanded = true;
          }

          if (navState.expanded) {
            nav.classList.add('expanded');
            nav.style.transform = 'translate(0, 0)';
            nav.style.opacity = '1';
          } else {
            nav.classList.remove('expanded');
            nav.style.transform = computeCollapsedTransform();
            nav.style.opacity = '0.92';
          }
        };

        const expandNav = () => updateNavTransform(true);
        const collapseNav = (force = false) => {
          if (!navState.autoHide) return;
          if (!force && navState.stayExpanded) return;
          updateNavTransform(false);
        };

        nav.__collapseNav = collapseNav;
        nav.__expandNav = expandNav;
        nav.__navState = navState;

        applyNavSettings(savedSize, savedOpacity, savedPosition, savedHandleSize, savedLocation, savedAutoHide, savedStayExpanded);

        // Apply lock state to buttons
        const allButtons = document.querySelectorAll('.nav-btn, .nav-btn-placeholder');
        allButtons.forEach(btn => {
          btn.draggable = !savedButtonsLocked;
        });

        // Right-click to open context menu - improved robustness
        const openContextMenu = (e) => {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();

          debugLog('âš™ï¸ Opening navbar settings...');

          // Force display first, then add show class for smooth transition
          overlay.style.display = 'block';
          contextMenu.style.display = 'block';

          // Use requestAnimationFrame to ensure display is applied before transition
          requestAnimationFrame(() => {
            overlay.classList.add('show');
            contextMenu.classList.add('show');
          });

          // Keep navbar expanded while settings menu is open
          if (nav.classList.contains('auto-hide')) {
            nav.classList.add('expanded');
          }
        };

        // Add contextmenu event listener to nav and all children
        nav.addEventListener('contextmenu', openContextMenu, true);
        
        // Also add to all nav buttons
        allButtons.forEach(btn => {
          btn.addEventListener('contextmenu', openContextMenu, true);
        });

        // Close context menu function
        const closeContextMenu = () => {
          contextMenu.classList.remove('show');
          overlay.classList.remove('show');

          // Wait for transition to finish before hiding
          setTimeout(() => {
            if (!contextMenu.classList.contains('show')) {
              contextMenu.style.display = 'none';
              overlay.style.display = 'none';
            }
          }, 200);
        };

        // Close on overlay click
        overlay.addEventListener('click', closeContextMenu);

        // Helper function to save settings to both localStorage and Supabase
        async function saveAllSettings() {
          const settings = {
            btnSize: Number(sizeSlider.value),
            opacity: Number(opacitySlider.value),
            position: Number(positionSlider.value),
            handleSize: Number(handleSizeSlider.value),
            location: locationSelect.value,
            autoHide: autoHideToggle.checked,
            stayExpanded: stayExpandedToggle.checked,
            buttonsLocked: lockButtonsToggle.checked,
            buttonOrder: JSON.parse(navStorageHelper.getItem(NAV_ORDER_STORAGE_KEY) || 'null'),
            moduleAssignments: JSON.parse(navStorageHelper.getItem('navModuleAssignments') || '{}')
          };
          
          // Save to Supabase (async, non-blocking)
          navSupabaseSync.saveToSupabase(settings);
        }

        // Close on outside click
        document.addEventListener('click', e => {
          if (!contextMenu.contains(e.target) && !nav.contains(e.target)) {
            closeContextMenu();
          }
        });

        // Close on Escape key
        document.addEventListener('keydown', e => {
          if (e.key === 'Escape' && contextMenu.classList.contains('show')) {
            closeContextMenu();
          }
        });

        // Size slider
        sizeSlider.addEventListener('input', e => {
          const size = e.target.value;
          sizeValue.textContent = `${size}px`;
          applyNavSettings(size, opacitySlider.value, positionSlider.value, handleSizeSlider.value, locationSelect.value, autoHideToggle.checked, stayExpandedToggle.checked);
          navStorageHelper.setItem('navBtnSize', size);
          saveAllSettings();
        });

        // Opacity slider
        opacitySlider.addEventListener('input', e => {
          const opacity = e.target.value;
          opacityValue.textContent = `${opacity}%`;
          applyNavSettings(sizeSlider.value, opacity, positionSlider.value, handleSizeSlider.value, locationSelect.value, autoHideToggle.checked, stayExpandedToggle.checked);
          navStorageHelper.setItem('navOpacity', opacity);
          saveAllSettings();
        });

        // Position slider
        positionSlider.addEventListener('input', e => {
          const position = e.target.value;
          positionValue.textContent = `${position}px`;
          applyNavSettings(sizeSlider.value, opacitySlider.value, position, handleSizeSlider.value, locationSelect.value, autoHideToggle.checked, stayExpandedToggle.checked);
          navStorageHelper.setItem('navPosition', position);
        });

        // Position slider
        positionSlider.addEventListener('input', e => {
          const position = e.target.value;
          positionValue.textContent = `${position}px`;
          applyNavSettings(sizeSlider.value, opacitySlider.value, position, handleSizeSlider.value, locationSelect.value, autoHideToggle.checked, stayExpandedToggle.checked);
          navStorageHelper.setItem('navPosition', position);
          saveAllSettings();
        });

        // Handle size slider
        handleSizeSlider.addEventListener('input', e => {
          const handleSize = e.target.value;
          handleSizeValue.textContent = `${handleSize}px`;
          applyNavSettings(sizeSlider.value, opacitySlider.value, positionSlider.value, handleSize, locationSelect.value, autoHideToggle.checked, stayExpandedToggle.checked);
          navStorageHelper.setItem('navHandleSize', handleSize);
          saveAllSettings();
        });

        // Location select
        locationSelect.addEventListener('change', e => {
          const location = e.target.value;
          const locationText = locationSelect.options[locationSelect.selectedIndex].text;
          locationValue.textContent = locationText;
          applyNavSettings(sizeSlider.value, opacitySlider.value, positionSlider.value, handleSizeSlider.value, location, autoHideToggle.checked, stayExpandedToggle.checked);
          navStorageHelper.setItem('navLocation', location);
          saveAllSettings();
        });

        // Auto-hide toggle
        autoHideToggle.addEventListener('change', e => {
          const autoHide = e.target.checked;
          applyNavSettings(sizeSlider.value, opacitySlider.value, positionSlider.value, handleSizeSlider.value, locationSelect.value, autoHide, stayExpandedToggle.checked);
          navStorageHelper.setItem('navAutoHide', autoHide);
          saveAllSettings();
        });

        // Stay expanded toggle
        stayExpandedToggle.addEventListener('change', e => {
          const stayExpanded = e.target.checked;
          applyNavSettings(sizeSlider.value, opacitySlider.value, positionSlider.value, handleSizeSlider.value, locationSelect.value, autoHideToggle.checked, stayExpanded);
          navStorageHelper.setItem('navStayExpanded', stayExpanded);
          saveAllSettings();
        });

        // Lock buttons toggle
        lockButtonsToggle.addEventListener('change', e => {
          const isLocked = e.target.checked;
          const allButtons = document.querySelectorAll('.nav-btn, .nav-btn-placeholder');

          allButtons.forEach(btn => {
            btn.draggable = !isLocked;
            // Visual feedback: change cursor
            btn.style.cursor = isLocked ? 'pointer' : 'move';
          });

          navStorageHelper.setItem('navButtonsLocked', isLocked);
          saveAllSettings();
        });

        // Add New Button handler
        const addNewNavButton = document.getElementById('addNewNavButton');
        if (addNewNavButton) {
          addNewNavButton.addEventListener('click', () => {
            alert('Add New Button feature coming soon! This will allow you to add custom navigation buttons.');
            // TODO: Implement module selection dialog
          });
        }

        // Navbar interaction handlers
        const navButtons = nav.querySelectorAll('.nav-btn');
        let collapseTimeout = null;

        // When auto-hide is enabled: expand on hover
        nav.addEventListener('mouseenter', () => {
          if (navState.autoHide) {
            if (collapseTimeout) {
              clearTimeout(collapseTimeout);
              collapseTimeout = null;
            }
            expandNav();
          }
        });

        // Collapse behavior on mouse leave
        nav.addEventListener('mouseleave', () => {
          if (contextMenu.classList.contains('show')) {
            return;
          }

          if (navState.autoHide) {
            collapseTimeout = setTimeout(() => collapseNav(false), 60);
          }
        });

        navButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            if (!navState.autoHide) return;
            if (contextMenu.classList.contains('show')) return;
            if (navState.stayExpanded) {
              collapseNav(true);
            }
          });
        });

        function applyNavSettings(size, opacity, position, handleSize, location, autoHide, stayExpanded) {
          sizeValue.textContent = `${size}px`;
          opacityValue.textContent = `${opacity}%`;
          positionValue.textContent = `${position}px`;
          handleSizeValue.textContent = `${handleSize}px`;

          document.documentElement.style.setProperty('--nav-btn-size', `${size}px`);
          document.documentElement.style.setProperty('--nav-opacity', opacity / 100);
          document.documentElement.style.setProperty('--nav-handle-size', `${handleSize}px`);

          // Apply location-based positioning
          // Reset all positioning
          nav.style.top = '';
          nav.style.right = '';
          nav.style.bottom = '';
          nav.style.left = '';
          nav.style.transform = '';
          nav.style.borderRadius = '';
          nav.style.flexDirection = '';

          // Apply based on location
          switch(location) {
            case 'right-bottom':
              nav.style.bottom = `${position}px`;
              nav.style.right = '0';
              nav.style.borderRadius = '20px 0 0 20px';
              nav.style.flexDirection = 'row';
              break;
            case 'right-top':
              nav.style.top = `${position}px`;
              nav.style.right = '0';
              nav.style.borderRadius = '20px 0 0 20px';
              nav.style.flexDirection = 'row';
              break;
            case 'left-bottom':
              nav.style.bottom = `${position}px`;
              nav.style.left = '0';
              nav.style.borderRadius = '0 20px 20px 0';
              nav.style.flexDirection = 'row-reverse';
              break;
            case 'left-top':
              nav.style.top = `${position}px`;
              nav.style.left = '0';
              nav.style.borderRadius = '0 20px 20px 0';
              nav.style.flexDirection = 'row-reverse';
              break;
            case 'top-left':
              nav.style.top = '0';
              nav.style.left = `${position}px`;
              nav.style.borderRadius = '0 0 20px 20px';
              nav.style.flexDirection = 'column';
              break;
            case 'top-right':
              nav.style.top = '0';
              nav.style.right = `${position}px`;
              nav.style.borderRadius = '0 0 20px 20px';
              nav.style.flexDirection = 'column';
              break;
            case 'bottom-left':
              nav.style.bottom = '0';
              nav.style.left = `${position}px`;
              nav.style.borderRadius = '20px 20px 0 0';
              nav.style.flexDirection = 'column-reverse';
              break;
            case 'bottom-right':
              nav.style.bottom = '0';
              nav.style.right = `${position}px`;
              nav.style.borderRadius = '20px 20px 0 0';
              nav.style.flexDirection = 'column-reverse';
              break;
          }

          navState.location = location;
          navState.handleSize = Number(handleSize);
          navState.autoHide = autoHide;
          navState.stayExpanded = stayExpanded;

          if (!navState.autoHide) {
            navState.expanded = true;
          }

          if (autoHide) {
            nav.classList.add('auto-hide');
          } else {
            nav.classList.remove('auto-hide');
          }

          updateNavTransform(navState.expanded);
        }

        debugLog('âœ… Navbar context menu setup complete');
        }); // Close the loadNavbarSettings().then()
      }

      // Add spin animation for refresh button
      const style = document.createElement('style');
      style.textContent = `
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `;
      document.head.appendChild(style);

      // ============================================================
      // MODULE ASSIGNMENT FOR PLACEHOLDER BUTTONS
      // ============================================================
      let currentAssignmentSlot = null;

      function setupModuleAssignment() {
        const modal = document.getElementById('moduleAssignmentModal');
        const moduleSelect = document.getElementById('moduleSelect');
        const moduleIcon = document.getElementById('moduleIcon');
        const assignBtn = document.getElementById('assignModuleBtn');
        const cancelBtn = document.getElementById('cancelAssignBtn');

        // Load saved assignments
        let savedAssignments = {};
        try {
          savedAssignments = JSON.parse(navStorageHelper.getItem('navModuleAssignments') || '{}') || {};
        } catch (err) {
          console.warn('âš ï¸ Failed to parse saved nav module assignments:', err);
          savedAssignments = {};
        }

        // Apply saved assignments
        Object.keys(savedAssignments).forEach(slot => {
          const assignment = savedAssignments[slot];
          updatePlaceholderButton(slot, assignment);
        });

        // Click handler for placeholder buttons
        document.querySelectorAll('.nav-btn-placeholder').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            currentAssignmentSlot = btn.dataset.slot;

            // Load current assignment if exists
            const current = savedAssignments[currentAssignmentSlot];
            if (current) {
              moduleSelect.value = current.module;
              moduleIcon.value = current.icon || '';
            } else {
              moduleSelect.value = '';
              moduleIcon.value = '';
            }

            modal.style.display = 'block';
            modal.classList.add('show');
          });
        });

        // Assign button
        assignBtn.addEventListener('click', async () => {
          const module = moduleSelect.value;
          const icon = moduleIcon.value.trim();

          if (!module) {
            await customAlert('âš ï¸ Missing Selection', 'Please select a module');
            return;
          }

          const assignment = { module, icon };
          savedAssignments[currentAssignmentSlot] = assignment;

          try {
            navStorageHelper.setItem('navModuleAssignments', JSON.stringify(savedAssignments));
            // Also save to Supabase
            saveAllSettings();
          } catch (err) {
            console.error('âŒ Failed to save nav module assignments:', err);
          }

          updatePlaceholderButton(currentAssignmentSlot, assignment);

          modal.style.display = 'none';
          modal.classList.remove('show');
        });

        // Cancel button
        cancelBtn.addEventListener('click', () => {
          modal.style.display = 'none';
          modal.classList.remove('show');
        });

        // Close on outside click
        document.addEventListener('click', (e) => {
          if (!modal.contains(e.target) && modal.classList.contains('show')) {
            modal.style.display = 'none';
            modal.classList.remove('show');
          }
        });
      }

      function updatePlaceholderButton(slot, assignment) {
        const btn = document.querySelector(`.nav-btn-placeholder[data-slot="${slot}"]`);
        if (!btn) return;

        const moduleNames = {
          'index': 'ðŸ ',
          'index.mobile': 'ðŸ“±',
          'email-system': 'âœ‰ï¸',
          'payment-records': 'ðŸ’³'
        };

        const moduleUrls = {
          'index': 'index.html',
          'index.mobile': 'index.mobile.html',
          'email-system': 'email-system-complete.html',
          'payment-records': 'payment-records-new.html'
        };

        // Update button appearance
        btn.innerHTML = assignment.icon || moduleNames[assignment.module] || 'ðŸ“„';
        btn.classList.remove('nav-btn-placeholder');
        btn.classList.add('nav-btn');
        btn.title = `Open ${assignment.module}`;
        btn.style.cursor = 'pointer';

        // Add click handler to open module
        btn.onclick = (e) => {
          e.stopPropagation();
          const url = moduleUrls[assignment.module];
          if (url) {
            window.open(url, '_blank');
          }
        };

        // Right-click to reassign
        btn.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          e.stopPropagation();
          currentAssignmentSlot = slot;

          let latestAssignments = {};
          try {
            latestAssignments = JSON.parse(navStorageHelper.getItem('navModuleAssignments') || '{}') || {};
          } catch (err) {
            console.warn('âš ï¸ Failed to load nav module assignments for context menu:', err);
            latestAssignments = {};
          }
          const current = latestAssignments[currentAssignmentSlot];

          document.getElementById('moduleSelect').value = current?.module || '';
          document.getElementById('moduleIcon').value = current?.icon || '';

          document.getElementById('moduleAssignmentModal').style.display = 'block';
          document.getElementById('moduleAssignmentModal').classList.add('show');
        });
      }

      // ============================================================
      // DRAG AND DROP FOR NAVBAR BUTTONS
      // ============================================================
      let isInitializing = true; // Flag to prevent saves during page load
      const NAV_ORDER_STORAGE_KEY = 'paymentRecordsNavButtonOrder.v1';

      function scheduleNavInitializationUnlock(delay = 5000) {
        setTimeout(() => {
          if (!isInitializing) return;
          isInitializing = false;
        }, delay);
      }
      
      function setupNavDragDrop() {
        const allButtons = document.querySelectorAll('.nav-btn, .nav-btn-placeholder, #navCountdownTimer');
        const topRow = document.querySelector('.nav-row-top');
        const mainRow = document.querySelector('.nav-row-main');
        let draggedElement = null;

        allButtons.forEach(btn => {
          // Make buttons draggable
          btn.setAttribute('draggable', 'true');

          if (btn.dataset.dragHandlers === 'true') {
            return;
          }
          btn.dataset.dragHandlers = 'true';

          btn.addEventListener('dragstart', (e) => {
            // PREVENT dragging during initialization
            if (isInitializing) {
              e.preventDefault();
              return false;
            }
            
            draggedElement = btn;
            btn.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', btn.innerHTML);
          });

          btn.addEventListener('dragend', () => {
            // Ignore dragend events during initialization
            if (isInitializing) {
              return;
            }
            
            btn.classList.remove('dragging');
            allButtons.forEach(b => b.classList.remove('drag-over'));
            topRow.classList.remove('drag-over');
            mainRow.classList.remove('drag-over');

            // Save button order
            saveNavButtonOrder();
          });

          btn.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            if (btn !== draggedElement) {
              btn.classList.add('drag-over');
            }
          });

          btn.addEventListener('dragleave', () => {
            btn.classList.remove('drag-over');
          });

          btn.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            btn.classList.remove('drag-over');

            if (btn !== draggedElement && draggedElement) {
              // Get target position
              const targetContainer = btn.parentElement;
              const targetIndex = Array.from(targetContainer.children).indexOf(btn);
              const draggedIndex = Array.from(targetContainer.children).indexOf(draggedElement);

              // Insert dragged element at target position
              if (targetIndex < draggedIndex) {
                targetContainer.insertBefore(draggedElement, btn);
              } else {
                targetContainer.insertBefore(draggedElement, btn.nextSibling);
              }
            }
          });
        });

        // Add drop zones to containers for cross-row dragging
        [topRow, mainRow].forEach(container => {
          container.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            container.classList.add('drag-over');
          });

          container.addEventListener('dragleave', (e) => {
            // Only remove if leaving container entirely
            if (!container.contains(e.relatedTarget)) {
              container.classList.remove('drag-over');
            }
          });

          container.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            container.classList.remove('drag-over');

            if (draggedElement && !container.contains(draggedElement)) {
              // Moving to different container - append to end
              container.appendChild(draggedElement);
            }
          });
        });
      }

      // Save navbar button order to localStorage
      function getNavButtonKey(btn) {
        if (!btn) return null;
        return btn.id || btn.dataset.slot || btn.dataset.assignment || null;
      }

      function saveNavButtonOrder() {
        const topRow = document.querySelector('.nav-row-top');
        const mainRow = document.querySelector('.nav-row-main');

        if (!topRow || !mainRow) {
          console.warn('âš ï¸ Cannot save navbar order - rows missing');
          return;
        }

        const order = {
          top: Array.from(topRow.children)
            .map(getNavButtonKey)
            .filter(Boolean),
          main: Array.from(mainRow.children)
            .map(getNavButtonKey)
            .filter(Boolean)
        };

        try {
          const persisted = navStorageHelper.setItem(NAV_ORDER_STORAGE_KEY, JSON.stringify(order));
          if (persisted) {
            console.log('ðŸ’¾ Nav button order saved:', order);
            // Also save to Supabase
            saveAllSettings();
          } else {
            console.warn('âš ï¸ Nav button order could not be saved (storage unavailable).');
          }
        } catch (e) {
          console.error('âŒ Failed to save nav button order:', e);
        }
      }

      // Load navbar button order from localStorage
      function loadNavButtonOrder() {
        // console.log('ðŸ”„ Loading navbar button order...');
        
        const topRow = document.querySelector('.nav-row-top');
        const mainRow = document.querySelector('.nav-row-main');

        if (!topRow || !mainRow) {
          // console.warn('âš ï¸ Nav rows not found - skipping saved order load');
          return;
        }

  const savedOrder = navStorageHelper.getItem(NAV_ORDER_STORAGE_KEY);
        // console.log('ðŸ“¦ Saved order from localStorage:', savedOrder);
        
        if (!savedOrder) {
          console.log('â„¹ï¸ No saved order found - using default layout');
          // No saved order - just setup drag and drop for existing buttons
          setupNavDragDrop();
          
          // Save the default order immediately so it persists
          setTimeout(() => {
            saveNavButtonOrder();
          }, 200);
          scheduleNavInitializationUnlock(2000);
          return;
        }

        try {
          const order = JSON.parse(savedOrder);
          // console.log('âœ… Parsed saved order:', order);

          const isLegacyFormat = Array.isArray(order.top) && order.top.length && typeof order.top[0] === 'object';
          if (isLegacyFormat) {
            // console.warn('âš ï¸ Legacy navbar order format detected - clearing saved data');
            navStorageHelper.removeItem(NAV_ORDER_STORAGE_KEY);
            setupNavDragDrop();
            return;
          }

          const buttonMap = new Map();
          const originalRows = new Map();

          const registerButtons = (nodes, rowName) => {
            Array.from(nodes).forEach(btn => {
              const key = getNavButtonKey(btn);
              if (!key) return;
              buttonMap.set(key, btn);
              if (!originalRows.has(key)) {
                originalRows.set(key, rowName);
              }
            });
          };

          registerButtons(topRow.children, 'top');
          registerButtons(mainRow.children, 'main');

          const usedKeys = new Set();
          let needsResave = false;

          const reorderRow = (rowEl, desiredKeys = []) => {
            if (!rowEl) return;
            
            const fragment = document.createDocumentFragment();
            
            // First, add buttons in the saved order
            desiredKeys.forEach(key => {
              if (!buttonMap.has(key)) {
                needsResave = true;
                return;
              }
              fragment.appendChild(buttonMap.get(key));
              usedKeys.add(key);
            });

            rowEl.innerHTML = '';
            rowEl.appendChild(fragment);
            
          };

          const desiredTopOrder = Array.isArray(order.top) ? order.top : [];
          const desiredMainOrder = Array.isArray(order.main) ? order.main : [];

          reorderRow(topRow, desiredTopOrder);
          reorderRow(mainRow, desiredMainOrder);

          // console.log('âœ¨ Nav buttons reordered successfully');

          // Append any buttons that weren't part of the saved order (new buttons, etc.)
          buttonMap.forEach((btn, key) => {
            if (usedKeys.has(key)) return;
            const targetRowName = originalRows.get(key) === 'top' ? 'top' : 'main';
            const targetRow = targetRowName === 'top' ? topRow : mainRow;
            targetRow.appendChild(btn);
            needsResave = true;
          });

          // Setup drag and drop for all buttons
          setupNavDragDrop();

          // Allow saves after initialization completes
          setTimeout(() => {
            scheduleNavInitializationUnlock();
            // console.log('ðŸ”“ Nav initialization complete - drag saves enabled');
          }, 50);

          if (needsResave) {
            setTimeout(() => {
              saveNavButtonOrder();
            }, 500);
          }

          // Note: We don't auto-save here because it can cause race conditions
          // New buttons will be saved when the user manually drags them
        } catch (e) {
          console.error('âŒ Error loading navbar button order:', e);
          navStorageHelper.removeItem(NAV_ORDER_STORAGE_KEY);
          // Fallback - setup drag and drop for existing buttons
          setupNavDragDrop();
          scheduleNavInitializationUnlock(2000);
        }
      }

      // Initialize module assignment
      setupModuleAssignment();

      // ============================================================
      // MONTH TOTALS UPDATE
      // ============================================================
      function updateMonthTotals() {
        PaymentRecordsEngine.updateMonthTotals();
      }

      function handleMonthSelectorChange() {
        if (typeof PaymentRecordsEngine !== 'undefined' && PaymentRecordsEngine.handleMonthSelectorChange) {
          PaymentRecordsEngine.handleMonthSelectorChange();
        }
      }

      // ============================================================
      // DETAILS PANEL
      // ============================================================
      let currentEditingStudent = null;
      let currentPaymentRecord = null;

      async function openDetailsPanel(payment) {
        if (!payment) return;
        
        currentPaymentRecord = payment;
        selectedPayment = payment;
        
        document.getElementById('detailsPanel').classList.add('active');
        document.getElementById('detailsOverlay').classList.add('active');

        // Populate payment information (read-only)
        document.getElementById('detailPaymentId').textContent = payment.paymentId || payment.id || payment.gmailId || 'â€”';
        document.getElementById('detailAmount').textContent = `${payment.amountUSDLabel || payment.amount + ' $'} (${payment.amountAMDLabel || 'â€”'})`;
        document.getElementById('detailMethod').textContent = payment.paymentMethod || 'unspecified';
        document.getElementById('detailDate').innerHTML = `${payment.dateLabel} â€¢ ${payment.timeLabel}`;
        document.getElementById('detailPayer').textContent = payment.payerName || 'â€”';

        // If there's a student linked, load full student data
        if (payment.studentId) {
          try {
            const { data: student, error } = await supabaseClient
              .from('students')
              .select('*')
              .eq('id', payment.studentId)
              .single();

            if (error) throw error;

            if (student) {
              currentEditingStudent = student;
              populateStudentFields(student);
              await loadCreditHistory(payment.studentId);
            } else {
              clearStudentFields();
            }
          } catch (error) {
            console.error('âŒ Error loading student data:', error);
            clearStudentFields();
          }
        } else {
          // No student linked - show empty fields
          currentEditingStudent = null;
          clearStudentFields();
        }

        // Setup button event listeners
        setupDetailsButtonListeners();
      }

      function populateStudentFields(student) {
        // Student information
        document.getElementById('detailStudentName').value = student.name || '';
        
        // Email - handle array or string
        const emailArray = Array.isArray(student.email) ? student.email : (student.email ? [student.email] : []);
        document.getElementById('detailEmail').value = emailArray.join('\n');
        
        // Phone - format if exists
        document.getElementById('detailPhone').value = formatPhone(student.phone || '');
        
        // Group buttons
        const groupLetter = student.group_name ? student.group_name.replace('Group ', '').trim() : '';
        document.querySelectorAll('.detail-group-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.group === groupLetter);
        });
        document.getElementById('detailGroupCustom').value = groupLetter && !['A', 'B', 'C', 'D', 'E', 'F'].includes(groupLetter) ? groupLetter : '';
        
        // Status
        document.getElementById('detailStatus').value = student.status || 'active';
        
        // Payment amount buttons - use price_per_class
        const price = parseInt(student.price_per_class || 0);
        document.querySelectorAll('.detail-amount-btn').forEach(btn => {
          btn.classList.toggle('active', parseInt(btn.dataset.amount) === price);
        });
        document.getElementById('detailPayCustom').value = price && ![25, 50, 75, 100].includes(price) ? price : '';
        
        // Credit balance - use balance field
        document.getElementById('detailCredit').value = student.balance || 0;
        
        // Aliases - handle comma or pipe-separated string
        const aliasesArray = student.aliases 
          ? student.aliases.split(/[,|]+/).map(a => a.trim()).filter(a => a)
          : [];
        document.getElementById('detailAliases').value = aliasesArray.join(', ');
        
        // Notes
        document.getElementById('detailNotes').value = student.notes || '';
        
        // Update save button text for existing student
        document.getElementById('saveDetailsBtn').innerHTML = 'ðŸ’¾ Save All Changes';
      }

      function clearStudentFields() {
        document.getElementById('detailStudentName').value = '';
        document.getElementById('detailEmail').value = '';
        document.getElementById('detailPhone').value = '';
        document.getElementById('detailGroupCustom').value = '';
        document.getElementById('detailStatus').value = 'active';
        document.getElementById('detailPayCustom').value = '';
        document.getElementById('detailCredit').value = 0;
        document.getElementById('detailAliases').value = '';
        document.getElementById('detailNotes').value = '';
        
        document.querySelectorAll('.detail-group-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.detail-amount-btn').forEach(btn => btn.classList.remove('active'));
        
        // Update save button text for new student
        document.getElementById('saveDetailsBtn').innerHTML = 'âž• Create New Student';
      }

      function setupDetailsButtonListeners() {
        // Group buttons
        document.querySelectorAll('.detail-group-btn').forEach(btn => {
          btn.onclick = () => {
            document.querySelectorAll('.detail-group-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('detailGroupCustom').value = '';
          };
        });

        // Custom group input
        document.getElementById('detailGroupCustom').oninput = () => {
          document.querySelectorAll('.detail-group-btn').forEach(b => b.classList.remove('active'));
        };

        // Amount buttons
        document.querySelectorAll('.detail-amount-btn').forEach(btn => {
          btn.onclick = () => {
            document.querySelectorAll('.detail-amount-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('detailPayCustom').value = '';
          };
        });

        // Custom amount input
        document.getElementById('detailPayCustom').oninput = () => {
          document.querySelectorAll('.detail-amount-btn').forEach(b => b.classList.remove('active'));
        };

        // Phone formatting
        document.getElementById('detailPhone').onblur = (e) => {
          e.target.value = formatPhone(e.target.value);
        };

        // Save button
        document.getElementById('saveDetailsBtn').onclick = saveStudentChanges;
        
        // Cancel button
        document.getElementById('cancelDetailsBtn').onclick = closeDetailsPanel;
      }

      function formatPhone(phone) {
        if (!phone) return '';
        const cleaned = phone.replace(/\D/g, '');
        if (cleaned.length === 10) {
          return `${cleaned.slice(0,3)}-${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
        }
        return phone;
      }

      async function saveStudentChanges() {
        try {
          // Get all form values
          const activeGroupBtn = document.querySelector('.detail-group-btn.active');
          const customGroup = document.getElementById('detailGroupCustom').value.trim();
          const groupLetter = customGroup || (activeGroupBtn ? activeGroupBtn.dataset.group : '');
          const groupName = groupLetter ? `Group ${groupLetter}` : '';

          // Get payment amount
          const activeAmountBtn = document.querySelector('.detail-amount-btn.active');
          const customAmount = document.getElementById('detailPayCustom').value.trim();
          const price = customAmount || (activeAmountBtn ? activeAmountBtn.dataset.amount : '0');

          // Parse emails (newline or comma separated)
          const emailInput = document.getElementById('detailEmail').value.trim();
          const emailsArray = emailInput
            .split(/[\n,]+/)
            .map(e => e.trim())
            .filter(e => e && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e));

          // Parse aliases (comma separated)
          const aliasesInput = document.getElementById('detailAliases').value.trim();
          const aliases = aliasesInput
            .split(',')
            .map(a => a.trim())
            .filter(a => a);

          const newName = document.getElementById('detailStudentName').value.trim();
          const newEmail = emailsArray.length > 0 ? emailsArray[0] : '';
          const newPhone = document.getElementById('detailPhone').value.trim();
          const newStatus = document.getElementById('detailStatus').value;
          const newPrice = parseInt(price) || 0;
          const newBalance = parseInt(document.getElementById('detailCredit').value) || 0;
          const newAliases = aliases.length > 0 ? aliases.join(', ') : null;
          const newNotes = document.getElementById('detailNotes').value.trim();

          // ========================================
          // CREATE NEW STUDENT
          // ========================================
          if (!currentEditingStudent || !currentEditingStudent.id) {
            // Validate required fields for new student
            if (!newName) {
              showNotification('âŒ Student name is required', 'error');
              return;
            }

            debugLog('âž• Creating new student:', newName);

            const newStudent = {
              name: newName,
              email: newEmail || null,
              phone: newPhone || null,
              group_name: groupName || null,
              status: newStatus || 'Active',
              price_per_class: newPrice,
              balance: newBalance,
              aliases: newAliases,
              notes: newNotes || null,
              show_in_grid: true // Default to visible
            };

            const { data, error } = await supabaseClient
              .from('students')
              .insert([newStudent])
              .select();

            if (error) {
              console.error('âŒ Error creating student:', error);
              throw error;
            }

            if (data && data[0]) {
              const createdStudent = data[0];
              debugLog('âœ… Student created successfully:', createdStudent);
              
              // Update current editing student
              currentEditingStudent = createdStudent;
              
              // If we have a current payment, link it to the new student
              if (currentPaymentRecord) {
                debugLog('ðŸ”— Linking payment to new student:', createdStudent.id);
                const { error: linkError } = await supabaseClient
                  .from('payments')
                  .update({ 
                    student_id: createdStudent.id,
                    linked_student_id: createdStudent.id,
                    student_name: createdStudent.name,
                    status: 'matched',
                    derived_student_group: groupLetter || null
                  })
                  .eq('id', currentPaymentRecord.id || currentPaymentRecord.gmailId);
                
                if (linkError) {
                  console.error('âš ï¸ Error linking payment to student:', linkError);
                } else {
                  debugLog('âœ… Payment linked to new student');
                }
              }
              
              showNotification('âœ… New student created successfully', 'success');
              
              // Refresh data and close panel
              await PaymentRecordsEngine.load(true);
              closeDetailsPanel();
            }

            return;
          }

          // ========================================
          // UPDATE EXISTING STUDENT
          // ========================================
          debugLog('ðŸ“ Updating existing student:', currentEditingStudent.id);

          // Build update object - only include fields that have changed
          const updates = {};
          
          if (newName && newName !== currentEditingStudent.name) {
            updates.name = newName;
          }

          if (newEmail !== (currentEditingStudent.email || '')) {
            updates.email = newEmail;
          }

          if (newPhone !== (currentEditingStudent.phone || '')) {
            updates.phone = newPhone;
          }

          if (groupName !== (currentEditingStudent.group_name || '')) {
            updates.group_name = groupName;
          }

          if (newStatus !== currentEditingStudent.status) {
            updates.status = newStatus;
          }

          if (newPrice !== parseInt(currentEditingStudent.price_per_class || 0)) {
            updates.price_per_class = newPrice;
          }

          if (newBalance !== parseInt(currentEditingStudent.balance || 0)) {
            updates.balance = newBalance;
          }

          if (newAliases !== (currentEditingStudent.aliases || null)) {
            updates.aliases = newAliases;
          }

          if (newNotes !== (currentEditingStudent.notes || '')) {
            updates.notes = newNotes;
          }

          // Only update if there are changes
          if (Object.keys(updates).length === 0) {
            showNotification('â„¹ï¸ No changes to save', 'info');
            closeDetailsPanel();
            return;
          }

          debugLog('ðŸ’¾ Saving student updates:', updates);
          debugLog('ðŸ“‹ Student ID:', currentEditingStudent.id);

          const { data, error } = await supabaseClient
            .from('students')
            .update(updates)
            .eq('id', currentEditingStudent.id)
            .select();

          if (error) {
            console.error('âŒ Supabase error details:', error);
            throw error;
          }

          debugLog('âœ… Save successful:', data);
          
          // If group changed, update all payment records for this student
          if (updates.group_name && currentEditingStudent.id) {
            debugLog('ðŸ“ Updating payment records with new group:', updates.group_name);
            try {
              // Extract just the letter from "Group A" format for derived_student_group
              const groupLetter = updates.group_name.replace('Group ', '').trim();
              
              const { error: paymentError } = await supabaseClient
                .from('payments')
                .update({ derived_student_group: groupLetter })
                .eq('student_id', currentEditingStudent.id);
              
              if (paymentError) {
                console.error('âš ï¸ Error updating payment groups:', paymentError);
              } else {
                debugLog('âœ… Payment records updated with group letter:', groupLetter);
              }
            } catch (err) {
              console.error('âš ï¸ Failed to update payment groups:', err);
            }
          }
          
          showNotification('âœ… Student information updated successfully', 'success');
          
          // Update the current editing student with new data
          if (data && data[0]) {
            currentEditingStudent = data[0];
            
            // CRITICAL: Update the cached student data in PaymentRecordsEngine immediately
            if (PaymentRecordsEngine?.state?.students) {
              PaymentRecordsEngine.state.students.set(currentEditingStudent.id, currentEditingStudent);
              debugLog('ðŸ”„ Updated cached student data for ID:', currentEditingStudent.id);
            }
            
            // Also clear reference cache to force fresh data on next load
            if (PaymentRecordsEngine?.state?.referenceCache) {
              PaymentRecordsEngine.state.referenceCache = null;
              debugLog('ðŸ—‘ï¸ Cleared reference cache to force refresh');
            }
          }
          
          // Reload all payment data to reflect group changes in the grid
          await loadData(true);
          
          // Close panel after data refresh
          closeDetailsPanel();

        } catch (error) {
          console.error('âŒ Error saving student:', error);
          console.error('âŒ Error details:', JSON.stringify(error, null, 2));
          showNotification('âŒ Failed to save changes: ' + (error.message || 'Unknown error'), 'error');
        }
      }

      async function loadCreditHistory(studentId) {
        try {
          const { data, error } = await supabaseClient
            .from('credit_payments')
            .select('*')
            .eq('student_id', studentId)
            .order('class_date', { ascending: false })
            .limit(20);

          if (error) throw error;

          const timeline = document.getElementById('creditTimeline');
          
          if (!data || data.length === 0) {
            timeline.innerHTML = '<div style="color: rgba(255, 255, 255, 0.5); font-size: 13px; text-align: center">No credit history available</div>';
            return;
          }

          timeline.innerHTML = data.map(item => `
            <div class="credit-timeline-item">
              <div class="credit-timeline-info">
                <div class="credit-timeline-date">${new Date(item.class_date).toLocaleDateString()}</div>
                <div class="credit-timeline-action">${item.action || 'Credit adjustment'}</div>
              </div>
              <div class="credit-timeline-amount" style="font-weight: 600; color: ${item.amount > 0 ? '#10b981' : '#ef4444'};">
                ${item.amount > 0 ? '+' : ''}${item.amount} $
              </div>
            </div>
          `).join('');

        } catch (error) {
          console.error('âŒ Error loading credit history:', error);
        }
      }

      // ============================================================
      // PDF EXPORT UTILITIES
      // ============================================================
      const pdfAssets = {
        logoUrl: 'https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png',
        logoDataUrl: null,
        fetchPromise: null
      };

      async function loadReportLogo() {
        if (pdfAssets.logoDataUrl) {
          return pdfAssets.logoDataUrl;
        }

        if (!pdfAssets.fetchPromise) {
          pdfAssets.fetchPromise = fetch(pdfAssets.logoUrl)
            .then(response => {
              if (!response.ok) {
                throw new Error(`Failed to load logo: ${response.status}`);
              }
              return response.blob();
            })
            .then(blob => new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(blob);
            }))
            .then(dataUrl => {
              pdfAssets.logoDataUrl = dataUrl;
              return dataUrl;
            })
            .catch(error => {
              console.warn('Could not load logo:', error);
              return null;
            })
            .finally(() => {
              pdfAssets.fetchPromise = null;
            });
        }

        return pdfAssets.fetchPromise;
      }

      const formatReportAmount = (value) => {
        const numeric = Number(value || 0);
        if (!Number.isFinite(numeric)) return '0';
        return Math.round(numeric).toLocaleString('en-US');
      };

      // ============================================================
      // PDF EXPORT FUNCTIONALITY
      // ============================================================
      async function exportToPDF() {
        const exportBtn = document.getElementById('exportPdfBtn');
        if (!exportBtn) return;

        try {
          // Add loading state
          exportBtn.classList.add('exporting');
          exportBtn.disabled = true;

          // Get the filtered records from PaymentRecordsEngine
          const searchTerm = PaymentRecordsEngine.state.filters.search.trim();
          const records = PaymentRecordsEngine.state.filtered && PaymentRecordsEngine.state.filtered.length > 0
            ? PaymentRecordsEngine.state.filtered
            : PaymentRecordsEngine.state.payments;

          if (!records || records.length === 0) {
            alert('No payment records to export.');
            return;
          }

          // Initialize jsPDF
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
          });

          const pageWidth = doc.internal.pageSize.getWidth();
          const pageHeight = doc.internal.pageSize.getHeight();

          // Load and cache logo asset once per session
          const logoData = await loadReportLogo();

          // Function to add professional watermark using logo
          const addWatermark = () => {
            if (logoData) {
              doc.saveGraphicsState();
              
              // Make it VERY light - barely visible
              doc.setGState(new doc.GState({ opacity: 0.05 }));
              
              // Center the logo watermark - make it BIG to cover the page
              const centerX = pageWidth / 2;
              const centerY = pageHeight / 2;
              const logoSize = 140; // Large to cover most of the page
              
              try {
                doc.addImage(logoData, 'PNG', centerX - logoSize/2, centerY - logoSize/2, logoSize, logoSize);
              } catch (e) {
                console.warn('Watermark logo rendering failed:', e);
              }
              
              doc.restoreGraphicsState();
            }
          };

          // Function to add professional header to each page
          const addHeader = (pageNum) => {
            // Elegant gradient header bar
            doc.setFillColor(30, 41, 59); // Dark slate
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            // Accent bar (cyan/purple gradient effect - top stripe)
            const gradient = doc.setFillColor(138, 180, 255);
            doc.rect(0, 0, pageWidth, 3, 'F');
            
            // Add logo if loaded
            if (logoData) {
              try {
                doc.addImage(logoData, 'PNG', 15, 8, 30, 24);
              } catch (e) {
                console.warn('Logo rendering failed:', e);
              }
            }

            // Company branding
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('ARNOMA', logoData ? 50 : 15, 18);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(203, 213, 225); // Light slate
            doc.text('Education Management System', logoData ? 50 : 15, 26);

            // Document title
            doc.setFontSize(16);
            doc.setTextColor(138, 180, 255); // Cyan accent
            doc.setFont('helvetica', 'bold');
            doc.text('PAYMENT RECORDS REPORT', logoData ? 50 : 15, 34);

            // Professional metadata on the right
            doc.setFontSize(9);
            doc.setTextColor(203, 213, 225);
            doc.setFont('helvetica', 'normal');
            const exportDate = new Date().toLocaleString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              hour12: true
            });
            
            const rightX = pageWidth - 15;
            doc.text(`Report Generated: ${exportDate}`, rightX, 14, { align: 'right' });
            doc.text(`Total Records: ${records.length}`, rightX, 20, { align: 'right' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(138, 180, 255);
            doc.text(`Page ${pageNum}`, rightX, 28, { align: 'right' });

            // Bottom border accent
            doc.setDrawColor(138, 180, 255);
            doc.setLineWidth(0.5);
            doc.line(15, 38, pageWidth - 15, 38);
          };

          // Function to add professional footer
          const addFooter = (pageNum, totalPages) => {
            const footerY = pageHeight - 18;
            
            // Footer separator line
            doc.setDrawColor(203, 213, 225);
            doc.setLineWidth(0.3);
            doc.line(15, footerY, pageWidth - 15, footerY);
            
            // Footer background
            doc.setFillColor(248, 250, 252);
            doc.rect(0, footerY + 2, pageWidth, 18, 'F');
            
            // Footer content
            doc.setTextColor(71, 85, 105); // Slate gray
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('ARNOMA', 15, footerY + 8);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text('Education Management System â€¢ Financial Records', 15, footerY + 12);
            
            // Center text
            doc.setFontSize(7);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(100, 116, 139);
            doc.text('Confidential Document - For Internal Use Only', pageWidth / 2, footerY + 10, { align: 'center' });
            
            // Right aligned page numbers
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.setTextColor(71, 85, 105);
            doc.text(`Page ${pageNum} of ${totalPages}`, pageWidth - 15, footerY + 8, { align: 'right' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text(new Date().toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric' 
            }), pageWidth - 15, footerY + 12, { align: 'right' });
          };

          // Get student details for comprehensive information
          const studentsMap = PaymentRecordsEngine.state.students;
          const groupsMap = PaymentRecordsEngine.state.groups;
          
          // Prepare enhanced table data with all student information
          const tableData = records.map(record => {
            // Try multiple date fields and ensure valid date
            let date;
            const dateFields = [record.emailDate, record.created_at, record.date, record.timestamp];
            for (const field of dateFields) {
              if (field) {
                const tempDate = new Date(field);
                if (!isNaN(tempDate.getTime())) {
                  date = tempDate;
                  break;
                }
              }
            }
            
            // Fallback to current date if no valid date found
            if (!date || isNaN(date.getTime())) {
              date = new Date();
            }
            
            const dateStr = date.toLocaleDateString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric'
            });
            const timeStr = date.toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });

            // Get student details if available - try multiple ID fields
            const studentId = record.studentId || record.student_id || record.linked_student_id;
            const student = studentId ? studentsMap.get(studentId) : null;
            
            // Get student name and email
            const studentName = student?.name || record.studentName || record.student_name || 'N/A';
            const studentEmail = student?.email || record.email || '-';
            const groupName = record.groupLetter || record.groupName || record.group_name || student?.group_name || '-';
            
            const amountUSD = record.amountUSD || record.amount_paid_usd || record.amount || 0;

            return [
              dateStr,
              timeStr,
              record.payerName || record.payer_name || 'N/A',
              studentName,
              studentEmail,
              groupName,
              `$${Number(amountUSD).toFixed(2)}`,
              record.memo || record.message || '-'
            ];
          });

          // Add watermark and first page header
          addWatermark();
          addHeader(1);

          // Generate table with professional styling
          doc.autoTable({
            head: [[
              'Date', 
              'Time', 
              'Payer Name', 
              'Student Name', 
              'Email Address',
              'Group', 
              'Amount (USD)', 
              'Notes'
            ]],
            body: tableData,
            startY: 45,
            margin: { top: 45, bottom: 22, left: 15, right: 15 },
            styles: {
              fontSize: 8,
              cellPadding: 3.5,
              lineColor: [226, 232, 240], // Light slate border
              lineWidth: 0.2,
              textColor: [30, 41, 59], // Dark slate text
              font: 'helvetica'
            },
            headStyles: {
              fillColor: [71, 85, 105], // Professional slate
              textColor: [255, 255, 255],
              fontStyle: 'bold',
              fontSize: 9,
              halign: 'center',
              cellPadding: 4,
              lineWidth: 0.3,
              lineColor: [138, 180, 255]
            },
            alternateRowStyles: {
              fillColor: [248, 250, 252] // Very light slate
            },
            columnStyles: {
              0: { cellWidth: 26, halign: 'center', fontStyle: 'bold' },   // Date
              1: { cellWidth: 20, halign: 'center', textColor: [100, 116, 139] },   // Time
              2: { cellWidth: 38, fontStyle: 'bold' },                     // Payer Name
              3: { cellWidth: 36 },                     // Student Name
              4: { cellWidth: 44, fontSize: 7, textColor: [71, 85, 105] },                     // Email Address
              5: { cellWidth: 20, halign: 'center', fontStyle: 'bold', textColor: [138, 180, 255] },   // Group (increased width)
              6: { cellWidth: 26, halign: 'right', fontStyle: 'bold', textColor: [22, 163, 74] },    // Amount USD
              7: { cellWidth: 'auto', fontSize: 7, textColor: [100, 116, 139] }     // Notes
            },
            didDrawPage: (data) => {
              const pageNum = doc.internal.getCurrentPageInfo().pageNumber;
              const totalPages = doc.internal.getNumberOfPages();
              
              // Add watermark to every page
              addWatermark();
              
              // Add header (skip first page as we already added it)
              if (pageNum > 1) {
                addHeader(pageNum);
              }
              
              // Add footer to all pages
              addFooter(pageNum, totalPages);
            }
          });

          // Calculate comprehensive totals
          const totalUSD = records.reduce((sum, r) => {
            const amt = Number(r.amountUSD || r.amount_paid_usd || r.amount || 0);
            return sum + amt;
          }, 0);

          const totalAMD = records.reduce((sum, r) => {
            const amt = Number(r.amountAMD || r.amount_paid_amd || 0);
            return sum + amt;
          }, 0);

          // Add hyper-professional summary box (always rendered, with overflow safety)
          const summaryMetrics = {
            totalUSD,
            totalAMD,
            transactionCount: records.length,
            average: totalUSD / Math.max(records.length, 1)
          };

          const drawSummaryCard = () => {
            const hasAMD = summaryMetrics.totalAMD > 0;
            const rows = 3 + (hasAMD ? 1 : 0); // total payments, total usd, optional amd, average
            const summaryWidth = 95;
            const summaryHeight = 38 + rows * 14;
            const marginRight = 15;
            const summaryX = pageWidth - summaryWidth - marginRight;
            let summaryY = (doc.lastAutoTable?.finalY || 45) + 12;

            const bottomLimit = pageHeight - 28;
            if (summaryY + summaryHeight > bottomLimit) {
              summaryY = Math.max(45, bottomLimit - summaryHeight);
            }

            // Shadow effect for depth
            doc.setFillColor(0, 0, 0);
            doc.setGState(new doc.GState({ opacity: 0.08 }));
            doc.roundedRect(summaryX + 1, summaryY + 1, summaryWidth, summaryHeight, 4, 4, 'F');
            doc.setGState(new doc.GState({ opacity: 1 }));

            // Main container background
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(summaryX, summaryY, summaryWidth, summaryHeight, 4, 4, 'F');

            // Border with premium green accent
            doc.setDrawColor(34, 197, 94);
            doc.setLineWidth(1);
            doc.roundedRect(summaryX, summaryY, summaryWidth, summaryHeight, 4, 4, 'S');

            // Header section
            doc.setFillColor(34, 197, 94);
            doc.roundedRect(summaryX, summaryY, summaryWidth, 12, 4, 4, 'F');
            doc.rect(summaryX, summaryY + 6, summaryWidth, 6, 'F');

            // Title
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('FINANCIAL SUMMARY', summaryX + summaryWidth / 2, summaryY + 8, { align: 'center' });

            // Content area background
            doc.setFillColor(248, 250, 252);
            doc.rect(summaryX + 3, summaryY + 14, summaryWidth - 6, summaryHeight - 18, 'F');

            const leftMargin = summaryX + 9;
            const rightMargin = summaryX + summaryWidth - 9;
            let contentY = summaryY + 26;

            const drawRow = ({
              label,
              value,
              labelFontSize = 8.5,
              valueFontSize = 11,
              labelColor = [71, 85, 105],
              valueColor = [71, 85, 105],
              valueBold = true,
              labelBold = true,
              divider = true,
              italicLabel = false
            }) => {
              doc.setFontSize(labelFontSize);
              doc.setTextColor(...labelColor);
              doc.setFont('helvetica', italicLabel ? 'italic' : labelBold ? 'bold' : 'normal');
              doc.text(label, leftMargin, contentY);

              doc.setFontSize(valueFontSize);
              doc.setTextColor(...valueColor);
              doc.setFont('helvetica', valueBold ? 'bold' : 'normal');
              doc.text(value, rightMargin, contentY, { align: 'right' });

              contentY += 9;
              if (divider) {
                doc.setDrawColor(226, 232, 240);
                doc.setLineWidth(0.2);
                doc.line(leftMargin, contentY - 4, rightMargin, contentY - 4);
                contentY += 5;
              }
            };

            drawRow({
              label: 'TOTAL PAYMENTS',
              value: `${summaryMetrics.transactionCount} transactions`,
              valueFontSize: 10,
              valueColor: [30, 41, 59],
              valueBold: false
            });

            drawRow({
              label: 'TOTAL USD',
              value: formatReportAmount(summaryMetrics.totalUSD),
              valueFontSize: 14,
              valueColor: [34, 197, 94]
            });

            if (hasAMD) {
              drawRow({
                label: 'TOTAL AMD',
                value: formatReportAmount(summaryMetrics.totalAMD),
                valueFontSize: 12,
                valueColor: [168, 85, 247]
              });
            }

            drawRow({
              label: 'Average per transaction',
              value: formatReportAmount(summaryMetrics.average),
              labelFontSize: 7.5,
              valueFontSize: 10,
              labelColor: [100, 116, 139],
              valueColor: [71, 85, 105],
              valueBold: true,
              labelBold: false,
              italicLabel: true,
              divider: false
            });
          };

          drawSummaryCard();

          // After all content is rendered, update footers with final page count
          const finalPageCount = doc.internal.getNumberOfPages();
          for (let i = 1; i <= finalPageCount; i++) {
            doc.setPage(i);
            addFooter(i, finalPageCount);
          }

          // Generate professional filename
          const timestamp = new Date().toISOString().slice(0, 10);
          const timeString = new Date().toTimeString().slice(0, 5).replace(':', '');
          const filename = searchTerm
            ? `ARNOMA-Payment-Records-${searchTerm.replace(/\s+/g, '-')}-${timestamp}-${timeString}.pdf`
            : `ARNOMA-Payment-Records-${timestamp}-${timeString}.pdf`;

          // Save PDF
          doc.save(filename);

          debugLog(`âœ… Professional PDF exported: ${filename} (${records.length} records, $${totalUSD.toFixed(2)} total)`);

        } catch (error) {
          console.error('âŒ Error exporting PDF:', error);
          alert('Failed to export PDF. Please try again.');
        } finally {
          // Remove loading state
          exportBtn.classList.remove('exporting');
          exportBtn.disabled = false;
        }
      }

      function closeDetailsPanel() {
        document.getElementById('detailsPanel').classList.remove('active');
        document.getElementById('detailsOverlay').classList.remove('active');
        selectedPayment = null;
        currentEditingStudent = null;
        currentPaymentRecord = null;
      }

      // ============================================================
      // RENDER FUNCTIONS (PLACEHOLDER)
      // ============================================================
      function updateStats() {
        // TODO: Update footer statistics
      }

      // ============================================================
      // NOTIFICATION CENTER SYSTEM
      // ============================================================
      // NOTIFICATION SYSTEM - MOVED TO Notification-Center.html
      // ============================================================
      // Notification center functionality has been moved to a standalone
      // Notification-Center.html file that opens via openModulePopup()
      // The bell button is located in the navigation bar and opens the popup.
      
      // Update notification badge count
      async function updateNotificationBadge() {
        try {
          // Safety check: ensure supabaseClient is initialized
          if (!window.supabaseClient && !window.supabase) {
            return; // Silently skip if not ready
          }
          
          // Use global supabaseClient or create temporary one
          const client = window.supabaseClient || window.supabase?.createClient(
            'https://zlvnxvrzotamhpezqedr.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38'
          );
          
          if (!client) {
            return; // Silently skip if client creation failed
          }
          
          const { data, error } = await client
            .from('notifications')
            .select('id, read, is_read')
            .or('read.is.null,read.eq.false')
            .or('is_read.is.null,is_read.eq.false');
          
          if (error) {
            return; // Silently skip on error
          }
          
          const unreadCount = (data || []).length;
          const badge = document.getElementById('notificationBadge');
          
          if (!badge) return;
          
          if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        } catch (err) {
          // Silently fail - notification badge is non-critical
        }
      }
      
      // Refresh notification badge periodically
      setInterval(() => {
        if (!document.hidden) {
          updateNotificationBadge();
        }
      }, 300000); // Every 5 minutes
      
      // Update badge on page load - with delay to ensure Supabase is loaded
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          updateNotificationBadge();
        }, 1000); // Wait 1 second for Supabase to initialize
      });
      
      // ============================================================
      // EMAIL PREVIEW MODAL
      // ============================================================

      // Open email preview
      function openEmailPreview(notification) {
  debugLog('ðŸ“§ Opening email preview:', notification);

        const overlay = document.getElementById('emailPreviewOverlay');
        const body = document.getElementById('emailPreviewBody');
        const title = document.getElementById('emailPreviewTitle');

        if (!overlay || !body || !title) return;
        
        overlay.style.display = 'flex';

        // Support both metadata (new) and payload (legacy)
        const payload = notification.metadata || notification.payload || {};

        title.textContent = payload.subject || 'Email Preview';

        // Render email content
        let html = `
          <div class="email-meta">
            <div class="email-meta-row">
              <div class="email-meta-label">Subject:</div>
              <div class="email-meta-value">${payload.subject || 'N/A'}</div>
            </div>
            <div class="email-meta-row">
              <div class="email-meta-label">Recipient:</div>
              <div class="email-meta-value">${payload.email || payload.recipient || payload.recipients || 'N/A'}</div>
            </div>
            <div class="email-meta-row">
              <div class="email-meta-label">Sent:</div>
              <div class="email-meta-value">${formatNotificationTime(notification.created_at)}</div>
            </div>
            ${payload.template_name ? `
              <div class="email-meta-row">
                <div class="email-meta-label">Template:</div>
                <div class="email-meta-value">${payload.template_name}</div>
              </div>
            ` : ''}
            ${payload.automation_id ? `
              <div class="email-meta-row">
                <div class="email-meta-label">Automation:</div>
                <div class="email-meta-value">#${payload.automation_id}</div>
              </div>
            ` : ''}
          </div>

          <div class="email-body-content">
            ${payload.html || payload.body_html || payload.body || '<p style="color: rgba(255,255,255,0.5);">No email content available</p>'}
          </div>
        `;

        // Add action buttons if template exists
        if (payload.template_id || payload.template_name) {
          html += `
            <div class="email-actions">
              <button class="email-action-btn primary" onclick="openEmailTemplate('${payload.template_id || ''}', '${payload.template_name || ''}')">
                ðŸ“ Open in Email Templates
              </button>
              <button class="email-action-btn secondary" onclick="closeEmailPreview()">
                Close
              </button>
            </div>
          `;
        } else {
          html += `
            <div class="email-actions">
              <button class="email-action-btn secondary" onclick="closeEmailPreview()">
                Close
              </button>
            </div>
          `;
        }

        body.innerHTML = html;
        BlurManager.enable(16);
        requestAnimationFrame(() => overlay.classList.add('active'));
      }

      // Close email preview
      function closeEmailPreview() {
        const emailOverlay = document.getElementById('emailPreviewOverlay');
        
        if (emailOverlay) {
          emailOverlay.classList.remove('active');
          BlurManager.reset(); // Force complete reset instead of just disable
          
          // Force cleanup of any lingering styles on body/container
          document.body.style.filter = '';
          document.body.style.backdropFilter = '';
          document.body.style.webkitBackdropFilter = '';
          document.body.style.background = ''; // RESET BACKGROUND!
          const container = document.querySelector('.container');
          if (container) {
            container.style.filter = '';
            container.style.backdropFilter = '';
            container.style.webkitBackdropFilter = '';
          }
          
          setTimeout(() => {
            if (!emailOverlay.classList.contains('active')) {
              emailOverlay.style.display = 'none';
            }
          }, 200);
        }
        
  debugLog('ðŸ“§ Email preview closed');
      }

      // Close on overlay click
      document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('emailPreviewOverlay');
        if (overlay) {
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              closeEmailPreview();
            }
          });
        }
      });

      // Open email template (navigate to email editor)
      function openEmailTemplate(templateId, templateName) {
  debugLog('ðŸ“ Opening email template:', templateId, templateName);

        // TODO: Navigate to email editor module with template selected
        // For now, just show an alert
        customAlert(
          'Email Template',
          `Would navigate to email editor with template: ${templateName || templateId}\n\nThis feature requires the Email Automation module.`
        );

        closeEmailPreview();
      }

      // ============================================================
      // NOTIFICATION SYSTEM INITIALIZATION
      // ============================================================

      // Helper function to create notification (for email system integration)
      async function createNotification(type, title, message, category, payload = {}) {
        try {
          debugLog('ðŸ”” Creating notification:', { type, title, category });

          const { data, error } = await supabaseClient
            .from('notifications')
            .insert([
              {
                type: type,
                title: title,
                message: message,
                category: category,
                payload: payload,
                read: false
              }
            ])
            .select();

          if (error) {
            console.error('âŒ Error creating notification:', error);
            return null;
          }

          debugLog('âœ… Notification created:', data[0]);

          // Trigger badge update
          updateNotificationBadge();

          return data[0];

        } catch (err) {
          console.error('âŒ Exception creating notification:', err);
          return null;
        }
      }

      // Expose globally for email system integration
      window.createNotification = createNotification;

      // ============================================================
      // MODULE POPUP SYSTEM
      // ============================================================

      /**
       * Open a module in a full-screen popup overlay
       * @param {string} moduleUrl - The URL of the HTML module to load
       * @param {string} moduleTitle - The title of the module (for logging)
       */
      function openModulePopup(moduleUrl, moduleTitle) {
  debugLog(`ðŸ“¦ Opening module popup: ${moduleTitle} (${moduleUrl})`);

        const overlay = document.getElementById('modulePopupOverlay');
        const iframe = document.getElementById('modulePopupIframe');

        if (!overlay || !iframe) {
          console.error('âŒ Module popup elements not found');
          return;
        }

        // Force complete reload: clear iframe first, then load with cache buster
        iframe.src = 'about:blank';
        
        // Use setTimeout to ensure the blank loads first
        setTimeout(() => {
          const cacheBuster = `?reload=${Date.now()}`;
          iframe.src = moduleUrl + cacheBuster;
          debugLog('ðŸ“… Loading calendar with cache buster:', moduleUrl + cacheBuster);
        }, 10);

        // Show overlay with animation
        overlay.classList.add('active');

        // Add special class for notification center to hide the module close button
        if (moduleUrl.includes('Notification-Center.html')) {
          overlay.classList.add('notification-center-open');
        } else {
          overlay.classList.remove('notification-center-open');
        }

        // Log success
  debugLog(`âœ… Module popup opened: ${moduleTitle}`);

        // Add escape key listener
        document.addEventListener('keydown', handleModulePopupEscape);
      }

      /**
       * Close the module popup overlay
       */
      function closeModulePopup() {
  debugLog('ðŸ“¦ Closing module popup');

        const overlay = document.getElementById('modulePopupOverlay');
        const iframe = document.getElementById('modulePopupIframe');

        if (!overlay || !iframe) return;

        // Hide overlay
        overlay.classList.remove('active');
        overlay.classList.remove('notification-center-open');

        // Clear iframe source after animation completes
        setTimeout(() => {
          iframe.src = 'about:blank';
        }, 300);

        // Remove escape key listener
        document.removeEventListener('keydown', handleModulePopupEscape);

  debugLog('âœ… Module popup closed');
      }

      /**
       * Handle escape key press to close module popup
       */
      function handleModulePopupEscape(event) {
        if (event.key === 'Escape') {
          closeModulePopup();
        }
      }

      // Close module popup on overlay click
      document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('modulePopupOverlay');
        if (overlay) {
          overlay.addEventListener('click', (e) => {
            // Only close if clicking directly on the overlay (not the container or iframe)
            if (e.target === overlay || e.target.classList.contains('module-popup-overlay')) {
              debugLog('ðŸ“¦ Clicked overlay background, closing popup');
              closeModulePopup();
            }
          });
          debugLog('âœ… Overlay click listener attached');
        } else {
          console.warn('âš ï¸ Module popup overlay not found');
        }
      });

      // Listen for iframe postMessage close events
      window.addEventListener('message', (event) => {
        if (event?.data?.type === 'close-module-popup') {
          debugLog('ðŸ“¨ Received close-module-popup message');
          closeModulePopup();
        }
      });

      // Expose globally for module cross-communication
      window.openModulePopup = openModulePopup;
      window.closeModulePopup = closeModulePopup;
    </script>

    <!-- ============================================================
         PAYER ACTIONS POPUP
         ============================================================ -->
    <div id="payerActionsOverlay" class="payer-actions-overlay">
      <div class="payer-actions-popup">
        <div class="payer-actions-header">
          <div class="payer-actions-title">Payer Actions</div>
          <button class="payer-actions-close" onclick="closePayerActionsPopup()" aria-label="Close payer actions">Ã—</button>
        </div>
        <div class="payer-actions-body">
          <!-- Payer Summary -->
          <div class="payer-summary">
            <div class="payer-summary-row">
              <span class="payer-summary-label">Payer Name</span>
              <span class="payer-summary-value" id="payerSummaryName">â€”</span>
            </div>
            <div class="payer-summary-row">
              <span class="payer-summary-label">Amount (USD)</span>
              <span class="payer-summary-value amount" id="payerSummaryAmountUSD">â€”</span>
            </div>
            <div class="payer-summary-row">
              <span class="payer-summary-label">Amount (AMD)</span>
              <span class="payer-summary-value amount" id="payerSummaryAmountAMD">â€”</span>
            </div>
            <div class="payer-summary-row">
              <span class="payer-summary-label">Date</span>
              <span class="payer-summary-value" id="payerSummaryDate">â€”</span>
            </div>
            <div class="payer-summary-row">
              <span class="payer-summary-label">Message</span>
              <span class="payer-summary-value message" id="payerSummaryMessage">â€”</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="payer-actions-grid">
            <button type="button" class="payer-action-btn" onclick="createPayerAlias()">
              <span class="icon">ðŸ·ï¸</span>
              Create Payer Alias
            </button>
            <button type="button" class="payer-action-btn" onclick="changePaymentDate()">
              <span class="icon">ðŸ“…</span>
              Change Email Date
            </button>
            <button type="button" class="payer-action-btn" onclick="linkPaymentToStudent()">
              <span class="icon">ðŸ”—</span>
              Link to Student
            </button>
            <button type="button" class="payer-action-btn danger" onclick="ignorePayment()">
              <span class="icon">ðŸ‘ï¸</span>
              Ignore This Payment
            </button>
            <button type="button" class="payer-action-btn danger" onclick="ignoreAllFromPayer()">
              <span class="icon">ðŸš«</span>
              Ignore All from Payer
            </button>
            <button type="button" class="payer-action-btn danger" onclick="deletePayment()">
              <span class="icon">ðŸ—‘ï¸</span>
              Delete This Payment
            </button>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- ============================================================
         CUSTOM ALERT/PROMPT MODAL
         ============================================================ -->
    <div id="customAlertOverlay" class="custom-alert-overlay">
      <div class="custom-alert-modal">
        <div class="custom-alert-title" id="customAlertTitle">Alert</div>
        <div class="custom-alert-message" id="customAlertMessage">Message</div>
        <input type="text" class="custom-alert-input" id="customAlertInput" style="display: none;" placeholder="Enter value...">
        <div class="custom-alert-buttons" id="customAlertButtons">
          <button class="custom-alert-btn cancel" id="customAlertCancel">Cancel</button>
          <button class="custom-alert-btn ok" id="customAlertOk">OK</button>
        </div>
      </div>
    </div>

    <!-- ============================================================
         EMAIL PREVIEW MODAL
         ============================================================ -->
    <div id="emailPreviewOverlay" class="email-preview-overlay">
      <div class="email-preview-panel">
        <div class="email-preview-header">
          <div class="email-preview-title" id="emailPreviewTitle">Email Preview</div>
          <button class="email-preview-close" onclick="closeEmailPreview()" aria-label="Close email preview">Ã—</button>
        </div>
        <div class="email-preview-body" id="emailPreviewBody">
          <!-- Email content will be rendered here -->
        </div>
      </div>
    </div>

    <!-- ============================================================
         CUSTOM CONFIRMATION MODAL
         ============================================================ -->
    <div id="confirmModalOverlay" class="confirm-modal-overlay">
      <div class="confirm-modal-panel">
        <div class="confirm-modal-icon">âš ï¸</div>
        <div class="confirm-modal-title" id="confirmModalTitle">Confirm Action</div>
        <div class="confirm-modal-message" id="confirmModalMessage">Are you sure?</div>
        <div class="confirm-modal-actions">
          <button class="confirm-modal-btn confirm-modal-cancel" id="confirmModalCancel">Cancel</button>
          <button class="confirm-modal-btn confirm-modal-confirm" id="confirmModalConfirm">OK</button>
        </div>
      </div>
    </div>

    <!-- ============================================================
         MODULE POPUP OVERLAY SYSTEM
         ============================================================ -->
    <div id="modulePopupOverlay" class="module-popup-overlay">
      <div class="module-popup-container">
        <button class="module-popup-close" onclick="closeModulePopup()" aria-label="Close module" title="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <iframe id="modulePopupIframe" class="module-popup-iframe" src="about:blank" title="Module Content"></iframe>
      </div>
    </div>
  </body>
</html>
