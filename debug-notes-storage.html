<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Debug Notes Storage</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    pre {
      background: #0f0f1e;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
    }
    button {
      padding: 10px 20px;
      margin: 10px 5px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #5568d3;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .warning { color: #f59e0b; }
  </style>
</head>
<body>
  <h1>üîç Notes Storage Debugger</h1>
  
  <button onclick="checkDatabase()">Check Database Records</button>
  <button onclick="checkStorage()">Check Storage Files</button>
  <button onclick="testSignedURL()">Test Signed URL</button>
  
  <pre id="output">Click a button to start debugging...</pre>

  <script>
    const SUPABASE_URL = 'https://pzbkznboxsckoswzfigq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Ymt6bmJveHNja29zd3pmaWdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI2NTYwNDIsImV4cCI6MjA0ODIzMjA0Mn0.cPVXo-Kd2qSNO0l63V9Q_MjbjPj_Bs88SgDwl6hR5k8';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const BUCKET_NAME = 'student-notes';

    // Check for admin session on page load
    async function ensureAdminSession() {
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (!session) {
        log('‚ö†Ô∏è No admin session found. Redirecting to login...', 'warning');
        setTimeout(() => {
          window.location.href = 'Login.html?redirect=' + encodeURIComponent(window.location.href);
        }, 2000);
        throw new Error('Authentication required');
      }
      
      return session;
    }

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
      output.innerHTML += `<div class="${className}">${message}</div>`;
    }

    function clear() {
      document.getElementById('output').innerHTML = '';
    }

    async function checkDatabase() {
      clear();
      log('üìä Checking database records...\n');

      try {
        await ensureAdminSession();
        
        const { data, error } = await supabase
          .from('student_notes')
          .select('*')
          .eq('is_system_note', true)
          .eq('deleted', false)
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        log(`‚úÖ Found ${data.length} system notes in database\n`, 'success');

        data.forEach((note, i) => {
          log(`\n--- Note ${i + 1} ---`);
          log(`ID: ${note.id}`);
          log(`Title: ${note.title}`);
          log(`System: ${note.group_name}`);
          log(`PDF URL: ${note.pdf_url}`, note.pdf_url ? 'success' : 'error');
          log(`File Name: ${note.file_name}`);
          log(`File Size: ${note.file_size} bytes`);
          log(`Created: ${note.created_at}`);
        });

      } catch (error) {
        log(`‚ùå Database error: ${error.message}`, 'error');
        console.error(error);
      }
    }

    async function checkStorage() {
      clear();
      log('üìÅ Checking storage bucket...\n');

      try {
        await ensureAdminSession();
        
        // List all files in Cardiovascular System folder
        const { data, error } = await supabase.storage
          .from(BUCKET_NAME)
          .list('Cardiovascular System', {
            limit: 100,
            sortBy: { column: 'created_at', order: 'desc' }
          });

        if (error) throw error;

        log(`‚úÖ Found ${data.length} files in Cardiovascular System folder\n`, 'success');

        data.forEach((file, i) => {
          log(`\n--- File ${i + 1} ---`);
          log(`Name: ${file.name}`);
          log(`Size: ${file.metadata?.size || 'unknown'} bytes`);
          log(`Created: ${file.created_at}`);
          log(`Full path: Cardiovascular System/${file.name}`);
        });

        // Also check root level
        log('\n\nüìÅ Checking root level of bucket...\n');
        const { data: rootData, error: rootError } = await supabase.storage
          .from(BUCKET_NAME)
          .list('', {
            limit: 100
          });

        if (rootError) throw rootError;

        log(`‚úÖ Found ${rootData.length} items at root level\n`, 'success');
        rootData.forEach(item => {
          log(`  ${item.name} (${item.id ? 'folder' : 'file'})`);
        });

      } catch (error) {
        log(`‚ùå Storage error: ${error.message}`, 'error');
        console.error(error);
      }
    }

    async function testSignedURL() {
      clear();
      log('üîó Testing signed URL generation...\n');

      try {
        await ensureAdminSession();
        
        // Get the first note from database
        const { data: notes, error: dbError } = await supabase
          .from('student_notes')
          .select('pdf_url, title')
          .eq('is_system_note', true)
          .eq('deleted', false)
          .limit(1);

        if (dbError) throw dbError;

        if (!notes || notes.length === 0) {
          log('‚ùå No notes found in database', 'error');
          return;
        }

        const note = notes[0];
        log(`Testing note: ${note.title}`);
        log(`PDF path: ${note.pdf_url}\n`);

        // Try to create signed URL
        const { data, error } = await supabase.storage
          .from(BUCKET_NAME)
          .createSignedUrl(note.pdf_url, 3600);

        if (error) {
          log(`‚ùå Failed to create signed URL`, 'error');
          log(`Error message: ${error.message}`, 'error');
          log(`Error details: ${JSON.stringify(error, null, 2)}`, 'error');
          
          // Try alternate paths
          log('\n‚ö†Ô∏è Trying alternate paths...', 'warning');
          
          // Try URL-encoded version
          const encoded = encodeURIComponent(note.pdf_url);
          log(`\nTrying URL-encoded: ${encoded}`);
          const { data: data2, error: error2 } = await supabase.storage
            .from(BUCKET_NAME)
            .createSignedUrl(encoded, 3600);
          
          if (error2) {
            log(`‚ùå Also failed: ${error2.message}`, 'error');
          } else {
            log(`‚úÖ URL-encoded path worked!`, 'success');
            log(`Signed URL: ${data2.signedUrl}`);
          }

        } else {
          log(`‚úÖ Signed URL created successfully!`, 'success');
          log(`\nSigned URL: ${data.signedUrl}\n`);
          log('üöÄ Opening in new tab...');
          window.open(data.signedUrl, '_blank');
        }

      } catch (error) {
        log(`‚ùå Test error: ${error.message}`, 'error');
        console.error(error);
      }
    }
  </script>
</body>
</html>
