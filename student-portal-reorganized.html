<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ============================================================================
       STUDENT PORTAL - ARNOMA NURSING ACADEMY
       ============================================================================
       Main student dashboard displaying:
       - Personal schedule with countdown timer
       - Payment history and balance
       - Class notes and materials (with payment-gated access)
       - NCLEX systems progress tracking
       - Study games (PharmaQuest)
       - Nurses forum for Q&A
       - Profile management
       
       ARCHITECTURE:
       - Self-contained HTML mega-page (no bundler/modules)
       - Direct Supabase integration via CDN client
       - Vanilla JavaScript with DOM caching patterns
       - Supports both regular auth and admin impersonation
       ============================================================================ -->
  
  <!-- ============================== META TAGS ============================== -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Portal - ARNOMA</title>
  <link rel="icon" type="image/png" href="/richyfesta-logo.png">
  <link rel="apple-touch-icon" href="/richyfesta-logo.png">
  
  <!-- Cache Control -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- ============================= EXTERNAL CDN ============================= -->
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Google API (reserved for future classroom integration) -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <style>
    /* ==========================================================================
       CSS VARIABLES - Design System Tokens
       ========================================================================== */
    :root {
      /* Background Colors */
      --bg-base: #020510;
      --bg-gradient-start: #030a1f;
      --bg-gradient-end: #050d2c;
      
      /* Panel Colors */
      --panel-light: rgba(37, 56, 117, 0.85);
      --panel-dark: rgba(16, 24, 47, 0.92);
      
      /* Border & Glass Effects */
      --glass-border: rgba(125, 211, 252, 0.35);
      
      /* Accent Colors */
      --accent-primary: #7dd3fc;
      --accent-secondary: #c084fc;
      --accent-tertiary: #f9a8d4;
      
      /* Glow Effects */
      --glow-blue: rgba(125, 211, 252, 0.65);
      --glow-purple: rgba(192, 132, 252, 0.6);
      
      /* Typography */
      --text-strong: #f8fbff;
      --text-muted: rgba(255, 255, 255, 0.7);
      
      /* Shadows */
      --card-shadow: 0 30px 120px rgba(3, 6, 19, 0.65);
    }
    
    /* ==========================================================================
       RESET & BASE STYLES
       ========================================================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: radial-gradient(circle at 15% 20%, rgba(125, 211, 252, 0.12), transparent 40%),
                  radial-gradient(circle at 75% 0%, rgba(248, 113, 113, 0.08), transparent 40%),
                  linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
      color: var(--text-strong);
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }
    
    /* Background overlay effects */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 50%, rgba(126, 34, 206, 0.18) 0%, transparent 45%),
                  radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.18) 0%, transparent 45%);
      opacity: 0.7;
      pointer-events: none;
      z-index: 0;
    }
    
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 120px 120px;
      opacity: 0.4;
      pointer-events: none;
      z-index: 0;
      animation: grainShift 26s linear infinite;
    }
    
    /* ==========================================================================
       ANIMATIONS
       ========================================================================== */
    @keyframes auroraDrift {
      0% { transform: translate3d(-10%, -10%, 0) scale(1); }
      50% { transform: translate3d(10%, 15%, 0) scale(1.1); }
      100% { transform: translate3d(-10%, -10%, 0) scale(1); }
    }
    
    @keyframes orbFloat {
      0% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-25px) scale(1.05); }
      100% { transform: translateY(0) scale(1); }
    }
    
    @keyframes pulseGlow {
      0%, 100% { opacity: 0.35; }
      50% { opacity: 0.85; }
    }
    
    @keyframes shimmerLine {
      0% { transform: translateX(-100%); opacity: 0; }
      45% { opacity: 0.8; }
      100% { transform: translateX(200%); opacity: 0; }
    }
    
    @keyframes grainShift {
      0% { transform: translate3d(0,0,0); }
      100% { transform: translate3d(-10%, -15%, 0); }
    }
    
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(102,126,234,0.3), 0 0 40px rgba(102,126,234,0.2); }
      50% { box-shadow: 0 0 30px rgba(102,126,234,0.5), 0 0 60px rgba(102,126,234,0.3); }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes borderGlow {
      0%, 100% { border-color: rgba(255,255,255,0.3); }
      50% { border-color: rgba(102,126,234,0.8); }
    }
    
    @keyframes unlock {
      0% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.2) rotate(-10deg); }
      75% { transform: scale(1.2) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 0; }
    }
    
    @keyframes urgentBlink {
      0%, 49% { 
        opacity: 1;
        text-shadow: 0 0 10px rgba(239, 68, 68, 0.8), 0 0 20px rgba(239, 68, 68, 0.5);
      }
      50%, 100% { 
        opacity: 0.4;
        text-shadow: 0 0 5px rgba(239, 68, 68, 0.4), 0 0 10px rgba(239, 68, 68, 0.2);
      }
    }
    
    @keyframes unpaidGlow {
      0%, 100% { 
        box-shadow: 0 10px 36px rgba(239, 68, 68, 0.3), 0 0 20px rgba(239, 68, 68, 0.4);
        border-color: rgba(239, 68, 68, 0.6);
      }
      50% { 
        box-shadow: 0 10px 36px rgba(239, 68, 68, 0.5), 0 0 30px rgba(239, 68, 68, 0.6);
        border-color: rgba(239, 68, 68, 0.9);
      }
    }
    
    @keyframes glossyShine {
      0%, 100% {
        transform: translateX(-100%) translateY(-100%) rotate(45deg);
      }
      50% {
        transform: translateX(100%) translateY(100%) rotate(45deg);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes notificationPulse {
      0% {
        transform: scale(1);
        opacity: 0.7;
      }
      50% {
        transform: scale(1.3);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 0;
      }
    }
    
    /* ==========================================================================
       BACKGROUND DECORATION LAYERS
       ========================================================================== */
    .background-layers {
      position: fixed;
      inset: 0;
      overflow: hidden;
      z-index: 0;
      pointer-events: none;
    }
    
    .logo-watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 85vw;
      height: 85vw;
      max-width: 1200px;
      max-height: 1200px;
      background-image: url('richyfesta-logo.png');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.08;
      filter: blur(0.5px);
      pointer-events: none;
      z-index: 0;
    }
    
    .aurora-layer {
      position: absolute;
      width: 140%;
      height: 140%;
      filter: blur(70px);
      opacity: 0.35;
      background: radial-gradient(circle, rgba(125, 211, 252, 0.35), transparent 60%);
      animation: auroraDrift 30s ease-in-out infinite;
      mix-blend-mode: screen;
    }
    
    .aurora-2 {
      background: radial-gradient(circle, rgba(192, 132, 252, 0.35), transparent 60%);
      animation-duration: 34s;
      animation-delay: -6s;
    }
    
    .aurora-3 {
      background: radial-gradient(circle, rgba(248, 113, 113, 0.25), transparent 70%);
      animation-duration: 40s;
      animation-delay: -12s;
    }
    
    .floating-orb {
      position: absolute;
      width: 320px;
      height: 320px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(125, 211, 252, 0.18), transparent 60%);
      filter: blur(12px);
      animation: orbFloat 12s ease-in-out infinite;
    }
    
    .orb-1 { top: 10%; left: 10%; }
    .orb-2 { bottom: 8%; right: 12%; animation-duration: 16s; }
    .orb-3 { top: 40%; right: 20%; animation-duration: 18s; }
    
    .digital-grid {
      position: absolute;
      inset: 0;
      background-image: linear-gradient(transparent 95%, rgba(255,255,255,0.04) 95%),
                        linear-gradient(90deg, transparent 95%, rgba(255,255,255,0.04) 95%);
      background-size: 140px 140px;
      opacity: 0.35;
      transform: skewY(-4deg);
      filter: blur(0.5px);
    }
    
    .grain-overlay {
      position: absolute;
      inset: 0;
      background-image: radial-gradient(rgba(255,255,255,0.04) 1px, transparent 1px);
      background-size: 3px 3px;
      opacity: 0.2;
      animation: grainShift 18s linear infinite;
    }
    
    /* ==========================================================================
       LAYOUT - Main Container
       ========================================================================== */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 2;
    }
    
    /* ==========================================================================
       HEADER - Top Navigation Bar
       ========================================================================== */
    .header {
      background: linear-gradient(135deg, rgba(14, 23, 46, 0.88), rgba(29, 38, 72, 0.82));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 35px 80px rgba(2, 6, 23, 0.65), inset 0 1px 0 rgba(255,255,255,0.05);
      padding: 32px 40px;
      border-radius: 24px;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 24px;
      animation: slideInLeft 0.6s ease-out;
      position: relative;
      overflow: visible;
      z-index: 1000;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmer 3s infinite;
    }
    
    .header::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,0.08), transparent 70%);
      opacity: 0;
      animation: shimmerLine 6s ease-in-out infinite;
      pointer-events: none;
    }
    
    /* Header Left: Logo + Title */
    .header-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }
    
    .logo {
      width: 150px;
      height: 150px;
      filter: drop-shadow(0 0 25px rgba(125, 211, 252, 0.45)) drop-shadow(0 0 45px rgba(192, 132, 252, 0.35));
      animation: float 3s ease-in-out infinite;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .logo::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 60%);
      border-radius: 50%;
      pointer-events: none;
    }
    
    .logo:hover {
      filter: drop-shadow(0 0 35px rgba(125, 211, 252, 0.6)) drop-shadow(0 0 60px rgba(192, 132, 252, 0.5));
      transform: scale(1.05);
    }
    
    .header-title h1 {
      font-size: 42px;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
      line-height: 1.3;
      text-shadow: 0 2px 20px rgba(0,0,0,0.2);
      display: flex !important;
      flex-direction: column !important;
      gap: 8px;
      align-items: flex-start;
    }
    
    .header-title h1 .title-line {
      font-size: 28px !important;
      font-weight: 600;
      display: block;
    }
    
    .header-title h1 .name-line {
      font-size: 42px !important;
      font-weight: 700;
      display: block;
    }
    
    /* Header Right: Action Buttons */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    /* ==========================================================================
       BUTTONS - Shared button styles
       ========================================================================== */
    .logout-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(239,68,68,0.2);
      display: none;
    }
    
    .logout-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    .logout-btn:hover::before {
      left: 100%;
    }
    
    .logout-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 20px rgba(239,68,68,0.4);
    }
    
    .logout-btn:active {
      transform: translateY(-1px) scale(0.95);
    }
    
    .forum-btn,
    .account-btn {
      padding: 12px 24px;
      background-image: linear-gradient(120deg, rgba(125, 211, 252, 0.25), rgba(192, 132, 252, 0.25));
      border: 1px solid rgba(125, 211, 252, 0.35);
      box-shadow: 0 10px 30px rgba(125, 211, 252, 0.2);
      color: white;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    .forum-btn:hover,
    .account-btn:hover {
      box-shadow: 0 15px 35px rgba(125, 211, 252, 0.35);
      border-color: rgba(125, 211, 252, 0.55);
      transform: translateY(-2px);
    }
    
    .forum-btn {
      position: relative;
    }
    
    .forum-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: linear-gradient(120deg, #fb7185, #f43f5e);
      box-shadow: 0 0 12px rgba(244, 63, 94, 0.6);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 7px;
      border-radius: 10px;
      animation: pulse 2s infinite;
    }
    
    /* ==========================================================================
       ACCOUNT DROPDOWN
       ========================================================================== */
    .account-dropdown {
      position: relative;
      z-index: 10000;
    }
    
    .dropdown-arrow {
      font-size: 10px;
      transition: transform 0.3s ease;
    }
    
    .account-dropdown.open .dropdown-arrow {
      transform: rotate(180deg);
    }
    
    .account-menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: linear-gradient(135deg, rgba(14, 23, 46, 0.88), rgba(29, 38, 72, 0.82));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 35px 80px rgba(2, 6, 23, 0.65), inset 0 1px 0 rgba(255,255,255,0.05);
      border-radius: 12px;
      min-width: 180px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 9999;
    }
    
    .account-dropdown.open .account-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .account-menu-item {
      width: 100%;
      padding: 14px 18px;
      background: transparent;
      border: none;
      color: white;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      text-align: left;
    }
    
    .account-menu-item:first-child {
      border-radius: 12px 12px 0 0;
    }
    
    .account-menu-item:last-child {
      border-radius: 0 0 12px 12px;
    }
    
    .account-menu-item:hover {
      background: rgba(239,68,68,0.15);
      padding-left: 22px;
    }
    
    /* Account Profile Section in Dropdown */
    .account-profile-section {
      padding: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    .account-profile-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    
    .profile-icon {
      font-size: 24px;
    }
    
    .profile-name {
      font-size: 15px;
      font-weight: 600;
      color: white;
    }
    
    .account-profile-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .account-info-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      font-size: 13px;
    }
    
    .account-info-label {
      color: rgba(255,255,255,0.6);
      font-weight: 500;
      min-width: 65px;
    }
    
    .account-info-value {
      color: rgba(255,255,255,0.95);
      font-weight: 500;
      text-align: right;
      flex: 1;
      word-break: break-word;
    }
    
    /* ========================================================================== */
    /* FILE CONTINUATION COMMENT - Due to size limits, this will be split        */
    /* ========================================================================== */
  </style>
</head>
<body>
  <!-- Background decorative layers -->
  <div class="background-layers" aria-hidden="true">
    <div class="logo-watermark"></div>
    <div class="aurora-layer aurora-1"></div>
    <div class="aurora-layer aurora-2"></div>
    <div class="aurora-layer aurora-3"></div>
    <div class="floating-orb orb-1"></div>
    <div class="floating-orb orb-2"></div>
    <div class="floating-orb orb-3"></div>
    <div class="digital-grid"></div>
    <div class="grain-overlay"></div>
  </div>
  
  <!-- ============================================================================
       IMPERSONATION BANNER (Hidden by default, shown during admin impersonation)
       ============================================================================ -->
  <div id="impersonationBanner" class="impersonation-banner" style="display: none;">
    <div class="impersonation-banner-text">
      <span class="impersonation-icon">üëÅÔ∏è</span>
      <span>You are viewing as: <strong id="impersonatedStudentName">Student Name</strong></span>
      <span style="opacity: 0.8; font-size: 12px;" id="impersonationTimer">Expires in 10:00</span>
    </div>
    <button class="exit-impersonation-btn" onclick="exitImpersonation()">
      ‚Üê Exit Impersonation Mode
    </button>
  </div>
  
  <!-- ============================================================================
       MAIN PORTAL CONTENT
       ============================================================================ -->
  <div id="portalContent" style="display: block;">
    <div class="container">
      <!-- ===== HEADER ===== -->
      <div class="header">
        <div class="header-left">
          <img src="richyfesta-logo.png" alt="ARNOMA" class="logo">
          <div class="header-title">
            <h1 id="welcomeMessage" style="opacity: 0; transition: opacity 0.3s ease;">
              <span class="title-line">Welcome,</span>
              <span class="name-line">Loading...</span>
            </h1>
          </div>
        </div>
        <div class="header-actions">
          <button class="forum-btn" id="portalAdminBtn" onclick="window.location.href='Student-Portal-Admin.html'" style="display: none;">
            <span>üéõÔ∏è</span>
            <span>Portal</span>
          </button>
          <button class="forum-btn" onclick="toggleForum()">
            <span>üí¨</span>
            <span>Nurses</span>
            <span class="forum-badge" id="forumBadge" style="display: none;">0</span>
          </button>
          <div class="account-dropdown">
            <button class="account-btn" onclick="toggleAccountDropdown()">
              <span>üë§ My Account</span>
              <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div class="account-menu" id="accountMenu">
              <button class="account-menu-item" onclick="openProfileModal()">
                <span>üë§</span>
                <span>My Profile</span>
              </button>
              <button class="account-menu-item" onclick="logout()">
                <span>üö™</span>
                <span>Sign Out</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ===== CONTENT GRID ===== -->
      <div class="content">
        <!-- Schedule Card -->
        <div class="card">
          <h2 class="card-title">
            <div class="card-title-left">
              Your Schedule<span id="scheduleGroupName" style="color: rgba(255,255,255,0.6); font-weight: 400;"></span>
              <span id="scheduleUpdatedBadge" class="schedule-updated-badge" style="display: none;">Updated</span>
            </div>
          </h2>
          
          <!-- Next Class Countdown Timer -->
          <div class="next-class-timer" id="nextClassTimer">
            <div class="timer-label">Next Class:</div>
            <div class="timer-date" id="nextClassDate">Loading...</div>
            <div class="timer-countdown">
              <span class="timer-icon">‚è≥</span>
              <span class="timer-label-small">Starts in:</span>
              <span class="timer-value" id="countdownValue">--:--:--</span>
            </div>
          </div>
          
          <!-- Schedule Display -->
          <div class="group-schedule" id="groupScheduleDisplay">
            <div class="schedule-empty">Loading schedule...</div>
          </div>
        </div>
        
        <!-- Payment History Card -->
        <div class="card">
          <h2 class="card-title">
            <div class="card-title-left">
              Payment History
            </div>
          </h2>
          
          <!-- Payment Stats - Always Visible -->
          <div class="summary-stats">
            <div class="stat-card" style="border-color: #ef4444;">
              <div class="stat-label">Unpaid</div>
              <div class="stat-value" style="color: #ef4444;" id="totalUnpaid">$0</div>
            </div>
            <div class="stat-card" style="border-color: #22c55e;">
              <div class="stat-label">Last Paid</div>
              <div class="stat-value" style="color: #22c55e;" id="lastPaid">$0</div>
              <div class="stat-date" id="lastPaidDate">-</div>
            </div>
          </div>
          
          <!-- Payment List - Always Visible -->
          <div class="payment-list" id="paymentList" style="margin-top: 15px;">
            <!-- Payment items will be populated here -->
          </div>
        </div>
        
        <!-- Announcements & Changes Card -->
        <div class="card">
          <h2 class="card-title">
            <div class="card-title-left">
              Announcements & Changes
            </div>
          </h2>
          
          <div class="announcements-feed" id="announcementsFeed">
            <div class="announcement-empty">Loading announcements...</div>
          </div>
        </div>
      </div>
      
      <!-- NOTE: Additional sections continue below -->
      <!-- This file will be split due to character limits -->
    </div>
  </div>
  
  <script>
    // ==========================================================================
    // SUPABASE CONFIGURATION
    // ==========================================================================
    const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ==========================================================================
    // GLOBAL STATE VARIABLES
    // ==========================================================================
    let currentStudent = null;
    let currentEmail = null;
    let isAdmin = false;
    let impersonationMode = false;
    let impersonationToken = null;
    let impersonationTimer = null;
    let countdownInterval = null;
    let currentGroupScheduleData = null;
    let currentGroupScheduleSummary = null;
    let currentPayments = [];
    let allSystemNotes = [];
    let selectedSystem = null;
    let systemMetaMap = new Map();
    let systemAssignmentStats = new Map();
    let nclexSystems = [];
    let forumMessages = [];
    let forumUpdateInterval = null;
    let sessionId = null;
    let sessionHeartbeatInterval = null;
    
    // ==========================================================================
    // AUTHENTICATION
    // ==========================================================================
    async function checkAuthentication() {
      // Check for impersonation mode first
      const urlParams = new URLSearchParams(window.location.search);
      const impersonateId = urlParams.get('impersonate');
      
      if (impersonateId) {
        console.debug('üé≠ Impersonation mode detected');
        const tokenData = sessionStorage.getItem('impersonation_token');
        
        if (tokenData) {
          impersonationToken = JSON.parse(tokenData);
          
          // Validate token hasn't expired
          if (impersonationToken.expiresAt < Date.now()) {
            alert('Impersonation session has expired. Returning to admin panel.');
            exitImpersonation();
            return null;
          }
          
          // Validate student ID matches
          if (impersonationToken.studentId != impersonateId) {
            console.error('‚ùå Student ID mismatch!');
            alert('Invalid impersonation token. Returning to admin panel.');
            exitImpersonation();
            return null;
          }
          
          // Enable impersonation mode
          impersonationMode = true;
          
          // Load the impersonated student's data
          const { data: student, error } = await supabase
            .from('students')
            .select('*')
            .eq('id', impersonateId)
            .single();
          
          if (error || !student) {
            console.error('Impersonated student not found:', error);
            alert('Student not found. Returning to admin panel.');
            exitImpersonation();
            return null;
          }
          
          currentStudent = student;
          currentEmail = student.email;
          
          // Keep banner name in sync
          impersonationToken.studentName = student.name || impersonationToken.studentName;
          impersonationToken.studentId = student.id;
          sessionStorage.setItem('impersonation_token', JSON.stringify(impersonationToken));
          
          // Show impersonation banner
          showImpersonationBanner(impersonationToken);
          
          // Add impersonating class to body
          document.body.classList.add('impersonating');
          
          // FORCE HIDE Portal Admin button during impersonation
          const portalBtn = document.getElementById('portalAdminBtn');
          if (portalBtn) {
            portalBtn.style.display = 'none';
            portalBtn.disabled = true;
          }
          
          await loadPortalData();
          return student;
        } else {
          alert('No valid impersonation token found. Returning to admin panel.');
          exitImpersonation();
          return null;
        }
      }
      
      // Normal authentication flow
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session || !session.user) {
        window.location.href = 'Login.html';
        return null;
      }
      
      currentEmail = session.user.email;
      
      // Try to find student record by email
      const { data: studentRecord, error: studentError } = await supabase
        .from('students')
        .select('*')
        .eq('email', currentEmail)
        .single();
      
      // Check if admin by verifying against admin_accounts table
      const { data: adminAccounts, error: adminError } = await supabase
        .from('admin_accounts')
        .select('*')
        .eq('email', currentEmail)
        .maybeSingle();
      
      // Admin must be in admin_accounts table AND not have a student record
      const isAdminUser = adminAccounts && !adminError && !studentRecord;
      
      if (isAdminUser) {
        isAdmin = true;
        
        // Show Portal Admin button for admin
        const portalBtn = document.getElementById('portalAdminBtn');
        if (portalBtn) {
          portalBtn.style.display = 'flex';
        }
        
        // For admin, load any student (can be selected later)
        const { data: students, error } = await supabase
          .from('students')
          .select('*')
          .limit(1)
          .single();
        
        if (error) {
          console.error('Error loading student data:', error);
          alert('No students found in database');
          return null;
        }
        
        currentStudent = students;
        await loadPortalData();
        return students;
      } else if (studentRecord) {
        // Regular student login
        isAdmin = false;
        
        // FORCE HIDE Portal Admin button for students
        const portalBtn = document.getElementById('portalAdminBtn');
        if (portalBtn) {
          portalBtn.style.display = 'none';
          portalBtn.remove(); // Remove from DOM entirely
        }
        
        currentStudent = studentRecord;
        await loadPortalData();
        return studentRecord;
      } else {
        // No student record and not admin - deny access
        console.error('Access denied - no student or admin record found');
        await supabase.auth.signOut();
        window.location.href = 'Login.html';
        return null;
      }
    }
    
    // ==========================================================================
    // INITIALIZATION
    // ==========================================================================
    (async function() {
      try {
        // SECURITY: Hide Portal Admin button by default
        const portalBtn = document.getElementById('portalAdminBtn');
        if (portalBtn) {
          portalBtn.style.display = 'none';
        }
        
        // Check authentication and load student
        currentStudent = await checkAuthentication();
        
        if (!currentStudent) {
          return;
        }
        
        // Start session tracking
        await startSession();
        
        // Student authenticated successfully - load portal data
        await loadPortalData();
        
      } catch (error) {
        console.error('Authentication error:', error);
        window.location.href = 'Login.html';
      }
    })();
    
    // NOTE: Remaining JavaScript functions will continue in actual implementation
    // This reorganized version demonstrates the structure and organization pattern
    
    console.log('‚úÖ Student Portal JavaScript initialized');
  </script>
</body>
</html>
