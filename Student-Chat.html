<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARNOMA Student Chat</title>
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.18);
      --stroke2: rgba(255,255,255,.28);
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --glowCyan: 0 0 24px rgba(34,211,238,.35);
      --glowViolet: 0 0 28px rgba(167,139,250,.30);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.60);
      --danger: rgba(255,80,80,.85);
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: transparent;
      padding: 0;
      overflow: hidden;
    }

    /* Chat Container (Floating Popup - Bottom Right) */
    .chat-container {
      position: fixed;
      right: 18px;
      bottom: 86px;
      width: 380px;
      max-width: calc(100vw - 36px);
      height: 560px;
      max-height: calc(100vh - 140px);
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background:
        radial-gradient(120% 120% at 10% 0%, rgba(34,211,238,.22), transparent 55%),
        radial-gradient(140% 140% at 90% 10%, rgba(167,139,250,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transform-origin: 90% 100%;
      animation: chatSlideIn 0.3s ease-out;
    }

    @keyframes chatSlideIn {
      from {
        opacity: 0;
        transform: scale(0.96) translateY(8px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* Header */
    .chat-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    }

    .chat-title {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .chat-avatar {
      width: 36px;
      height: 36px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.20);
      background:
        radial-gradient(100% 100% at 20% 20%, rgba(34,211,238,.28), transparent 55%),
        radial-gradient(120% 120% at 80% 10%, rgba(167,139,250,.22), transparent 60%),
        rgba(255,255,255,.06);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      display: grid;
      place-items: center;
      flex: 0 0 auto;
    }

    .chat-avatar span {
      font-weight: 900;
      font-size: 14px;
      color: rgba(255,255,255,.92);
      letter-spacing: .2px;
    }

    .chat-meta {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-meta .name {
      font-size: 14px;
      font-weight: 800;
      color: var(--txt);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-meta .status {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(34,211,238,.85);
      box-shadow: 0 0 14px rgba(34,211,238,.45);
    }

    .chat-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .chat-icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
    }

    .chat-icon-btn:hover {
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.26);
      background: rgba(255,255,255,.09);
    }

    .chat-icon-btn svg {
      width: 16px;
      height: 16px;
      opacity: .92;
    }

    /* Body */
    .chat-body {
      flex: 1;
      padding: 14px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.20) transparent;
    }

    .chat-body::-webkit-scrollbar {
      width: 10px;
    }

    .chat-body::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.16);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }

    .chat-day {
      text-align: center;
      font-size: 11px;
      color: rgba(255,255,255,.55);
      margin: 6px 0 12px;
      letter-spacing: .2px;
    }

    .msg {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      align-items: flex-end;
    }

    .msg.me {
      justify-content: flex-end;
    }

    .bubble {
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
      line-height: 1.35;
      font-size: 13px;
      word-wrap: break-word;
    }

    .msg.me .bubble {
      background:
        linear-gradient(135deg, rgba(34,211,100,.22), rgba(16,185,129,.18)),
        rgba(255,255,255,.06);
      border-color: rgba(34,211,100,.30);
      box-shadow: 0 12px 30px rgba(0,0,0,.28), 0 0 20px rgba(34,211,100,.15);
    }

    .msg.admin .bubble {
      background:
        linear-gradient(135deg, rgba(239,68,68,.22), rgba(220,38,38,.18)),
        rgba(255,255,255,.06);
      border-color: rgba(239,68,68,.30);
      box-shadow: 0 12px 30px rgba(0,0,0,.28), 0 0 20px rgba(239,68,68,.15);
    }

    /* Other students - blue style */
    .msg.other-student .bubble {
      background:
        linear-gradient(135deg, rgba(59,130,246,.22), rgba(37,99,235,.18)),
        rgba(255,255,255,.06);
      border-color: rgba(59,130,246,.30);
      box-shadow: 0 12px 30px rgba(0,0,0,.28), 0 0 20px rgba(59,130,246,.15);
    }

    /* Private messages - gray style */
    .msg.private .bubble {
      background:
        linear-gradient(135deg, rgba(148,163,184,.18), rgba(100,116,139,.14)),
        rgba(255,255,255,.06);
      border-color: rgba(148,163,184,.25);
      box-shadow: 0 12px 30px rgba(0,0,0,.28), 0 0 18px rgba(148,163,184,.10);
    }

    /* System message style */
    .system-msg {
      text-align: center;
      margin: 14px 0;
      font-size: 12px;
      color: rgba(255,255,255,.50);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .system-msg::before,
    .system-msg::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(255,255,255,.15), transparent);
      max-width: 60px;
    }

    .system-msg-text {
      background: rgba(148,163,184,.12);
      border: 1px solid rgba(148,163,184,.18);
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 11px;
      letter-spacing: .3px;
    }

    .meta-line {
      margin-top: 6px;
      font-size: 11px;
      color: rgba(255,255,255,.55);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .sender-info {
      font-weight: 600;
      font-size: 11px;
    }

    .college-info {
      font-size: 10px;
      opacity: 0.75;
    }

    /* Typing */
    .typing {
      display: none;
      margin: 10px 0 0;
      font-size: 12px;
      color: rgba(255,255,255,.55);
      align-items: center;
      gap: 8px;
    }

    .typing.show {
      display: flex;
    }

    .typing .dots {
      display: inline-flex;
      gap: 4px;
    }

    .typing .dots i {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.45);
      animation: chatDot 1.1s infinite ease-in-out;
    }

    .typing .dots i:nth-child(2) {
      animation-delay: .15s;
    }

    .typing .dots i:nth-child(3) {
      animation-delay: .30s;
    }

    @keyframes chatDot {
      0%, 100% {
        transform: translateY(0);
        opacity: .45;
      }
      50% {
        transform: translateY(-3px);
        opacity: .85;
      }
    }

    /* Footer */
    .chat-foot {
      padding: 12px 12px 14px;
      border-top: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.07));
    }

    .chat-compose {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      min-height: 42px;
      max-height: 110px;
      resize: none;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      padding: 10px 12px;
      outline: none;
      line-height: 1.35;
      font-size: 13px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }

    .chat-input::placeholder {
      color: rgba(255,255,255,.45);
    }

    .chat-input:focus {
      border-color: rgba(34,211,238,.30);
      box-shadow: inset 0 0 0 1px rgba(34,211,238,.10);
    }

    .chat-send {
      width: 46px;
      height: 42px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(120% 120% at 20% 20%, rgba(34,211,238,.26), transparent 55%),
        radial-gradient(120% 120% at 80% 10%, rgba(167,139,250,.18), transparent 60%),
        rgba(255,255,255,.07);
      color: var(--txt);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
    }

    .chat-send:hover {
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.26);
      filter: brightness(1.05);
    }

    .chat-send:active {
      transform: translateY(0) scale(.98);
    }

    .chat-send svg {
      width: 16px;
      height: 16px;
      opacity: .95;
    }

    .chat-send-admin {
      width: 46px;
      height: 42px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.30);
      background:
        radial-gradient(120% 120% at 20% 20%, rgba(239,68,68,.28), transparent 55%),
        radial-gradient(120% 120% at 80% 10%, rgba(220,38,38,.22), transparent 60%),
        rgba(255,255,255,.07);
      color: var(--txt);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      margin-left: 4px;
    }

    .chat-send-admin:hover {
      transform: translateY(-1px);
      border-color: rgba(239,68,68,.45);
      filter: brightness(1.08);
    }

    .chat-send-admin:active {
      transform: translateY(0) scale(.98);
    }

    .chat-send-admin svg {
      width: 16px;
      height: 16px;
      opacity: .95;
    }

    /* Private chat tooltip */
    .private-indicator {
      display: none; /* Hidden - we use system message instead */
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 14px;
    }

    /* Mobile */
    @media (max-width: 420px) {
      .chat-container {
        width: calc(100vw - 36px);
        height: calc(100vh - 140px);
        right: 18px;
        bottom: 86px;
      }
    }
    
    @media (max-width: 768px) {
      .chat-container {
        right: 14px;
        bottom: 80px;
        width: calc(100vw - 28px);
      }
    }
  </style>
</head>
<body>

<div class="chat-container">
  <div class="chat-head">
    <div class="chat-title">
      <div class="chat-avatar"><span id="chatAvatar">A</span></div>
      <div class="chat-meta">
        <div class="name" id="chatStudentName">Chat</div>
        <div class="status"><span class="dot"></span><span id="chatStatus">Group chat with classmates</span></div>
      </div>
    </div>

    <div class="chat-actions">
      <button class="chat-icon-btn" id="chatCloseBtn" title="Close">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="chat-body" id="chatBody">
    <div class="loading" id="loadingState">Loading chat...</div>
    
    <div class="typing" id="chatTyping">
      <span>Typing</span>
      <span class="dots"><i></i><i></i><i></i></span>
    </div>
  </div>

  <div class="chat-foot">
    <div class="private-indicator" id="privateIndicator">ðŸ”’ Private Chat - Only you and the administrator can see this</div>
    <div class="chat-compose">
      <textarea class="chat-input" id="chatInput" rows="1" placeholder="Write a messageâ€¦ (Enter to send)"></textarea>
      <button class="chat-send" id="chatSendBtn" title="Send to everyone">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M4 12l16-8-6.5 16-2.7-6.2L4 12Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </button>
      <button class="chat-send-admin" id="chatSendAdminBtn" title="Send to Admin only (Private)">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 15v-3m0 0V9m0 3h3m-3 0H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M4 12l16-8-6.5 16-2.7-6.2L4 12Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
// Supabase Configuration
const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const DEBUG_MODE = false;
const debugLog = (...args) => DEBUG_MODE && console.log(...args);

(function() {
  const $ = (id) => document.getElementById(id);

  const chatBody = $("chatBody");
  const chatInput = $("chatInput");
  const chatSendBtn = $("chatSendBtn");
  const chatSendAdminBtn = $("chatSendAdminBtn");
  const chatTyping = $("chatTyping");
  const chatCloseBtn = $("chatCloseBtn");
  const loadingState = $("loadingState");
  const chatStudentName = $("chatStudentName");
  const chatAvatar = $("chatAvatar");
  const privateIndicator = $("privateIndicator");

  let currentStudentId = null;
  let currentStudentName = "";
  let currentStudentCollege = "";
  let messagesSubscription = null;
  let messagePollingInterval = null;

  // Check if we're in an iframe
  const isInIframe = window.self !== window.top;

  // Close button - send message to parent if in iframe, otherwise go back
  if (chatCloseBtn) {
    chatCloseBtn.addEventListener('click', () => {
      if (isInIframe) {
        window.parent.postMessage('closeChat', '*');
      } else {
        window.history.back();
      }
    });
  }

  // ESC to close
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      if (isInIframe) {
        window.parent.postMessage('closeChat', '*');
      } else {
        window.history.back();
      }
    }
  });

  // Initialize
  async function init() {
    try {
      // Get student info from session/localStorage
      const studentData = getStudentData();
      if (!studentData) {
        alert('Please log in through the Student Portal first.');
        window.location.href = 'student-portal.html';
        return;
      }

      currentStudentId = studentData.id;
      currentStudentName = studentData.name;

      // Fetch student's college from database
      await fetchStudentCollege();

      // Update header
      chatStudentName.textContent = `Chat`;
      chatAvatar.textContent = studentData.name.charAt(0).toUpperCase();

      // Load existing messages
      await loadMessages();

      // Subscribe to new messages
      subscribeToMessages();

      // Start polling for new messages (every 2 seconds)
      startMessagePolling();

      // Hide loading
      loadingState.style.display = 'none';

      // Focus input
      chatInput.focus();

    } catch (error) {
      console.error('Init error:', error);
      loadingState.textContent = 'Error loading chat. Please refresh.';
    }
  }

  function getStudentData() {
    // Try to get from URL parameters first
    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('studentId');
    const studentName = urlParams.get('studentName');
    
    if (studentId && studentName) {
      return {
        id: parseInt(studentId),
        name: decodeURIComponent(studentName)
      };
    }
    
    // Try from window.opener (if opened from student portal)
    if (window.opener && window.opener.currentStudent) {
      return window.opener.currentStudent;
    }
    
    // Try from window.parent (if in iframe)
    if (window.parent && window.parent !== window && window.parent.currentStudent) {
      return window.parent.currentStudent;
    }
    
    // Fallback to localStorage
    const stored = localStorage.getItem('arnoma:student:session');
    if (stored) {
      try {
        return JSON.parse(stored);
      } catch (e) {
        debugLog('Parse error:', e);
      }
    }
    
    return null;
  }

  async function fetchStudentCollege() {
    try {
      const { data, error } = await supabaseClient
        .from('students')
        .select('college')
        .eq('id', currentStudentId)
        .single();
      
      if (!error && data) {
        currentStudentCollege = data.college || '';
      }
    } catch (error) {
      console.error('Error fetching college:', error);
    }
  }

  async function loadMessages() {
    try {
      // Fetch messages from Supabase
      // Group messages: is_private = false (visible to all)
      // Private messages: is_private = true AND student_id = currentStudentId
      const { data: groupMessages, error: groupError } = await supabaseClient
        .from('chat_messages')
        .select('*')
        .eq('is_private', false)
        .order('created_at', { ascending: true });

      const { data: privateMessages, error: privateError } = await supabaseClient
        .from('chat_messages')
        .select('*')
        .eq('is_private', true)
        .eq('student_id', currentStudentId)
        .order('created_at', { ascending: true });

      if (groupError) {
        console.error('Error loading group messages:', groupError);
      }
      if (privateError) {
        console.error('Error loading private messages:', privateError);
      }

      // Combine and sort all messages
      const allMessages = [...(groupMessages || []), ...(privateMessages || [])];
      allMessages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      
      // Clear chat body except typing indicator
      chatBody.innerHTML = '';
      chatBody.appendChild(chatTyping);

      if (allMessages.length === 0) {
        addDayDivider('Today');
        addWelcomeMessage();
      } else {
        addDayDivider('Today');
        allMessages.forEach(msg => {
          addMessageToUI(
            msg.message, 
            msg.sender_type, 
            msg.created_at, 
            msg.is_private,
            msg.sender_name,
            msg.sender_college
          );
        });
      }

      scrollToBottom();
    } catch (error) {
      console.error('Load messages error:', error);
    }
  }

  function getLocalMessages() {
    // DEPRECATED: Kept for backward compatibility
    // New messages are stored in Supabase
    const key = `arnoma:chat:${currentStudentId}`;
    const stored = localStorage.getItem(key);
    if (stored) {
      try {
        return JSON.parse(stored);
      } catch (e) {
        return [];
      }
    }
    return [];
  }

  function saveLocalMessages(messages) {
    // DEPRECATED: Kept for backward compatibility
    // New messages are saved to Supabase
    const key = `arnoma:chat:${currentStudentId}`;
    localStorage.setItem(key, JSON.stringify(messages));
  }

  function addWelcomeMessage() {
    const welcome = "Hi! ðŸ‘‹ Welcome to the group chat! You can message your classmates here, or send a private message to the admin using the red button.";
    addMessageToUI(welcome, 'admin', new Date().toISOString(), false, 'Admin', '');
  }

  function addDayDivider(text) {
    const div = document.createElement('div');
    div.className = 'chat-day';
    div.textContent = text;
    chatBody.insertBefore(div, chatTyping);
  }

  function addSystemMessage(text) {
    const div = document.createElement('div');
    div.className = 'system-msg';
    div.innerHTML = `<span class="system-msg-text">ðŸ”’ ${text}</span>`;
    chatBody.insertBefore(div, chatTyping);
    scrollToBottom();
  }

  function addMessageToUI(text, sender, timestamp, isPrivate = false, senderName = '', senderCollege = '') {
    const wrap = document.createElement("div");
    
    // Determine message type
    const isMe = sender === "student";
    const isAdmin = sender === "admin";
    const isOtherStudent = !isMe && !isAdmin;
    
    if (isPrivate) {
      wrap.className = "msg private" + (isMe ? " me" : "");
    } else {
      wrap.className = "msg" + (isMe ? " me" : (isAdmin ? " admin" : " other-student"));
    }
    
    const bub = document.createElement("div");
    bub.className = "bubble";
    
    const textNode = document.createTextNode(text);
    bub.appendChild(textNode);

    const meta = document.createElement("div");
    meta.className = "meta-line";
    
    // Build sender info
    const senderInfo = document.createElement("div");
    senderInfo.className = "sender-info";
    
    let displayName = '';
    if (isMe) {
      displayName = senderName || currentStudentName || "You";
    } else if (isAdmin) {
      displayName = "Admin";
    } else {
      displayName = senderName || "Student";
    }
    
    senderInfo.textContent = displayName;
    
    // Add college if available
    if (senderCollege && senderCollege.trim()) {
      const collegeInfo = document.createElement("div");
      collegeInfo.className = "college-info";
      collegeInfo.textContent = senderCollege;
      meta.appendChild(senderInfo);
      meta.appendChild(collegeInfo);
    } else {
      meta.appendChild(senderInfo);
    }
    
    // Add timestamp
    const timeSpan = document.createElement("div");
    timeSpan.style.fontSize = "10px";
    timeSpan.style.opacity = "0.6";
    timeSpan.style.marginTop = "2px";
    timeSpan.textContent = formatTime(timestamp);
    meta.appendChild(timeSpan);
    
    bub.appendChild(meta);
    wrap.appendChild(bub);

    chatBody.insertBefore(wrap, chatTyping);
    scrollToBottom();
  }

  function formatTime(timestamp) {
    const date = new Date(timestamp);
    const h = String(date.getHours()).padStart(2, '0');
    const m = String(date.getMinutes()).padStart(2, '0');
    return `${h}:${m}`;
  }

  function scrollToBottom() {
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function showTyping(on) {
    chatTyping.classList.toggle("show", !!on);
    scrollToBottom();
  }

  async function send(isPrivateToAdmin = false) {
    const text = (chatInput.value || "").trim();
    if (!text) return;

    const timestamp = new Date().toISOString();

    // Show system message if sending private to admin
    if (isPrivateToAdmin) {
      addSystemMessage("Private Chat - Only you and the administrator can see this");
    }

    // Add to UI immediately (optimistic update)
    addMessageToUI(text, "student", timestamp, isPrivateToAdmin, currentStudentName, currentStudentCollege);
    chatInput.value = "";
    resizeInput();

    try {
      // Save to Supabase
      const { data, error } = await supabaseClient
        .from('chat_messages')
        .insert({
          student_id: currentStudentId,
          message: text,
          sender_type: 'student',
          sender_name: currentStudentName,
          sender_college: currentStudentCollege,
          is_private: isPrivateToAdmin
        })
        .select()
        .single();

      if (error) {
        console.error('Error sending message:', error);
        // Optionally show error to user
        addSystemMessage("âš ï¸ Message failed to send. Please try again.");
        return;
      }

      debugLog('âœ… Message sent:', data);

      // Save to localStorage as backup (deprecated but kept for compatibility)
      const messages = getLocalMessages();
      messages.push({
        text: text,
        sender: "student",
        timestamp: timestamp,
        isPrivate: isPrivateToAdmin,
        senderName: currentStudentName,
        senderCollege: currentStudentCollege
      });
      saveLocalMessages(messages);

    } catch (error) {
      console.error('Send error:', error);
      addSystemMessage("âš ï¸ Network error. Please check your connection.");
    }
  }

  function startMessagePolling() {
    // Poll for new messages every 2 seconds
    messagePollingInterval = setInterval(async () => {
      await checkForNewMessages();
    }, 2000);
  }

  async function checkForNewMessages() {
    try {
      // Get current message count in UI
      const currentMessageCount = chatBody.querySelectorAll('.msg').length;
      
      // Fetch latest message count from database
      const { data: groupMessages } = await supabaseClient
        .from('chat_messages')
        .select('id', { count: 'exact', head: false })
        .eq('is_private', false);

      const { data: privateMessages } = await supabaseClient
        .from('chat_messages')
        .select('id', { count: 'exact', head: false })
        .eq('is_private', true)
        .eq('student_id', currentStudentId);

      const totalMessages = (groupMessages?.length || 0) + (privateMessages?.length || 0);

      if (totalMessages > currentMessageCount) {
        // New message detected, reload messages
        await loadMessages();
      }
    } catch (error) {
      debugLog('Polling error:', error);
    }
  }

  function resizeInput() {
    chatInput.style.height = "auto";
    chatInput.style.height = Math.min(chatInput.scrollHeight, 110) + "px";
  }

  function subscribeToMessages() {
    // Real-time subscription for instant message updates
    messagesSubscription = supabaseClient
      .channel('chat_messages_channel')
      .on(
        'postgres_changes',
        { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'chat_messages' 
        },
        async (payload) => {
          debugLog('ðŸ“¨ New message received:', payload.new);
          
          // Check if this message is relevant to current student
          const newMsg = payload.new;
          const isRelevant = 
            !newMsg.is_private || // Group message (visible to all)
            newMsg.student_id === currentStudentId; // Private message for this student

          if (isRelevant && newMsg.student_id !== currentStudentId) {
            // Only add if it's not our own message (we already added it optimistically)
            // or if it's from someone else
            addMessageToUI(
              newMsg.message,
              newMsg.sender_type,
              newMsg.created_at,
              newMsg.is_private,
              newMsg.sender_name,
              newMsg.sender_college
            );
          }
        }
      )
      .subscribe((status) => {
        debugLog('ðŸ“¡ Subscription status:', status);
      });
  }

  // Events
  chatSendBtn.addEventListener("click", () => send(false));
  chatSendAdminBtn.addEventListener("click", () => send(true));
  
  chatInput.addEventListener("input", resizeInput);
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send(false); // Default to group message on Enter
    }
  });

  // Cleanup on unload
  window.addEventListener('beforeunload', () => {
    if (messagesSubscription) {
      supabase.removeChannel(messagesSubscription);
    }
    if (messagePollingInterval) {
      clearInterval(messagePollingInterval);
    }
  });

  // Start
  init();
  resizeInput();
})();
</script>

</body>
</html>
