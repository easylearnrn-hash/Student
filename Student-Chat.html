<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARNOMA Student Chat</title>
  
  <!-- 
    PERFORMANCE OPTIMIZATIONS APPLIED:
    1. Incremental message loading with timestamp-based queries (load only new messages)
    2. Single OR query instead of multiple separate queries (reduce network calls)
    3. Message deduplication cache to prevent rendering duplicates
    4. DocumentFragment batching for efficient DOM updates
    5. requestAnimationFrame for scroll batching
    6. CSS containment (contain: layout style) for message isolation
    7. GPU acceleration (transform: translateZ(0)) for smooth rendering
    8. Intelligent polling: only when real-time subscription fails (5s interval)
    9. Non-blocking college fetch - load messages first, fetch metadata async
    10. HTML string concatenation instead of createElement() chains
    11. Debounced scroll requests to prevent layout thrashing
    12. will-change hints for browser optimization
  -->
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.18);
      --stroke2: rgba(255,255,255,.28);
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --glowCyan: 0 0 24px rgba(34,211,238,.35);
      --glowViolet: 0 0 28px rgba(167,139,250,.30);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.60);
      --danger: rgba(255,80,80,.85);
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: transparent;
      padding: 0;
      overflow: visible;
      pointer-events: auto;
    }

    /* Chat Container (Floating Popup - Bottom Right) */
    .chat-container {
      position: fixed;
      right: 0;
      bottom: 0;
      width: 400px;
      max-width: 100vw;
      height: 650px;
      max-height: 100vh;
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background:
        radial-gradient(120% 120% at 10% 0%, rgba(34,211,238,.22), transparent 55%),
        radial-gradient(140% 140% at 90% 10%, rgba(167,139,250,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transform-origin: bottom right;
      animation: chatPopIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: auto;
      z-index: 9999;
    }

    @keyframes chatPopIn {
      0% {
        opacity: 0;
        transform: scale(0.85) translateY(20px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* Header */
    .chat-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      cursor: pointer;
      user-select: none;
      transition: background 0.15s ease;
    }
    
    .chat-head:hover {
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
    }

    .chat-title {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .chat-avatar {
      width: 36px;
      height: 36px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.20);
      background:
        radial-gradient(100% 100% at 20% 20%, rgba(34,211,238,.28), transparent 55%),
        radial-gradient(120% 120% at 80% 10%, rgba(167,139,250,.22), transparent 60%),
        rgba(255,255,255,.06);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      display: grid;
      place-items: center;
      flex: 0 0 auto;
    }

    .chat-avatar span {
      font-weight: 900;
      font-size: 14px;
      color: rgba(255,255,255,.92);
      letter-spacing: .2px;
    }

    .chat-meta {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-meta .name {
      font-size: 14px;
      font-weight: 800;
      color: var(--txt);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-meta .status {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(34,211,238,.85);
      box-shadow: 0 0 14px rgba(34,211,238,.45);
    }

    .chat-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .chat-icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
    }

    .chat-icon-btn:hover {
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.26);
      background: rgba(255,255,255,.09);
    }

    .chat-icon-btn svg {
      width: 16px;
      height: 16px;
      opacity: .92;
    }

    /* Body */
    .chat-body {
      flex: 1;
      padding: 14px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.20) transparent;
      /* Performance optimizations */
      will-change: scroll-position;
      contain: layout style paint;
      -webkit-overflow-scrolling: touch;
    }

    .chat-body::-webkit-scrollbar {
      width: 10px;
    }

    .chat-body::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.16);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }

    .chat-day {
      text-align: center;
      font-size: 11px;
      color: rgba(255,255,255,.55);
      margin: 6px 0 12px;
      letter-spacing: .2px;
    }

    .msg {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      align-items: flex-end;
      /* Performance: contain layout changes */
      contain: layout style;
    }

    .msg.me {
      justify-content: flex-end;
    }

    .bubble {
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
      line-height: 1.35;
      font-size: 13px;
      word-wrap: break-word;
      /* Performance: enable GPU acceleration for transforms */
      transform: translateZ(0);
      will-change: transform;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .bubble:hover {
      border-color: rgba(167,139,250,.35);
      background: rgba(255,255,255,.10);
      box-shadow: 0 14px 32px rgba(0,0,0,.30);
    }
    
    .bubble:active {
      transform: translateZ(0) scale(0.98);
    }

    .msg.me .bubble {
      background:
        linear-gradient(135deg, rgba(34,211,100,.22), rgba(16,185,129,.18)),
        rgba(255,255,255,.06);
      border-color: rgba(34,211,100,.30);
      box-shadow: 0 12px 30px rgba(0,0,0,.28), 0 0 20px rgba(34,211,100,.15);
    }

    .msg.admin .bubble {
      background:
        linear-gradient(135deg, rgba(239,68,68,.22), rgba(220,38,38,.18)),
        rgba(255,255,255,.06);
      border-color: rgba(239,68,68,.30);
      box-shadow: 0 12px 30px rgba(0,0,0,.28), 0 0 20px rgba(239,68,68,.15);
    }

    /* Announcement messages - prominent red centered style */
    .msg.announcement {
      text-align: center;
      max-width: 85%;
      margin: 20px auto;
    }
    
    .msg.announcement .bubble {
      background:
        linear-gradient(135deg, rgba(239,68,68,.30), rgba(220,38,38,.25)),
        rgba(255,255,255,.08);
      border: 2px solid rgba(239,68,68,.50);
      box-shadow: 0 12px 40px rgba(0,0,0,.35), 0 0 30px rgba(239,68,68,.30);
      font-weight: 500;
    }

    /* Other students - blue style */
    .msg.other-student .bubble {
      background:
        linear-gradient(135deg, rgba(59,130,246,.22), rgba(37,99,235,.18)),
        rgba(255,255,255,.06);
      border-color: rgba(59,130,246,.30);
      box-shadow: 0 12px 30px rgba(0,0,0,.28), 0 0 20px rgba(59,130,246,.15);
    }

    /* Private messages - gray style */
    .msg.private .bubble {
      background:
        linear-gradient(135deg, rgba(148,163,184,.18), rgba(100,116,139,.14)),
        rgba(255,255,255,.06);
      border-color: rgba(148,163,184,.25);
      box-shadow: 0 12px 30px rgba(0,0,0,.28), 0 0 18px rgba(148,163,184,.10);
    }

    /* System message style */
    .system-msg {
      text-align: center;
      margin: 14px 0;
      font-size: 12px;
      color: rgba(255,255,255,.50);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .system-msg::before,
    .system-msg::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(255,255,255,.15), transparent);
      max-width: 60px;
    }

    .system-msg-text {
      background: rgba(148,163,184,.12);
      border: 1px solid rgba(148,163,184,.18);
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 11px;
      letter-spacing: .3px;
    }

    .meta-line {
      margin-top: 6px;
      font-size: 11px;
      color: rgba(255,255,255,.55);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .sender-info {
      font-weight: 600;
      font-size: 11px;
    }

    .college-info {
      font-size: 10px;
      opacity: 0.75;
    }

    /* Typing */
    .typing {
      display: none;
      margin: 10px 0 0;
      font-size: 12px;
      color: rgba(255,255,255,.55);
      align-items: center;
      gap: 8px;
    }

    .typing.show {
      display: flex;
    }

    .typing .dots {
      display: inline-flex;
      gap: 4px;
    }

    .typing .dots i {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.45);
      animation: chatDot 1.1s infinite ease-in-out;
    }

    .typing .dots i:nth-child(2) {
      animation-delay: .15s;
    }

    .typing .dots i:nth-child(3) {
      animation-delay: .30s;
    }

    @keyframes chatDot {
      0%, 100% {
        transform: translateY(0);
        opacity: .45;
      }
      50% {
        transform: translateY(-3px);
        opacity: .85;
      }
    }

    /* Footer */
    .chat-foot {
      padding: 12px 12px 14px;
      border-top: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.07));
    }

    .chat-compose {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      position: relative;
    }

    .chat-input {
      flex: 1;
      min-height: 42px;
      max-height: 110px;
      resize: none;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      padding: 10px 44px 10px 12px;
      outline: none;
      line-height: 1.35;
      font-size: 13px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }

    .chat-input::placeholder {
      color: rgba(255,255,255,.45);
    }

    .chat-input:focus {
      border-color: rgba(34,211,238,.30);
      box-shadow: inset 0 0 0 1px rgba(34,211,238,.10);
    }

    .chat-send {
      width: 46px;
      height: 42px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(120% 120% at 20% 20%, rgba(34,211,238,.26), transparent 55%),
        radial-gradient(120% 120% at 80% 10%, rgba(167,139,250,.18), transparent 60%),
        rgba(255,255,255,.07);
      color: var(--txt);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
    }

    .chat-send:hover {
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.26);
      filter: brightness(1.05);
    }

    .chat-send:active {
      transform: translateY(0) scale(.98);
    }

    .chat-send svg {
      width: 16px;
      height: 16px;
      opacity: .95;
    }

    .chat-send-admin {
      width: 46px;
      height: 42px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.30);
      background:
        radial-gradient(120% 120% at 20% 20%, rgba(239,68,68,.28), transparent 55%),
        radial-gradient(120% 120% at 80% 10%, rgba(220,38,38,.22), transparent 60%),
        rgba(255,255,255,.07);
      color: var(--txt);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      margin-left: 4px;
    }

    .chat-send-admin:hover {
      transform: translateY(-1px);
      border-color: rgba(239,68,68,.45);
      filter: brightness(1.08);
    }

    .chat-send-admin:active {
      transform: translateY(0) scale(.98);
    }

    .chat-send-admin svg {
      width: 16px;
      height: 16px;
      opacity: .95;
    }

    /* File Upload Button */
    .chat-upload {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 26px;
      height: 26px;
      border: none;
      background: transparent;
      color: rgba(156,220,254,.85);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: transform .15s ease, color .15s ease;
      padding: 0;
      z-index: 10;
    }

    .chat-upload:hover {
      transform: translateY(-50%) scale(1.10);
      color: rgba(156,220,254,1);
    }

    .chat-upload:active {
      transform: translateY(-50%) scale(0.95);
    }

    .chat-upload svg {
      width: 18px;
      height: 18px;
      opacity: .90;
    }

    .chat-upload input[type="file"] {
      display: none;
    }

    /* Reply Preview */
    .reply-preview {
      display: none;
      padding: 10px 12px;
      margin: 8px 0 0;
      background: rgba(167,139,250,.08);
      border-left: 3px solid rgba(167,139,250,.65);
      border-radius: 8px;
      position: relative;
    }

    .reply-preview.show {
      display: block;
    }

    .reply-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .reply-preview-label {
      font-size: 11px;
      font-weight: 600;
      color: rgba(167,139,250,.95);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .reply-preview-close {
      background: none;
      border: none;
      color: rgba(255,255,255,.60);
      cursor: pointer;
      padding: 2px;
      display: grid;
      place-items: center;
      border-radius: 4px;
      transition: all 0.15s ease;
    }

    .reply-preview-close:hover {
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
    }

    .reply-preview-close svg {
      width: 14px;
      height: 14px;
    }

    .reply-preview-sender {
      font-size: 12px;
      font-weight: 600;
      color: rgba(255,255,255,.85);
      margin-bottom: 2px;
    }

    .reply-preview-text {
      font-size: 12px;
      color: rgba(255,255,255,.60);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 300px;
    }

    /* File Preview */
    .file-preview {
      display: none;
      padding: 12px;
      margin: 8px 0;
      background: rgba(156,220,254,.10);
      border: 1px solid rgba(156,220,254,.25);
      border-radius: 12px;
      align-items: center;
      gap: 12px;
    }

    .file-preview.active {
      display: flex;
    }

    .file-preview-icon {
      width: 40px;
      height: 40px;
      background: rgba(156,220,254,.20);
      border-radius: 8px;
      display: grid;
      place-items: center;
      flex-shrink: 0;
    }

    .file-preview-icon svg {
      width: 24px;
      height: 24px;
      color: var(--accent-blue);
    }

    .file-preview-info {
      flex: 1;
      min-width: 0;
    }

    .file-preview-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--txt);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-preview-size {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .file-preview-remove {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid rgba(239,68,68,.30);
      background: rgba(239,68,68,.15);
      color: #ff6b6b;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: all .15s ease;
      flex-shrink: 0;
    }

    .file-preview-remove:hover {
      background: rgba(239,68,68,.25);
      border-color: rgba(239,68,68,.45);
    }

    .file-preview-remove svg {
      width: 14px;
      height: 14px;
    }

    /* Message with attachment */
    .msg.has-attachment {
      max-width: 90%;
    }

    .msg-attachment {
      margin-top: 8px;
      padding: 10px;
      background: rgba(0,0,0,.15);
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .msg-attachment-icon {
      width: 36px;
      height: 36px;
      background: rgba(156,220,254,.20);
      border-radius: 6px;
      display: grid;
      place-items: center;
      flex-shrink: 0;
    }

    .msg-attachment-icon svg {
      width: 20px;
      height: 20px;
      color: var(--accent-blue);
    }

    .msg-attachment-info {
      flex: 1;
      min-width: 0;
    }

    .msg-attachment-name {
      font-size: 12px;
      font-weight: 500;
      color: rgba(255,255,255,.95);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .msg-attachment-size {
      font-size: 10px;
      color: rgba(255,255,255,.55);
      margin-top: 2px;
    }

    .msg-attachment-download {
      padding: 6px 12px;
      background: rgba(156,220,254,.20);
      border: 1px solid rgba(156,220,254,.30);
      border-radius: 6px;
      color: var(--accent-blue);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all .15s ease;
      flex-shrink: 0;
    }

    .msg-attachment-download:hover {
      background: rgba(156,220,254,.30);
      border-color: rgba(156,220,254,.45);
    }

    /* Private chat tooltip */
    .private-indicator {
      display: none; /* Hidden - we use system message instead */
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 14px;
    }

    /* Mobile */
    @media (max-width: 420px) {
      .chat-container {
        width: 100vw;
        height: calc(100vh - 60px);
        right: 0;
        bottom: 0;
      }
    }
    
    @media (max-width: 768px) {
      .chat-container {
        right: 0;
        bottom: 0;
        width: 100vw;
      }
    }
  </style>
</head>
<body>

<div class="chat-container">
  <div class="chat-head">
    <div class="chat-title">
      <div class="chat-avatar"><span id="chatAvatar">A</span></div>
      <div class="chat-meta">
        <div class="name" id="chatStudentName">Chat</div>
        <div class="status"><span class="dot"></span><span id="chatStatus">Group chat with classmates</span></div>
      </div>
    </div>

    <div class="chat-actions">
      <button class="chat-icon-btn" id="chatCloseBtn" title="Close">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="chat-body" id="chatBody">
    <div class="loading" id="loadingState">Loading chat...</div>
    
    <div class="typing" id="chatTyping">
      <span>Typing</span>
      <span class="dots"><i></i><i></i><i></i></span>
    </div>
  </div>

  <div class="chat-foot">
    <div class="private-indicator" id="privateIndicator">ðŸ”’ Private Chat - Only you and the administrator can see this</div>
    
    <!-- Reply Preview -->
    <div class="reply-preview" id="replyPreview">
      <div class="reply-preview-header">
        <span class="reply-preview-label">Replying to</span>
        <button class="reply-preview-close" id="replyPreviewClose" title="Cancel reply">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="reply-preview-sender" id="replyPreviewSender">Student Name</div>
      <div class="reply-preview-text" id="replyPreviewText">Original message text...</div>
    </div>
    
    <!-- File Preview -->
    <div class="file-preview" id="filePreview">
      <div class="file-preview-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
          <polyline points="13 2 13 9 20 9"></polyline>
        </svg>
      </div>
      <div class="file-preview-info">
        <div class="file-preview-name" id="fileName">document.pdf</div>
        <div class="file-preview-size" id="fileSize">0 KB</div>
      </div>
      <button class="file-preview-remove" id="fileRemoveBtn" title="Remove file">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="chat-compose">
      <div style="position: relative; flex: 1;">
        <textarea class="chat-input" id="chatInput" rows="1" placeholder="Write a messageâ€¦"></textarea>
        <!-- File Upload Button (Inside Textarea) -->
        <button class="chat-upload" title="Attach file" onclick="document.getElementById('fileInput').click()">
          <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.gif" style="display:none">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
          </svg>
        </button>
      </div>

      <button class="chat-send" id="chatSendBtn" title="Send to everyone">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M4 12l16-8-6.5 16-2.7-6.2L4 12Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </button>
      <button class="chat-send-admin" id="chatSendAdminBtn" title="Send to Admin only (Private)">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 15v-3m0 0V9m0 3h3m-3 0H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M4 12l16-8-6.5 16-2.7-6.2L4 12Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
// Supabase Configuration
const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const DEBUG_MODE = false;
const debugLog = (...args) => DEBUG_MODE && console.log(...args);

(function() {
  const $ = (id) => document.getElementById(id);

  const chatBody = $("chatBody");
  const chatInput = $("chatInput");
  const chatSendBtn = $("chatSendBtn");
  const chatSendAdminBtn = $("chatSendAdminBtn");
  const chatTyping = $("chatTyping");
  const chatCloseBtn = $("chatCloseBtn");
  const chatHead = document.querySelector(".chat-head");
  const loadingState = $("loadingState");
  const chatStudentName = $("chatStudentName");
  const chatAvatar = $("chatAvatar");
  const privateIndicator = $("privateIndicator");
  const fileInput = $("fileInput");
  const filePreview = $("filePreview");
  const fileName = $("fileName");
  const fileSize = $("fileSize");
  const fileRemoveBtn = $("fileRemoveBtn");
  const replyPreview = $("replyPreview");
  const replyPreviewSender = $("replyPreviewSender");
  const replyPreviewText = $("replyPreviewText");
  const replyPreviewClose = $("replyPreviewClose");

  let currentStudentId = null;
  let currentStudentName = "";
  let currentStudentCollege = "";
  let messagesSubscription = null;
  let messagePollingInterval = null;
  let selectedFile = null;
  
  // Performance optimizations
  let lastMessageTimestamp = null;
  let messageCache = new Map();
  let isLoadingMessages = false;
  let pendingScrollRequest = false;
  
  // Reply functionality
  let replyingTo = null;

  // Check if we're in an iframe
  const isInIframe = window.self !== window.top;

  // Function to close chat
  const closeChat = () => {
    if (isInIframe) {
      window.parent.postMessage('closeChat', '*');
    } else {
      window.history.back();
    }
  };

  // Close button
  if (chatCloseBtn) {
    chatCloseBtn.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent header click from firing
      closeChat();
    });
  }

  // Header click to close
  if (chatHead) {
    chatHead.addEventListener('click', closeChat);
  }

  // ESC to close
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeChat();
    }
  });

  // File Upload Functions
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate file size (max 10MB)
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
      alert('File size must be less than 10MB');
      event.target.value = '';
      return;
    }

    selectedFile = file;
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    filePreview.classList.add('active');
  }

  function removeFile() {
    selectedFile = null;
    fileInput.value = '';
    filePreview.classList.remove('active');
  }

  // Reply Functions
  function setReplyTo(senderName, messageText) {
    replyingTo = {
      sender: senderName,
      text: messageText
    };
    replyPreviewSender.textContent = senderName;
    replyPreviewText.textContent = messageText || '(attachment)';
    replyPreview.classList.add('show');
    chatInput.focus();
  }

  function clearReply() {
    replyingTo = null;
    replyPreview.classList.remove('show');
  }

  async function uploadFileToStorage(file) {
    try {
      const fileExt = file.name.split('.').pop();
      const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
      const filePath = `chat-attachments/${fileName}`;

      const { data, error } = await supabaseClient
        .storage
        .from('student-notes')
        .upload(filePath, file, {
          cacheControl: '3600',
          upsert: false
        });

      if (error) throw error;

      // Get public URL
      const { data: urlData } = supabaseClient
        .storage
        .from('student-notes')
        .getPublicUrl(filePath);

      return {
        url: urlData.publicUrl,
        name: file.name,
        size: file.size
      };
    } catch (error) {
      console.error('Error uploading file:', error);
      throw error;
    }
  }

  // Initialize
  async function init() {
    try {
      // Get student info from session/localStorage
      const studentData = getStudentData();
      if (!studentData) {
        alert('Please log in through the Student Portal first.');
        window.location.href = 'student-portal.html';
        return;
      }

      currentStudentId = studentData.id;
      currentStudentName = studentData.name;

      // Fetch student's college from database (async, non-blocking)
      fetchStudentCollege(); // Don't await - load messages first

      // Update header immediately
      chatStudentName.textContent = `Chat`;
      chatAvatar.textContent = studentData.name.charAt(0).toUpperCase();

      // Load existing messages (priority)
      await loadMessages();

      // Subscribe to new messages for real-time updates
      subscribeToMessages();

      // Polling handled automatically by subscribeToMessages based on connection status

      // Hide loading
      loadingState.style.display = 'none';

      // Focus input
      chatInput.focus();

    } catch (error) {
      console.error('Init error:', error);
      loadingState.textContent = 'Error loading chat. Please refresh.';
    }
  }

  function getStudentData() {
    // Try to get from URL parameters first
    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('studentId');
    const studentName = urlParams.get('studentName');
    
    if (studentId && studentName) {
      return {
        id: parseInt(studentId),
        name: decodeURIComponent(studentName)
      };
    }
    
    // Try from window.opener (if opened from student portal)
    if (window.opener && window.opener.currentStudent) {
      return window.opener.currentStudent;
    }
    
    // Try from window.parent (if in iframe)
    if (window.parent && window.parent !== window && window.parent.currentStudent) {
      return window.parent.currentStudent;
    }
    
    // Fallback to localStorage
    const stored = localStorage.getItem('arnoma:student:session');
    if (stored) {
      try {
        return JSON.parse(stored);
      } catch (e) {
        debugLog('Parse error:', e);
      }
    }
    
    return null;
  }

  async function fetchStudentCollege() {
    try {
      const { data, error } = await supabaseClient
        .from('students')
        .select('college')
        .eq('id', currentStudentId)
        .single();
      
      if (!error && data) {
        currentStudentCollege = data.college || '';
      }
    } catch (error) {
      console.error('Error fetching college:', error);
    }
  }

  async function loadMessages() {
    if (isLoadingMessages) return; // Prevent concurrent loads
    isLoadingMessages = true;
    
    try {
      // Use timestamp-based incremental loading instead of fetching all messages
      const query = supabaseClient
        .from('chat_messages')
        .select('*')
        .order('created_at', { ascending: true })
        .limit(100); // Limit initial load
      
      if (lastMessageTimestamp) {
        query.gt('created_at', lastMessageTimestamp);
      }
      
      // Single query with OR condition for better performance
      const { data: messages, error } = await query.or(`is_private.eq.false,and(is_private.eq.true,student_id.eq.${currentStudentId})`);

      if (error) {
        console.error('Error loading messages:', error);
        return;
      }

      // If this is the first load, clear and show welcome
      if (!lastMessageTimestamp) {
        chatBody.innerHTML = '';
        chatBody.appendChild(chatTyping);
        
        if (!messages || messages.length === 0) {
          addDayDivider('Today');
          addWelcomeMessage();
        } else {
          addDayDivider('Today');
        }
      }
      
      // Batch DOM updates using DocumentFragment for better performance
      if (messages && messages.length > 0) {
        const fragment = document.createDocumentFragment();
        
        messages.forEach(msg => {
          // Check cache to avoid duplicates
          const msgKey = `${msg.id}-${msg.created_at}`;
          if (messageCache.has(msgKey)) return;
          
          messageCache.set(msgKey, true);
          lastMessageTimestamp = msg.created_at;
          
          const attachment = msg.attachment_url ? {
            url: msg.attachment_url,
            name: msg.attachment_name,
            size: msg.attachment_size
          } : null;
          
          const msgElement = createMessageElement(
            msg.message, 
            msg.sender_type, 
            msg.created_at, 
            msg.is_private,
            msg.sender_name,
            msg.sender_college,
            msg.is_announcement || false,
            attachment
          );
          
          fragment.appendChild(msgElement);
        });
        
        chatBody.insertBefore(fragment, chatTyping);
      }

      requestScrollToBottom();
    } catch (error) {
      console.error('Load messages error:', error);
    } finally {
      isLoadingMessages = false;
    }
  }

  function getLocalMessages() {
    // DEPRECATED: Kept for backward compatibility
    // New messages are stored in Supabase
    const key = `arnoma:chat:${currentStudentId}`;
    const stored = localStorage.getItem(key);
    if (stored) {
      try {
        return JSON.parse(stored);
      } catch (e) {
        return [];
      }
    }
    return [];
  }

  function saveLocalMessages(messages) {
    // DEPRECATED: Kept for backward compatibility
    // New messages are saved to Supabase
    const key = `arnoma:chat:${currentStudentId}`;
    localStorage.setItem(key, JSON.stringify(messages));
  }

  function addWelcomeMessage() {
    const welcome = "Hi! ðŸ‘‹ Welcome to the group chat! You can message your classmates here, or send a private message to the admin using the red button.";
    addMessageToUI(welcome, 'admin', new Date().toISOString(), false, 'Admin', '');
  }

  function addDayDivider(text) {
    const div = document.createElement('div');
    div.className = 'chat-day';
    div.textContent = text;
    chatBody.insertBefore(div, chatTyping);
  }

  function addSystemMessage(text) {
    const div = document.createElement('div');
    div.className = 'system-msg';
    div.innerHTML = `<span class="system-msg-text">ðŸ”’ ${text}</span>`;
    chatBody.insertBefore(div, chatTyping);
    requestScrollToBottom();
  }

  // Optimized: Create message element without immediate DOM insertion
  function createMessageElement(text, sender, timestamp, isPrivate = false, senderName = '', senderCollege = '', isAnnouncement = false, attachment = null) {
    const wrap = document.createElement("div");
    
    // Determine message type
    const isMe = sender === "student";
    const isAdmin = sender === "admin";
    
    // Build class string once
    let className = "msg";
    if (isAnnouncement) className += " announcement";
    if (isPrivate) className += " private";
    if (attachment) className += " has-attachment";
    if (isMe) className += " me";
    else if (isAdmin) className += " admin";
    else if (!isAnnouncement) className += " other-student";
    
    wrap.className = className;
    
    const bub = document.createElement("div");
    bub.className = "bubble";
    
    // Build inner HTML more efficiently
    let bubbleHTML = '';
    
    if (text) {
      bubbleHTML += `<div class="msg-text">${escapeHtml(text)}</div>`;
    }

    if (attachment) {
      const fileName = attachment.name || attachment.attachmentName || 'File';
      const fileSize = formatFileSize(attachment.size || attachment.attachmentSize || 0);
      const fileUrl = attachment.url || attachment.attachmentUrl || '#';
      
      bubbleHTML += `
        <div class="msg-attachment">
          <div class="msg-attachment-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
              <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
          </div>
          <div class="msg-attachment-info">
            <div class="msg-attachment-name">${escapeHtml(fileName)}</div>
            <div class="msg-attachment-size">${fileSize}</div>
          </div>
          <a class="msg-attachment-download" href="${fileUrl}" target="_blank" download="${escapeHtml(fileName)}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </a>
        </div>
      `;
    }
    
    // Build meta info
    let displayName = '';
    if (isAnnouncement) displayName = "ðŸ“¢ Admin Announcement";
    else if (isMe) displayName = senderName || currentStudentName || "You";
    else if (isAdmin) displayName = "Admin";
    else displayName = senderName || "Student";
    
    bubbleHTML += '<div class="meta-line">';
    bubbleHTML += `<div class="sender-info">${escapeHtml(displayName)}</div>`;
    if (senderCollege && senderCollege.trim()) {
      bubbleHTML += `<div class="college-info">${escapeHtml(senderCollege)}</div>`;
    }
    bubbleHTML += `<div style="font-size:10px;opacity:0.6;margin-top:2px">${formatTime(timestamp)}</div>`;
    bubbleHTML += '</div>';
    
    bub.innerHTML = bubbleHTML;
    
    // Add click handler for reply functionality (don't allow replying to yourself or announcements)
    if (!isMe && !isAnnouncement) {
      bub.addEventListener('click', () => {
        setReplyTo(displayName, text || '(attachment)');
      });
    }
    
    wrap.appendChild(bub);
    
    return wrap;
  }

  // Helper to escape HTML for security
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function addMessageToUI(text, sender, timestamp, isPrivate = false, senderName = '', senderCollege = '', isAnnouncement = false, attachment = null) {
    const msgElement = createMessageElement(text, sender, timestamp, isPrivate, senderName, senderCollege, isAnnouncement, attachment);
    chatBody.insertBefore(msgElement, chatTyping);
    requestScrollToBottom();
  }

  function formatTime(timestamp) {
    const date = new Date(timestamp);
    const h = String(date.getHours()).padStart(2, '0');
    const m = String(date.getMinutes()).padStart(2, '0');
    return `${h}:${m}`;
  }

  // Optimized scrolling with requestAnimationFrame batching
  function requestScrollToBottom() {
    if (!pendingScrollRequest) {
      pendingScrollRequest = true;
      requestAnimationFrame(() => {
        chatBody.scrollTop = chatBody.scrollHeight;
        pendingScrollRequest = false;
      });
    }
  }

  function scrollToBottom() {
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function showTyping(on) {
    chatTyping.classList.toggle("show", !!on);
    requestScrollToBottom();
  }

  async function send(isPrivateToAdmin = false) {
    const text = (chatInput.value || "").trim();
    if (!text && !selectedFile) return;

    const timestamp = new Date().toISOString();
    let attachmentData = null;
    
    // Prepare message text with reply context if replying
    let fullMessage = text;
    if (replyingTo && text) {
      fullMessage = `â†©ï¸ Replying to ${replyingTo.sender}: "${replyingTo.text.substring(0, 50)}${replyingTo.text.length > 50 ? '...' : ''}"\n\n${text}`;
    }

    // Upload file if selected
    if (selectedFile) {
      try {
        addSystemMessage("ðŸ“Ž Uploading file...");
        attachmentData = await uploadFileToStorage(selectedFile);
        debugLog('âœ… File uploaded:', attachmentData);
      } catch (error) {
        console.error('File upload error:', error);
        addSystemMessage("âš ï¸ File upload failed. Please try again.");
        return;
      }
    }

    // Show system message if sending private to admin
    if (isPrivateToAdmin) {
      addSystemMessage("Private Chat - Only you and the administrator can see this");
    }

    // Add to UI immediately (optimistic update)
    addMessageToUI(
      fullMessage || (attachmentData ? 'ðŸ“Ž File attached' : ''), 
      "student", 
      timestamp, 
      isPrivateToAdmin, 
      currentStudentName, 
      currentStudentCollege,
      false,
      attachmentData
    );
    
    chatInput.value = "";
    removeFile();
    clearReply(); // Clear reply preview
    resizeInput();

    try {
      // Save to Supabase
      const { data, error } = await supabaseClient
        .from('chat_messages')
        .insert({
          student_id: currentStudentId,
          message: fullMessage || (attachmentData ? 'ðŸ“Ž File attached' : ''),
          sender_type: 'student',
          sender_name: currentStudentName,
          is_private: isPrivateToAdmin
        })
        .select()
        .single();

      if (error) {
        console.error('Error sending message:', error);
        addSystemMessage("âš ï¸ Message failed to send. Please try again.");
        return;
      }

      debugLog('âœ… Message sent:', data);

      // Save to localStorage as backup (deprecated but kept for compatibility)
      const messages = getLocalMessages();
      messages.push({
        text: fullMessage || (attachmentData ? 'ðŸ“Ž File attached' : ''),
        sender: "student",
        timestamp: timestamp,
        isPrivate: isPrivateToAdmin,
        senderName: currentStudentName,
        senderCollege: currentStudentCollege,
        attachmentUrl: attachmentData?.url || null,
        attachmentName: attachmentData?.name || null,
        attachmentSize: attachmentData?.size || null
      });
      saveLocalMessages(messages);

    } catch (error) {
      console.error('Send error:', error);
      addSystemMessage("âš ï¸ Network error. Please check your connection.");
    }
  }

  function startMessagePolling() {
    // Optimized: Poll only if real-time subscription fails, use longer interval
    messagePollingInterval = setInterval(async () => {
      await checkForNewMessages();
    }, 5000); // Reduced frequency from 2s to 5s
  }

  async function checkForNewMessages() {
    if (isLoadingMessages) return; // Skip if already loading
    
    try {
      // Only fetch count to check for new messages (more efficient)
      if (!lastMessageTimestamp) return;
      
      const { count, error } = await supabaseClient
        .from('chat_messages')
        .select('*', { count: 'exact', head: true })
        .or(`is_private.eq.false,and(is_private.eq.true,student_id.eq.${currentStudentId})`)
        .gt('created_at', lastMessageTimestamp);

      if (!error && count > 0) {
        // New messages detected, load incrementally
        await loadMessages();
      }
    } catch (error) {
      debugLog('Polling error:', error);
    }
  }

  function resizeInput() {
    chatInput.style.height = "auto";
    chatInput.style.height = Math.min(chatInput.scrollHeight, 110) + "px";
  }

  function subscribeToMessages() {
    // Real-time subscription for instant message updates
    messagesSubscription = supabaseClient
      .channel('chat_messages_channel')
      .on(
        'postgres_changes',
        { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'chat_messages' 
        },
        (payload) => {
          debugLog('ðŸ“¨ New message received:', payload.new);
          
          // Check if this message is relevant to current student
          const newMsg = payload.new;
          const isRelevant = 
            !newMsg.is_private || // Group message (visible to all)
            newMsg.student_id === currentStudentId; // Private message for this student

          if (isRelevant && newMsg.student_id !== currentStudentId) {
            // Only add if it's not our own message (we already added it optimistically)
            const msgKey = `${newMsg.id}-${newMsg.created_at}`;
            if (messageCache.has(msgKey)) return; // Prevent duplicates
            
            messageCache.set(msgKey, true);
            lastMessageTimestamp = newMsg.created_at;
            
            const attachment = newMsg.attachment_url ? {
              url: newMsg.attachment_url,
              name: newMsg.attachment_name,
              size: newMsg.attachment_size
            } : null;
            
            addMessageToUI(
              newMsg.message,
              newMsg.sender_type,
              newMsg.created_at,
              newMsg.is_private,
              newMsg.sender_name,
              newMsg.sender_college,
              newMsg.is_announcement || false,
              attachment
            );
          }
        }
      )
      .subscribe((status) => {
        debugLog('ðŸ“¡ Subscription status:', status);
        if (status === 'SUBSCRIBED') {
          // Stop polling when real-time connection is active
          if (messagePollingInterval) {
            clearInterval(messagePollingInterval);
            messagePollingInterval = null;
            debugLog('âœ… Real-time active, polling stopped');
          }
        } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
          // Restart polling if subscription fails
          if (!messagePollingInterval) {
            startMessagePolling();
            debugLog('âš ï¸ Subscription failed, polling restarted');
          }
        }
      });
  }

  // Events
  chatSendBtn.addEventListener("click", () => send(false));
  chatSendAdminBtn.addEventListener("click", () => send(true));
  replyPreviewClose.addEventListener("click", clearReply);
  
  chatInput.addEventListener("input", resizeInput);
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send(false); // Default to group message on Enter
    }
  });

  // File upload events
  fileInput.addEventListener("change", handleFileSelect);
  fileRemoveBtn.addEventListener("click", removeFile);

  // Cleanup on unload
  window.addEventListener('beforeunload', () => {
    if (messagesSubscription) {
      supabaseClient.removeChannel(messagesSubscription);
    }
    if (messagePollingInterval) {
      clearInterval(messagePollingInterval);
    }
  });

  // Start
  init();
  resizeInput();
})();
</script>

</body>
</html>
