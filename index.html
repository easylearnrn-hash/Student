<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>ARNOMA Portal - Login</title>

    <!-- Supabase Configuration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1"></script>
    
    <!-- Shared Dialog Utilities -->
    <script src="shared-dialogs.js"></script>

    <style>
      /* -----------------------------------
       ROOT VARIABLES
    ----------------------------------- */
      :root {
        --glass-bg: rgba(255, 255, 255, 0.08);
        --glass-border: rgba(255, 255, 255, 0.2);
        --neon-cyan: #26ffe6;
        --neon-purple: #8a4dff;
        --text-light: #e8e8e8;
        --text-dim: #9a9a9a;
        --radius: 22px;
        --transition: 0.25s ease;
        --blur: 18px;
      }

      /* -----------------------------------
       GLOBAL RESET
    ----------------------------------- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Poppins', sans-serif;
      }

      body {
        height: 100vh;
        width: 100%;
        background: radial-gradient(circle at 20% 20%, #0f1120, #05060a 80%);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        color: var(--text-light);
      }

      /* -----------------------------------
       FLOATING NEON BACK SHAPES
    ----------------------------------- */
      .neon-orb {
        position: absolute;
        width: 380px;
        height: 380px;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(0, 255, 230, 0.45), transparent 70%);
        filter: blur(55px);
        animation: float 8s ease-in-out infinite alternate;
        top: -120px;
        left: -80px;
        opacity: 0.6;
      }

      .neon-orb2 {
        position: absolute;
        width: 400px;
        height: 400px;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(128, 0, 255, 0.35), transparent 70%);
        filter: blur(65px);
        bottom: -140px;
        right: -100px;
        animation: float2 10s ease-in-out infinite alternate;
        opacity: 0.5;
      }

      @keyframes float {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(30px);
        }
      }
      @keyframes float2 {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(-30px);
        }
      }

      /* -----------------------------------
       MAIN CARD
    ----------------------------------- */
      .login-card {
        width: 380px;
        padding: 40px 35px;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius);
        backdrop-filter: blur(var(--blur));
        box-shadow:
          0 0 35px rgba(0, 0, 0, 0.4),
          0 0 12px rgba(30, 255, 230, 0.25),
          inset 0 0 25px rgba(255, 255, 255, 0.05);
        position: relative;
        animation: fadeIn 0.6s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* -----------------------------------
       TOGGLE BUTTONS
    ----------------------------------- */
      .toggle-container {
        display: flex;
        margin-bottom: 28px;
        background: rgba(255, 255, 255, 0.06);
        padding: 6px;
        border-radius: 14px;
        backdrop-filter: blur(12px);
      }

      .toggle-btn {
        flex: 1;
        text-align: center;
        padding: 10px 0;
        border-radius: 10px;
        cursor: pointer;
        color: var(--text-dim);
        font-size: 15px;
        transition: var(--transition);
      }

      .toggle-btn.active {
        background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
        color: #000;
        font-weight: 600;
        box-shadow: 0 0 12px rgba(140, 255, 255, 0.4);
      }

      /* -----------------------------------
       INPUT FIELD
    ----------------------------------- */
      .input-group {
        margin-bottom: 16px;
        position: relative;
      }

      .input-label {
        font-size: 14px;
        margin-bottom: 6px;
        color: var(--text-dim);
      }

      .input-box {
        width: 100%;
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.07);
        border: 1px solid rgba(255, 255, 255, 0.22);
        border-radius: 12px;
        color: white;
        font-size: 15px;
        outline: none;
        transition: var(--transition);
      }

      .input-box:focus {
        border-color: var(--neon-cyan);
        box-shadow: 0 0 10px rgba(38, 255, 230, 0.4);
      }

      /* Password visibility toggle */
      .password-wrapper {
        position: relative;
      }

      .password-wrapper .input-box {
        padding-right: 45px;
      }

      .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 18px;
        color: var(--text-dim);
        transition: var(--transition);
        user-select: none;
      }

      .password-toggle:hover {
        color: var(--neon-cyan);
      }

      /* Remember Me checkbox */
      .remember-me-container {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        gap: 8px;
      }

      .remember-me-container input[type="checkbox"] {
        appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.05);
        cursor: pointer;
        position: relative;
        transition: var(--transition);
      }

      .remember-me-container input[type="checkbox"]:checked {
        background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
        border-color: var(--neon-cyan);
      }

      .remember-me-container input[type="checkbox"]:checked::after {
        content: '‚úì';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #000;
        font-size: 12px;
        font-weight: bold;
      }

      .remember-me-container label {
        font-size: 14px;
        color: var(--text-dim);
        cursor: pointer;
        user-select: none;
      }

      .remember-me-container input[type="checkbox"]:hover {
        border-color: var(--neon-cyan);
      }

      /* -----------------------------------
       LOGIN BUTTON
    ----------------------------------- */
      .login-btn {
        margin-top: 10px;
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
        border: none;
        color: #000;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        font-size: 16px;
      }

      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 18px rgba(140, 255, 255, 0.45);
      }

      .login-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* -----------------------------------
       ERROR MESSAGE
    ----------------------------------- */
      .error-message {
        margin-top: 12px;
        padding: 10px;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 10px;
        color: #ef4444;
        font-size: 13px;
        text-align: center;
        display: none;
      }

      .success-message {
        margin-top: 12px;
        padding: 10px;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: 10px;
        color: #22c55e;
        font-size: 13px;
        text-align: center;
        display: none;
      }

      /* -----------------------------------
       EXTRA LINKS
    ----------------------------------- */
      .bottom-links {
        text-align: center;
        margin-top: 22px;
        font-size: 13px;
        color: var(--text-dim);
      }

      .bottom-links span {
        color: var(--neon-cyan);
        cursor: pointer;
        transition: var(--transition);
      }

      .bottom-links span:hover {
        text-shadow: 0 0 8px rgba(38, 255, 230, 0.6);
      }

      /* Loading spinner */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .login-btn.loading::after {
        content: '';
        width: 16px;
        height: 16px;
        border: 2px solid #000;
        border-top-color: transparent;
        border-radius: 50%;
        display: inline-block;
        margin-left: 8px;
        animation: spin 0.6s linear infinite;
      }

      /* -----------------------------------
       REGISTER BUTTON
    ----------------------------------- */
      .register-btn {
        padding: 12px 24px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.07);
        border: 1px solid rgba(255, 255, 255, 0.22);
        color: var(--neon-cyan);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        font-size: 14px;
      }

      .register-btn:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: var(--neon-cyan);
        box-shadow: 0 0 12px rgba(38, 255, 230, 0.3);
        transform: translateY(-1px);
      }

      /* -----------------------------------
       MODAL OVERLAY & REGISTRATION MODAL
    ----------------------------------- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.3s ease-out;
      }

      .modal-overlay.active {
        display: flex;
      }

      .registration-modal {
        width: 450px;
        max-width: 90vw;
        max-height: 90vh;
        overflow-y: auto;
        padding: 40px 35px;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius);
        backdrop-filter: blur(var(--blur));
        box-shadow:
          0 0 45px rgba(0, 0, 0, 0.5),
          0 0 15px rgba(30, 255, 230, 0.3),
          inset 0 0 25px rgba(255, 255, 255, 0.05);
        position: relative;
        animation: slideUp 0.4s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-close {
        position: absolute;
        top: 18px;
        right: 18px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: var(--text-light);
        font-size: 20px;
        cursor: pointer;
        transition: var(--transition);
      }

      .modal-close:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: #ef4444;
        color: #ef4444;
        transform: rotate(90deg);
      }

      /* -----------------------------------
       FIELD-LEVEL ERROR MESSAGE
    ----------------------------------- */
      .field-error {
        margin-top: 6px;
        font-size: 12px;
        color: #ef4444;
        display: none;
        text-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
      }

      .field-error.show {
        display: block;
      }

      /* SELECT DROPDOWN STYLING */
      select.input-box {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2326ffe6' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 40px;
      }

      select.input-box option {
        background: #1a1a2e;
        color: white;
      }
    </style>
  </head>

  <body>
    <div class="neon-orb"></div>
    <div class="neon-orb2"></div>

    <div class="login-card">
      <!-- LOGO -->
      <div style="text-align: center; margin-bottom: 24px">
        <img
          src="richyfesta-logo.png"
          alt="ARNOMA Logo"
          style="width: 120px; height: auto; filter: drop-shadow(0 0 15px rgba(38, 255, 230, 0.5))"
        />
      </div>

      <!-- TOGGLE -->
      <div class="toggle-container">
        <div class="toggle-btn active" id="studentBtn">Student Login</div>
        <div class="toggle-btn" id="adminBtn">Admin Login</div>
      </div>

      <!-- TITLE -->
      <h2
        style="
          margin-bottom: 6px;
          text-align: center;
          background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        "
      >
        ARNOMA NCLEX
      </h2>
      <p style="text-align: center; margin-bottom: 22px; color: var(--text-dim)">Sign in to your account</p>

      <!-- INPUTS -->
      <div class="input-group">
        <div class="input-label">Email</div>
        <input type="email" id="emailInput" class="input-box" placeholder="username@gmail.com" autocomplete="email" />
      </div>

      <div class="input-group" id="passwordGroup">
        <div class="input-label">Password</div>
        <div class="password-wrapper">
          <input
            type="password"
            id="passwordInput"
            class="input-box"
            placeholder="Enter your password"
            autocomplete="current-password"
          />
          <span class="password-toggle" id="passwordToggle">üëÅÔ∏è</span>
        </div>
      </div>

      <div class="remember-me-container">
        <input type="checkbox" id="rememberMeCheckbox" />
        <label for="rememberMeCheckbox">Remember me for 30 days</label>
      </div>

      <button class="login-btn" id="loginBtn">Login</button>

      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>

      <div class="bottom-links">
        <span id="forgotPassword">Forgot Password?</span>
        <span style="margin: 0 8px;">‚Ä¢</span>
        <span id="registerBtn">Sign Up</span>
      </div>

      <div class="bottom-links" style="margin-top: 10px;">
        <span id="studentRegistrationBtn">Student Registration</span>
      </div>
    </div>

    <!-- WAITING LIST SIGNUP MODAL (Original Sign Up) -->
    <div class="modal-overlay" id="waitingListModal">
      <div class="registration-modal">
        <!-- CLOSE BUTTON -->
        <div class="modal-close" id="closeWaitingListModal">‚úï</div>

        <!-- MODAL HEADER -->
        <div style="text-align: center; margin-bottom: 24px;">
          <h2
            style="
              margin-bottom: 6px;
              background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
              background-clip: text;
            "
          >
            Join Waiting List
          </h2>
          <p style="color: var(--text-dim); font-size: 14px;">Register your interest</p>
        </div>

        <!-- FORM -->
        <div class="input-group">
          <div class="input-label">First Name *</div>
          <input type="text" id="waitingFirstName" class="input-box" placeholder="Enter your first name" />
          <div class="field-error" id="errorWaitingFirstName"></div>
        </div>

        <div class="input-group">
          <div class="input-label">Last Name *</div>
          <input type="text" id="waitingLastName" class="input-box" placeholder="Enter your last name" />
          <div class="field-error" id="errorWaitingLastName"></div>
        </div>

        <div class="input-group">
          <div class="input-label">Email Address *</div>
          <input type="email" id="waitingEmail" class="input-box" placeholder="your.email@example.com" />
          <div class="field-error" id="errorWaitingEmail"></div>
        </div>

        <div class="input-group">
          <div class="input-label">Phone Number *</div>
          <input type="tel" id="waitingPhone" class="input-box" placeholder="+1 (555) 123-4567" />
          <div class="field-error" id="errorWaitingPhone"></div>
        </div>

        <div class="input-group">
          <div class="input-label">Preferred Language *</div>
          <select id="waitingLanguage" class="input-box">
            <option value="">Select language</option>
            <option value="Armenian">Armenian</option>
            <option value="English">English</option>
          </select>
          <div class="field-error" id="errorWaitingLanguage"></div>
        </div>

        <button class="login-btn" id="submitWaitingList" style="margin-top: 24px;">
          Submit Registration
        </button>

        <div class="error-message" id="waitingErrorMessage"></div>
        <div class="success-message" id="waitingSuccessMessage"></div>
      </div>
    </div>

    <!-- STUDENT REGISTRATION MODAL (New - Create Account) -->
    <div class="modal-overlay" id="registrationModal">
      <div class="registration-modal">
        <!-- CLOSE BUTTON -->
        <div class="modal-close" id="closeModal">‚úï</div>

        <!-- MODAL HEADER -->
        <div style="text-align: center; margin-bottom: 24px;">
          <h2
            style="
              margin-bottom: 6px;
              background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
              background-clip: text;
            "
          >
            Student Account Setup
          </h2>
          <p style="color: var(--text-dim); font-size: 14px;">Create your login credentials</p>
        </div>

        <!-- INFO BOX -->
        <div style="
          background: rgba(38, 255, 230, 0.1);
          border: 1px solid rgba(38, 255, 230, 0.3);
          border-radius: 10px;
          padding: 12px;
          margin-bottom: 20px;
          font-size: 13px;
          color: var(--neon-cyan);
          line-height: 1.5;
        ">
          ‚ÑπÔ∏è <strong>Note:</strong> You must be registered as a student by the administrator first. Enter the email address that was provided to the admin.
        </div>

        <!-- REGISTRATION FORM -->
        <div class="input-group">
          <div class="input-label">Email Address *</div>
          <input type="email" id="regEmail" class="input-box" placeholder="your.email@example.com" autocomplete="email" />
          <div class="field-error" id="errorEmail"></div>
        </div>

        <div class="input-group">
          <div class="input-label">Create Password *</div>
          <div class="password-wrapper">
            <input type="password" id="regPassword" class="input-box" placeholder="Minimum 6 characters" autocomplete="new-password" />
            <span class="password-toggle" onclick="togglePasswordVisibility('regPassword', this)">üëÅÔ∏è</span>
          </div>
          <div class="field-error" id="errorPassword"></div>
        </div>

        <div class="input-group">
          <div class="input-label">Confirm Password *</div>
          <div class="password-wrapper">
            <input type="password" id="regPasswordConfirm" class="input-box" placeholder="Re-enter your password" autocomplete="new-password" />
            <span class="password-toggle" onclick="togglePasswordVisibility('regPasswordConfirm', this)">üëÅÔ∏è</span>
          </div>
          <div class="field-error" id="errorPasswordConfirm"></div>
        </div>

        <button class="login-btn" id="submitRegistration" style="margin-top: 24px;">
          Submit Registration
        </button>

        <div class="error-message" id="regErrorMessage"></div>
        <div class="success-message" id="regSuccessMessage"></div>
      </div>
    </div>

      <!-- MASTER ACCESS PICKER MODAL -->
      <div class="modal-overlay" id="masterAccessModal">
        <div class="master-access-modal">
          <div class="modal-close" id="masterModalClose">‚úï</div>
          <div class="master-modal-header">
            <h2>Master Student Access</h2>
            <p>Select any student below to open their portal instantly. Use the search box to jump quickly.</p>
            <div class="master-search-wrapper">
              <input type="text" id="masterStudentSearch" placeholder="Search by name, email, or group" />
            </div>
          </div>
          <div class="master-student-list" id="masterStudentList">
            <!-- Students populated via JS -->
          </div>
        </div>
      </div>

      <style>
        #masterAccessModal {
          display: none;
          align-items: center;
          justify-content: center;
          backdrop-filter: blur(12px);
          background: rgba(10, 15, 40, 0.75);
          padding: 30px;
          z-index: 2000;
        }
        #masterAccessModal.active { display: flex; }
        .master-access-modal {
          width: min(600px, 95vw);
          max-height: 80vh;
          background: rgba(13, 17, 34, 0.95);
          border: 1px solid rgba(99, 102, 241, 0.3);
          border-radius: 24px;
          padding: 28px;
          position: relative;
          box-shadow: 0 20px 60px rgba(5, 8, 20, 0.6);
          display: flex;
          flex-direction: column;
        }
        .master-modal-header h2 {
          margin: 0 0 6px;
          font-size: 1.4rem;
          background: linear-gradient(120deg, #60a5fa, #a855f7);
          -webkit-background-clip: text;
          background-clip: text;
          -webkit-text-fill-color: transparent;
        }
        .master-modal-header p {
          margin: 0 0 16px;
          color: rgba(255,255,255,0.7);
          font-size: 0.95rem;
        }
        .master-search-wrapper input {
          width: 100%;
          padding: 12px 14px;
          border-radius: 12px;
          border: 1px solid rgba(255,255,255,0.1);
          background: rgba(14, 20, 45, 0.8);
          color: #fff;
          font-size: 0.95rem;
          outline: none;
        }
        .master-student-list {
          margin-top: 18px;
          overflow-y: auto;
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
        .master-empty {
          padding: 24px;
          border-radius: 16px;
          text-align: center;
          color: rgba(255,255,255,0.65);
          border: 1px dashed rgba(255,255,255,0.15);
          font-size: 0.95rem;
        }
        .master-student-row {
          padding: 14px 16px;
          border-radius: 16px;
          background: rgba(255, 255, 255, 0.03);
          border: 1px solid rgba(255, 255, 255, 0.06);
          display: flex;
          justify-content: space-between;
          align-items: center;
          cursor: pointer;
          transition: transform 0.2s ease, border 0.2s ease;
        }
        .master-student-row:hover {
          transform: translateY(-1px);
          border-color: rgba(99, 102, 241, 0.5);
          background: rgba(99, 102, 241, 0.08);
        }
        .master-student-info {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }
        .master-student-name {
          font-weight: 600;
          color: #fff;
        }
        .master-student-meta {
          font-size: 0.85rem;
          color: rgba(255,255,255,0.65);
        }
        .master-student-badge {
          padding: 6px 12px;
          border-radius: 999px;
    background: rgba(15, 23, 42, 0.65);
    border: 1px solid rgba(99, 102, 241, 0.5);
    color: #e0e7ff;
          font-weight: 600;
          font-size: 0.8rem;
        }
        @media (max-width: 600px) {
          .master-access-modal { padding: 20px; }
          .master-student-row { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
      </style>

    <script>
      // ============================================================
      // SUPABASE INITIALIZATION
      // ============================================================
      const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';

      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          autoRefreshToken: true,
          persistSession: true,
          detectSessionInUrl: true
        }
      });
      const supabase = supabaseClient; // Local alias for backward compatibility

      // ============================================================
      // DOM ELEMENTS
      // ============================================================
      const studentBtn = document.getElementById('studentBtn');
      const adminBtn = document.getElementById('adminBtn');
      const emailInput = document.getElementById('emailInput');
      const passwordInput = document.getElementById('passwordInput');
      const passwordGroup = document.getElementById('passwordGroup');
      const loginBtn = document.getElementById('loginBtn');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      const forgotPasswordLink = document.getElementById('forgotPassword');
      const passwordToggle = document.getElementById('passwordToggle');
      const rememberMeCheckbox = document.getElementById('rememberMeCheckbox');
  const masterAccessModal = document.getElementById('masterAccessModal');
  const masterModalClose = document.getElementById('masterModalClose');
  const masterStudentSearch = document.getElementById('masterStudentSearch');
  const masterStudentListEl = document.getElementById('masterStudentList');

      let mode = 'student';
  const MASTER_ACCESS_CODE = 'ARNOMA-MASTER-2025';
  const MASTER_ACCESS_EMAILS = ['hrachfilm@gmail.com'];
  let masterStudentOptions = [];

      // ============================================================
      // PASSWORD VISIBILITY TOGGLE
      // ============================================================
      passwordToggle.onclick = () => {
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          passwordToggle.textContent = 'üôà';
        } else {
          passwordInput.type = 'password';
          passwordToggle.textContent = 'üëÅÔ∏è';
        }
      };

      // Global function for registration password fields
      window.togglePasswordVisibility = (inputId, toggleElement) => {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
          input.type = 'text';
          toggleElement.textContent = 'üôà';
        } else {
          input.type = 'password';
          toggleElement.textContent = 'üëÅÔ∏è';
        }
      };

      // ============================================================
      // MODE TOGGLE
      // ============================================================
      studentBtn.onclick = () => {
        mode = 'student';
        studentBtn.classList.add('active');
        adminBtn.classList.remove('active');
        loginBtn.innerText = 'Login';
        passwordGroup.style.display = 'block';
        hideMessages();
      };

      adminBtn.onclick = () => {
        mode = 'admin';
        adminBtn.classList.add('active');
        studentBtn.classList.remove('active');
        loginBtn.innerText = 'Admin Login';
        passwordGroup.style.display = 'block';
        hideMessages();
      };

      // ============================================================
      // LOGIN HANDLER
      // ============================================================
      loginBtn.onclick = async () => {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        // Validation
        if (!email) {
          showError('Please enter your email');
          return;
        }

        if (!password) {
          showError('Please enter your password');
          return;
        }

        // Start loading
        loginBtn.disabled = true;
        loginBtn.classList.add('loading');
        hideMessages();

        try {
          if (mode === 'admin') {
            await handleAdminLogin(email, password);
          } else {
            await handleStudentLogin(email, password);
          }
        } catch (error) {
          const errorMsg = error.message || 'An error occurred. Please try again.';
          
          // Check if it's an email confirmation error
          if (errorMsg.toLowerCase().includes('email') && errorMsg.toLowerCase().includes('confirm')) {
            showError(errorMsg + ' <a href="#" onclick="resendConfirmationEmail(); return false;" style="color: #00f5ff; text-decoration: underline; margin-left: 8px;">Resend confirmation email</a>');
          } else {
            showError(errorMsg);
          }
        } finally {
          loginBtn.disabled = false;
          loginBtn.classList.remove('loading');
        }
      };

      // ============================================================
      // ADMIN LOGIN (Supabase Auth)
      // ============================================================
      async function handleAdminLogin(email, password) {
        console.log('üîê Attempting admin login...');

        // Set storage persistence based on Remember Me checkbox
        const rememberMe = rememberMeCheckbox.checked;
        
        // Update storage - if remember me is checked, use local storage (30 days)
        // If not checked, use session storage (closes when browser closes)
        if (rememberMe) {
          await supabase.auth.setSession({ access_token: null, refresh_token: null }); // Clear any session
        }

        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password,
        });

        if (error) {
          console.error('‚ùå Login error:', error);
          throw new Error(error.message);
        }

        if (data?.user) {
          // Store remember me preference
          if (rememberMe) {
            localStorage.setItem('arnoma:remember-me', 'true');
            localStorage.setItem('arnoma:session-expiry', Date.now() + (30 * 24 * 60 * 60 * 1000)); // 30 days
          } else {
            localStorage.removeItem('arnoma:remember-me');
            localStorage.removeItem('arnoma:session-expiry');
          }

          // Check if this is the hardcoded admin email
          const ADMIN_EMAIL = 'hrachfilm@gmail.com';
          
          if (data.user.email === ADMIN_EMAIL) {
            // Admin account - no student record needed
            console.log('‚úÖ Admin login successful:', data.user.email);
            showSuccess('Login successful! Redirecting to payment records...');

            // Redirect to Payment Records (admin dashboard)
            setTimeout(() => {
              window.location.href = 'Payment-Records.html';
            }, 800);
            return;
          }

          // Not admin - check if they have a student record with admin role
          let studentData = null;
          let roleError = null;

          ({ data: studentData, error: roleError } = await supabase
            .from('students')
            .select('role, name')
            .eq('auth_user_id', data.user.id)
            .single());

          if (roleError || !studentData) {
            console.warn('‚ö†Ô∏è Student lookup failed, attempting auto-link fallback...', roleError);
            studentData = await autoLinkStudentAccount(data.user);
          }

          if (!studentData) {
            console.error('‚ùå Account not found in students table');
            await supabase.auth.signOut();
            throw new Error('Account not found. Please contact administrator.');
          }

          if (studentData.role !== 'admin') {
            console.error('‚ùå Not an admin account');
            await supabase.auth.signOut();
            throw new Error('This email is not an admin account. Please use Student Login tab.');
          }

          console.log('‚úÖ Admin login successful:', data.user.email);
          showSuccess('Login successful! Redirecting to payment records...');

          // Redirect to Payment Records (admin dashboard)
          setTimeout(() => {
            window.location.href = 'Payment-Records.html';
          }, 800);
        }
      }

      // ============================================================
      // STUDENT LOGIN (Supabase Auth - same credentials, different redirect)
      // ============================================================
      async function handleStudentLogin(email, password) {
        console.log('üë®‚Äçüéì Attempting student login...');
        console.log('üîç Password check:', password);
        console.log('üîç Is master code?', password === MASTER_ACCESS_CODE);

        const normalizedEmail = (email || '').trim().toLowerCase();
        const isWhitelistedAdmin = MASTER_ACCESS_EMAILS.includes(normalizedEmail);

        // ‚úÖ Allow master access using the regular admin password (no master code needed)
        if (isWhitelistedAdmin && password !== MASTER_ACCESS_CODE) {
          try {
            await unlockMasterAccessWithAdminPassword(email, password);
            return;
          } catch (adminAccessError) {
            console.error('Master access via admin password failed:', adminAccessError);
            throw adminAccessError;
          }
        }

        // üîê MASTER ADMIN BYPASS: Login as any student
        if (password === MASTER_ACCESS_CODE) {
          console.log('üîì Master code detected - bypassing normal auth');
          
          try {
            loginBtn.disabled = true;

            if (isWhitelistedAdmin) {
              console.log('‚úÖ Master admin authenticated via master code. Loading student list...');
              try {
                await showMasterStudentPicker();
              } catch (studentPickerError) {
                console.error('Failed to open master student picker:', studentPickerError);
                showError(studentPickerError.message || 'Unable to load student list. Please try again.');
              }
              return;
            }

            await impersonateStudentByEmail(email);
            return;
          } catch (e) {
            console.error('Master access error:', e);
            showError('Master access failed: ' + e.message);
            return;
          } finally {
            loginBtn.disabled = false;
          }
        }

        // Set storage persistence based on Remember Me checkbox
        const rememberMe = rememberMeCheckbox.checked;

        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password,
        });

        if (error) {
          console.error('‚ùå Login error:', error);
          throw new Error(error.message);
        }

        if (data?.user) {
          // Store remember me preference
          if (rememberMe) {
            localStorage.setItem('arnoma:remember-me', 'true');
            localStorage.setItem('arnoma:session-expiry', Date.now() + (30 * 24 * 60 * 60 * 1000)); // 30 days
          } else {
            localStorage.removeItem('arnoma:remember-me');
            localStorage.removeItem('arnoma:session-expiry');
          }

          // Check if user has student role (with auto-link fallback)
          let studentData = null;
          let roleError = null;

          ({ data: studentData, error: roleError } = await supabase
            .from('students')
            .select('role, name')
            .eq('auth_user_id', data.user.id)
            .single());

          if (roleError || !studentData) {
            console.warn('‚ö†Ô∏è Student lookup failed, attempting auto-link fallback...', roleError);
            studentData = await autoLinkStudentAccount(data.user);
          }

          if (!studentData) {
            console.error('‚ùå Account not found in students table');
            await supabase.auth.signOut();
            throw new Error('Account not found. Please contact administrator.');
          }

          if (studentData.role === 'admin') {
            console.error('‚ùå This is an admin account');
            await supabase.auth.signOut();
            throw new Error('This is an admin account. Please use Admin Login tab.');
          }

          console.log('‚úÖ Student login successful:', data.user.email);
          showSuccess('Login successful! Redirecting to student portal...');

          // Redirect to Student Portal
          setTimeout(() => {
            window.location.href = 'student-portal.html';
          }, 800);
        }
      }

      // ============================================================
      // FORGOT PASSWORD
      // ============================================================
      forgotPasswordLink.onclick = async () => {
        const email = emailInput.value.trim();

        if (!email) {
          showError('Please enter your email first');
          return;
        }

        loginBtn.disabled = true;
        hideMessages();

        try {
          const { error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.origin + '/reset-password.html',
          });

          if (error) throw error;

          showSuccess('Password reset email sent! Check your inbox.');
        } catch (error) {
          showError(error.message || 'Failed to send reset email');
        } finally {
          loginBtn.disabled = false;
        }
      };

      // ============================================================
      // RESEND CONFIRMATION EMAIL
      // ============================================================
      window.resendConfirmationEmail = async function() {
        const email = emailInput.value.trim();
        
        if (!email) {
          showError('Please enter your email address');
          return;
        }

        try {
          const { error } = await supabase.auth.resend({
            type: 'signup',
            email: email
          });

          if (error) throw error;

          showSuccess('‚úÖ Confirmation email resent! Please check your inbox (and spam folder).');
        } catch (error) {
          showError('Failed to resend confirmation: ' + error.message);
        }
      };

      // ============================================================
      // MESSAGE HELPERS
      // ============================================================
      function showError(message) {
        errorMessage.innerHTML = message; // Use innerHTML to support links
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
      }

      function showSuccess(message) {
        successMessage.innerHTML = message; // Use innerHTML for consistency
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';
      }

      function hideMessages() {
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';
      }

      // ============================================================
      // ENTER KEY SUPPORT
      // ============================================================
      emailInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') passwordInput.focus();
      });

      passwordInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') loginBtn.click();
      });

      // ============================================================
      // CHECK IF ALREADY LOGGED IN
      // ============================================================
      window.addEventListener('DOMContentLoaded', async () => {
        const {
          data: { session },
        } = await supabase.auth.getSession();

        if (session) {
          console.log('‚úÖ Already logged in, checking role...');
          
          // Check user role and redirect appropriately
          const { data: studentData } = await supabase
            .from('students')
            .select('role')
            .eq('auth_user_id', session.user.id)
            .single();

          if (studentData?.role === 'admin') {
            window.location.href = 'Student-Manager.html';
          } else if (studentData) {
            // Student found with linked auth_user_id
            window.location.href = 'student-portal.html';
          } else {
            // No student found with this auth_user_id - try to link by email
            console.log('üîó No linked student found, attempting auto-link...');
            const userEmail = session.user.email;
            
            try {
              // Try to link the account using the RPC function
              const { data: linkResult, error: linkError } = await supabase.rpc(
                'link_student_auth_account',
                {
                  p_student_id: null,  // Let the function find by email
                  p_auth_user_id: session.user.id
                }
              );

              if (linkError) {
                console.error('‚ùå Failed to auto-link:', linkError);
                // Try fallback auto-link
                await autoLinkStudentAccount(session.user.id, userEmail);
              } else {
                console.log('‚úÖ Auto-link successful:', linkResult);
              }
              
              // Redirect to portal after linking
              window.location.href = 'student-portal.html';
            } catch (err) {
              console.error('‚ùå Auto-link error:', err);
              // Still try to redirect - portal will show error if needed
              window.location.href = 'student-portal.html';
            }
          }
        }
      });

      // ============================================================
      // WAITING LIST SIGNUP (Original Sign Up Button)
      // ============================================================
      const registerBtn = document.getElementById('registerBtn');
      const waitingListModal = document.getElementById('waitingListModal');
      const closeWaitingListModal = document.getElementById('closeWaitingListModal');
      const submitWaitingList = document.getElementById('submitWaitingList');

      const waitingFirstName = document.getElementById('waitingFirstName');
      const waitingLastName = document.getElementById('waitingLastName');
      const waitingEmail = document.getElementById('waitingEmail');
      const waitingPhone = document.getElementById('waitingPhone');
      const waitingLanguage = document.getElementById('waitingLanguage');

      const errorWaitingFirstName = document.getElementById('errorWaitingFirstName');
      const errorWaitingLastName = document.getElementById('errorWaitingLastName');
      const errorWaitingEmail = document.getElementById('errorWaitingEmail');
      const errorWaitingPhone = document.getElementById('errorWaitingPhone');
      const errorWaitingLanguage = document.getElementById('errorWaitingLanguage');
      const waitingErrorMessage = document.getElementById('waitingErrorMessage');
      const waitingSuccessMessage = document.getElementById('waitingSuccessMessage');

      // Open waiting list modal
      registerBtn.onclick = () => {
        waitingListModal.classList.add('active');
        clearWaitingListForm();
      };

      // Close waiting list modal
      closeWaitingListModal.onclick = () => {
        waitingListModal.classList.remove('active');
      };

      waitingListModal.onclick = e => {
        if (e.target === waitingListModal) {
          waitingListModal.classList.remove('active');
        }
      };

      function clearWaitingListForm() {
        waitingFirstName.value = '';
        waitingLastName.value = '';
        waitingEmail.value = '';
        waitingPhone.value = '';
        waitingLanguage.value = '';
        clearWaitingFieldErrors();
        waitingErrorMessage.style.display = 'none';
        waitingSuccessMessage.style.display = 'none';
      }

      function clearWaitingFieldErrors() {
        errorWaitingFirstName.classList.remove('show');
        errorWaitingLastName.classList.remove('show');
        errorWaitingEmail.classList.remove('show');
        errorWaitingPhone.classList.remove('show');
        errorWaitingLanguage.classList.remove('show');
      }

      function validateWaitingListForm() {
        let isValid = true;
        clearWaitingFieldErrors();

        if (!waitingFirstName.value.trim()) {
          showFieldError(errorWaitingFirstName, 'First name is required');
          isValid = false;
        }
        if (!waitingLastName.value.trim()) {
          showFieldError(errorWaitingLastName, 'Last name is required');
          isValid = false;
        }
        if (!waitingEmail.value.trim()) {
          showFieldError(errorWaitingEmail, 'Email is required');
          isValid = false;
        } else if (!validateEmail(waitingEmail.value.trim())) {
          showFieldError(errorWaitingEmail, 'Please enter a valid email');
          isValid = false;
        }
        if (!waitingPhone.value.trim()) {
          showFieldError(errorWaitingPhone, 'Phone number is required');
          isValid = false;
        }
        if (!waitingLanguage.value) {
          showFieldError(errorWaitingLanguage, 'Please select a language');
          isValid = false;
        }

        return isValid;
      }

      // Submit to waiting list
      submitWaitingList.onclick = async () => {
        if (!validateWaitingListForm()) return;

        submitWaitingList.disabled = true;
        submitWaitingList.textContent = 'Submitting...';
        waitingErrorMessage.style.display = 'none';
        waitingSuccessMessage.style.display = 'none';

        try {
          const registrationData = {
            first_name: waitingFirstName.value.trim(),
            last_name: waitingLastName.value.trim(),
            email: waitingEmail.value.trim().toLowerCase(),
            phone: waitingPhone.value.trim(),
            preferred_language: waitingLanguage.value,
            created_at: new Date().toISOString(),
          };

          const { error } = await supabase.from('student_waiting_list').insert([registrationData]);

          if (error) throw new Error(error.message);

          waitingSuccessMessage.textContent = '‚úÖ Registration complete! We will contact you soon.';
          waitingSuccessMessage.style.display = 'block';

          setTimeout(() => {
            waitingListModal.classList.remove('active');
            clearWaitingListForm();
          }, 3000);
        } catch (error) {
          waitingErrorMessage.textContent = error.message || 'Registration failed. Please try again.';
          waitingErrorMessage.style.display = 'block';
        } finally {
          submitWaitingList.disabled = false;
          submitWaitingList.textContent = 'Submit Registration';
        }
      };

      // ============================================================
      // STUDENT ACCOUNT REGISTRATION (New Button)
      // ============================================================
      const studentRegistrationBtn = document.getElementById('studentRegistrationBtn');
      const registrationModal = document.getElementById('registrationModal');
      const closeModal = document.getElementById('closeModal');
      const submitRegistration = document.getElementById('submitRegistration');

      // Registration form fields
      const regEmail = document.getElementById('regEmail');
      const regPassword = document.getElementById('regPassword');
      const regPasswordConfirm = document.getElementById('regPasswordConfirm');

      // Error display elements
      const errorEmail = document.getElementById('errorEmail');
      const errorPassword = document.getElementById('errorPassword');
      const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
      const regErrorMessage = document.getElementById('regErrorMessage');
      const regSuccessMessage = document.getElementById('regSuccessMessage');

      // Open student registration modal
      studentRegistrationBtn.onclick = () => {
        registrationModal.classList.add('active');
        clearRegistrationForm();
      };

      // Close modal
      closeModal.onclick = () => {
        registrationModal.classList.remove('active');
      };

      // Close on background click
      registrationModal.onclick = e => {
        if (e.target === registrationModal) {
          registrationModal.classList.remove('active');
        }
      };

      // Clear form and errors
      function clearRegistrationForm() {
        regEmail.value = '';
        regPassword.value = '';
        regPasswordConfirm.value = '';
        clearFieldErrors();
        regErrorMessage.style.display = 'none';
        regSuccessMessage.style.display = 'none';
      }

      // ============================================================
      // MASTER ACCESS MODAL EVENTS
      // ============================================================
      if (masterModalClose) {
        masterModalClose.onclick = () => closeMasterAccessModal();
      }
      if (masterAccessModal) {
        masterAccessModal.onclick = e => {
          if (e.target === masterAccessModal) {
            closeMasterAccessModal();
          }
        };
      }
      if (masterStudentSearch) {
        masterStudentSearch.addEventListener('input', e => {
          filterMasterStudentList(e.target.value);
        });
      }
      if (masterStudentListEl) {
        masterStudentListEl.addEventListener('click', e => {
          const row = e.target.closest('.master-student-row');
          if (!row) return;
          const studentId = row.getAttribute('data-student-id');
          if (studentId) {
            selectMasterStudent(studentId);
          }
        });
      }

      function clearFieldErrors() {
        errorEmail.classList.remove('show');
        errorPassword.classList.remove('show');
        errorPasswordConfirm.classList.remove('show');
      }

      // Validation helpers
      function showFieldError(errorElement, message) {
        errorElement.textContent = message;
        errorElement.classList.add('show');
      }

      function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      }

      function validateRegistrationForm() {
        let isValid = true;
        clearFieldErrors();

        // Email
        if (!regEmail.value.trim()) {
          showFieldError(errorEmail, 'Email is required');
          isValid = false;
        } else if (!validateEmail(regEmail.value.trim())) {
          showFieldError(errorEmail, 'Please enter a valid email');
          isValid = false;
        }

        // Password
        if (!regPassword.value) {
          showFieldError(errorPassword, 'Password is required');
          isValid = false;
        } else if (regPassword.value.length < 6) {
          showFieldError(errorPassword, 'Password must be at least 6 characters');
          isValid = false;
        }

        // Confirm Password
        if (!regPasswordConfirm.value) {
          showFieldError(errorPasswordConfirm, 'Please confirm your password');
          isValid = false;
        } else if (regPassword.value !== regPasswordConfirm.value) {
          showFieldError(errorPasswordConfirm, 'Passwords do not match');
          isValid = false;
        }

        return isValid;
      }

      // ============================================================
      // MASTER ACCESS HELPERS
      // ============================================================
      async function impersonateStudentByEmail(email) {
        const lookupEmail = (email || '').trim().toLowerCase();
        const { data: studentData, error: studentError } = await supabase
          .from('students')
          .select('*')
          .eq('email', lookupEmail)
          .single();

        if (studentError || !studentData) {
          console.error('Student lookup failed:', studentError);
          throw new Error('Student not found with that email');
        }

        await startMasterAccessForStudent(studentData);
      }

      function openMasterAccessModal(students) {
        masterStudentOptions = Array.isArray(students) ? students : [];
        if (masterStudentSearch) {
          masterStudentSearch.value = '';
        }
        renderMasterStudentList(masterStudentOptions);
        if (masterAccessModal) {
          masterAccessModal.classList.add('active');
        }
        document.body.style.overflow = 'hidden';
        setTimeout(() => {
          masterStudentSearch?.focus();
        }, 50);
      }

      function closeMasterAccessModal() {
        if (masterAccessModal) {
          masterAccessModal.classList.remove('active');
        }
        document.body.style.overflow = '';
      }

      function filterMasterStudentList(query) {
        const term = (query || '').toLowerCase();
        if (!term) {
          renderMasterStudentList(masterStudentOptions);
          return;
        }

        const filtered = masterStudentOptions.filter(student => {
          const nameMatch = (student.name || '').toLowerCase().includes(term);
          const emailMatch = (student.email || '').toLowerCase().includes(term);
          const groupCombined = `${student.group_letter || ''} ${(student.group_name || '')}`
            .trim()
            .toLowerCase();
          const groupMatch = groupCombined.includes(term);
          return nameMatch || emailMatch || groupMatch;
        });

        renderMasterStudentList(filtered);
      }

      function renderMasterStudentList(list) {
        if (!masterStudentListEl) return;
        if (!list || list.length === 0) {
          masterStudentListEl.innerHTML = '<div class="master-empty">No students found. Try a different search.</div>';
          return;
        }

        const markup = list
          .map(student => {
            const rawGroup = student.group_letter || student.group_name || '‚Äî';
            const normalizedGroup = rawGroup.toString().toUpperCase().startsWith('GROUP')
              ? rawGroup
              : `Group ${rawGroup}`;
            const emailText = student.email || 'No email on file';
            return `
              <div class="master-student-row" data-student-id="${student.id}">
                <div class="master-student-info">
                  <span class="master-student-name">${student.name || 'Unnamed Student'}</span>
                  <span class="master-student-meta">${emailText}</span>
                </div>
                <div class="master-student-badge">${normalizedGroup}</div>
              </div>
            `;
          })
          .join('');

        masterStudentListEl.innerHTML = markup;
      }

      async function selectMasterStudent(studentId) {
        const student = masterStudentOptions.find(s => String(s.id) === String(studentId));
        if (!student) return;
        await startMasterAccessForStudent(student);
      }

      async function showMasterStudentPicker() {
        const { data: students, error: studentListError } = await supabase
          .from('students')
          .select('id, name, email, group_name')
          .order('name');

        if (studentListError) {
          console.error('Failed to load students for master access:', studentListError);
          throw new Error('Unable to load student list. Please try again.');
        }

        openMasterAccessModal(students || []);
        showSuccess('Master access unlocked. Choose a student to continue.');
      }

      async function unlockMasterAccessWithAdminPassword(email, password) {
        console.log('üîë Verifying admin credentials for master access...');
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

        if (error || !data?.user) {
          console.error('‚ùå Admin credential verification failed:', error);
          throw new Error('Admin password incorrect. Please double-check or use the Admin Login tab.');
        }

        try {
          await showMasterStudentPicker();
        } finally {
          try {
            await supabase.auth.signOut();
          } catch (signOutError) {
            console.warn('‚ö†Ô∏è Failed to clear admin session after master unlock:', signOutError);
          }
        }
      }

      async function startMasterAccessForStudent(studentData) {
        if (!studentData) return;
        closeMasterAccessModal();
        const masterToken = {
          studentId: studentData.id,
          studentName: studentData.name,
          studentEmail: studentData.email,
          timestamp: Date.now(),
          expiresAt: Date.now() + 8 * 60 * 60 * 1000,
          isMasterAccess: true
        };

        sessionStorage.setItem('impersonation_token', JSON.stringify(masterToken));
        localStorage.setItem('impersonation_token', JSON.stringify(masterToken));

        console.log('üíæ Master token stored:', masterToken);
        showSuccess(`Master access granted! Logging in as ${studentData.name}...`);

        setTimeout(() => {
          window.location.href = `student-portal.html?impersonate=${studentData.id}&v=${Date.now()}`;
        }, 800);
      }

      // Helper to link a Supabase auth user to an existing student row via RPC
      async function autoLinkStudentAccount(user) {
        if (!user?.id || !user?.email) {
          console.warn('[AutoLink] Missing user data; skipping auto-link.');
          return null;
        }

        try {
          const email = user.email.toLowerCase();
          
          // Use RPC to safely look up student (bypasses RLS)
          const { data: studentLookup, error: lookupError } = await supabase
            .rpc('verify_student_registration_email', { p_email: email });

          if (lookupError) {
            console.warn('[AutoLink] Lookup failed:', lookupError);
            return null;
          }

          const studentRecord = Array.isArray(studentLookup)
            ? studentLookup[0]
            : studentLookup;

          if (!studentRecord) {
            console.warn('[AutoLink] No matching student found for email:', email);
            return null;
          }

          if (studentRecord.auth_user_id && studentRecord.auth_user_id !== user.id) {
            console.warn('[AutoLink] Student record already linked to a different account.');
            return null;
          }

          if (studentRecord.auth_user_id === user.id) {
            console.log('[AutoLink] ‚úÖ Student already linked; returning existing record.');
            return studentRecord;
          }

          // Link auth account via RPC (bypasses RLS safely)
          const { data: linkResult, error: linkError } = await supabase.rpc(
            'link_student_auth_account',
            {
              p_student_id: studentRecord.id,
              p_auth_user_id: user.id
            }
          );

          if (linkError) {
            console.error('[AutoLink] ‚ùå Linking error:', linkError);
            return null;
          }

          const linkedStudent = Array.isArray(linkResult)
            ? linkResult[0]
            : linkResult;

          console.log('[AutoLink] ‚úÖ Successfully linked student record:', linkedStudent);
          return linkedStudent || null;
        } catch (autoError) {
          console.error('[AutoLink] ‚ùå Unexpected error:', autoError);
          return null;
        }
      }

      // Submit registration
      submitRegistration.onclick = async () => {
        // Validate form
        if (!validateRegistrationForm()) {
          return;
        }

        // Start loading
        submitRegistration.disabled = true;
        submitRegistration.classList.add('loading');
        submitRegistration.textContent = 'Submitting...';
        regErrorMessage.style.display = 'none';
        regSuccessMessage.style.display = 'none';

        try {
          const email = regEmail.value.trim().toLowerCase();
          const password = regPassword.value.trim();
          
          console.log('[Registration] Starting student account creation for:', email);

          // Step 1: Check if student exists in database
          const { data: studentLookup, error: studentError } = await supabase
            .rpc('verify_student_registration_email', { p_email: email });

          if (studentError) {
            throw new Error('Database error checking student: ' + studentError.message);
          }

          console.log('[Registration] RPC result:', studentLookup);

          const studentData = Array.isArray(studentLookup)
            ? studentLookup[0]
            : (studentLookup || null);

          if (!studentData) {
            throw new Error('‚ùå Your email is not registered in our system. Please contact the administrator to be added as a student first.');
          }

          if (studentData.auth_user_id) {
            throw new Error('‚ùå This email already has an account. Please use the Login tab to sign in.');
          }

          console.log('[Registration] ‚úÖ Student found in database:', studentData);

          // Step 2: Create Supabase Auth account
          console.log('[Registration] Creating Supabase Auth account...');
          const { data: authData, error: authError } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
              emailRedirectTo: `${window.location.origin}/email-confirmed.html`,
            }
          });

          if (authError) {
            console.error('[Registration] ‚ùå Auth error:', authError);
            throw new Error('Failed to create account: ' + authError.message);
          }

          if (!authData.user) {
            throw new Error('Failed to create user account. Please try again.');
          }

          const userId = authData.user.id;
          console.log('[Registration] ‚úÖ Auth account created with UUID:', userId);

          // Step 3: Link auth account to student record via RPC (bypasses RLS safely)
          const { data: linkResult, error: linkError } = await supabase.rpc(
            'link_student_auth_account',
            {
              p_student_id: studentData.id,
              p_auth_user_id: userId
            }
          );

          if (linkError) {
            console.error('[Registration] ‚ùå Error linking account:', linkError);
            throw new Error('Account created but linking failed. Please contact admin.');
          }

          const linkedStudent = Array.isArray(linkResult) ? linkResult[0] : linkResult;
          console.log('[Registration] ‚úÖ Account linked to student record ID:', linkedStudent?.id || studentData.id);

          // Clear form and close modal immediately
          registrationModal.classList.remove('active');
          clearRegistrationForm();
          
          // Show success popup notification
          console.log('[Registration] ‚úÖ Registration completed successfully');
          await customAlert(
            'üéâ Account Created Successfully!',
            'Thank you for registering! A confirmation email has been sent to your inbox. Please confirm your email address, then you can log in.',
            'success'
          );

          // Clear form and close modal after delay
        } catch (error) {
          console.error('[Registration] ‚ùå Registration failed:', error);
          
          // Show error as popup instead of inline message
          await customAlert(
            'Registration Error',
            error.message || 'Registration failed. Please try again.',
            'error'
          );
        } finally {
          submitRegistration.disabled = false;
          submitRegistration.classList.remove('loading');
          submitRegistration.textContent = 'Submit Registration';
        }
      };

      // Send registration confirmation email
      async function sendRegistrationEmail(studentData) {
        try {
          const emailHTML = generateRegistrationEmailHTML(studentData);

          const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({
              to: studentData.email,
              subject: 'Welcome to ARNOMA NCLEX ‚Äî Registration Received',
              html: emailHTML,
            }),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.warn('[Registration] ‚ö†Ô∏è Email sending failed:', errorData);
            // Don't throw error - registration was successful even if email fails
          } else {
            const result = await response.json();
            console.log('[Registration] ‚úÖ Confirmation email sent:', result);
            
            // Log to sent_emails and notifications tables
            try {
              const resendEmailId = result?.id || result?.data?.id || null;
              const fullName = `${studentData.first_name} ${studentData.last_name}`;
              
              // 1. Log to sent_emails table (for Email System)
              const sentEmailRecord = {
                recipient_email: studentData.email,
                recipient_name: fullName,
                subject: 'Welcome to ARNOMA NCLEX ‚Äî Registration Received',
                html_content: emailHTML,
                template_name: 'Registration Confirmation',
                email_type: 'registration',
                resend_id: resendEmailId,
                delivery_status: 'delivered',
                status: 'sent',
                sent_at: new Date().toISOString()
              };
              
              const { error: logError } = await supabase.from('sent_emails').insert([sentEmailRecord]);
              if (logError) console.error('‚ö†Ô∏è Failed to log registration email:', logError);
              
              // 2. Log to notifications table (for Notification Center bell)
              const notificationRecord = {
                type: 'email_sent',
                category: 'email',
                title: 'Registration Confirmation Sent',
                description: `Welcome email sent to ${fullName} (${studentData.email})`,
                student_name: fullName,
                metadata: {
                  student_name: fullName,
                  email: studentData.email,
                  phone: studentData.phone,
                  email_type: 'registration',
                  subject: 'Welcome to ARNOMA NCLEX ‚Äî Registration Received',
                  html: emailHTML
                },
                timestamp: new Date().toISOString(),
                read: false,
                created_at: new Date().toISOString()
              };
              
              const { error: notifError } = await supabase.from('notifications').insert([notificationRecord]);
              if (notifError) console.error('‚ö†Ô∏è Failed to log registration notification:', notifError);
              
            } catch (logErr) {
              console.error('‚ö†Ô∏è Error logging notifications (email still sent):', logErr);
            }
          }
        } catch (error) {
          console.warn('[Registration] ‚ö†Ô∏è Email error (non-critical):', error.message);
          // Don't throw - email is secondary to registration
        }
      }

      // Generate registration confirmation email HTML
      function generateRegistrationEmailHTML(studentData) {
        const fullName = `${studentData.first_name} ${studentData.last_name}`;

        return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome to ARNOMA</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background-color: #f5f5f5;">
  <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f5f5f5; padding: 40px 20px;">
    <tr>
      <td align="center">
        <table width="600" cellpadding="0" cellspacing="0" style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
          
          <!-- Header with gradient -->
          <tr>
            <td style="background: linear-gradient(135deg, #26ffe6 0%, #8a4dff 100%); padding: 40px 30px; text-align: center;">
              <h1 style="margin: 0; color: #000; font-size: 28px; font-weight: 700;">
                üìù Registration Received
              </h1>
            </td>
          </tr>

          <!-- Main Content -->
          <tr>
            <td style="padding: 40px 30px;">
              <h2 style="color: #1a1a2e; margin-top: 0; margin-bottom: 16px;">
                Welcome, ${fullName}!
              </h2>
              
              <p style="color: #4a5568; line-height: 1.6; margin-bottom: 20px; font-size: 16px;">
                Thank you for registering with <strong>ARNOMA NCLEX-RN</strong>. We've received your application and added you to our waiting list.
              </p>

              <!-- Info Box -->
              <div style="background: linear-gradient(135deg, rgba(38,255,230,0.1) 0%, rgba(138,77,255,0.1) 100%); border-left: 4px solid #26ffe6; padding: 20px; border-radius: 8px; margin: 24px 0;">
                <p style="margin: 0; color: #1a1a2e; font-size: 14px; line-height: 1.6;">
                  <strong>üìã Your Registration Details:</strong><br><br>
                  <strong>Name:</strong> ${fullName}<br>
                  <strong>Email:</strong> ${studentData.email}<br>
                  <strong>Phone:</strong> ${studentData.phone}<br>
                  <strong>Preferred Language:</strong> ${studentData.preferred_language}
                </p>
              </div>

              <p style="color: #4a5568; line-height: 1.6; margin-bottom: 20px; font-size: 16px;">
                Our admissions team will review your application and contact you soon to discuss the next steps.
              </p>

              <p style="color: #4a5568; line-height: 1.6; margin-bottom: 30px; font-size: 16px;">
                In the meantime, if you have any questions, feel free to reach out to us.
              </p>

              <!-- CTA Button -->
              <table cellpadding="0" cellspacing="0" style="margin: 30px 0;">
                <tr>
                  <td align="center" style="background: linear-gradient(135deg, #26ffe6 0%, #8a4dff 100%); border-radius: 12px; padding: 14px 32px;">
                    <a href="mailto:info@arnoma.com" style="color: #000; text-decoration: none; font-weight: 600; font-size: 16px; display: block;">
                      üìß Contact Us
                    </a>
                  </td>
                </tr>
              </table>

              <p style="color: #718096; font-size: 14px; margin-top: 30px;">
                We're excited to have you join our community!
              </p>
            </td>
          </tr>

          <!-- Footer -->
          <tr>
            <td style="background: #f7fafc; padding: 30px; text-align: center; border-top: 1px solid #e2e8f0;">
              <p style="margin: 0; color: #718096; font-size: 14px; line-height: 1.6;">
                <strong>ARNOMA NCLEX-RN</strong><br>
                Excellence in Nursing Education<br>
                <a href="mailto:info@arnoma.com" style="color: #26ffe6; text-decoration: none;">info@arnoma.com</a>
              </p>
              <p style="margin: 16px 0 0 0; color: #a0aec0; font-size: 12px;">
                This is an automated message. Please do not reply to this email.
              </p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>
</body>
</html>`;
      }
    </script>
  </body>
</html>
