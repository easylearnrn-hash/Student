<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Portal Admin - ARNOMA</title>
  <link rel="icon" type="image/png" href="/richyfesta-logo.png">
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="shared-auth.js"></script>
  <script src="shared-dialogs.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 50%, rgba(102,126,234,0.08) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(118,75,162,0.08) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }
    
    .header {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 32px 40px;
      border-radius: 24px;
      box-shadow: 0 25px 60px rgba(13, 16, 35, 0.7), 
                  inset 0 1px 0 rgba(255,255,255,0.05);
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .header-title h1 {
      font-size: 36px;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
      text-shadow: 0 2px 20px rgba(0,0,0,0.2);
    }
    
    .back-btn {
      padding: 12px 24px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
    }
    
    .tabs {
      display: flex;
      gap: 16px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 14px 28px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.7);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .tab:hover {
      background: rgba(255,255,255,0.12);
      color: white;
    }
    
    .tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-color: rgba(102,126,234,0.3);
      color: white;
      box-shadow: 0 4px 20px rgba(102,126,234,0.3);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 25px 60px rgba(13, 16, 35, 0.7), inset 0 1px 0 rgba(255,255,255,0.05);
      margin-bottom: 24px;
    }
    
    .card-title {
      font-size: 22px;
      color: #ffffff;
      font-weight: 700;
      margin: 0 0 24px 0;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15));
      border: 1px solid rgba(255,255,255,0.12);
      padding: 24px;
      border-radius: 16px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.7), rgba(30, 41, 80, 0.6));
    }
    
    thead {
      background: rgba(102,126,234,0.15);
    }
    
    th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      color: #ffffff;
      font-size: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
    }
    
    td {
      padding: 14px 16px;
      color: rgba(255,255,255,0.9);
      font-size: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    tr:hover {
      background: rgba(102,126,234,0.08);
    }
    
    .action-btn {
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .action-btn.view {
      background: rgba(59,130,246,0.15);
      color: #3b82f6;
      border-color: rgba(59,130,246,0.3);
    }
    
    .action-btn.edit {
      background: rgba(251,188,4,0.15);
      color: #fbbc04;
      border-color: rgba(251,188,4,0.3);
    }
    
    .action-btn.delete {
      background: rgba(239,68,68,0.15);
      color: #ef4444;
      border-color: rgba(239,68,68,0.3);
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.2);
    }
    
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .search-input {
      flex: 1;
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      color: white;
      font-size: 14px;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
    }
    
    .add-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102,126,234,0.4);
    }
    
    .btn-filter {
      padding: 12px 20px;
      background: rgba(34,197,94,0.15);
      color: #22c55e;
      border: 2px solid rgba(34,197,94,0.3);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      margin-right: 8px;
    }
    
    .btn-filter:hover {
      background: rgba(34,197,94,0.25);
      border-color: rgba(34,197,94,0.5);
      transform: translateY(-2px);
    }
    
    .btn-filter.active {
      background: #22c55e;
      color: white;
      box-shadow: 0 4px 12px rgba(34,197,94,0.4);
    }
    
    .group-filter {
      padding: 12px 16px;
      background: rgba(255,255,255,0.08);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      margin-right: 8px;
      min-width: 150px;
    }
    
    .group-filter:hover {
      background: rgba(255,255,255,0.12);
      border-color: rgba(102,126,234,0.5);
    }
    
    .group-filter:focus {
      outline: none;
      border-color: rgba(102,126,234,0.6);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
    }
    
    .group-filter option {
      background: #1e293b;
      color: white;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .badge.active {
      background: rgba(34,197,94,0.15);
      color: #22c55e;
    }
    
    .badge.inactive {
      background: rgba(148,163,184,0.15);
      color: #94a3b8;
    }
    
    .badge.locked {
      background: rgba(239,68,68,0.15);
      color: #ef4444;
    }
    
    .badge.free {
      background: rgba(52,168,83,0.15);
      color: #34a853;
    }
    
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 24px;
      padding: 32px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
    }
    
    .close-modal {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .close-modal:hover {
      background: rgba(239,68,68,0.25);
      transform: rotate(90deg);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      color: rgba(255,255,255,0.9);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      color: white;
      font-size: 14px;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }
    
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
      background: rgba(148,163,184,0.3);
      border-radius: 15px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .toggle-switch.on {
      background: #22c55e;
    }
    
    .toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    
    .toggle-switch.on .toggle-slider {
      transform: translateX(30px);
    }
    
    .submit-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102,126,234,0.4);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,0.5);
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.7);
    }

    /* Status Modal Styles */
    .status-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    .status-modal-content {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 0;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .status-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 32px;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-modal-header h3 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .close-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 24px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .status-modal-body {
      padding: 32px;
      overflow-y: auto;
      max-height: calc(80vh - 100px);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      margin-bottom: 24px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-indicator.online .status-dot {
      background: #10b981;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }

    .status-indicator.offline .status-dot {
      background: #ef4444;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      font-size: 20px;
      font-weight: 600;
      color: white;
    }

    .status-details {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 32px;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
    }

    .status-label {
      color: rgba(255, 255, 255, 0.6);
      font-weight: 500;
    }

    .status-value {
      color: white;
      font-weight: 600;
    }
    
    .stats-section {
      margin: 32px 0;
      padding: 24px;
      background: linear-gradient(145deg, rgba(102,126,234,0.1), rgba(118,75,162,0.08));
      border-radius: 16px;
      border: 1px solid rgba(102,126,234,0.2);
    }
    
    .stats-section h4 {
      margin: 0 0 20px 0;
      font-size: 18px;
      color: white;
      font-weight: 700;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
    }
    
    .stat-item {
      text-align: center;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 8px;
      text-shadow: 0 0 20px rgba(102,126,234,0.5);
    }
    
    .stat-label {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-history h4 {
      margin: 0 0 16px 0;
      font-size: 18px;
      color: rgba(255, 255, 255, 0.8);
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      font-size: 14px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    
    .history-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-date {
      color: white;
      font-weight: 600;
      flex: 1;
    }

    .history-duration {
      color: #667eea;
      font-weight: 700;
      margin: 0 12px;
    }
    
    .history-details {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    
    .history-details span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .history-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .history-status.active {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .history-status.ended {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.6);
    }

    .action-btn.info {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      padding: 8px 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .action-btn.info.online {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
      animation: pulseGreen 2s infinite;
    }

    .action-btn.info.was-online {
      background: linear-gradient(135deg, #065f46, #047857);
      box-shadow: 0 0 10px rgba(6, 95, 70, 0.3);
    }

    @keyframes pulseGreen {
      0%, 100% {
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
      }
      50% {
        box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
      }
    }

    .action-btn.info svg {
      display: block;
    }

    .action-btn.info:hover {
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }

    .action-btn.info.online:hover {
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.6);
    }

    .action-btn.info.was-online:hover {
      box-shadow: 0 4px 15px rgba(6, 95, 70, 0.5);
    }

    /* Folder Accordion Styles */
    .folder-section {
      margin-bottom: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .folder-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      cursor: pointer;
      background: rgba(255,255,255,0.03);
      transition: all 0.3s ease;
      user-select: none;
    }

    .folder-header:hover {
      background: rgba(255,255,255,0.08);
    }

    .folder-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .folder-icon {
      font-size: 24px;
      transition: transform 0.3s ease;
    }

    .folder-section.expanded .folder-icon {
      transform: rotate(90deg);
    }

    .folder-name {
      font-size: 18px;
      font-weight: 600;
      color: white;
    }

    .folder-count {
      font-size: 14px;
      color: rgba(255,255,255,0.5);
      margin-left: 8px;
    }

    .folder-actions {
      display: flex;
      gap: 8px;
    }

    .folder-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    .folder-section.expanded .folder-content {
      max-height: 2000px;
    }

    .template-list {
      padding: 12px;
    }

    .template-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }

    .template-item:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(102,126,234,0.3);
    }

    .template-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .template-title {
      font-size: 16px;
      font-weight: 600;
      color: white;
      margin-bottom: 4px;
    }

    .template-meta {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
    }

    .template-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .template-content {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .template-footer {
      display: flex;
      gap: 12px;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .template-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-dot.open {
      background: #10b981;
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
    }

    .status-dot.closed {
      background: #ef4444;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
    }

    .mini-btn {
      padding: 6px 12px;
      font-size: 13px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mini-btn:hover {
      background: rgba(255,255,255,0.15);
    }

    .mini-btn.primary {
      background: rgba(102,126,234,0.2);
      border-color: rgba(102,126,234,0.4);
    }

    .mini-btn.primary:hover {
      background: rgba(102,126,234,0.3);
    }

    .mini-btn.danger {
      background: rgba(239,68,68,0.2);
      border-color: rgba(239,68,68,0.4);
    }

    .mini-btn.danger:hover {
      background: rgba(239,68,68,0.3);
    }

    .empty-folder {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255,255,255,0.5);
    }

    .empty-folder-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    /* Search and Controls */
    .notes-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      align-items: center;
    }

    .search-notes {
      flex: 1;
      padding: 12px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }

    .search-notes::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .folder-search {
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      color: white;
      font-size: 13px;
      margin: 12px;
      width: calc(100% - 24px);
    }

    .folder-search::placeholder {
      color: rgba(255,255,255,0.4);
    }

    /* Drag and Drop */
    .drag-handle {
      cursor: grab;
      padding: 4px 8px;
      color: rgba(255,255,255,0.4);
      font-size: 18px;
      user-select: none;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    .dragging {
      opacity: 0.5;
    }

    .drag-over {
      border-top: 2px solid #667eea;
    }

    .reorder-mode .folder-header,
    .reorder-mode .template-item {
      cursor: move;
    }

    .toggle-reorder-btn {
      padding: 8px 16px;
      background: rgba(102,126,234,0.2);
      border: 1px solid rgba(102,126,234,0.4);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .toggle-reorder-btn:hover {
      background: rgba(102,126,234,0.3);
    }

    .toggle-reorder-btn.active {
      background: rgba(102,126,234,0.4);
      border-color: rgba(102,126,234,0.6);
    }

    /* Full-Screen Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 9999;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content-fullscreen {
      position: relative;
      width: 95vw;
      height: 95vh;
      background: #0b1220;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
      animation: slideUp 0.4s ease;
    }

    .modal-header-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 10;
    }

    .modal-header-bar h2 {
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
    }

    .modal-close-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      font-size: 24px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
      transform: scale(1.05);
    }

    .modal-iframe-container {
      position: absolute;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .modal-iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Fullscreen Impersonation Modal */
    .impersonation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: none;
      flex-direction: column;
    }

    .impersonation-modal.active {
      display: flex;
    }

    .impersonation-header {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .impersonation-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .impersonation-title .emoji {
      font-size: 24px;
    }

    .impersonation-close {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-weight: 300;
    }

    .impersonation-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .impersonation-iframe {
      flex: 1;
      width: 100%;
      border: none;
      background: white;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-title">
        <h1>üéõÔ∏è Student Portal Admin</h1>
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="back-btn" onclick="window.location.href='Test-Manager.html'">
          üìù Test Manager
        </button>
        <button class="back-btn" onclick="window.location.href='student-portal.html'">
          ‚Üê Back to Portal
        </button>
      </div>
    </div>
    
    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalStudents">0</div>
        <div class="stat-label">Total Students</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalNotes">0</div>
        <div class="stat-label">PDF Notes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalPayments">0</div>
        <div class="stat-label">Payments Recorded</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="forumMessages">0</div>
        <div class="stat-label">Forum Messages</div>
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('students')">
        <span>üë•</span> Students
      </div>
      <div class="tab" onclick="switchTab('notes')">
        <span>üìÑ</span> PDF Notes
      </div>
      <div class="tab" onclick="switchTab('groupNotes')">
        <span>üìö</span> Group Notes
      </div>
      <div class="tab" onclick="switchTab('payments')">
        <span>üí≥</span> Payments
      </div>
      <div class="tab" onclick="switchTab('forum')">
        <span>üí¨</span> Forum
      </div>
      <div class="tab" onclick="switchTab('systems')">
        <span>üéØ</span> NCLEX Systems
      </div>
    </div>
    
    <!-- Students Tab -->
    <div id="studentsTab" class="tab-content active">
      <div class="card">
        <div class="card-title">Manage Students</div>
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search students..." id="studentSearch" onkeyup="filterStudents()">
          <select class="group-filter" id="groupFilterSelect" onchange="filterStudents()" title="Filter by group">
            <option value="">All Groups</option>
          </select>
          <button class="btn-filter" id="onlineFilterBtn" onclick="toggleOnlineFilter()" title="Show only online students">
            üü¢ Online Now
          </button>
          <button class="add-btn" onclick="openStudentModal()">+ Add Student</button>
        </div>
        <div class="table-container">
          <table id="studentsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Group</th>
                <th>Schedule</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="studentsTableBody">
              <tr>
                <td colspan="6" class="loading">Loading students...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Notes Tab -->
    <div id="notesTab" class="tab-content">
      <div class="card">
        <div class="card-title">Manage PDF Notes (Legacy)</div>
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search notes..." id="notesSearch" onkeyup="filterNotes()">
          <button class="add-btn" onclick="window.open('Notes-Manager.html', '_blank')">+ Upload New Note</button>
        </div>
        <div class="table-container">
          <table id="notesTable">
            <thead>
              <tr>
                <th>Title</th>
                <th>System</th>
                <th>Group</th>
                <th>Date</th>
                <th>Access</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="notesTableBody">
              <tr>
                <td colspan="6" class="loading">Loading notes...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Group Notes Tab -->
    <div id="groupNotesTab" class="tab-content">
      <!-- Embedded Group Notes Manager -->
      <div class="card" style="padding: 0; overflow: hidden;">
        <iframe 
          src="Group-Notes.html"
          title="Group Notes Manager"
          style="width: 100%; height: 900px; border: none; background: #0b1220;"
          loading="lazy"
        >
        </iframe>
      </div>
    </div>
    
    <!-- Payments Tab -->
    <div id="paymentsTab" class="tab-content">
      <div class="card">
        <div class="card-title">Manage Payments</div>
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search payments..." id="paymentsSearch" onkeyup="filterPayments()">
          <button class="add-btn" onclick="window.open('Payment-Records.html', '_blank')">+ Add Payment</button>
        </div>
        <div class="table-container">
          <table id="paymentsTable">
            <thead>
              <tr>
                <th>Student</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Method</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody">
              <tr>
                <td colspan="6" class="loading">Loading payments...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Forum Tab -->
    <div id="forumTab" class="tab-content">
      <div class="card">
        <div class="card-title">Forum Messages</div>
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search messages..." id="forumSearch" onkeyup="filterForum()">
        </div>
        <div class="table-container">
          <table id="forumTable">
            <thead>
              <tr>
                <th>Author</th>
                <th>Message</th>
                <th>Date</th>
                <th>Replies</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="forumTableBody">
              <tr>
                <td colspan="5" class="loading">Loading forum messages...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Systems Tab -->
    <div id="systemsTab" class="tab-content">
      <div class="card">
        <div class="card-title">NCLEX Systems Progress</div>
        <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">
          Track student progress across all NCLEX systems. System progress is automatically calculated based on completed notes.
        </p>
        <div id="systemsOverview" class="loading">Loading systems...</div>
      </div>
    </div>
  </div>
  
  <!-- Student Modal -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="studentModalTitle">Add Student</h2>
        <button class="close-modal" onclick="closeStudentModal()">√ó</button>
      </div>
      <form id="studentForm" onsubmit="saveStudent(event)">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-input" id="studentName" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="studentEmail" required>
        </div>
        <div class="form-group">
          <label class="form-label">Group</label>
          <select class="form-select" id="studentGroup" required>
            <option value="">Select Group</option>
            <option value="A">Group A</option>
            <option value="B">Group B</option>
            <option value="C">Group C</option>
            <option value="D">Group D</option>
            <option value="E">Group E</option>
            <option value="F">Group F</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Schedule</label>
          <select class="form-select" id="studentSchedule" required>
            <option value="">Select Schedule</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Price Per Class ($)</label>
          <input type="number" class="form-input" id="studentPrice" value="50">
        </div>
        <button type="submit" class="submit-btn">Save Student</button>
      </form>
    </div>
  </div>
  
  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    if (window.ArnomaAuth?.attachAuthListener) {
      window.ArnomaAuth.attachAuthListener(supabase);
    }

    let adminSessionPromise = null;
    async function ensureAdminSession() {
      if (!adminSessionPromise) {
        adminSessionPromise = (async () => {
          try {
            const session = window.ArnomaAuth
              ? await window.ArnomaAuth.ensureSession(supabase, { redirectToLogin: true })
              : (await supabase.auth.getSession()).data.session;

            if (!session?.user?.email) {
              throw new Error('Admin session missing email');
            }

            currentEmail = session.user.email;
            return session;
          } catch (error) {
            console.error('Admin authentication failed:', error);
            window.location.href = 'index.html';
            throw error;
          }
        })();
      }

      return adminSessionPromise;
    }

    function canonicalizeGroupCode(value) {
      if (!value) return '';
      const raw = value.toString().trim();
      if (!raw) return '';
      let normalized = raw.replace(/^group\s+/i, '');
      normalized = normalized.replace(/[^a-z0-9]/gi, '');
      return normalized.toUpperCase();
    }

    function formatGroupLabel(code) {
      return code ? code.toUpperCase() : '-';
    }
    
    let currentStudentId = null;
    let currentEmail = null; // Track admin email for audit logging
    
    // Tab Switching
    function switchTab(tab) {
      // Update tabs
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.closest('.tab').classList.add('active');
      
      // Update content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tab + 'Tab').classList.add('active');
      
      // Load data for tab
      if (tab === 'students') loadStudents();
      if (tab === 'notes') loadNotes();
      // Group Notes tab now uses standalone page (Group-Notes.html)
      if (tab === 'payments') loadPayments();
      if (tab === 'forum') loadForum();
      if (tab === 'systems') loadSystems();
    }
    
    // Load Stats
    async function loadStats() {
      try {
        console.log('üìä [loadStats] Starting stats load...');
        // TEMPORARILY SKIP AUTH CHECK - remove this later
        // await ensureAdminSession();
        
        // Total Students
        const { count: studentCount, error: studentError } = await supabase
          .from('students')
          .select('*', { count: 'exact', head: true });
        console.log('üë• [loadStats] Students count:', studentCount, 'Error:', studentError);
        document.getElementById('totalStudents').textContent = studentCount || 0;
        
        // Total Notes - ONLY count non-deleted notes
        try {
          const { count: notesCount, error: notesError } = await supabase
            .from('student_notes')
            .select('*', { count: 'exact', head: true })
            .eq('deleted', false);
          console.log('üìù [loadStats] Notes count (deleted=false):', notesCount, 'Error:', notesError);
          document.getElementById('totalNotes').textContent = notesCount || 0;
        } catch (err) {
          console.warn('‚ùå [loadStats] Could not load notes count (RLS?):', err);
          document.getElementById('totalNotes').textContent = '-';
        }
        
        // Total Payments - ONLY count paid status from payment_records + all Zelle
        const [manualCount, zelleCount] = await Promise.all([
          supabase
            .from('payment_records')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'paid'), // Only count paid records
          supabase
            .from('payments')
            .select('*', { count: 'exact', head: true })
        ]);
        console.log('üí∞ [loadStats] Payment counts - Manual (paid only):', manualCount.count, 'Zelle:', zelleCount.count);
        console.log('üí∞ [loadStats] Manual error:', manualCount.error, 'Zelle error:', zelleCount.error);
        const totalPayments = (manualCount.count || 0) + (zelleCount.count || 0);
        console.log('üí∞ [loadStats] Total payments:', totalPayments);
        document.getElementById('totalPayments').textContent = totalPayments;
        
        // Forum Messages (may fail if RLS restricts access)
        try {
          const { count: forumCount } = await supabase
            .from('nurses_forum')
            .select('*', { count: 'exact', head: true })
            .is('parent_id', null);
          document.getElementById('forumMessages').textContent = forumCount || 0;
        } catch (err) {
          console.warn('Could not load forum count (RLS?):', err);
          document.getElementById('forumMessages').textContent = '-';
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }
    
    // Helper to parse and format schedule for display
    function parseScheduleString(scheduleStr) {
      if (!scheduleStr) return [];

      // If already an array, handle each item
      if (Array.isArray(scheduleStr)) {
        const allSessions = [];
        scheduleStr.forEach(item => {
          allSessions.push(...parseScheduleString(item));
        });
        return allSessions;
      }

      // Try to parse as JSON first
      if (typeof scheduleStr === 'string') {
        try {
          const parsed = JSON.parse(scheduleStr);
          if (Array.isArray(parsed)) {
            return parseScheduleString(parsed);
          }
        } catch {
          // Not JSON, continue with string parsing
        }
      }

      const sessions = [];
      const parts = scheduleStr.toString().split(',').map(s => s.trim());

      parts.forEach(part => {
        // Handle "Tuesday/Friday 3:00 PM" format (slash-separated days)
        const slashMatch = part.match(/^([A-Za-z/]+)\s+(.+)$/);
        if (slashMatch) {
          const daysStr = slashMatch[1];
          const time = slashMatch[2];
          const days = daysStr.split('/').map(d => d.trim());

          days.forEach(day => {
            const normalized = normalizeDay(day);
            if (normalized) {
              sessions.push({ day: normalized, time: time });
            }
          });
        } else {
          // Handle "Tuesday 3:00 PM" format (single day)
          const spaceMatch = part.match(/^([A-Za-z]+)\s+(.+)$/);
          if (spaceMatch) {
            const day = normalizeDay(spaceMatch[1]);
            const time = spaceMatch[2];
            if (day) {
              sessions.push({ day: day, time: time });
            }
          }
        }
      });

      return sessions;

      function normalizeDay(day) {
        if (!day || typeof day !== 'string') return '';
        const map = {
          'sun': 'Sunday', 'sunday': 'Sunday',
          'mon': 'Monday', 'monday': 'Monday',
          'tue': 'Tuesday', 'tues': 'Tuesday', 'tuesday': 'Tuesday',
          'wed': 'Wednesday', 'weds': 'Wednesday', 'wednesday': 'Wednesday',
          'thu': 'Thursday', 'thur': 'Thursday', 'thurs': 'Thursday', 'thursday': 'Thursday',
          'fri': 'Friday', 'friday': 'Friday',
          'sat': 'Saturday', 'saturday': 'Saturday'
        };
        return map[day.toLowerCase()] || day;
      }
    }

    function formatScheduleDisplay(scheduleStr) {
      const sessions = parseScheduleString(scheduleStr);
      if (sessions.length === 0) return '-';
      
      return sessions.map(s => {
        // Abbreviate day name (Monday -> Mon, Tuesday -> Tue, etc.)
        const dayAbbr = s.day.substring(0, 3);
        
        // Simplify time format (remove minutes if :00, simplify AM/PM)
        let simpleTime = s.time
          .replace(':00', '') // Remove :00 minutes
          .replace(' AM', ' AM')
          .replace(' PM', ' PM')
          .replace(/(\d+) (AM|PM)/, '$1 $2'); // Ensure space between number and AM/PM
        
        return `${dayAbbr} ${simpleTime}`;
      }).join(', ');
    }
    
    // Load Students
    async function loadStudents() {
      console.log('üîÑ Loading students...');
      try {
        // TEMPORARILY SKIP AUTH CHECK - remove this later
        console.log('‚ö†Ô∏è Skipping auth check temporarily...');
        // await ensureAdminSession();
        
        console.log('üìä Fetching students and groups...');
        // Fetch students and groups
        const [studentsResult, groupsResult] = await Promise.all([
          supabase.from('students').select('*').order('name'),
          supabase.from('groups').select('*')
        ]);
        
        console.log('Students result:', studentsResult);
        console.log('Groups result:', groupsResult);
        
        if (studentsResult.error) {
          console.error('‚ùå Students query error:', studentsResult.error);
          throw studentsResult.error;
        }
        
        const students = studentsResult.data || [];
        const groups = groupsResult.data || [];
        
        console.log(`‚úÖ Loaded ${students.length} students and ${groups.length} groups`);
        
        // Try to fetch active sessions (may fail if table doesn't exist yet)
        let activeSessions = [];
        let allSessionsMap = {};
        try {
          // FIX: Query student_sessions table (not session_logs)
          const sessionsResult = await supabase
            .from('student_sessions')
            .select('student_id, is_active, last_activity')
            .eq('is_active', true);
          
          if (!sessionsResult.error) {
            const allSessions = sessionsResult.data || [];
            console.log('‚úÖ Raw active sessions from student_sessions:', allSessions);
            
            // CRITICAL FIX: Only consider sessions with activity in last 10 minutes as "online"
            // This prevents stale sessions from showing students as online when they're not
            const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000).toISOString();
            activeSessions = allSessions.filter(session => {
              return session.last_activity && session.last_activity > tenMinutesAgo;
            });
            console.log(`‚úÖ Filtered to ${activeSessions.length} truly active sessions (activity < 10 min ago)`);
          } else {
            console.log('‚ö†Ô∏è Student sessions query error:', sessionsResult.error);
          }
          
          // Also get all students who have ever logged in
          const allSessionsResult = await supabase
            .from('student_sessions')
            .select('student_id')
            .limit(1000);
          
          if (!allSessionsResult.error) {
            const allSessions = allSessionsResult.data || [];
            allSessions.forEach(s => {
              allSessionsMap[s.student_id] = true;
            });
          }
        } catch (sessionError) {
          console.log('‚ö†Ô∏è Student sessions table not available yet (table may not exist):', sessionError);
        }
        
        // Create online status map
        const onlineMap = {};
        activeSessions.forEach(session => {
          onlineMap[session.student_id] = true;
        });
        
        // Create group lookup map
        const groupMap = {};
        const uniqueGroups = new Set();
        groups.forEach(g => {
          const code = canonicalizeGroupCode(g.group_name || g.name || '');
          if (code) {
            groupMap[code] = g;
            uniqueGroups.add(code);
          }
        });
        
        // Populate group filter dropdown
        const groupFilter = document.getElementById('groupFilterSelect');
        if (groupFilter) {
          // Store current selection
          const currentSelection = groupFilter.value;
          
          // Build options
          const options = ['<option value="">All Groups</option>'];
          Array.from(uniqueGroups).sort().forEach(code => {
            options.push(`<option value="${code}">${formatGroupLabel(code)}</option>`);
          });
          groupFilter.innerHTML = options.join('');
          
          // Restore selection if it still exists
          if (currentSelection && uniqueGroups.has(currentSelection)) {
            groupFilter.value = currentSelection;
          }
        }
        
        const tbody = document.getElementById('studentsTableBody');
        
        if (students.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üë•</div><div>No students found</div></td></tr>';
          return;
        }
        
        tbody.innerHTML = students.map(student => {
          const groupCode = canonicalizeGroupCode(student.group_name || student.group || '');
          const group = groupMap[groupCode];
          const schedule = group ? formatScheduleDisplay(group.schedule) : '-';
          const isOnline = onlineMap[student.id];
          const hasLoggedIn = allSessionsMap[student.id];
          
          // Determine status class: online (bright green) | was-online (dark green) | default (blue)
          let statusClass = '';
          if (isOnline) {
            statusClass = 'online';
          } else if (hasLoggedIn) {
            statusClass = 'was-online';
          }
          
          return `
          <tr data-group="${groupCode}" data-student-name="${(student.name || '').toLowerCase()}">
            <td>${student.name || '-'}</td>
            <td>${student.email || '-'}</td>
            <td>${formatGroupLabel(groupCode)}</td>
            <td>${schedule}</td>
            <td><span class="badge ${student.show_in_grid ? 'active' : 'inactive'}">${student.show_in_grid ? 'Active' : 'Inactive'}</span></td>
            <td>
              <button class="action-btn info ${statusClass}" onclick="showStudentStatus(${student.id}, '${student.name?.replace(/'/g, "\\'") || 'Unknown'}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
              </button>
              <button class="action-btn view" onclick="impersonateStudent(${student.id}, '${student.name?.replace(/'/g, "\\'") || 'Unknown'}')">üëÅÔ∏è View as Student</button>
              <button class="action-btn edit" onclick="editStudent(${student.id})">Edit</button>
              <button class="action-btn delete" onclick="deleteStudent(${student.id})">Delete</button>
            </td>
          </tr>
        `;
        }).join('');
      } catch (error) {
        console.error('Error loading students:', error);
        document.getElementById('studentsTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center; color: #ef4444;">Error loading students</td></tr>';
      }
    }
    
    // Load Notes
    async function loadNotes() {
      try {
        await ensureAdminSession();
        const { data: notes, error } = await supabase
          .from('student_notes')
          .select('*')
          .eq('deleted', false)
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Error loading notes (RLS?):', error);
          throw error;
        }
        
        const tbody = document.getElementById('notesTableBody');
        
        if (!notes || notes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üìÑ</div><div>No notes found</div></td></tr>';
          return;
        }
        
        tbody.innerHTML = notes.map(note => `
          <tr>
            <td>${note.title || 'Untitled'}</td>
            <td>${note.system || '-'}</td>
            <td>${note.group_name || '-'}</td>
            <td>${note.class_date ? new Date(note.class_date).toLocaleDateString() : '-'}</td>
            <td><span class="badge ${note.requires_payment ? 'locked' : 'free'}">${note.requires_payment ? 'üîí Locked' : '‚úì Free'}</span></td>
            <td>
              <button class="action-btn view" onclick="viewNote(${note.id})">View</button>
              <button class="action-btn delete" onclick="deleteNote(${note.id})">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading notes:', error);
        document.getElementById('notesTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center; color: #ef4444;">Error loading notes</td></tr>';
      }
    }
    
    // Group Notes now handled by standalone Group-Notes.html page
    
    // Load Payments
    async function loadPayments() {
      try {
        await ensureAdminSession();
        // Fetch from BOTH payment_records (manual) and payments (Zelle)
        const [manualResult, zelleResult] = await Promise.all([
          supabase
            .from('payment_records')
            .select('*, students(name)')
            .order('date', { ascending: false }),
          supabase
            .from('payments')
            .select('*')
            .order('payment_date', { ascending: false })
        ]);
        
        if (manualResult.error) throw manualResult.error;
        if (zelleResult.error) throw zelleResult.error;
        
        // Normalize manual payments
        const manualPayments = (manualResult.data || []).map(p => ({
          id: p.id,
          student_name: p.students?.name || 'Unknown',
          date: p.date,
          amount: p.amount,
          status: p.status,
          method: p.payment_method || 'Manual',
          source: 'payment_records'
        }));
        
        // Normalize Zelle payments
        const zellePayments = (zelleResult.data || []).map(p => ({
          id: p.id,
          student_name: p.resolved_student_name || p.sender_name || 'Unknown',
          date: p.payment_date,
          amount: p.amount,
          status: 'paid',
          method: 'Zelle',
          source: 'payments'
        }));
        
        // Combine and sort by date
        const allPayments = [...manualPayments, ...zellePayments].sort((a, b) => 
          new Date(b.date) - new Date(a.date)
        );
        
        const tbody = document.getElementById('paymentsTableBody');
        
        if (allPayments.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üí≥</div><div>No payments found</div></td></tr>';
          return;
        }
        
        tbody.innerHTML = allPayments.map(payment => `
          <tr>
            <td>${payment.student_name}</td>
            <td>${payment.date ? new Date(payment.date).toLocaleDateString() : '-'}</td>
            <td>$${payment.amount || 0}</td>
            <td><span class="badge ${payment.status === 'paid' ? 'active' : 'inactive'}">${payment.status || 'pending'}</span></td>
            <td>${payment.method}</td>
            <td>
              <button class="action-btn view" onclick="viewPayment('${payment.source}', ${payment.id})">View</button>
              ${payment.source === 'payment_records' ? `<button class="action-btn delete" onclick="deletePayment(${payment.id})">Delete</button>` : ''}
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading payments:', error);
        document.getElementById('paymentsTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center; color: #ef4444;">Error loading payments</td></tr>';
      }
    }
    
    // Load Forum
    async function loadForum() {
      try {
        const { data: messages, error } = await supabase
          .from('nurses_forum')
          .select(`
            *,
            students (name)
          `)
          .is('parent_id', null)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const tbody = document.getElementById('forumTableBody');
        
        if (!messages || messages.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">üí¨</div><div>No messages found</div></td></tr>';
          return;
        }
        
        // Count replies for each message
        const { data: replies } = await supabase
          .from('nurses_forum')
          .select('parent_id')
          .not('parent_id', 'is', null);
        
        const replyCounts = {};
        if (replies) {
          replies.forEach(reply => {
            replyCounts[reply.parent_id] = (replyCounts[reply.parent_id] || 0) + 1;
          });
        }
        
        tbody.innerHTML = messages.map(msg => `
          <tr>
            <td>${msg.students?.name || 'Anonymous'}</td>
            <td>${(msg.message || '').substring(0, 100)}${msg.message?.length > 100 ? '...' : ''}</td>
            <td>${new Date(msg.created_at).toLocaleDateString()}</td>
            <td>${replyCounts[msg.id] || 0}</td>
            <td>
              <button class="action-btn view" onclick="viewMessage(${msg.id})">View</button>
              <button class="action-btn delete" onclick="deleteMessage(${msg.id})">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading forum:', error);
        document.getElementById('forumTableBody').innerHTML = '<tr><td colspan="5" style="text-align:center; color: #ef4444;">Error loading forum</td></tr>';
      }
    }
    
    // Load Systems
    async function loadSystems() {
      const systemsDiv = document.getElementById('systemsOverview');
      
      const systems = [
        { name: 'Cardiovascular', icon: '‚ù§Ô∏è' },
        { name: 'Respiratory', icon: 'ü´Å' },
        { name: 'Neurological', icon: 'üß†' },
        { name: 'Gastrointestinal', icon: 'üè•' },
        { name: 'Renal', icon: 'üíß' },
        { name: 'Endocrine', icon: '‚öóÔ∏è' },
        { name: 'Musculoskeletal', icon: 'ü¶¥' },
        { name: 'Integumentary', icon: 'ü©π' },
        { name: 'Immune', icon: 'üõ°Ô∏è' },
        { name: 'Hematologic', icon: 'ü©∏' }
      ];
      
      systemsDiv.innerHTML = `
        <div class="stats-grid">
          ${systems.map(sys => `
            <div class="stat-card">
              <div style="font-size: 48px; margin-bottom: 12px;">${sys.icon}</div>
              <div style="font-weight: 600; color: white; margin-bottom: 8px;">${sys.name}</div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.6);">System Module</div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    // Student Modal Functions
    function openStudentModal() {
      currentStudentId = null;
      document.getElementById('studentModalTitle').textContent = 'Add Student';
      document.getElementById('studentForm').reset();
      document.getElementById('studentModal').classList.add('active');
    }
    
    function closeStudentModal() {
      document.getElementById('studentModal').classList.remove('active');
    }
    
    async function saveStudent(event) {
      event.preventDefault();
      
      const studentData = {
        name: document.getElementById('studentName').value,
        email: document.getElementById('studentEmail').value,
        group_name: canonicalizeGroupCode(document.getElementById('studentGroup').value) || null,
        schedule: document.getElementById('studentSchedule').value,
        price_per_class: parseInt(document.getElementById('studentPrice').value) || 50,
        show_in_grid: true
      };
      
      try {
        if (currentStudentId) {
          // Update existing
          const { error } = await supabase
            .from('students')
            .update(studentData)
            .eq('id', currentStudentId);
          
          if (error) throw error;
          alert('Student updated successfully!');
        } else {
          // Create new
          const { error } = await supabase
            .from('students')
            .insert([studentData]);
          
          if (error) throw error;
          alert('Student added successfully!');
        }
        
        closeStudentModal();
        loadStudents();
        loadStats();
      } catch (error) {
        console.error('Error saving student:', error);
        alert('Error saving student: ' + error.message);
      }
    }
    
    async function editStudent(id) {
      try {
        const { data, error } = await supabase
          .from('students')
          .select('*')
          .eq('id', id)
          .single();
        
        if (error) throw error;
        
        currentStudentId = id;
        document.getElementById('studentModalTitle').textContent = 'Edit Student';
        document.getElementById('studentName').value = data.name || '';
        document.getElementById('studentEmail').value = data.email || '';
  document.getElementById('studentGroup').value = canonicalizeGroupCode(data.group_name || data.group || '');
        document.getElementById('studentSchedule').value = data.schedule || '';
        document.getElementById('studentPrice').value = data.price_per_class || 50;
        
        document.getElementById('studentModal').classList.add('active');
      } catch (error) {
        console.error('Error loading student:', error);
        alert('Error loading student');
      }
    }
    
    function viewStudent(id) {
      window.open(`Student-Manager.html#student-${id}`, '_blank');
    }
    
    // Impersonate Student - View Portal as Student
    // Show student online status
    async function showStudentStatus(studentId, studentName) {
      try {
        await ensureAdminSession();
        
        // FIX: Query student_sessions table (not session_logs)
        const { data: sessions, error } = await supabase
          .from('student_sessions')
          .select('*')
          .eq('student_id', studentId)
          .order('session_start', { ascending: false })
          .limit(20);
        
        if (error) {
          console.error('Session query error:', error);
          throw error;
        }
        
        console.log('Sessions data:', sessions);
        
        // Calculate statistics (FIX: student_sessions doesn't have duration_seconds, page_views, or notes_viewed)
        // We need to calculate duration from session_start and session_end
        const activeSession = sessions?.find(s => s.is_active);
        const totalSessions = sessions?.length || 0;
        
        // Calculate total seconds by summing up session durations
        const totalSeconds = sessions?.reduce((sum, s) => {
          if (s.session_end && s.session_start) {
            const start = new Date(s.session_start);
            const end = new Date(s.session_end);
            return sum + Math.floor((end - start) / 1000);
          }
          // For active sessions, calculate from start to now
          if (s.is_active && s.session_start) {
            const start = new Date(s.session_start);
            const now = new Date();
            return sum + Math.floor((now - start) / 1000);
          }
          return sum;
        }, 0) || 0;
        
        const totalHours = (totalSeconds / 3600).toFixed(1);
        const avgSessionMinutes = totalSessions > 0 ? ((totalSeconds / totalSessions) / 60).toFixed(1) : 0;
        
        // Build status HTML
        let statusHTML = `
          <div class="status-modal-header">
            <h3>${studentName} - Session Analytics</h3>
            <button class="close-btn" onclick="closeStatusModal()">√ó</button>
          </div>
          <div class="status-modal-body">
        `;
        
        // Current Status Section
        if (activeSession) {
          const loginTime = new Date(activeSession.session_start);
          const lastActivity = new Date(activeSession.last_activity);
          const now = new Date();
          const sessionDuration = Math.floor((now - loginTime) / 1000 / 60); // minutes
          const idleMinutes = Math.floor((now - lastActivity) / 1000 / 60);
          
          statusHTML += `
            <div class="status-indicator online">
              <span class="status-dot"></span>
              <span class="status-text">üü¢ Currently Online</span>
            </div>
            <div class="status-details">
              <div class="status-row">
                <span class="status-label">Login Time:</span>
                <span class="status-value">${loginTime.toLocaleString()}</span>
              </div>
              <div class="status-row">
                <span class="status-label">Session Duration:</span>
                <span class="status-value">${sessionDuration} minutes</span>
              </div>
              <div class="status-row">
                <span class="status-label">Last Activity:</span>
                <span class="status-value">${idleMinutes === 0 ? 'Just now' : idleMinutes + ' minutes ago'}</span>
              </div>
            </div>
          `;
        } else if (sessions && sessions.length > 0) {
          const lastSession = sessions[0];
          // Calculate last session duration
          let lastSessionMinutes = 0;
          if (lastSession.session_end && lastSession.session_start) {
            const start = new Date(lastSession.session_start);
            const end = new Date(lastSession.session_end);
            lastSessionMinutes = Math.floor((end - start) / 1000 / 60);
          }
          const lastSeen = new Date(lastSession.session_end || lastSession.last_activity);
          
          statusHTML += `
            <div class="status-indicator offline">
              <span class="status-dot"></span>
              <span class="status-text">üî¥ Offline</span>
            </div>
            <div class="status-details">
              <div class="status-row">
                <span class="status-label">Last Seen:</span>
                <span class="status-value">${lastSeen.toLocaleString()}</span>
              </div>
              <div class="status-row">
                <span class="status-label">Last Session Duration:</span>
                <span class="status-value">${lastSessionMinutes} minutes</span>
              </div>
            </div>
          `;
        } else {
          statusHTML += `
            <div class="status-indicator offline">
              <span class="status-dot"></span>
              <span class="status-text">‚ö™ Never Logged In</span>
            </div>
          `;
        }
        
        // Overall Statistics Section
        if (totalSessions > 0) {
          statusHTML += `
            <div class="stats-section">
              <h4>üìä Overall Statistics</h4>
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-value">${totalSessions}</div>
                  <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">${totalHours}h</div>
                  <div class="stat-label">Total Study Time</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">${avgSessionMinutes}m</div>
                  <div class="stat-label">Avg Session</div>
                </div>
              </div>
            </div>
          `;
        }
        
        // Recent Session History
        if (sessions && sessions.length > 0) {
          statusHTML += `
            <div class="status-history">
              <h4>üìÖ Recent Session History</h4>
              <div class="history-list">
          `;
          
          sessions.slice(0, 10).forEach(session => {
            const start = new Date(session.session_start);
            const end = session.session_end ? new Date(session.session_end) : null;
            const durationMinutes = session.duration_seconds ? Math.floor(session.duration_seconds / 60) : 0;
            const hours = Math.floor(durationMinutes / 60);
            const minutes = durationMinutes % 60;
            const durationText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            
            statusHTML += `
              <div class="history-item">
                <div class="history-main">
                  <span class="history-date">${start.toLocaleDateString()} ${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                  <span class="history-duration">${session.is_active ? 'üü¢ Active - ' + durationText : durationText}</span>
                </div>
                <div class="history-details">
                  <span>üìÑ ${session.total_page_views || 0} pages</span>
                  <span>üìö ${session.total_notes_viewed || 0} notes</span>
                  ${end ? '<span>üèÅ ' + end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + '</span>' : ''}
                </div>
              </div>
            `;
          });
          
          statusHTML += `
              </div>
            </div>
          `;
        }
        
        statusHTML += `</div>`;
        
        // Show modal
        const modal = document.getElementById('statusModal');
        const modalContent = document.getElementById('statusModalContent');
        modalContent.innerHTML = statusHTML;
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('Error loading student status:', error);
        alert('Failed to load student status: ' + error.message);
      }
    }
    
    function closeStatusModal() {
      document.getElementById('statusModal').style.display = 'none';
    }
    
    function formatTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
      
      return date.toLocaleDateString();
    }

    async function impersonateStudent(studentId, studentName) {
      try {
        console.log('üö™ Starting impersonation request', { studentId, studentName, studentIdType: typeof studentId });
        
        // Ensure studentId is a number (not string)
        const numericStudentId = parseInt(studentId);
        if (isNaN(numericStudentId)) {
          alert('Invalid student ID');
          return;
        }
        
        // Generate impersonation token (valid for 10 minutes)
        const impersonationToken = {
          studentId: numericStudentId,  // Store as number
          studentName: studentName,
          timestamp: Date.now(),
          expiresAt: Date.now() + (10 * 60 * 1000), // 10 minutes
          adminEmail: currentEmail || 'admin'
        };
        
        // Store in BOTH sessionStorage AND localStorage for reliability
        sessionStorage.setItem('impersonation_token', JSON.stringify(impersonationToken));
        localStorage.setItem('impersonation_token', JSON.stringify(impersonationToken));
        
        // Log audit trail
        console.log('üé≠ Impersonation started:', {
          admin: impersonationToken.adminEmail,
          student: studentName,
          studentId: studentId,
          timestamp: new Date(impersonationToken.timestamp).toISOString()
        });
        console.log('‚úÖ Token stored in storage:', JSON.stringify(impersonationToken));
        
        // Small delay to ensure storage write completes
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Open in fullscreen modal instead of navigation
        const modal = document.getElementById('impersonationModal');
        const iframe = document.getElementById('impersonationIframe');
        const titleElement = document.getElementById('impersonationStudentName');
        
        // Update modal title
        titleElement.textContent = `Viewing as ${studentName}`;
        
        // Set iframe src with impersonation parameter
        iframe.src = `student-portal.html?impersonate=${studentId}`;
        
        // Show modal
        modal.classList.add('active');
        
      } catch (error) {
        console.error('Error starting impersonation:', error);
        alert('Failed to start impersonation mode: ' + error.message);
      }
    }
    
    function closeImpersonation() {
      const modal = document.getElementById('impersonationModal');
      const iframe = document.getElementById('impersonationIframe');
      
      // Clear iframe
      iframe.src = '';
      
      // Hide modal
      modal.classList.remove('active');
      
      // Clear impersonation tokens
      sessionStorage.removeItem('impersonation_token');
      localStorage.removeItem('impersonation_token');
      
      console.log('üö™ Impersonation session closed');
      
      // Refresh student list to update any changes
      loadStudents();
    }
    
    async function deleteStudent(id) {
      if (!confirm('Are you sure you want to delete this student?')) return;
      
      try {
        const { error } = await supabase
          .from('students')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        alert('Student deleted successfully!');
        loadStudents();
        loadStats();
      } catch (error) {
        console.error('Error deleting student:', error);
        alert('Error deleting student: ' + error.message);
      }
    }
    
    function viewNote(id) {
      window.open(`Protected-PDF-Viewer.html?note=${id}`, '_blank');
    }
    
    async function deleteNote(id) {
      if (!confirm('Are you sure you want to delete this note?')) return;
      
      try {
        const { error } = await supabase
          .from('student_notes')
          .update({ deleted: true })
          .eq('id', id);
        
        if (error) throw error;
        
        alert('Note deleted successfully!');
        loadNotes();
        loadStats();
      } catch (error) {
        console.error('Error deleting note:', error);
        alert('Error deleting note: ' + error.message);
      }
    }
    
    function viewPayment(source, id) {
      if (source === 'payment_records') {
        window.open(`Payment-Records.html#payment-${id}`, '_blank');
      } else {
        // Zelle payments - could open Payment-Records in Zelle view
        window.open(`Payment-Records.html`, '_blank');
      }
    }
    
    async function deletePayment(id) {
      if (!confirm('Are you sure you want to delete this payment record?')) return;
      
      try {
        const { error } = await supabase
          .from('payment_records')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        alert('Payment deleted successfully!');
        loadPayments();
        loadStats();
      } catch (error) {
        console.error('Error deleting payment:', error);
        alert('Error deleting payment: ' + error.message);
      }
    }
    
    function viewMessage(id) {
      alert(`View message ${id} - Feature coming soon!`);
    }
    
    async function deleteMessage(id) {
      if (!confirm('Are you sure you want to delete this message and all its replies?')) return;
      
      try {
        // Delete replies first
        await supabase
          .from('nurses_forum')
          .delete()
          .eq('parent_id', id);
        
        // Delete message
        const { error } = await supabase
          .from('nurses_forum')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        alert('Message deleted successfully!');
        loadForum();
        loadStats();
      } catch (error) {
        console.error('Error deleting message:', error);
        alert('Error deleting message: ' + error.message);
      }
    }
    
    // Filter Functions
    let showOnlineOnly = false;
    
    function toggleOnlineFilter() {
      showOnlineOnly = !showOnlineOnly;
      const btn = document.getElementById('onlineFilterBtn');
      
      if (showOnlineOnly) {
        btn.classList.add('active');
        btn.textContent = 'üü¢ Showing Online Only';
      } else {
        btn.classList.remove('active');
        btn.textContent = 'üü¢ Online Now';
      }
      
      filterStudents();
    }
    
    function filterStudents() {
      const search = document.getElementById('studentSearch').value.toLowerCase();
      const selectedGroup = document.getElementById('groupFilterSelect')?.value || '';
      const rows = document.querySelectorAll('#studentsTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const rowGroup = row.getAttribute('data-group') || '';
        const matchesSearch = text.includes(search);
        const matchesGroup = !selectedGroup || rowGroup === selectedGroup;
        
        // Check if student is online (has .online class on status button)
        const statusBtn = row.querySelector('.action-btn.info');
        const isOnline = statusBtn && statusBtn.classList.contains('online');
        
        // Show row if it matches search AND group AND (showOnlineOnly is false OR student is online)
        const shouldShow = matchesSearch && matchesGroup && (!showOnlineOnly || isOnline);
        row.style.display = shouldShow ? '' : 'none';
      });
    }
    
    function filterNotes() {
      const search = document.getElementById('notesSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#notesTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      });
    }
    
    function filterPayments() {
      const search = document.getElementById('paymentsSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#paymentsTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      });
    }
    
    function filterForum() {
      const search = document.getElementById('forumSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#forumTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      });
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ DOMContentLoaded fired!');
      console.log('üîß Supabase client:', supabase);
      
      try {
        // Get current admin email with timeout
        console.log('üîç Getting session...');
        
        const sessionPromise = supabase.auth.getSession();
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Session timeout after 5s')), 5000)
        );
        
        const { data: { session } } = await Promise.race([sessionPromise, timeoutPromise]);
        console.log('üìß Session:', session);
        
        if (session && session.user) {
          currentEmail = session.user.email;
          console.log('‚úÖ Admin email:', currentEmail);
        } else {
          console.log('‚ö†Ô∏è No session found');
        }
        
        console.log('üìä Loading stats...');
        loadStats();
        
        console.log('üë• Loading students...');
        loadStudents();
      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        console.log('üîÑ Attempting to load without session...');
        loadStats();
        loadStudents();
      }

      // Close modal when clicking outside
      const statusModal = document.getElementById('statusModal');
      statusModal.addEventListener('click', (e) => {
        if (e.target === statusModal) {
          closeStatusModal();
        }
      });
    });
  </script>

  <!-- Status Modal -->
  <div id="statusModal" class="status-modal">
    <div id="statusModalContent" class="status-modal-content"></div>
  </div>

  <!-- Note Modal -->
  <div id="noteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="noteModalTitle">Add Note</h2>
        <button class="close-btn" onclick="closeNoteModal()">√ó</button>
      </div>
      <form id="noteForm" onsubmit="saveNote(event)">
        <input type="hidden" id="noteFolderId">
        <input type="hidden" id="noteTemplateId">
        <input type="hidden" id="noteAssignmentId">
        
        <div class="form-group">
          <label class="form-label">Note Title</label>
          <input type="text" id="noteTitle" required class="form-input" placeholder="e.g., Heart Failure Pathophysiology">
        </div>
        <div class="form-group">
          <label class="form-label">Note Content (Optional)</label>
          <textarea id="noteContent" class="form-input" rows="6" placeholder="Enter note content or attach a PDF below..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Class Date</label>
          <input type="date" id="noteClassDate" required class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Attach PDF (Optional)</label>
          <input type="file" id="noteFile" accept=".pdf" class="form-input">
          <small style="color: rgba(255,255,255,0.6)">Students can access this note if they paid for the class date</small>
        </div>
        <button type="submit" class="submit-btn">Save Note</button>
      </form>
    </div>
  </div>

  <!-- Full-Screen Modal for Notes Manager -->
  <div id="notesManagerModal" class="modal-overlay">
    <div class="modal-content-fullscreen">
      <div class="modal-header-bar">
        <h2>üìö Notes Manager</h2>
        <button class="modal-close-btn" onclick="closeNotesManager()">√ó</button>
      </div>
      <div class="modal-iframe-container">
        <iframe id="notesManagerIframe" src="" title="Notes Manager"></iframe>
      </div>
    </div>
  </div>

  <script>
    // ===== MODAL FUNCTIONS =====
    function openNotesManager() {
      const modal = document.getElementById('notesManagerModal');
      const iframe = document.getElementById('notesManagerIframe');
      
      // Set iframe source
      iframe.src = 'Notes-Manager-NEW.html';
      
      // Show modal
      modal.classList.add('active');
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    function closeNotesManager() {
      const modal = document.getElementById('notesManagerModal');
      const iframe = document.getElementById('notesManagerIframe');
      
      // Hide modal with fade out
      modal.classList.remove('active');
      
      // Clear iframe source to stop any processes
      setTimeout(() => {
        iframe.src = '';
      }, 300);
      
      // Restore body scroll
      document.body.style.overflow = '';
      
      // Reload notes in case they were updated
      if (typeof loadNotes === 'function') {
        loadNotes();
      }
    }

    // Close modal on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('notesManagerModal');
        if (modal.classList.contains('active')) {
          closeNotesManager();
        }
      }
    });

    // Close modal on background click
    document.getElementById('notesManagerModal').addEventListener('click', (e) => {
      if (e.target.id === 'notesManagerModal') {
        closeNotesManager();
      }
    });

    // Listen for messages from embedded iframes (e.g., Group Notes Manager, Impersonation)
    window.addEventListener('message', (event) => {
      if (event.data && event.data.action === 'openNotesManager') {
        openNotesManager();
      }
      
      // Handle impersonation iframe messages
      if (event.data && event.data.action === 'closeImpersonation') {
        console.log('üì® Received close impersonation message:', event.data.reason);
        closeImpersonation();
        
        // Show error message based on reason
        if (event.data.reason === 'not_found') {
          alert('Student not found in database. Please refresh the page and try again.');
        } else if (event.data.reason === 'expired') {
          alert('Impersonation session expired.');
        } else if (event.data.reason === 'no_token') {
          alert('Impersonation token not found. Please try again.');
        }
      }
    });
  </script>

  <!-- Fullscreen Impersonation Modal -->
  <div id="impersonationModal" class="impersonation-modal">
    <div class="impersonation-header">
      <div class="impersonation-title">
        <span class="emoji">üëÅÔ∏è</span>
        <span id="impersonationStudentName">Viewing as Student</span>
      </div>
      <button class="impersonation-close" onclick="closeImpersonation()">√ó</button>
    </div>
    <iframe id="impersonationIframe" class="impersonation-iframe" title="Student Portal View"></iframe>
  </div>

</body>
</html>
