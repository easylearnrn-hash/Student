<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Portal Admin - ARNOMA</title>
  <link rel="icon" type="image/png" href="/richyfesta-logo.png">
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="shared-auth.js"></script>
  <script src="shared-dialogs.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      /* PERFORMANCE: Reduced opacity to lighten GPU load */
      background: radial-gradient(circle at 20% 50%, rgba(102,126,234,0.05) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(118,75,162,0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }
    
    .header {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 32px 40px;
      border-radius: 24px;
      box-shadow: 0 25px 60px rgba(13, 16, 35, 0.7), 
                  inset 0 1px 0 rgba(255,255,255,0.05);
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .header-title h1 {
      font-size: 36px;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
      text-shadow: 0 2px 20px rgba(0,0,0,0.2);
    }
    
    .back-btn {
      padding: 12px 24px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
    }
    
    /* Chat notification badge */
    .chat-notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 700;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
      animation: badgePulse 2s ease-in-out infinite;
    }
    
    @keyframes badgePulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6);
      }
    }
    
    .tabs {
      display: flex;
      gap: 16px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 14px 28px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.7);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .tab:hover {
      background: rgba(255,255,255,0.12);
      color: white;
    }
    
    .tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-color: rgba(102,126,234,0.3);
      color: white;
      box-shadow: 0 4px 20px rgba(102,126,234,0.3);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 25px 60px rgba(13, 16, 35, 0.7), inset 0 1px 0 rgba(255,255,255,0.05);
      margin-bottom: 24px;
    }
    
    .card-title {
      font-size: 22px;
      color: #ffffff;
      font-weight: 700;
      margin: 0 0 24px 0;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15));
      border: 1px solid rgba(255,255,255,0.12);
      padding: 24px;
      border-radius: 16px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.7), rgba(30, 41, 80, 0.6));
    }
    
    thead {
      background: rgba(102,126,234,0.15);
    }
    
    th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      color: #ffffff;
      font-size: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
    }
    
    td {
      padding: 14px 16px;
      color: rgba(255,255,255,0.9);
      font-size: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    /* Prevent action buttons from wrapping */
    td:last-child {
      white-space: nowrap;
    }
    
    tr:hover {
      background: rgba(102,126,234,0.08);
    }
    
    /* Red strip for students with unpaid balance */
    tr.has-unpaid {
      border-left: 4px solid #ef4444;
      background: rgba(239, 68, 68, 0.05);
    }
    
    tr.has-unpaid:hover {
      background: rgba(239, 68, 68, 0.08);
    }
    
    .action-btn {
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .action-btn.view {
      background: rgba(59,130,246,0.15);
      color: #3b82f6;
      border-color: rgba(59,130,246,0.3);
    }
    
    .action-btn.edit {
      background: rgba(251,188,4,0.15);
      color: #fbbc04;
      border-color: rgba(251,188,4,0.3);
    }
    
    .action-btn.delete {
      background: rgba(239,68,68,0.15);
      color: #ef4444;
      border-color: rgba(239,68,68,0.3);
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.2);
    }
    
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .search-input {
      flex: 1;
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      color: white;
      font-size: 14px;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
    }
    
    .add-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102,126,234,0.4);
    }
    
    .btn-filter {
      padding: 12px 20px;
      background: rgba(34,197,94,0.15);
      color: #22c55e;
      border: 2px solid rgba(34,197,94,0.3);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      margin-right: 8px;
    }
    
    .btn-filter.btn-icon {
      padding: 10px;
      width: 42px;
      height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .btn-filter:hover {
      background: rgba(34,197,94,0.25);
      border-color: rgba(34,197,94,0.5);
      transform: translateY(-2px);
    }
    
    .btn-filter.active {
      background: #22c55e;
      color: white;
      box-shadow: 0 4px 12px rgba(34,197,94,0.4);
    }
    
    .group-filter {
      padding: 12px 16px;
      background: rgba(255,255,255,0.08);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      margin-right: 8px;
      min-width: 150px;
    }
    
    .group-filter:hover {
      background: rgba(255,255,255,0.12);
      border-color: rgba(102,126,234,0.5);
    }
    
    .group-filter:focus {
      outline: none;
      border-color: rgba(102,126,234,0.6);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
    }
    
    .group-filter option {
      background: #1e293b;
      color: white;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .badge.active {
      background: rgba(34,197,94,0.15);
      color: #22c55e;
    }
    
    .badge.inactive {
      background: rgba(148,163,184,0.15);
      color: #94a3b8;
    }
    
    .badge.locked {
      background: rgba(239,68,68,0.15);
      color: #ef4444;
    }
    
    .badge.free {
      background: rgba(52,168,83,0.15);
      color: #34a853;
    }
    
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 24px;
      padding: 32px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
    }
    
    .close-modal {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .close-modal:hover {
      background: rgba(239,68,68,0.25);
      transform: rotate(90deg);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      color: rgba(255,255,255,0.9);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      color: white;
      font-size: 14px;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }
    
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
      background: rgba(148,163,184,0.3);
      border-radius: 15px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .toggle-switch.on {
      background: #22c55e;
    }
    
    .toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    
    .toggle-switch.on .toggle-slider {
      transform: translateX(30px);
    }
    
    .submit-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102,126,234,0.4);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,0.5);
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.7);
    }

    /* Status Modal Styles */
    .status-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    .status-modal-content {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 0;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .status-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 32px;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-modal-header h3 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .close-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 24px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .status-modal-body {
      padding: 32px;
      overflow-y: auto;
      max-height: calc(80vh - 100px);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      margin-bottom: 24px;
    }

    .user-status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-indicator.online .user-status-dot {
      background: #10b981;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }

    .status-indicator.offline .user-status-dot {
      background: #ef4444;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      font-size: 20px;
      font-weight: 600;
      color: white;
    }

    .status-details {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 32px;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
    }

    .status-label {
      color: rgba(255, 255, 255, 0.6);
      font-weight: 500;
    }

    .status-value {
      color: white;
      font-weight: 600;
    }
    
    .stats-section {
      margin: 32px 0;
      padding: 24px;
      background: linear-gradient(145deg, rgba(102,126,234,0.1), rgba(118,75,162,0.08));
      border-radius: 16px;
      border: 1px solid rgba(102,126,234,0.2);
    }
    
    .stats-section h4 {
      margin: 0 0 20px 0;
      font-size: 18px;
      color: white;
      font-weight: 700;
    }
    
    /* Removed duplicate .stats-grid - already defined at line 189 */
    /* Removed duplicate .stat-value - already defined at line 204 */
    /* Removed duplicate .stat-label - already defined at line 211 */
    
    .stat-item {
      text-align: center;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .status-history h4 {
      margin: 0 0 16px 0;
      font-size: 18px;
      color: rgba(255, 255, 255, 0.8);
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      font-size: 14px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    
    .history-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-date {
      color: white;
      font-weight: 600;
      flex: 1;
    }

    .history-duration {
      color: #667eea;
      font-weight: 700;
      margin: 0 12px;
    }
    
    .history-details {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    
    .history-details span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .history-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .history-status.active {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .history-status.ended {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.6);
    }

    .action-btn.info {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      padding: 8px 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .action-btn.info.online {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
      animation: pulseGreen 2s infinite;
    }

    .action-btn.info.was-online {
      background: linear-gradient(135deg, #065f46, #047857);
      box-shadow: 0 0 10px rgba(6, 95, 70, 0.3);
    }

    @keyframes pulseGreen {
      0%, 100% {
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
      }
      50% {
        box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
      }
    }

    .action-btn.info svg {
      display: block;
    }

    .action-btn.info:hover {
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }

    .action-btn.info.online:hover {
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.6);
    }

    .action-btn.info.was-online:hover {
      box-shadow: 0 4px 15px rgba(6, 95, 70, 0.5);
    }

    /* Folder Accordion Styles */
    .folder-section {
      margin-bottom: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .folder-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      cursor: pointer;
      background: rgba(255,255,255,0.03);
      transition: all 0.3s ease;
      user-select: none;
    }

    .folder-header:hover {
      background: rgba(255,255,255,0.08);
    }

    .folder-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .folder-icon {
      font-size: 24px;
      transition: transform 0.3s ease;
    }

    .folder-section.expanded .folder-icon {
      transform: rotate(90deg);
    }

    .folder-name {
      font-size: 18px;
      font-weight: 600;
      color: white;
    }

    .folder-count {
      font-size: 14px;
      color: rgba(255,255,255,0.5);
      margin-left: 8px;
    }

    .folder-actions {
      display: flex;
      gap: 8px;
    }

    .folder-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    .folder-section.expanded .folder-content {
      max-height: 2000px;
    }

    .template-list {
      padding: 12px;
    }

    .template-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }

    .template-item:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(102,126,234,0.3);
    }

    .template-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .template-title {
      font-size: 16px;
      font-weight: 600;
      color: white;
      margin-bottom: 4px;
    }

    .template-meta {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
    }

    .template-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .template-content {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .template-footer {
      display: flex;
      gap: 12px;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .template-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .note-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .note-status-dot.open {
      background: #10b981;
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
    }

    .note-status-dot.closed {
      background: #ef4444;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
    }

    .mini-btn {
      padding: 6px 12px;
      font-size: 13px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mini-btn:hover {
      background: rgba(255,255,255,0.15);
    }

    .mini-btn.primary {
      background: rgba(102,126,234,0.2);
      border-color: rgba(102,126,234,0.4);
    }

    .mini-btn.primary:hover {
      background: rgba(102,126,234,0.3);
    }

    .mini-btn.danger {
      background: rgba(239,68,68,0.2);
      border-color: rgba(239,68,68,0.4);
    }

    .mini-btn.danger:hover {
      background: rgba(239,68,68,0.3);
    }

    .empty-folder {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255,255,255,0.5);
    }

    .empty-folder-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    /* Search and Controls */
    .notes-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      align-items: center;
    }

    .search-notes {
      flex: 1;
      padding: 12px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }

    .search-notes::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .folder-search {
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      color: white;
      font-size: 13px;
      margin: 12px;
      width: calc(100% - 24px);
    }

    .folder-search::placeholder {
      color: rgba(255,255,255,0.4);
    }

    /* Drag and Drop */
    .drag-handle {
      cursor: grab;
      padding: 4px 8px;
      color: rgba(255,255,255,0.4);
      font-size: 18px;
      user-select: none;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    .dragging {
      opacity: 0.5;
    }

    .drag-over {
      border-top: 2px solid #667eea;
    }

    .reorder-mode .folder-header,
    .reorder-mode .template-item {
      cursor: move;
    }

    .toggle-reorder-btn {
      padding: 8px 16px;
      background: rgba(102,126,234,0.2);
      border: 1px solid rgba(102,126,234,0.4);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .toggle-reorder-btn:hover {
      background: rgba(102,126,234,0.3);
    }

    .toggle-reorder-btn.active {
      background: rgba(102,126,234,0.4);
      border-color: rgba(102,126,234,0.6);
    }

    /* Full-Screen Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 9999;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content-fullscreen {
      position: relative;
      width: 95vw;
      height: 95vh;
      background: #0b1220;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
      animation: slideUp 0.4s ease;
    }

    .modal-header-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 10;
    }

    .modal-header-bar h2 {
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
    }

    .modal-close-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      font-size: 24px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
      transform: scale(1.05);
    }

    .modal-iframe-container {
      position: absolute;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .modal-iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Fullscreen Impersonation Modal */
    .impersonation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: none;
      flex-direction: column;
    }

    .impersonation-modal.active {
      display: flex;
    }

    .impersonation-header {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .impersonation-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .impersonation-title .emoji {
      font-size: 24px;
    }

    .impersonation-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .impersonation-alert-btn {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: white;
      padding: 10px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .impersonation-alert-btn:hover {
      background: linear-gradient(135deg, #d97706, #b45309);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }

    .impersonation-close {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-weight: 300;
    }

    .impersonation-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .impersonation-iframe {
      flex: 1;
      width: 100%;
      border: none;
      background: white;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Alert Modal Styles */
    .alert-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      padding: 20px;
    }

    .alert-modal.active {
      display: flex;
    }

    .alert-modal-content {
      background: linear-gradient(145deg, 
        rgba(15, 23, 42, 0.95), 
        rgba(30, 41, 59, 0.92));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 32px;
      max-width: 700px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease-out;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4),
                  inset 0 1px 0 rgba(255,255,255,0.1);
    }

    .alert-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .alert-modal-title {
      font-size: 22px;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      gap: 12px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .student-selector {
      margin-bottom: 24px;
    }

    .student-selector-label {
      display: block;
      color: rgba(255,255,255,0.95);
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .student-checkbox-group {
      max-height: 220px;
      overflow-y: auto;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px;
    }

    .student-checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      transition: all 0.2s;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .student-checkbox-item:hover {
      background: rgba(102,126,234,0.12);
      border-color: rgba(102,126,234,0.3);
    }

    .student-checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .student-checkbox-item label {
      color: rgba(255,255,255,0.92);
      font-size: 14px;
      cursor: pointer;
      flex: 1;
      font-weight: 500;
    }

    .select-all-btn {
      padding: 10px 18px;
      background: linear-gradient(135deg, rgba(102,126,234,0.25), rgba(147,51,234,0.2));
      color: #a5b4fc;
      border: 1px solid rgba(102,126,234,0.4);
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      transition: all 0.2s;
      width: 100%;
    }

    .select-all-btn:hover {
      background: linear-gradient(135deg, rgba(102,126,234,0.35), rgba(147,51,234,0.3));
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.25);
    }
    
    .group-select-btn:hover {
      background: rgba(147,51,234,0.4) !important;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(147,51,234,0.35);
    }
    
    .group-select-btn:active {
      transform: translateY(0);
    }
    
    .group-select-btn.active {
      background: rgba(102,126,234,0.5) !important;
      border-color: rgba(102,126,234,0.8) !important;
      box-shadow: 0 0 12px rgba(102,126,234,0.4) !important;
    }
    
    /* Alert Modal Form Inputs */
    .alert-modal input[type="text"],
    .alert-modal input[type="datetime-local"],
    .alert-modal textarea,
    .alert-modal select {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    
    .alert-modal input[type="text"]::placeholder,
    .alert-modal textarea::placeholder {
      color: rgba(255,255,255,0.4);
    }
    
    .alert-modal input[type="text"]:focus,
    .alert-modal input[type="datetime-local"]:focus,
    .alert-modal textarea:focus,
    .alert-modal select:focus {
      outline: none;
      border-color: rgba(102,126,234,0.6);
      background: rgba(255,255,255,0.12);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }
    
    .alert-modal textarea {
      min-height: 120px;
      resize: vertical;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-title">
        <h1>üéõÔ∏è Student Portal Admin</h1>
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="back-btn" onclick="window.location.href='Test-Manager.html'">
          üìù Test Manager
        </button>
        <button class="back-btn" onclick="openAdminChat()" style="position: relative;">
          üí¨ Student Chat
          <span id="chatBadge" class="chat-notification-badge" style="display: none;">0</span>
        </button>
        <button class="back-btn" onclick="openAlertModal()">
          üîî Create Alert
        </button>
        <button class="back-btn" onclick="window.location.href='Payment-Records.html'">
          ‚Üê Back to Payments
        </button>
      </div>
    </div>
    
    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalStudents">0</div>
        <div class="stat-label">Total Students</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalNotes">0</div>
        <div class="stat-label">PDF Notes</div>
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab(event, 'students')">
        <span>üë•</span> Students
      </div>
      <div class="tab" onclick="switchTab(event, 'notes')">
        <span>üìÑ</span> PDF Notes
      </div>
      <div class="tab" onclick="openGroupNotesModal()">
        <span>üìö</span> Group Notes
      </div>
      <div class="tab" onclick="switchTab(event, 'settings')">
        <span>‚öôÔ∏è</span> Settings
      </div>
    </div>
    
    <!-- Students Tab -->
    <div id="studentsTab" class="tab-content active">
      <div class="card">
        <div class="card-title">Manage Students</div>
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search students..." id="studentSearch" onkeyup="debouncedFilterStudents()">
          <select class="group-filter" id="groupFilterSelect" onchange="filterStudents()" title="Filter by group">
            <option value="">All Groups</option>
          </select>
          <button class="btn-filter btn-icon active" id="activeFilterBtn" onclick="toggleActiveFilter()" title="Active students only">
            ‚úì
          </button>
          <button class="btn-filter btn-icon" id="onlineFilterBtn" onclick="toggleOnlineFilter()" title="Online students only">
            üü¢
          </button>
          <button class="add-btn" onclick="openStudentModal()">+ Add Student</button>
        </div>
        <div class="table-container">
          <table id="studentsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Group</th>
                <th>Schedule</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="studentsTableBody">
              <tr>
                <td colspan="6" class="loading">Loading students...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Notes Tab -->
    <div id="notesTab" class="tab-content">
      <div class="card">
        <div class="card-title">Manage PDF Notes (Legacy)</div>
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search notes..." id="notesSearch" onkeyup="debouncedFilterNotes()">
          <button class="add-btn" onclick="window.open('Notes-Manager.html', '_blank')">+ Upload New Note</button>
          <button class="add-btn" onclick="window.open('PDF-Media-Manager.html', '_blank')" style="background: linear-gradient(135deg, #c084fc, #f9a8d4); margin-left: 8px;">üì∏ Manage Media</button>
          <button class="add-btn" onclick="window.open('Group-Notes.html', '_blank')" style="background: linear-gradient(135deg, #22c55e, #16a34a); margin-left: 8px;">FREE Access</button>
        </div>
        <div class="table-container">
          <table id="notesTable">
            <thead>
              <tr>
                <th>Title</th>
                <th>System</th>
                <th>Group</th>
                <th>Date</th>
                <th>Access</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="notesTableBody">
              <tr>
                <td colspan="6" class="loading">Loading notes...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Group Notes Modal -->
    <div id="groupNotesModal" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      backdrop-filter: blur(8px);
    ">
      <div style="
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      ">
        <!-- Close Button -->
        <button 
          onclick="closeGroupNotesModal()"
          style="
            position: absolute;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.6);
            border-radius: 50%;
            color: #ef4444;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
          "
          onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'; this.style.transform='scale(1.1)'"
          onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'; this.style.transform='scale(1)'"
        >
          ‚úï
        </button>
        
        <!-- Iframe Container -->
        <div style="
          width: 100%;
          height: 100%;
          max-width: 1800px;
          background: #0b1220;
          border-radius: 16px;
          overflow: hidden;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        ">
          <iframe 
            id="groupNotesIframe"
            src=""
            title="Group Notes Manager"
            style="width: 100%; height: 100%; border: none;"
          >
          </iframe>
        </div>
      </div>
    </div>
    
    <!-- Settings Tab -->
    <div id="settingsTab" class="tab-content">
      <div class="card">
        <div class="card-title">üéÑ Portal Theme Settings</div>
        <p style="color: rgba(255,255,255,0.7); margin-bottom: 24px;">
          Control the Christmas theme for the Student Portal
        </p>
        
        <div style="display: flex; align-items: center; gap: 16px; padding: 24px; background: rgba(255,255,255,0.05); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
          <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1;">
            <input 
              type="checkbox" 
              id="christmasThemeToggle" 
              onchange="toggleChristmasTheme()"
              style="width: 24px; height: 24px; cursor: pointer; accent-color: #10b981;"
            >
            <div>
              <div style="font-size: 18px; font-weight: 600; color: white; margin-bottom: 4px;">
                Enable Christmas Theme
              </div>
              <div style="font-size: 14px; color: rgba(255,255,255,0.6);">
                Adds snow effect, Christmas tree, and festive fonts to Student Portal
              </div>
            </div>
          </label>
          <div style="font-size: 48px;">‚ùÑÔ∏è</div>
        </div>
        
        <div id="themeStatus" style="margin-top: 16px; padding: 16px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; color: #10b981; display: none;">
          <strong>‚úì Christmas Theme Enabled</strong><br>
          <span style="font-size: 13px; opacity: 0.9;">Students will see festive decorations when they visit the portal</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Student Modal -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="studentModalTitle">Add Student</h2>
        <button class="close-modal" onclick="closeStudentModal()">√ó</button>
      </div>
      <form id="studentForm" onsubmit="saveStudent(event)">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-input" id="studentName" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="studentEmail" required>
        </div>
        <div class="form-group">
          <label class="form-label">Group</label>
          <select class="form-select" id="studentGroup" required>
            <option value="">Select Group</option>
            <option value="A">Group A</option>
            <option value="B">Group B</option>
            <option value="C">Group C</option>
            <option value="D">Group D</option>
            <option value="E">Group E</option>
            <option value="F">Group F</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Schedule</label>
          <select class="form-select" id="studentSchedule" required>
            <option value="">Select Schedule</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Price Per Class ($)</label>
          <input type="number" class="form-input" id="studentPrice" value="50">
        </div>
        <button type="submit" class="submit-btn">Save Student</button>
      </form>
    </div>
  </div>
  
  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
    
    // Create Supabase client without shadowing global window.supabase
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    if (window.ArnomaAuth?.attachAuthListener) {
      window.ArnomaAuth.attachAuthListener(supabaseClient);
    }

    let adminSessionPromise = null;
    async function ensureAdminSession() {
      if (!adminSessionPromise) {
        adminSessionPromise = (async () => {
          try {
            const session = window.ArnomaAuth
              ? await window.ArnomaAuth.ensureSession(supabaseClient, { redirectToLogin: true })
              : (await supabaseClient.auth.getSession()).data.session;

            if (!session?.user?.email) {
              throw new Error('Admin session missing email');
            }

            currentEmail = session.user.email;
            return session;
          } catch (error) {
            console.error('Admin authentication failed:', error);
            window.location.href = 'index.html';
            throw error;
          }
        })();
      }

      return adminSessionPromise;
    }

    function canonicalizeGroupCode(value) {
      if (!value) return '';
      const raw = value.toString().trim();
      if (!raw) return '';
      let normalized = raw.replace(/^group\s+/i, '');
      normalized = normalized.replace(/[^a-z0-9]/gi, '');
      return normalized.toUpperCase();
    }

    function formatGroupLabel(code) {
      return code ? code.toUpperCase() : '-';
    }
    
    let currentStudentId = null;
    let currentEmail = null; // Track admin email for audit logging
    
    // ===== PERFORMANCE: DATA CACHE =====
    const DATA_CACHE = {
      students: { data: null, timestamp: 0, ttl: 5 * 60 * 1000 }, // 5 min
      notes: { data: null, timestamp: 0, ttl: 5 * 60 * 1000 },
      stats: { data: null, timestamp: 0, ttl: 2 * 60 * 1000 } // 2 min
    };

    function getCachedData(key) {
      const cache = DATA_CACHE[key];
      if (!cache) return null;
      const now = Date.now();
      if (cache.data && (now - cache.timestamp) < cache.ttl) {
        return cache.data;
      }
      return null;
    }

    function setCachedData(key, data) {
      if (DATA_CACHE[key]) {
        DATA_CACHE[key].data = data;
        DATA_CACHE[key].timestamp = Date.now();
      }
    }

    function clearCache(key) {
      if (key) {
        if (DATA_CACHE[key]) {
          DATA_CACHE[key].data = null;
          DATA_CACHE[key].timestamp = 0;
        }
      } else {
        // Clear all caches
        Object.keys(DATA_CACHE).forEach(k => {
          DATA_CACHE[k].data = null;
          DATA_CACHE[k].timestamp = 0;
        });
      }
    }

    // ===== PERFORMANCE: DEBOUNCE HELPER =====
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Tab Switching
    function switchTab(e, tab) {
      // Update tabs
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      e.currentTarget.classList.add('active');
      
      // Update content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tab + 'Tab').classList.add('active');
      
      // Load data for tab (with caching)
      if (tab === 'students') loadStudents();
      if (tab === 'notes') loadNotes();
      if (tab === 'settings') loadSettings();
    }
    
    // Load Settings Tab
    async function loadSettings() {
      const checkbox = document.getElementById('christmasThemeToggle');
      const status = document.getElementById('themeStatus');
      
      try {
        // Fetch current setting from Supabase
  const { data, error } = await supabaseClient
          .from('portal_settings')
          .select('setting_value')
          .eq('setting_key', 'christmas_theme')
          .single();
        
        if (error) {
          console.error('Error loading Christmas theme setting:', error);
          return;
        }
        
        const isEnabled = data?.setting_value?.enabled === true;
        
        if (checkbox) {
          checkbox.checked = isEnabled;
        }
        if (status) {
          status.style.display = isEnabled ? 'block' : 'none';
        }
      } catch (err) {
        console.error('Failed to load settings:', err);
      }
    }
    
    // Toggle Christmas Theme
    async function toggleChristmasTheme() {
      const checkbox = document.getElementById('christmasThemeToggle');
      const status = document.getElementById('themeStatus');
      const isEnabled = checkbox.checked;
      
      try {
        // Update setting in Supabase
  const { error } = await supabaseClient
          .from('portal_settings')
          .update({ 
            setting_value: { enabled: isEnabled },
            updated_at: new Date().toISOString()
          })
          .eq('setting_key', 'christmas_theme');
        
        if (error) {
          console.error('Error saving Christmas theme setting:', error);
          alert('‚ùå Failed to save setting. Please try again.');
          checkbox.checked = !isEnabled; // Revert checkbox
          return;
        }
        
        if (status) {
          status.style.display = isEnabled ? 'block' : 'none';
        }
        
        // Alert user
        if (isEnabled) {
          alert('‚úÖ Christmas Theme Enabled!\n\nAll students will now see:\n‚Ä¢ Snowflakes ‚ùÑÔ∏è\n‚Ä¢ Christmas tree üéÑ\n‚Ä¢ Falling snow\n‚Ä¢ Festive font ‚úçÔ∏è\n\nChanges take effect immediately when they reload the portal.');
        } else {
          alert('‚ùå Christmas Theme Disabled\n\nAll Christmas decorations will be hidden when students reload the portal.');
        }
      } catch (err) {
        console.error('Failed to save setting:', err);
        alert('‚ùå Failed to save setting. Please try again.');
        checkbox.checked = !isEnabled; // Revert checkbox
      }
    }
    
    // Group Notes Modal Functions
    function openGroupNotesModal() {
      const modal = document.getElementById('groupNotesModal');
      const iframe = document.getElementById('groupNotesIframe');
      
      // CRITICAL FIX: Check if iframe contains Group-Notes.html, not just if src is empty
      // Empty src="" defaults to parent URL, which breaks first-click behavior
      const currentSrc = iframe.src || '';
      const hasGroupNotes = currentSrc.includes('Group-Notes.html');
      
      // Load the iframe src when opening (lazy load)
      if (!hasGroupNotes) {
        iframe.src = 'Group-Notes.html?v=' + Date.now();
      }
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    function closeGroupNotesModal() {
      const modal = document.getElementById('groupNotesModal');
      modal.style.display = 'none';
      document.body.style.overflow = ''; // Restore scrolling
    }
    
    // Initialize Group Notes modal event listeners after DOM loads
    document.addEventListener('DOMContentLoaded', function() {
      // Close modal on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const modal = document.getElementById('groupNotesModal');
          if (modal && modal.style.display === 'flex') {
            closeGroupNotesModal();
          }
        }
      });
      
      // Close modal when clicking backdrop
      document.addEventListener('click', function(e) {
        const modal = document.getElementById('groupNotesModal');
        if (e.target === modal) {
          closeGroupNotesModal();
        }
      });
    });
    
    // Load Stats
    async function loadStats() {
      try {
        // PERFORMANCE FIX: Disabled caching - always fetch fresh data for real-time updates
        await ensureAdminSession();
        
        // Total Students
  const { count: studentCount, error: studentError } = await supabaseClient
          .from('students')
          .select('*', { count: 'exact', head: true });
        
        // Total Notes - ONLY count non-deleted notes
        let notesCount = 0;
        try {
          const { count, error: notesError } = await supabaseClient
            .from('student_notes')
            .select('*', { count: 'exact', head: true })
            .eq('deleted', false);
          notesCount = count || 0;
        } catch (err) {
          console.warn('‚ùå [loadStats] Could not load notes count (RLS?):', err);
          notesCount = '-';
        }
        
        const stats = {
          students: studentCount || 0,
          notes: notesCount
        };
        
        updateStatsUI(stats);
        
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }
    
    function updateStatsUI(stats) {
      document.getElementById('totalStudents').textContent = stats.students;
      document.getElementById('totalNotes').textContent = stats.notes;
    }
    
    // Helper to parse and format schedule for display
    function parseScheduleString(scheduleStr) {
      if (!scheduleStr) return [];

      // If already an array, handle each item
      if (Array.isArray(scheduleStr)) {
        const allSessions = [];
        scheduleStr.forEach(item => {
          allSessions.push(...parseScheduleString(item));
        });
        return allSessions;
      }

      // Try to parse as JSON first
      if (typeof scheduleStr === 'string') {
        try {
          const parsed = JSON.parse(scheduleStr);
          if (Array.isArray(parsed)) {
            return parseScheduleString(parsed);
          }
        } catch {
          // Not JSON, continue with string parsing
        }
      }

      const sessions = [];
      const parts = scheduleStr.toString().split(',').map(s => s.trim());

      parts.forEach(part => {
        // Handle "Tuesday/Friday 3:00 PM" format (slash-separated days)
        const slashMatch = part.match(/^([A-Za-z/]+)\s+(.+)$/);
        if (slashMatch) {
          const daysStr = slashMatch[1];
          const time = slashMatch[2];
          const days = daysStr.split('/').map(d => d.trim());

          days.forEach(day => {
            const normalized = normalizeDay(day);
            if (normalized) {
              sessions.push({ day: normalized, time: time });
            }
          });
        } else {
          // Handle "Tuesday 3:00 PM" format (single day)
          const spaceMatch = part.match(/^([A-Za-z]+)\s+(.+)$/);
          if (spaceMatch) {
            const day = normalizeDay(spaceMatch[1]);
            const time = spaceMatch[2];
            if (day) {
              sessions.push({ day: day, time: time });
            }
          }
        }
      });

      return sessions;

      function normalizeDay(day) {
        if (!day || typeof day !== 'string') return '';
        const map = {
          'sun': 'Sunday', 'sunday': 'Sunday',
          'mon': 'Monday', 'monday': 'Monday',
          'tue': 'Tuesday', 'tues': 'Tuesday', 'tuesday': 'Tuesday',
          'wed': 'Wednesday', 'weds': 'Wednesday', 'wednesday': 'Wednesday',
          'thu': 'Thursday', 'thur': 'Thursday', 'thurs': 'Thursday', 'thursday': 'Thursday',
          'fri': 'Friday', 'friday': 'Friday',
          'sat': 'Saturday', 'saturday': 'Saturday'
        };
        return map[day.toLowerCase()] || day;
      }
    }

    function formatScheduleDisplay(scheduleStr) {
      const sessions = parseScheduleString(scheduleStr);
      if (sessions.length === 0) return '-';
      
      return sessions.map(s => {
        // Abbreviate day name (Monday -> Mon, Tuesday -> Tue, etc.)
        const dayAbbr = s.day.substring(0, 3);
        
        // Simplify time format (remove minutes if :00, simplify AM/PM)
        let simpleTime = s.time
          .replace(':00', '') // Remove :00 minutes
          .replace(' AM', ' AM')
          .replace(' PM', ' PM')
          .replace(/(\d+) (AM|PM)/, '$1 $2'); // Ensure space between number and AM/PM
        
        return `${dayAbbr} ${simpleTime}`;
      }).join(', ');
    }
    
    // Load Students
    async function loadStudents() {
      try {
        // PERFORMANCE FIX: Disabled caching - always fetch fresh data for real-time updates
        
        await ensureAdminSession();
        
        // Fetch students and groups (limit to prevent overload)
        const [studentsResult, groupsResult] = await Promise.all([
          supabaseClient.from('students').select('*').order('name').limit(500),
          supabaseClient.from('groups').select('*')
        ]);
        
        if (studentsResult.error) {
          console.error('‚ùå Students query error:', studentsResult.error);
          throw studentsResult.error;
        }
        
        const students = studentsResult.data || [];
        const groups = groupsResult.data || [];
        
        // Try to fetch active sessions (may fail if table doesn't exist yet)
        let activeSessions = [];
        let allSessionsMap = {};
        try {
          // FIX: Query student_sessions table (not session_logs)
          // PERFORMANCE: Only fetch sessions updated in last hour to reduce data transfer
          const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();
          const sessionsResult = await supabaseClient
            .from('student_sessions')
            .select('student_id, is_active, last_activity')
            .eq('is_active', true)
            .gte('last_activity', oneHourAgo)
            .limit(200);
          
          if (!sessionsResult.error) {
            const allSessions = sessionsResult.data || [];
            
            // CRITICAL FIX: Only consider sessions with activity in last 10 minutes as "online"
            // This prevents stale sessions from showing students as online when they're not
            const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000).toISOString();
            activeSessions = allSessions.filter(session => {
              return session.last_activity && session.last_activity > tenMinutesAgo;
            });
          }
          
          // Also get all students who have ever logged in (with limit)
          const allSessionsResult = await supabaseClient
            .from('student_sessions')
            .select('student_id')
            .limit(500);
          
          if (!allSessionsResult.error) {
            const allSessions = allSessionsResult.data || [];
            allSessions.forEach(s => {
              allSessionsMap[s.student_id] = true;
            });
          }
        } catch (sessionError) {
          // Student sessions table not available yet
        }
        
        // Create online status map
        const onlineMap = {};
        activeSessions.forEach(session => {
          onlineMap[session.student_id] = true;
        });
        
        // Create group lookup map
        const groupMap = {};
        const uniqueGroups = new Set();
        groups.forEach(g => {
          const code = canonicalizeGroupCode(g.group_name || g.name || '');
          if (code) {
            groupMap[code] = g;
            uniqueGroups.add(code);
          }
        });
        
        const data = {
          students,
          groups,
          groupMap,
          uniqueGroups,
          onlineMap,
          allSessionsMap
        };
        
        renderStudentsTable(data);
        
      } catch (error) {
        console.error('Error loading students:', error);
        document.getElementById('studentsTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center; color: #ef4444;">Error loading students</td></tr>';
      }
    }
    
    function renderStudentsTable(data) {
      const { students, groupMap, uniqueGroups, onlineMap, allSessionsMap } = data;
      
      // PERFORMANCE: Immediate UI update for group filter
      const groupFilter = document.getElementById('groupFilterSelect');
      if (groupFilter) {
        const currentSelection = groupFilter.value;
        const options = ['<option value="">All Groups</option>'];
        Array.from(uniqueGroups).sort().forEach(code => {
          options.push(`<option value="${code}">${formatGroupLabel(code)}</option>`);
        });
        groupFilter.innerHTML = options.join('');
        if (currentSelection && uniqueGroups.has(currentSelection)) {
          groupFilter.value = currentSelection;
        }
      }
      
      const tbody = document.getElementById('studentsTableBody');
      
      if (students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üë•</div><div>No students found</div></td></tr>';
        return;
      }
      
      // PERFORMANCE: Defer heavy DOM operations to next animation frame
      requestAnimationFrame(() => {
        // Build all rows in a single innerHTML assignment (faster than createElement loops)
        tbody.innerHTML = students.map(student => {
          const groupCode = canonicalizeGroupCode(student.group_name || student.group || '');
          const group = groupMap[groupCode];
          const schedule = group ? formatScheduleDisplay(group.schedule) : '-';
          const isOnline = onlineMap[student.id];
          const hasLoggedIn = allSessionsMap[student.id];
          
          // Check for unpaid balance (negative balance = owes money)
          const balance = parseFloat(student.balance) || 0;
          const hasUnpaid = balance < 0;
          
          // Determine status class: online (bright green) | was-online (dark green) | default (blue)
          let statusClass = '';
          if (isOnline) {
            statusClass = 'online';
          } else if (hasLoggedIn) {
            statusClass = 'was-online';
          }
          
          return `
          <tr class="${hasUnpaid ? 'has-unpaid' : ''}" data-group="${groupCode}" data-student-name="${(student.name || '').toLowerCase()}" data-active="${student.show_in_grid ? 'true' : 'false'}">
            <td>${student.name || '-'}</td>
            <td>${student.email || '-'}</td>
            <td>${formatGroupLabel(groupCode)}</td>
            <td>${schedule}</td>
            <td><span class="badge ${student.show_in_grid ? 'active' : 'inactive'}">${student.show_in_grid ? 'Active' : 'Inactive'}</span></td>
            <td>
              <button class="action-btn info ${statusClass}" onclick="showStudentStatus(${student.id}, '${student.name?.replace(/'/g, "\\'") || 'Unknown'}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
              </button>
              <button class="action-btn view" onclick="impersonateStudent(${student.id}, '${student.name?.replace(/'/g, "\\'") || 'Unknown'}')">üëÅÔ∏è View as Student</button>
              <button class="action-btn edit" onclick="editStudent(${student.id})">Edit</button>
              <button class="action-btn delete" onclick="deleteStudent(${student.id})">Delete</button>
            </td>
          </tr>
        `;
        }).join('');
        
        // Apply active filter if it's enabled by default
        if (showActiveOnly) {
          filterStudents();
        }
      });
    }
    
    // Load Notes
    async function loadNotes() {
      try {
  await ensureAdminSession();
  const { data: notes, error } = await supabaseClient
          .from('student_notes')
          .select('*')
          .eq('deleted', false)
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Error loading notes (RLS?):', error);
          throw error;
        }
        
        const tbody = document.getElementById('notesTableBody');
        
        if (!notes || notes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üìÑ</div><div>No notes found</div></td></tr>';
          return;
        }
        
        tbody.innerHTML = notes.map(note => `
          <tr>
            <td>${note.title || 'Untitled'}</td>
            <td>${note.system || '-'}</td>
            <td>${note.group_name || '-'}</td>
            <td>${note.class_date ? new Date(note.class_date).toLocaleDateString() : '-'}</td>
            <td><span class="badge ${note.requires_payment ? 'locked' : 'free'}">${note.requires_payment ? 'üîí Locked' : '‚úì Free'}</span></td>
            <td>
              <button class="action-btn view" onclick="viewNote(${note.id})">View</button>
              <button class="action-btn delete" onclick="deleteNote(${note.id})">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading notes:', error);
        document.getElementById('notesTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center; color: #ef4444;">Error loading notes</td></tr>';
      }
    }
    
    // Group Notes now handled by standalone Group-Notes.html page
    
    // Student Modal Functions
    function openStudentModal() {
      currentStudentId = null;
      document.getElementById('studentModalTitle').textContent = 'Add Student';
      document.getElementById('studentForm').reset();
      document.getElementById('studentModal').classList.add('active');
    }
    
    function closeStudentModal() {
      document.getElementById('studentModal').classList.remove('active');
    }
    
    async function saveStudent(event) {
      event.preventDefault();
      
      const studentData = {
        name: document.getElementById('studentName').value,
        email: document.getElementById('studentEmail').value,
        group_name: canonicalizeGroupCode(document.getElementById('studentGroup').value) || null,
        schedule: document.getElementById('studentSchedule').value,
        price_per_class: parseInt(document.getElementById('studentPrice').value) || 50,
        show_in_grid: true
      };
      
      try {
        if (currentStudentId) {
          // Update existing
          const { error } = await supabaseClient
            .from('students')
            .update(studentData)
            .eq('id', currentStudentId);
          
          if (error) throw error;
          alert('Student updated successfully!');
        } else {
          // Create new
          const { error } = await supabaseClient
            .from('students')
            .insert([studentData]);
          
          if (error) throw error;
          alert('Student added successfully!');
        }
        
        // PERFORMANCE: Clear cache after mutation
        clearCache('students');
        clearCache('stats');
        
        closeStudentModal();
        loadStudents();
        loadStats();
      } catch (error) {
        console.error('Error saving student:', error);
        alert('Error saving student: ' + error.message);
      }
    }
    
    async function editStudent(id) {
      try {
  const { data, error } = await supabaseClient
          .from('students')
          .select('*')
          .eq('id', id)
          .single();
        
        if (error) throw error;
        
        currentStudentId = id;
        document.getElementById('studentModalTitle').textContent = 'Edit Student';
        document.getElementById('studentName').value = data.name || '';
        document.getElementById('studentEmail').value = data.email || '';
  document.getElementById('studentGroup').value = canonicalizeGroupCode(data.group_name || data.group || '');
        document.getElementById('studentSchedule').value = data.schedule || '';
        document.getElementById('studentPrice').value = data.price_per_class || 50;
        
        document.getElementById('studentModal').classList.add('active');
      } catch (error) {
        console.error('Error loading student:', error);
        alert('Error loading student');
      }
    }
    
    function viewStudent(id) {
      window.open(`Student-Manager.html#student-${id}`, '_blank');
    }
    
    // Impersonate Student - View Portal as Student
    // Show student online status
    async function showStudentStatus(studentId, studentName) {
      try {
        await ensureAdminSession();
        
        // FIX: Query student_sessions table (not session_logs)
        // CRITICAL: Ensure studentId is a number for proper filtering
        const numericStudentId = parseInt(studentId);
        if (isNaN(numericStudentId)) {
          console.error('‚ùå Invalid student ID:', studentId);
          alert('Invalid student ID');
          return;
        }
        
        // PERFORMANCE: Show modal immediately with loading state
        const modal = document.getElementById('statusModal');
        const modalContent = document.getElementById('statusModalContent');
        modalContent.innerHTML = `
          <div class="status-modal-header">
            <h3>${studentName} - Session Analytics</h3>
            <button class="close-btn" onclick="closeStatusModal()">√ó</button>
          </div>
          <div class="status-modal-body" style="text-align:center; padding: 40px;">
            <div style="color: rgba(255,255,255,0.6);">Loading session data...</div>
          </div>
        `;
        modal.style.display = 'flex';
        
        // PERFORMANCE: Defer data fetching to next frame
        requestAnimationFrame(async () => {
          const { data: sessions, error } = await supabaseClient
            .from('student_sessions')
            .select('*')
            .eq('student_id', numericStudentId)
            .order('session_start', { ascending: false })
            .limit(20);
          
          if (error) {
            console.error('Session query error:', error);
            modalContent.innerHTML = `
              <div class="status-modal-header">
                <h3>${studentName} - Session Analytics</h3>
                <button class="close-btn" onclick="closeStatusModal()">√ó</button>
              </div>
              <div class="status-modal-body" style="text-align:center; padding: 40px; color: #ef4444;">
                Failed to load session data
              </div>
            `;
            return;
          }
          
          // Calculate statistics (FIX: student_sessions doesn't have duration_seconds, page_views, or notes_viewed)
          // We need to calculate duration from session_start and session_end
          const activeSession = sessions?.find(s => s.is_active);
          const totalSessions = sessions?.length || 0;
          
          // Calculate total seconds by summing up session durations
          const totalSeconds = sessions?.reduce((sum, s) => {
            if (s.session_end && s.session_start) {
              const start = new Date(s.session_start);
              const end = new Date(s.session_end);
              return sum + Math.floor((end - start) / 1000);
            }
            // For active sessions, calculate from start to now
            if (s.is_active && s.session_start) {
              const start = new Date(s.session_start);
              const now = new Date();
              return sum + Math.floor((now - start) / 1000);
            }
            return sum;
          }, 0) || 0;
          
          const totalHours = (totalSeconds / 3600).toFixed(1);
          const avgSessionMinutes = totalSessions > 0 ? ((totalSeconds / totalSessions) / 60).toFixed(1) : 0;
          
          // Build status HTML
          let statusHTML = `
            <div class="status-modal-header">
              <h3>${studentName} - Session Analytics</h3>
              <button class="close-btn" onclick="closeStatusModal()">√ó</button>
            </div>
            <div class="status-modal-body">
          `;
          
          // Current Status Section
          if (activeSession) {
            const loginTime = new Date(activeSession.session_start);
            const lastActivity = new Date(activeSession.last_activity);
            const now = new Date();
            const sessionDuration = Math.floor((now - loginTime) / 1000 / 60); // minutes
            const idleMinutes = Math.floor((now - lastActivity) / 1000 / 60);
            
            statusHTML += `
              <div class="status-indicator online">
                <span class="user-status-dot"></span>
                <span class="status-text">üü¢ Currently Online</span>
              </div>
              <div class="status-details">
                <div class="status-row">
                  <span class="status-label">Login Time:</span>
                  <span class="status-value">${loginTime.toLocaleString()}</span>
                </div>
                <div class="status-row">
                  <span class="status-label">Session Duration:</span>
                  <span class="status-value">${sessionDuration} minutes</span>
                </div>
                <div class="status-row">
                  <span class="status-label">Last Activity:</span>
                  <span class="status-value">${idleMinutes === 0 ? 'Just now' : idleMinutes + ' minutes ago'}</span>
                </div>
              </div>
            `;
          } else if (sessions && sessions.length > 0) {
            const lastSession = sessions[0];
            // Calculate last session duration
            let lastSessionMinutes = 0;
            if (lastSession.session_end && lastSession.session_start) {
              const start = new Date(lastSession.session_start);
              const end = new Date(lastSession.session_end);
              lastSessionMinutes = Math.floor((end - start) / 1000 / 60);
            }
            const lastSeen = new Date(lastSession.session_end || lastSession.last_activity);
            
            statusHTML += `
              <div class="status-indicator offline">
                <span class="user-status-dot"></span>
                <span class="status-text">üî¥ Offline</span>
              </div>
              <div class="status-details">
                <div class="status-row">
                  <span class="status-label">Last Seen:</span>
                  <span class="status-value">${lastSeen.toLocaleString()}</span>
                </div>
                <div class="status-row">
                  <span class="status-label">Last Session Duration:</span>
                  <span class="status-value">${lastSessionMinutes} minutes</span>
                </div>
              </div>
            `;
          } else {
            statusHTML += `
              <div class="status-indicator offline">
                <span class="user-status-dot"></span>
                <span class="status-text">‚ö™ Never Logged In</span>
              </div>
            `;
          }
          
          // Overall Statistics Section
          if (totalSessions > 0) {
            statusHTML += `
              <div class="stats-section">
                <h4>üìä Overall Statistics</h4>
                <div class="stats-grid">
                  <div class="stat-item">
                    <div class="stat-value">${totalSessions}</div>
                    <div class="stat-label">Total Sessions</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">${totalHours}h</div>
                    <div class="stat-label">Total Study Time</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">${avgSessionMinutes}m</div>
                    <div class="stat-label">Avg Session</div>
                  </div>
                </div>
              </div>
            `;
          }
          
          // Recent Session History
          if (sessions && sessions.length > 0) {
            statusHTML += `
              <div class="status-history">
                <h4>üìÖ Recent Session History</h4>
                <div class="history-list">
            `;
            
            sessions.slice(0, 10).forEach(session => {
              const start = new Date(session.session_start);
              const end = session.session_end ? new Date(session.session_end) : null;
              
              // FIXED: Calculate duration from session_start and session_end (not from non-existent duration_seconds field)
              let durationMinutes = 0;
              if (end && start) {
                durationMinutes = Math.floor((end - start) / 1000 / 60);
              } else if (session.is_active && start) {
                // For active sessions, calculate duration from start to now
                durationMinutes = Math.floor((new Date() - start) / 1000 / 60);
              }
              
              const hours = Math.floor(durationMinutes / 60);
              const minutes = durationMinutes % 60;
              const durationText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
              
              statusHTML += `
                <div class="history-item">
                  <div class="history-main">
                    <span class="history-date">${start.toLocaleDateString()} ${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    <span class="history-duration">${session.is_active ? 'üü¢ Active - ' + durationText : durationText}</span>
                  </div>
                  <div class="history-details">
                    <span>‚è±Ô∏è Duration: ${durationText}</span>
                    ${end ? '<span>üèÅ Ended: ' + end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + '</span>' : '<span>üü¢ Currently Active</span>'}
                  </div>
                </div>
              `;
            });
            
            statusHTML += `
                </div>
              </div>
            `;
          }
          
          statusHTML += `</div>`;
          
          // Update modal content
          modalContent.innerHTML = statusHTML;
        });
        
      } catch (error) {
        console.error('Error loading student status:', error);
        alert('Failed to load student status: ' + error.message);
      }
    }
    
    function closeStatusModal() {
      document.getElementById('statusModal').style.display = 'none';
    }
    
    function formatTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
      
      return date.toLocaleDateString();
    }

    async function impersonateStudent(studentId, studentName) {
      try {
        // Ensure studentId is a number (not string)
        const numericStudentId = parseInt(studentId);
        if (isNaN(numericStudentId)) {
          alert('Invalid student ID');
          return;
        }
        
        // Generate impersonation token (valid for 10 minutes)
        const impersonationToken = {
          studentId: numericStudentId,  // Store as number
          studentName: studentName,
          timestamp: Date.now(),
          expiresAt: Date.now() + (10 * 60 * 1000), // 10 minutes
          adminEmail: currentEmail || 'admin',
          isMasterAccess: true  // Required for student-portal.html to recognize impersonation
        };
        
        // Store in BOTH sessionStorage AND localStorage for reliability
        sessionStorage.setItem('impersonation_token', JSON.stringify(impersonationToken));
        localStorage.setItem('impersonation_token', JSON.stringify(impersonationToken));
        
        // Small delay to ensure storage write completes
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Open in fullscreen modal instead of navigation
        const modal = document.getElementById('impersonationModal');
        const iframe = document.getElementById('impersonationIframe');
        const titleElement = document.getElementById('impersonationStudentName');
        
        // Update modal title
        titleElement.textContent = `Viewing as ${studentName}`;
        
        // Set iframe src with impersonation parameter
        iframe.src = `student-portal.html?impersonate=${studentId}`;
        
        // Show modal
        modal.classList.add('active');
        
      } catch (error) {
        console.error('Error starting impersonation:', error);
        alert('Failed to start impersonation mode: ' + error.message);
      }
    }
    
    function closeImpersonation() {
      const modal = document.getElementById('impersonationModal');
      const iframe = document.getElementById('impersonationIframe');
      
      // Clear iframe
      iframe.src = '';
      
      // Hide modal
      modal.classList.remove('active');
      
      // Clear impersonation tokens
      sessionStorage.removeItem('impersonation_token');
      localStorage.removeItem('impersonation_token');
      
      // Clear admin chat tokens
      sessionStorage.removeItem('admin_chat_token');
      localStorage.removeItem('admin_chat_token');
      
      // Refresh student list to update any changes
      loadStudents();
    }
    
    // Check for new forum messages and update badge
    async function checkNewMessages() {
      try {
        const badge = document.getElementById('chatBadge');
        if (!badge) return;
        
        // Get last viewed timestamp from localStorage
        const lastViewed = localStorage.getItem('admin_chat_last_viewed') || 0;
        const lastViewedTime = new Date(parseInt(lastViewed));
        
        // Query for messages newer than last viewed
  const { data: messages, error } = await supabaseClient
          .from('forum_messages')
          .select('id, created_at')
          .gt('created_at', lastViewedTime.toISOString())
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Error checking messages:', error);
          return;
        }
        
        const newMessageCount = messages?.length || 0;
        
        // Update badge
        if (newMessageCount > 0) {
          badge.textContent = newMessageCount > 99 ? '99+' : newMessageCount;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
        
      } catch (error) {
        console.error('Error in checkNewMessages:', error);
      }
    }
    
    // Open admin chat modal
    async function openAdminChat() {
      console.log('üéØ openAdminChat() called');
      
      // Mark messages as viewed
      localStorage.setItem('admin_chat_last_viewed', Date.now().toString());
      
      // Hide badge immediately
      const badge = document.getElementById('chatBadge');
      if (badge) {
        badge.style.display = 'none';
      }
      
      try {
        // Get current admin user
        const { data: { user } } = await supabaseClient.auth.getUser();
        console.log('üë§ Admin user:', user?.email);
        
        if (!user) {
          alert('Please log in to access the chat');
          return;
        }
        
        // Create admin chat token (similar to impersonation but for admin)
        const adminChatToken = {
          isAdmin: true,
          adminEmail: user.email || currentEmail || 'admin',
          timestamp: Date.now(),
          expiresAt: Date.now() + (60 * 60 * 1000), // 1 hour
          mode: 'admin_chat'
        };
        
        console.log('üé´ Created admin chat token:', adminChatToken);
        
        // Store token in localStorage so iframe can access it
        localStorage.setItem('admin_chat_token', JSON.stringify(adminChatToken));
        
        const modal = document.getElementById('impersonationModal');
        const iframe = document.getElementById('impersonationIframe');
        const titleElement = document.getElementById('impersonationStudentName');
        
        console.log('üîç Modal elements:', { modal: !!modal, iframe: !!iframe, titleElement: !!titleElement });
        
        // Update modal title
        titleElement.textContent = 'Student Chat (Admin Mode)';
        
        // Wait for iframe to load before showing modal
        iframe.addEventListener('load', function onIframeLoad() {
          modal.classList.add('active');
          console.log('‚úÖ Modal opened successfully');
          iframe.removeEventListener('load', onIframeLoad);
        }, { once: true });
        
        // Load student portal with hash to go directly to forum tab
        iframe.src = 'student-portal.html#forum';
        
        console.log('üì± Loading iframe:', iframe.src);
        
      } catch (error) {
        console.error('‚ùå Error opening admin chat:', error);
        alert('Failed to open chat. Please try again.');
      }
    }
    
    async function deleteStudent(id) {
      if (!confirm('Are you sure you want to delete this student?')) return;
      
      try {
  const { error } = await supabaseClient
          .from('students')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        // PERFORMANCE: Clear cache after mutation
        clearCache('students');
        clearCache('stats');
        
        alert('Student deleted successfully!');
        loadStudents();
        loadStats();
      } catch (error) {
        console.error('Error deleting student:', error);
        alert('Error deleting student: ' + error.message);
      }
    }
    
    function viewNote(id) {
      window.open(`Protected-PDF-Viewer.html?note=${id}`, '_blank');
    }
    
    async function deleteNote(id) {
      if (!confirm('Are you sure you want to delete this note?')) return;
      
      try {
        const { error } = await supabaseClient
          .from('student_notes')
          .update({ deleted: true })
          .eq('id', id);
        
        if (error) throw error;
        
        alert('Note deleted successfully!');
        loadNotes();
        loadStats();
      } catch (error) {
        console.error('Error deleting note:', error);
        alert('Error deleting note: ' + error.message);
      }
    }
    
    function viewPayment(source, id) {
      if (source === 'payment_records') {
        window.open(`Payment-Records.html#payment-${id}`, '_blank');
      } else {
        // Zelle payments - could open Payment-Records in Zelle view
        window.open(`Payment-Records.html`, '_blank');
      }
    }
    
    async function deletePayment(id) {
      if (!confirm('Are you sure you want to delete this payment record?')) return;
      
      try {
        const { error } = await supabaseClient
          .from('payment_records')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        alert('Payment deleted successfully!');
        loadPayments();
        loadStats();
      } catch (error) {
        console.error('Error deleting payment:', error);
        alert('Error deleting payment: ' + error.message);
      }
    }
    
    function viewMessage(id) {
      alert(`View message ${id} - Feature coming soon!`);
    }
    
    async function deleteMessage(id) {
      if (!confirm('Are you sure you want to delete this message and all its replies?')) return;
      
      try {
        // Delete replies first
        await supabaseClient
          .from('nurses_forum')
          .delete()
          .eq('parent_id', id);
        
        // Delete message
        const { error } = await supabaseClient
          .from('nurses_forum')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        alert('Message deleted successfully!');
        loadForum();
        loadStats();
      } catch (error) {
        console.error('Error deleting message:', error);
        alert('Error deleting message: ' + error.message);
      }
    }
    
    // Filter Functions
    let showOnlineOnly = false;
    let showActiveOnly = true; // DEFAULT: Show active students only
    
    function toggleActiveFilter() {
      showActiveOnly = !showActiveOnly;
      const btn = document.getElementById('activeFilterBtn');
      
      if (showActiveOnly) {
        btn.classList.add('active');
        btn.textContent = '‚úì';
        btn.title = 'Active students only';
      } else {
        btn.classList.remove('active');
        btn.textContent = '‚óã';
        btn.title = 'All students';
      }
      
      filterStudents();
    }
    
    function toggleOnlineFilter() {
      showOnlineOnly = !showOnlineOnly;
      const btn = document.getElementById('onlineFilterBtn');
      
      if (showOnlineOnly) {
        btn.classList.add('active');
        btn.title = 'Showing online only';
      } else {
        btn.classList.remove('active');
        btn.title = 'Online students only';
      }
      
      filterStudents();
    }
    
    function filterStudents() {
      const search = document.getElementById('studentSearch').value.toLowerCase();
      const selectedGroup = document.getElementById('groupFilterSelect')?.value || '';
      
      // PERFORMANCE: Immediate count update, defer row filtering
      const tbody = document.getElementById('studentsTableBody');
      if (!tbody) return;
      
      const rows = tbody.querySelectorAll('tr');
      
      // PERFORMANCE: Defer heavy DOM operations to next animation frame
      requestAnimationFrame(() => {
        let visibleCount = 0;
        
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          const rowGroup = row.getAttribute('data-group') || '';
          const matchesSearch = text.includes(search);
          const matchesGroup = !selectedGroup || rowGroup === selectedGroup;
          
          // Check if student is online (has .online class on status button)
          const statusBtn = row.querySelector('.action-btn.info');
          const isOnline = statusBtn && statusBtn.classList.contains('online');
          
          // Check if student is active (data-active attribute)
          const isActive = row.getAttribute('data-active') === 'true';
          
          // Show row if it matches all filters:
          // - search term AND
          // - group filter AND
          // - online filter (if enabled) AND
          // - active filter (if enabled)
          const shouldShow = matchesSearch && 
                            matchesGroup && 
                            (!showOnlineOnly || isOnline) &&
                            (!showActiveOnly || isActive);
          row.style.display = shouldShow ? '' : 'none';
          if (shouldShow) visibleCount++;
        });
      });
    }
    
    // Create debounced versions of filter functions (300ms delay) - MUST be after functions are defined
    const debouncedFilterStudents = debounce(filterStudents, 300);
    const debouncedFilterNotes = debounce(() => {
      const search = document.getElementById('notesSearch')?.value.toLowerCase() || '';
      const rows = document.querySelectorAll('#notesTableBody tr');
      rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
      });
    }, 300);
    const debouncedFilterStudentList = debounce(() => {
      const search = document.getElementById('studentAlertSearch')?.value.toLowerCase() || '';
      document.querySelectorAll('.alert-student-item').forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(search) ? '' : 'none';
      });
    }, 300);
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Get current admin email with timeout
  const sessionPromise = supabaseClient.auth.getSession();
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Session timeout after 5s')), 5000)
        );
        
        const { data: { session } } = await Promise.race([sessionPromise, timeoutPromise]);
        
        if (session && session.user) {
          currentEmail = session.user.email;
        }
        
        loadStats();
        loadStudents();
        
        // Check for new messages on load
        checkNewMessages();
        
        // Poll for new messages every 30 seconds
        setInterval(checkNewMessages, 30000);
        
      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        loadStats();
        loadStudents();
      }

      // Close responses modal when clicking outside
      const responsesModal = document.getElementById('responsesModal');
      if (responsesModal) {
        responsesModal.addEventListener('click', (e) => {
          if (e.target.id === 'responsesModal') {
            closeResponsesModal();
          }
        });
      }
      
      // Close status modal when clicking backdrop
      const statusModal = document.getElementById('statusModal');
      if (statusModal) {
        statusModal.addEventListener('click', (e) => {
          if (e.target === statusModal) {
            closeStatusModal();
          }
        });
      }
    });
  </script>

  <!-- Status Modal -->
  <div id="statusModal" class="status-modal">
    <div id="statusModalContent" class="status-modal-content"></div>
  </div>

  <!-- REMOVED: Orphaned Note Modal (notes are managed via Notes-Manager-NEW.html) -->

  <!-- Full-Screen Modal for Notes Manager -->
  <div id="notesManagerModal" class="modal-overlay">
    <div class="modal-content-fullscreen">
      <div class="modal-header-bar">
        <h2>üìö Notes Manager</h2>
        <button class="modal-close-btn" onclick="closeNotesManager()">√ó</button>
      </div>
      <div class="modal-iframe-container">
        <iframe id="notesManagerIframe" src="" title="Notes Manager"></iframe>
      </div>
    </div>
  </div>

  <script>
    // ===== MODAL FUNCTIONS =====
    function openNotesManager() {
      const modal = document.getElementById('notesManagerModal');
      const iframe = document.getElementById('notesManagerIframe');
      
      // Set iframe source with cache-busting timestamp
      iframe.src = `Notes-Manager-NEW.html?v=${Date.now()}`;
      
      // Show modal
      modal.classList.add('active');
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    function closeNotesManager() {
      const modal = document.getElementById('notesManagerModal');
      const iframe = document.getElementById('notesManagerIframe');
      
      // Hide modal with fade out
      modal.classList.remove('active');
      
      // Clear iframe source to stop any processes
      setTimeout(() => {
        iframe.src = '';
      }, 300);
      
      // Restore body scroll
      document.body.style.overflow = '';
      
      // Reload notes in case they were updated
      if (typeof loadNotes === 'function') {
        loadNotes();
      }
    }

    // Initialize Notes Manager modal event listeners after DOM loads
    document.addEventListener('DOMContentLoaded', () => {
      // Close modal on ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const modal = document.getElementById('notesManagerModal');
          if (modal && modal.classList.contains('active')) {
            closeNotesManager();
          }
        }
      });

      // Close modal on background click
      const notesModal = document.getElementById('notesManagerModal');
      if (notesModal) {
        notesModal.addEventListener('click', (e) => {
          if (e.target.id === 'notesManagerModal') {
            closeNotesManager();
          }
        });
      }

      // Listen for messages from embedded iframes (e.g., Group Notes Manager, Impersonation)
      window.addEventListener('message', (event) => {
        if (event.data && event.data.action === 'openNotesManager') {
          openNotesManager();
        }
        
        // Handle impersonation iframe messages
        if (event.data && event.data.action === 'closeImpersonation') {
          closeImpersonation();
        
          // Show error message based on reason
          if (event.data.reason === 'not_found') {
            alert('Student not found in database. Please refresh the page and try again.');
          } else if (event.data.reason === 'expired') {
            alert('Impersonation session expired.');
          } else if (event.data.reason === 'no_token') {
            alert('Impersonation token not found. Please try again.');
          }
        }
      });
    });

    // ===== ALERT SYSTEM FUNCTIONS =====
    
    async function openAlertModal() {
      // Show modal immediately
      document.getElementById('alertModal').classList.add('active');
      
      try {
        // Load all students (use * to get all columns)
        const { data: students, error } = await supabaseClient
          .from('students')
          .select('*')
          .order('name');
        
        if (error) throw error;
        
        // Store students data globally for filtering
        allStudentsData = students || [];
        
        // Populate student checkboxes
        const checkboxGroup = document.getElementById('studentCheckboxGroup');
        
        if (!students || students.length === 0) {
          checkboxGroup.innerHTML = `
            <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.6);">
              No students found
            </div>
          `;
          return;
        }
        
        // Get group from student data (try multiple possible column names)
        checkboxGroup.innerHTML = students.map(student => {
          const group = student.group_letter || student.group || student.group_name || '';
          return `
            <div class="student-checkbox-item">
              <input 
                type="checkbox" 
                id="student_${student.id}" 
                value="${student.id}"
                data-name="${student.name || ''}"
                data-group="${group}"
                data-email="${student.email || ''}"
                data-balance="${student.balance || 0}"
              />
              <label for="student_${student.id}">${student.name} ${group ? `(${group})` : ''}</label>
            </div>
          `;
        }).join('');
        
      } catch (error) {
        console.error('Error loading students:', error);
        const checkboxGroup = document.getElementById('studentCheckboxGroup');
        checkboxGroup.innerHTML = `
          <div style="padding: 20px; text-align: center; color: rgba(239,68,68,0.9);">
            ‚ö†Ô∏è Failed to load students<br>
            <small style="color: rgba(255,255,255,0.6);">${error.message || 'Please try again'}</small>
          </div>
        `;
      }
    }
    
    function closeAlertModal() {
      document.getElementById('alertModal').classList.remove('active');
      document.getElementById('alertForm').reset();
      document.getElementById('questionFieldContainer').style.display = 'none';
      document.getElementById('variableSuggestions').style.display = 'none';
      document.getElementById('alertStudentSearch').value = '';
      const repeatCheckbox = document.getElementById('limitRepeats');
      if (repeatCheckbox) {
        repeatCheckbox.checked = false;
      }
      const repeatContainer = document.getElementById('repeatLimitContainer');
      if (repeatContainer) {
        repeatContainer.style.display = 'none';
      }
      const repeatCountInput = document.getElementById('repeatCount');
      if (repeatCountInput) {
        repeatCountInput.value = 1;
        updateRepeatCountPreview(1);
      }
    }
    
    function showVariableSuggestions(textarea) {
      const value = textarea.value;
      const suggestionsDiv = document.getElementById('variableSuggestions');
      
      // Show suggestions if user types {
      if (value.includes('{')) {
        suggestionsDiv.style.display = 'block';
      } else {
        suggestionsDiv.style.display = 'none';
      }
    }
    
    function insertVariable(variable) {
      const textarea = document.getElementById('alertMessage');
      const cursorPos = textarea.selectionStart;
      const textBefore = textarea.value.substring(0, cursorPos);
      const textAfter = textarea.value.substring(cursorPos);
      
      textarea.value = textBefore + variable + textAfter;
      textarea.focus();
      
      // Set cursor after inserted variable
      const newCursorPos = cursorPos + variable.length;
      textarea.setSelectionRange(newCursorPos, newCursorPos);
    }
    
    let allStudentsData = []; // Store all students for filtering
    
    function filterStudentList() {
      const searchTerm = document.getElementById('alertStudentSearch').value.toLowerCase();
      const checkboxGroup = document.getElementById('studentCheckboxGroup');
      
      if (!allStudentsData || allStudentsData.length === 0) {
        console.warn('‚ö†Ô∏è No students data available for filtering');
        return;
      }
      
      // If search is empty, show all students
      const filtered = searchTerm === '' ? allStudentsData : allStudentsData.filter(student => {
        const name = (student.name || '').toLowerCase();
        const email = (student.email || '').toLowerCase();
        const group = (student.group_letter || student.group || student.group_name || '').toLowerCase();
        
        return name.includes(searchTerm) || 
               email.includes(searchTerm) || 
               group.includes(searchTerm);
      });
      
      if (filtered.length === 0) {
        checkboxGroup.innerHTML = `
          <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">
            No students match "${searchTerm}"
          </div>
        `;
        return;
      }
      
      checkboxGroup.innerHTML = filtered.map(student => {
        const group = student.group_letter || student.group || student.group_name || '';
        return `
          <div class="student-checkbox-item">
            <input 
              type="checkbox" 
              id="student_${student.id}" 
              value="${student.id}"
              data-name="${student.name || ''}"
              data-group="${group}"
              data-email="${student.email || ''}"
              data-balance="${student.balance || 0}"
            />
            <label for="student_${student.id}">${student.name} ${group ? `(${group})` : ''}</label>
          </div>
        `;
      }).join('');
    }
    
    function toggleQuestionField() {
      const hasQuestion = document.getElementById('hasQuestion').checked;
      const container = document.getElementById('questionFieldContainer');
      container.style.display = hasQuestion ? 'block' : 'none';
      
      // Clear question text if unchecked
      if (!hasQuestion) {
        document.getElementById('questionText').value = '';
      }
    }

    function toggleRepeatLimit() {
      const limitCheckbox = document.getElementById('limitRepeats');
      const container = document.getElementById('repeatLimitContainer');
      if (!limitCheckbox || !container) return;
      const isEnabled = limitCheckbox.checked;
      container.style.display = isEnabled ? 'block' : 'none';
      if (!isEnabled) {
        const repeatCountInput = document.getElementById('repeatCount');
        if (repeatCountInput) {
          repeatCountInput.value = 1;
        }
      }
      const repeatCountInput = document.getElementById('repeatCount');
      if (repeatCountInput) {
        updateRepeatCountPreview(repeatCountInput.value);
      }
    }

    function updateRepeatCountPreview(value) {
      const preview = document.getElementById('repeatCountPreview');
      if (!preview) return;
      const parsed = parseInt(value, 10);
      const safeValue = Number.isFinite(parsed) && parsed > 0 ? parsed : 1;
      preview.textContent = safeValue;
    }
    
    function toggleGroup(groupLetter) {
      const checkboxes = document.querySelectorAll('#studentCheckboxGroup input[type="checkbox"]');
      const btn = document.getElementById(`groupBtn-${groupLetter}`);
      
      // Check if any students in this group are currently checked
      const groupCheckboxes = Array.from(checkboxes).filter(cb => cb.dataset.group === groupLetter);
      const someChecked = groupCheckboxes.some(cb => cb.checked);
      
      // Toggle: if some are checked, uncheck all; if none checked, check all
      const newState = !someChecked;
      
      groupCheckboxes.forEach(checkbox => {
        checkbox.checked = newState;
      });
      
      // Update button visual state
      if (newState) {
        btn.style.background = 'rgba(102,126,234,0.5)';
        btn.style.borderColor = 'rgba(102,126,234,0.8)';
        btn.style.boxShadow = '0 0 12px rgba(102,126,234,0.4)';
      } else {
        btn.style.background = 'rgba(147,51,234,0.25)';
        btn.style.borderColor = 'rgba(147,51,234,0.4)';
        btn.style.boxShadow = 'none';
      }
      
      // Show visual feedback
      const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    }
    
    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('#studentCheckboxGroup input[type="checkbox"]');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      
      checkboxes.forEach(cb => {
        cb.checked = !allChecked;
      });
      
      // Reset all group button states
      ['A', 'B', 'C', 'D', 'E', 'F'].forEach(letter => {
        const btn = document.getElementById(`groupBtn-${letter}`);
        if (btn) {
          if (!allChecked) {
            btn.style.background = 'rgba(102,126,234,0.5)';
            btn.style.borderColor = 'rgba(102,126,234,0.8)';
            btn.style.boxShadow = '0 0 12px rgba(102,126,234,0.4)';
          } else {
            btn.style.background = 'rgba(147,51,234,0.25)';
            btn.style.borderColor = 'rgba(147,51,234,0.4)';
            btn.style.boxShadow = 'none';
          }
        }
      });
    }
    
    async function saveAlert(event) {
      event.preventDefault();
      
      try {
        const message = document.getElementById('alertMessage').value;
        const alertType = document.getElementById('alertType').value;
        const scheduleTime = document.getElementById('alertSchedule').value;
        const expiration = document.getElementById('alertExpiration').value;
        const isOneTime = document.getElementById('isOneTime').checked;
    const showOnOpen = document.getElementById('showOnOpen').checked;
    const limitRepeats = document.getElementById('limitRepeats').checked;
    const repeatCountInput = document.getElementById('repeatCount');
  const parsedRepeatCount = parseInt(repeatCountInput?.value || '1', 10);
  const repeatCount = Number.isFinite(parsedRepeatCount) ? Math.min(20, Math.max(1, parsedRepeatCount)) : 1;
        const hasQuestion = document.getElementById('hasQuestion').checked;
        const questionText = document.getElementById('questionText').value;
        const answerOption1 = document.getElementById('answerOption1').value || 'Yes';
        const answerOption2 = document.getElementById('answerOption2').value || 'No';
        
        // Get selected students
        const checkboxes = document.querySelectorAll('#studentCheckboxGroup input[type="checkbox"]:checked');
        
        if (checkboxes.length === 0) {
          alert('Please select at least one student to alert.');
          return;
        }
        
        // Validate question if checkbox is checked
        if (hasQuestion && !questionText.trim()) {
          alert('Please enter a question or uncheck the "Add Question" option.');
          return;
        }

        if (limitRepeats && (!Number.isFinite(parsedRepeatCount) || parsedRepeatCount < 1)) {
          alert('Please enter how many times the alert should appear (minimum of 1).');
          return;
        }
        
        // Create alerts for each selected student
        const alerts = [];
        
        checkboxes.forEach(checkbox => {
          const studentId = checkbox.value;
          const studentName = checkbox.dataset.name;
          const studentGroup = checkbox.dataset.group;
          const studentEmail = checkbox.dataset.email;
          
          // Replace variables in message
          let personalizedMessage = message
            .replace(/{student_name}/g, studentName)
            .replace(/{group}/g, studentGroup || 'N/A')
            .replace(/{email}/g, studentEmail);
          
          // Replace variables in question if it exists
          let personalizedQuestion = null;
          if (hasQuestion && questionText) {
            personalizedQuestion = questionText
              .replace(/{student_name}/g, studentName)
              .replace(/{group}/g, studentGroup || 'N/A')
              .replace(/{email}/g, studentEmail);
          }
          
          alerts.push({
            student_id: studentId,
            message: personalizedMessage,
            alert_type: alertType,
            scheduled_for: scheduleTime || null,
            expires_at: expiration || null,
            is_one_time: isOneTime,
            show_on_open: showOnOpen,
            is_read: false,
            has_question: hasQuestion,
            question_text: personalizedQuestion,
            answer_option_1: answerOption1,
            answer_option_2: answerOption2,
            created_at: new Date().toISOString(),
            max_show_count: limitRepeats ? repeatCount : null,
            times_shown: 0
          });
        });
        
        // Insert alerts into database
        const { error } = await supabaseClient
          .from('student_alerts')
          .insert(alerts);
        
        if (error) {
          // If table doesn't exist, create it
          if (error.message.includes('relation "student_alerts" does not exist')) {
            alert('The student_alerts table needs to be created. Please run the setup SQL script.');
            return;
          }
          throw error;
        }
        
        await customAlert('Success!', `Alert created for ${alerts.length} student${alerts.length > 1 ? 's' : ''}!`);
        
        // Ask if user wants to save as template
        const saveAsTemplate = await customConfirm('Save as Template?', 'Would you like to save this alert as a template for future use?');
        
        if (saveAsTemplate) {
          const templateName = await customPrompt('Template Name', 'Enter a name for this template');
          
          if (templateName) {
            const templates = loadTemplatesFromStorage();
            const newTemplate = {
              id: 'custom-' + Date.now(),
              name: templateName,
              message: message,
              type: alertType,
              hasQuestion: hasQuestion,
              questionText: hasQuestion ? questionText : '',
              answerOption1: hasQuestion ? answerOption1 : '',
              answerOption2: hasQuestion ? answerOption2 : '',
              showOnOpen: showOnOpen,
              limitRepeats: limitRepeats,
              repeatCount: limitRepeats ? repeatCount : 1
            };
            templates.push(newTemplate);
            saveTemplatesToStorage(templates);
            
            await customAlert('Saved!', 'Template saved successfully!');
          }
        }
        
        closeAlertModal();
        
      } catch (error) {
        console.error('Error creating alert:', error);
        await customAlert('Error', 'Failed to create alert. Please try again.');
      }
    }
    
    // Setup alert modal event listeners after DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Close alert modal when clicking outside
      const alertModal = document.getElementById('alertModal');
      if (alertModal) {
        alertModal.addEventListener('click', (e) => {
          if (e.target.id === 'alertModal') {
            closeAlertModal();
          }
        });
      }
      
      // Close responses modal when clicking outside
      const responsesModal = document.getElementById('responsesModal');
      if (responsesModal) {
        responsesModal.addEventListener('click', (e) => {
          if (e.target.id === 'responsesModal') {
            closeResponsesModal();
          }
        });
      }
    });
    
    // Close alert modal on ESC key
    document.addEventListener('keydown', (e) => {
      const alertModal = document.getElementById('alertModal');
      const responsesModal = document.getElementById('responsesModal');
      
      if (e.key === 'Escape') {
        if (alertModal && alertModal.classList.contains('active')) {
          closeAlertModal();
        }
        if (responsesModal && responsesModal.classList.contains('active')) {
          closeResponsesModal();
        }
      }
    });
    
    // ===== ALERT RESPONSES VIEWER =====
    
    async function viewAlertResponses(tab = 'viewed') {
      try {
        // Close alert modal if it's open
        const alertModal = document.getElementById('alertModal');
        if (alertModal) {
          alertModal.classList.remove('active');
        }
        
        const modal = document.getElementById('responsesModal');
        const content = document.getElementById('responsesContent');
        
        // Show modal with loading state
        modal.classList.add('active');
        content.innerHTML = '<div class="loading">Loading responses...</div>';
        
        console.log('üìä Loading alert responses - Tab:', tab);
        
        // Create tab navigation
        const tabsHTML = `
          <div style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 12px;">
            <button 
              onclick="viewAlertResponses('viewed')" 
              style="padding: 12px 24px; background: ${tab === 'viewed' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${tab === 'viewed' ? 'rgba(102,126,234,0.5)' : 'rgba(255,255,255,0.1)'}; border-radius: 10px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
              ‚úÖ Alert Views & History
            </button>
            <button 
              onclick="viewAlertResponses('questions')" 
              style="padding: 12px 24px; background: ${tab === 'questions' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${tab === 'questions' ? 'rgba(102,126,234,0.5)' : 'rgba(255,255,255,0.1)'}; border-radius: 10px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
              üìä Question Responses
            </button>
          </div>
          
          <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <input 
              type="text" 
              id="alertSearchInput" 
              placeholder="üîç Search by student name..." 
              oninput="filterAlertsByStudent(this.value)"
              style="flex: 1; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 14px;"
            />
            <button 
              id="filterAllBtn"
              onclick="filterAlertsByStatus('all')" 
              class="alert-filter-btn active"
              style="padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 1px solid rgba(102,126,234,0.5); border-radius: 10px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; white-space: nowrap;">
              üë• All
            </button>
            <button 
              id="filterReadBtn"
              onclick="filterAlertsByStatus('read')" 
              class="alert-filter-btn"
              style="padding: 12px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; white-space: nowrap;">
              ‚úÖ Read
            </button>
            <button 
              id="filterUnreadBtn"
              onclick="filterAlertsByStatus('unread')" 
              class="alert-filter-btn"
              style="padding: 12px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; white-space: nowrap;">
              ‚è≥ Unread
            </button>
          </div>
        `;
        
        if (tab === 'viewed') {
          // First, fetch all students
          const { data: students, error: studentsError } = await supabaseClient
            .from('students')
            .select('id, name, email, group_name');
          
          if (studentsError) throw studentsError;
          
          // Create a lookup map
          const studentMap = {};
          students.forEach(s => {
            studentMap[s.id] = s;
          });
          
          // Then fetch ALL alerts with read status
          const { data: alerts, error } = await supabaseClient
            .from('student_alerts')
            .select('id, message, alert_type, is_read, created_at, student_id, read_at, max_show_count, times_shown')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          
          if (!alerts || alerts.length === 0) {
            content.innerHTML = tabsHTML + `
              <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <p>No alerts have been sent yet</p>
              </div>
            `;
            return;
          }
          
          // Group alerts by message and type to find unique alerts
          const groupedAlerts = {};
          alerts.forEach(alert => {
            const key = `${alert.message}_${alert.alert_type}_${new Date(alert.created_at).toLocaleDateString()}`;
            if (!groupedAlerts[key]) {
              groupedAlerts[key] = {
                message: alert.message,
                alert_type: alert.alert_type,
                created_at: alert.created_at,
                students: []
              };
            }
            
            // Get student data from the map
            const student = studentMap[alert.student_id] || { name: 'Unknown', email: '', group_name: '' };
            
            groupedAlerts[key].students.push({
              name: student.name,
              email: student.email,
              group: student.group_name,
              is_read: alert.is_read,
              read_at: alert.read_at,
              max_show_count: alert.max_show_count,
              times_shown: alert.times_shown
            });
          });
          
          // Show ALL alerts with their student lists
          let html = tabsHTML;
          const allGroups = Object.values(groupedAlerts);
          
          // Sort by most recent first
          allGroups.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          
          // Loop through ALL alerts
          allGroups.forEach(group => {
            const alertTypeIcon = group.alert_type === 'urgent' ? 'üö®' : group.alert_type === 'info' ? '‚ÑπÔ∏è' : '‚ö†Ô∏è';
            const alertTypeColor = group.alert_type === 'urgent' ? '#ef4444' : group.alert_type === 'info' ? '#3b82f6' : '#f59e0b';
            const readCount = group.students.filter(s => s.is_read).length;
            const unreadCount = group.students.filter(s => !s.is_read).length;
            const totalStudents = group.students.length;
            
            // Get all student names for filtering
            const studentNames = group.students.map(s => s.name.toLowerCase()).join('|');
            
            html += `
              <div class="card alert-card" data-student-names="${studentNames}" style="margin-bottom: 24px;">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                      <span style="font-size: 32px;">${alertTypeIcon}</span>
                      <div>
                        <div style="font-size: 16px; font-weight: 700; color: ${alertTypeColor}; text-transform: uppercase; letter-spacing: 0.5px;">
                          ${group.alert_type} Alert
                        </div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 4px;">
                          Sent: ${new Date(group.created_at).toLocaleString()}
                        </div>
                      </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; margin-top: 12px;">
                      <div style="font-size: 14px; line-height: 1.6; color: rgba(255,255,255,0.9); white-space: pre-wrap;">${group.message}</div>
                    </div>
                  </div>
                  <div style="display: flex; gap: 12px; align-items: center; margin-left: 24px;">
                    <div class="badge" style="background: rgba(34,197,94,0.2); color: #22c55e; font-size: 14px; padding: 8px 16px;">
                      ‚úÖ ${readCount} Read
                    </div>
                    <div class="badge" style="background: rgba(239,68,68,0.2); color: #ef4444; font-size: 14px; padding: 8px 16px;">
                      ‚è≥ ${unreadCount} Unread
                    </div>
                    <div class="badge" style="background: rgba(102,126,234,0.2); color: #8ab4ff; font-size: 14px; padding: 8px 16px;">
                      üë• ${totalStudents} Total
                    </div>
                  </div>
                </div>
                
                <div class="table-container" style="margin-top: 20px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Status</th>
                        <th>Student</th>
                        <th>Group</th>
                        <th>Email</th>
                        <th>Views</th>
                        <th>Read At</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${group.students.sort((a, b) => {
                        // Sort: unread first, then by name
                        if (a.is_read === b.is_read) return a.name.localeCompare(b.name);
                        return a.is_read ? 1 : -1;
                      }).map(student => `
                        <tr class="alert-student-row" data-read-status="${student.is_read ? 'read' : 'unread'}" style="background: ${student.is_read ? 'rgba(34,197,94,0.05)' : 'rgba(239,68,68,0.05)'};">
                          <td>
                            ${student.is_read ? 
                              '<span style="font-size: 24px; filter: drop-shadow(0 2px 4px rgba(34,197,94,0.5));">‚úÖ</span>' : 
                              '<span style="font-size: 24px; opacity: 0.3;">‚¨ú</span>'}
                          </td>
                          <td>
                            <div style="font-weight: 600; font-size: 14px;">${student.name}</div>
                          </td>
                          <td>
                            <span class="badge" style="background: rgba(147,51,234,0.2); color: #c084fc;">${student.group || 'N/A'}</span>
                          </td>
                          <td style="font-size: 13px; color: rgba(255,255,255,0.6);">${student.email}</td>
                          <td style="font-size: 13px; color: rgba(255,255,255,0.7);">
                            ${(() => {
                              const maxViews = Number(student.max_show_count);
                              const shown = Number(student.times_shown || 0);
                              if (Number.isFinite(maxViews) && maxViews > 0) {
                                return `${shown}/${maxViews}`;
                              }
                              return shown > 0 ? `${shown}` : '‚Äî';
                            })()}
                          </td>
                          <td style="font-size: 13px; color: rgba(255,255,255,0.7);">
                            ${student.is_read && student.read_at ? 
                              `<div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 16px;">üïê</span>
                                <span>${new Date(student.read_at).toLocaleString('en-US', { 
                                  month: 'short', 
                                  day: 'numeric', 
                                  hour: 'numeric', 
                                  minute: '2-digit',
                                  hour12: true
                                })}</span>
                              </div>` : 
                              '<span style="color: rgba(255,255,255,0.3);">Not read yet</span>'}
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          });
          
          content.innerHTML = html;
          
        } else {
          // Questions tab - original logic
          const { data: alerts, error } = await supabaseClient
            .from('student_alerts')
            .select(`
              id,
              message,
              question_text,
              answer_option_1,
              answer_option_2,
              student_answer,
              answered_at,
              created_at,
              alert_type,
              student_id,
              students (
                name,
                email,
                group_name
              )
            `)
            .eq('has_question', true)
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          
          if (!alerts || alerts.length === 0) {
            content.innerHTML = tabsHTML + `
              <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <p>No questions have been sent yet</p>
              </div>
            `;
            return;
          }
          
          // Group alerts by question text
          const groupedAlerts = {};
          alerts.forEach(alert => {
            const key = alert.question_text || 'Unknown Question';
            if (!groupedAlerts[key]) {
              groupedAlerts[key] = {
                question: alert.question_text,
                created_at: alert.created_at,
                alert_type: alert.alert_type,
                answer_option_1: alert.answer_option_1 || 'Yes',
                answer_option_2: alert.answer_option_2 || 'No',
                responses: []
              };
            }
            groupedAlerts[key].responses.push({
              student_name: alert.students?.name || 'Unknown',
              student_email: alert.students?.email || '',
              student_group: alert.students?.group_name || alert.students?.group || '',
              answer: alert.student_answer,
              answered_at: alert.answered_at
            });
          });
          
          // Render grouped responses
          let html = tabsHTML;
          Object.values(groupedAlerts).forEach(group => {
            const option1 = group.answer_option_1;
            const option2 = group.answer_option_2;
            const totalResponses = group.responses.filter(r => r.answer).length;
            const option1Count = group.responses.filter(r => r.answer === option1).length;
            const option2Count = group.responses.filter(r => r.answer === option2).length;
            const noResponseCount = group.responses.filter(r => !r.answer).length;
            
            // Get all student names for filtering
            const studentNames = group.responses.map(r => r.student_name.toLowerCase()).join('|');
            
            html += `
              <div class="card alert-card" data-student-names="${studentNames}" style="margin-bottom: 24px;">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div style="flex: 1;">
                    <div style="font-size: 18px; margin-bottom: 8px;">${group.question}</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.5);">
                      Sent: ${new Date(group.created_at).toLocaleString()}
                    </div>
                  </div>
                  <div style="display: flex; gap: 12px; align-items: center;">
                    <div class="badge" style="background: rgba(34,197,94,0.2); color: #22c55e; font-size: 14px; padding: 8px 16px;">
                      ‚úÖ ${option1Count} ${option1}
                    </div>
                    <div class="badge" style="background: rgba(239,68,68,0.2); color: #ef4444; font-size: 14px; padding: 8px 16px;">
                      ‚ùå ${option2Count} ${option2}
                    </div>
                    <div class="badge" style="background: rgba(148,163,184,0.2); color: #94a3b8; font-size: 14px; padding: 8px 16px;">
                      ‚è≥ ${noResponseCount} No Response
                    </div>
                  </div>
                </div>
                
                <div class="table-container" style="margin-top: 20px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Student</th>
                        <th>Group</th>
                        <th>Answer</th>
                        <th>Answered At</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${group.responses.map(response => `
                        <tr>
                          <td>
                            <div>${response.student_name}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5);">${response.student_email}</div>
                          </td>
                          <td>${response.student_group || 'N/A'}</td>
                          <td>
                            ${response.answer === option1 ? `<span class="badge" style="background: rgba(34,197,94,0.2); color: #22c55e;">‚úÖ ${option1}</span>` : 
                              response.answer === option2 ? `<span class="badge" style="background: rgba(239,68,68,0.2); color: #ef4444;">‚ùå ${option2}</span>` : 
                              '<span class="badge" style="background: rgba(148,163,184,0.2); color: #94a3b8;">‚è≥ No Response</span>'}
                          </td>
                          <td>${response.answered_at ? new Date(response.answered_at).toLocaleString() : '‚Äî'}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          });
          
          content.innerHTML = html;
        }
        
      } catch (error) {
        console.error('‚ùå Error loading responses:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          tab: tab
        });
        document.getElementById('responsesContent').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <p>Failed to load responses</p>
            <p style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px;">Error: ${error.message}</p>
            <p style="font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 4px;">Check browser console for details</p>
          </div>
        `;
      }
    }
    
    function closeResponsesModal() {
      document.getElementById('responsesModal').classList.remove('active');
    }
    
    // Filter alerts by student name
    function filterAlertsByStudent(searchTerm) {
      const cards = document.querySelectorAll('.alert-card');
      const lowerSearch = searchTerm.toLowerCase().trim();
      
      cards.forEach(card => {
        if (!lowerSearch) {
          // Show all if search is empty
          card.style.display = '';
        } else {
          // Check if any student name matches
          const studentNames = card.getAttribute('data-student-names');
          const matches = studentNames.includes(lowerSearch);
          card.style.display = matches ? '' : 'none';
        }
      });
    }
    
    // Filter alerts by read/unread status
    function filterAlertsByStatus(status) {
      const rows = document.querySelectorAll('.alert-student-row');
      
      // Update button styles
      document.querySelectorAll('.alert-filter-btn').forEach(btn => {
        btn.style.background = 'rgba(255,255,255,0.05)';
        btn.style.borderColor = 'rgba(255,255,255,0.1)';
      });
      
      const activeBtn = status === 'all' ? document.getElementById('filterAllBtn') :
                        status === 'read' ? document.getElementById('filterReadBtn') :
                        document.getElementById('filterUnreadBtn');
      
      if (activeBtn) {
        activeBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        activeBtn.style.borderColor = 'rgba(102,126,234,0.5)';
      }
      
      // Filter rows
      rows.forEach(row => {
        if (status === 'all') {
          row.style.display = '';
        } else {
          const rowStatus = row.getAttribute('data-read-status');
          row.style.display = rowStatus === status ? '' : 'none';
        }
      });
      
      // Update badge counts for each alert card
      document.querySelectorAll('.alert-card').forEach(card => {
        const visibleRows = card.querySelectorAll('.alert-student-row[style*="display: ;"], .alert-student-row:not([style*="display: none"])');
        // If no students are visible in this card, hide the entire card
        card.style.display = visibleRows.length > 0 ? '' : 'none';
      });
    }
  </script>

  <!-- Fullscreen Impersonation Modal -->
  <div id="impersonationModal" class="impersonation-modal">
    <div class="impersonation-header">
      <div class="impersonation-title">
        <span class="emoji">üëÅÔ∏è</span>
        <span id="impersonationStudentName">Viewing as Student</span>
      </div>
      <button class="impersonation-close" onclick="closeImpersonation()">√ó</button>
    </div>
    <iframe id="impersonationIframe" class="impersonation-iframe" title="Student Portal View"></iframe>
  </div>

  <!-- Alert Modal -->
  <div id="alertModal" class="alert-modal">
    <div class="alert-modal-content">
      <div class="alert-modal-header">
        <div class="alert-modal-title">
          <span>üîî</span>
          <span>Create Student Alert</span>
        </div>
        <div style="display: flex; gap: 12px; align-items: center;">
          <button type="button" class="back-btn" onclick="openTemplateModal()" style="margin: 0;">
            üìã Templates
          </button>
          <button type="button" class="back-btn" onclick="viewAlertResponses()" style="margin: 0;">
            üìä View Responses
          </button>
          <button class="close-modal" onclick="closeAlertModal()">√ó</button>
        </div>
      </div>
      
      <form id="alertForm" onsubmit="saveAlert(event)">
        <div class="form-group">
          <label class="form-label">Alert Message</label>
          <textarea 
            id="alertMessage" 
            class="form-textarea" 
            placeholder="Type your message... Use { to see available variables"
            required
            rows="5"
            oninput="showVariableSuggestions(this)"
          ></textarea>
          <div id="variableSuggestions" style="display: none; margin-top: 8px; padding: 12px; background: rgba(102,126,234,0.1); border-radius: 8px; border: 1px solid rgba(102,126,234,0.3);">
            <div style="font-size: 12px; font-weight: 600; color: #a5b4fc; margin-bottom: 8px;">Available Variables:</div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <code class="variable-tag" onclick="insertVariable('{student_name}')" style="cursor: pointer; padding: 4px 8px; background: rgba(102,126,234,0.2); border-radius: 4px; font-size: 11px; color: white;">{student_name}</code>
              <code class="variable-tag" onclick="insertVariable('{group}')" style="cursor: pointer; padding: 4px 8px; background: rgba(102,126,234,0.2); border-radius: 4px; font-size: 11px; color: white;">{group}</code>
              <code class="variable-tag" onclick="insertVariable('{email}')" style="cursor: pointer; padding: 4px 8px; background: rgba(102,126,234,0.2); border-radius: 4px; font-size: 11px; color: white;">{email}</code>
            </div>
          </div>
        </div>

        <div class="student-selector">
          <label class="student-selector-label">Select Students to Alert</label>
          
          <!-- Group Selector -->
          <div style="background: rgba(147,51,234,0.1); padding: 14px; border-radius: 12px; border: 1px solid rgba(147,51,234,0.3); margin-bottom: 14px; backdrop-filter: blur(8px);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
              <span style="font-size: 16px;">üìö</span>
              <span style="font-weight: 600; font-size: 14px; color: rgba(255,255,255,0.95);">Quick Select by Group</span>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <button type="button" class="group-select-btn" id="groupBtn-A" onclick="toggleGroup('A')" style="padding: 10px 18px; background: rgba(147,51,234,0.25); border: 1px solid rgba(147,51,234,0.4); border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
                A
              </button>
              <button type="button" class="group-select-btn" id="groupBtn-B" onclick="toggleGroup('B')" style="padding: 10px 18px; background: rgba(147,51,234,0.25); border: 1px solid rgba(147,51,234,0.4); border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
                B
              </button>
              <button type="button" class="group-select-btn" id="groupBtn-C" onclick="toggleGroup('C')" style="padding: 10px 18px; background: rgba(147,51,234,0.25); border: 1px solid rgba(147,51,234,0.4); border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
                C
              </button>
              <button type="button" class="group-select-btn" id="groupBtn-D" onclick="toggleGroup('D')" style="padding: 10px 18px; background: rgba(147,51,234,0.25); border: 1px solid rgba(147,51,234,0.4); border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
                D
              </button>
              <button type="button" class="group-select-btn" id="groupBtn-E" onclick="toggleGroup('E')" style="padding: 10px 18px; background: rgba(147,51,234,0.25); border: 1px solid rgba(147,51,234,0.4); border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
                E
              </button>
              <button type="button" class="group-select-btn" id="groupBtn-F" onclick="toggleGroup('F')" style="padding: 10px 18px; background: rgba(147,51,234,0.25); border: 1px solid rgba(147,51,234,0.4); border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
                F
              </button>
            </div>
            <div style="margin-top: 10px; font-size: 11px; color: rgba(255,255,255,0.6);">
              Click a letter to toggle group selection (click again to deselect)
            </div>
          </div>
          
          <input 
            type="text" 
            id="alertStudentSearch" 
            class="form-input" 
            placeholder="üîç Search students by name, email, or group..."
            oninput="debouncedFilterStudentList()"
            style="margin-bottom: 12px;"
          />
          <button type="button" class="select-all-btn" onclick="toggleSelectAll()">
            Select All / Deselect All
          </button>
          <div id="studentCheckboxGroup" class="student-checkbox-group">
            <!-- Students will be populated here -->
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Alert Type</label>
          <select id="alertType" class="form-select">
            <option value="info">‚ÑπÔ∏è Info</option>
            <option value="warning">‚ö†Ô∏è Warning</option>
            <option value="urgent">üö® Urgent</option>
            <option value="success">‚úÖ Success</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Schedule Alert (Optional)</label>
          <input 
            type="datetime-local" 
            id="alertSchedule" 
            class="form-input"
          />
          <div style="margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.6);">
            Leave empty to show alert immediately
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Expiration (Optional)</label>
          <input 
            type="datetime-local" 
            id="alertExpiration" 
            class="form-input"
          />
          <div style="margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.6);">
            Leave empty for alerts that don't expire
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" style="display: flex; align-items: center; gap: 10px;">
            <input 
              type="checkbox" 
              id="isOneTime" 
              style="width: 18px; height: 18px; cursor: pointer;"
            />
            <span>One-time only (hide after student views it once)</span>
          </label>
        </div>

        <div class="form-group">
          <label class="form-label" style="display: flex; align-items: center; gap: 10px;">
            <input 
              type="checkbox" 
              id="showOnOpen" 
              style="width: 18px; height: 18px; cursor: pointer;"
            />
            <span>Show on open (display immediately when student logs in or refreshes)</span>
          </label>
        </div>

        <div class="form-group">
          <label class="form-label" style="display: flex; align-items: center; gap: 10px;">
            <input 
              type="checkbox" 
              id="limitRepeats" 
              onchange="toggleRepeatLimit()"
              style="width: 18px; height: 18px; cursor: pointer;"
            />
            <span>Limit how many times this alert appears</span>
          </label>
          <div id="repeatLimitContainer" style="display: none; margin-left: 28px; margin-top: 12px;">
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
              <input 
                type="number" 
                id="repeatCount" 
                class="form-input" 
                min="1"
                max="20"
                value="1"
                style="max-width: 130px;"
                oninput="updateRepeatCountPreview(this.value)"
              />
              <span style="font-size: 12px; color: rgba(255,255,255,0.75);">
                Students will see this alert up to <strong id="repeatCountPreview">1</strong> time(s)
              </span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" style="display: flex; align-items: center; gap: 10px;">
            <input 
              type="checkbox" 
              id="hasQuestion" 
              onchange="toggleQuestionField()"
              style="width: 18px; height: 18px; cursor: pointer;"
            />
            <span>Add Question with Custom Answers</span>
          </label>
        </div>

        <div id="questionFieldContainer" class="form-group" style="display: none;">
          <label class="form-label">Question for Students</label>
          <textarea 
            id="questionText" 
            class="form-textarea" 
            placeholder="Enter a question for students to answer (e.g., 'Will you attend the makeup class on Saturday?')"
            rows="3"
          ></textarea>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <div>
              <label class="form-label" style="font-size: 12px;">Option 1</label>
              <input 
                type="text" 
                id="answerOption1" 
                class="form-input" 
                placeholder="e.g., Yes, I will, I do"
                value="Yes"
              />
            </div>
            <div>
              <label class="form-label" style="font-size: 12px;">Option 2</label>
              <input 
                type="text" 
                id="answerOption2" 
                class="form-input" 
                placeholder="e.g., No, I won't, I don't"
                value="No"
              />
            </div>
          </div>
          
          <div style="margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.6);">
            Students will see two buttons with your custom answer options
          </div>
        </div>

        <button type="submit" class="submit-btn">
          Create Alert
        </button>
      </form>
    </div>
  </div>

  <!-- Alert Responses Modal -->
  <div id="responsesModal" class="alert-modal">
    <div class="alert-modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
      <div class="alert-modal-header">
        <div class="alert-modal-title">
          <span>üìä</span>
          <span>Student Alert Responses & History</span>
        </div>
        <button class="close-modal" onclick="closeResponsesModal()">√ó</button>
      </div>
      
      <div id="responsesContent" style="padding: 24px;">
        <div class="loading">Loading responses...</div>
      </div>
    </div>
  </div>

  <!-- Alert Template Modal -->
  <div id="templateModal" class="alert-modal">
    <div class="alert-modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
      <div class="alert-modal-header">
        <div class="alert-modal-title">
          <span>üìã</span>
          <span>Alert Templates</span>
        </div>
        <div style="display: flex; gap: 12px; align-items: center;">
          <button type="button" class="back-btn" onclick="showCreateTemplate()" style="margin: 0;">
            ‚ûï New Template
          </button>
          <button class="close-modal" onclick="closeTemplateModal()">√ó</button>
        </div>
      </div>
      
      <div id="templateContent" style="padding: 24px;">
        <div class="loading">Loading templates...</div>
      </div>
    </div>
  </div>

  <script>
    // ===== ALERT TEMPLATE MANAGEMENT =====
    const TEMPLATES_STORAGE_KEY = 'arnoma-alert-templates-v1';

    function loadTemplatesFromStorage() {
      const stored = localStorage.getItem(TEMPLATES_STORAGE_KEY);
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          if (Array.isArray(parsed)) {
            return parsed.map(template => {
              const repeatCount = parseInt(template.repeatCount ?? '1', 10);
              return {
                ...template,
                limitRepeats: Boolean(template.limitRepeats),
                repeatCount: Number.isFinite(repeatCount) && repeatCount > 0 ? repeatCount : 1
              };
            });
          }
          return getDefaultTemplates();
        } catch (e) {
          console.error('Error parsing templates:', e);
          return getDefaultTemplates();
        }
      }
      return getDefaultTemplates();
    }

    function saveTemplatesToStorage(templates) {
      localStorage.setItem(TEMPLATES_STORAGE_KEY, JSON.stringify(templates));
    }

    function getDefaultTemplates() {
      return [
        {
          id: 'makeup-class',
          name: 'Makeup Class Notification',
          message: 'Hi {student_name},\n\nWe have a makeup class scheduled for [DATE] at [TIME].\n\nPlease confirm your attendance.\n\nThank you!',
          type: 'info',
          hasQuestion: true,
          questionText: 'Will you attend the makeup class?',
          answerOption1: 'Yes, I will attend',
          answerOption2: 'No, I cannot attend',
          showOnOpen: true,
          limitRepeats: false,
          repeatCount: 1
        },
        {
          id: 'payment-reminder',
          name: 'Payment Reminder',
          message: 'Dear {student_name},\n\nThis is a friendly reminder about your outstanding balance.\n\nPlease submit your payment at your earliest convenience.\n\nThank you!',
          type: 'warning',
          hasQuestion: false,
          showOnOpen: false,
          limitRepeats: false,
          repeatCount: 1
        },
        {
          id: 'test-announcement',
          name: 'Test Announcement',
          message: 'Hi {student_name},\n\nWe have an upcoming test on [DATE].\n\nTopic: [TOPIC]\nDuration: [DURATION]\n\nPlease prepare accordingly.\n\nGood luck!',
          type: 'info',
          hasQuestion: false,
          showOnOpen: true,
          limitRepeats: false,
          repeatCount: 1
        },
        {
          id: 'urgent-update',
          name: 'Urgent Update',
          message: 'URGENT: {student_name},\n\n[YOUR URGENT MESSAGE HERE]\n\nPlease respond immediately if you have any questions.',
          type: 'urgent',
          hasQuestion: false,
          showOnOpen: true,
          limitRepeats: false,
          repeatCount: 1
        }
      ];
    }

    function openTemplateModal() {
      const modal = document.getElementById('templateModal');
      const content = document.getElementById('templateContent');
      
      modal.classList.add('active');
      renderTemplates();
    }

    function closeTemplateModal() {
      document.getElementById('templateModal').classList.remove('active');
    }

    function renderTemplates() {
      const templates = loadTemplatesFromStorage();
      const content = document.getElementById('templateContent');
      
      if (templates.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No templates yet</p>
            <button onclick="showCreateTemplate()" class="add-btn" style="margin-top: 16px;">
              ‚ûï Create Your First Template
            </button>
          </div>
        `;
        return;
      }

      let html = `
        <div style="display: grid; gap: 16px;">
          ${templates.map(template => `
            <div class="card" style="padding: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div style="flex: 1;">
                  <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 8px; color: rgba(255,255,255,0.95);">${template.name}</h3>
                  <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <span class="badge" style="background: ${template.type === 'urgent' ? 'rgba(239,68,68,0.2)' : template.type === 'warning' ? 'rgba(245,158,11,0.2)' : 'rgba(59,130,246,0.2)'}; color: ${template.type === 'urgent' ? '#fca5a5' : template.type === 'warning' ? '#fbbf24' : '#93c5fd'};">
                      ${template.type === 'urgent' ? 'üö®' : template.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} ${template.type}
                    </span>
                    ${template.hasQuestion ? '<span class="badge" style="background: rgba(147,51,234,0.2); color: #c084fc;">‚ùì Has Question</span>' : ''}
                    ${template.showOnOpen ? '<span class="badge" style="background: rgba(34,197,94,0.2); color: #86efac;">üëÅÔ∏è Show on Open</span>' : ''}
                    ${template.limitRepeats ? `<span class="badge" style="background: rgba(59,130,246,0.15); color: #93c5fd;">üîÅ Up to ${template.repeatCount || 1}√ó</span>` : ''}
                  </div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button onclick="useTemplate('${template.id}')" class="action-btn view" title="Use Template">
                    ‚úÖ Use
                  </button>
                  <button onclick="editTemplate('${template.id}')" class="action-btn edit" title="Edit Template">
                    ‚úèÔ∏è
                  </button>
                  ${!template.id.startsWith('default-') ? `
                    <button onclick="deleteTemplate('${template.id}')" class="action-btn delete" title="Delete Template">
                      üóëÔ∏è
                    </button>
                  ` : ''}
                </div>
              </div>
              
              <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; font-size: 14px; line-height: 1.6; color: rgba(255,255,255,0.8); white-space: pre-wrap;">${template.message}</div>
              
              ${template.hasQuestion ? `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                  <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.7); margin-bottom: 8px;">Question: ${template.questionText}</div>
                  <div style="display: flex; gap: 8px;">
                    <span class="badge" style="background: rgba(34,197,94,0.2); color: #86efac;">‚úÖ ${template.answerOption1}</span>
                    <span class="badge" style="background: rgba(239,68,68,0.2); color: #fca5a5;">‚ùå ${template.answerOption2}</span>
                  </div>
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      `;
      
      content.innerHTML = html;
    }

    function useTemplate(templateId) {
      const templates = loadTemplatesFromStorage();
      const template = templates.find(t => t.id === templateId);
      
      if (!template) {
        customAlert('Error', 'Template not found');
        return;
      }

      // Fill the alert form with template data
      document.getElementById('alertMessage').value = template.message;
      document.getElementById('alertType').value = template.type;
      document.getElementById('showOnOpen').checked = template.showOnOpen;
      document.getElementById('hasQuestion').checked = template.hasQuestion;
      const limitRepeatsCheckbox = document.getElementById('limitRepeats');
      const repeatCountInput = document.getElementById('repeatCount');
      if (limitRepeatsCheckbox && repeatCountInput) {
        limitRepeatsCheckbox.checked = Boolean(template.limitRepeats);
        repeatCountInput.value = template.repeatCount || 1;
        toggleRepeatLimit();
      }
      
      if (template.hasQuestion) {
        document.getElementById('questionFieldContainer').style.display = 'block';
        document.getElementById('questionText').value = template.questionText || '';
        document.getElementById('answerOption1').value = template.answerOption1 || 'Yes';
        document.getElementById('answerOption2').value = template.answerOption2 || 'No';
      }

      closeTemplateModal();
      customAlert('Success', `Template "${template.name}" loaded into alert form`);
    }

    async function showCreateTemplate() {
      const name = await customPrompt('Template Name', 'Enter a name for your template');
      if (!name) return;

      const message = await customPrompt('Template Message', 'Enter message (use {student_name}, {group}, {email} for variables)');
      if (!message) return;

      const templates = loadTemplatesFromStorage();
      const newTemplate = {
        id: 'custom-' + Date.now(),
        name: name,
        message: message,
        type: 'info',
        hasQuestion: false,
        showOnOpen: false,
        limitRepeats: false,
        repeatCount: 1
      };

      templates.push(newTemplate);
      saveTemplatesToStorage(templates);
      renderTemplates();
      await customAlert('Success', 'Template created successfully!');
    }

    async function editTemplate(templateId) {
      const templates = loadTemplatesFromStorage();
      const template = templates.find(t => t.id === templateId);
      
      if (!template) {
        await customAlert('Error', 'Template not found');
        return;
      }

      const newName = await customPrompt('Template Name', 'Enter new name', template.name);
      if (newName === null || newName === '') return;

      const newMessage = await customPrompt('Template Message', 'Enter new message', template.message);
      if (newMessage === null || newMessage === '') return;

      template.name = newName;
      template.message = newMessage;
      
      saveTemplatesToStorage(templates);
      renderTemplates();
      await customAlert('Success', 'Template updated successfully!');
    }

    async function deleteTemplate(templateId) {
      const confirmed = await customConfirm('Delete Template', 'Are you sure you want to delete this template?');
      if (!confirmed) return;

      const templates = loadTemplatesFromStorage();
      const filtered = templates.filter(t => t.id !== templateId);
      
      saveTemplatesToStorage(filtered);
      renderTemplates();
      await customAlert('Success', 'Template deleted successfully!');
    }
  </script>

</body>
</html>

