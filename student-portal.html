<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ============================================================================
       STUDENT PORTAL - ARNOMA NURSING ACADEMY
       ============================================================================
       Purpose: Main student dashboard with schedule, payments, notes, and progress
       Auth: Supports both regular student login and admin impersonation mode
       Data: Direct Supabase integration (self-contained, no bundler)
       ============================================================================ -->
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Portal - ARNOMA</title>
  <link rel="icon" type="image/png" href="/richyfesta-logo.png">
  <link rel="apple-touch-icon" href="/richyfesta-logo.png">
  
  <!-- Cache Control -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Google API -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <style>
    /* ==========================================================================
       CSS VARIABLES - Design System
       ========================================================================== */
    :root {
      --bg-base: #020510;
      --bg-gradient-start: #030a1f;
      --bg-gradient-end: #050d2c;
      --panel-light: rgba(37, 56, 117, 0.85);
      --panel-dark: rgba(16, 24, 47, 0.92);
      --glass-border: rgba(125, 211, 252, 0.35);
      --accent-primary: #7dd3fc;
      --accent-secondary: #c084fc;
      --accent-tertiary: #f9a8d4;
      --glow-blue: rgba(125, 211, 252, 0.65);
      --glow-purple: rgba(192, 132, 252, 0.6);
      --text-strong: #f8fbff;
      --text-muted: rgba(255, 255, 255, 0.7);
      --card-shadow: 0 30px 120px rgba(3, 6, 19, 0.65);
      --panel-blur: 8px;
      --modal-blur: 14px;
      --list-blur: 0px;
    }

    /* ==========================================================================
       PERFORMANCE: DISABLE INFINITE ANIMATIONS ONLY
       ========================================================================== */
    /* Disable infinite animations and heavy effects that kill performance */
    *, *::before, *::after {
      animation: none !important;
      animation-duration: 0s !important;
      animation-delay: 0s !important;
    }
    
    /* SELECTIVELY RE-ENABLE smooth transitions for interactive elements */
    button,
    .card,
    .system-card,
    .game-card,
    .stat-card,
    .classroom-item,
    .announcement-item,
    .carousel-nav,
    a,
    input,
    textarea,
    select,
    .note-card,
    .forum-message,
    .modal {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
    /* Faster transitions for small elements */
    .system-icon,
    .game-icon,
    .stat-icon,
    .notification-badge {
      transition: transform 0.2s ease, opacity 0.2s ease !important;
    }
    
    /* Ultra-smooth carousel scrolling */
    .systems-carousel {
      scroll-behavior: smooth !important;
    }

    /* ==========================================================================
       ANIMATIONS - Keyframe Definitions (DISABLED)
       ========================================================================== */
    @keyframes auroraDrift {
      0% { transform: translate3d(-10%, -10%, 0) scale(1); }
      50% { transform: translate3d(10%, 15%, 0) scale(1.1); }
      100% { transform: translate3d(-10%, -10%, 0) scale(1); }
    }

    @keyframes orbFloat {
      0% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-25px) scale(1.05); }
      100% { transform: translateY(0) scale(1); }
    }

    @keyframes pulseGlow {
      0%, 100% { opacity: 0.35; }
      50% { opacity: 0.85; }
    }

    @keyframes shimmerLine {
      0% { transform: translateX(-100%); opacity: 0; }
      45% { opacity: 0.8; }
      100% { transform: translateX(200%); opacity: 0; }
    }

    @keyframes grainShift {
      0% { transform: translate3d(0,0,0); }
      100% { transform: translate3d(-10%, -15%, 0); }
    }

    /* ==========================================================================
       GLOBAL RESET & BASE STYLES
       ========================================================================== */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      min-height: 100vh;
      padding: 0; /* FIXED: Remove padding for full-width layout */
      position: relative;
      overflow-x: hidden; /* FIXED: Prevent horizontal scroll */
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 50%, rgba(102,126,234,0.08) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(118,75,162,0.08) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    /* ==========================================================================
       LAYOUT COMPONENTS
       ========================================================================== */
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
      padding: 20px; /* FIXED: Move padding from body to container */
    }

    .section-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }

    .section-tab {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(15, 23, 42, 0.55);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
    }

    .section-tab.active {
      background: linear-gradient(120deg, rgba(125,211,252,0.2), rgba(192,132,252,0.2));
      border-color: rgba(125,211,252,0.5);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.35);
    }

    .section-panel {
      display: none;
    }

    .section-panel.active {
      display: block;
    }
    
    .header {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      border: 1px solid rgba(255,255,255,0.12);
      padding: 32px 40px;
      border-radius: 24px;
      box-shadow: 0 25px 60px rgba(13, 16, 35, 0.7), 
                  inset 0 1px 0 rgba(255,255,255,0.05);
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 24px;
      animation: slideInLeft 0.6s ease-out;
      position: relative;
      overflow: visible;
      z-index: 1000;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmer 3s infinite;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }
    
    .logo {
      width: 150px;
      height: 150px;
      filter: brightness(1.4) drop-shadow(0 0 30px rgba(102,126,234,1)) drop-shadow(0 0 50px rgba(150,170,255,0.8));
      animation: float 3s ease-in-out infinite;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .logo::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 60%);
      border-radius: 50%;
      pointer-events: none;
    }
    
    .logo:hover {
      filter: brightness(1.5) drop-shadow(0 0 35px rgba(102,126,234,1)) drop-shadow(0 0 60px rgba(150,170,255,0.9));
      transform: scale(1.05);
    }
    
    .header-title h1 {
      font-size: 42px;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
      line-height: 1.3;
      text-shadow: 0 2px 20px rgba(0,0,0,0.2);
      display: flex !important;
      flex-direction: column !important;
      gap: 8px;
      align-items: flex-start;
    }
    
    .header-title h1 .title-line {
      font-size: 28px !important;
      font-weight: 600;
      display: block;
    }
    
    .header-title h1 .name-line {
      font-size: 42px !important;
      font-weight: 700;
      display: block;
    }
    
    .logout-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(239,68,68,0.2);
      display: none;
    }
    
    .logout-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    .logout-btn:hover::before {
      left: 100%;
    }
    
    .logout-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 20px rgba(239,68,68,0.4);
    }
    
    .logout-btn:active {
      transform: translateY(-1px) scale(0.95);
    }
    
    /* Account Dropdown */
    .account-dropdown {
      position: relative;
      z-index: 10000;
    }
    
    .account-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, rgba(102,126,234,0.18), rgba(118,75,162,0.18));
      color: white;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .account-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102,126,234,0.25);
      background: linear-gradient(135deg, rgba(102,126,234,0.25), rgba(118,75,162,0.25));
      border-color: rgba(102,126,234,0.3);
    }
    
    .dropdown-arrow {
      font-size: 10px;
      transition: transform 0.3s ease;
    }
    
    .account-dropdown.open .dropdown-arrow {
      transform: rotate(180deg);
    }
    
    .account-menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      box-shadow: 0 25px 60px rgba(13, 16, 35, 0.7), inset 0 1px 0 rgba(255,255,255,0.05);
      min-width: 180px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 9999;
    }
    
    .account-dropdown.open .account-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .account-menu-item {
      width: 100%;
      padding: 14px 18px;
      background: transparent;
      border: none;
      color: white;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      text-align: left;
    }
    
    .account-menu-item:first-child {
      border-radius: 12px 12px 0 0;
    }
    
    .account-menu-item:last-child {
      border-radius: 0 0 12px 12px;
    }
    
    .account-menu-item:hover {
      background: rgba(239,68,68,0.15);
      padding-left: 22px;
    }
    
    /* Account Profile Section in Dropdown */
    .account-profile-section {
      padding: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    .account-profile-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    
    .profile-icon {
      font-size: 24px;
    }
    
    .profile-name {
      font-size: 15px;
      font-weight: 600;
      color: white;
    }
    
    .account-profile-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .account-info-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      font-size: 13px;
    }
    
    .account-info-label {
      color: rgba(255,255,255,0.6);
      font-weight: 500;
      min-width: 65px;
    }
    
    .account-info-value {
      color: rgba(255,255,255,0.95);
      font-weight: 500;
      text-align: right;
      flex: 1;
      word-break: break-word;
    }
    
    /* Header Actions Container */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    /* Forum Button */
    .forum-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, rgba(59,130,246,0.18), rgba(37,99,235,0.18));
      color: white;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      position: relative;
    }
    
    .forum-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59,130,246,0.3);
      background: linear-gradient(135deg, rgba(59,130,246,0.25), rgba(37,99,235,0.25));
      border-color: rgba(59,130,246,0.3);
    }
    
    .forum-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 7px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(239,68,68,0.4);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    /* Forum Modal */
    .forum-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    
    .forum-modal.active {
      display: flex;
    }
    
    .forum-container {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 24px;
      box-shadow: 0 25px 60px rgba(13, 16, 35, 0.7);
      width: 100%;
      max-width: 900px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .forum-header {
      padding: 24px 30px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .forum-header h2 {
      color: white;
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .close-forum-btn {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-forum-btn:hover {
      background: rgba(239,68,68,0.25);
      transform: rotate(90deg);
    }
    
    /* ==========================================================================
       MODAL COMPONENTS
       ========================================================================== */
    
    /* Game Modal */
    
    /* Profile Modal */
    .profile-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    
    .profile-modal.active {
      display: flex;
    }
    
    .profile-modal-container {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      border: 1px solid rgba(102,126,234,0.3);
      border-radius: 24px;
      box-shadow: 0 25px 80px rgba(13, 16, 35, 0.9),
                  0 0 60px rgba(102,126,234,0.2);
      width: 90vw;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }
    
    .profile-modal-header {
      padding: 24px 32px;
      border-bottom: 1px solid rgba(102,126,234,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.05));
    }
    
    .profile-modal-header h2 {
      color: white;
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
    }
    
    .close-profile-btn {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 24px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-profile-btn:hover {
      background: rgba(239,68,68,0.25);
      transform: rotate(90deg) scale(1.1);
    }
    
    .profile-modal-content {
      padding: 32px;
      overflow-y: auto;
      max-height: 70vh;
    }
    
    .profile-modal-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .profile-modal-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      padding: 16px 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      transition: all 0.2s ease;
    }
    
    .profile-modal-row:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(102,126,234,0.3);
    }
    
    .profile-modal-label {
      color: rgba(255,255,255,0.65);
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      min-width: 140px;
    }
    
    .profile-modal-value {
      color: rgba(255,255,255,0.95);
      font-weight: 500;
      font-size: 15px;
      text-align: right;
      flex: 1;
      word-break: break-word;
    }
    
    .game-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    
    .game-modal.active {
      display: flex;
    }
    
    .game-modal-container {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      border: 1px solid rgba(147,51,234,0.3);
      border-radius: 24px;
      box-shadow: 0 25px 80px rgba(13, 16, 35, 0.9),
                  0 0 60px rgba(147,51,234,0.3);
      width: 95vw;
      height: 90vh;
      max-width: 1400px;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }
    
    .game-modal-header {
      padding: 20px 30px;
      border-bottom: 1px solid rgba(147,51,234,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, rgba(147,51,234,0.1), rgba(168,85,247,0.05));
    }
    
    .game-modal-header h2 {
      color: white;
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
    }
    
    .close-game-btn {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 24px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-game-btn:hover {
      background: rgba(239,68,68,0.25);
      transform: rotate(90deg) scale(1.1);
    }
    
    .game-modal-content {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    .game-modal-content iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }
    
    .forum-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 30px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .forum-message {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.7), rgba(30, 41, 80, 0.6));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 20px;
      animation: slideInLeft 0.4s ease backwards;
      position: relative; /* For absolute positioned pin icon */
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .message-author {
      color: #60a5fa;
      font-weight: 600;
      font-size: 14px;
    }
    
    .message-time {
      color: rgba(255,255,255,0.5);
      font-size: 12px;
    }
    
    .message-text {
      color: rgba(255,255,255,0.9);
      line-height: 1.6;
      font-size: 14px;
      margin-bottom: 12px;
    }
    
    .message-replies {
      margin-top: 16px;
      padding-left: 20px;
      border-left: 2px solid rgba(96,165,250,0.3);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .message-reply {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      padding: 12px;
    }
    
    .reply-btn {
      background: transparent;
      border: 1px solid rgba(96,165,250,0.3);
      color: #60a5fa;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .reply-btn:hover {
      background: rgba(96,165,250,0.1);
      border-color: #60a5fa;
    }
    
    .delete-message-btn {
      background: transparent;
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      line-height: 1;
    }
    
    .delete-message-btn:hover {
      background: rgba(239, 68, 68, 0.15);
      border-color: #ef4444;
      transform: scale(1.05);
    }
    
    .reply-input-container {
      display: none;
      margin-top: 12px;
      gap: 8px;
    }
    
    .reply-input-container.active {
      display: flex;
    }
    
    .reply-input {
      flex: 1;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(255,255,255,0.12);
      color: white;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .reply-input:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96,165,250,0.1);
    }
    
    .send-reply-btn {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border: none;
      color: white;
      padding: 10px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .send-reply-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59,130,246,0.3);
    }
    
    .forum-input-area {
      padding: 20px 30px;
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      gap: 12px;
    }
    
    .forum-input {
      flex: 1;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.7), rgba(30, 41, 80, 0.6));
      border: 1px solid rgba(255,255,255,0.12);
      color: white;
      padding: 14px 18px;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.2s ease;
      resize: none;
      font-family: inherit;
    }
    
    .forum-input:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96,165,250,0.1);
    }
    
    .forum-input::placeholder {
      color: rgba(255,255,255,0.4);
    }
    
    .send-message-btn {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border: none;
      color: white;
      padding: 14px 28px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(59,130,246,0.3);
    }
    
    .send-message-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59,130,246,0.4);
    }
    
    .send-message-btn:active {
      transform: translateY(0);
    }
    
    .content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    
    .full-width-card {
      grid-column: 1 / -1;
    }
    
    .classroom-item {
      padding: 24px;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.7), rgba(30, 41, 80, 0.6));
      backdrop-filter: blur(var(--list-blur));
      -webkit-backdrop-filter: blur(var(--list-blur));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      border-left: 3px solid #4285f4;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 16px;
      animation: slideInLeft 0.5s ease-out backwards;
      position: relative;
      overflow: hidden;
      will-change: transform;
      display: flex;
      flex-direction: column;
      min-height: 220px;
    }
    
    /* Remove the circle hover effect */
    .classroom-item::after {
      display: none;
    }
    
    .classroom-item:hover {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.85), rgba(30, 41, 80, 0.75));
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(102,126,234,0.2);
      border-color: rgba(102,126,234,0.3);
    }
    
    /* Fixed content area with scrolling if needed */
    .note-content-area {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* Fixed footer area - always at bottom */
    .note-footer-area {
      margin-top: auto;
      padding-top: 4px;
    }
    
    /* Fixed badge position - centered */
    .note-badge-container {
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
    }
    
    /* Collapsed state - fixed height */
    .classroom-item.note-collapsed {
      min-height: 220px;
      max-height: 220px;
    }
    
    /* Expanded state - allow growth */
    .classroom-item.note-expanded {
      min-height: 220px;
      max-height: none;
    }
    
    /* Expand indicator animation */
    .note-expand-indicator {
      transition: all 0.3s ease;
      cursor: pointer;
      user-select: none;
    }
    
    .classroom-item:hover .note-expand-indicator {
      color: rgba(102,126,234,0.8);
    }
    
    .classroom-item.announcement {
      border-left-color: #fbbc04;
    }
    
    .classroom-item.material {
      border-left-color: #34a853;
    }
    
    .classroom-item.locked {
      border-left-color: #ef4444;
      border: 2px solid rgba(239,68,68,0.4);
      background: linear-gradient(135deg, rgba(239,68,68,0.05), rgba(239,68,68,0.02));
      position: relative;
    }
    
    .classroom-item.locked:hover {
      border-color: rgba(239,68,68,0.6);
      transform: scale(1.01);
    }

    .locked-attachment-card {
      position: relative;
      cursor: not-allowed;
      transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease, background 0.25s ease;
      isolation: isolate;
      overflow: visible !important;
    }

    .locked-attachment-card::after {
      content: 'Please make your payment to see the notes';
      position: absolute;
      left: 50%;
      bottom: -56px;
      transform: translate(-50%, 10px);
      background: rgba(239,68,68,0.95);
      color: white;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
      box-shadow: 0 12px 30px rgba(239,68,68,0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      max-width: 240px;
      text-align: center;
      white-space: normal;
      line-height: 1.3;
      z-index: 5;
    }

    .locked-attachment-card:hover {
      background: linear-gradient(145deg, rgba(239,68,68,0.25), rgba(239,68,68,0.08)) !important;
      border-color: rgba(239,68,68,0.6) !important;
      box-shadow: 0 12px 28px rgba(239,68,68,0.45);
      transform: translateY(-4px);
    }

    .locked-attachment-card:hover::after {
      opacity: 1;
      transform: translate(-50%, -6px);
    }
    
    .classroom-text.blurred {
      filter: blur(12px);
      user-select: none;
      pointer-events: none;
      opacity: 0.4;
    }
    
    .classroom-badge.locked {
      background: rgba(148,163,184,0.2);
      color: #94a3b8;
    }
    
    .classroom-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    
    .classroom-title {
      font-weight: 700;
      color: #ffffff;
      font-size: 16px;
      margin-bottom: 5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .classroom-course {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      font-weight: 600;
    }
    
    .classroom-date {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      white-space: nowrap;
    }
    
    .classroom-text {
      color: rgba(255,255,255,0.9);
      font-size: 14px;
      line-height: 1.5;
      margin-top: 10px;
    }
    
    .classroom-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 10px;
    }
    
    .classroom-badge.announcement {
      background: rgba(251,188,4,0.2);
      color: #fbbc04;
    }
    
    .classroom-badge.material {
      background: rgba(52,168,83,0.2);
      color: #34a853;
    }
    
    .classroom-list {
      max-height: 560px;
      overflow-y: auto;
      padding: 4px;
    }
    
    /* Notes Grid System */
    .notes-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      padding: 0 4px;
    }
    
    .notes-system-container {
      margin-bottom: 32px;
      animation: fadeIn 0.4s ease;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Responsive: 2 columns on tablets */
    @media (max-width: 1200px) {
      .notes-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Responsive: 1 column on mobile */
    @media (max-width: 768px) {
      .notes-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .classroom-list::-webkit-scrollbar {
      width: 8px;
    }
    
    .classroom-list::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }
    
    .classroom-list::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
    
    .classroom-list::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }
    
    /* Systems Progress Carousel */
    .systems-carousel-container {
      position: relative;
      padding: 24px 56px;
      margin: 24px 0;
      /* FIX: Establish stacking context for z-index */
      z-index: 1;
      isolation: isolate;
    }
    
    .systems-carousel {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding: 16px 8px; /* Add horizontal padding for hover lift */
      scrollbar-width: none;
      -ms-overflow-style: none;
      /* FIX: Allow cards to lift above carousel */
      transform-style: preserve-3d;
    }
    
    .systems-carousel::-webkit-scrollbar {
      display: none;
    }
    
    .system-card {
      --glass-bg: rgba(15, 23, 42, 0.7);
      min-width: 220px;
      height: 280px;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.85), rgba(30, 41, 80, 0.75));
      border-radius: 24px;
      padding: 28px 24px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      border: 1.5px solid rgba(255,255,255,0.15);
      flex-shrink: 0;
      will-change: transform;
      box-shadow: 0 12px 48px rgba(15, 27, 71, 0.3),
                  inset 0 1px 0 rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      /* FIX: Base z-index for normal cards */
      z-index: 1;
    }
    
    .system-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, transparent 60%);
      opacity: 0.5;
      pointer-events: none;
      border-radius: 24px;
    }
    
    .system-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, var(--status-color), transparent 70%);
      opacity: 0.9;
      border-radius: 24px 24px 0 0;
    }
    
    .system-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 24px 64px rgba(15, 27, 71, 0.4),
                  inset 0 1px 0 rgba(255,255,255,0.12);
      border-color: rgba(255,255,255,0.3);
      /* FIX: Ensure hover card is above others */
      z-index: 5;
    }
    
    .system-card:active {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 12px 32px rgba(15, 27, 71, 0.3);
      z-index: 5;
    }
    
    .system-card.completed {
      --status-color: #34a853;
      background: linear-gradient(135deg, rgba(52,168,83,0.15), rgba(52,168,83,0.05));
      border-color: rgba(52,168,83,0.4);
    }
    
    .system-card.current {
      --status-color: #fbbc04;
      background: linear-gradient(135deg, rgba(251,188,4,0.28), rgba(251,188,4,0.12));
      border-color: rgba(251,188,4,0.6);
      border-width: 2px;
      min-width: 260px;
      height: 320px;
      transform: scale(1.12);
      /* FIX: Current card is always on top */
      z-index: 15;
      box-shadow: 0 28px 70px rgba(251,188,4,0.45),
                  0 0 0 4px rgba(251,188,4,0.2),
                  inset 0 2px 0 rgba(255,255,255,0.3),
                  inset 0 -2px 0 rgba(0,0,0,0.15);
      will-change: transform, box-shadow;
    }
    
    .system-card.current::before {
      opacity: 1;
      background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, transparent 65%);
    }
    
    .system-card.current .system-icon {
      width: 80px;
      height: 80px;
      font-size: 44px;
      background: rgba(251,188,4,0.25);
      border-color: rgba(251,188,4,0.5);
      box-shadow: 0 8px 24px rgba(251,188,4,0.3);
    }
    
    .system-card.current .system-name {
      font-size: 19px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }
    
    .system-card.current .system-progress {
      font-size: 16px;
      font-weight: 700;
    }
    
    .system-card.current:hover {
      transform: translateY(-8px) scale(1.14);
      box-shadow: 0 36px 80px rgba(251,188,4,0.55),
                  0 0 0 5px rgba(251,188,4,0.25),
                  inset 0 2px 0 rgba(255,255,255,0.35),
                  inset 0 -2px 0 rgba(0,0,0,0.2);
      /* FIX: Highest z-index when current card is hovered */
      z-index: 20;
    }
    
    .system-card.current:active {
      transform: translateY(-4px) scale(1.12);
      box-shadow: 0 24px 64px rgba(251,188,4,0.45),
                  0 0 0 4px rgba(251,188,4,0.22),
                  inset 0 2px 0 rgba(255,255,255,0.32);
      z-index: 20;
    }
    
    .system-card.in-progress {
      --status-color: #3b82f6;
      background: linear-gradient(135deg, rgba(59,130,246,0.22), rgba(59,130,246,0.08));
      border-color: rgba(59,130,246,0.5);
    }
    
    .system-card.not-started {
      --status-color: #ea4335;
      background: linear-gradient(135deg, rgba(234,67,53,0.18), rgba(234,67,53,0.06));
      border-color: rgba(234,67,53,0.45);
      opacity: 0.75;
    }
    
    .system-card.selected {
      border-color: rgba(255,255,255,0.6);
      box-shadow: 0 8px 32px rgba(102,126,234,0.3),
                  0 0 0 2px rgba(102,126,234,0.2);
      /* FIX: Selected cards above normal cards */
      z-index: 8;
    }

    .system-card.selected:not(.current) {
      transform: scale(1.05);
      z-index: 8;
    }

    .system-card.current.selected {
      transform: scale(1.08);
      /* FIX: Selected current card is highest */
      z-index: 18;
    }
    
    /* Futuristic Notification Badge */
    .system-notification {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
      animation: scaleIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .system-notification.unlocked {
      background: linear-gradient(135deg, #34a853, #0f9d58);
      box-shadow: 0 4px 20px rgba(52,168,83,0.6),
                  0 0 0 3px rgba(52,168,83,0.3),
                  inset 0 1px 0 rgba(255,255,255,0.4);
    }
    
    .system-notification.locked {
      background: linear-gradient(135deg, #ea4335, #c5221f);
      box-shadow: 0 4px 20px rgba(234,67,53,0.6),
                  0 0 0 3px rgba(234,67,53,0.3),
                  inset 0 1px 0 rgba(255,255,255,0.4);
    }
    
    .notification-count {
      font-size: 13px;
      font-weight: 800;
      color: white;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
      position: relative;
      z-index: 2;
    }
    
    .notification-lock {
      font-size: 12px;
      position: absolute;
      bottom: -4px;
      right: -4px;
      background: rgba(0,0,0,0.4);
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid rgba(255,255,255,0.3);
    }
    
    .notification-pulse {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 50%;
      background: inherit;
      animation: notificationPulse 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
      opacity: 0.7;
    }
    
    @keyframes notificationPulse {
      0% {
        transform: scale(1);
        opacity: 0.7;
      }
      50% {
        transform: scale(1.3);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 0;
      }
    }
    
    .system-icon {
      width: 68px;
      height: 68px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      margin-bottom: 18px;
      background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
      border: 2px solid rgba(255,255,255,0.25);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15),
                  inset 0 1px 0 rgba(255,255,255,0.2);
    }
    
    .system-card:hover .system-icon {
      transform: rotate(12deg) scale(1.15);
      background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.12));
      box-shadow: 0 6px 24px rgba(0,0,0,0.2),
                  inset 0 1px 0 rgba(255,255,255,0.3);
    }
    
    .system-name {
      font-size: 17px;
      font-weight: 700;
      color: white;
      margin-bottom: 10px;
      line-height: 1.4;
      text-shadow: 0 2px 6px rgba(0,0,0,0.3);
      letter-spacing: 0.2px;
    }
    
    .system-progress {
      font-size: 14px;
      font-weight: 600;
      color: rgba(255,255,255,0.85);
      margin-bottom: 16px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .system-bar {
      width: 100%;
      height: 8px;
      background: rgba(0,0,0,0.25);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .system-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--status-color), var(--status-color-light, var(--status-color)));
      border-radius: 12px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 12px var(--status-color),
                  inset 0 1px 0 rgba(255,255,255,0.3);
    }
    
    .system-status {
      position: absolute;
      bottom: 20px;
      right: 20px;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--status-color);
      color: var(--status-color);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2),
                  0 0 20px var(--status-color, transparent);
    }
    
    .system-card.current .system-status {
      animation: glow 2s ease-in-out infinite;
      background: rgba(251,188,4,0.2);
    }
    
    .carousel-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    
    .carousel-nav:hover {
      background: rgba(102,126,234,0.3);
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 4px 20px rgba(102,126,234,0.4);
    }
    
    .carousel-nav.prev {
      left: 0;
    }
    
    .carousel-nav.next {
      right: 0;
    }
    
    .progress-legend {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: rgba(255,255,255,0.8);
    }
    
    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      box-shadow: 0 0 10px currentColor;
    }
    
    .legend-dot.completed {
      background: #34a853;
    }
    
    .legend-dot.current {
      background: #fbbc04;
      animation: pulse 2s ease-in-out infinite;
    }
    
  .legend-dot.in-progress {
      background: #34a853;
    }
    
    .legend-dot.current {
      background: #facc15;
    }
    
    .legend-dot.in-progress {
      background: #3b82f6;
    }
    
    .legend-dot.not-started {
      background: #ef4444;
    }
    
    .games-card {
      padding: 24px 28px;
    }

    .games-card .card-title {
      margin-bottom: 16px;
    }

    .games-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 20px;
    }

    .game-card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.85), rgba(30, 41, 80, 0.75));
      border: 1.5px solid rgba(255,255,255,0.15);
      border-radius: 24px;
      padding: 26px 30px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 24px;
      min-height: 0;
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      box-shadow: 0 12px 48px rgba(15, 27, 71, 0.3),
                  inset 0 1px 0 rgba(255,255,255,0.08);
      appearance: none;
      -webkit-appearance: none;
      text-align: left;
      width: 100%;
      color: inherit;
    }
    
    .game-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(147,51,234,0.15) 0%, rgba(102,126,234,0.12) 100%);
      opacity: 0;
      transition: opacity 0.4s ease;
      border-radius: 24px;
    }
    
    .game-card:hover::before {
      opacity: 1;
    }
    
    .pharmaquest-card {
      border-color: rgba(147,51,234,0.4);
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(45, 20, 80, 0.7));
    }
    
    .pharmaquest-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, rgba(147,51,234,0.8), transparent 70%);
      border-radius: 24px 24px 0 0;
    }
    
    .game-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 28px 70px rgba(147,51,234,0.35), 
                  0 0 80px rgba(147,51,234,0.25),
                  inset 0 2px 0 rgba(255,255,255,0.15);
      border-color: rgba(147,51,234,0.6);
    }
    
    .coming-soon-card {
      opacity: 0.65;
      cursor: not-allowed;
      border-color: rgba(255,255,255,0.1);
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }
    
    .coming-soon-card:hover {
      transform: none;
      box-shadow: 0 12px 48px rgba(15, 27, 71, 0.3);
      border-color: rgba(255,255,255,0.1);
    }
    
    .game-icon {
      font-size: 56px;
      line-height: 1;
      filter: drop-shadow(0 6px 20px rgba(147,51,234,0.5));
      animation: float 3.5s ease-in-out infinite;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    .game-card:hover .game-icon {
      transform: scale(1.1) rotate(5deg);
      filter: drop-shadow(0 8px 28px rgba(147,51,234,0.7));
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-12px); }
    }
    
    .game-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      z-index: 2;
    }
    
    .game-title {
      color: #ffffff;
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, #ffffff, #e0e7ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.3px;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.3));
    }
    
    .game-description {
      color: rgba(255,255,255,0.8);
      font-size: 15px;
      line-height: 1.4;
      margin: 0;
      font-weight: 400;
    }
    
    .game-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 2px;
    }
    
    .game-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
      color: rgba(255,255,255,0.9);
      background: rgba(147,51,234,0.2);
      padding: 6px 12px;
      border-radius: 10px;
      border: 1.5px solid rgba(147,51,234,0.3);
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }
    
    .game-stat:hover {
      background: rgba(147,51,234,0.3);
      border-color: rgba(147,51,234,0.5);
      transform: translateY(-2px);
    }
    
    .stat-icon {
      font-size: 16px;
    }
    
    .game-play-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: linear-gradient(135deg, #9333ea, #7c3aed);
      color: white;
      padding: 14px 20px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 6px 24px rgba(147,51,234,0.4),
                  inset 0 1px 0 rgba(255,255,255,0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 0;
      position: relative;
      overflow: hidden;
      min-width: 160px;
      flex-shrink: 0;
    }
    
    .game-play-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .game-card:hover .game-play-btn {
      background: linear-gradient(135deg, #a855f7, #9333ea);
      box-shadow: 0 10px 32px rgba(147,51,234,0.6),
                  inset 0 1px 0 rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    
    .game-card:hover .game-play-btn::before {
      left: 100%;
    }
    
    .play-arrow {
      font-size: 20px;
      transition: transform 0.3s ease;
    }
    
    .game-card:hover .play-arrow {
      transform: translateX(6px);
    }
    
    .coming-soon-badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: rgba(251,191,36,0.2);
      border: 1.5px solid rgba(251,191,36,0.4);
      color: #fbbf24;
      padding: 10px 18px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      margin-top: 12px;
      width: fit-content;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(251,191,36,0.2);
    }
    
    .connect-google-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .connect-google-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(66,133,244,0.3);
    }
    
    /* ==========================================================================
       CARD COMPONENTS
       ========================================================================== */
    
    .card {
      position: relative;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      border: 1px solid rgba(255,255,255,0.12);
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 25px 60px rgba(13, 16, 35, 0.7), inset 0 1px 0 rgba(255,255,255,0.05);
      animation: scaleIn 0.5s ease-out;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      will-change: transform;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: -45%;
      left: -30%;
      width: 70%;
      height: 160%;
      background: linear-gradient(130deg, rgba(255,255,255,0.35), transparent 60%);
      opacity: 0.45;
      transform: rotate(8deg);
      pointer-events: none;
      transition: transform 0.6s ease, opacity 0.6s ease;
    }
    
    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 30px 70px rgba(13, 16, 35, 0.8), inset 0 1px 0 rgba(255,255,255,0.08);
      border-color: rgba(102,126,234,0.3);
    }
    
    .card:hover::before {
      transform: rotate(2deg) translateX(12px);
      opacity: 0.65;
    }
    
    .card-title {
      font-size: 22px;
      color: #ffffff;
      font-weight: 700;
      margin: 0 0 24px 0;
      padding: 0 0 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.1);
      letter-spacing: 0.3px;
    }
    
    .card-title-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 22px;
    }
    
    .card-title-left span {
      font-size: 24px;
      line-height: 1;
    }
    
    .show-all-notes-btn {
      margin-left: auto;
      padding: 10px 22px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .show-all-notes-btn:hover {
      background: rgba(255,255,255,0.18);
      border-color: rgba(255,255,255,0.3);
      transform: translateY(-1px);
    }

    .show-all-notes-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .profile-info {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .info-row {
      display: grid;
      grid-template-columns: 140px 1fr;
      align-items: center;
      gap: 20px;
      padding: 18px 22px;
      background: linear-gradient(140deg, rgba(255,255,255,0.14), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      animation: slideInRight 0.5s ease-out backwards;
      min-height: 62px;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 8px 24px rgba(15, 27, 71, 0.18);
      position: relative;
      overflow: hidden;
    }

    .info-row::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 40%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.18));
      opacity: 0;
      transition: opacity 0.35s ease;
      pointer-events: none;
    }
    
    .info-row:nth-child(1) { animation-delay: 0.1s; }
    .info-row:nth-child(2) { animation-delay: 0.2s; }
    .info-row:nth-child(3) { animation-delay: 0.3s; }
    .info-row:nth-child(4) { animation-delay: 0.4s; }
    .info-row:nth-child(5) { animation-delay: 0.5s; }
    
    .info-row:hover {
      transform: translateX(6px);
      box-shadow: 0 14px 34px rgba(102,126,234,0.28);
      border-color: rgba(255,255,255,0.32);
    }

    .info-row:hover::after {
      opacity: 0.35;
    }
    
    .info-label {
      font-weight: 600;
      color: rgba(255,255,255,0.75);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .info-value {
      font-weight: 700;
      color: #ffffff;
      font-size: 16px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: right;
      word-break: break-word;
      overflow-wrap: break-word;
    }
    
    .payment-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(120px, 0.85fr));
      grid-auto-flow: row;
      gap: 10px;
      max-height: 184px;
      overflow-y: auto;
      padding: 4px;
      margin-top: 16px;
    }
    
    .payment-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .payment-list::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .payment-list::-webkit-scrollbar-thumb {
      background: transparent;
      border-radius: 10px;
    }
    
    .payment-list:hover::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.3);
    }
    
    .payment-list::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.5);
    }
    
    .payment-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 14px 16px;
      background: linear-gradient(145deg, rgba(255,255,255,0.14), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 16px;
      border-left: 3px solid rgba(255,255,255,0.38);
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      animation: slideInRight 0.4s ease-out backwards;
      position: relative;
      overflow: hidden;
      min-height: 80px;
      backdrop-filter: blur(var(--list-blur));
      -webkit-backdrop-filter: blur(var(--list-blur));
      box-shadow: 0 12px 32px rgba(12, 22, 54, 0.22);
    }
    
    .payment-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.16), transparent);
      transition: left 0.5s;
    }
    
    .payment-item:hover::before {
      left: 100%;
    }
    
    .payment-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 44px rgba(0,0,0,0.22);
      border-color: rgba(255,255,255,0.32);
    }
    
    .payment-item.paid {
      border-left-color: #22c55e;
    }
    
    .payment-item.credit {
      border-left-color: #fb923c;
    }
    
    .payment-item.unpaid {
      border-left-color: #ef4444;
    }
    
    .payment-item.absent {
      border-left-color: #f59e0b;
    }
    
    .payment-date {
      font-weight: 600;
      color: #ffffff;
      font-size: 13px;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .payment-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 14px;
      color: rgba(255,255,255,0.9);
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 12px;
    }
    
    .status-badge.paid {
      background: rgba(34,197,94,0.15);
      color: #22c55e;
    }
    
    .status-badge.credit {
      background: rgba(251,146,60,0.15);
      color: #fb923c;
    }
    
    .status-badge.unpaid {
      background: rgba(239,68,68,0.15);
      color: #ef4444;
    }
    
    .status-badge.absent {
      background: rgba(245,158,11,0.15);
      color: #f59e0b;
    }
    
    .payment-amount {
      font-weight: 700;
      font-size: 16px;
      color: #667eea;
    }
    
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .stat-card {
      padding: 18px 16px;
      background: linear-gradient(150deg, rgba(255,255,255,0.16), rgba(255,255,255,0.05));
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.2);
      text-align: center;
      animation: scaleIn 0.5s ease-out backwards;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 90px;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 36px rgba(12, 22, 54, 0.2);
    }

    .stat-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(255,255,255,0.25), transparent 60%);
      opacity: 0;
      transition: opacity 0.35s ease;
      pointer-events: none;
    }
    
    .stat-card:nth-child(1) { animation-delay: 0.1s; }
    .stat-card:nth-child(2) { animation-delay: 0.2s; }
    .stat-card:nth-child(3) { animation-delay: 0.3s; }
    
    .stat-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 18px 48px rgba(102,126,234,0.28);
      border-color: rgba(255,255,255,0.3);
    }

    .stat-card:hover::after {
      opacity: 0.6;
    }
    
    .stat-label {
      font-size: 11px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    .stat-value {
      font-size: 26px;
      font-weight: 700;
      color: #ffffff;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
      line-height: 1;
    }
    
    .stat-date {
      font-size: 10px;
      color: rgba(255,255,255,0.55);
      margin-top: 6px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    
    /* Unpaid stat card - clean style matching Last Paid box */
    .stat-card.has-unpaid {

    .stat-card.credit-card {
      border-color: #0ea5e9 !important;
    }

    .stat-card.credit-card .stat-value {
      color: #38bdf8;
    }

    .stat-card.credit-card .stat-date {
      color: rgba(56, 189, 248, 0.8);
      font-weight: 500;
    }
      /* No special effects - looks exactly like green box but red */
    }
    
    .login-screen {
      max-width: 450px;
      margin: 80px auto;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      padding: 40px;
      border-radius: 24px;
      box-shadow: 0 25px 60px rgba(13, 16, 35, 0.7), inset 0 1px 0 rgba(255,255,255,0.05);
      animation: scaleIn 0.5s ease-out, glow 3s infinite;
      border: 1px solid rgba(102,126,234,0.3);
    }
    
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }
    
    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e2e8f0;
      transition: all 0.3s;
    }
    
    .step-dot.active {
      background: #667eea;
      width: 30px;
      border-radius: 5px;
    }
    
    .auth-step {
      display: none;
    }
    
    .auth-step.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Futuristic Animations */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(102,126,234,0.3), 0 0 40px rgba(102,126,234,0.2); }
      50% { box-shadow: 0 0 30px rgba(102,126,234,0.5), 0 0 60px rgba(102,126,234,0.3); }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes borderGlow {
      0%, 100% { border-color: rgba(255,255,255,0.3); }
      50% { border-color: rgba(102,126,234,0.8); }
    }
    
    @keyframes unlock {
      0% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.2) rotate(-10deg); }
      75% { transform: scale(1.2) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 0; }
    }
    
    @keyframes urgentBlink {
      0%, 49% { 
        opacity: 1;
        text-shadow: 0 0 10px rgba(239, 68, 68, 0.8), 0 0 20px rgba(239, 68, 68, 0.5);
      }
      50%, 100% { 
        opacity: 0.4;
        text-shadow: 0 0 5px rgba(239, 68, 68, 0.4), 0 0 10px rgba(239, 68, 68, 0.2);
      }
    }
    
    @keyframes unpaidGlow {
      0%, 100% { 
        box-shadow: 0 10px 36px rgba(239, 68, 68, 0.3), 0 0 20px rgba(239, 68, 68, 0.4);
        border-color: rgba(239, 68, 68, 0.6);
      }
      50% { 
        box-shadow: 0 10px 36px rgba(239, 68, 68, 0.5), 0 0 30px rgba(239, 68, 68, 0.6);
        border-color: rgba(239, 68, 68, 0.9);
      }
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .login-logo {
      width: 180px;
      height: 180px;
      margin-bottom: 40px;
      filter: drop-shadow(0 0 15px rgba(102,126,234,0.8));
    }
    
    .login-title {
      font-size: 28px;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .login-subtitle {
      color: rgba(255,255,255,0.7);
      font-size: 14px;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    .input-label {
      display: block;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .input-field {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 80, 0.5));
      border-radius: 10px;
      font-size: 16px;
      color: #ffffff;
      transition: all 0.2s;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
    }
    
    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .login-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .login-btn:hover::before {
      width: 400px;
      height: 400px;
    }
    
    .login-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 10px 30px rgba(102,126,234,0.4);
    }
    
    .login-btn:active {
      transform: translateY(-1px) scale(0.98);
    }
    
    .error-message {
      background: rgba(239,68,68,0.15);
      color: #ef4444;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      color: white;
      font-size: 18px;
      animation: pulse 2s ease-in-out infinite;
    }
    
    .loading::after {
      content: '';
      display: block;
      width: 50px;
      height: 50px;
      margin: 20px auto;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr;
      }
      
      .summary-stats {
        grid-template-columns: 1fr;
      }
      
      .group-schedule {
        grid-template-columns: 1fr;
      }
      
      .games-container {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .game-card {
        padding: 24px;
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .game-play-btn {
        width: 100%;
        min-width: 0;
      }
      
      .game-icon {
        font-size: 48px;
      }
      
      .game-title {
        font-size: 20px;
      }
      
      .game-modal-container {
        width: 100vw;
        height: 100vh;
        border-radius: 0;
        max-width: none;
      }
      
      .game-modal-header {
        padding: 16px 20px;
      }
      
      .game-modal-header h2 {
        font-size: 20px;
      }
      
      .header {
        text-align: center;
      }
      
      .header-left {
        flex-direction: column;
      }
    }
    
    /* Impersonation Banner */
    .impersonation-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10000;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .impersonation-banner-text {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 14px;
    }
    
    .impersonation-icon {
      font-size: 20px;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.1);
      }
    }
    
    .exit-impersonation-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.4);
      color: white;
      padding: 8px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
    }
    
    .exit-impersonation-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    /* Adjust body padding when impersonation banner is active */
    body.impersonating {
      padding-top: 70px;
    }
    
    body.impersonating .container {
      margin-top: 0;
    }
    
    /* Schedule Card Styles */
    .schedule-updated-badge {
      display: inline-block;
      background: rgba(251,188,4,0.2);
      color: #fbbc04;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      margin-left: 12px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .next-class-card {
      padding: 22px 26px;
      border-radius: 26px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      margin-bottom: 25px;
    }

    .next-class-label {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 1px;
      color: rgba(255, 255, 255, 0.55);
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .next-class-date {
      font-size: 20px;
      font-weight: 700;
      color: white;
      margin-bottom: 18px;
    }

    .next-class-timer {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.10);
      backdrop-filter: blur(10px);
    }

    .timer-icon {
      font-size: 20px;
    }

    .timer-text {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.75);
    }

    .timer-value {
      font-size: 20px;
      font-weight: 700;
      margin-left: 4px;
      background: linear-gradient(90deg, #8ab4ff, #b499ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .next-class-timer .timer-value {
      font-family: 'Courier New', monospace;
      font-size: 26px;
      font-weight: 700;
      color: #8b9eff;
      letter-spacing: 2px;
      text-shadow: 0 0 20px rgba(102,126,234,0.5),
                   0 2px 4px rgba(0,0,0,0.3);
    }
    
    .group-schedule {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    
    .schedule-card {
      padding: 14px 18px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .schedule-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(102,126,234,0.3);
      transform: translateY(-2px);
    }
    
    .schedule-card.one-time {
      background: linear-gradient(145deg, rgba(251,188,4,0.15), rgba(251,188,4,0.1));
      border-color: rgba(251,188,4,0.5);
    }
    
    .time-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      padding: 2px 0;
    }
    
    .flag {
      font-size: 12px;
      width: 20px;
      flex-shrink: 0;
    }
    
    .day-name {
      font-size: 12px;
      font-weight: 600;
      width: 75px;
      color: #ffffff;
      flex-shrink: 0;
    }
    
    .time-value {
      font-size: 12px;
      font-weight: 600;
      margin-left: auto;
      white-space: nowrap;
    }
    
    .la-time {
      color: #a3c8ff;
    }
    
    .miami-time {
      color: #f5c042;
    }
    
    .yerevan-time {
      color: #d5a6ff;
    }
    
    .time-divider {
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      margin: 6px 0;
    }
    
    .one-time-date {
      display: block;
      font-size: 11px;
      color: #fbbc04;
      margin-top: 10px;
      font-weight: 700;
      text-shadow: 0 0 15px rgba(251,188,4,0.6);
      letter-spacing: 0.5px;
    }
    
    .schedule-empty {
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      text-align: center;
      padding: 16px;
      font-style: italic;
    }
    
    /* Announcements Feed Styles */
    .announcements-feed {
      max-height: 400px;
      overflow-y: auto;
      padding: 4px;
    }
    
    .announcements-feed::-webkit-scrollbar {
      width: 8px;
    }
    
    .announcements-feed::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }
    
    .announcements-feed::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
    
    .announcements-feed::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .announcement-item {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.7), rgba(30, 41, 80, 0.6));
      backdrop-filter: blur(var(--list-blur));
      border: 1px solid rgba(255,255,255,0.12);
      border-left-width: 3px;
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    
    .announcement-item:hover {
      transform: translateX(4px);
      border-color: rgba(255,255,255,0.2);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .announcement-item.cancelation {
      border-left-color: #ef4444;
      background: linear-gradient(145deg, rgba(239,68,68,0.1), rgba(239,68,68,0.05));
    }
    
    .announcement-item.reschedule {
      border-left-color: #3b82f6;
      background: linear-gradient(145deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05));
    }
    
    .announcement-item.new-class {
      border-left-color: #10b981;
      background: linear-gradient(145deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
    }
    
    .announcement-item.permanent-change {
      border-left-color: #f59e0b;
      background: linear-gradient(145deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05));
    }
    
    .announcement-icon {
      font-size: 18px;
      margin-right: 8px;
    }
    
    .announcement-text {
      color: rgba(255,255,255,0.9);
      font-size: 13px;
      line-height: 1.5;
    }
    
    .announcement-date {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      margin-top: 6px;
      font-style: italic;
    }
    
    .announcement-empty {
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      text-align: center;
      padding: 16px;
      font-style: italic;
    }

    /* ===== Modernized theme overrides ===== */
    body {
      background: radial-gradient(circle at 15% 20%, rgba(125, 211, 252, 0.12), transparent 40%),
                  radial-gradient(circle at 75% 0%, rgba(248, 113, 113, 0.08), transparent 40%),
                  linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
      color: var(--text-strong);
    }

    body::before {
      background: radial-gradient(circle at 20% 50%, rgba(126, 34, 206, 0.18) 0%, transparent 45%),
                  radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.18) 0%, transparent 45%);
      opacity: 0.7;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 120px 120px;
      opacity: 0.4;
      pointer-events: none;
      z-index: 0;
      animation: grainShift 26s linear infinite;
    }

    .background-layers {
      position: fixed;
      inset: 0;
      overflow: hidden;
      z-index: 0;
      pointer-events: none;
    }

    .aurora-layer {
      position: absolute;
      width: 140%;
      height: 140%;
      filter: blur(70px);
      opacity: 0.35;
      background: radial-gradient(circle, rgba(125, 211, 252, 0.35), transparent 60%);
      animation: auroraDrift 30s ease-in-out infinite;
      mix-blend-mode: screen;
    }

    .aurora-2 {
      background: radial-gradient(circle, rgba(192, 132, 252, 0.35), transparent 60%);
      animation-duration: 34s;
      animation-delay: -6s;
    }

    .aurora-3 {
      background: radial-gradient(circle, rgba(248, 113, 113, 0.25), transparent 70%);
      animation-duration: 40s;
      animation-delay: -12s;
    }

    .floating-orb {
      position: absolute;
      width: 320px;
      height: 320px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(125, 211, 252, 0.18), transparent 60%);
      filter: blur(12px);
      animation: orbFloat 12s ease-in-out infinite;
    }

    .orb-1 { top: 10%; left: 10%; }
    .orb-2 { bottom: 8%; right: 12%; animation-duration: 16s; }
    .orb-3 { top: 40%; right: 20%; animation-duration: 18s; }

    .digital-grid {
      position: absolute;
      inset: 0;
      background-image: linear-gradient(transparent 95%, rgba(255,255,255,0.04) 95%),
                        linear-gradient(90deg, transparent 95%, rgba(255,255,255,0.04) 95%);
      background-size: 140px 140px;
      opacity: 0.35;
      transform: skewY(-4deg);
      filter: blur(0.5px);
    }

    .grain-overlay {
      position: absolute;
      inset: 0;
      background-image: radial-gradient(rgba(255,255,255,0.04) 1px, transparent 1px);
      background-size: 3px 3px;
      opacity: 0.2;
      animation: grainShift 18s linear infinite;
    }

    .logo-watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 85vw;
      height: 85vw;
      max-width: 1200px;
      max-height: 1200px;
      background-image: url('richyfesta-logo.png');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.08;
      filter: blur(0.5px);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 2;
    }

    .header,
    .card,
    .forum-container,
    .profile-modal-container,
    .game-modal-container,
    .account-menu {
      background: linear-gradient(135deg, rgba(14, 23, 46, 0.88), rgba(29, 38, 72, 0.82));
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 35px 80px rgba(2, 6, 23, 0.65), inset 0 1px 0 rgba(255,255,255,0.05);
    }

    .header::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,0.08), transparent 70%);
      opacity: 0;
      animation: shimmerLine 6s ease-in-out infinite;
      pointer-events: none;
    }

    .logo {
      filter: drop-shadow(0 0 25px rgba(125, 211, 252, 0.45)) drop-shadow(0 0 45px rgba(192, 132, 252, 0.35));
    }

    .card,
    .game-card,
    .system-card,
    .classroom-item,
    .payment-item,
    .profile-modal-row,
    .info-row,
    .stat-card {
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.08);
      background-image: linear-gradient(145deg, rgba(15, 23, 42, 0.92), rgba(31, 41, 80, 0.78));
      box-shadow: var(--card-shadow);
      position: relative;
      overflow: hidden;
    }

    .card::before,
    .game-card::before,
    .system-card::before,
    .payment-item::before,
    .classroom-item::before,
    .info-row::before,
    .profile-modal-row::before {
      content: '';
      position: absolute;
      top: -150%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(125, 211, 252, 0.08), transparent 45%);
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
    }

    .card:hover::before,
    .game-card:hover::before,
    .system-card:hover::before,
    .payment-item:hover::before,
    .classroom-item:hover::before,
    .info-row:hover::before,
    .profile-modal-row:hover::before {
      opacity: 1;
    }

    .stat-card {
      background-image: linear-gradient(160deg, rgba(125, 211, 252, 0.18), rgba(14, 23, 42, 0.9));
      border-color: rgba(125, 211, 252, 0.3);
    }

    .next-class-timer {
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(125, 211, 252, 0.2);
      border-radius: 18px;
      padding: 20px;
      box-shadow: inset 0 0 20px rgba(125, 211, 252, 0.1);
    }

    .timer-countdown {
      background: radial-gradient(circle at 30% 30%, rgba(125, 211, 252, 0.15), transparent);
      border: 1px solid rgba(125, 211, 252, 0.25);
      border-radius: 16px;
      padding: 10px 16px;
    }

    .payment-item {
      border-left-width: 4px;
      backdrop-filter: blur(16px);
    }

    .classroom-item {
      backdrop-filter: blur(14px);
    }

    .system-card {
      background-image: linear-gradient(160deg, rgba(15, 23, 42, 0.95), rgba(59, 7, 100, 0.85));
      border: 1px solid rgba(192, 132, 252, 0.25);
    }

    .game-card {
      background-image: linear-gradient(150deg, rgba(30, 64, 175, 0.45), rgba(59, 7, 100, 0.6));
    }

    .forum-btn,
    .account-btn,
    .logout-btn,
    .unified-expand-btn,
    .game-play-btn,
    .connect-google-btn {
      background-image: linear-gradient(120deg, rgba(125, 211, 252, 0.25), rgba(192, 132, 252, 0.25));
      border: 1px solid rgba(125, 211, 252, 0.35);
      box-shadow: 0 10px 30px rgba(125, 211, 252, 0.2);
    }

    .forum-btn:hover,
    .account-btn:hover,
    .logout-btn:hover,
    .unified-expand-btn:hover,
    .game-play-btn:hover,
    .connect-google-btn:hover {
      box-shadow: 0 15px 35px rgba(125, 211, 252, 0.35);
      border-color: rgba(125, 211, 252, 0.55);
    }

    .forum-badge {
      background: linear-gradient(120deg, #fb7185, #f43f5e);
      box-shadow: 0 0 12px rgba(244, 63, 94, 0.6);
    }

    .schedule-day {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.85), rgba(30, 64, 175, 0.25));
      border: 1px solid rgba(125, 211, 252, 0.2);
    }

    .profile-modal-row {
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(125, 211, 252, 0.15);
    }

    .forum-modal,
    .profile-modal,
    .game-modal {
      backdrop-filter: blur(30px);
      background: rgba(4, 6, 17, 0.75);
    }
  </style>
</head>
<body>
  <!-- ==========================================================================
       BACKGROUND VISUAL EFFECTS
       ========================================================================== -->
  <div class="background-layers" aria-hidden="true">
    <div class="logo-watermark"></div>
    <div class="aurora-layer aurora-1"></div>
    <div class="aurora-layer aurora-2"></div>
    <div class="aurora-layer aurora-3"></div>
    <div class="floating-orb orb-1"></div>
    <div class="floating-orb orb-2"></div>
    <div class="floating-orb orb-3"></div>
    <div class="digital-grid"></div>
    <div class="grain-overlay"></div>
  </div>
  
  <!-- ==========================================================================
       ADMIN IMPERSONATION BANNER
       ========================================================================== -->
  <!-- Impersonation Banner (hidden by default) -->
  <div id="impersonationBanner" class="impersonation-banner" style="display: none;">
    <div class="impersonation-banner-text">
      <span class="impersonation-icon"></span>
      <span>You are viewing as: <strong id="impersonatedStudentName">Student Name</strong></span>
      <span style="opacity: 0.8; font-size: 12px;" id="impersonationTimer">Expires in 10:00</span>
    </div>
    <button class="exit-impersonation-btn" onclick="exitImpersonation()">
       Exit Impersonation Mode
    </button>
  </div>
  
  <!-- Main Portal Content -->
  <div id="portalContent" style="display: block;">
    <div class="container">
      <div class="header">
        <div class="header-left">
          <img src="richyfesta-logo.png" alt="ARNOMA" class="logo">
          <div class="header-title">
            <h1 id="welcomeMessage" style="opacity: 0; transition: opacity 0.3s ease;">
              <span class="title-line">Welcome,</span>
              <span class="name-line">Loading...</span>
            </h1>
          </div>
        </div>
        <div class="header-actions">
          <button class="forum-btn" id="portalAdminBtn" onclick="window.location.href='Student-Portal-Admin.html'" style="display: none;">
            <span></span>
            <span>Portal</span>
          </button>
          <button class="forum-btn" onclick="toggleForum()">
            <span></span>
            <span>Nurses</span>
            <span class="forum-badge" id="forumBadge" style="display: none;">0</span>
          </button>
          <div class="account-dropdown">
            <button class="account-btn" onclick="toggleAccountDropdown()">
              <span> My Account</span>
              <span class="dropdown-arrow"></span>
            </button>
            <div class="account-menu" id="accountMenu">
              <button class="account-menu-item" onclick="openProfileModal()">
                <span></span>
                <span>My Profile</span>
              </button>
              <button class="account-menu-item" onclick="logout()">
                <span></span>
                <span>Sign Out</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- All sections in one page - Custom Order -->
      <div class="content">
        
        <!-- 1. GROUP SCHEDULE -->
        <div class="card">
          <h2 class="card-title">
            <div class="card-title-left">
              Your Schedule<span id="scheduleGroupName" style="color: rgba(255,255,255,0.6); font-weight: 400;"></span>
              <span id="scheduleUpdatedBadge" class="schedule-updated-badge" style="display: none;">Updated</span>
            </div>
          </h2>
          
          <!-- Next Class Countdown Timer -->
          <div class="next-class-card">
            <div class="next-class-label">NEXT CLASS:</div>

            <div class="next-class-date" id="nextClassDate">
              Friday, Dec 5  8:00 AM
            </div>

            <div class="next-class-timer">
              <span class="timer-icon"></span>
              <span class="timer-text">Starts in:</span>
              <span class="timer-value" id="countdownValue">1 day</span>
            </div>
          </div>
          
          <!-- Schedule Display -->
          <div class="group-schedule" id="groupScheduleDisplay">
            <div class="schedule-empty">Loading schedule...</div>
          </div>
        </div>

        <!-- 2. PAYMENT HISTORY -->
        <div class="card">
          <h2 class="card-title">
            <div class="card-title-left">
              Payment History
            </div>
          </h2>
          
          <div class="summary-stats">
            <div class="stat-card" style="border-color: #ef4444;">
              <div class="stat-label">Unpaid</div>
              <div class="stat-value" style="color: #ef4444;" id="totalUnpaid">$0</div>
            </div>
            <div class="stat-card" style="border-color: #22c55e;">
          <div class="stat-label">Last Paid</div>
          <div class="stat-value" style="color: #22c55e;" id="lastPaid">$0</div>
              <div class="stat-date" id="lastPaidDate">-</div>
            </div>
            <div class="stat-card credit-card" id="creditCard" style="display: none;">
              <div class="stat-label">Credit</div>
              <div class="stat-value" id="creditBalance">$0</div>
              <div class="stat-date" id="creditNote">Extra payment available</div>
            </div>
            <div class="stat-card" id="absencesCard" style="border-color: #f59e0b; display: none;">
              <div class="stat-label">Absences</div>
              <div class="stat-value" style="color: #f59e0b;" id="absencesCount">0</div>
              <div class="stat-date" id="absencesNote">Missed classes</div>
            </div>
          </div>
          
          <div class="payment-list" id="paymentList" style="margin-top: 15px;">
            <div class="announcement-empty" id="paymentLazyMessage">Loading payment history...</div>
          </div>
        </div>

        <!-- 3. ANNOUNCEMENTS -->
        <div class="card">
          <h2 class="card-title">
            <div class="card-title-left">
              Announcements & Changes
            </div>
          </h2>
          
          <div class="announcements-feed" id="announcementsFeed">
            <div class="announcement-empty">Loading announcements...</div>
          </div>
        </div>

        <!-- 4. GAME CENTER -->
        <div class="card full-width-card games-card">
          <h2 class="card-title">
            <div class="card-title-left">
              <span></span>
              Study Games
            </div>
          </h2>
          
          <div class="games-container">
            <button type="button" class="game-card pharmaquest-card" onclick="openGameModal('PharmaQuest.html')">
              <div class="game-icon"></div>
              <div class="game-content">
                <h3 class="game-title">PharmaQuest</h3>
                <p class="game-description">Master NCLEX medications through interactive gameplay</p>
                <div class="game-stats">
                  <span class="game-stat">
                    <span class="stat-icon"></span>
                    <span>3 Difficulty Levels</span>
                  </span>
                  <span class="game-stat">
                    <span class="stat-icon"></span>
                    <span>Quick Study Sessions</span>
                  </span>
                </div>
              </div>
              <div class="game-play-btn">
                <span>Play Now</span>
                <span class="play-arrow"></span>
              </div>
            </button>
            
            <!-- Practice Test -->
            <button type="button" class="game-card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15));" onclick="openGameModal('Tests-Library.html')">
              <div class="game-icon"></div>
              <div class="game-content">
                <h3 class="game-title">Practice Tests</h3>
                <p class="game-description">Choose from various tests on different topics</p>
                <div class="game-stats">
                  <span class="game-stat">
                    <span class="stat-icon"></span>
                    <span>Multiple Tests</span>
                  </span>
                  <span class="game-stat">
                    <span class="stat-icon"></span>
                    <span>Instant Feedback</span>
                  </span>
                </div>
              </div>
              <div class="game-play-btn">
                <span>View Tests</span>
                <span class="play-arrow"></span>
              </div>
            </button>
            
            <!-- Placeholder for future games -->
            <div class="game-card coming-soon-card">
              <div class="game-icon"></div>
              <div class="game-content">
                <h3 class="game-title">Lab Values Quest</h3>
                <p class="game-description">Coming Soon</p>
                <div class="coming-soon-badge">
                  <span></span>
                  <span>In Development</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 5. CAROUSEL (NCLEX Systems Progress) -->
        <div class="card full-width-card" style="overflow: visible;">
          <h2 class="card-title">
            <div class="card-title-left">
              <span></span>
              NCLEX Systems Progress
            </div>
          </h2>
          
          <div class="systems-carousel-container">
            <button class="carousel-nav prev" onclick="scrollCarousel(-1)"></button>
            <div class="systems-carousel" id="systemsCarousel">
              <!-- System cards will be populated here -->
            </div>
            <button class="carousel-nav next" onclick="scrollCarousel(1)"></button>
          </div>
          
          <div class="progress-legend">
            <div class="legend-item">
              <span class="legend-dot completed"></span>
              <span>Completed</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot current"></span>
              <span>Ongoing</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot in-progress"></span>
              <span>In Progress</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot not-started"></span>
              <span>Not Started</span>
            </div>
          </div>
        </div>

        <!-- 6. NOTES -->
        <div class="card full-width-card">
          <h2 class="card-title">
            <div class="card-title-left">
              <span></span>
              Class Materials & Notes
            </div>
          </h2>
          
          <div id="classroomContent">
            <div id="classroomList" class="classroom-list">
              <div class="announcement-empty" id="notesLazyMessage">Loading materials...</div>
            </div>
          </div>
        </div>
        
      </div> <!-- End content -->

    </div> <!-- End main -->

    <!-- Forum Sidebar (unchanged) -->
    <div class="forum-sidebar" id="forumSidebar">
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Forum Modal -->
  <div class="forum-modal" id="forumModal">
    <div class="forum-container">
      <div class="forum-header">
        <h2> Nurses</h2>
        <button class="close-forum-btn" onclick="toggleForum()"></button>
      </div>
      
      <div class="forum-messages" id="forumMessages">
        <!-- Messages will be loaded here -->
      </div>
      
      <div class="forum-input-area">
        <textarea 
          class="forum-input" 
          id="forumInput" 
          placeholder="Ask a question or share something with your classmates..." 
          rows="2"
          onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendForumMessage(); }"></textarea>
        <button class="send-message-btn" onclick="sendForumMessage()">
          Send 
        </button>
      </div>
    </div>
  </div>
  
  <!-- Game Modal -->
  
  <!-- Profile Modal -->
  <dialog class="profile-modal" id="profileModal" aria-modal="true" tabindex="-1">
    <div class="profile-modal-container">
      <div class="profile-modal-header">
        <h2> My Profile</h2>
        <button class="close-profile-btn" onclick="closeProfileModal()"></button>
      </div>
      <div class="profile-modal-content">
        <div class="profile-modal-section">
          <div class="profile-modal-row">
            <span class="profile-modal-label">Full Name</span>
            <span class="profile-modal-value" id="modalStudentName">-</span>
          </div>
          <div class="profile-modal-row">
            <span class="profile-modal-label">Email Address</span>
            <span class="profile-modal-value" id="modalStudentEmail">-</span>
          </div>
          <div class="profile-modal-row">
            <span class="profile-modal-label">Group</span>
            <span class="profile-modal-value" id="modalStudentGroup">-</span>
          </div>
          <div class="profile-modal-row">
            <span class="profile-modal-label">Schedule</span>
            <span class="profile-modal-value" id="modalStudentSchedule">-</span>
          </div>
          <div class="profile-modal-row">
            <span class="profile-modal-label">Class Fee</span>
            <span class="profile-modal-value" id="modalStudentFee">-</span>
          </div>
          <div class="profile-modal-row">
            <span class="profile-modal-label">Account Balance</span>
            <span class="profile-modal-value" id="modalStudentBalance">-</span>
          </div>
          <div class="profile-modal-row">
            <span class="profile-modal-label">Aliases</span>
            <span class="profile-modal-value" id="modalStudentAliases" style="font-size: 0.9em; opacity: 0.85;">-</span>
          </div>
        </div>
      </div>
    </div>
  </dialog>

  <dialog class="game-modal" id="gameModal" aria-modal="true" tabindex="-1">
    <div class="game-modal-container">
      <div class="game-modal-header">
        <h2> PharmaQuest</h2>
        <button class="close-game-btn" onclick="closeGameModal()"></button>
      </div>
      <div class="game-modal-content">
        <iframe id="gameIframe" src="about:blank" title="PharmaQuest Game" style="border: none;" allowfullscreen></iframe>
      </div>
    </div>
  </dialog>
  
  <script>
    /* ==========================================================================
       STUDENT PORTAL - JAVASCRIPT
       ==========================================================================
       Architecture: Self-contained vanilla JS with direct Supabase integration
       Patterns: DOM caching, data caching with TTL, event-driven updates
       Auth: Supports student login + admin impersonation mode
       ========================================================================== */
    
    // ==========================================================================
    // CONFIGURATION
    // ==========================================================================
    const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
    
    // Initialize Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ==========================================================================
    // GLOBAL STATE
    // ==========================================================================
    
    /**
     * Checks authentication status and handles both normal student login and admin impersonation mode.
     * 
     * @async
     * @returns {Promise<Object|null>} Student data object if authenticated, null if auth fails
     * 
     * @description
     * This function handles two authentication flows:
     * 1. **Impersonation Mode**: When URL contains ?impersonate=<student_id>
     *    - Validates impersonation token from sessionStorage
     *    - Checks token expiration (10 min default)
     *    - Verifies student ID matches token
     *    - Loads student data from Supabase
     * 
     * 2. **Normal Authentication**: Standard student login via Supabase Auth
     *    - Retrieves active session
     *    - Matches session.user.id to students.auth_user_id
     *    - Redirects to login if no valid session
     * 
     * @example
     * // Called on portal initialization
     * const student = await checkAuthentication();
     * if (student) {
     *   await loadPortal(student);
     * }
     */
    async function checkAuthentication() {
      // ---------- Check for Admin Chat Mode ----------
      const adminChatTokenStr = localStorage.getItem('admin_chat_token') || sessionStorage.getItem('admin_chat_token');
      console.log(' Checking for admin chat token:', adminChatTokenStr ? 'FOUND' : 'NOT FOUND');
      
      if (adminChatTokenStr) {
        try {
          const adminToken = JSON.parse(adminChatTokenStr);
          console.log(' Admin token parsed:', adminToken);
          
          // Check if token is expired
          if (Date.now() > adminToken.expiresAt) {
            console.log(' Admin chat token expired');
            localStorage.removeItem('admin_chat_token');
            sessionStorage.removeItem('admin_chat_token');
          } else {
            console.log(' Admin chat mode activated for:', adminToken.adminEmail);
            console.log(' Returning admin object - SKIPPING student authentication');
            isAdmin = true;
            
            // Return a pseudo student object for admin
            const adminObj = {
              id: 0,
              name: 'Administrator',
              email: adminToken.adminEmail,
              role: 'admin',
              isAdminChatMode: true
            };
            console.log(' Admin object:', adminObj);
            return adminObj;
          }
        } catch (e) {
          console.error(' Error parsing admin chat token:', e);
          localStorage.removeItem('admin_chat_token');
          sessionStorage.removeItem('admin_chat_token');
        }
      }
      
      // Check for impersonation mode first
      const urlParams = new URLSearchParams(window.location.search);
      const impersonateId = urlParams.get('impersonate');
      
      // ---------- Impersonation Authentication ----------
      if (impersonateId) {
        console.log(' Impersonation mode detected for student ID:', impersonateId);
        console.log(' Running in iframe:', window.self !== window.top);
        
        // Try both sessionStorage and localStorage
        let tokenData = sessionStorage.getItem('impersonation_token') || localStorage.getItem('impersonation_token');
        console.log(' Token data found:', tokenData ? 'YES' : 'NO');
        
        if (tokenData) {
          const impersonationToken = JSON.parse(tokenData);
          console.log(' Token parsed:', impersonationToken);
          
          // Validate token hasn't expired
          if (impersonationToken.expiresAt < Date.now()) {
            console.error(' Token expired');
            alert('Impersonation session has expired.');
            sessionStorage.removeItem('impersonation_token');
            localStorage.removeItem('impersonation_token');
            
            // If in iframe, tell parent to close modal
            if (window.self !== window.top) {
              window.parent.postMessage({ action: 'closeImpersonation', reason: 'expired' }, '*');
            } else {
              window.location.href = 'Student-Portal-Admin.html';
            }
            return null;
          }
          
          // Validate student ID matches (convert both to string for comparison)
          if (String(impersonationToken.studentId) !== String(impersonateId)) {
            console.error(' Student ID mismatch!', impersonationToken.studentId, 'vs', impersonateId);
            alert('Invalid impersonation token.');
            sessionStorage.removeItem('impersonation_token');
            localStorage.removeItem('impersonation_token');
            
            // If in iframe, tell parent to close modal
            if (window.self !== window.top) {
              window.parent.postMessage({ action: 'closeImpersonation', reason: 'mismatch' }, '*');
            } else {
              window.location.href = 'Student-Portal-Admin.html';
            }
            return null;
          }
          
          // Load the impersonated student's data
          console.log(' Loading student data for ID:', impersonateId);
          const { data: student, error } = await supabase
            .from('students')
            .select('*')
            .eq('id', impersonateId)
            .single();
          
          if (error || !student) {
            console.error(' Impersonated student not found:', error);
            console.error('Query details - ID:', impersonateId, 'Type:', typeof impersonateId);
            alert('Student not found. Please contact administrator.');
            sessionStorage.removeItem('impersonation_token');
            localStorage.removeItem('impersonation_token');
            
            // If in iframe, tell parent to close modal
            if (window.self !== window.top) {
              window.parent.postMessage({ action: 'closeImpersonation', reason: 'not_found' }, '*');
            } else {
              window.location.href = 'Student-Portal-Admin.html';
            }
            return null;
          }
          
          console.log(' Impersonation authenticated for:', student.name);
          return student;
        } else {
          console.error(' No impersonation token found in sessionStorage or localStorage');
          console.error('SessionStorage keys:', Object.keys(sessionStorage));
          console.error('LocalStorage keys:', Object.keys(localStorage));
          alert('Invalid impersonation session.');
          
          // If in iframe, tell parent to close modal
          if (window.self !== window.top) {
            window.parent.postMessage({ action: 'closeImpersonation', reason: 'no_token' }, '*');
          } else {
            window.location.href = 'Student-Portal-Admin.html';
          }
          return null;
        }
      }
      
      // ---------- Normal Student Authentication ----------
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        // Check if we're in admin chat mode - if so, it's okay to have no session
        const adminChatCheck = localStorage.getItem('admin_chat_token') || sessionStorage.getItem('admin_chat_token');
        if (!adminChatCheck) {
          // No session and no admin token - redirect to login
          window.location.href = 'index.html';
          return null;
        }
        // Admin chat mode is active, continue without student session
        return null;
      }
      
      
      // Get student data
      const { data: studentData, error } = await supabase
        .from('students')
        .select('*')
        .eq('auth_user_id', session.user.id)
        .single();
      
      if (error || !studentData) {
        console.error(' Student not found:', error);
        // Check if admin chat mode before showing error
        const adminChatCheck = localStorage.getItem('admin_chat_token') || sessionStorage.getItem('admin_chat_token');
        if (!adminChatCheck) {
          alert('Your account is not set up correctly. Please contact the administrator.');
          await supabase.auth.signOut();
          window.location.href = 'index.html';
        }
        return null;
      }
      
      // If admin account, redirect to Student Manager
      if (studentData.role === 'admin') {
        window.location.href = 'Student-Manager.html';
        return null;
      }
      
      return studentData;
    }
    
    // Admin credentials for testing
    const ADMIN_EMAIL = 'hrachfilm@gmail.com';
    const ADMIN_PASSWORD = 'Richy1977';
    
    // Google Classroom API Configuration
    const GOOGLE_CLIENT_ID = '503155871883-q4mr96hfcq2vt42acnrve8eini85hpju.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/classroom.courses.readonly https://www.googleapis.com/auth/classroom.announcements.readonly https://www.googleapis.com/auth/classroom.coursework.me.readonly';
    
    // ==========================================================================
    // DEBUG MODE - Set to false for production
    // ==========================================================================
    const DEBUG_MODE = false;
    
    // Wrap console methods to respect DEBUG_MODE
    const debugLog = (...args) => DEBUG_MODE && console.log(...args);
    const debugDebug = (...args) => DEBUG_MODE && console.debug(...args);
    
    let currentStudent = null;
    let currentEmail = null;
    let isAdmin = false;
    let googleAccessToken = null;
    let impersonationMode = false;
    let impersonationToken = null;
    let impersonationTimer = null;
    let countdownInterval = null;
  let currentGroupScheduleData = null;
  let currentGroupScheduleSummary = null;
    let currentPayments = []; // Store payment history globally
    let activeSection = 'overview';
    const sectionLoadedState = {
      overview: false,
      payments: false,
      progress: false,
      materials: false
    };
    let paymentsLoaded = false;
    let paymentsLoadingPromise = null;
    let progressLoaded = false;
    let materialsLoaded = false;
    
    // ==========================================================================
    // GLOBAL INTERVAL MANAGER - PERFORMANCE FIX
    // ==========================================================================
    // Prevents duplicate intervals and ensures proper cleanup
    const intervalManager = {
      intervals: new Map(),
      
      set(name, callback, delay) {
        // Clear existing interval if it exists
        this.clear(name);
        
        // Create new interval
        const id = setInterval(callback, delay);
        this.intervals.set(name, id);
        if (DEBUG_MODE) console.debug(` Interval '${name}' started (${delay}ms)`);
        return id;
      },
      
      clear(name) {
        if (this.intervals.has(name)) {
          clearInterval(this.intervals.get(name));
          this.intervals.delete(name);
          if (DEBUG_MODE) console.debug(` Interval '${name}' cleared`);
        }
      },
      
      clearAll() {
        if (DEBUG_MODE) console.debug(` Clearing all ${this.intervals.size} intervals`);
        this.intervals.forEach((id, name) => {
          clearInterval(id);
          if (DEBUG_MODE) console.debug(`   Cleared '${name}'`);
        });
        this.intervals.clear();
      }
    };
    
    // Clean up all intervals and end session when page unloads
    window.addEventListener('beforeunload', () => {
      intervalManager.clearAll();
      // End session if one was started (not during impersonation)
      if (sessionId) {
        endSession();
      }
    });
    
    // ==========================================================================
    // CUSTOM DIALOG SYSTEM
    // ==========================================================================
    
    function showLockedNoteDialog(classDate) {
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease;
      `;
      
      // Create dialog
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98));
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 24px;
        padding: 32px;
        max-width: 440px;
        width: 90%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
        animation: slideUp 0.3s ease;
      `;
      
      dialog.innerHTML = `
        <div style="text-align: center;">
          <div style="
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), rgba(14, 165, 233, 0.1));
            border: 1px solid rgba(56, 189, 248, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
          "></div>
          
          <h3 style="
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 12px 0;
            letter-spacing: -0.02em;
          ">Note Locked</h3>
          
          <p style="
            color: rgba(255, 255, 255, 0.75);
            font-size: 1rem;
            line-height: 1.6;
            margin: 0 0 28px 0;
          ">
            This note is locked. Please complete payment for <strong style="color: rgba(255, 255, 255, 0.95);">${classDate}</strong> class to unlock.
          </p>
          
          <button id="closeDialogBtn" style="
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.9), rgba(14, 165, 233, 0.9));
            border: 1px solid rgba(56, 189, 248, 0.5);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(56, 189, 248, 0.4)'"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            Got it
          </button>
        </div>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      // Close handlers
      const closeDialog = () => {
        overlay.style.animation = 'fadeOut 0.2s ease';
        setTimeout(() => overlay.remove(), 200);
      };
      
      document.getElementById('closeDialogBtn').addEventListener('click', closeDialog);
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeDialog();
      });
      
      // Add animations
      if (!document.querySelector('#dialogAnimations')) {
        const style = document.createElement('style');
        style.id = 'dialogAnimations';
        style.textContent = `
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
          }
          @keyframes slideUp {
            from { 
              opacity: 0;
              transform: translateY(20px) scale(0.95);
            }
            to { 
              opacity: 1;
              transform: translateY(0) scale(1);
            }
          }
        `;
        document.head.appendChild(style);
      }
    }
    
    // ==========================================================================
    // SCHEDULE HELPER FUNCTIONS
    // ==========================================================================
    // LA Timezone constant
    const LA_TIMEZONE = 'America/Los_Angeles';
    
    // Get current date/time in LA timezone
    function getNowLA() {
      return new Date(new Date().toLocaleString('en-US', { timeZone: LA_TIMEZONE }));
    }
    
    // Normalize day names to full capitalized form
    function normalizeDayName(input) {
      if (!input || typeof input !== 'string') return null;
      const normalized = input.trim().toLowerCase();
      const dayMap = {
        'sun': 'Sunday', 'sunday': 'Sunday',
        'mon': 'Monday', 'monday': 'Monday',
        'tue': 'Tuesday', 'tues': 'Tuesday', 'tuesday': 'Tuesday',
        'wed': 'Wednesday', 'wednesday': 'Wednesday',
        'thu': 'Thursday', 'thur': 'Thursday', 'thurs': 'Thursday', 'thursday': 'Thursday',
        'fri': 'Friday', 'friday': 'Friday',
        'sat': 'Saturday', 'saturday': 'Saturday'
      };
      return dayMap[normalized] || null;
    }
    
    // Normalize time labels to consistent 12-hour format
    function normalizeTimeLabel(input) {
      if (!input || typeof input !== 'string') return '';
      const trimmed = input.trim();
      const match = trimmed.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
      if (!match) return trimmed;
      const hours = match[1];
      const minutes = match[2];
      const meridiem = match[3].toUpperCase();
      return `${hours}:${minutes} ${meridiem}`;
    }
    
    // Convert LA time to Yerevan time with DST awareness
    function convertLAtoYerevan(day, time12) {
      const normalizedDay = normalizeDayName(day) || day || 'Sunday';
      const normalizedTime = normalizeTimeLabel(time12);
      
      // Current month to determine DST
      const currentDate = new Date();
      const month = currentDate.getMonth(); // 0-11
      
      // PST to AMT: +12 hours, PDT to AMT: +11 hours
      const isDST = month >= 2 && month < 10; // Mar-Oct is DST
      const hourDiff = isDST ? 11 : 12;
      
      // Parse 12-hour time
      const timeSource = normalizedTime || time12 || '';
      const timeMatch = timeSource.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
      if (!timeMatch) {
        return { day: normalizedDay, time: timeSource };
      }
      
      let hours = parseInt(timeMatch[1]);
      const minutes = timeMatch[2];
      const meridiem = timeMatch[3].toUpperCase();
      
      // Convert to 24-hour
      if (meridiem === 'PM' && hours !== 12) hours += 12;
      if (meridiem === 'AM' && hours === 12) hours = 0;
      
      // Add hour difference
      hours += hourDiff;
      
      // Day mapping
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const baseDayIndex = days.indexOf(normalizedDay);
      let newDayIndex = baseDayIndex === -1 ? 0 : baseDayIndex;
      
      // Handle day overflow
      if (hours >= 24) {
        hours -= 24;
        newDayIndex = (newDayIndex + 1) % 7;
      } else if (hours < 0) {
        hours += 24;
        newDayIndex = (newDayIndex - 1 + 7) % 7;
      }
      
      // Convert back to 12-hour format
      const newMeridiem = hours >= 12 ? 'PM' : 'AM';
      let displayHours = hours % 12;
      if (displayHours === 0) displayHours = 12;
      
      return {
        day: days[newDayIndex],
        time: `${displayHours}:${minutes} ${newMeridiem}`,
      };
    }
    
    // Convert LA time to Miami time (ET is +3 hours from PT)
    function convertLAtoMiami(day, time12) {
      const normalizedDay = normalizeDayName(day) || day || 'Sunday';
      const normalizedTime = normalizeTimeLabel(time12);
      
      // LA to Miami is always +3 hours
      const hourDiff = 3;
      
      // Parse 12-hour time
      const timeSource = normalizedTime || time12 || '';
      const timeMatch = timeSource.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
      if (!timeMatch) {
        return { day: normalizedDay, time: timeSource };
      }
      
      let hours = parseInt(timeMatch[1]);
      const minutes = timeMatch[2];
      const meridiem = timeMatch[3].toUpperCase();
      
      // Convert to 24-hour
      if (meridiem === 'PM' && hours !== 12) hours += 12;
      if (meridiem === 'AM' && hours === 12) hours = 0;
      
      // Add hour difference
      hours += hourDiff;
      
      // Day mapping
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const baseDayIndex = days.indexOf(normalizedDay);
      let newDayIndex = baseDayIndex === -1 ? 0 : baseDayIndex;
      
      // Handle day overflow
      if (hours >= 24) {
        hours -= 24;
        newDayIndex = (newDayIndex + 1) % 7;
      } else if (hours < 0) {
        hours += 24;
        newDayIndex = (newDayIndex - 1 + 7) % 7;
      }
      
      // Convert back to 12-hour format
      const newMeridiem = hours >= 12 ? 'PM' : 'AM';
      let displayHours = hours % 12;
      if (displayHours === 0) displayHours = 12;
      
      return {
        day: days[newDayIndex],
        time: `${displayHours}:${minutes} ${newMeridiem}`,
      };
    }
    
    // Convert day name to 3-letter abbreviation
    function abbreviateDay(day) {
      // Return full day name instead of abbreviation
      return day;
    }
    
    // Format schedule elegantly (returns HTML string)
    function formatSchedule(scheduleString, oneTimeSchedules = []) {
      const hasRegularSchedule = scheduleString && scheduleString.trim() !== '';
      const hasOneTimeSchedule = oneTimeSchedules && oneTimeSchedules.length > 0;
      
      if (!hasRegularSchedule && !hasOneTimeSchedule) {
        return '<div class="schedule-empty">No schedule set</div>';
      }
      
      const dayOrder = { Monday: 1, Tuesday: 2, Wednesday: 3, Thursday: 4, Friday: 5, Saturday: 6, Sunday: 7 };
      
      const expandSchedulePart = part => {
        if (!part) return [];
        const trimmed = part.trim();
        if (!trimmed) return [];
        
        const timeMatch = trimmed.match(/(\d{1,2}):(\d{2})\s*(?:AM|PM)/i);
        if (timeMatch) {
          const timeValue = normalizeTimeLabel(timeMatch[0]);
          const daySectionRaw = trimmed.slice(0, timeMatch.index).trim();
          const sanitized = daySectionRaw
            .replace(/\band\b/gi, ' ')
            .replace(/\bat\b/gi, ' ')
            .replace(/\bon\b/gi, ' ')
            .trim();
          
          const chunks = sanitized
            .split(/[\/,&]+/)
            .map(token => token.trim())
            .filter(Boolean);
          
          const normalizedDays = [];
          chunks.forEach(chunk => {
            chunk
              .split(/\s+/)
              .map(token => token.trim())
              .filter(Boolean)
              .forEach(token => {
                const normalized = normalizeDayName(token);
                if (normalized) {
                  normalizedDays.push(normalized);
                }
              });
          });
          
          if (normalizedDays.length) {
            return normalizedDays.map(dayName => ({ day: dayName, time: timeValue }));
          }
          
          if (daySectionRaw) {
            return [{ day: daySectionRaw, time: timeValue }];
          }
        }
        
        const fallbackMatch = trimmed.match(/^(\w+)\s+(.+)$/);
        if (fallbackMatch) {
          return [{ day: fallbackMatch[1], time: fallbackMatch[2].trim() }];
        }
        
        return [{ day: trimmed, time: '' }];
      };
      
      // Parse regular schedules
      let parsed = [];
      if (hasRegularSchedule) {
        const parts = scheduleString
          .split(',')
          .map(part => part.trim())
          .filter(Boolean);
        
        parsed = parts
          .reduce((acc, part) => acc.concat(expandSchedulePart(part)), [])
          .map(entry => {
            const laDay = normalizeDayName(entry.day) || entry.day;
            const laTime = normalizeTimeLabel(entry.time);
            const miami = convertLAtoMiami(laDay, laTime);
            const yerevan = convertLAtoYerevan(laDay, laTime);
            
            return {
              day: laDay,
              time: laTime,
              miamiDay: miami.day,
              miamiTime: miami.time,
              yerevanDay: yerevan.day,
              yerevanTime: yerevan.time,
              order: dayOrder[laDay] || 999,
              isOneTime: false,
            };
          })
          .sort((a, b) => a.order - b.order);
      }
      
      // Add one-time schedules
      const oneTimeParsed = (oneTimeSchedules || [])
        .map(schedule => {
          const laDay = normalizeDayName(schedule.day) || schedule.day;
          const laTime = normalizeTimeLabel(schedule.time);
          const miami = convertLAtoMiami(laDay, laTime);
          const yerevan = convertLAtoYerevan(laDay, laTime);
          
          return {
            day: laDay,
            time: laTime,
            date: schedule.date,
            miamiDay: miami.day,
            miamiTime: miami.time,
            yerevanDay: yerevan.day,
            yerevanTime: yerevan.time,
            order: dayOrder[laDay] || 999,
            isOneTime: true,
          };
        })
        .sort((a, b) => a.order - b.order);
      
      // Combine and render
      const allSchedules = [...parsed, ...oneTimeParsed];
      
      return allSchedules
        .map(({ day, time, miamiDay, miamiTime, yerevanDay, yerevanTime, isOneTime, date }) => {
          if (time) {
            const classType = isOneTime ? 'schedule-card one-time' : 'schedule-card';
            const dateLabel = isOneTime ? `<span class="one-time-date"> ${date}</span>` : '';
            
            return `
              <div class="${classType}">
                <div class="time-row">
                  <span class="flag"></span>
                  <span class="day-name">${day}</span>
                  <span class="time-value la-time">${time} LA</span>
                </div>
                
                <div class="time-divider"></div>
                
                <div class="time-row">
                  <span class="flag"></span>
                  <span class="day-name">${miamiDay}</span>
                  <span class="time-value miami-time">${miamiTime} MIA</span>
                </div>
                
                <div class="time-divider"></div>
                
                <div class="time-row">
                  <span class="flag"></span>
                  <span class="day-name">${yerevanDay}</span>
                  <span class="time-value yerevan-time">${yerevanTime}</span>
                </div>
                ${dateLabel}
              </div>`;
          }
          return `<div class="schedule-card">${day}</div>`;
        })
        .join('');
    }

    function buildScheduleSummary(scheduleString, oneTimeSchedules = []) {
      if (scheduleString && typeof scheduleString === 'string' && scheduleString.trim()) {
        return scheduleString.replace(/\s+/g, ' ').trim();
      }
      if (Array.isArray(oneTimeSchedules) && oneTimeSchedules.length > 0) {
        const entries = oneTimeSchedules
          .map(entry => {
            if (!entry) return '';
            const chunks = [];
            if (entry.day) chunks.push(entry.day);
            if (entry.date) chunks.push(entry.date);
            if (entry.time) chunks.push(entry.time);
            return chunks.join(' ').replace(/\s+/g, ' ').trim();
          })
          .filter(Boolean);
        if (entries.length) {
          return entries.join('  ');
        }
      }
      return 'Not scheduled';
    }

    function setProfileScheduleText(text) {
      const el = document.getElementById('modalStudentSchedule');
      if (!el) return;
      const safeText = text == null ? '' : String(text).trim();
      el.textContent = safeText || 'Not scheduled';
    }
    
    // ==========================================================================
    // END SCHEDULE HELPER FUNCTIONS
    // ==========================================================================
    
    // ==========================================================================
    // SCHEDULE DATA LOADING
    // ==========================================================================
    
    /**
     * Normalizes group codes to canonical uppercase single-letter format.
     * 
     * @param {string|number} value - Raw group value (e.g., "Group C", "group a", "B")
     * @returns {string} Normalized uppercase letter (A-F) or empty string
     * 
     * @description
     * Handles various group code formats from database and user input:
     * - Strips "group" prefix (case-insensitive)
     * - Removes all non-alphanumeric characters
     * - Converts to uppercase
     * - Returns first character only
     * 
     * Critical for consistency across modules (Student-Manager, Payment-Records, Calendar).
     * 
     * @example
     * canonicalizeGroupCode("Group C")  //  "C"
     * canonicalizeGroupCode("group a")  //  "A"
     * canonicalizeGroupCode("B")        //  "B"
     * canonicalizeGroupCode(" c ")      //  "C"
     * canonicalizeGroupCode("")         //  ""
     */
    function canonicalizeGroupCode(value) {
      if (!value) return '';
      const raw = value.toString().trim();
      if (!raw) return '';
      let normalized = raw.replace(/^group\s+/i, ''); // Strip "group" prefix
      normalized = normalized.replace(/[^a-z0-9]/gi, ''); // Remove non-alphanumeric
      return normalized.toUpperCase(); // Uppercase
    }
    
    function getStudentGroup(student) {
      if (!student) return null;
      const rawGroup = student.group_name || student.group || null;
      const normalized = canonicalizeGroupCode(rawGroup);
      console.debug(' Student group:', { raw: rawGroup, normalized: normalized });
      return normalized;
    }
    
    // Get group schedule from Supabase
    async function getGroupSchedule(groupName) {
      if (!groupName || !supabase) {
        console.debug(' No groupName or supabase:', { groupName, hasSupabase: !!supabase });
        return null;
      }
      
      try {
        // Normalize group name for consistent lookup
        const normalizedGroup = canonicalizeGroupCode(groupName);
        console.debug(' Looking up group schedule:', { original: groupName, normalized: normalizedGroup });
        
        // Fetch all groups and find the match (more reliable than .eq() with various column names)
        const { data: allGroups, error } = await supabase
          .from('groups')
          .select('*');
        
        if (error) {
          console.error(' Error loading groups:', error);
          return null;
        }
        
        if (!allGroups || allGroups.length === 0) {
          console.debug(' No groups found in database');
          return null;
        }
        
        // Find matching group (check multiple possible fields)
        const matchingGroup = allGroups.find(g => {
          const gCode = canonicalizeGroupCode(g.group_code || g.group_name || g.name || '');
          return gCode === normalizedGroup;
        });
        
        if (!matchingGroup) {
          console.debug(' No matching group found for:', normalizedGroup, 'Available groups:', allGroups.map(g => ({
            group_code: g.group_code,
            group_name: g.group_name,
            name: g.name
          })));
          return null;
        }
        
        console.debug(' Found group schedule:', matchingGroup);
        
        return {
          schedule: matchingGroup.schedule || '',
          one_time_schedules: matchingGroup.one_time_schedules || [],
          updated_at: matchingGroup.updated_at ? new Date(matchingGroup.updated_at) : null
        };
      } catch (e) {
        console.error('Exception loading group schedule:', e);
        return null;
      }
    }
    
    // Compute next class date/time from schedule
    function computeNextClass(schedule) {
      if (!schedule || (!schedule.schedule && !schedule.one_time_schedules?.length)) {
        return null;
      }
      
      const now = getNowLA();
      const currentDay = now.getDay(); // 0 = Sunday, 6 = Saturday
      const currentTime = now.getHours() * 60 + now.getMinutes();
      
      const dayMap = {
        'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
        'Thursday': 4, 'Friday': 5, 'Saturday': 6
      };
      
      let nextClass = null;
      let minDaysDiff = Infinity;
      
      // Parse regular schedule
      if (schedule.schedule && schedule.schedule.trim()) {
        const parts = schedule.schedule.split(',').map(p => p.trim()).filter(Boolean);
        
        parts.forEach(part => {
          const timeMatch = part.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
          if (!timeMatch) return;
          
          const daySection = part.slice(0, timeMatch.index).trim();
          const days = daySection.split(/[\/,&\s]+/).map(d => normalizeDayName(d)).filter(Boolean);
          
          const timeStr = timeMatch[0];
          const timeParsed = timeMatch[0].match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
          if (!timeParsed) return;
          
          let hours = parseInt(timeParsed[1]);
          const minutes = parseInt(timeParsed[2]);
          const meridiem = timeParsed[3].toUpperCase();
          
          // Convert to 24-hour
          if (meridiem === 'PM' && hours !== 12) hours += 12;
          if (meridiem === 'AM' && hours === 12) hours = 0;
          
          const classTimeInMinutes = hours * 60 + minutes;
          
          days.forEach(dayName => {
            const dayIndex = dayMap[dayName];
            if (dayIndex === undefined) return;
            
            let daysDiff = dayIndex - currentDay;
            
            // If class is today but already passed or in progress (within 2 hours of start), move to next week
            const twoHoursInMinutes = 2 * 60; // 120 minutes
            const timeSinceClass = currentTime - classTimeInMinutes;
            if (daysDiff === 0 && timeSinceClass >= 0 && timeSinceClass < twoHoursInMinutes) {
              // Class is currently in progress, skip to next week
              daysDiff = 7;
            } else if (daysDiff === 0 && classTimeInMinutes <= currentTime) {
              // Class already passed (more than 2 hours ago), move to next week
              daysDiff = 7;
            }
            
            // If day is in the past this week, move to next week
            if (daysDiff < 0) {
              daysDiff += 7;
            }
            
            if (daysDiff < minDaysDiff) {
              minDaysDiff = daysDiff;
              
              const nextDate = new Date(now);
              nextDate.setDate(nextDate.getDate() + daysDiff);
              nextDate.setHours(hours, minutes, 0, 0);
              
              nextClass = {
                date: nextDate,
                day: dayName,
                time: timeStr,
                isOneTime: false
              };
            }
          });
        });
      }
      
      // Check one-time schedules
      if (schedule.one_time_schedules && schedule.one_time_schedules.length > 0) {
        schedule.one_time_schedules.forEach(oneTime => {
          if (!oneTime.date || !oneTime.time) return;
          
          const dateParts = oneTime.date.split('-');
          if (dateParts.length !== 3) return;
          
          const timeMatch = oneTime.time.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
          if (!timeMatch) return;
          
          let hours = parseInt(timeMatch[1]);
          const minutes = parseInt(timeMatch[2]);
          const meridiem = timeMatch[3].toUpperCase();
          
          if (meridiem === 'PM' && hours !== 12) hours += 12;
          if (meridiem === 'AM' && hours === 12) hours = 0;
          
          const oneTimeDate = new Date(
            parseInt(dateParts[0]),
            parseInt(dateParts[1]) - 1,
            parseInt(dateParts[2]),
            hours,
            minutes,
            0
          );
          
          // Only consider future one-time classes
          if (oneTimeDate > now) {
            const daysDiff = Math.floor((oneTimeDate - now) / (1000 * 60 * 60 * 24));
            
            if (daysDiff < minDaysDiff) {
              minDaysDiff = daysDiff;
              nextClass = {
                date: oneTimeDate,
                day: oneTime.day,
                time: oneTime.time,
                isOneTime: true
              };
            }
          }
        });
      }
      
      return nextClass;
    }
    
    /**
     * Starts a real-time countdown timer to the next scheduled class.
     * 
     * @param {Date|null} nextClassDate - JavaScript Date object for next class start time
     * @returns {void}
     * 
     * @description
     * Creates an interval that updates every second to display:
     * - Days, hours, minutes, seconds until class starts
     * - "Class in Progress" if class started within last 2 hours
     * - "Class has ended" if more than 2 hours past start time
     * - Empty schedule message if no nextClassDate provided
     * 
     * Uses Los Angeles timezone (America/Los_Angeles) for all calculations.
     * Automatically clears any existing countdown before starting new one.
     * 
     * @example
     * const nextClass = calculateNextClass(schedule);
     * startCountdown(nextClass.date);
     */
    function startCountdown(nextClassDate) {
      // Clear any existing countdown
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      
      if (!nextClassDate) {
        document.getElementById('nextClassTimer').innerHTML = `
          <div class="schedule-empty" style="padding: 20px; margin: 0;">
            No upcoming classes at this time.<br>
            Please check for schedule updates.
          </div>
        `;
        return;
      }
      
      const updateCountdown = () => {
        const countdownEl = document.getElementById('countdownValue');
        if (!countdownEl) return;

        const now = getNowLA();
        const diff = nextClassDate - now;
        
        // Check if class is in progress (started but less than 2 hours ago)
        const twoHours = 2 * 60 * 60 * 1000; // 2 hours in milliseconds
        if (diff < 0 && Math.abs(diff) < twoHours) {
          // Class is in progress - red and blinking
          countdownEl.textContent = 'Class in Progress';
          countdownEl.style.fontSize = '16px';
          countdownEl.style.color = '#ef4444'; // Red color
          countdownEl.style.animation = 'urgentBlink 1.5s ease-in-out infinite';
          countdownEl.style.fontWeight = '700';
          return;
        }
        
        if (diff <= -twoHours) {
          // Class ended more than 2 hours ago, stop countdown
          intervalManager.clear('countdown');
          countdownEl.textContent = 'Check schedule for next class';
          countdownEl.style.fontSize = '14px';
          countdownEl.style.color = 'rgba(255,255,255,0.6)';
          return;
        }
        
        // Class hasn't started yet - show countdown (reset styles)
        const dayMs = 24 * 60 * 60 * 1000;
        const hourMs = 60 * 60 * 1000;
        const minuteMs = 60 * 1000;
        const thirtyMinMs = 30 * 60 * 1000; // 30 minutes
        
        if (diff >= dayMs) {
          // More than 1 day away - show days + hours
          const days = Math.floor(diff / dayMs);
          const hours = Math.floor((diff % dayMs) / hourMs);
          const dayLabel = `${days} day${days === 1 ? '' : 's'}`;
          const hourLabel = `${hours} hour${hours === 1 ? '' : 's'}`;
          countdownEl.textContent = hours > 0 ? `${dayLabel} ${hourLabel}` : dayLabel;
          countdownEl.style.fontSize = '18px';
        } else if (diff >= thirtyMinMs) {
          // Between 30 minutes and 1 day - show hours only, rounded to 30-min increments
          const totalMinutes = Math.floor(diff / minuteMs);
          const roundedMinutes = Math.ceil(totalMinutes / 30) * 30; // Round up to nearest 30 min
          const hours = Math.floor(roundedMinutes / 60);
          const minutes = roundedMinutes % 60;
          
          if (hours > 0 && minutes > 0) {
            countdownEl.textContent = `${hours}h ${minutes}m`;
          } else if (hours > 0) {
            countdownEl.textContent = `${hours}h`;
          } else {
            countdownEl.textContent = `${minutes}m`;
          }
          countdownEl.style.fontSize = '22px';
        } else {
          // Last 30 minutes - show minute-by-minute countdown (no seconds)
          const minutes = Math.floor(diff / minuteMs);
          
          if (minutes > 0) {
            countdownEl.textContent = `${minutes} minute${minutes === 1 ? '' : 's'}`;
          } else {
            countdownEl.textContent = 'Starting soon';
          }
          countdownEl.style.fontSize = '20px';
          countdownEl.style.color = '#fbbf24'; // Amber color for urgency
          countdownEl.style.fontWeight = '600';
        }

        // Reset styles for non-urgent states
        if (diff >= thirtyMinMs) {
          countdownEl.style.color = '';
          countdownEl.style.animation = '';
          countdownEl.style.fontWeight = '';
        }
      };
      
      // Update immediately
      updateCountdown();
      
      // PERFORMANCE FIX: Update every 30 minutes instead of every 1 second
      // Massive CPU savings - countdown doesn't need frequent updates
      intervalManager.set('countdown', updateCountdown, 1800000); // 30 minutes
    }
    
    // Load schedule change announcements
    async function loadChangeNotes(groupName) {
      if (!groupName || !supabase) {
        document.getElementById('announcementsFeed').innerHTML = 
          '<div class="announcement-empty">No announcements at this time.</div>';
        return;
      }
      
      // Normalize group to single letter (A-F)
      const normalizedGroup = groupName.toString().trim().replace(/group\s*/i, '').toUpperCase().charAt(0);
      if (DEBUG_MODE) console.log(' Loading announcements for Group:', normalizedGroup);
      
      try {
        // Fetch both schedule changes AND note announcements
        const [scheduleData, noteData] = await Promise.all([
          supabase
            .from('schedule_changes')
            .select('*')
            .eq('group_name', groupName)
            .order('created_at', { ascending: false })
            .limit(10),
          supabase
            .from('note_assignments')
            .select('id, class_date, template_id')
            .eq('group_id', normalizedGroup)
            .eq('is_open', true)
            .is('deleted_at', null) // FIX: Use deleted_at column
            .order('class_date', { ascending: false })
            .limit(10)
        ]);
        
        if (scheduleData.error) {
          console.error(' Error loading schedule changes:', scheduleData.error);
        }
        
        if (noteData.error) {
          console.error(' Error loading note announcements:', noteData.error);
        }
        
        const scheduleChanges = scheduleData.data || [];
        const noteAnnouncements = noteData.data || [];
        
        // Load templates for announcements
        const announcementTemplateIds = noteAnnouncements
          .map(assignment => assignment.template_id)
          .filter(id => !!id);
        const announcementTemplatesById = {};
        if (announcementTemplateIds.length > 0) {
          const { data: announcementTemplates, error: announcementTemplateError } = await supabase
            .from('note_templates')
            .select(`
              id,
              note_title,
              note_folders (
                folder_name,
                icon
              )
            `)
            .in('id', announcementTemplateIds);
          
          if (announcementTemplateError) {
            console.error(' Error loading announcement templates:', announcementTemplateError);
          } else {
            announcementTemplates?.forEach(template => {
              announcementTemplatesById[template.id] = template;
            });
          }
        }
        
        if (DEBUG_MODE) console.log(` Found ${scheduleChanges.length} schedule changes and ${noteAnnouncements.length} note announcements`);
        
        // Combine and sort by date
        const allAnnouncements = [];
        
        // Add schedule changes
        scheduleChanges.forEach(note => {
          const type = note.change_type || 'general';
          let icon = '';
          let className = 'announcement-item';
          
          if (type.includes('cancel')) {
            className += ' cancelation';
            icon = '';
          } else if (type.includes('reschedule') || type.includes('move')) {
            className += ' reschedule';
            icon = '';
          } else if (type.includes('new') || type.includes('add')) {
            className += ' new-class';
            icon = '';
          } else if (type.includes('permanent') || type.includes('change')) {
            className += ' permanent-change';
            icon = '';
          }
          
          allAnnouncements.push({
            date: new Date(note.created_at),
            className,
            icon,
            text: note.message || note.description || 'Schedule update'
          });
        });
        
        // Add note announcements
        noteAnnouncements.forEach(assignment => {
          const template = announcementTemplatesById[assignment.template_id];
          const folder = template?.note_folders;
          
          // Skip if template is null (broken foreign key)
          if (!template) {
            console.warn(' Skipping announcement with missing template:', assignment.id);
            return;
          }
          
          allAnnouncements.push({
            date: new Date(assignment.class_date),
            className: 'announcement-item new-class',
            icon: folder?.icon || '',
            text: `Richy Festa added ${template?.note_title || 'New Note'} in ${folder?.folder_name || 'General'}`
          });
        });
        
        // Sort by date (newest first)
        allAnnouncements.sort((a, b) => b.date - a.date);
        
        // Take top 15
        const recentAnnouncements = allAnnouncements.slice(0, 15);
        
        if (recentAnnouncements.length === 0) {
          document.getElementById('announcementsFeed').innerHTML = 
            '<div class="announcement-empty">No announcements at this time.</div>';
          return;
        }
        
        // Render announcements
        const html = recentAnnouncements.map(announcement => {
          const createdDate = announcement.date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
          });
          
          return `
            <div class="${announcement.className}">
              <span class="announcement-icon">${announcement.icon}</span>
              <div style="flex: 1;">
                <div class="announcement-text">${announcement.text}</div>
                <div class="announcement-date">Posted ${createdDate}</div>
              </div>
            </div>
          `;
        }).join('');
        
        document.getElementById('announcementsFeed').innerHTML = html;
      } catch (e) {
        console.error('Exception loading announcements:', e);
        document.getElementById('announcementsFeed').innerHTML = 
          '<div class="announcement-empty">Unable to load announcements.</div>';
      }
    }
    
    // ============================================================
    // END SCHEDULE DATA LOADING FUNCTIONS
    // ============================================================
    
    // Initialize app - Check authentication
    (async function() {
      try {
        // CHECK FOR ADMIN CHAT MODE FIRST - Skip this entire flow if admin chat is active
        const adminChatTokenStr = localStorage.getItem('admin_chat_token') || sessionStorage.getItem('admin_chat_token');
        if (adminChatTokenStr) {
          console.log(' Admin chat mode detected - skipping normal authentication flow');
          return; // Exit early, let initPortal() handle admin chat mode
        }
        
        // SECURITY: Hide Portal Admin button by default for all users
        // Only show it if user is verified admin from admin_accounts table
        const portalBtn = document.getElementById('portalAdminBtn');
        if (portalBtn) {
          portalBtn.style.display = 'none';
        }
        
        // Check for impersonation mode first
        const urlParams = new URLSearchParams(window.location.search);
        const impersonateId = urlParams.get('impersonate');
        
        console.debug(' Checking impersonation mode:', { impersonateId });
        
        if (impersonateId) {
          // Load impersonation token from sessionStorage
          const tokenData = sessionStorage.getItem('impersonation_token');
          
          console.debug(' Impersonation token from sessionStorage:', tokenData);
          
          if (tokenData) {
            impersonationToken = JSON.parse(tokenData);
            
            console.debug(' Parsed impersonation token:', impersonationToken);
            
            // Validate token hasn't expired
            if (impersonationToken.expiresAt < Date.now()) {
              alert('Impersonation session has expired. Returning to admin panel.');
              exitImpersonation();
              return;
            }
            
            // Validate student ID matches
            if (impersonationToken.studentId != impersonateId) {
              console.error(' Student ID mismatch!', { 
                tokenStudentId: impersonationToken.studentId, 
                urlStudentId: impersonateId 
              });
              alert('Invalid impersonation token. Returning to admin panel.');
              exitImpersonation();
              return;
            }
            
            // Enable impersonation mode
            impersonationMode = true;
            
            console.debug(' Loading student with ID:', impersonateId);
            
            // Load the impersonated student's data
            const { data: student, error } = await supabase
              .from('students')
              .select('*')
              .eq('id', impersonateId)
              .single();
            
            console.debug(' Loaded student:', student);
            
            if (error || !student) {
              console.error('Impersonated student not found:', error);
              alert('Student not found. Returning to admin panel.');
              exitImpersonation();
              return;
            }
            
            currentStudent = student;
            currentEmail = student.email; // Use student's email for all queries
            
            // Keep banner name in sync with actual record (prevents stale names)
            impersonationToken.studentName = student.name || impersonationToken.studentName;
            impersonationToken.studentId = student.id;
            sessionStorage.setItem('impersonation_token', JSON.stringify(impersonationToken));
            
            // Show impersonation banner
            showImpersonationBanner(impersonationToken);
            
            // Add impersonating class to body
            document.body.classList.add('impersonating');
            
            // FORCE HIDE admin buttons during impersonation
            const portalBtn = document.getElementById('portalAdminBtn');
            if (portalBtn) {
              portalBtn.style.display = 'none';
              portalBtn.disabled = true;
            }
            
            await loadPortalData();
            return;
          } else {
            alert('No valid impersonation token found. Returning to admin panel.');
            exitImpersonation();
            return;
          }
        }
        
        // ---------- Admin Detection & Verification ----------
        // Normal authentication flow (non-impersonation)
        // Check if user is authenticated via Supabase Auth
        const { data: { session } } = await supabase.auth.getSession();
        
        if (session && session.user) {
          currentEmail = session.user.email;
          
          // First, try to find student record by email
          const { data: studentRecord, error: studentError } = await supabase
            .from('students')
            .select('*')
            .eq('email', currentEmail)
            .single();
          
          // Check if admin by verifying against admin_accounts table
          const { data: adminAccounts, error: adminError } = await supabase
            .from('admin_accounts')
            .select('*')
            .eq('email', currentEmail)
            .maybeSingle(); // Use maybeSingle() instead of single() - returns null if not found
          
          // Determine if user is admin
          // Admin must be in admin_accounts table AND not have a student record
          const isAdminUser = adminAccounts && !adminError && !studentRecord;
          
          if (isAdminUser) {
            isAdmin = true;
            
            // Show Portal Admin button for admin
            const portalBtn = document.getElementById('portalAdminBtn');
            if (portalBtn) {
              portalBtn.style.display = 'flex';
            }
            
            // For admin, load any student (can be selected later)
            // For now, load first student as default
            const { data: students, error } = await supabase
              .from('students')
              .select('*')
              .limit(1)
              .single();
            
            if (error) {
              console.error('Error loading student data:', error);
              alert('No students found in database');
              return;
            }
            
            currentStudent = students;
            await loadPortalData();
          } else if (studentRecord) {
            // Regular student login - must have student record
            isAdmin = false;
            
            // FORCE HIDE admin buttons for students
            const portalBtn = document.getElementById('portalAdminBtn');
            if (portalBtn) {
              portalBtn.style.display = 'none';
              portalBtn.remove(); // Remove from DOM entirely for security
            }
            
            currentStudent = studentRecord;
            await loadPortalData();
          } else {
            // No student record and not admin - deny access
            console.error('Access denied - no student or admin record found for:', currentEmail);
            await supabase.auth.signOut();
            window.location.href = 'index.html';
            return;
          }
        } else {
          // No session - redirect to login
          window.location.href = 'index.html';
        }
      } catch (error) {
        console.error('Authentication error:', error);
        window.location.href = 'index.html';
      }
    })();
    
    /**
     * Main portal data loader - orchestrates loading all student dashboard data.
     * 
     * @async
     * @returns {Promise<void>}
     * 
     * @description
     * OPTIMIZED LOADING STRATEGY:
     * 1. Validates currentStudent exists
     * 2. Shows basic student info IMMEDIATELY (name, welcome message)
     * 3. Loads everything else IN PARALLEL (non-blocking):
     *    - Payment history
     *    - Classroom notes
     *    - Systems progress
     * 
     * This ensures students see the page instantly and can access Practice Tests
     * while data loads in the background.
     * 
     * Handles errors by signing out user and redirecting to login.
     * 
     * @throws {Error} If student data unavailable or database queries fail
     * 
     * @example
     * // Called after successful authentication
     * await loadPortalData();
     */
    async function loadPortalData() {
      try {
        // Skip loading portal data if in admin chat mode
        if (currentStudent && currentStudent.isAdminChatMode) {
          console.log(' Admin chat mode - skipping portal data load');
          return;
        }
        
        // Check if currentStudent exists
        if (!currentStudent || !currentStudent.id) {
          console.error(' No student data available');
          await supabase.auth.signOut();
          window.location.href = 'index.html';
          return;
        }
        
        // PHASE 1: Show basic student info IMMEDIATELY (non-blocking)
        showBasicStudentInfo(currentStudent);
        
        // PHASE 2: Load ALL sections at once (no lazy loading, all in one page)
        await Promise.all([
          loadScheduleForStudent(currentStudent),
          loadPaymentsSection(),
          loadProgressSection(),
          loadMaterialsSection()
        ]);
        
        // Mark all sections as loaded
        sectionLoadedState.overview = true;
        sectionLoadedState.payments = true;
        sectionLoadedState.progress = true;
        sectionLoadedState.materials = true;
        
      } catch (error) {
        console.error('Critical error loading portal:', error);
        // Sign out and redirect only on critical failures
        await supabase.auth.signOut();
        window.location.href = 'index.html';
      }

      // AUTO-REFRESH payments every 30 seconds to show new payments immediately
      setInterval(async () => {
        try {
          await refreshPaymentsData();
        } catch (error) {
          console.warn('Failed to auto-refresh payments:', error);
        }
      }, 30000); // 30 seconds
    }
    
    /**
     * Shows basic student info immediately without waiting for database queries.
     * This makes the page feel instant and interactive.
     */
    function showBasicStudentInfo(student) {
      // Update welcome message immediately
      const welcomeMessage = document.getElementById('welcomeMessage');
      if (welcomeMessage) {
        welcomeMessage.innerHTML = `
          <span class="title-line">Welcome,</span>
          <span class="name-line">Nurse ${student.name}</span>
        `;
        welcomeMessage.style.opacity = '1';
      }
      
      // Show loading state for stats
      document.getElementById('lastPaid').textContent = '...';
      document.getElementById('lastPaidDate').textContent = 'Loading';
      document.getElementById('totalUnpaid').textContent = '...';
    }
    
    // ==========================================================================
    // PAYMENT FUNCTIONS
    // ==========================================================================
    
    // ---------- Mock Payment Generator ----------
    // Generate mock payment history
    function generateMockPayments() {
      const payments = [];
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear();
      const currentMonth = currentDate.getMonth();
      
      // Generate 12 months of payment history
      for (let i = 0; i < 12; i++) {
        const month = currentMonth - i;
        const year = month < 0 ? currentYear - 1 : currentYear;
        const adjustedMonth = month < 0 ? 12 + month : month;
        
        // 2-4 classes per month
        const classesPerMonth = 2 + Math.floor(Math.random() * 3);
        for (let j = 0; j < classesPerMonth; j++) {
          const day = 5 + (j * 7);
          if (day <= 28) {
            const date = new Date(year, adjustedMonth, day);
            const rand = Math.random();
            
            let status, amount;
            if (rand > 0.85) {
              status = 'absent';
              amount = 0;
            } else if (rand > 0.75) {
              status = 'unpaid';
              amount = 50;
            } else {
              status = 'paid';
              amount = 50;
            }
            
            payments.push({ date, status, amount, day });
          }
        }
      }
      
      return payments.sort((a, b) => b.date - a.date);
    }
    
    // ---------- Payment History Loader ----------
    /**
     * Loads payment history from Supabase by querying multiple tables.
     * 
     * @async
     * @param {Object} student - Student object containing id, name, email, and aliases
     * @param {number} student.id - Primary student ID
     * @param {string} student.name - Student's full name
     * @param {string} student.email - Student's email address
     * @param {Array<string>} [student.aliases] - Alternative names for matching payments
     * 
     * @returns {Promise<Array<Object>>} Array of payment objects sorted by date (newest first)
     * 
     * @description
     * Aggregates payments from THREE sources:
     * 1. **payment_records table**: Manual entries linked by student_id
     * 2. **payments table (by linked_student_id)**: Zelle/automated payments with explicit link
     * 3. **payments table (by name matching)**: Payments matched via resolved_student_name and aliases
     * 
     * Each payment object contains: { date, status, amount, source, id }
     * Status values: 'paid', 'unpaid', 'pending', 'cancelled', 'absent'
     * 
     * @example
     * const payments = await loadPaymentHistory(currentStudent);
     * // Returns: [{ date: Date, status: 'paid', amount: 50, source: 'payment_records', id: 123 }, ...]
     */
    async function loadPaymentHistory(student) {
      console.debug('Loading payment history for student:', {
        id: student.id,
        name: student.name,
        email: student.email,
        aliases: student.aliases,
        group: student.group_name || student.group
      });
      
      try {
        const allPayments = [];
        
        // 1. Query payment_records table (manual tracking by student_id)
        // PERFORMANCE FIX: Wrap in try-catch to handle RLS permission errors gracefully
        let paymentRecords = [];
        try {
          const { data, error: recordsError } = await supabase
            .from('payment_records')
            .select('*')
            .eq('student_id', student.id)
            .order('date', { ascending: false });
          
          if (recordsError) {
            // RLS permission error expected for students - skip silently
            console.debug(' Payment records not accessible (expected for students)');
          } else if (data && data.length > 0) {
            paymentRecords = data;
          }
        } catch (err) {
          // Ignore permission errors
          console.debug(' Payment records query failed (expected for students)');
        }
        
        if (paymentRecords.length > 0) {
          const records = paymentRecords.map(record => ({
            date: new Date(record.date),
            status: record.status || 'unpaid',
            amount: parseFloat(record.amount) || 0,
            payment_method: record.payment_method,
            notes: record.notes,
            id: record.id,
            source: 'manual'
          }));
          allPayments.push(...records);
        }
        
        // 2. Query payments table (Zelle emails) - ULTRA-BROAD MATCHING

        // Build comprehensive search patterns
        const nameParts = (student.name || '').split(/\s+/).filter(Boolean);
        const payerNameLike = nameParts.length ? `%${nameParts.join('%')}%` : `%${student.name || ''}%`;
        const studentNameLike = payerNameLike; // Same pattern for student_name field
        
        // Parse student emails (could be array or string) - SAFELY
        let studentEmails = [];
        if (Array.isArray(student.email)) {
          studentEmails = student.email.filter(e => e && typeof e === 'string' && e.trim().length > 0);
        } else if (student.email && typeof student.email === 'string' && student.email.trim()) {
          // Check if it's a JSON array string
          const emailStr = student.email.trim();
          if (emailStr.startsWith('[') && emailStr.endsWith(']')) {
            try {
              const parsed = JSON.parse(emailStr);
              studentEmails = Array.isArray(parsed) ? parsed.filter(e => e && typeof e === 'string' && e.trim().length > 0) : [emailStr];
            } catch {
              studentEmails = [emailStr];
            }
          } else {
            studentEmails = [emailStr];
          }
        }
        
        // Parse student aliases (could be array or string) - SAFELY
        let studentAliases = [];
        if (Array.isArray(student.aliases)) {
          studentAliases = student.aliases.filter(a => a && typeof a === 'string' && a.trim().length > 0);
        } else if (student.aliases && typeof student.aliases === 'string' && student.aliases.trim()) {
          const aliasStr = student.aliases.trim();
          if (aliasStr.startsWith('[') && aliasStr.endsWith(']')) {
            try {
              const parsed = JSON.parse(aliasStr);
              studentAliases = Array.isArray(parsed) ? parsed.filter(a => a && typeof a === 'string' && a.trim().length > 0) : [aliasStr];
            } catch {
              studentAliases = [aliasStr];
            }
          } else {
            studentAliases = [aliasStr];
          }
        }
        
        
        // OPTIMIZED: Single query with OR conditions instead of multiple queries
        let paymentsQuery = supabase
          .from('payments')
          .select('*')
          .or(`linked_student_id.eq.${student.id},student_id.eq.${student.id}`)
          .order('email_date', { ascending: false });

        const { data: zellePayments, error: zelleError } = await paymentsQuery;

        if (zelleError) {
          console.error('Error loading Zelle payments:', zelleError);
        } else if (zellePayments && zellePayments.length > 0) {
          console.log(` Loaded ${zellePayments.length} Zelle payments from database`);
          zellePayments.forEach((p, i) => {
            console.log(`  Payment ${i+1}: date="${p.date}", email_date="${p.email_date}", payer="${p.payer_name}", amount=$${p.amount}`);
          });
          
          const zelle = zellePayments.map(payment => {
            // Extract just YYYY-MM-DD portion in case Supabase returns timestamptz format
            const dateStr = payment.date ? payment.date.substring(0, 10) : null;
            // Use 'date' field (YYYY-MM-DD string) instead of 'email_date' (timestamp) to avoid timezone issues
            const paymentDate = dateStr ? new Date(dateStr + 'T00:00:00') : new Date(payment.email_date);
            console.log(`   Converted date "${payment.date}" (extracted: "${dateStr}") to JavaScript Date: ${paymentDate.toLocaleDateString()}`);
            return {
              date: paymentDate,
              status: 'paid', // Zelle payments are always paid
              amount: parseFloat(payment.amount) || 0,
              payment_method: 'Zelle',
              notes: payment.payer_name ? `From: ${payment.payer_name}` : payment.memo,
              id: payment.id,
              source: 'zelle'
            };
          });
          allPayments.push(...zelle);
        }
        
        // 3. Query credit_payments table (payments applied from student credit balance)
        const { data: creditPayments, error: creditError } = await supabase
          .from('credit_payments')
          .select('*')
          .eq('student_id', student.id)
          .order('class_date', { ascending: false });
          
        if (creditError) {
          console.error('Error loading credit payments:', creditError);
        } else {
          console.debug(` Raw credit_payments from database:`, creditPayments);
          if (creditPayments && creditPayments.length > 0) {
            const credits = creditPayments.map(payment => ({
              date: new Date(payment.class_date),
              status: 'paid',
              amount: parseFloat(payment.amount) || 0,
              payment_method: 'Credit Balance',
              notes: payment.balance_after != null ? `Balance after: $${payment.balance_after}` : null,
              id: payment.id,
              source: 'credit' // Mark as credit payment for orange badge
            }));
            allPayments.push(...credits);
            console.debug(` Loaded ${credits.length} credit payments:`, credits.map(c => ({ date: c.date.toISOString().split('T')[0], amount: c.amount })));
          } else {
            console.debug(' No credit payments found in database for this student');
          }
        }
        
        // Sort all payments by date (most recent first)
        allPayments.sort((a, b) => b.date - a.date);
        
        // ---------- DEDUPLICATION: Remove duplicate payments for same date ----------
        // IMPORTANT: Credit payments are NEVER deduplicated (they're separate transactions)
        // Only deduplicate Zelle/manual payments if they match on the same day
        const deduplicatedPayments = [];
        const seenDates = new Map(); // Track date -> payment mapping (excluding credits)
        
        for (const payment of allPayments) {
          const dateKey = payment.date.toISOString().split('T')[0]; // YYYY-MM-DD format
          
          //  ALWAYS include credit payments (don't deduplicate)
          if (payment.source === 'credit') {
            deduplicatedPayments.push(payment);
            continue;
          }
          
          if (!seenDates.has(dateKey)) {
            // First payment for this date - add it
            deduplicatedPayments.push(payment);
            seenDates.set(dateKey, payment);
          } else {
            // Duplicate date found - keep manual record over zelle if both exist
            const existing = seenDates.get(dateKey);
            if (payment.source === 'manual' && existing.source === 'zelle') {
              // Replace zelle with manual record (manual is more authoritative)
              const index = deduplicatedPayments.indexOf(existing);
              if (index !== -1) {
                deduplicatedPayments[index] = payment;
                seenDates.set(dateKey, payment);
              }
            }
            // Otherwise skip this duplicate
            console.debug(` Skipping duplicate payment for ${dateKey}:`, {
              kept: existing.source,
              skipped: payment.source,
              amount: payment.amount
            });
          }
        }
        
        console.debug(' Total payments found:', {
          manual: paymentRecords?.length || 0,
          zelle: zellePayments?.length || 0,
          credit: creditPayments?.length || 0,
          totalBeforeDedup: allPayments.length,
          totalAfterDedup: deduplicatedPayments.length,
          duplicatesRemoved: allPayments.length - deduplicatedPayments.length,
          firstPayment: deduplicatedPayments[0]
        });
        
        return deduplicatedPayments;
        
      } catch (error) {
        console.error('Exception loading payment history:', error);
        return [];
      }
    }
    
    /**
     *  Calculate unpaid classes based on student's schedule
     * This matches the Calendar's red dot logic - counts PAST classes without payment
     * 
     * @param {Object} student - Student object with group_name, price_per_class, start_date
     * @param {Array} payments - Array of payment records
     * @param {Object} groupSchedule - Group schedule with days array
     * @returns {Object} { unpaidAmount, unpaidClasses: [] }
     */
    async function calculateUnpaidFromSchedule(student, payments, groupScheduleData) {
      console.debug(' Calculating unpaid classes from schedule:', {
        student: student.name,
        groupScheduleData: groupScheduleData,
        payments: payments.length
      });
      
      if (!student.group_name || !groupScheduleData || !groupScheduleData.schedule) {
        console.debug(' No schedule data to calculate unpaid classes');
        return { unpaidAmount: 0, unpaidClasses: [] };
      }
      
      const pricePerClass = parseFloat(student.price_per_class) || 50;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Get student start date (when they joined)
      let studentStartDate = null;
      if (student.start_date) {
        studentStartDate = new Date(student.start_date);
        studentStartDate.setHours(0, 0, 0, 0);
      }
      
      // Fetch absences data for this student
      let absences = [];
      try {
        const { data, error } = await supabase
          .from('student_absences')
          .select('*')
          .eq('student_id', student.id);
        
        if (!error && data) {
          // Extract just YYYY-MM-DD portion to match scheduled date format
          absences = data.map(a => a.class_date ? a.class_date.substring(0, 10) : a.class_date);
          console.debug(` Loaded ${absences.length} absences for student:`, absences);
          console.debug(` Raw absence data:`, data);
        } else if (error) {
          console.debug(' Error loading absences:', error);
        }
      } catch (err) {
        console.debug(' Could not load absences:', err);
      }
      
      // Fetch credit_payments to see which classes were paid via credit
      let creditPayments = [];
      try {
        const { data, error } = await supabase
          .from('credit_payments')
          .select('*')
          .eq('student_id', student.id);
        
        if (!error && data) {
          // Extract just YYYY-MM-DD portion to match scheduled date format
          creditPayments = data.map(cp => cp.class_date ? cp.class_date.substring(0, 10) : cp.class_date);
        }
      } catch (err) {
        console.debug(' Could not load credit payments:', err);
      }
      
      // Fetch skipped_classes to exclude cancelled classes from schedule
      let skippedClassDates = [];
      try {
        const { data, error } = await supabase
          .from('skipped_classes')
          .select('*')
          .eq('group_name', student.group_name || student.group);
        
        if (!error && data) {
          // Extract just YYYY-MM-DD portion to match scheduled date format
          skippedClassDates = data.map(sc => sc.class_date ? sc.class_date.substring(0, 10) : sc.class_date);
          console.debug(` Loaded ${skippedClassDates.length} skipped classes for group:`, skippedClassDates);
        }
      } catch (err) {
        console.debug(' Could not load skipped classes:', err);
      }
      
      // Parse schedule string to extract active days
      // Format: "Monday, Wednesday, Friday at 7:00 PM" or "Tue, Thu 6:30 PM"
      const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const scheduleActiveDays = [];
      
      const scheduleStr = groupScheduleData.schedule || '';
      console.debug(' Parsing schedule string:', scheduleStr);
      
      // Extract day names from schedule string
      const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const fullDayMap = {
        'Mon': 'Monday', 'Tue': 'Tuesday', 'Wed': 'Wednesday',
        'Thu': 'Thursday', 'Fri': 'Friday', 'Sat': 'Saturday', 'Sun': 'Sunday'
      };
      
      dayNames.forEach(dayName => {
        if (scheduleStr.includes(dayName)) {
          const fullDay = fullDayMap[dayName] || dayName;
          if (!scheduleActiveDays.includes(fullDay)) {
            scheduleActiveDays.push(fullDay);
          }
        }
      });
      
      console.debug(' Active schedule days:', scheduleActiveDays);
      
      if (scheduleActiveDays.length === 0) {
        console.debug(' No active days found in schedule');
        return { unpaidAmount: 0, unpaidClasses: [] };
      }
      
      // Generate all past class dates based on schedule
      const scheduledDates = [];
      
      //  START FROM DECEMBER 1, 2025 (as requested)
      const dec1_2025 = new Date('2025-12-01');
      dec1_2025.setHours(0, 0, 0, 0);
      
      // ALWAYS use the LATER of: Dec 1 2025 or student start date
      // This ensures we never count unpaid before Dec 1, even if student started earlier
      const startDate = new Date(Math.max(dec1_2025.getTime(), studentStartDate ? studentStartDate.getTime() : dec1_2025.getTime()));
      
      console.debug(` Calculating unpaid classes from ${startDate.toISOString().split('T')[0]} to today`);
      
      // Generate all scheduled class dates until today
      for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
        const dayName = daysOfWeek[d.getDay()];
        // Use local date format instead of UTC to avoid timezone shift
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        console.debug(` Checking ${dateStr} (${dayName}, day#${d.getDay()}) - in schedule? ${scheduleActiveDays.includes(dayName)}`);
        if (scheduleActiveDays.includes(dayName)) {
          // Skip if this class was cancelled/skipped in the Calendar
          if (!skippedClassDates.includes(dateStr)) {
            scheduledDates.push(dateStr);
            console.debug(` Added ${dateStr} as scheduled class`);
          } else {
            console.debug(` ${dateStr}: Class was skipped/cancelled in Calendar`);
          }
        }
      }
      
      console.debug(` Generated ${scheduledDates.length} scheduled class dates (after excluding ${skippedClassDates.length} skipped classes)`);
      
      // Check each scheduled date for payment status
      const unpaidClasses = [];
      const absentClasses = []; // Track absent classes for display
      for (const dateStr of scheduledDates) {
        console.debug(` Checking date ${dateStr} against absences:`, absences, `includes? ${absences.includes(dateStr)}`);
        // Mark if absent (show in payment history but don't count as unpaid)
        if (absences.includes(dateStr)) {
          console.debug(` ${dateStr}: Student was absent (no payment expected)`);
          absentClasses.push({
            date: dateStr,
            amount: 0, // No payment expected for absences
            status: 'absent'
          });
          continue;
        }
        
        // Skip if paid via credit
        if (creditPayments.includes(dateStr)) {
          console.debug(` ${dateStr}: Paid via credit`);
          continue;
        }
        
        // Check if there's a payment covering this class
        const classDate = new Date(dateStr);
        const hasPaidPayment = payments.some(p => {
          if (p.status !== 'paid') return false;
          const paymentDate = new Date(p.date);
          
          // Payment must be on or after class date (Calendar logic)
          // Payment applies to nearest PAST class
          const daysDiff = Math.floor((paymentDate - classDate) / (1000 * 60 * 60 * 24));
          return daysDiff >= 0 && daysDiff <= 7; // Within a week after class
        });
        
        if (!hasPaidPayment) {
          unpaidClasses.push({
            date: dateStr,
            amount: pricePerClass
          });
          console.debug(` ${dateStr}: UNPAID (no payment found)`);
        } else {
          console.debug(` ${dateStr}: PAID`);
        }
      }
      
      const unpaidAmount = unpaidClasses.length * pricePerClass;
      console.debug(` Total unpaid: $${unpaidAmount} (${unpaidClasses.length} classes  $${pricePerClass})`);
      console.debug(` Total absent: ${absentClasses.length} classes`);
      
      return { unpaidAmount, unpaidClasses, absentClasses };
    }
    
    // Load student payment UI only when needed
    async function updatePaymentUI(payments = [], student = null, groupSchedule = null) {
      let totalUnpaid = 0;
      let lastPaidAmount = 0;
      let lastPaidDate = null;
      let unpaidClasses = []; // Track individual unpaid class dates
      let absentClasses = []; // Track absent class dates
      const studentMarkedAbsent = (() => {
        if (!student) return false;
        const normalizeStatus = (value) => typeof value === 'string' ? value.trim().toLowerCase() : '';
        const normalizeBooleanLike = (value) => {
          if (value === true) return true;
          if (typeof value === 'string') {
            const normalized = value.trim().toLowerCase();
            return ['true', 'absent', 'yes', 'on'].includes(normalized);
          }
          return false;
        };
        return (
          normalizeBooleanLike(student.absent) ||
          normalizeStatus(student.status) === 'absent' ||
          normalizeStatus(student.attendance_status) === 'absent' ||
          normalizeStatus(student.lifecycle_status) === 'absent' ||
          normalizeStatus(student.current_status) === 'absent'
        );
      })();

      const numericBalance = student ? Number(student.balance) : NaN;
      const pricePerClassValue = student ? (parseFloat(student.price_per_class) || 50) : 50;
      
      //  ENHANCED: Calculate unpaid from schedule (matches Calendar red dots)
      if (student && groupSchedule) {
        const result = await calculateUnpaidFromSchedule(student, payments, groupSchedule);
        totalUnpaid = result.unpaidAmount;
        unpaidClasses = result.unpaidClasses; // Capture unpaid class dates
        absentClasses = result.absentClasses || []; // Capture absent class dates
        console.debug(` Schedule-based unpaid calculation: $${result.unpaidAmount} (${unpaidClasses.length} classes)`);
        console.debug(` Absent classes: ${absentClasses.length}`);

        // Return the calculated unpaid amount - students should always see unpaid classes
        result.unpaidAmount = totalUnpaid;
        result.unpaidClasses = unpaidClasses;
        result.absentClasses = absentClasses;

      } else {
        // Fallback: Calculate from payment_records table only
        console.debug(' Using fallback payment_records calculation (no schedule data)');
        payments.forEach(payment => {
          const amount = parseFloat(payment.amount) || 0;
          if (payment.status === 'unpaid' || payment.status === 'pending') {
            totalUnpaid += amount;
          }
        });
      }

      if (studentMarkedAbsent && (totalUnpaid > 0 || unpaidClasses.length > 0)) {
        console.debug(' Student marked absent  clearing unpaid totals from portal view.');
        totalUnpaid = 0;
        unpaidClasses = [];
      }
      
      // Calculate last paid
      payments.forEach(payment => {
        const amount = parseFloat(payment.amount) || 0;
        if (payment.status === 'paid') {
          if (!lastPaidDate || payment.date > lastPaidDate) {
            lastPaidDate = payment.date;
            lastPaidAmount = amount;
          }
        }
      });
      
      let lastPaidDateText = '-';
      if (lastPaidDate) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const paymentDate = new Date(lastPaidDate);
        paymentDate.setHours(0, 0, 0, 0);
        
        if (paymentDate.getTime() === today.getTime()) {
          lastPaidDateText = 'Today';
        } else if (paymentDate.getTime() === yesterday.getTime()) {
          lastPaidDateText = 'Yesterday';
        } else {
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          lastPaidDateText = `${monthNames[lastPaidDate.getMonth()]} ${lastPaidDate.getDate()}`;
        }
      }
      
      document.getElementById('lastPaid').textContent = `$${lastPaidAmount.toFixed(0)}`;
      document.getElementById('lastPaidDate').textContent = lastPaidDateText;
      document.getElementById('totalUnpaid').textContent = `$${totalUnpaid.toFixed(0)}`;

      const creditCardEl = document.getElementById('creditCard');
      const creditValueEl = document.getElementById('creditBalance');
      const creditNoteEl = document.getElementById('creditNote');
      if (creditCardEl && creditValueEl) {
        if (Number.isFinite(numericBalance) && numericBalance > 0) {
          creditValueEl.textContent = `$${numericBalance.toFixed(0)}`;
          if (creditNoteEl) {
            const classesCovered = pricePerClassValue > 0 ? numericBalance / pricePerClassValue : 0;
            if (classesCovered >= 1) {
              const rounded = classesCovered >= 2 ? Math.round(classesCovered) : Math.round(classesCovered * 10) / 10;
              const label = rounded === 1 ? 'class' : 'classes';
              creditNoteEl.textContent = `${rounded} ${label} covered`;
            } else {
              creditNoteEl.textContent = 'Extra payment available';
            }
          }
          creditCardEl.style.display = 'flex';
          creditCardEl.classList.add('credit-active');
        } else {
          creditCardEl.style.display = 'none';
          creditCardEl.classList.remove('credit-active');
        }
      }
      
      // Update absences card
      const absencesCardEl = document.getElementById('absencesCard');
      const absencesCountEl = document.getElementById('absencesCount');
      const absencesNoteEl = document.getElementById('absencesNote');
      if (absencesCardEl && absencesCountEl) {
        const totalAbsences = (absentClasses && absentClasses.length) || 0;
        if (totalAbsences > 0) {
          absencesCountEl.textContent = totalAbsences.toString();
          if (absencesNoteEl) {
            const label = totalAbsences === 1 ? 'class missed' : 'classes missed';
            absencesNoteEl.textContent = label;
          }
          absencesCardEl.style.display = 'flex';
        } else {
          absencesCardEl.style.display = 'none';
        }
      }
      
      const unpaidCard = document.querySelector('.stat-card[style*="#ef4444"]');
      if (unpaidCard) {
        unpaidCard.classList.toggle('has-unpaid', totalUnpaid > 0);
      }
      
      const paymentList = document.getElementById('paymentList');
      if (!paymentList) return;
      paymentList.innerHTML = '';
      
      //  NEW: Add unpaid class entries first (if any)
      if (unpaidClasses && unpaidClasses.length > 0) {
        console.debug(` Displaying ${unpaidClasses.length} unpaid class dates`);
        unpaidClasses.forEach(unpaidClass => {
          // Extract just YYYY-MM-DD portion and add local midnight time to avoid timezone shift
          const dateOnlyStr = unpaidClass.date ? unpaidClass.date.substring(0, 10) : unpaidClass.date;
          const classDate = new Date(dateOnlyStr + 'T00:00:00');
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const dateStr = `${monthNames[classDate.getMonth()]} ${classDate.getDate()}, ${classDate.getFullYear()}`;
          
          const item = document.createElement('div');
          item.className = 'payment-item unpaid';
          
          item.innerHTML = `
            <div class="payment-date">${dateStr}</div>
            <div class="payment-status">
              <span class="status-badge unpaid">Not Paid</span>
              <span class="payment-amount">$${unpaidClass.amount.toFixed(0)}</span>
            </div>
          `;
          
          paymentList.appendChild(item);
        });
      }
      
      //  NEW: Add absent class entries (if any)
      if (absentClasses && absentClasses.length > 0) {
        console.debug(` Displaying ${absentClasses.length} absent class dates`);
        absentClasses.forEach(absentClass => {
          // Extract just YYYY-MM-DD portion and add local midnight time to avoid timezone shift
          const dateOnlyStr = absentClass.date ? absentClass.date.substring(0, 10) : absentClass.date;
          const classDate = new Date(dateOnlyStr + 'T00:00:00');
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const dateStr = `${monthNames[classDate.getMonth()]} ${classDate.getDate()}, ${classDate.getFullYear()}`;
          
          const item = document.createElement('div');
          item.className = 'payment-item absent';
          
          item.innerHTML = `
            <div class="payment-date">${dateStr}</div>
            <div class="payment-status">
              <span class="status-badge absent">Absent</span>
              <span class="payment-amount">-</span>
            </div>
          `;
          
          paymentList.appendChild(item);
        });
      }
      
      if (!payments.length && (!unpaidClasses || unpaidClasses.length === 0) && (!absentClasses || absentClasses.length === 0)) {
        paymentList.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No payment records found.</div>';
        return;
      }
      
      payments.forEach(payment => {
        const item = document.createElement('div');
        
        //  Check if payment is from credit balance
        const isCreditPayment = payment.source === 'credit';
        const itemClass = isCreditPayment ? 'credit' : payment.status;
        
        item.className = `payment-item ${itemClass}`;
        
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const dateStr = `${monthNames[payment.date.getMonth()]} ${payment.date.getDate()}, ${payment.date.getFullYear()}`;
        
        let statusText = 'Unknown';
        let statusClass = payment.status || 'unknown';
        
        //  Override for credit payments - show orange badge
        if (isCreditPayment) {
          statusText = 'Paid from Credit';
          statusClass = 'credit';
        } else {
          switch (payment.status) {
            case 'paid':
              statusText = 'Paid';
              break;
            case 'unpaid':
              statusText = 'Not Paid';
              break;
            case 'pending':
              statusText = 'Pending';
              statusClass = 'unpaid';
              break;
            case 'absent':
              statusText = 'Absent';
              break;
            case 'cancelled':
              statusText = 'Cancelled';
              break;
            default:
              statusText = payment.status || 'Unknown';
          }
        }
        
        const amount = parseFloat(payment.amount) || 0;
        const paymentMethod = payment.payment_method && !isCreditPayment ? ` (${payment.payment_method})` : '';
        
        item.innerHTML = `
          <div class="payment-date">${dateStr}</div>
          <div class="payment-status">
            <span class="status-badge ${statusClass}">${statusText}${paymentMethod}</span>
            ${amount > 0 ? `<span class="payment-amount">$${amount.toFixed(0)}</span>` : ''}
          </div>
        `;
        
        paymentList.appendChild(item);
      });
    }

    async function loadScheduleForStudent(student) {
      currentGroupScheduleData = null;
      currentGroupScheduleSummary = null;
      setProfileScheduleText('Loading latest schedule...');
      const groupName = getStudentGroup(student);
      console.debug(' About to load schedule for groupName:', groupName);
      
      if (!groupName) {
        currentGroupScheduleSummary = 'No group assigned';
        setProfileScheduleText(currentGroupScheduleSummary);
        document.getElementById('groupScheduleDisplay').innerHTML = 
          '<div class="schedule-empty">No group assigned</div>';
        document.getElementById('nextClassTimer').innerHTML = 
          '<div class="schedule-empty" style="padding: 20px; margin: 0;">No group assigned</div>';
        document.getElementById('announcementsFeed').innerHTML = 
          '<div class="announcement-empty">No announcements available</div>';
        return;
      }
      
      try {
        const scheduleData = await getGroupSchedule(groupName);
        console.debug(' getGroupSchedule returned:', scheduleData);
        
        if (scheduleData) {
          currentGroupScheduleData = scheduleData;
          currentGroupScheduleSummary = buildScheduleSummary(scheduleData.schedule, scheduleData.one_time_schedules);
          setProfileScheduleText(currentGroupScheduleSummary);
          
          const groupNameEl = document.getElementById('scheduleGroupName');
          if (groupNameEl) {
            groupNameEl.textContent = ` - Group ${groupName}`;
          }
          
          const scheduleHtml = formatSchedule(scheduleData.schedule, scheduleData.one_time_schedules);
          document.getElementById('groupScheduleDisplay').innerHTML = scheduleHtml;
          
          if (scheduleData.updated_at) {
            const daysSinceUpdate = Math.floor((new Date() - scheduleData.updated_at) / (1000 * 60 * 60 * 24));
            const badge = document.getElementById('scheduleUpdatedBadge');
            if (badge) {
              badge.style.display = daysSinceUpdate <= 7 ? 'inline-block' : 'none';
            }
          }
          
          const nextClass = computeNextClass(scheduleData);
          if (nextClass) {
            const dateOptions = { weekday: 'long', month: 'short', day: 'numeric' };
            const dateStr = nextClass.date.toLocaleDateString('en-US', dateOptions);
            document.getElementById('nextClassDate').textContent = `${dateStr}  ${nextClass.time}`;
            
            const now = getNowLA();
            const timerEl = document.getElementById('nextClassTimer');
            if (timerEl) {
              timerEl.classList.toggle('today', nextClass.date.toDateString() === now.toDateString());
            }
            startCountdown(nextClass.date);
          } else {
            document.getElementById('nextClassTimer').innerHTML = `
              <div class="schedule-empty" style="padding: 20px; margin: 0;">
                No upcoming classes at this time.<br>
                Please check for schedule updates.
              </div>
            `;
          }
        } else {
          currentGroupScheduleSummary = 'Schedule not available';
          setProfileScheduleText(currentGroupScheduleSummary);
          document.getElementById('groupScheduleDisplay').innerHTML = 
            '<div class="schedule-empty">Schedule not available</div>';
          document.getElementById('nextClassTimer').innerHTML = 
            '<div class="schedule-empty" style="padding: 20px; margin: 0;">Schedule not available</div>';
        }
      } catch (err) {
        console.error('Error loading schedule:', err);
        currentGroupScheduleSummary = 'Error loading schedule';
        setProfileScheduleText(currentGroupScheduleSummary);
        document.getElementById('groupScheduleDisplay').innerHTML = 
          '<div class="schedule-empty">Error loading schedule</div>';
      }
      
      // PERFORMANCE FIX: Removed loadChangeNotes() call - now lazy-loaded in Materials section
    }
    
    // Toggle account dropdown
    function toggleAccountDropdown() {
      const dropdown = document.querySelector('.account-dropdown');
      dropdown.classList.toggle('open');
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.querySelector('.account-dropdown');
      if (dropdown && !dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
      }
    });
    
    // Logout function
    async function logout() {
      try {
        // End session tracking
        await endSession();
        
        // Clear countdown timer
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
        
        await supabase.auth.signOut();
        currentStudent = null;
        currentEmail = null;
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = 'index.html';
      }
    }
    
    // ==========================================================================
    // FORUM FUNCTIONALITY
    // ==========================================================================
    
    let forumMessages = [];
    let forumUpdateInterval = null;
    
    // Toggle Forum Modal
    function toggleForum() {
      const modal = document.getElementById('forumModal');
      const isActive = modal.classList.contains('active');
      
      if (isActive) {
        modal.classList.remove('active');
        intervalManager.clear('forum');
      } else {
        modal.classList.add('active');
        markForumViewed(); // Mark as viewed when opening
        loadForumMessages();
        loadStudentsForMentions(); // Load students for @ mentions
        setupMentionAutocomplete(); // Setup autocomplete
        // PERFORMANCE FIX: Refresh every 30 seconds instead of 10 seconds
        // Reduces database load by 67%
        intervalManager.set('forum', loadForumMessages, 30000); // 30 seconds
      }
    }
    
    // ==========================================================================
    // UI MODAL FUNCTIONS
    // ==========================================================================
    
    // ---------- Profile Modal ----------
    // Open Profile Modal
    function openProfileModal() {
      const modal = document.getElementById('profileModal');
      
      // Debug: Log current student data
      
      // Populate modal with current student data
      if (currentStudent) {
        document.getElementById('modalStudentName').textContent = currentStudent.name || '-';
        document.getElementById('modalStudentEmail').textContent = currentStudent.email || '-';
        document.getElementById('modalStudentGroup').textContent = currentStudent.group || currentStudent.group_name || '-';
  setProfileScheduleText(currentGroupScheduleSummary || currentStudent.schedule || 'Not scheduled');
        document.getElementById('modalStudentFee').textContent = currentStudent.price_per_class ? `$${currentStudent.price_per_class}` : '-';
        document.getElementById('modalStudentBalance').textContent = currentStudent.balance ? `$${currentStudent.balance}` : '$0';
        
        console.debug('Profile modal populated with:', {
          name: currentStudent.name,
          email: currentStudent.email,
          group: currentStudent.group || currentStudent.group_name,
          schedule: currentStudent.schedule,
          fee: currentStudent.price_per_class,
          balance: currentStudent.balance
        });
        
        // Format aliases
        let aliasesText = '-';
        if (currentStudent.aliases) {
          try {
            let aliasArray = [];
            if (typeof currentStudent.aliases === 'string') {
              try {
                aliasArray = JSON.parse(currentStudent.aliases);
              } catch {
                aliasArray = currentStudent.aliases.split(',').map(a => a.trim()).filter(a => a);
              }
            } else if (Array.isArray(currentStudent.aliases)) {
              aliasArray = currentStudent.aliases;
            }
            
            if (aliasArray.length > 0) {
              aliasesText = aliasArray.join(', ');
            }
          } catch (e) {
          }
        }
        document.getElementById('modalStudentAliases').textContent = aliasesText;
      }
      
      modal.classList.add('active');
      
      // Close account dropdown when opening profile modal
      const accountDropdown = document.querySelector('.account-dropdown');
      if (accountDropdown) {
        accountDropdown.classList.remove('open');
      }
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = 'hidden';
    }
    
    // ---------- Game Modal ----------
    // Close Profile Modal
    function closeProfileModal() {
      const modal = document.getElementById('profileModal');
      modal.classList.remove('active');
      
      // Restore body scroll
      document.body.style.overflow = '';
    }
    
    // Open Game Modal
    function openGameModal(gameUrl) {
      const modal = document.getElementById('gameModal');
      const iframe = document.getElementById('gameIframe');
      
      iframe.src = gameUrl;
      modal.classList.add('active');
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = 'hidden';
    }
    
    // Close Game Modal
    function closeGameModal() {
      const modal = document.getElementById('gameModal');
      const iframe = document.getElementById('gameIframe');
      
      modal.classList.remove('active');
      iframe.src = ''; // Clear iframe to stop game
      
      // Restore body scroll
      document.body.style.overflow = '';
    }
    
    function setupModalAccessibility() {
      const profileModal = document.getElementById('profileModal');
      const gameModal = document.getElementById('gameModal');

      if (profileModal) {
        profileModal.addEventListener('click', (event) => {
          if (event.target === profileModal) {
            closeProfileModal();
          }
        });
        profileModal.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' || event.key === 'Enter') {
            closeProfileModal();
          }
        });
      }

      if (gameModal) {
        gameModal.addEventListener('click', (event) => {
          if (event.target === gameModal) {
            closeGameModal();
          }
        });
        gameModal.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' || event.key === 'Enter') {
            closeGameModal();
          }
        });
      }
    }

    // Initialize section tabs for lazy loading
    function initSectionTabs() {
      const tabs = document.querySelectorAll('.section-tab');
      if (!tabs.length) return;
      tabs.forEach(tab => {
        tab.addEventListener('click', async () => {
          const section = tab.dataset.section;
          if (!section || section === activeSection) return;
          if (!currentStudent) {
            console.warn('Student data not ready yet. Please wait a moment.');
            return;
          }
          setActiveSection(section);
          await ensureSectionData(section);
        });
      });
      setActiveSection(activeSection);
    }

    function setActiveSection(section) {
      activeSection = section;
      document.querySelectorAll('.section-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.section === section);
      });
      document.querySelectorAll('.section-panel').forEach(panel => {
        panel.classList.toggle('active', panel.dataset.section === section);
      });
    }

    async function ensureSectionData(section) {
      if (sectionLoadedState[section]) return;
      if (!currentStudent) {
        console.warn('Section requested before student data is ready.');
        return;
      }
      try {
        switch (section) {
          case 'overview':
            await loadScheduleForStudent(currentStudent);
            break;
          case 'payments':
            await loadPaymentsSection();
            break;
          case 'progress':
            await loadProgressSection();
            break;
          case 'materials':
            await loadMaterialsSection();
            break;
          default:
            break;
        }
        sectionLoadedState[section] = true;
      } catch (error) {
        console.error(`Error loading section ${section}:`, error);
      }
    }

    // Force reload payments data (clears cache)
    async function refreshPaymentsData() {
      paymentsLoaded = false;
      currentPayments = [];
      paymentsLoadingPromise = null;
      const payments = await ensurePaymentsData();
      await updatePaymentUI(payments, currentStudent, currentGroupScheduleData);
      console.log(' Payments refreshed');
      return payments;
    }

    async function ensurePaymentsData() {
      if (paymentsLoaded && currentPayments.length) {
        return currentPayments;
      }
      if (paymentsLoadingPromise) {
        return paymentsLoadingPromise;
      }
      paymentsLoadingPromise = loadPaymentHistory(currentStudent)
        .then(payments => {
          currentPayments = payments;
          paymentsLoaded = true;
          paymentsLoadingPromise = null;
          return payments;
        })
        .catch(error => {
          paymentsLoadingPromise = null;
          throw error;
        });
      return paymentsLoadingPromise;
    }

    async function loadPaymentsSection() {
      const payments = await ensurePaymentsData();
      //  Pass student and schedule to calculate unpaid from Calendar red dots
      await updatePaymentUI(payments, currentStudent, currentGroupScheduleData);
      const lazyMessage = document.getElementById('paymentLazyMessage');
      if (lazyMessage) {
        lazyMessage.remove();
      }
    }

    async function loadProgressSection() {
      if (progressLoaded) return;
      await loadSystemsProgress();
      progressLoaded = true;
    }

    async function loadMaterialsSection() {
      if (materialsLoaded) return;
      const payments = await ensurePaymentsData();
      
      // Load both notes AND announcements
      await Promise.all([
        loadClassroomUpdates(payments),
        loadChangeNotes(currentStudent?.group || currentStudent?.group_name)
      ]);
      
      const notesMessage = document.getElementById('notesLazyMessage');
      if (notesMessage) {
        notesMessage.remove();
      }
      materialsLoaded = true;
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupModalAccessibility();
      // initSectionTabs(); // DISABLED - showing all sections in one page
    });

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeGameModal();
        closeProfileModal();
      }
    });
    
    /**
     * Loads forum messages and replies from Supabase database.
     * 
     * @async
     * @returns {Promise<void>}
     * 
     * @description
     * Queries the forum_messages table with nested replies join:
     * - Fetches up to 50 messages sorted by newest first
     * - Includes all replies via forum_replies relationship
     * - Updates global forumMessages array
     * - Calls renderForumMessages() to update UI
     * - Displays setup message if tables don't exist
     * 
     * Expected schema:
     * - forum_messages: { id, student_name, message, created_at }
     * - forum_replies: { id, message_id, student_name, reply, created_at }
     * 
     * @throws {Error} Logs to console but doesn't throw - shows setup UI on error
     */
    async function loadForumMessages() {
      try {
        const { data, error } = await supabase
          .from('forum_messages')
          .select(`
            *,
            replies:forum_replies(*)
          `)
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) {
          console.error('Error loading forum messages:', error);
          // Show message about creating table if it doesn't exist
          if (error.code === 'PGRST116' || error.code === 'PGRST204' || error.code === 'PGRST205' || error.message?.includes('does not exist')) {
            displayForumSetupMessage();
          }
          return;
        }
        
        // Sort messages: pinned first, then by date
        forumMessages = data || [];
        forumMessages.sort((a, b) => {
          // Pinned messages come first
          if (a.is_pinned && !b.is_pinned) return -1;
          if (!a.is_pinned && b.is_pinned) return 1;
          // Then sort by date (newest first)
          return new Date(b.created_at) - new Date(a.created_at);
        });
        
        renderForumMessages();
        updateForumBadge();
        
      } catch (error) {
        console.error('Forum loading error:', error);
        displayForumSetupMessage();
      }
    }
    
    // Display setup message if table doesn't exist
    function displayForumSetupMessage() {
      const container = document.getElementById('forumMessages');
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">
          <p style="font-size: 48px; margin-bottom: 16px;"></p>
          <p style="font-size: 16px; margin-bottom: 8px;">Forum is being set up...</p>
          <p style="font-size: 13px;">Database tables need to be created. Contact admin.</p>
        </div>
      `;
    }
    
    // ---------- Forum Message Rendering ----------
    // Format message with markdown-style formatting and safe HTML
    function formatMessageText(text) {
      if (!text) return '';
      
      // First, protect safe HTML tags by temporarily replacing them
      let formatted = text;
      const safeSpans = [];
      
      // Extract and protect <span style="font-size: Xpx">...</span> tags
      formatted = formatted.replace(/<span style="font-size: (\d+)px">(.+?)<\/span>/g, (match, size, content) => {
        const index = safeSpans.length;
        safeSpans.push({ size, content });
        return `__SAFE_SPAN_${index}__`;
      });
      
      // NOW escape HTML to prevent XSS (but our safe spans are protected)
      formatted = escapeHtml(formatted);
      
      // Convert **text** to <strong>text</strong>
      formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      
      // Convert *text* to <em>text</em> (but not *** or **)
      formatted = formatted.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
      
      // Restore safe span tags
      formatted = formatted.replace(/__SAFE_SPAN_(\d+)__/g, (match, index) => {
        const span = safeSpans[parseInt(index)];
        return `<span style="font-size: ${span.size}px">${span.content}</span>`;
      });
      
      return formatted;
    }
    
    // Render Forum Messages
    function renderForumMessages() {
      const container = document.getElementById('forumMessages');
      
      // Check if current user is admin
      const isAdmin = currentStudent && (currentStudent.isAdminChatMode || currentStudent.role === 'admin' || currentStudent.id === 0);
      console.log(' Rendering forum - isAdmin:', isAdmin, 'currentStudent:', currentStudent);
      
      if (!forumMessages || forumMessages.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">
            <p style="font-size: 48px; margin-bottom: 16px;"></p>
            <p style="font-size: 16px;">No messages yet. Be the first to post!</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = forumMessages.map((msg, index) => {
        const isAdminMessage = msg.student_name === 'Administrator' || msg.student_id === 0;
        const isPinned = msg.is_pinned === true;
        return `
        <div class="forum-message" style="animation-delay: ${index * 0.1}s; ${isPinned ? 'border: 2px solid rgba(251, 191, 36, 0.3); background: linear-gradient(145deg, rgba(251, 191, 36, 0.05), rgba(245, 158, 11, 0.05));' : ''}">
          ${isPinned ? '<div style="position: absolute; top: 8px; right: 8px; font-size: 20px;" title="Pinned message"></div>' : ''}
          <div class="message-header">
            <div style="display: flex; flex-direction: column; gap: 2px;">
              <span class="message-author" style="${isAdminMessage ? 'color: #ef4444; font-weight: 600;' : ''}"> ${escapeHtml(msg.student_name || 'Student')}</span>
              <div style="font-size: 11px; color: rgba(255,255,255,0.5); padding-left: 24px;">
                ${msg.student_group ? `<span>Group ${escapeHtml(msg.student_group)}</span>` : ''}${msg.student_group && msg.student_college ? '  ' : ''}${msg.student_college ? `<span> ${escapeHtml(msg.student_college)}</span>` : ''}
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span class="message-time">${formatMessageTime(msg.created_at)}</span>
              ${isAdmin ? `<button class="delete-message-btn" onclick="deleteForumMessage(${msg.id})" title="Delete message"></button>` : ''}
            </div>
          </div>
          <div class="message-text" id="messageText${msg.id}" style="${isAdminMessage ? 'color: #ef4444;' : ''}" data-original="${escapeHtml(msg.message).replace(/"/g, '&quot;')}">${formatMessageText(msg.message)}</div>
          <div style="display: flex; gap: 8px; margin-top: 8px;">
            <button class="reply-btn" onclick="toggleReplyInput(${msg.id})">Reply</button>
            ${isAdminMessage && isAdmin ? `
              <button class="reply-btn" onclick="togglePinMessage(${msg.id})" title="${isPinned ? 'Unpin message' : 'Pin message'}">${isPinned ? ' Unpin' : ' Pin'}</button>
              <button class="reply-btn" onclick="editMessage(${msg.id})" title="Edit message"> Edit</button>
            ` : ''}
          </div>
          
          <div class="reply-input-container" id="replyInput${msg.id}">
            <input 
              type="text" 
              class="reply-input" 
              id="replyText${msg.id}" 
              placeholder="Write a reply..." 
              onkeypress="if(event.key==='Enter') sendReply(${msg.id})">
            <button class="send-reply-btn" onclick="sendReply(${msg.id})">Send</button>
          </div>
          
          ${msg.replies && msg.replies.length > 0 ? `
            <div class="message-replies">
              ${msg.replies.map(reply => {
                const isAdminReply = reply.student_name === 'Administrator' || reply.student_id === 0;
                return `
                <div class="message-reply">
                  <div class="message-header">
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                      <span class="message-author" style="${isAdminReply ? 'color: #ef4444; font-weight: 600;' : ''}"> ${escapeHtml(reply.student_name || 'Student')}</span>
                      <div style="font-size: 10px; color: rgba(255,255,255,0.4); padding-left: 24px;">
                        ${reply.student_group ? `<span>Group ${escapeHtml(reply.student_group)}</span>` : ''}${reply.student_group && reply.student_college ? '  ' : ''}${reply.student_college ? `<span> ${escapeHtml(reply.student_college)}</span>` : ''}
                      </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span class="message-time">${formatMessageTime(reply.created_at)}</span>
                      ${isAdmin ? `<button class="delete-message-btn" onclick="deleteForumReply(${reply.id})" title="Delete reply"></button>` : ''}
                    </div>
                  </div>
                  <div class="message-text" style="${isAdminReply ? 'color: #ef4444;' : ''}">${formatMessageText(reply.message)}</div>
                </div>
              `;
              }).join('')}
            </div>
          ` : ''}
        </div>
      `;
      }).join('');
    }
    
    /**
     * Sends a new message to the student forum.
     * 
     * @async
     * @returns {Promise<void>}
     * 
     * @description
     * Workflow:
     * 1. Validates message input is not empty
     * 2. Checks currentStudent is authenticated
     * 3. Inserts new message into forum_messages table
     * 4. Reloads all messages to update UI
     * 5. Clears input field on success
     * 6. Shows error alert if insert fails
     * 
     * Message data saved:
     * - student_id: currentStudent.id
     * - student_name: currentStudent.name
     * - student_email: currentStudent.email or currentEmail
     * - message: sanitized text from input
     * - created_at: ISO timestamp
     * 
     * @example
     * <input id="forumInput" onkeypress="if(event.key==='Enter') sendForumMessage()" />
     */
    async function sendForumMessage() {
      const input = document.getElementById('forumInput');
      let message = input.value.trim();
      
      if (!message) return;
      
      // Allow admin (id: 0) or regular students (id > 0)
      if (!currentStudent || (currentStudent.id === undefined || currentStudent.id === null)) {
        showCustomAlert('Please log in to post messages', 'error');
        return;
      }
      
      // Remove @ symbols from the message before sending
      message = message.replace(/@/g, '');
      
      try {
        // Check if admin is posting
        const isAdminPosting = currentStudent.isAdminChatMode || currentStudent.role === 'admin';
        
        const { data, error } = await supabase
          .from('forum_messages')
          .insert([{
            student_id: isAdminPosting ? 0 : currentStudent.id,
            student_name: isAdminPosting ? 'Administrator' : (currentStudent.name || 'Student'),
            student_email: currentStudent.email || currentEmail,
            student_group: isAdminPosting ? null : (currentStudent.group_code || null),
            student_college: isAdminPosting ? null : (currentStudent.college || null),
            message: message,
            created_at: new Date().toISOString()
          }])
          .select();
        
        if (error) {
          console.error('Error sending message:', error);
          showCustomAlert('Failed to send message. Please try again.', 'error');
          return;
        }
        
        input.value = '';
        await loadForumMessages();
        
      } catch (error) {
        console.error('Send message error:', error);
        showCustomAlert('Failed to send message. Please try again.', 'error');
      }
    }
    
    // Toggle Reply Input
    function toggleReplyInput(messageId) {
      const container = document.getElementById(`replyInput${messageId}`);
      const isActive = container.classList.contains('active');
      
      // Close all other reply inputs
      document.querySelectorAll('.reply-input-container.active').forEach(el => {
        el.classList.remove('active');
      });
      
      if (!isActive) {
        container.classList.add('active');
        document.getElementById(`replyText${messageId}`).focus();
      }
    }
    
    // Send Reply
    async function sendReply(messageId) {
      const input = document.getElementById(`replyText${messageId}`);
      let message = input.value.trim();
      
      if (!message) return;
      
      // Allow admin (id: 0) or regular students (id > 0)
      if (!currentStudent || (currentStudent.id === undefined || currentStudent.id === null)) {
        showCustomAlert('Please log in to reply', 'error');
        return;
      }
      
      // Remove @ symbols from the message before sending
      message = message.replace(/@/g, '');
      
      try {
        // Check if admin is replying
        const isAdminReplying = currentStudent.isAdminChatMode || currentStudent.role === 'admin';
        
        const { data, error } = await supabase
          .from('forum_replies')
          .insert([{
            message_id: messageId,
            student_id: isAdminReplying ? 0 : currentStudent.id,
            student_name: isAdminReplying ? 'Administrator' : (currentStudent.name || 'Student'),
            student_group: isAdminReplying ? null : (currentStudent.group_code || null),
            student_college: isAdminReplying ? null : (currentStudent.college || null),
            message: message,
            created_at: new Date().toISOString()
          }])
          .select();
        
        if (error) {
          console.error('Error sending reply:', error);
          showCustomAlert('Failed to send reply. Please try again.', 'error');
          return;
        }
        
        input.value = '';
        document.getElementById(`replyInput${messageId}`).classList.remove('active');
        await loadForumMessages();
        
      } catch (error) {
        console.error('Send reply error:', error);
        showCustomAlert('Failed to send reply. Please try again.', 'error');
      }
    }
    
    // ---------- Admin Delete Functions ----------
    async function deleteForumMessage(messageId) {
      if (!isAdmin) {
        showCustomAlert('Only admins can delete messages', 'error');
        return;
      }
      
      const confirmed = await showCustomConfirm('Are you sure you want to delete this message? This will also delete all replies.');
      if (!confirmed) {
        return;
      }
      
      try {
        // First delete all replies
        const { error: repliesError } = await supabase
          .from('forum_replies')
          .delete()
          .eq('message_id', messageId);
        
        if (repliesError) {
          console.error('Error deleting replies:', repliesError);
        }
        
        // Then delete the message
        const { error: messageError } = await supabase
          .from('forum_messages')
          .delete()
          .eq('id', messageId);
        
        if (messageError) {
          console.error('Error deleting message:', messageError);
          showCustomAlert('Failed to delete message. Please try again.', 'error');
          return;
        }
        
        showCustomAlert('Message deleted successfully', 'success');
        await loadForumMessages();
        
      } catch (error) {
        console.error('Delete message error:', error);
        showCustomAlert('Failed to delete message. Please try again.', 'error');
      }
    }
    
    async function deleteForumReply(replyId) {
      if (!isAdmin) {
        showCustomAlert('Only admins can delete replies', 'error');
        return;
      }
      
      const confirmed = await showCustomConfirm('Are you sure you want to delete this reply?');
      if (!confirmed) {
        return;
      }
      
      try {
        const { error } = await supabase
          .from('forum_replies')
          .delete()
          .eq('id', replyId);
        
        if (error) {
          console.error('Error deleting reply:', error);
          showCustomAlert('Failed to delete reply. Please try again.', 'error');
          return;
        }
        
        showCustomAlert('Reply deleted successfully', 'success');
        await loadForumMessages();
        
      } catch (error) {
        console.error('Delete reply error:', error);
        showCustomAlert('Failed to delete reply. Please try again.', 'error');
      }
    }
    
    // ---------- Admin Message Actions ----------
    async function togglePinMessage(messageId) {
      try {
        // Get current pin status
        const { data: currentMessage, error: fetchError } = await supabase
          .from('forum_messages')
          .select('is_pinned')
          .eq('id', messageId)
          .single();
        
        if (fetchError) {
          console.error('Error fetching message:', fetchError);
          // If column doesn't exist, show helpful message
          if (fetchError.code === 'PGRST116' || fetchError.code === 'PGRST204') {
            showCustomAlert('Pin feature requires database update. Please run add-is-pinned-to-forum.sql', 'error');
            return;
          }
          showCustomAlert('Failed to fetch message status', 'error');
          return;
        }
        
        // Toggle the pin status
        const newPinStatus = !currentMessage.is_pinned;
        
        const { error: updateError } = await supabase
          .from('forum_messages')
          .update({ is_pinned: newPinStatus })
          .eq('id', messageId);
        
        if (updateError) {
          console.error('Error updating pin status:', updateError);
          showCustomAlert('Failed to pin/unpin message', 'error');
          return;
        }
        
        showCustomAlert(newPinStatus ? ' Message pinned!' : 'Message unpinned', 'success');
        await loadForumMessages();
        
      } catch (error) {
        console.error('Toggle pin error:', error);
        showCustomAlert('Failed to toggle pin. Please try again.', 'error');
      }
    }
    
    async function editMessage(messageId) {
      const messageTextEl = document.getElementById(`messageText${messageId}`);
      const originalText = messageTextEl.getAttribute('data-original');
      
      // Show formatting toolbar and edit mode
      const modal = document.createElement('div');
      modal.className = 'custom-alert-overlay';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999999;
      `;
      
      modal.innerHTML = `
        <div style="
          background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.1));
          border: 1px solid rgba(59, 130, 246, 0.3);
          border-radius: 16px;
          padding: 24px;
          max-width: 600px;
          width: 90%;
          backdrop-filter: blur(12px);
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        ">
          <h3 style="color: white; margin-bottom: 16px;"> Edit Message</h3>
          
          <div style="margin-bottom: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
            <button onclick="formatText('bold')" style="padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; cursor: pointer;"><strong>B</strong></button>
            <button onclick="formatText('italic')" style="padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; cursor: pointer;"><em>I</em></button>
            <select id="fontSize" onchange="formatText('fontSize')" style="padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
              <option value="14">Normal</option>
              <option value="18">Large</option>
              <option value="24">Extra Large</option>
            </select>
          </div>
          
          <textarea id="editMessageText" style="
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 16px;
          ">${originalText.replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&')}</textarea>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.custom-alert-overlay').remove()" style="
              flex: 1;
              padding: 12px;
              background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2);
              border-radius: 8px;
              color: white;
              cursor: pointer;
            ">Cancel</button>
            <button onclick="saveEditedMessage(${messageId})" style="
              flex: 1;
              padding: 12px;
              background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9));
              border: none;
              border-radius: 8px;
              color: white;
              font-weight: 600;
              cursor: pointer;
            ">Save</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    function formatText(command) {
      const textarea = document.getElementById('editMessageText');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const selectedText = textarea.value.substring(start, end);
      
      if (!selectedText) {
        showCustomAlert('Please select text to format', 'info');
        return;
      }
      
      let formattedText = '';
      if (command === 'bold') {
        formattedText = `**${selectedText}**`;
      } else if (command === 'italic') {
        formattedText = `*${selectedText}*`;
      } else if (command === 'fontSize') {
        const size = document.getElementById('fontSize').value;
        formattedText = `<span style="font-size: ${size}px">${selectedText}</span>`;
      }
      
      textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
      textarea.focus();
      textarea.setSelectionRange(start, start + formattedText.length);
    }
    
    async function saveEditedMessage(messageId) {
      const newText = document.getElementById('editMessageText').value.trim();
      
      if (!newText) {
        showCustomAlert('Message cannot be empty', 'error');
        return;
      }
      
      try {
        // First try with edited_at column
        let updateData = { 
          message: newText,
          edited_at: new Date().toISOString()
        };
        
        let { error } = await supabase
          .from('forum_messages')
          .update(updateData)
          .eq('id', messageId);
        
        // If column doesn't exist, try without edited_at
        if (error && error.code === 'PGRST204') {
          console.log(' edited_at column not found, updating without it');
          updateData = { message: newText };
          const result = await supabase
            .from('forum_messages')
            .update(updateData)
            .eq('id', messageId);
          error = result.error;
        }
        
        if (error) {
          console.error('Error updating message:', error);
          showCustomAlert('Failed to update message. Please try again.', 'error');
          return;
        }
        
        showCustomAlert('Message updated successfully', 'success');
        document.querySelector('.custom-alert-overlay').remove();
        await loadForumMessages();
        
      } catch (error) {
        console.error('Save message error:', error);
        showCustomAlert('Failed to save message', 'error');
      }
    }
    
    // ---------- @ Mention Autocomplete ----------
    let allStudents = [];
    let mentionSuggestions = null;
    
    async function loadStudentsForMentions() {
      try {
        const { data, error } = await supabase
          .from('students')
          .select('id, name')
          .order('name');
        
        if (!error && data) {
          allStudents = data;
        }
      } catch (error) {
        console.error('Error loading students for mentions:', error);
      }
    }
    
    function setupMentionAutocomplete() {
      const input = document.getElementById('forumInput');
      if (!input) return;
      
      // Create suggestion dropdown
      mentionSuggestions = document.createElement('div');
      mentionSuggestions.style.cssText = `
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        margin-bottom: 8px;
        display: none;
        z-index: 1000;
      `;
      input.parentElement.style.position = 'relative';
      input.parentElement.appendChild(mentionSuggestions);
      
      input.addEventListener('input', function(e) {
        const text = this.value;
        const cursorPos = this.selectionStart;
        const textBeforeCursor = text.substring(0, cursorPos);
        const atIndex = textBeforeCursor.lastIndexOf('@');
        
        if (atIndex !== -1 && cursorPos - atIndex <= 20) {
          const searchTerm = textBeforeCursor.substring(atIndex + 1).toLowerCase();
          const matches = allStudents.filter(s => 
            s.name.toLowerCase().includes(searchTerm)
          ).slice(0, 5);
          
          if (matches.length > 0 && searchTerm) {
            showMentionSuggestions(matches, atIndex, cursorPos);
          } else {
            mentionSuggestions.style.display = 'none';
          }
        } else {
          mentionSuggestions.style.display = 'none';
        }
      });
    }
    
    function showMentionSuggestions(matches, atIndex, cursorPos) {
      mentionSuggestions.innerHTML = matches.map(student => `
        <div onclick="insertMention('${student.name.replace(/'/g, "\\'")}', ${atIndex}, ${cursorPos})" style="
          padding: 10px 12px;
          cursor: pointer;
          color: white;
          border-bottom: 1px solid rgba(255,255,255,0.05);
        " onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'" onmouseout="this.style.background=''">
           ${student.name}
        </div>
      `).join('');
      mentionSuggestions.style.display = 'block';
    }
    
    function insertMention(name, atIndex, cursorPos) {
      const input = document.getElementById('forumInput');
      const text = input.value;
      const beforeAt = text.substring(0, atIndex);
      const afterCursor = text.substring(cursorPos);
      input.value = beforeAt + `@${name} ` + afterCursor;
      mentionSuggestions.style.display = 'none';
      input.focus();
    }
    
    // Update Forum Badge (unread count)
    function updateForumBadge() {
      const badge = document.getElementById('forumBadge');
      const newMessages = forumMessages.filter(msg => {
        const msgDate = new Date(msg.created_at);
        const lastViewed = localStorage.getItem('lastForumView');
        return !lastViewed || msgDate > new Date(lastViewed);
      }).length;
      
      if (newMessages > 0) {
        badge.textContent = newMessages;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }
    
    // Mark forum as viewed
    function markForumViewed() {
      localStorage.setItem('lastForumView', new Date().toISOString());
      updateForumBadge();
    }
    
    // Format message time
    function formatMessageTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }
    
    // ==========================================================================
    // UTILITY FUNCTIONS
    // ==========================================================================
    
    // ---------- Security & Sanitization ----------
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ---------- Forum Notification Checker ----------
    // PERFORMANCE FIX: Check for new messages periodically (when forum is closed) - using interval manager
    // Only check every 60 seconds to reduce Supabase load
    intervalManager.set('forumNotification', () => {
      if (!document.getElementById('forumModal').classList.contains('active')) {
        // Silently check for new messages
        supabase
          .from('forum_messages')
          .select('id, created_at')
          .order('created_at', { ascending: false })
          .limit(1)
          .then(({ data }) => {
            if (data && data.length > 0) {
              const lastViewed = localStorage.getItem('lastForumView');
              if (!lastViewed || new Date(data[0].created_at) > new Date(lastViewed)) {
                document.getElementById('forumBadge').style.display = 'block';
              }
            }
          });
      }
    }, 60000); // Check every 60 seconds (reduced from 30)
    
    // Custom Alert Dialog
    function showCustomAlert(message, type = 'info') {
      // Remove existing alert if any
      const existing = document.querySelector('.custom-alert-overlay');
      if (existing) existing.remove();
      
      const overlay = document.createElement('div');
      overlay.className = 'custom-alert-overlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999999;
        animation: fadeIn 0.2s ease;
      `;
      
      const icon = type === 'error' ? '' : type === 'success' ? '' : '';
      const bgColor = type === 'error' ? 'linear-gradient(145deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1))' : 
                      type === 'success' ? 'linear-gradient(145deg, rgba(34, 197, 94, 0.15), rgba(22, 163, 74, 0.1))' : 
                      'linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.1))';
      
      overlay.innerHTML = `
        <div class="custom-alert-box" style="
          background: ${bgColor};
          border: 1px solid ${type === 'error' ? 'rgba(239, 68, 68, 0.3)' : type === 'success' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(59, 130, 246, 0.3)'};
          border-radius: 16px;
          padding: 32px;
          max-width: 400px;
          width: 90%;
          backdrop-filter: blur(12px);
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          animation: slideUp 0.3s ease;
        ">
          <div style="font-size: 48px; text-align: center; margin-bottom: 16px;">${icon}</div>
          <div style="color: white; font-size: 16px; text-align: center; margin-bottom: 24px; line-height: 1.5;">${message}</div>
          <button onclick="this.closest('.custom-alert-overlay').remove()" style="
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
            OK
          </button>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (overlay.parentElement) overlay.remove();
      }, 5000);
    }
    
    function showCustomConfirm(message) {
      return new Promise((resolve) => {
        // Remove existing overlay if any
        const existing = document.querySelector('.custom-confirm-overlay');
        if (existing) existing.remove();
        
        const overlay = document.createElement('div');
        overlay.className = 'custom-confirm-overlay';
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          backdrop-filter: blur(8px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 999999;
          animation: fadeIn 0.2s ease;
        `;
        
        overlay.innerHTML = `
          <div class="custom-confirm-box" style="
            background: linear-gradient(145deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            backdrop-filter: blur(12px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
          ">
            <div style="font-size: 48px; text-align: center; margin-bottom: 16px;"></div>
            <div style="color: white; font-size: 16px; text-align: center; margin-bottom: 24px; line-height: 1.5;">${message}</div>
            <div style="display: flex; gap: 12px;">
              <button class="confirm-cancel-btn" style="
                flex: 1;
                padding: 12px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 8px;
                color: white;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
              " onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
                Cancel
              </button>
              <button class="confirm-ok-btn" style="
                flex: 1;
                padding: 12px;
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
                border: none;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
              " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(239, 68, 68, 0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                OK
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Handle button clicks
        overlay.querySelector('.confirm-cancel-btn').onclick = () => {
          overlay.remove();
          resolve(false);
        };
        
        overlay.querySelector('.confirm-ok-btn').onclick = () => {
          overlay.remove();
          resolve(true);
        };
        
        // Handle overlay click (cancel)
        overlay.onclick = (e) => {
          if (e.target === overlay) {
            overlay.remove();
            resolve(false);
          }
        };
      });
    }
    
    // Google Classroom Integration
    let isGoogleConnected = false;
    let googleClient = null;
    
    // Initialize Google Classroom
    async function initGoogleClassroom() {
      try {
        // Auto-connect using student's email
        await connectGoogleClassroom();
      } catch (error) {
        console.error('Google Classroom init error:', error);
        // Show connect button if auto-connect fails
      }
    }
    
    // Connect to Google Classroom
    async function connectGoogleClassroom() {
      try {
        // Initialize Google API client
        await new Promise((resolve) => {
          gapi.load('client:auth2', resolve);
        });
        
        await gapi.client.init({
          apiKey: firebaseConfig.apiKey,
          clientId: GOOGLE_CLIENT_ID,
          discoveryDocs: ['https://classroom.googleapis.com/$discovery/rest?version=v1'],
          scope: SCOPES
        });
        
        // Sign in with student's email
        const auth2 = gapi.auth2.getAuthInstance();
        if (!auth2.isSignedIn.get()) {
          await auth2.signIn({ prompt: 'consent', login_hint: currentEmail });
        }
        
        isGoogleConnected = true;
        // Load real classroom data
        await loadRealClassroomUpdates();
        
      } catch (error) {
        console.error('Google Classroom connection error:', error);
        // Fall back to demo data
        loadClassroomUpdates();
      }
    }
    
    // Load real classroom updates from Google Classroom API
    async function loadRealClassroomUpdates() {
      try {
        const updates = [];
        
        // Get courses
        const coursesResponse = await gapi.client.classroom.courses.list({
          courseStates: ['ACTIVE']
        });
        
        const courses = coursesResponse.result.courses || [];
        
        for (const course of courses.slice(0, 5)) { // Limit to 5 courses
          // Get announcements
          try {
            const announcementsResponse = await gapi.client.classroom.courses.announcements.list({
              courseId: course.id,
              pageSize: 3
            });
            
            const announcements = announcementsResponse.result.announcements || [];
            announcements.forEach(announcement => {
              updates.push({
                type: 'announcement',
                course: course.name,
                title: announcement.text ? announcement.text.substring(0, 50) + '...' : 'New Announcement',
                text: announcement.text || 'Check Google Classroom for details',
                date: getRelativeTime(announcement.creationTime)
              });
            });
          } catch (e) {
          }
          
          // Get coursework
          try {
            const courseworkResponse = await gapi.client.classroom.courses.courseWork.list({
              courseId: course.id,
              pageSize: 3
            });
            
            const coursework = courseworkResponse.result.courseWork || [];
            coursework.forEach(work => {
              updates.push({
                type: 'material',
                course: course.name,
                title: work.title,
                text: work.description || 'New course material posted',
                date: getRelativeTime(work.creationTime)
              });
            });
          } catch (e) {
          }
        }
        
        // Sort by date and display
        displayClassroomUpdates(updates);
        
      } catch (error) {
        console.error('Error loading classroom updates:', error);
        // Fall back to demo data
        loadClassroomUpdates();
      }
    }
    
    // Get relative time
    function getRelativeTime(timestamp) {
      const now = new Date();
      const date = new Date(timestamp);
      const diff = now - date;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      
      if (hours < 1) return 'Just now';
      if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
      if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;
      return date.toLocaleDateString();
    }
    
    // Display classroom updates
    function displayClassroomUpdates(updates) {
      const classroomList = document.getElementById('classroomList');
      classroomList.innerHTML = '';
      
      if (updates.length === 0) {
        classroomList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">No recent updates found.</div>';
        return;
      }
      
      updates.forEach(update => {
        const item = document.createElement('div');
        item.className = `classroom-item ${update.type}`;
        
        const badgeText = update.type === 'announcement' ? ' Announcement' : ' Material';
        
        item.innerHTML = `
          <div class="classroom-header">
            <div>
              <div class="classroom-title">${update.title}</div>
              <div class="classroom-course">${update.course}</div>
            </div>
            <div class="classroom-date">${update.date}</div>
          </div>
          <div class="classroom-text">${update.text}</div>
          <span class="classroom-badge ${update.type}">${badgeText}</span>
        `;
        
        classroomList.appendChild(item);
      });
    }
    
    /**
     * Loads classroom notes/assignments filtered by student's group and payment status.
     * 
     * @async
     * @param {Array<Object>} payments - Array of payment objects with status and date
     * @returns {Promise<Array<Object>>} Array of accessible note assignments
     * 
     * @description
     * Complex note loading with payment-based access control:
     * 
     * 1. **Group Filtering**: Normalizes student.group (handles "Group C", "C", etc.)
     * 2. **Note Query**: Fetches from note_assignments table with:
     *    - Group match (A-F)
     *    - Active status (deleted = false)
     *    - Joined with note_templates for metadata
     * 
     * 3. **Payment Locking**: For each note:
     *    - If note.requires_payment = true  checks payment history
     *    - Locked if no matching paid status for note's date
     *    - Unlocked if payment found OR note doesn't require payment
     * 
     * 4. **UI Rendering**: Creates cards showing:
     *    - Lock icon () for payment-locked notes
     *    - System icon + name
     *    - PDF download link (if unlocked)
     *    - Payment prompt (if locked)
     * 
     * 5. **Global State Updates**:
     *    - Sets allSystemNotes array
     *    - Calls refreshSystemAssignmentStats()
     *    - Updates notification badges
     * 
     * @example
     * const payments = await loadPaymentHistory(student);
     * await loadClassroomUpdates(payments);
     */
    async function loadClassroomUpdates(payments) {
      // Use passed payments or fall back to global currentPayments
      const paymentData = payments || currentPayments || [];
      
      const classroomList = document.getElementById('classroomList');
      classroomList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">Loading your notes...</div>';
      
      console.debug(' Payment data for notes:', {
        passedPayments: !!payments,
        globalPayments: !!currentPayments,
        usingPayments: paymentData.length,
        firstPayment: paymentData[0]
      });
      
      try {
        const studentId = currentStudent?.id;
        let studentGroup = currentStudent?.group || currentStudent?.group_name;
        
        if (!studentId) {
          console.warn(' No student ID found');
          classroomList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">No student found.</div>';
          allSystemNotes = [];
          refreshSystemAssignmentStats();
          updateSystemNotifications();
          return [];
        }
        
        // Normalize group to format "Group X"
        if (studentGroup && !studentGroup.toLowerCase().startsWith('group')) {
          studentGroup = `Group ${studentGroup}`;
        }
        
        if (DEBUG_MODE) console.log(' Loading notes for Student ID:', studentId, 'Group:', studentGroup);
        
        // Fetch permissions for this student (both group and individual access)
        const { data: permissions, error: permError} = await supabase
          .from('student_note_permissions')
          .select('note_id, is_accessible')
          .or(`student_id.eq.${studentId},and(group_name.eq.${studentGroup},student_id.is.null)`)
          .eq('is_accessible', true);
        
        if (permError) {
          console.error(' Error loading permissions:', permError);
        }
        
        const accessibleNoteIds = permissions?.map(p => p.note_id) || [];
        
        if (DEBUG_MODE) console.log(` Found ${accessibleNoteIds.length} accessible notes`);
        
        if (accessibleNoteIds.length === 0) {
          classroomList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">No notes available yet.</div>';
          allSystemNotes = [];
          refreshSystemAssignmentStats();
          updateSystemNotifications();
          return [];
        }
        
        // Fetch the actual notes
        const { data: notes, error: notesError } = await supabase
          .from('student_notes')
          .select('*')
          .in('id', accessibleNoteIds)
          .order('class_date', { ascending: false });
        
        if (notesError) {
          console.error(' Error loading notes:', notesError);
          classroomList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">Error loading notes.</div>';
          allSystemNotes = [];
          refreshSystemAssignmentStats();
          updateSystemNotifications();
          return [];
        }
        
        if (DEBUG_MODE) console.log(` Loaded ${notes?.length || 0} notes`);
        
        // Transform notes to match expected format
        const transformedNotes = notes.map(note => {
          const classDate = new Date(note.class_date);
          //  All notes are unlocked for students with individual access
          const isPaid = true;
          
          // Get system category from whatever column exists (try system, system_category, group_name, etc.)
          const systemName = note.system || note.system_category || note.category || note.group_name || 'General';
          
          return {
            id: note.id,
            date: classDate,
            title: note.title || 'Untitled Note',
            text: note.description || note.title || 'Note', 
            isPaid: isPaid,
            course: systemName,
            folderIcon: '',
            type: 'material',
            isTemplateMissing: false,
            system: systemName,
            read: false, // TODO: Track which notes have been opened
            attachments: (note.file_path || note.pdf_url) ? [{
              title: (note.title || 'Note') + '.pdf',
              url: note.file_path || note.pdf_url, // Use actual Supabase storage URL
              noteId: note.id,
              type: 'pdf'
            }] : []
          };
          
          // Debug log to see what we're working with
          if (DEBUG_MODE && transformedNote.attachments.length > 0) {
            console.log(' Note attachment URL:', transformedNote.attachments[0].url);
          }
          
          return transformedNote;
        });
        
        allSystemNotes = transformedNotes;
        refreshSystemAssignmentStats();
        
        displayNotes(transformedNotes);
        updateSystemNotifications();
        
        return transformedNotes;
        
      } catch (error) {
        console.error(' Error in loadClassroomUpdates:', error);
        classroomList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">Error loading notes.</div>';
        allSystemNotes = [];
        refreshSystemAssignmentStats();
        updateSystemNotifications();
        return [];
      }
    }
    
    // Generate demo notes based on payment history
    function generateDemoNotes(payments) {
      const demoNotes = [];
      const today = new Date();
      
      // NCLEX systems for note categorization
      const systemsList = [
        'Cardiovascular System', 'Endocrine System', 'Gastrointestinal System',
        'Respiratory System', 'Pharmacology', 'Medical Terminology',
        'Human Anatomy', 'Medication Suffixes & Classes'
      ];
      
      // Generate notes for last 30 days based on attendance
      for (let i = 0; i < 30; i++) {
        const noteDate = new Date(today);
        noteDate.setDate(today.getDate() - i);
        
        // Check if there's a payment for this date
        const payment = payments.find(p => 
          p.date.getDate() === noteDate.getDate() &&
          p.date.getMonth() === noteDate.getMonth() &&
          p.date.getFullYear() === noteDate.getFullYear()
        );
        
        if (payment && payment.status !== 'absent') {
          const isPaid = payment.status === 'paid';
          const randomSystem = systemsList[Math.floor(Math.random() * systemsList.length)];
          
          const noteTypes = [
            { title: 'NCLEX Practice Questions', text: 'Complete set of practice questions covering today\'s topics with detailed explanations and rationales.' },
            { title: 'Pharmacology Review', text: 'Comprehensive medication guide including drug classes, mechanisms of action, and nursing considerations.' },
            { title: 'Lab Values & Diagnostics', text: 'Essential laboratory values reference sheet with normal ranges and clinical significance.' },
            { title: 'Patient Care Study', text: 'Real-world case study demonstrating critical thinking and prioritization skills for NCLEX preparation.' },
            { title: 'Systems Review Notes', text: 'Detailed notes on body systems, pathophysiology, and key nursing interventions for exam success.' }
          ];
          
          const randomNote = noteTypes[Math.floor(Math.random() * noteTypes.length)];
          
          demoNotes.push({
            date: new Date(noteDate),
            title: `${randomNote.title} - ${noteDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`,
            text: isPaid ? randomNote.text : 'Unlock this content by completing payment for this class session.',
            isPaid: isPaid,
            course: currentStudent?.group || 'Your Class',
            type: i % 3 === 0 ? 'announcement' : 'material',
            system: randomSystem,
            read: i > 5 ? true : false, // Last 5 notes are unread
            attachments: isPaid ? [
              {
                title: `${randomNote.title}.pdf`,
                url: '#',
                thumbnailUrl: null,
                type: 'file'
              }
            ] : []
          });
        }
      }
      
      // Store globally for filtering
      allSystemNotes = demoNotes;
      refreshSystemAssignmentStats();
      
      return demoNotes;
    }
    
    // Filter notes by system and update UI
  function filterNotesBySystem(systemName) {
      selectedSystem = systemName;
      
      // Normalize system names for comparison (handle "Cardiovascular" vs "Cardiovascular System")
      const normalizeSystemName = (name) => {
        if (!name) return '';
        // Remove " System" suffix for comparison
        return name.replace(/\s+System$/i, '').trim().toLowerCase();
      };
      
      const normalizedSearchName = normalizeSystemName(systemName);
      
      const filteredNotes = allSystemNotes.filter(note => {
        const normalizedNoteName = normalizeSystemName(note.system);
        return normalizedNoteName === normalizedSearchName;
      });

      document.querySelectorAll('.system-card').forEach(card => {
        if (card.dataset.systemName === systemName) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      });

      const escapedName = typeof CSS !== 'undefined' && CSS.escape
        ? CSS.escape(systemName)
        : systemName;
      const targetCard = document.querySelector(`.system-card[data-system-name="${escapedName}"]`);
      if (targetCard) {
        centerSystemCard(targetCard);
      }

      updateNotesHeader(systemName);
      displayNotes(filteredNotes);

      filteredNotes.forEach(note => {
        note.read = true;
      });

      updateSystemNotifications();

      const classroomList = document.getElementById('classroomList');
      if (classroomList) {
        classroomList.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    
    // Show all notes (clear filter)
    function showAllNotes() {
      selectedSystem = null;
      
      updateNotesHeader(null);
      document.querySelectorAll('.system-card').forEach(c => c.classList.remove('selected'));
      
      displayNotes(allSystemNotes);
      updateSystemNotifications();
    }

    function updateNotesHeader(systemName) {
      const titleElement = document.querySelector('#classroomContent').previousElementSibling;
      if (!titleElement || !titleElement.classList.contains('card-title')) return;

      titleElement.innerHTML = '';

      const left = document.createElement('div');
      left.className = 'card-title-left';

      if (systemName) {
        const systemEmoji = nclexSystems.find(s => s.name === systemName)?.icon || '';
        left.innerHTML = `<span>${systemEmoji}</span>${systemName} - Notes`;

        const button = document.createElement('button');
        button.className = 'show-all-notes-btn';
        button.type = 'button';
        button.textContent = ' Show All Notes';
        button.addEventListener('click', showAllNotes);

        titleElement.appendChild(left);
        titleElement.appendChild(button);
      } else {
        left.innerHTML = `<span></span>Class Materials & Notes`;
        titleElement.appendChild(left);
      }
    }

    function updateSystemNotifications() {
      refreshSystemAssignmentStats();
      document.querySelectorAll('.system-card').forEach(card => {
        const systemName = card.dataset.systemName;
        if (!systemName) return;
        const stats = systemAssignmentStats.get(systemName);
        const unlockedUnread = stats?.unlockedUnread || 0;
        const lockedUnread = stats?.lockedUnread || 0;

        card.querySelectorAll('.system-notification').forEach(notification => notification.remove());

        let badgeMarkup = '';
        if (unlockedUnread > 0) {
          badgeMarkup = `
            <div class="system-notification unlocked">
              <span class="notification-count">${unlockedUnread}</span>
              <div class="notification-pulse"></div>
            </div>
          `;
        } else if (lockedUnread > 0) {
          badgeMarkup = `
            <div class="system-notification locked">
              <span class="notification-count">${lockedUnread}</span>
              <span class="notification-lock"></span>
              <div class="notification-pulse"></div>
            </div>
          `;
        }

        if (badgeMarkup) {
          card.insertAdjacentHTML('afterbegin', badgeMarkup);
        }
      });
    }
    
    // Helper function to check if a date is paid
    function checkIfPaid(date, payments) {
      if (!payments || payments.length === 0) return false;
      
      const payment = payments.find(p => 
        p.date.getDate() === date.getDate() &&
        p.date.getMonth() === date.getMonth() &&
        p.date.getFullYear() === date.getFullYear()
      );
      
      return payment && payment.status === 'paid';
    }
    
    // Helper function to get course name by ID
    function getCourseNameById(courseId, courses) {
      if (!courses) return 'Your Class';
      const course = courses.find(c => c.id === courseId);
      return course ? course.name : 'Your Class';
    }
    
    // Fetch data from Google Classroom API
    async function fetchGoogleClassroomData(type, accessToken, studentEmail) {
      let endpoint = '';
      let allResults = [];
      
      try {
        if (type === 'courses') {
          // Fetch courses where this specific student email is enrolled
          endpoint = `https://classroom.googleapis.com/v1/courses?studentId=${encodeURIComponent(studentEmail)}&courseStates=ACTIVE`;
          const response = await fetch(endpoint, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
          });
          
          if (!response.ok) throw new Error(`${response.status}`);
          const data = await response.json();
          return data.courses || [];
          
        } else if (type === 'announcements') {
          // First get courses for this student
          const courses = await fetchGoogleClassroomData('courses', accessToken, studentEmail);
          
          // Fetch announcements from their courses
          for (const course of courses) {
            endpoint = `https://classroom.googleapis.com/v1/courses/${course.id}/announcements?orderBy=updateTime%20desc`;
            const response = await fetch(endpoint, {
              headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            
            if (response.ok) {
              const data = await response.json();
              if (data.announcements) {
                allResults.push(...data.announcements.map(a => ({ ...a, courseId: course.id })));
              }
            }
          }
          
          return allResults;
          
        } else if (type === 'coursework') {
          // First get courses for this student
          const courses = await fetchGoogleClassroomData('courses', accessToken, studentEmail);
          
          // Fetch coursework from their courses
          for (const course of courses) {
            endpoint = `https://classroom.googleapis.com/v1/courses/${course.id}/courseWork?orderBy=updateTime%20desc`;
            const response = await fetch(endpoint, {
              headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            
            if (response.ok) {
              const data = await response.json();
              if (data.courseWork) {
                allResults.push(...data.courseWork.map(w => ({ ...w, courseId: course.id })));
              }
            }
          }
          
          return allResults;
        }
        
      } catch (error) {
        console.error(`Error fetching ${type}:`, error);
        throw error;
      }
      
      return allResults;
    }
    
    // Get service account token from Firebase Cloud Function
    async function getServiceAccountToken() {
      try {
        // Call your Firebase function to get service account access token
        const getToken = functions.httpsCallable('getClassroomServiceToken');
        const result = await getToken();
        
        if (result.data && result.data.accessToken) {
          const token = result.data.accessToken;
          // Cache for 50 minutes (tokens expire in 60)
          localStorage.setItem('classroomAccessToken', token);
          localStorage.setItem('tokenExpiry', Date.now() + (50 * 60 * 1000));
          return token;
        }
      } catch (error) {
        console.error('Error getting service account token:', error);
      }
      return null;
    }
    
    // Check if cached token is still valid
    function getCachedToken() {
      const token = localStorage.getItem('classroomAccessToken');
      const expiry = localStorage.getItem('tokenExpiry');
      
      if (token && expiry && Date.now() < parseInt(expiry)) {
        return token;
      }
      
      // Token expired or doesn't exist
      localStorage.removeItem('classroomAccessToken');
      localStorage.removeItem('tokenExpiry');
      return null;
    }
    
    // ==========================================================================
    // NCLEX SYSTEMS PROGRESS
    // ==========================================================================
    // NCLEX Systems Data - All 24 Body Systems
    const DEFAULT_SYSTEMS = [
      // Core Systems (10)
      { name: 'Cardiovascular', icon: '', status: 'not-started', progress: 0 },
      { name: 'Respiratory', icon: '', status: 'not-started', progress: 0 },
      { name: 'Neurological', icon: '', status: 'not-started', progress: 0 },
      { name: 'Gastrointestinal', icon: '', status: 'not-started', progress: 0 },
      { name: 'Renal', icon: '', status: 'not-started', progress: 0 },
      { name: 'Endocrine', icon: '', status: 'not-started', progress: 0 },
      { name: 'Musculoskeletal', icon: '', status: 'not-started', progress: 0 },
      { name: 'Integumentary', icon: '', status: 'not-started', progress: 0 },
      { name: 'Immune', icon: '', status: 'not-started', progress: 0 },
      { name: 'Hematologic', icon: '', status: 'not-started', progress: 0 },
      
      // Specialized Systems (14)
      { name: 'Reproductive', icon: '', status: 'not-started', progress: 0 },
      { name: 'Sensory (Eyes/Ears)', icon: '', status: 'not-started', progress: 0 },
      { name: 'Mental Health', icon: '', status: 'not-started', progress: 0 },
      { name: 'Maternal Health', icon: '', status: 'not-started', progress: 0 },
      { name: 'Pediatrics', icon: '', status: 'not-started', progress: 0 },
      { name: 'Oncology', icon: '', status: 'not-started', progress: 0 },
      { name: 'Infectious Diseases', icon: '', status: 'not-started', progress: 0 },
      { name: 'Autoimmune Disorders', icon: '', status: 'not-started', progress: 0 },
      { name: 'Pain Management', icon: '', status: 'not-started', progress: 0 },
      { name: 'Gerontology', icon: '', status: 'not-started', progress: 0 },
      { name: 'Emergency Care', icon: '', status: 'not-started', progress: 0 },
      { name: 'Critical Care', icon: '', status: 'not-started', progress: 0 },
      { name: 'Pharmacology', icon: '', status: 'not-started', progress: 0 },
      { name: 'Nursing Fundamentals', icon: '', status: 'not-started', progress: 0 }
    ];

        let nclexSystems = DEFAULT_SYSTEMS.map(system => ({ ...system }));
    
        // Global variable to store all notes
        let allSystemNotes = [];
        let selectedSystem = null;
        let systemMetaMap = new Map();
        let systemAssignmentStats = new Map();

        // Helper function to normalize system names for matching
        function normalizeSystemName(name) {
          if (!name) return '';
          // Remove " System" suffix and normalize case for comparison
          return name.replace(/\s+System$/i, '').trim();
        }

        function buildSystemAssignmentStats() {
          const stats = new Map();
          allSystemNotes.forEach(note => {
            const systemName = note.system;
            if (!systemName) return;
            
            // Normalize the system name (remove " System" suffix)
            const normalizedName = normalizeSystemName(systemName);
            
            if (!stats.has(normalizedName)) {
              stats.set(normalizedName, {
                totalNotes: 0,
                viewedNotes: 0,
                assignedTemplates: new Set(),
                lockedUnread: 0,
                unlockedUnread: 0
              });
            }
            const entry = stats.get(normalizedName);
            
            // Count total notes
            entry.totalNotes += 1;
            
            // Count viewed notes (opened PDFs)
            if (note.read) {
              entry.viewedNotes += 1;
            }
            
            const templateKey = note.templateId || note.id;
            if (templateKey) {
              entry.assignedTemplates.add(templateKey);
            }
            if (!note.read) {
              if (note.isPaid) {
                entry.unlockedUnread += 1;
              } else {
                entry.lockedUnread += 1;
              }
            }
          });
          stats.forEach(entry => {
            entry.assignedCount = entry.assignedTemplates.size;
          });
          return stats;
        }

        function refreshSystemAssignmentStats() {
          systemAssignmentStats = buildSystemAssignmentStats();
        }

        function calculateSystemProgressFromCounts(assignedCount, totalTemplates) {
          // NEW: Calculate progress based on notes viewed, not just assigned
          const stats = systemAssignmentStats.get('Cardiovascular'); // Example - will be replaced per system
          if (stats && stats.totalNotes > 0) {
            // Progress = (viewed notes / total notes) * 100
            return Math.min(100, Math.round((stats.viewedNotes / stats.totalNotes) * 100));
          }
          // Fallback to old logic if no stats available
          if (totalTemplates > 0) {
            return Math.min(100, Math.round((assignedCount / totalTemplates) * 100));
          }
          return assignedCount > 0 ? 60 : 0;
        }

        function determineSystemStatus(meta, assignedCount) {
          if (meta?.is_current) return 'current';
          const totalTemplates = meta?.totalTemplates ?? 0;
          if (totalTemplates > 0 && assignedCount >= totalTemplates && assignedCount > 0) {
            return 'completed';
          }
          if (assignedCount > 0) {
            return 'in-progress';
          }
          return 'not-started';
        }

        function getSystemStatusLabel(status) {
          switch (status) {
            case 'completed':
              return 'Completed';
            case 'current':
              return 'Ongoing';
            case 'in-progress':
              return 'In Progress';
            default:
              return 'Not Started';
          }
        }
    
    /**
     * Loads NCLEX body systems progress carousel from note folders.
     * 
     * @async
     * @returns {Promise<void>}
     * 
     * @description
     * Displays student progress across NCLEX body systems:
     * 1. Queries note_folders table for all active systems
     * 2. Counts total note_templates per folder
     * 3. Counts completed assignments via note_assignments table
     * 4. Calculates progress percentage per system
     * 5. Renders carousel cards with progress bars
     * 6. Highlights current system (is_current = true)
     * 
     * Each card shows:
     * - System icon and name
     * - Completed/Total count (e.g., "3/10")
     * - Visual progress bar
     * - "Current" badge if applicable
     * 
     * Sorted by sort_order from database.
     * 
     * @example
     * await loadSystemsProgress();
     * // Renders: [ Cardiovascular 7/15] [ Neurological 2/12] [ Respiratory 0/8]
     */
    async function loadSystemsProgress() {
      const carousel = document.getElementById('systemsCarousel');
      if (!carousel) return;

      refreshSystemAssignmentStats();

      carousel.innerHTML = '<div class="system-card loading" style="min-height: 140px; justify-content: center; align-items: center;">Loading systems...</div>';

      try {
        const { data: folders, error } = await supabase
          .from('note_folders')
          .select(`
            id,
            folder_name,
            icon,
            sort_order,
            note_templates (id)
          `)
          .is('deleted_at', null) // FIX: Use deleted_at column
          .order('sort_order', { ascending: true });

        if (error) {
          throw error;
        }

        const assignmentStats = systemAssignmentStats || new Map();

        if (folders && folders.length) {
          systemMetaMap = new Map();
          nclexSystems = folders.map(folder => {
            const totalTemplates = Array.isArray(folder.note_templates) ? folder.note_templates.length : 0;
            const meta = {
              totalTemplates,
              is_current: false, // Default to false (column doesn't exist)
              icon: folder.icon || ''
            };
            systemMetaMap.set(folder.folder_name, meta);
            const stats = assignmentStats.get(folder.folder_name);
            const totalNotes = stats?.totalNotes || 0;
            const viewedNotes = stats?.viewedNotes || 0;
            // Calculate progress based on viewed/total notes
            const progress = totalNotes > 0 ? Math.min(100, Math.round((viewedNotes / totalNotes) * 100)) : 0;
            const status = determineSystemStatus(meta, stats?.assignedCount || 0);
            return {
              id: folder.id,
              name: folder.folder_name,
              icon: meta.icon,
              totalTemplates: totalNotes, // Show total accessible notes, not templates
              progress,
              status
            };
          });
        } else {
          systemMetaMap = new Map();
          nclexSystems = DEFAULT_SYSTEMS.map(system => {
            const meta = {
              totalTemplates: 0,
              is_current: system.status === 'current',
              icon: system.icon || ''
            };
            systemMetaMap.set(system.name, meta);
            const stats = assignmentStats.get(system.name);
            const totalNotes = stats?.totalNotes || 0;
            const viewedNotes = stats?.viewedNotes || 0;
            // Calculate progress based on viewed/total notes
            const progress = totalNotes > 0 ? Math.min(100, Math.round((viewedNotes / totalNotes) * 100)) : 0;
            const status = determineSystemStatus(meta, stats?.assignedCount || 0) || system.status;
            return {
              ...system,
              totalTemplates: totalNotes, // Show total accessible notes
              progress,
              status
            };
          });
        }
      } catch (error) {
        console.error(' Error loading note folders for systems carousel:', error);
        const assignmentStats = systemAssignmentStats || new Map();
        nclexSystems = (nclexSystems.length ? nclexSystems : DEFAULT_SYSTEMS).map(system => {
          const meta = systemMetaMap.get(system.name) || {
            totalTemplates: 0,
            is_current: system.status === 'current',
            icon: system.icon || ''
          };
          const stats = assignmentStats.get(system.name);
          const assignedCount = stats?.assignedCount || 0;
          const progress = calculateSystemProgressFromCounts(assignedCount, meta.totalTemplates);
          const status = determineSystemStatus(meta, assignedCount) || system.status;
          return {
            ...system,
            progress,
            status
          };
        });
      }

      renderSystemsCarousel();
      updateSystemNotifications();
    }

    function renderSystemsCarousel() {
      const carousel = document.getElementById('systemsCarousel');
      if (!carousel) return;

      carousel.innerHTML = '';

      if (nclexSystems.length === 0) {
        carousel.innerHTML = '<div class="system-card" style="justify-content:center; align-items:center; min-height:140px;">No systems configured yet.</div>';
        return;
      }

      nclexSystems.forEach((system, index) => {
        const card = document.createElement('div');
        card.className = `system-card ${system.status || 'not-started'}`;
        card.dataset.systemName = system.name;
        card.style.animationDelay = `${index * 0.05}s`;

        if (selectedSystem === system.name) {
          card.classList.add('selected');
        }

  const stats = systemAssignmentStats.get(system.name);
  const unlockedUnreadCount = stats?.unlockedUnread || 0;
  const lockedUnreadCount = stats?.lockedUnread || 0;
        const statusLabel = getSystemStatusLabel(system.status);

        let notificationBadge = '';
        if (unlockedUnreadCount > 0) {
          notificationBadge = `
            <div class="system-notification unlocked">
              <span class="notification-count">${unlockedUnreadCount}</span>
              <div class="notification-pulse"></div>
            </div>
          `;
        } else if (lockedUnreadCount > 0) {
          notificationBadge = `
            <div class="system-notification locked">
              <span class="notification-count">${lockedUnreadCount}</span>
              <span class="notification-lock"></span>
              <div class="notification-pulse"></div>
            </div>
          `;
        }

        card.innerHTML = `
          ${notificationBadge}
          <div class="system-icon">${system.icon}</div>
          <div class="system-name">${system.name}</div>
          <div class="system-progress">${system.progress}% Complete</div>
          <div class="system-bar">
            <div class="system-bar-fill" style="width: ${system.progress}%"></div>
          </div>
          <div class="system-status">${statusLabel}</div>
        `;

        card.addEventListener('click', () => {
          centerSystemCard(card);
          filterNotesBySystem(system.name);
        });

        carousel.appendChild(card);
      });

      setTimeout(() => {
        const escapedName = selectedSystem && typeof CSS !== 'undefined' && CSS.escape
          ? CSS.escape(selectedSystem)
          : selectedSystem;
        const focusCard = selectedSystem && escapedName
          ? carousel.querySelector(`.system-card[data-system-name="${escapedName}"]`)
          : carousel.querySelector('.system-card.current') || carousel.firstElementChild;
        if (focusCard) {
          centerSystemCard(focusCard);
        }
      }, 300);
    }

    function centerSystemCard(card) {
      const carousel = document.getElementById('systemsCarousel');
      if (!carousel || !card) return;

      const container = carousel.parentElement;
      if (!container) return;

      const containerWidth = container.getBoundingClientRect().width;
      const cardWidth = card.getBoundingClientRect().width;
      const target = card.offsetLeft - (containerWidth / 2) + (cardWidth / 2);
      const maxScroll = carousel.scrollWidth - carousel.clientWidth;
      const clamped = Math.max(0, Math.min(target, maxScroll));

      carousel.scrollTo({
        left: clamped,
        behavior: 'smooth'
      });
    }
    
    // Carousel navigation
    function scrollCarousel(direction) {
      const carousel = document.getElementById('systemsCarousel');
      const scrollAmount = 220; // card width + gap
      carousel.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
      });
    }
    
    // Display notes with lock/unlock status
    function displayNotes(notes) {
      const classroomList = document.getElementById('classroomList');
      classroomList.innerHTML = '';
      
      if (notes.length === 0) {
        const emptyMessage = document.createElement('div');
        emptyMessage.style.cssText = 'text-align: center; color: rgba(255,255,255,0.7); padding: 40px;';
        emptyMessage.textContent = 'No notes available yet.';
        classroomList.appendChild(emptyMessage);
        return;
      }
      
      // Group notes by system
      const notesBySystem = new Map();
      notes.forEach(note => {
        const systemName = normalizeSystemName(note.system || 'Other');
        if (!notesBySystem.has(systemName)) {
          notesBySystem.set(systemName, []);
        }
        notesBySystem.get(systemName).push(note);
      });
      
      // Render notes in a grid without system headers
      const notesGrid = document.createElement('div');
      notesGrid.className = 'notes-grid';
      notesGrid.style.cssText = `
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        padding: 0 4px;
      `;
      
      // Add all notes to the grid
      notes.forEach(note => {
        const item = createNoteCard(note);
        notesGrid.appendChild(item);
      });
      
      classroomList.appendChild(notesGrid);
    }
    
    // Helper function to create individual note cards
    function createNoteCard(note) {
      const item = document.createElement('div');
      const noteTypeClass = note.type === 'warning' ? 'warning' : (note.type || 'material');
      const lockedClass = !note.isPaid && note.type !== 'warning' ? 'locked' : '';
      item.className = `classroom-item ${noteTypeClass} ${lockedClass} note-collapsed`;
      
      // Clean up title - remove "Bulk uploaded - " prefix
      let cleanTitle = note.title || 'Untitled Note';
      cleanTitle = cleanTitle.replace(/^Bulk uploaded\s*-\s*/i, '').trim();
      
      // Clean up description text - remove "Bulk uploaded - " prefix
      let cleanText = note.text || 'Click to view note content...';
      cleanText = cleanText.replace(/^Bulk uploaded\s*-\s*/i, '').trim();
      
      // Create unique ID for this note card
      const noteCardId = `note-card-${note.id}`;
      item.id = noteCardId;
        
      // Determine the badge icon and text
      let badgeIcon = note.folderIcon || '';
      let badgeText = note.course || 'Note';
      
      if (note.type === 'warning' && note.isTemplateMissing) {
        badgeIcon = '';
        badgeText = 'Missing Content';
      } else if (!note.isPaid) {
        badgeIcon = '';
        badgeText = 'Payment Required';
      } else if (note.type === 'announcement') {
        badgeIcon = '';
        badgeText = note.course || 'Announcement';
      } else if (note.type === 'material') {
        badgeIcon = note.folderIcon || '';
        badgeText = note.course || 'Material';
      }
      
      // Build attachments HTML - hidden by default, shown on click
      let attachmentsHTML = '';
      if (note.isTemplateMissing) {
        attachmentsHTML = `
          <div class="note-attachments" style="display: none; margin-top: 15px; padding: 15px; border-radius: 12px; background: rgba(255,168,0,0.1); border: 1px solid rgba(255,168,0,0.4); color: #ffb347;">
            This note template has been removed or is not available. Please contact an administrator to restore it.
          </div>
        `;
      } else if (note.attachments && note.attachments.length > 0 && note.isPaid) {
        attachmentsHTML = '<div class="note-attachments" style="display: none; margin-top: 15px; flex-direction: column; gap: 10px;">';
        note.attachments.forEach(attachment => {
          const icon = attachment.type === 'video' ? '' : 
                      attachment.type === 'link' ? '' : 
                      attachment.type === 'pdf' ? '' : '';
          
          // For PDF attachments from our system, use Protected-PDF-Viewer
          const clickHandler = attachment.type === 'pdf' 
            ? `event.stopPropagation(); window.open('Protected-PDF-Viewer.html?url=${encodeURIComponent(attachment.url)}&title=${encodeURIComponent(attachment.title)}', '_blank')`
            : `event.stopPropagation(); window.open('${attachment.url}', '_blank')`;
          
          attachmentsHTML += `
            <button style="
              width: 100%;
              padding: 14px 18px;
              border-radius: 12px;
              background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(59,130,246,0.1));
              border: 1px solid rgba(102,126,234,0.4);
              color: rgba(255,255,255,0.95);
              font-size: 15px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.3s ease;
              display: flex;
              align-items: center;
              gap: 12px;
            " onclick="${clickHandler}"
               onmouseover="this.style.background='linear-gradient(135deg, rgba(102,126,234,0.3), rgba(59,130,246,0.15))'; this.style.boxShadow='0 4px 20px rgba(102,126,234,0.4)'"
               onmouseout="this.style.background='linear-gradient(135deg, rgba(102,126,234,0.2), rgba(59,130,246,0.1))'; this.style.boxShadow='none'">
              <span style="font-size: 24px;">${icon}</span>
              <span style="flex: 1; text-align: left;">${attachment.title}</span>
              <span style="font-size: 18px;"></span>
            </button>
          `;
        });
        attachmentsHTML += '</div>';
      } else if (note.attachments && note.attachments.length > 0 && !note.isPaid) {
        attachmentsHTML = `
          <div class="note-attachments" style="display: none; margin-top: 18px; padding: 20px; border-radius: 16px; background: linear-gradient(135deg, rgba(234,67,53,0.15), rgba(197,34,31,0.08)); border: 1px solid rgba(234,67,53,0.35); text-align: center;">
            <div style="font-size: 48px; margin-bottom: 12px; filter: blur(8px);"></div>
            <div style="font-size: 16px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 6px; filter: blur(6px);">
              ${note.attachments.length} file${note.attachments.length !== 1 ? 's' : ''} locked
            </div>
            <div style="font-size: 13px; color: rgba(255,255,255,0.6); filter: blur(6px);">
              Complete payment for ${note.date.toLocaleDateString()} to unlock
            </div>
          </div>
        `;
      }
      
      // For locked notes, blur everything except title
      const contentBlur = !note.isPaid ? 'filter: blur(8px); user-select: none; pointer-events: none;' : '';
      const badgeBlur = !note.isPaid ? 'filter: blur(8px);' : '';
      
      item.innerHTML = `
        <div class="note-content-area">
          <div class="classroom-header">
            <div>
              <div class="classroom-title">
                ${note.isPaid ? '' : ' '}${cleanTitle}
              </div>
            </div>
            <div class="classroom-date" style="${contentBlur}">${note.date.toLocaleDateString()}</div>
          </div>
        </div>
        
        <div class="note-footer-area">
          <div class="note-badge-container">
            <span class="classroom-badge ${note.isPaid ? note.type || 'material' : 'locked'}" style="${badgeBlur}">${badgeIcon} ${badgeText}</span>
          </div>
          ${note.isPaid && (note.attachments?.length > 0 || note.isTemplateMissing) ? '<div class="note-expand-indicator" style="text-align: center; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); font-size: 20px; user-select: none; cursor: pointer;"></div>' : '<div style="height: 29px;"></div>'}
        </div>
        
        ${attachmentsHTML}
      `;
      
      // Add click handler to expand/collapse note (only for unlocked notes with attachments)
      if (note.isPaid && (note.attachments?.length > 0 || note.isTemplateMissing)) {
        item.style.cursor = 'pointer';
        item.addEventListener('click', (e) => {
          // Don't expand if clicking on a button inside
          if (e.target.tagName === 'BUTTON') return;
          
          const isCollapsed = item.classList.contains('note-collapsed');
          const attachmentsDiv = item.querySelector('.note-attachments');
          const indicator = item.querySelector('.note-expand-indicator');
          
          if (isCollapsed) {
            // Expand
            item.classList.remove('note-collapsed');
            item.classList.add('note-expanded');
            if (attachmentsDiv) attachmentsDiv.style.display = 'flex';
            if (indicator) indicator.innerHTML = '';
          } else {
            // Collapse
            item.classList.add('note-collapsed');
            item.classList.remove('note-expanded');
            if (attachmentsDiv) attachmentsDiv.style.display = 'none';
            if (indicator) indicator.innerHTML = '';
          }
        });
      } else if (!note.isPaid && !note.isTemplateMissing) {
        // Locked notes show payment dialog
        item.style.cursor = 'pointer';
        item.addEventListener('click', () => {
          showLockedNoteDialog(note.date.toLocaleDateString());
        });
      }
      
      return item;
    }
    
    // ==========================================================================
    // IMPERSONATION MODE FUNCTIONS
    // ==========================================================================
    
    // Show impersonation banner
    function showImpersonationBanner(token) {
      const banner = document.getElementById('impersonationBanner');
      const studentNameEl = document.getElementById('impersonatedStudentName');
      const timerEl = document.getElementById('impersonationTimer');
      
      if (banner && studentNameEl) {
        studentNameEl.textContent = token.studentName;
        banner.style.display = 'flex';
        
        // PERFORMANCE FIX: Update timer every 10 seconds instead of 1 second
        // Still shows countdown but with 90% less CPU usage
        updateImpersonationTimer(token, timerEl);
        intervalManager.set('impersonation', () => {
          updateImpersonationTimer(token, timerEl);
        }, 10000); // 10 seconds instead of 1 second
      }
    }
    
    // Update impersonation timer display
    function updateImpersonationTimer(token, timerEl) {
      const remainingMs = token.expiresAt - Date.now();
      
      if (remainingMs <= 0) {
        // Session expired
        intervalManager.clear('impersonation');
        alert('Impersonation session has expired.');
        exitImpersonation();
        return;
      }
      
      const minutes = Math.floor(remainingMs / 1000 / 60);
      const seconds = Math.floor((remainingMs / 1000) % 60);
      
      if (timerEl) {
        timerEl.textContent = `Expires in ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Warning when less than 1 minute remaining
        if (minutes === 0 && seconds <= 60) {
          timerEl.style.color = '#fbbf24';
          timerEl.style.fontWeight = '700';
        }
      }
    }
    
    /**
     * Exits admin impersonation mode and returns to admin panel.
     * 
     * @returns {void}
     * 
     * @description
     * Cleans up impersonation session:
     * 1. Removes impersonation_token from sessionStorage
     * 2. Clears impersonation timer interval
     * 3. Clears countdown timer interval
     * 4. Redirects to Student-Portal-Admin.html
     * 
     * Critical security function - ensures admin can't accidentally remain
     * in impersonation mode. Called by "Exit Impersonation" button.
     * 
     * @example
     * <button onclick="exitImpersonation()">Exit Impersonation</button>
     */
    function exitImpersonation() {
      // Clear impersonation data from both storages
      sessionStorage.removeItem('impersonation_token');
      localStorage.removeItem('impersonation_token');
      intervalManager.clear('impersonation');
      intervalManager.clear('countdown');
      
      // Log exit
      console.log(' Exiting impersonation mode');
      
      // Redirect back to admin panel
      window.location.href = 'Student-Portal-Admin.html';
    }
    
    // ==========================================================================
    // SESSION TRACKING
    // ==========================================================================
    let sessionId = null;
    let sessionHeartbeatInterval = null;
    
    async function startSession() {
      // VALIDATION 1: Ensure we have a valid student
      if (!currentStudent || !currentStudent.id) {
        console.warn(' Cannot start session: No student data');
        return;
      }
      
      // CRITICAL VALIDATION 2: NEVER track sessions during admin impersonation
      // This prevents false "online" status when admins view student portals
      const urlParams = new URLSearchParams(window.location.search);
      const isImpersonating = urlParams.get('impersonate');
      
      // Also check sessionStorage for impersonation token
      const impersonationToken = sessionStorage.getItem('impersonation_token') || 
                                 localStorage.getItem('impersonation_token');
      
      if (isImpersonating || impersonationToken) {
        console.log(' SESSION TRACKING BLOCKED: Admin impersonation mode detected', {
          urlParam: isImpersonating,
          hasToken: !!impersonationToken,
          student: currentStudent.name
        });
        return;
      }
      
      // VALIDATION 3: Ensure this is a real student login
      console.log(' Starting REAL student session:', {
        studentId: currentStudent.id,
        studentName: currentStudent.name,
        timestamp: new Date().toISOString()
      });
      
      try {
        // Create new session
        const nowIso = new Date().toISOString();
        const { data, error } = await supabase
          .from('student_sessions')
          .insert([{
            student_id: currentStudent.id,
            session_start: nowIso,
            last_activity: nowIso,
            is_active: true
          }])
          .select()
          .single();
        
        if (error) {
          console.error('Error starting session:', error);
          return;
        }
        
        if (DEBUG_MODE) console.log('Session started:', data);
        sessionId = data.id;
        
        // PERFORMANCE FIX: Heartbeat every 5 minutes instead of 2 minutes
        // Reduces Supabase load by 60% while still tracking activity
        intervalManager.set('sessionHeartbeat', updateSessionActivity, 5 * 60 * 1000); // 5 minutes
        
        // Update activity on page visibility change
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            updateSessionActivity();
          }
        });
        
      } catch (error) {
        console.error('Session start error:', error);
      }
    }
    
    async function updateSessionActivity() {
      if (!sessionId) return;
      
      try {
        await supabase
          .from('student_sessions')
          .update({ last_activity: new Date().toISOString() })
          .eq('id', sessionId);
      } catch (error) {
        console.error('Error updating session activity:', error);
      }
    }
    
    async function endSession() {
      if (!sessionId) return;
      
      try {
        await supabase
          .from('student_sessions')
          .update({
            session_end: new Date().toISOString(),
            is_active: false
          })
          .eq('id', sessionId);
        
        if (sessionHeartbeatInterval) {
          clearInterval(sessionHeartbeatInterval);
          sessionHeartbeatInterval = null;
        }
      } catch (error) {
        console.error('Error ending session:', error);
      }
    }
    
    // ==========================================================================
    // PORTAL INITIALIZATION
    // ==========================================================================
    (async function initPortal() {
      try {
        // Check authentication and load student
        // NOTE: checkAuthentication() internally calls loadPortalData() after auth success
        currentStudent = await checkAuthentication();
        
        if (!currentStudent) {
          // checkAuthentication() will handle redirect
          return;
        }
        
        // Start session tracking (skip for impersonation mode)
        const urlParams = new URLSearchParams(window.location.search);
        const isImpersonating = urlParams.get('impersonate');
        
        if (!isImpersonating) {
          // Only track real student sessions, not admin impersonations
          await startSession();
        } else {
          if (DEBUG_MODE) console.log(' Skipping session tracking for impersonation mode');
        }
        
        // PERFORMANCE FIX: Removed duplicate loadPortalData() call
        // It's already called inside checkAuthentication() after auth verification
        
        // Check if admin chat mode - hide portal content and show only forum
        if (currentStudent && currentStudent.isAdminChatMode) {
          console.log(' Admin chat mode - hiding portal content, showing only forum');
          // Hide ALL portal elements except the forum modal
          const container = document.querySelector('.container');
          const header = document.querySelector('.header');
          if (container) container.style.display = 'none';
          if (header) header.style.display = 'none';
          // Also hide body background and set to dark
          document.body.style.background = 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)';
          document.body.style.margin = '0';
          document.body.style.padding = '0';
          document.body.style.overflow = 'hidden';
          // Open forum immediately and center it
          setTimeout(() => {
            toggleForum();
            // Style the forum modal to take full screen in iframe
            const forumModal = document.getElementById('forumModal');
            if (forumModal) {
              forumModal.style.position = 'fixed';
              forumModal.style.top = '0';
              forumModal.style.left = '0';
              forumModal.style.right = '0';
              forumModal.style.bottom = '0';
              forumModal.style.margin = '0';
              forumModal.style.maxWidth = 'none';
              forumModal.style.height = '100vh';
              forumModal.style.borderRadius = '0';
            }
          }, 100);
        }
        // Check if URL has #forum hash and automatically open forum
        else if (window.location.hash === '#forum') {
          console.log(' Auto-opening forum from URL hash');
          // Wait a bit for DOM to be ready
          setTimeout(() => {
            toggleForum();
          }, 500);
        }
        
      } catch (error) {
        console.error(' Portal initialization failed:', error);
        alert('Failed to load portal. Please try again.');
        window.location.href = 'index.html';
      }
    })();
  </script>
</body>
</html>
