<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Manager - ARNOMA</title>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      padding: 30px 40px;
      border-radius: 16px;
      margin-bottom: 30px;
      border: 1px solid rgba(102, 126, 234, 0.3);
      box-shadow: 0 25px 60px rgba(13, 16, 35, 0.7);
    }

    h1 {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #f093fb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
    }

    .tab {
      padding: 14px 28px;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 80, 0.5));
      border: 1.5px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 15px;
      color: rgba(255, 255, 255, 0.8);
    }

    .tab:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
    }

    .tab.active {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.25), rgba(118, 75, 162, 0.2));
      border-color: #667eea;
      color: #ffffff;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      padding: 35px;
      box-shadow: 0 25px 60px rgba(13, 16, 35, 0.7);
      margin-bottom: 25px;
    }

    .card h2 {
      font-size: 22px;
      margin-bottom: 20px;
      color: #ffffff;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.9);
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 14px 16px;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 80, 0.5));
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      color: #ffffff;
      font-size: 15px;
      transition: all 0.2s;
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 120px;
      font-family: 'Courier New', monospace;
      line-height: 1.6;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .option-inputs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 10px 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      transition: all 0.2s;
    }

    .radio-label:hover {
      background: rgba(102, 126, 234, 0.15);
    }

    input[type="radio"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .btn {
      padding: 14px 28px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 24px rgba(102, 126, 234, 0.4);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover {
      background: linear-gradient(135deg, #7c3aed, #9333ea);
      box-shadow: 0 10px 32px rgba(102, 126, 234, 0.6);
      transform: translateY(-2px);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-secondary {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 80, 0.5));
      border: 1.5px solid rgba(255, 255, 255, 0.12);
    }

    .btn-secondary:hover {
      background: linear-gradient(145deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.12));
      border-color: #667eea;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 6px 24px rgba(239, 68, 68, 0.4);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      box-shadow: 0 10px 32px rgba(239, 68, 68, 0.6);
    }

    .question-list {
      display: grid;
      gap: 16px;
    }

    .question-item {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 80, 0.5));
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .question-item:hover {
      border-color: rgba(102, 126, 234, 0.4);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .question-text {
      font-size: 16px;
      font-weight: 600;
      color: #ffffff;
      flex: 1;
    }

    .question-actions {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
    }

    .options-display {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .option-display {
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      border-left: 3px solid transparent;
    }

    .option-display.correct {
      border-left-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }

    .alert {
      padding: 14px 18px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid;
    }

    .alert-success {
      background: rgba(34, 197, 94, 0.15);
      border-color: rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }

    .alert-error {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.3);
      color: #3b82f6;
    }

    .bulk-format-help {
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      font-size: 13px;
      line-height: 1.8;
      color: rgba(255, 255, 255, 0.8);
    }

    .bulk-format-help h3 {
      font-size: 16px;
      margin-bottom: 12px;
      color: #667eea;
    }

    .bulk-format-help code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      color: #f093fb;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 80, 0.5));
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #f093fb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-label {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 6px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.7);
    }

    .loading::after {
      content: '';
      display: block;
      width: 50px;
      height: 50px;
      margin: 20px auto;
      border: 4px solid rgba(102, 126, 234, 0.3);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .option-inputs {
        grid-template-columns: 1fr;
      }

      .options-display {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üìù Test Question Manager</h1>
    <p class="subtitle">Create and manage test questions for your students</p>
  </div>

  <!-- Stats -->
  <div class="stats">
    <div class="stat-card">
      <div class="stat-value" id="totalQuestions">0</div>
      <div class="stat-label">Total Questions</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('tests')">üì¶ Manage Tests</div>
    <div class="tab" onclick="switchTab('single')">‚ûï Add Single Question</div>
    <div class="tab" onclick="switchTab('bulk')">üìã Bulk Import</div>
    <div class="tab" onclick="switchTab('json')">üìÑ JSON Upload</div>
    <div class="tab" onclick="switchTab('qbank')">üè¶ Q-Bank</div>
    <div class="tab" onclick="switchTab('reactions')">üí¨ Reactions</div>
    <div class="tab" onclick="switchTab('manage')">üìö Manage Questions</div>
  </div>

  <!-- Tests Management Tab -->
  <div id="testsTab" class="tab-content active">
    <div class="card">
      <h2>Create New Test</h2>
      <p class="subtitle" style="margin-bottom: 25px;">Create a new test box that students can take. Each test contains its own set of questions.</p>
      
      <div id="testsAlert"></div>

      <div class="form-group">
        <label>System / Category</label>
        <input type="text" id="testSystem" placeholder="e.g., Cardiovascular, Respiratory, Renal">
      </div>

      <div class="form-group">
        <label>Test Name</label>
        <input type="text" id="testName" placeholder="e.g., Cardiovascular Medications Test">
      </div>

      <div class="form-group">
        <label>Description (Optional)</label>
        <textarea id="testDescription" rows="3" placeholder="Brief description of what this test covers..."></textarea>
      </div>

      <div class="form-group">
        <label>üè¶ Add Q-Bank to This Test (Optional)</label>
        <select id="testQBank" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
          <option value="">No Q-Bank (Add questions manually later)</option>
        </select>
        <p style="font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 8px;">üí° Select a Q-Bank to automatically add all its questions to this test</p>
      </div>

      <button class="btn" onclick="createNewTest()">üì¶ Create Test</button>
    </div>

    <!-- Existing Tests -->
    <div class="card">
      <h2>Your Tests</h2>
      <div id="testsList" class="question-list">
        <div class="loading">Loading tests...</div>
      </div>
    </div>
  </div>

  <!-- Single Question Tab -->
  <div id="singleTab" class="tab-content">
    <div class="card">
      <h2>Add New Question</h2>
      
      <div id="singleAlert"></div>

      <div class="form-group">
        <label>Add Question To Test</label>
        <select id="questionTestId" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
          <option value="">Loading tests...</option>
        </select>
        <p style="font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 8px;">Select which test this question belongs to</p>
      </div>

      <div class="form-group">
        <label>Category / Topic</label>
        <select id="questionCategory" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
          <option value="Medical Terminology">Medical Terminology</option>
          <option value="Human Anatomy">Human Anatomy</option>
          <option value="Medication Suffixes and Drug Classes">Medication Suffixes and Drug Classes</option>
          <option value="Cardiovascular System">Cardiovascular System</option>
          <option value="Endocrine System">Endocrine System</option>
          <option value="Gastrointestinal & Hepatic System">Gastrointestinal & Hepatic System</option>
          <option value="Respiratory System">Respiratory System</option>
          <option value="Renal">Renal</option>
          <option value="Fluids, Electrolytes & Nutrition">Fluids, Electrolytes & Nutrition</option>
          <option value="Eye Disorders">Eye Disorders</option>
          <option value="EENT">EENT</option>
          <option value="Burns and Skin">Burns and Skin</option>
          <option value="Reproductive and Sexual Health System">Reproductive and Sexual Health System</option>
          <option value="Maternal Health">Maternal Health</option>
          <option value="Pediatrics">Pediatrics</option>
          <option value="Medical-Surgical Care">Medical-Surgical Care</option>
          <option value="Mental Health">Mental Health</option>
          <option value="Autoimmune & Infectious Disorders">Autoimmune & Infectious Disorders</option>
          <option value="Neurology">Neurology</option>
          <option value="Cancer">Cancer</option>
          <option value="Musculoskeletal Disorders">Musculoskeletal Disorders</option>
          <option value="Psycho-Social Aspects">Psycho-Social Aspects</option>
          <option value="Nursing Skills and Fundamentals">Nursing Skills and Fundamentals</option>
          <option value="Pharmacology">Pharmacology</option>
        </select>
      </div>

      <div class="form-group">
        <label>Difficulty Level</label>
        <select id="questionDifficulty" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
          <option value="Easy">Easy</option>
          <option value="Medium" selected>Medium</option>
          <option value="Hard">Hard</option>
        </select>
      </div>

      <div class="form-group">
        <label>Question Text</label>
        <input type="text" id="questionText" placeholder="Enter your question here...">
      </div>

      <div class="form-group">
        <label>Answer Options</label>
        <div class="option-inputs">
          <input type="text" id="optionA" placeholder="Option A">
          <input type="text" id="optionB" placeholder="Option B">
          <input type="text" id="optionC" placeholder="Option C">
          <input type="text" id="optionD" placeholder="Option D">
        </div>
      </div>

      <div class="form-group">
        <label>Correct Answer</label>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="correct" value="A" checked>
            <span>Option A</span>
          </label>
          <label class="radio-label">
            <input type="radio" name="correct" value="B">
            <span>Option B</span>
          </label>
          <label class="radio-label">
            <input type="radio" name="correct" value="C">
            <span>Option C</span>
          </label>
          <label class="radio-label">
            <input type="radio" name="correct" value="D">
            <span>Option D</span>
          </label>
        </div>
      </div>

      <button class="btn" onclick="addSingleQuestion()">‚ûï Add Question</button>
    </div>
  </div>

  <!-- Bulk Import Tab -->
  <div id="bulkTab" class="tab-content">
    <div class="card">
      <h2>Bulk Import Questions</h2>

      <div class="bulk-format-help">
        <h3>üìã Format Instructions</h3>
        <p><strong>Option 1 - Simple Format:</strong></p>
        <p><code>Question text? | Option A | Option B | Option C | Option D | Correct (A/B/C/D)</code></p>
        <br>
        <p><strong>Option 2 - Multi-line Format:</strong></p>
        <p>Copy-paste questions with checkmarks (‚úîÔ∏è) or labels. System auto-detects correct answer!</p>
        <pre style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;font-size:12px;line-height:1.6;">
Long-term Amiodarone may cause:
A. Hypertension
B. Pulmonary fibrosis ‚úîÔ∏è
C. Kidney failure
D. Gallstones

Correct: B
        </pre>
        <p style="margin-top:12px;"><strong>Examples:</strong></p>
        <p><code>What is 2+2? | 3 | 4 | 5 | 6 | B</code></p>
        <p style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px;">
          üí° Tip: The system is smart - it can parse both formats!
        </p>
      </div>

      <div id="bulkAlert"></div>

      <div class="form-group">
        <label>Add Questions To Test</label>
        <select id="bulkTestId" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
          <option value="">Loading tests...</option>
        </select>
      </div>

      <div class="form-group">
        <label>Category / Topic</label>
        <select id="bulkCategory" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
          <option value="Medical Terminology">Medical Terminology</option>
          <option value="Human Anatomy">Human Anatomy</option>
          <option value="Medication Suffixes and Drug Classes">Medication Suffixes and Drug Classes</option>
          <option value="Cardiovascular System">Cardiovascular System</option>
          <option value="Endocrine System">Endocrine System</option>
          <option value="Gastrointestinal & Hepatic System">Gastrointestinal & Hepatic System</option>
          <option value="Respiratory System">Respiratory System</option>
          <option value="Renal">Renal</option>
          <option value="Fluids, Electrolytes & Nutrition">Fluids, Electrolytes & Nutrition</option>
          <option value="Eye Disorders">Eye Disorders</option>
          <option value="EENT">EENT</option>
          <option value="Burns and Skin">Burns and Skin</option>
          <option value="Reproductive and Sexual Health System">Reproductive and Sexual Health System</option>
          <option value="Maternal Health">Maternal Health</option>
          <option value="Pediatrics">Pediatrics</option>
          <option value="Medical-Surgical Care">Medical-Surgical Care</option>
          <option value="Mental Health">Mental Health</option>
          <option value="Autoimmune & Infectious Disorders">Autoimmune & Infectious Disorders</option>
          <option value="Neurology">Neurology</option>
          <option value="Cancer">Cancer</option>
          <option value="Musculoskeletal Disorders">Musculoskeletal Disorders</option>
          <option value="Psycho-Social Aspects">Psycho-Social Aspects</option>
          <option value="Nursing Skills and Fundamentals">Nursing Skills and Fundamentals</option>
          <option value="Pharmacology">Pharmacology</option>
        </select>
      </div>

      <div class="form-group">
        <label>Difficulty Level</label>
        <select id="bulkDifficulty" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
          <option value="Easy">Easy</option>
          <option value="Medium" selected>Medium</option>
          <option value="Hard">Hard</option>
        </select>
      </div>

      <div class="form-group">
        <label>Paste Questions (One per line)</label>
        <textarea id="bulkInput" placeholder="What is 2+2? | 3 | 4 | 5 | 6 | B
Capital of France? | Berlin | Paris | Rome | Madrid | B"></textarea>
      </div>

      <button class="btn" onclick="importBulkQuestions()">üì• Import Questions</button>
    </div>
  </div>

  <!-- JSON Upload Tab -->
  <div id="jsonTab" class="tab-content">
    <div class="card">
      <h2>Import from JSON</h2>

      <div class="bulk-format-help">
        <h3>üìÑ JSON Format</h3>
        <p>Upload a JSON file OR paste JSON text directly:</p>
        <pre style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;font-size:12px;line-height:1.6;">
[
  {
    "question": "What is 2+2?",
    "options": ["3", "4", "5", "6"],
    "correct_answer": "B"
  },
  {
    "question": "Capital of France?",
    "options": ["Berlin", "Paris", "Rome", "Madrid"],
    "correct_answer": "B"
  }
]
        </pre>
        <p style="margin-top:12px;font-size:13px;color:rgba(255,255,255,0.7);">
          <strong>Note:</strong> <code>correct_answer</code> can be "A", "B", "C", "D" or 0, 1, 2, 3
        </p>
      </div>

      <div id="jsonAlert"></div>

      <!-- Q-Bank Selection -->
      <div class="form-group">
        <label>üè¶ Add Questions to Q-Bank</label>
        <select id="jsonQBankId" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
          <option value="">Select a Q-Bank...</option>
          <option value="CREATE_NEW">‚ûï Create New Q-Bank</option>
        </select>
        <p style="font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 8px;">üí° Questions will be added to this Q-Bank after import</p>
      </div>

      <div class="form-group">
        <label>Category / Topic</label>
        <select id="jsonCategory" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
          <option value="Medical Terminology">Medical Terminology</option>
          <option value="Human Anatomy">Human Anatomy</option>
          <option value="Medication Suffixes and Drug Classes">Medication Suffixes and Drug Classes</option>
          <option value="Cardiovascular System">Cardiovascular System</option>
          <option value="Endocrine System">Endocrine System</option>
          <option value="Gastrointestinal & Hepatic System">Gastrointestinal & Hepatic System</option>
          <option value="Respiratory System">Respiratory System</option>
          <option value="Renal">Renal</option>
          <option value="Fluids, Electrolytes & Nutrition">Fluids, Electrolytes & Nutrition</option>
          <option value="Eye Disorders">Eye Disorders</option>
          <option value="EENT">EENT</option>
          <option value="Burns and Skin">Burns and Skin</option>
          <option value="Reproductive and Sexual Health System">Reproductive and Sexual Health System</option>
          <option value="Maternal Health">Maternal Health</option>
          <option value="Pediatrics">Pediatrics</option>
          <option value="Medical-Surgical Care">Medical-Surgical Care</option>
          <option value="Mental Health">Mental Health</option>
          <option value="Autoimmune & Infectious Disorders">Autoimmune & Infectious Disorders</option>
          <option value="Neurology">Neurology</option>
          <option value="Cancer">Cancer</option>
          <option value="Musculoskeletal Disorders">Musculoskeletal Disorders</option>
          <option value="Psycho-Social Aspects">Psycho-Social Aspects</option>
          <option value="Nursing Skills and Fundamentals">Nursing Skills and Fundamentals</option>
          <option value="Pharmacology">Pharmacology</option>
        </select>
      </div>

      <div class="form-group">
        <label>Difficulty Level</label>
        <select id="jsonDifficulty" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
          <option value="Easy">Easy</option>
          <option value="Medium" selected>Medium</option>
          <option value="Hard">Hard</option>
        </select>
      </div>

      <!-- Option 1: Paste JSON Text -->
      <div class="form-group">
        <label>üìù Option 1: Paste JSON Text</label>
        <textarea id="jsonText" rows="10" placeholder='[
  {
    "question": "Your question here?",
    "options": ["Option A", "Option B", "Option C", "Option D"],
    "correct_answer": "B"
  }
]'></textarea>
      </div>

      <button class="btn" onclick="importJSONText()" style="margin-bottom: 30px;">üìù Import from Pasted Text</button>

      <div style="text-align: center; margin: 30px 0; color: rgba(255,255,255,0.5); font-weight: 600;">
        ‚îÄ‚îÄ OR ‚îÄ‚îÄ
      </div>

      <!-- Option 2: Upload JSON File -->
      <div class="form-group">
        <label>üìÑ Option 2: Upload JSON File</label>
        <input type="file" id="jsonFile" accept=".json" style="padding:14px;cursor:pointer;">
      </div>

      <button class="btn" onclick="importJSONFile()">üì§ Import from File</button>
    </div>
  </div>

  <!-- Q-Bank Tab -->
  <div id="qbankTab" class="tab-content">
    <div class="card">
      <h2>üè¶ Question Bank Manager</h2>
      <p class="subtitle" style="margin-bottom: 25px;">Create organized question banks (Q-Banks) and easily add them to any test. Perfect for organizing questions by topic and difficulty!</p>
      
      <div id="qbankAlert"></div>

      <!-- Create New Q-Bank Section -->
      <div style="background: rgba(102,126,234,0.1); padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 1px solid rgba(102,126,234,0.3);">
        <h3 style="font-size: 18px; font-weight: 600; color: #ffffff; margin-bottom: 20px;">‚ûï Create New Q-Bank</h3>
        
        <div class="form-group">
          <label>Q-Bank Name</label>
          <input type="text" id="qbankName" placeholder="e.g., ACE Inhibitors - Advanced Questions">
        </div>

        <div class="form-group">
          <label>Category / Topic</label>
          <select id="qbankCategory" onchange="toggleCustomCategory()" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
            <option value="Medical Terminology">Medical Terminology</option>
            <option value="Human Anatomy">Human Anatomy</option>
            <option value="Medication Suffixes and Drug Classes">Medication Suffixes and Drug Classes</option>
            <option value="Cardiovascular System">Cardiovascular System</option>
            <option value="Endocrine System">Endocrine System</option>
            <option value="Gastrointestinal & Hepatic System">Gastrointestinal & Hepatic System</option>
            <option value="Respiratory System">Respiratory System</option>
            <option value="Renal">Renal</option>
            <option value="Fluids, Electrolytes & Nutrition">Fluids, Electrolytes & Nutrition</option>
            <option value="Eye Disorders">Eye Disorders</option>
            <option value="EENT">EENT</option>
            <option value="Burns and Skin">Burns and Skin</option>
            <option value="Reproductive and Sexual Health System">Reproductive and Sexual Health System</option>
            <option value="Maternal Health">Maternal Health</option>
            <option value="Pediatrics">Pediatrics</option>
            <option value="Medical-Surgical Care">Medical-Surgical Care</option>
            <option value="Mental Health">Mental Health</option>
            <option value="Autoimmune & Infectious Disorders">Autoimmune & Infectious Disorders</option>
            <option value="Neurology">Neurology</option>
            <option value="Cancer">Cancer</option>
            <option value="Musculoskeletal Disorders">Musculoskeletal Disorders</option>
            <option value="Psycho-Social Aspects">Psycho-Social Aspects</option>
            <option value="Nursing Skills and Fundamentals">Nursing Skills and Fundamentals</option>
            <option value="Pharmacology">Pharmacology</option>
            <option value="CUSTOM">‚ûï Add Custom Category...</option>
          </select>
        </div>

        <div class="form-group" id="customCategoryField" style="display: none;">
          <label>Custom Category Name</label>
          <input type="text" id="customCategoryInput" placeholder="e.g., Hematology Medications, Pain Management, etc.">
          <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 6px;">
            üí° Enter your custom category name and it will be added to the dropdown permanently
          </p>
        </div>

        <div class="form-group">
          <label>Description (Optional)</label>
          <textarea id="qbankDescription" rows="2" placeholder="Brief description of this question bank..."></textarea>
        </div>

        <button class="btn" onclick="createQBank()">üè¶ Create Q-Bank</button>
      </div>

      <!-- Add Existing Questions to Q-Bank -->
      <div style="background: rgba(74,222,128,0.1); padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 1px solid rgba(74,222,128,0.3);">
        <h3 style="font-size: 18px; font-weight: 600; color: #ffffff; margin-bottom: 15px;">üì• Add Existing Questions to Q-Bank</h3>
        <p style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 20px;">
          Quickly add all questions from a specific category/difficulty to a Q-Bank
        </p>

        <div class="form-group">
          <label>Select Q-Bank</label>
          <select id="targetQBank" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
            <option value="">Loading Q-Banks...</option>
          </select>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div class="form-group" style="margin: 0;">
            <label>Filter by Category</label>
            <select id="linkCategory" onchange="updateLinkPreview()" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
              <option value="">All Categories</option>
              <option value="Medical Terminology">Medical Terminology</option>
              <option value="Human Anatomy">Human Anatomy</option>
              <option value="Medication Suffixes and Drug Classes">Medication Suffixes and Drug Classes</option>
              <option value="Cardiovascular System">Cardiovascular System</option>
              <option value="Endocrine System">Endocrine System</option>
              <option value="Gastrointestinal & Hepatic System">Gastrointestinal & Hepatic System</option>
              <option value="Respiratory System">Respiratory System</option>
              <option value="Renal">Renal</option>
              <option value="Fluids, Electrolytes & Nutrition">Fluids, Electrolytes & Nutrition</option>
              <option value="Eye Disorders">Eye Disorders</option>
              <option value="EENT">EENT</option>
              <option value="Burns and Skin">Burns and Skin</option>
              <option value="Reproductive and Sexual Health System">Reproductive and Sexual Health System</option>
              <option value="Maternal Health">Maternal Health</option>
              <option value="Pediatrics">Pediatrics</option>
              <option value="Medical-Surgical Care">Medical-Surgical Care</option>
              <option value="Mental Health">Mental Health</option>
              <option value="Autoimmune & Infectious Disorders">Autoimmune & Infectious Disorders</option>
              <option value="Neurology">Neurology</option>
              <option value="Cancer">Cancer</option>
              <option value="Musculoskeletal Disorders">Musculoskeletal Disorders</option>
              <option value="Psycho-Social Aspects">Psycho-Social Aspects</option>
              <option value="Nursing Skills and Fundamentals">Nursing Skills and Fundamentals</option>
              <option value="Pharmacology">Pharmacology</option>
            </select>
          </div>

          <div class="form-group" style="margin: 0;">
            <label>Filter by Difficulty</label>
            <select id="linkDifficulty" onchange="updateLinkPreview()" style="padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 15px; width: 100%;">
              <option value="">All Difficulties</option>
              <option value="Easy">üü¢ Easy</option>
              <option value="Medium">üü° Medium</option>
              <option value="Hard">üî¥ Hard</option>
            </select>
          </div>
        </div>

        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <div id="linkPreview" style="font-size: 14px; color: rgba(255,255,255,0.8);">
            üí° Select filters above to see how many questions will be added
          </div>
        </div>

        <button class="btn" onclick="linkQuestionsToQBank()" style="background: linear-gradient(135deg, #4ade80, #22c55e);">
          ‚ûï Add Questions to Q-Bank
        </button>
      </div>

      <!-- Existing Q-Banks -->
      <h3 style="font-size: 18px; font-weight: 600; color: #ffffff; margin-bottom: 20px;">üìö Your Question Banks</h3>
      <div id="qbanksList" class="question-list">
        <div class="loading">Loading Q-Banks...</div>
      </div>
    </div>
  </div>

  <!-- Reactions Tab -->
  <div id="reactionsTab" class="tab-content">
    <div class="card">
      <h2>Manage Student Reactions</h2>
      <p class="subtitle" style="margin-bottom: 25px;">Add feedback messages that students will see when they answer questions correctly or incorrectly</p>
      
      <div id="reactionsAlert"></div>

      <!-- Correct Answer Reactions -->
      <div style="margin-bottom: 40px;">
        <h3 style="color: #4ade80; font-size: 20px; margin-bottom: 15px;">‚úÖ Correct Answer Reactions</h3>
        <div class="form-group">
          <label>Add New Reaction (one per line)</label>
          <textarea id="correctReactions" rows="8" placeholder="Amazing! You got it right! üéâ&#10;Perfect! Keep up the great work! ‚≠ê&#10;Excellent! You're on fire! üî•&#10;Fantastic! That's correct! üí´&#10;Brilliant! You nailed it! üèÜ"></textarea>
        </div>
      </div>

      <!-- Incorrect Answer Reactions -->
      <div style="margin-bottom: 30px;">
        <h3 style="color: #f87171; font-size: 20px; margin-bottom: 15px;">‚ùå Incorrect Answer Reactions</h3>
        <div class="form-group">
          <label>Add New Reaction (one per line)</label>
          <textarea id="incorrectReactions" rows="8" placeholder="Not quite, but keep trying! üí™&#10;Almost there! Review and try again! üìö&#10;Don't give up! You can do this! üåü&#10;Keep learning! Every mistake is progress! üöÄ&#10;Try again! You're getting closer! üí°"></textarea>
        </div>
      </div>

      <button class="btn" onclick="saveReactions()">üíæ Save Reactions</button>
    </div>

    <!-- Preview Section -->
    <div class="card">
      <h2>Current Reactions</h2>
      
      <div style="margin-bottom: 30px;">
        <h3 style="color: #4ade80; font-size: 18px; margin-bottom: 12px;">‚úÖ Correct Reactions (<span id="correctCount">0</span>)</h3>
        <div id="correctList" style="color: rgba(255,255,255,0.7); line-height: 1.8;">
          <em>No reactions added yet</em>
        </div>
      </div>

      <div>
        <h3 style="color: #f87171; font-size: 18px; margin-bottom: 12px;">‚ùå Incorrect Reactions (<span id="incorrectCount">0</span>)</h3>
        <div id="incorrectList" style="color: rgba(255,255,255,0.7); line-height: 1.8;">
          <em>No reactions added yet</em>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Questions Tab -->
  <div id="manageTab" class="tab-content">
    <div class="card">
      <h2>Manage All Questions</h2>
      <p class="subtitle" style="margin-bottom: 25px;">View, filter, and manage all test questions. Organize by test, category, or difficulty level.</p>
      
      <!-- Filters -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
        <div class="form-group" style="margin: 0;">
          <label>Filter by Test</label>
          <select id="filterTest" onchange="loadQuestions()" style="padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 14px; width: 100%;">
            <option value="">All Tests</option>
          </select>
        </div>
        
        <div class="form-group" style="margin: 0;">
          <label>Filter by Category</label>
          <select id="filterCategory" onchange="loadQuestions()" style="padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 14px; width: 100%;">
            <option value="">All Categories</option>
          </select>
        </div>
        
        <div class="form-group" style="margin: 0;">
          <label>Filter by Difficulty</label>
          <select id="filterDifficulty" onchange="loadQuestions()" style="padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; font-size: 14px; width: 100%;">
            <option value="">All Levels</option>
            <option value="Easy">üü¢ Easy</option>
            <option value="Medium">üü° Medium</option>
            <option value="Hard">üî¥ Hard</option>
          </select>
        </div>
      </div>

      <!-- Bulk Actions -->
      <div style="background: rgba(255,255,255,0.05); padding: 15px 20px; border-radius: 12px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 15px;">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="width: 18px; height: 18px; cursor: pointer;">
            <span>Select All</span>
          </label>
          <span id="selectedCount" style="color: rgba(255,255,255,0.6); font-size: 14px;">0 selected</span>
        </div>
        <button class="btn btn-danger btn-small" onclick="deleteSelected()" id="deleteSelectedBtn" disabled style="opacity: 0.5;">
          üóëÔ∏è Delete Selected
        </button>
      </div>

      <!-- Questions List -->
      <div id="questionList" class="question-list">
        <div class="loading">Loading questions...</div>
      </div>
    </div>
  </div>
</div>

<script>
// ========================================================
// SUPABASE CONFIGURATION
// ========================================================
const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ========================================================
// üîí ADMIN AUTHENTICATION
// ========================================================
async function requireAdminSession() {
  try {
    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
    
    if (sessionError || !session) {
      alert('‚õî Access Denied\n\nThis page is for administrators only.\n\nYou will be redirected to the student portal.');
      window.location.href = 'student-portal.html';
      return false;
    }

    // Check if user is in admin_accounts table
    const { data: adminAccount, error: adminError } = await supabaseClient
      .from('admin_accounts')
      .select('*')
      .eq('auth_user_id', session.user.id)
      .single();

    if (adminError || !adminAccount) {
      alert('‚õî Access Denied\n\nThis page is for administrators only.\n\nYou will be redirected to the student portal.');
      window.location.href = 'student-portal.html';
      return false;
    }

    console.log('‚úÖ Admin access verified:', adminAccount.email);
    return true;
  } catch (error) {
    console.error('‚ùå Admin auth error:', error);
    alert('‚õî Access Denied\n\nThis page is for administrators only.\n\nYou will be redirected to the student portal.');
    window.location.href = 'student-portal.html';
    return false;
  }
}

// Check admin access on page load
(async () => {
  console.log('üîí Checking admin access...');
  const isAdmin = await requireAdminSession();
  if (!isAdmin) {
    return; // Stop execution - user will be redirected
  }
  console.log('‚úÖ Admin access verified, loading Test Manager...');
})();

// ========================================================
// TAB SWITCHING
// ========================================================
function switchTab(tab) {
  // Remove active from all tabs
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  
  // Add active to selected tab
  event.target.classList.add('active');
  document.getElementById(tab + 'Tab').classList.add('active');
  
  // Reload questions if switching to manage tab
  if (tab === 'manage') {
    loadQuestions();
  }
  
  // Load Q-Banks if switching to qbank tab
  if (tab === 'qbank') {
    loadQBanks();
  }
  
  // Load Q-Bank dropdown when switching to tests tab
  if (tab === 'tests') {
    loadQBankDropdown();
  }
}

// ========================================================
// CUSTOM CATEGORY MANAGEMENT
// ========================================================
function toggleCustomCategory() {
  const select = document.getElementById('qbankCategory');
  const customField = document.getElementById('customCategoryField');
  
  if (select.value === 'CUSTOM') {
    customField.style.display = 'block';
    document.getElementById('customCategoryInput').focus();
  } else {
    customField.style.display = 'none';
  }
}

function addCustomCategory(categoryName) {
  // Get existing custom categories from localStorage
  let customCategories = JSON.parse(localStorage.getItem('customCategories') || '[]');
  
  // Add new category if not already exists
  if (!customCategories.includes(categoryName)) {
    customCategories.push(categoryName);
    localStorage.setItem('customCategories', JSON.stringify(customCategories));
    
    // Update all category dropdowns
    updateCategoryDropdowns();
  }
}

function updateCategoryDropdowns() {
  const customCategories = JSON.parse(localStorage.getItem('customCategories') || '[]');
  
  // Update Q-Bank category dropdown
  const qbankSelect = document.getElementById('qbankCategory');
  if (qbankSelect) {
    const customOption = qbankSelect.querySelector('option[value="CUSTOM"]');
    
    // Remove old custom categories
    qbankSelect.querySelectorAll('.custom-category').forEach(opt => opt.remove());
    
    // Add custom categories before the "Add Custom" option
    customCategories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      option.className = 'custom-category';
      qbankSelect.insertBefore(option, customOption);
    });
  }
  
  // Update other category dropdowns (questionCategory, bulkCategory, linkCategory, jsonCategory)
  const dropdowns = ['questionCategory', 'bulkCategory', 'linkCategory', 'jsonCategory'];
  dropdowns.forEach(id => {
    const dropdown = document.getElementById(id);
    if (dropdown) {
      // Remove old custom categories
      dropdown.querySelectorAll('.custom-category').forEach(opt => opt.remove());
      
      // Add custom categories at the end
      customCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        option.className = 'custom-category';
        dropdown.appendChild(option);
      });
    }
  });
}

// ========================================================
// SHOW ALERT
// ========================================================
function showAlert(containerId, message, type = 'success') {
  const container = document.getElementById(containerId);
  container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
  setTimeout(() => container.innerHTML = '', 5000);
}

// ========================================================
// ADD SINGLE QUESTION
// ========================================================
async function addSingleQuestion() {
  const question = document.getElementById('questionText').value.trim();
  const optionA = document.getElementById('optionA').value.trim();
  const optionB = document.getElementById('optionB').value.trim();
  const optionC = document.getElementById('optionC').value.trim();
  const optionD = document.getElementById('optionD').value.trim();
  const correct = document.querySelector('input[name="correct"]:checked').value;
  const category = document.getElementById('questionCategory').value;
  const difficulty = document.getElementById('questionDifficulty').value;
  const testId = document.getElementById('questionTestId').value;

  // Validation
  if (!question || !optionA || !optionB || !optionC || !optionD) {
    showAlert('singleAlert', '‚ö†Ô∏è Please fill in all fields', 'error');
    return;
  }

  if (!testId) {
    showAlert('singleAlert', '‚ö†Ô∏è Please select a test to add this question to', 'error');
    return;
  }

  const options = [optionA, optionB, optionC, optionD];

  try {
    const { error } = await supabaseClient
      .from('test_questions')
      .insert([{
        question,
        options: JSON.stringify(options),
        correct_answer: correct,
        category: category,
        difficulty: difficulty,
        test_id: parseInt(testId)
      }]);

    if (error) throw error;

    showAlert('singleAlert', `‚úÖ Question added to test (${category}, ${difficulty})!`, 'success');
    
    // Clear form (but keep test, category and difficulty)
    document.getElementById('questionText').value = '';
    document.getElementById('optionA').value = '';
    document.getElementById('optionB').value = '';
    document.getElementById('optionC').value = '';
    document.getElementById('optionD').value = '';
    document.querySelector('input[name="correct"][value="A"]').checked = true;

    // Update stats
    loadStats();

  } catch (error) {
    console.error('Error adding question:', error);
    showAlert('singleAlert', `‚ùå Error: ${error.message}`, 'error');
  }
}

// ========================================================
// BULK IMPORT QUESTIONS
// ========================================================
async function importBulkQuestions() {
  const bulkInput = document.getElementById('bulkInput').value.trim();
  
  if (!bulkInput) {
    showAlert('bulkAlert', '‚ö†Ô∏è Please paste questions to import', 'error');
    return;
  }

  const questions = [];
  const errors = [];

  // Try to parse as multi-line format first (with A. B. C. D. pattern)
  const multiLineBlocks = bulkInput.split(/\n\s*\n/); // Split by double newlines
  
  multiLineBlocks.forEach((block, blockIndex) => {
    const lines = block.trim().split('\n').filter(line => line.trim());
    
    if (lines.length === 0) return;
    
    // Check if this is multi-line format (has A. B. C. D. options)
    const hasOptionsPattern = lines.some(line => /^[A-D]\./.test(line.trim()));
    
    if (hasOptionsPattern) {
      // Multi-line format parsing
      let question = '';
      let options = ['', '', '', ''];
      let correctAnswer = '';
      
      for (let line of lines) {
        const trimmed = line.trim();
        
        // Check for option lines (A. B. C. D.)
        const optionMatch = trimmed.match(/^([A-D])\.\s*(.+?)(?:\s*‚úîÔ∏è)?$/);
        if (optionMatch) {
          const letter = optionMatch[1];
          const text = optionMatch[2].trim();
          const index = letter.charCodeAt(0) - 65; // A=0, B=1, C=2, D=3
          options[index] = text;
          
          // Check if this option has checkmark
          if (line.includes('‚úîÔ∏è') || line.includes('‚úì')) {
            correctAnswer = letter;
          }
          continue;
        }
        
        // Check for "Correct: X" pattern
        const correctMatch = trimmed.match(/^Correct:\s*([A-D])/i);
        if (correctMatch) {
          correctAnswer = correctMatch[1].toUpperCase();
          continue;
        }
        
        // Otherwise, it's part of the question
        if (question) question += ' ';
        question += trimmed;
      }
      
      // Validate
      if (!question || options.some(opt => !opt) || !correctAnswer) {
        errors.push(`Block ${blockIndex + 1}: Invalid multi-line format - missing question, options, or correct answer`);
        return;
      }
      
      questions.push({
        question,
        options: JSON.stringify(options),
        correct_answer: correctAnswer
      });
      
    } else {
      // Single-line pipe-separated format
      lines.forEach((line, lineIndex) => {
        const parts = line.split('|').map(p => p.trim());
        
        if (parts.length !== 6) {
          errors.push(`Line ${lineIndex + 1} in block ${blockIndex + 1}: Invalid format (expected 6 parts separated by |)`);
          return;
        }

        const [question, optA, optB, optC, optD, correct] = parts;
        const correctUpper = correct.toUpperCase();

        if (!['A', 'B', 'C', 'D'].includes(correctUpper)) {
          errors.push(`Line ${lineIndex + 1} in block ${blockIndex + 1}: Correct answer must be A, B, C, or D`);
          return;
        }

        questions.push({
          question,
          options: JSON.stringify([optA, optB, optC, optD]),
          correct_answer: correctUpper
        });
      });
    }
  });

  if (errors.length > 0) {
    showAlert('bulkAlert', `‚ùå Errors found:\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? `\n... and ${errors.length - 5} more errors` : ''}`, 'error');
    return;
  }

  if (questions.length === 0) {
    showAlert('bulkAlert', '‚ö†Ô∏è No valid questions found', 'error');
    return;
  }

  // Get test_id, category, and difficulty from form
  const bulkTestId = document.getElementById('bulkTestId').value;
  const bulkCategory = document.getElementById('bulkCategory').value;
  const bulkDifficulty = document.getElementById('bulkDifficulty').value;

  if (!bulkTestId) {
    showAlert('bulkAlert', '‚ö†Ô∏è Please select a test for these questions', 'error');
    return;
  }

  // Add test_id, category, and difficulty to all questions
  questions.forEach(q => {
    q.test_id = parseInt(bulkTestId);
    q.category = bulkCategory;
    q.difficulty = bulkDifficulty;
  });

  try {
    const { error } = await supabaseClient
      .from('test_questions')
      .insert(questions);

    if (error) throw error;

    showAlert('bulkAlert', `‚úÖ Successfully imported ${questions.length} question(s) (${bulkCategory}, ${bulkDifficulty})!`, 'success');
    document.getElementById('bulkInput').value = '';
    loadStats();

  } catch (error) {
    console.error('Error importing questions:', error);
    showAlert('bulkAlert', `‚ùå Error: ${error.message}`, 'error');
  }
}

// ========================================================
// CUSTOM PROMPT DIALOG
// ========================================================
function customPrompt(message, placeholder = '', defaultValue = '') {
  return new Promise((resolve) => {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    `;

    // Create dialog
    const dialog = document.createElement('div');
    dialog.style.cssText = `
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s ease;
    `;

    dialog.innerHTML = `
      <div style="font-size: 16px; color: rgba(255, 255, 255, 0.9); margin-bottom: 20px; line-height: 1.6;">
        ${message}
      </div>
      <input type="text" id="customPromptInput" value="${defaultValue}" placeholder="${placeholder}" 
        style="width: 100%; padding: 14px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); 
        border-radius: 8px; color: #ffffff; font-size: 15px; margin-bottom: 20px; outline: none;">
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button id="customPromptCancel" style="padding: 12px 24px; background: rgba(255, 255, 255, 0.1); 
          border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; cursor: pointer; 
          font-size: 15px; font-weight: 600;">
          Cancel
        </button>
        <button id="customPromptOk" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); 
          border: none; border-radius: 8px; color: #ffffff; cursor: pointer; font-size: 15px; font-weight: 600;">
          OK
        </button>
      </div>
    `;

    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    const input = document.getElementById('customPromptInput');
    const okBtn = document.getElementById('customPromptOk');
    const cancelBtn = document.getElementById('customPromptCancel');

    input.focus();
    input.select();

    const close = (value) => {
      overlay.style.animation = 'fadeOut 0.2s ease';
      setTimeout(() => overlay.remove(), 200);
      resolve(value);
    };

    okBtn.onclick = () => close(input.value.trim());
    cancelBtn.onclick = () => close(null);
    input.onkeydown = (e) => {
      if (e.key === 'Enter') close(input.value.trim());
      if (e.key === 'Escape') close(null);
    };
  });
}

// ========================================================
// CUSTOM TEST SELECTOR DIALOG
// ========================================================
function customTestSelector(tests, qbankName) {
  return new Promise((resolve) => {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    `;

    // Create dialog
    const dialog = document.createElement('div');
    dialog.style.cssText = `
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s ease;
    `;

    // Build test options with radio buttons
    const testOptionsHTML = tests.map((test, index) => `
      <label style="display: flex; align-items: center; padding: 14px; background: rgba(255, 255, 255, 0.05); 
        border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; margin-bottom: 10px; cursor: pointer;
        transition: all 0.2s ease;" 
        onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'"
        onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'">
        <input type="radio" name="testSelection" value="${index}" 
          style="margin-right: 12px; cursor: pointer; width: 18px; height: 18px;">
        <div style="flex: 1;">
          <div style="color: #93c5fd; font-size: 13px; font-weight: 600; margin-bottom: 4px;">
            ${test.system_category}
          </div>
          <div style="color: rgba(255, 255, 255, 0.9); font-size: 15px; font-weight: 500;">
            ${test.test_name}
          </div>
        </div>
      </label>
    `).join('');

    dialog.innerHTML = `
      <div style="font-size: 18px; color: #ffffff; margin-bottom: 8px; font-weight: 600;">
        üìù Add Q-Bank to Test
      </div>
      <div style="font-size: 14px; color: rgba(255, 255, 255, 0.7); margin-bottom: 24px;">
        Select which test to add "<span style="color: #93c5fd; font-weight: 600;">${qbankName}</span>" questions to:
      </div>
      <div style="margin-bottom: 24px; max-height: 400px; overflow-y: auto;">
        ${testOptionsHTML}
      </div>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button id="testSelectorCancel" style="padding: 12px 24px; background: rgba(255, 255, 255, 0.1); 
          border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; cursor: pointer; 
          font-size: 15px; font-weight: 600;">
          Cancel
        </button>
        <button id="testSelectorOk" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); 
          border: none; border-radius: 8px; color: #ffffff; cursor: pointer; font-size: 15px; font-weight: 600;">
          Add to Test
        </button>
      </div>
    `;

    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    const okBtn = document.getElementById('testSelectorOk');
    const cancelBtn = document.getElementById('testSelectorCancel');
    const radioButtons = dialog.querySelectorAll('input[type="radio"]');

    // Auto-select first option
    if (radioButtons.length > 0) {
      radioButtons[0].checked = true;
    }

    const close = (confirmed) => {
      if (confirmed) {
        const selected = dialog.querySelector('input[name="testSelection"]:checked');
        if (selected) {
          const testIndex = parseInt(selected.value);
          overlay.style.animation = 'fadeOut 0.2s ease';
          setTimeout(() => overlay.remove(), 200);
          resolve(tests[testIndex]);
          return;
        }
      }
      overlay.style.animation = 'fadeOut 0.2s ease';
      setTimeout(() => overlay.remove(), 200);
      resolve(null);
    };

    okBtn.onclick = () => close(true);
    cancelBtn.onclick = () => close(false);
    
    // Allow clicking on overlay background to cancel
    overlay.onclick = (e) => {
      if (e.target === overlay) close(false);
    };

    // Escape key to cancel
    const escHandler = (e) => {
      if (e.key === 'Escape') {
        close(false);
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);
  });
}

// ========================================================
// HANDLE JSON Q-BANK CREATION
// ========================================================
async function handleJSONQBankSelection() {
  const qbankSelect = document.getElementById('jsonQBankId');
  const selectedValue = qbankSelect.value;

  if (selectedValue === 'CREATE_NEW') {
    // Prompt for Q-Bank details
    const qbankName = await customPrompt(
      'üìù Enter Q-Bank Name:',
      'e.g., "Cardiovascular Medications - Easy"'
    );
    
    if (!qbankName) {
      qbankSelect.value = '';
      return null;
    }

    const category = document.getElementById('jsonCategory').value;
    const description = await customPrompt(
      'üìù Enter Q-Bank Description (Optional):',
      'Leave blank to skip'
    ) || '';

    try {
      // Create new Q-Bank
      const { data, error } = await supabaseClient
        .from('question_banks')
        .insert([{
          name: qbankName.trim(),
          category: category,
          description: description.trim()
        }])
        .select()
        .single();

      if (error) throw error;

      // Reload dropdown to show new Q-Bank
      await loadQBankDropdown();
      
      // Select the newly created Q-Bank
      qbankSelect.value = data.id;
      
      showAlert('jsonAlert', `‚úÖ Q-Bank "${qbankName}" created successfully!`, 'success');
      return data.id;

    } catch (error) {
      console.error('Error creating Q-Bank:', error);
      showAlert('jsonAlert', `‚ùå Error creating Q-Bank: ${error.message}`, 'error');
      qbankSelect.value = '';
      return null;
    }
  }

  return selectedValue ? parseInt(selectedValue) : null;
}

// ========================================================
// IMPORT JSON TEXT
// ========================================================
async function importJSONText() {
  const jsonTextInput = document.getElementById('jsonText');
  const jsonText = jsonTextInput.value.trim();
  
  if (!jsonText) {
    showAlert('jsonAlert', 'üìù üëÄ Please paste JSON text first!', 'error');
    return;
  }

  try {
    const jsonData = JSON.parse(jsonText);
    
    if (!Array.isArray(jsonData)) {
      showAlert('jsonAlert', '‚ùå üìã JSON must be an array of questions - wrap your questions in [ ]', 'error');
      return;
    }

    const questions = [];
    const errors = [];

    jsonData.forEach((item, index) => {
      // Validate required fields
      if (!item.question || !item.options || !item.correct_answer) {
        errors.push(`Question ${index + 1}: Missing required fields (question, options, correct_answer)`);
        return;
      }

      // Validate options array
      if (!Array.isArray(item.options) || item.options.length !== 4) {
        errors.push(`Question ${index + 1}: Options must be an array of exactly 4 items`);
        return;
      }

      // Normalize correct_answer
      let correctAnswer;
      if (typeof item.correct_answer === 'number') {
        // Convert 0,1,2,3 to A,B,C,D
        if (item.correct_answer < 0 || item.correct_answer > 3) {
          errors.push(`Question ${index + 1}: Numeric correct_answer must be 0, 1, 2, or 3`);
          return;
        }
        correctAnswer = String.fromCharCode(65 + item.correct_answer); // 0->A, 1->B, etc.
      } else if (typeof item.correct_answer === 'string') {
        correctAnswer = item.correct_answer.toUpperCase();
        if (!['A', 'B', 'C', 'D'].includes(correctAnswer)) {
          errors.push(`Question ${index + 1}: correct_answer must be A, B, C, D or 0, 1, 2, 3`);
          return;
        }
      } else {
        errors.push(`Question ${index + 1}: correct_answer must be a string or number`);
        return;
      }

      questions.push({
        question: item.question,
        options: JSON.stringify(item.options),
        correct_answer: correctAnswer,
        category: item.category || 'General',
        difficulty: item.difficulty || 'Medium',
        test_id: item.test_id || null,
        rationale: item.rationale || null
      });
    });

    if (errors.length > 0) {
      // Error reaction popup
      const errorReactions = ['üòû', 'üòî', 'ü§î', 'üòï', 'üí≠', 'üîç'];
      const errorMessages = [
        'Oops!',
        'Hold on!',
        'Not quite!',
        'Almost there!',
        'Let\'s fix this!'
      ];
      const randomErrorReaction = errorReactions[Math.floor(Math.random() * errorReactions.length)];
      const randomErrorMessage = errorMessages[Math.floor(Math.random() * errorMessages.length)];
      
      showAlert('jsonAlert', `${randomErrorReaction} ${randomErrorMessage} Errors found:\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? `\n... and ${errors.length - 5} more errors` : ''}`, 'error');
      return;
    }

    if (questions.length === 0) {
      showAlert('jsonAlert', '‚ö†Ô∏è ü§∑‚Äç‚ôÇÔ∏è No valid questions found in JSON text - please check your format!', 'error');
      return;
    }

    // Get Q-Bank selection (handle CREATE_NEW if selected)
    const qbankId = await handleJSONQBankSelection();
    
    // Get category and difficulty from form
    const category = document.getElementById('jsonCategory').value;
    const difficulty = document.getElementById('jsonDifficulty').value;

    // Add category and difficulty to all questions
    questions.forEach(q => {
      if (!q.category || q.category === 'General') {
        q.category = category;
      }
      if (!q.difficulty) {
        q.difficulty = difficulty;
      }
    });

    // Import questions to Supabase
    const { data: insertedQuestions, error } = await supabaseClient
      .from('test_questions')
      .insert(questions)
      .select();

    if (error) throw error;

    // If Q-Bank selected, link questions to Q-Bank
    if (qbankId && insertedQuestions) {
      const qbankLinks = insertedQuestions.map(q => ({
        qbank_id: qbankId,
        question_id: q.id
      }));

      const { error: linkError } = await supabaseClient
        .from('qbank_questions')
        .insert(qbankLinks);

      if (linkError) {
        console.error('Error linking to Q-Bank:', linkError);
        showAlert('jsonAlert', `‚ö†Ô∏è Questions imported but failed to link to Q-Bank: ${linkError.message}`, 'error');
        return;
      }
    }

    // Success reaction popup
    const reactions = ['üéâ', '‚ú®', 'üåü', 'üéä', 'üí´', '‚≠ê', 'üèÜ', 'üéØ'];
    const messages = [
      'Amazing!',
      'Fantastic!',
      'Perfect!',
      'Excellent!',
      'Outstanding!',
      'Brilliant!',
      'Superb!'
    ];
    const randomReaction = reactions[Math.floor(Math.random() * reactions.length)];
    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
    
    const qbankMessage = qbankId ? ' and linked to Q-Bank' : '';
    showAlert('jsonAlert', `${randomReaction} ${randomMessage} Successfully imported ${questions.length} question(s) from JSON text${qbankMessage}!`, 'success');
    jsonTextInput.value = ''; // Clear textarea
    loadStats();
    if (qbankId) loadQBanks(); // Reload Q-Banks to show updated count

  } catch (error) {
    console.error('Error parsing/importing JSON:', error);
    showAlert('jsonAlert', `‚ùå üí• Error: ${error.message}`, 'error');
  }
}

// ========================================================
// IMPORT JSON FILE
// ========================================================
async function importJSONFile() {
  const fileInput = document.getElementById('jsonFile');
  const file = fileInput.files[0];
  
  if (!file) {
    showAlert('jsonAlert', 'üìÇ üëÄ Please select a JSON file first!', 'error');
    return;
  }

  if (!file.name.endsWith('.json')) {
    showAlert('jsonAlert', 'üö´ ‚ùå Please select a valid JSON file (.json)', 'error');
    return;
  }

  const reader = new FileReader();
  
  reader.onload = async function(e) {
    try {
      const jsonData = JSON.parse(e.target.result);
      
      if (!Array.isArray(jsonData)) {
        showAlert('jsonAlert', '‚ùå üìã JSON must be an array of questions - wrap your questions in [ ]', 'error');
        return;
      }

      const questions = [];
      const errors = [];

      jsonData.forEach((item, index) => {
        // Validate required fields
        if (!item.question || !item.options || !item.correct_answer) {
          errors.push(`Question ${index + 1}: Missing required fields (question, options, correct_answer)`);
          return;
        }

        // Validate options array
        if (!Array.isArray(item.options) || item.options.length !== 4) {
          errors.push(`Question ${index + 1}: Options must be an array of exactly 4 items`);
          return;
        }

        // Normalize correct_answer
        let correctAnswer;
        if (typeof item.correct_answer === 'number') {
          // Convert 0,1,2,3 to A,B,C,D
          if (item.correct_answer < 0 || item.correct_answer > 3) {
            errors.push(`Question ${index + 1}: Numeric correct_answer must be 0, 1, 2, or 3`);
            return;
          }
          correctAnswer = String.fromCharCode(65 + item.correct_answer); // 0->A, 1->B, etc.
        } else if (typeof item.correct_answer === 'string') {
          correctAnswer = item.correct_answer.toUpperCase();
          if (!['A', 'B', 'C', 'D'].includes(correctAnswer)) {
            errors.push(`Question ${index + 1}: correct_answer must be A, B, C, D or 0, 1, 2, 3`);
            return;
          }
        } else {
          errors.push(`Question ${index + 1}: correct_answer must be a string or number`);
          return;
        }

        questions.push({
          question: item.question,
          options: JSON.stringify(item.options),
          correct_answer: correctAnswer,
          category: item.category || null,
          difficulty: item.difficulty || null,
          test_id: item.test_id || null,
          rationale: item.rationale || null
        });
      });

      if (errors.length > 0) {
        // Error reaction popup
        const errorReactions = ['üòû', 'üòî', 'ü§î', 'üòï', 'üí≠', 'üîç'];
        const errorMessages = [
          'Oops!',
          'Hold on!',
          'Not quite!',
          'Almost there!',
          'Let\'s fix this!'
        ];
        const randomErrorReaction = errorReactions[Math.floor(Math.random() * errorReactions.length)];
        const randomErrorMessage = errorMessages[Math.floor(Math.random() * errorMessages.length)];
        
        showAlert('jsonAlert', `${randomErrorReaction} ${randomErrorMessage} Errors found:\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? `\n... and ${errors.length - 5} more errors` : ''}`, 'error');
        return;
      }

      if (questions.length === 0) {
        showAlert('jsonAlert', '‚ö†Ô∏è ü§∑‚Äç‚ôÇÔ∏è No valid questions found in JSON file - please check your format!', 'error');
        return;
      }

      // Get Q-Bank selection (handle CREATE_NEW if selected)
      const qbankId = await handleJSONQBankSelection();
      
      // Get category and difficulty from form
      const category = document.getElementById('jsonCategory').value;
      const difficulty = document.getElementById('jsonDifficulty').value;

      // Add category and difficulty to all questions that don't have them
      questions.forEach(q => {
        if (!q.category) {
          q.category = category;
        }
        if (!q.difficulty) {
          q.difficulty = difficulty;
        }
      });

      // Import questions to Supabase
      const { data: insertedQuestions, error } = await supabaseClient
        .from('test_questions')
        .insert(questions)
        .select();

      if (error) throw error;

      // If Q-Bank selected, link questions to Q-Bank
      if (qbankId && insertedQuestions) {
        const qbankLinks = insertedQuestions.map(q => ({
          qbank_id: qbankId,
          question_id: q.id
        }));

        const { error: linkError } = await supabaseClient
          .from('qbank_questions')
          .insert(qbankLinks);

        if (linkError) {
          console.error('Error linking to Q-Bank:', linkError);
          showAlert('jsonAlert', `‚ö†Ô∏è Questions imported but failed to link to Q-Bank: ${linkError.message}`, 'error');
          return;
        }
      }

      // Success reaction popup
      const reactions = ['üéâ', '‚ú®', 'üåü', 'üéä', 'üí´', '‚≠ê', 'üèÜ', 'üéØ'];
      const messages = [
        'Amazing!',
        'Fantastic!',
        'Perfect!',
        'Excellent!',
        'Outstanding!',
        'Brilliant!',
        'Superb!'
      ];
      const randomReaction = reactions[Math.floor(Math.random() * reactions.length)];
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];
      
      const qbankMessage = qbankId ? ' and linked to Q-Bank' : '';
      showAlert('jsonAlert', `${randomReaction} ${randomMessage} Successfully imported ${questions.length} question(s) from JSON${qbankMessage}!`, 'success');
      fileInput.value = ''; // Clear file input
      loadStats();
      if (qbankId) loadQBanks(); // Reload Q-Banks to show updated count

    } catch (error) {
      console.error('Error parsing/importing JSON:', error);
      showAlert('jsonAlert', `‚ùå üí• Error: ${error.message}`, 'error');
    }
  };

  reader.onerror = function() {
    showAlert('jsonAlert', '‚ùå üìÑ Error reading file - please try again!', 'error');
  };

  reader.readAsText(file);
}

// ========================================================
// LOAD QUESTIONS
// ========================================================
let selectedQuestions = new Set();

async function loadQuestions() {
  const container = document.getElementById('questionList');
  container.innerHTML = '<div class="loading">Loading questions...</div>';

  // Get filter values
  const filterTest = document.getElementById('filterTest')?.value || '';
  const filterCategory = document.getElementById('filterCategory')?.value || '';
  const filterDifficulty = document.getElementById('filterDifficulty')?.value || '';

  try {
    // Build query
    let query = supabase
      .from('test_questions')
      .select(`
        *,
        tests (
          test_name,
          system_category
        )
      `)
      .order('id', { ascending: false });

    // Apply filters
    if (filterTest) {
      query = query.eq('test_id', filterTest);
    }
    if (filterCategory) {
      query = query.eq('category', filterCategory);
    }
    if (filterDifficulty) {
      query = query.eq('difficulty', filterDifficulty);
    }

    const { data, error } = await query;

    if (error) throw error;

    if (!data || data.length === 0) {
      container.innerHTML = '<div class="alert alert-info">üìö No questions found. Try adjusting your filters or add some questions!</div>';
      updateSelectedCount();
      return;
    }

    // Populate filter dropdowns with unique values
    await populateFilters(data);

    // Group by test, then by category
    const grouped = data.reduce((acc, q) => {
      const testName = q.tests?.test_name || 'Unassigned';
      const category = q.category || 'General';
      
      if (!acc[testName]) {
        acc[testName] = {};
      }
      if (!acc[testName][category]) {
        acc[testName][category] = [];
      }
      acc[testName][category].push(q);
      return acc;
    }, {});

    // Build HTML
    let html = '';
    Object.keys(grouped).sort().forEach(testName => {
      html += `
        <div style="margin-bottom: 40px;">
          <div style="background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2)); padding: 16px 24px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(102,126,234,0.3);">
            <h3 style="font-size: 20px; font-weight: 700; color: #ffffff; margin: 0;">
              üìù ${testName}
            </h3>
          </div>
      `;

      Object.keys(grouped[testName]).sort().forEach(category => {
        const questions = grouped[testName][category];
        html += `
          <div style="margin-bottom: 25px; margin-left: 15px;">
            <div style="background: rgba(255,255,255,0.08); padding: 12px 20px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
              <div style="font-weight: 600; font-size: 16px; color: rgba(255,255,255,0.9);">
                üìö ${category}
              </div>
              <div style="font-size: 14px; color: rgba(255,255,255,0.6);">
                ${questions.length} question${questions.length === 1 ? '' : 's'}
              </div>
            </div>
        `;

        questions.forEach(q => {
          const options = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
          const letters = ['A', 'B', 'C', 'D'];
          const difficulty = q.difficulty || 'Medium';
          
          // Difficulty colors
          const difficultyColors = {
            'Easy': { bg: 'rgba(74,222,128,0.3)', border: '#4ade80', text: '#4ade80', emoji: 'üü¢' },
            'Medium': { bg: 'rgba(251,191,36,0.3)', border: '#fbbf24', text: '#fbbf24', emoji: 'üü°' },
            'Hard': { bg: 'rgba(248,113,113,0.3)', border: '#f87171', text: '#f87171', emoji: 'üî¥' }
          };
          const diffColor = difficultyColors[difficulty] || difficultyColors['Medium'];
          
          html += `
            <div class="question-item" style="margin-bottom: 15px;">
              <div class="question-header">
                <div style="display: flex; align-items: start; gap: 12px; flex: 1;">
                  <input type="checkbox" 
                    class="question-checkbox" 
                    data-question-id="${q.id}"
                    onchange="toggleQuestionSelection(${q.id})"
                    ${selectedQuestions.has(q.id) ? 'checked' : ''}
                    style="width: 18px; height: 18px; cursor: pointer; margin-top: 4px; flex-shrink: 0;">
                  <div style="flex: 1;">
                    <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                      <span style="background: ${diffColor.bg}; border: 1px solid ${diffColor.border}; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: ${diffColor.text};">
                        ${diffColor.emoji} ${difficulty}
                      </span>
                      <span style="background: rgba(102,126,234,0.3); border: 1px solid rgba(102,126,234,0.5); padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #a5b4fc;">
                        ${category}
                      </span>
                    </div>
                    <div class="question-text" style="margin-bottom: 12px;">${q.question}</div>
                    <div class="options-display">
                      ${options.map((opt, i) => `
                        <div class="option-display ${letters[i] === q.correct_answer ? 'correct' : ''}">
                          <strong>${letters[i]})</strong> ${opt}
                          ${letters[i] === q.correct_answer ? ' ‚úÖ' : ''}
                        </div>
                      `).join('')}
                    </div>
                    ${q.rationale ? `
                      <div style="margin-top: 12px; padding: 12px; background: rgba(59,130,246,0.1); border-left: 3px solid #3b82f6; border-radius: 6px;">
                        <div style="font-size: 12px; font-weight: 600; color: #60a5fa; margin-bottom: 6px;">üí° RATIONALE</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.8); line-height: 1.5;">${q.rationale}</div>
                      </div>
                    ` : ''}
                  </div>
                </div>
                <div class="question-actions">
                  <button class="btn btn-danger btn-small" onclick="deleteQuestion(${q.id})" style="padding: 8px 14px;">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          `;
        });

        html += '</div>';
      });

      html += '</div>';
    });

    container.innerHTML = html;
    updateSelectedCount();

  } catch (error) {
    console.error('Error loading questions:', error);
    container.innerHTML = `<div class="alert alert-error">‚ùå Error loading questions: ${error.message}</div>`;
  }
}

async function populateFilters(allQuestions) {
  // Populate test filter
  const testFilter = document.getElementById('filterTest');
  if (testFilter && testFilter.options.length === 1) {
    try {
      const { data: tests } = await supabaseClient
        .from('tests')
        .select('id, test_name, system_category')
        .order('test_name');
      
      if (tests) {
        tests.forEach(test => {
          const option = document.createElement('option');
          option.value = test.id;
          option.textContent = `${test.system_category} - ${test.test_name}`;
          testFilter.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading test filter:', error);
    }
  }

  // Populate category filter
  const categoryFilter = document.getElementById('filterCategory');
  if (categoryFilter && categoryFilter.options.length === 1) {
    const categories = [...new Set(allQuestions.map(q => q.category || 'General'))].sort();
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      categoryFilter.appendChild(option);
    });
  }
}

function toggleQuestionSelection(id) {
  if (selectedQuestions.has(id)) {
    selectedQuestions.delete(id);
  } else {
    selectedQuestions.add(id);
  }
  updateSelectedCount();
  updateSelectAllCheckbox();
}

function toggleSelectAll() {
  const selectAllCheckbox = document.getElementById('selectAll');
  const checkboxes = document.querySelectorAll('.question-checkbox');
  
  selectedQuestions.clear();
  
  if (selectAllCheckbox.checked) {
    checkboxes.forEach(cb => {
      const id = parseInt(cb.dataset.questionId);
      selectedQuestions.add(id);
      cb.checked = true;
    });
  } else {
    checkboxes.forEach(cb => {
      cb.checked = false;
    });
  }
  
  updateSelectedCount();
}

function updateSelectAllCheckbox() {
  const selectAllCheckbox = document.getElementById('selectAll');
  const checkboxes = document.querySelectorAll('.question-checkbox');
  const checkedCount = document.querySelectorAll('.question-checkbox:checked').length;
  
  if (checkboxes.length === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  } else if (checkedCount === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  } else if (checkedCount === checkboxes.length) {
    selectAllCheckbox.checked = true;
    selectAllCheckbox.indeterminate = false;
  } else {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = true;
  }
}

function updateSelectedCount() {
  const countElement = document.getElementById('selectedCount');
  const deleteBtn = document.getElementById('deleteSelectedBtn');
  const count = selectedQuestions.size;
  
  countElement.textContent = `${count} selected`;
  
  if (count > 0) {
    deleteBtn.disabled = false;
    deleteBtn.style.opacity = '1';
  } else {
    deleteBtn.disabled = true;
    deleteBtn.style.opacity = '0.5';
  }
}

async function deleteSelected() {
  const count = selectedQuestions.size;
  
  if (count === 0) {
    alert('‚ö†Ô∏è No questions selected');
    return;
  }
  
  if (!confirm(`‚ö†Ô∏è Delete ${count} question${count === 1 ? '' : 's'}?\n\nThis action cannot be undone!`)) {
    return;
  }

  try {
    const { error } = await supabaseClient
      .from('test_questions')
      .delete()
      .in('id', Array.from(selectedQuestions));

    if (error) throw error;

    selectedQuestions.clear();
    loadQuestions();
    loadStats();
    
    // Show success message
    const reactions = ['üéâ', '‚úÖ', 'üí´', '‚≠ê'];
    const randomReaction = reactions[Math.floor(Math.random() * reactions.length)];
    alert(`${randomReaction} Successfully deleted ${count} question${count === 1 ? '' : 's'}!`);

  } catch (error) {
    console.error('Error deleting questions:', error);
    alert(`‚ùå Error deleting questions: ${error.message}`);
  }
}

// ========================================================
// DELETE QUESTION
// ========================================================
async function deleteQuestion(id) {
  if (!confirm('Are you sure you want to delete this question?')) {
    return;
  }

  try {
    const { error } = await supabaseClient
      .from('test_questions')
      .delete()
      .eq('id', id);

    if (error) throw error;

    loadQuestions();
    loadStats();

  } catch (error) {
    console.error('Error deleting question:', error);
    alert(`‚ùå Error deleting question: ${error.message}`);
  }
}

// ========================================================
// Q-BANK FUNCTIONS
// ========================================================

async function createQBank() {
  const name = document.getElementById('qbankName').value.trim();
  let category = document.getElementById('qbankCategory').value;
  const description = document.getElementById('qbankDescription').value.trim();

  if (!name) {
    showAlert('qbankAlert', '‚ö†Ô∏è Please enter a Q-Bank name', 'error');
    return;
  }

  // Handle custom category
  if (category === 'CUSTOM') {
    const customCategory = document.getElementById('customCategoryInput').value.trim();
    if (!customCategory) {
      showAlert('qbankAlert', '‚ö†Ô∏è Please enter a custom category name', 'error');
      return;
    }
    category = customCategory;
    
    // Add to localStorage for persistence
    addCustomCategory(customCategory);
  }

  try {
    const { error } = await supabaseClient
      .from('question_banks')
      .insert([{
        name,
        category,
        description: description || null
      }]);

    if (error) throw error;

    showAlert('qbankAlert', `‚úÖ Q-Bank created successfully with category "${category}"!`, 'success');
    
    // Clear form
    document.getElementById('qbankName').value = '';
    document.getElementById('qbankDescription').value = '';
    document.getElementById('qbankCategory').value = 'General';
    document.getElementById('customCategoryInput').value = '';
    document.getElementById('customCategoryField').style.display = 'none';
    
    // Reload Q-Banks list
    loadQBanks();

  } catch (error) {
    console.error('Error creating Q-Bank:', error);
    showAlert('qbankAlert', `‚ùå Error: ${error.message}`, 'error');
  }
}

async function loadQBanks() {
  const container = document.getElementById('qbanksList');
  container.innerHTML = '<div class="loading">Loading Q-Banks...</div>';

  try {
    // Get Q-Banks with question counts
    const { data: qbanks, error } = await supabaseClient
      .from('question_banks')
      .select(`
        *,
        qbank_questions (count)
      `)
      .order('created_at', { ascending: false });

    if (error) throw error;

    if (!qbanks || qbanks.length === 0) {
      container.innerHTML = '<div class="alert alert-info">üè¶ No Q-Banks yet. Create one above to get started!</div>';
      return;
    }

    let html = '';
    qbanks.forEach(qbank => {
      const questionCount = qbank.qbank_questions?.[0]?.count || 0;
      
      html += `
        <div class="question-item" style="margin-bottom: 20px;">
          <div class="question-header">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <h3 style="font-size: 18px; font-weight: 700; color: #ffffff; margin: 0;">
                  üè¶ ${qbank.name}
                </h3>
                <span style="background: rgba(102,126,234,0.3); border: 1px solid rgba(102,126,234,0.5); padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #a5b4fc;">
                  ${qbank.category}
                </span>
                <span style="background: rgba(74,222,128,0.3); border: 1px solid #4ade80; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #4ade80;">
                  ${questionCount} question${questionCount === 1 ? '' : 's'}
                </span>
              </div>
              ${qbank.description ? `
                <p style="font-size: 14px; color: rgba(255,255,255,0.7); margin: 8px 0 0 0;">
                  ${qbank.description}
                </p>
              ` : ''}
            </div>
            <div class="question-actions" style="display: flex; gap: 8px;">
              <button class="btn btn-primary btn-small" onclick="viewQBank(${qbank.id}, '${qbank.name.replace(/'/g, "\\'")}')">
                üìù Manage
              </button>
              <button class="btn btn-secondary btn-small" onclick="addQBankToTest(${qbank.id}, '${qbank.name.replace(/'/g, "\\'")}')">
                ‚ûï Add to Test
              </button>
              <button class="btn btn-danger btn-small" onclick="deleteQBank(${qbank.id}, '${qbank.name.replace(/'/g, "\\'")}')">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;

    // Also populate the target Q-Bank dropdown
    populateTargetQBankDropdown(qbanks);

  } catch (error) {
    console.error('Error loading Q-Banks:', error);
    container.innerHTML = `<div class="alert alert-error">‚ùå Error loading Q-Banks: ${error.message}</div>`;
  }
}

function populateTargetQBankDropdown(qbanks) {
  const dropdown = document.getElementById('targetQBank');
  if (!dropdown) return;

  if (!qbanks || qbanks.length === 0) {
    dropdown.innerHTML = '<option value="">No Q-Banks available - Create one first!</option>';
    return;
  }

  dropdown.innerHTML = '<option value="">Select a Q-Bank...</option>' +
    qbanks.map(qb => `<option value="${qb.id}">${qb.name} (${qb.category})</option>`).join('');
}

async function loadQBankDropdown() {
  const dropdown = document.getElementById('testQBank');
  const jsonDropdown = document.getElementById('jsonQBankId');

  try {
    const { data: qbanks, error } = await supabaseClient
      .from('question_banks')
      .select(`
        id,
        name,
        category,
        qbank_questions (count)
      `)
      .order('created_at', { ascending: false });

    if (error) throw error;

    // Update test creation dropdown
    if (dropdown) {
      if (!qbanks || qbanks.length === 0) {
        dropdown.innerHTML = '<option value="">No Q-Banks available - Create one in Q-Bank tab first!</option>';
      } else {
        dropdown.innerHTML = '<option value="">No Q-Bank (Add questions manually later)</option>' +
          qbanks.map(qb => {
            const count = qb.qbank_questions?.[0]?.count || 0;
            return `<option value="${qb.id}">${qb.name} - ${count} questions (${qb.category})</option>`;
          }).join('');
      }
    }

    // Update JSON import dropdown
    if (jsonDropdown) {
      if (!qbanks || qbanks.length === 0) {
        jsonDropdown.innerHTML = `
          <option value="">No Q-Banks available</option>
          <option value="CREATE_NEW">‚ûï Create New Q-Bank</option>
        `;
      } else {
        jsonDropdown.innerHTML = `
          <option value="">Select a Q-Bank...</option>
          <option value="CREATE_NEW">‚ûï Create New Q-Bank</option>
        ` + qbanks.map(qb => {
          const count = qb.qbank_questions?.[0]?.count || 0;
          return `<option value="${qb.id}">${qb.name} - ${count} questions (${qb.category})</option>`;
        }).join('');
      }
    }

  } catch (error) {
    console.error('Error loading Q-Bank dropdown:', error);
    if (dropdown) dropdown.innerHTML = '<option value="">Error loading Q-Banks</option>';
    if (jsonDropdown) jsonDropdown.innerHTML = '<option value="">Error loading Q-Banks</option>';
  }
}

async function linkQuestionsToQBank() {
  const qbankId = document.getElementById('targetQBank').value;
  const category = document.getElementById('linkCategory').value;
  const difficulty = document.getElementById('linkDifficulty').value;

  if (!qbankId) {
    showAlert('qbankAlert', '‚ö†Ô∏è Please select a Q-Bank', 'error');
    return;
  }

  try {
    // Build query to find matching questions
    let query = supabase
      .from('test_questions')
      .select('id');

    if (category) query = query.eq('category', category);
    if (difficulty) query = query.eq('difficulty', difficulty);

    const { data: questions, error: qError } = await query;

    if (qError) throw qError;

    if (!questions || questions.length === 0) {
      showAlert('qbankAlert', '‚ö†Ô∏è No questions found matching your filters', 'error');
      return;
    }

    // Confirm before linking
    if (!confirm(`üì• Add ${questions.length} question${questions.length === 1 ? '' : 's'} to this Q-Bank?\n\n${category ? 'Category: ' + category + '\n' : ''}${difficulty ? 'Difficulty: ' + difficulty : ''}`)) {
      return;
    }

    // Insert into qbank_questions
    const links = questions.map(q => ({
      qbank_id: parseInt(qbankId),
      question_id: q.id
    }));

    const { error: insertError } = await supabaseClient
      .from('qbank_questions')
      .insert(links);

    if (insertError) {
      // Handle duplicate key errors gracefully
      if (insertError.code === '23505') {
        showAlert('qbankAlert', `‚ö†Ô∏è Some questions were already in this Q-Bank. New questions have been added.`, 'success');
      } else {
        throw insertError;
      }
    } else {
      showAlert('qbankAlert', `‚úÖ Successfully added ${questions.length} question${questions.length === 1 ? '' : 's'} to Q-Bank!`, 'success');
    }

    // Reload Q-Banks to update counts
    loadQBanks();

    // Reset filters
    document.getElementById('linkCategory').value = '';
    document.getElementById('linkDifficulty').value = '';
    updateLinkPreview();

  } catch (error) {
    console.error('Error linking questions to Q-Bank:', error);
    showAlert('qbankAlert', `‚ùå Error: ${error.message}`, 'error');
  }
}

async function updateLinkPreview() {
  const category = document.getElementById('linkCategory').value;
  const difficulty = document.getElementById('linkDifficulty').value;
  const preview = document.getElementById('linkPreview');

  if (!category && !difficulty) {
    preview.innerHTML = 'üí° Select filters above to see how many questions will be added';
    return;
  }

  try {
    let query = supabase
      .from('test_questions')
      .select('id', { count: 'exact', head: true });

    if (category) query = query.eq('category', category);
    if (difficulty) query = query.eq('difficulty', difficulty);

    const { count, error } = await query;

    if (error) throw error;

    let filterText = '';
    if (category) filterText += `Category: <strong>${category}</strong>`;
    if (difficulty) {
      if (filterText) filterText += ' | ';
      filterText += `Difficulty: <strong>${difficulty}</strong>`;
    }

    preview.innerHTML = `üìä Found <strong>${count}</strong> question${count === 1 ? '' : 's'} matching: ${filterText}`;

  } catch (error) {
    preview.innerHTML = '‚ùå Error loading preview';
  }
}

// Add event listeners for live preview
document.addEventListener('DOMContentLoaded', () => {
  const categorySelect = document.getElementById('linkCategory');
  const difficultySelect = document.getElementById('linkDifficulty');
  
  if (categorySelect) categorySelect.addEventListener('change', updateLinkPreview);
  if (difficultySelect) difficultySelect.addEventListener('change', updateLinkPreview);
});

async function viewQBank(qbankId, qbankName) {
  // Switch to manage questions tab with Q-Bank filter
  switchTab('manage');
  
  // TODO: Add Q-Bank filter to manage questions
  alert(`üìö Viewing questions in "${qbankName}"\n\nThis feature will show all questions in this Q-Bank.`);
}

async function addQBankToTest(qbankId, qbankName) {
  // Get all tests
  const { data: tests, error: testsError } = await supabaseClient
    .from('tests')
    .select('id, test_name, system_category')
    .eq('is_active', true)
    .order('test_name');

  if (testsError) {
    await customAlert(`‚ùå Error loading tests: ${testsError.message}`);
    return;
  }

  if (!tests || tests.length === 0) {
    await customAlert('‚ö†Ô∏è No active tests found. Please create a test first!');
    return;
  }

  // Create custom selection dialog
  const selectedTest = await customTestSelector(tests, qbankName);
  if (!selectedTest) return;

  try {
    // Get all questions from Q-Bank
    const { data: qbankQuestions, error: qError } = await supabaseClient
      .from('qbank_questions')
      .select(`
        question_id,
        test_questions (*)
      `)
      .eq('qbank_id', qbankId);

    if (qError) throw qError;

    if (!qbankQuestions || qbankQuestions.length === 0) {
      await customAlert('‚ö†Ô∏è This Q-Bank has no questions yet!');
      return;
    }

    // Update all questions to belong to selected test
    const questionIds = qbankQuestions.map(q => q.question_id);
    
    const { error: updateError } = await supabaseClient
      .from('test_questions')
      .update({ test_id: selectedTest.id })
      .in('id', questionIds);

    if (updateError) throw updateError;

    await customAlert(`‚úÖ Successfully added ${questionIds.length} question${questionIds.length === 1 ? '' : 's'} from "${qbankName}" to "${selectedTest.test_name}"!`);
    loadStats();

  } catch (error) {
    console.error('Error adding Q-Bank to test:', error);
    await customAlert(`‚ùå Error: ${error.message}`);
  }
}

async function deleteQBank(id, name) {
  if (!confirm(`‚ö†Ô∏è Delete Q-Bank "${name}"?\n\nThis will remove the Q-Bank but NOT delete the questions themselves. Questions will remain in their tests.`)) {
    return;
  }

  try {
    const { error } = await supabaseClient
      .from('question_banks')
      .delete()
      .eq('id', id);

    if (error) throw error;

    loadQBanks();
    alert(`‚úÖ Q-Bank "${name}" deleted successfully!`);

  } catch (error) {
    console.error('Error deleting Q-Bank:', error);
    alert(`‚ùå Error: ${error.message}`);
  }
}

// ========================================================
// LOAD STATS
// ========================================================
async function loadStats() {
  try {
    const { count, error } = await supabaseClient
      .from('test_questions')
      .select('*', { count: 'exact', head: true });

    if (error) throw error;

    document.getElementById('totalQuestions').textContent = count || 0;

  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

// ========================================================
// REACTIONS MANAGEMENT
// ========================================================
const REACTIONS_KEY = 'arnoma-test-reactions-v1';

function loadReactionsData() {
  const saved = localStorage.getItem(REACTIONS_KEY);
  if (saved) {
    return JSON.parse(saved);
  }
  return {
    correct: [
      "Amazing! You got it right! üéâ",
      "Perfect! Keep up the great work! ‚≠ê",
      "Excellent! You're on fire! üî•",
      "Fantastic! That's correct! üí´",
      "Brilliant! You nailed it! üèÜ",
      "Outstanding! You're a star! üåü",
      "Superb! That's the right answer! ‚ú®",
      "Wonderful! You're doing great! üéØ"
    ],
    incorrect: [
      "Not quite, but keep trying! üí™",
      "Almost there! Review and try again! üìö",
      "Don't give up! You can do this! üåü",
      "Keep learning! Every mistake is progress! üöÄ",
      "Try again! You're getting closer! üí°",
      "No worries! Learning takes practice! üìñ",
      "Keep going! You'll get it next time! üéì",
      "Stay positive! Mistakes help you learn! üí´"
    ]
  };
}

function saveReactions() {
  const correctText = document.getElementById('correctReactions').value.trim();
  const incorrectText = document.getElementById('incorrectReactions').value.trim();

  if (!correctText && !incorrectText) {
    showAlert('reactionsAlert', '‚ö†Ô∏è Please add at least one reaction!', 'error');
    return;
  }

  const reactions = {
    correct: correctText ? correctText.split('\n').filter(line => line.trim()) : [],
    incorrect: incorrectText ? incorrectText.split('\n').filter(line => line.trim()) : []
  };

  if (reactions.correct.length === 0) {
    showAlert('reactionsAlert', '‚ö†Ô∏è Please add at least one correct answer reaction!', 'error');
    return;
  }

  if (reactions.incorrect.length === 0) {
    showAlert('reactionsAlert', '‚ö†Ô∏è Please add at least one incorrect answer reaction!', 'error');
    return;
  }

  localStorage.setItem(REACTIONS_KEY, JSON.stringify(reactions));
  showAlert('reactionsAlert', '‚úÖ üéâ Reactions saved successfully!', 'success');
  displayReactions();
}

function displayReactions() {
  const reactions = loadReactionsData();
  
  // Display correct reactions
  document.getElementById('correctCount').textContent = reactions.correct.length;
  const correctList = document.getElementById('correctList');
  if (reactions.correct.length > 0) {
    correctList.innerHTML = reactions.correct.map((r, i) => `
      <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
        ${i + 1}. ${r}
      </div>
    `).join('');
  } else {
    correctList.innerHTML = '<em>No reactions added yet</em>';
  }

  // Display incorrect reactions
  document.getElementById('incorrectCount').textContent = reactions.incorrect.length;
  const incorrectList = document.getElementById('incorrectList');
  if (reactions.incorrect.length > 0) {
    incorrectList.innerHTML = reactions.incorrect.map((r, i) => `
      <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
        ${i + 1}. ${r}
      </div>
    `).join('');
  } else {
    incorrectList.innerHTML = '<em>No reactions added yet</em>';
  }

  // Populate textareas
  document.getElementById('correctReactions').value = reactions.correct.join('\n');
  document.getElementById('incorrectReactions').value = reactions.incorrect.join('\n');
}

// ========================================================
// TESTS MANAGEMENT
// ========================================================
async function createNewTest() {
  const system = document.getElementById('testSystem').value.trim();
  const testName = document.getElementById('testName').value.trim();
  const description = document.getElementById('testDescription').value.trim();
  const qbankId = document.getElementById('testQBank').value;

  if (!system || !testName) {
    showAlert('testsAlert', '‚ö†Ô∏è Please fill in System and Test Name', 'error');
    return;
  }

  try {
    // Step 1: Create the test
    const { data: newTest, error: testError } = await supabaseClient
      .from('tests')
      .insert([{
        system_category: system,
        test_name: testName,
        description: description || null,
        is_active: true
      }])
      .select()
      .single();

    if (testError) throw testError;

    // Step 2: If Q-Bank selected, add all its questions to this test
    if (qbankId) {
      const { data: qbankQuestions, error: qError } = await supabaseClient
        .from('qbank_questions')
        .select('question_id')
        .eq('qbank_id', qbankId);

      if (qError) throw qError;

      if (qbankQuestions && qbankQuestions.length > 0) {
        const questionIds = qbankQuestions.map(q => q.question_id);
        
        // Update all questions to belong to this new test
        const { error: updateError } = await supabaseClient
          .from('test_questions')
          .update({ test_id: newTest.id })
          .in('id', questionIds);

        if (updateError) throw updateError;

        showAlert('testsAlert', `‚úÖ Test "${testName}" created with ${questionIds.length} questions from Q-Bank!`, 'success');
      } else {
        showAlert('testsAlert', `‚úÖ Test "${testName}" created (Q-Bank was empty)`, 'success');
      }
    } else {
      showAlert('testsAlert', `‚úÖ Test "${testName}" created successfully!`, 'success');
    }
    
    // Clear form
    document.getElementById('testSystem').value = '';
    document.getElementById('testName').value = '';
    document.getElementById('testDescription').value = '';
    document.getElementById('testQBank').value = '';

    // Reload tests
    loadTests();
    loadTestsDropdown();
    loadStats();

  } catch (error) {
    console.error('Error creating test:', error);
    showAlert('testsAlert', `‚ùå Error: ${error.message}`, 'error');
  }
}

async function loadTests() {
  const container = document.getElementById('testsList');
  
  try {
    const { data, error } = await supabaseClient
      .from('tests')
      .select('*')
      .order('system_category', { ascending: true });

    if (error) throw error;

    if (!data || data.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.5);padding:20px;">No tests created yet. Create your first test above!</div>';
      return;
    }

    // Group by category
    const grouped = data.reduce((acc, test) => {
      const cat = test.system_category || 'Other';
      if (!acc[cat]) acc[cat] = [];
      acc[cat].push(test);
      return acc;
    }, {});

    let html = '';
    Object.keys(grouped).sort().forEach(category => {
      html += `
        <div style="margin-bottom: 30px;">
          <div style="background: rgba(255,255,255,0.1); padding: 12px 20px; border-radius: 10px; margin-bottom: 15px; font-weight: 600; font-size: 16px; color: #ffffff;">
            üìö ${category} (${grouped[category].length})
          </div>
      `;
      
      grouped[category].forEach(test => {
        html += `
          <div class="question-item" style="margin-bottom: 15px;">
            <div class="question-header">
              <div style="flex: 1;">
                <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                  <span style="background: rgba(102,126,234,0.3); border: 1px solid rgba(102,126,234,0.5); padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #a5b4fc;">
                    ${test.system_category}
                  </span>
                  <span style="background: ${test.is_active ? 'rgba(74,222,128,0.3)' : 'rgba(239,68,68,0.3)'}; border: 1px solid ${test.is_active ? '#4ade80' : '#ef4444'}; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: ${test.is_active ? '#4ade80' : '#ef4444'};">
                    ${test.is_active ? '‚úÖ Active' : '‚≠ï Inactive'}
                  </span>
                </div>
                <div class="question-text" style="margin-bottom: 6px;">${test.test_name}</div>
                ${test.description ? `<div style="font-size: 13px; color: rgba(255,255,255,0.6); line-height: 1.4;">${test.description}</div>` : '<div style="font-size: 13px; color: rgba(255,255,255,0.4); font-style: italic;">No description</div>'}
              </div>
              <div class="question-actions" style="display: flex; gap: 8px;">
                <button class="btn btn-primary btn-small" onclick="editTest(${test.id}, '${test.test_name.replace(/'/g, "\\'")}', '${test.system_category.replace(/'/g, "\\'")}', '${(test.description || '').replace(/'/g, "\\'")}', ${test.is_active})" style="background: rgba(59,130,246,0.2); border-color: #3b82f6; color: #60a5fa;">‚úèÔ∏è Edit</button>
                <button class="btn btn-danger btn-small" onclick="deleteTest(${test.id}, '${test.test_name.replace(/'/g, "\\'")}')" style="padding: 8px 14px;">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
    });

    container.innerHTML = html;

  } catch (error) {
    console.error('Error loading tests:', error);
    container.innerHTML = `<div class="alert alert-error">‚ùå Error loading tests: ${error.message}</div>`;
  }
}

async function loadTestsDropdown() {
  const dropdown = document.getElementById('questionTestId');
  const bulkDropdown = document.getElementById('bulkTestId');
  
  try {
    const { data, error } = await supabaseClient
      .from('tests')
      .select('id, test_name, system_category')
      .eq('is_active', true)
      .order('test_name');

    if (error) throw error;

    const optionsHTML = data && data.length > 0
      ? data.map(test => `<option value="${test.id}">${test.system_category} - ${test.test_name}</option>`).join('')
      : '<option value="">No tests available - Create one first!</option>';

    dropdown.innerHTML = optionsHTML;
    if (bulkDropdown) bulkDropdown.innerHTML = optionsHTML;

  } catch (error) {
    console.error('Error loading tests dropdown:', error);
    const errorHTML = '<option value="">Error loading tests</option>';
    dropdown.innerHTML = errorHTML;
    if (bulkDropdown) bulkDropdown.innerHTML = errorHTML;
  }
}

async function deleteTest(id, testName) {
  if (!confirm(`‚ö†Ô∏è Delete "${testName}"?\n\nThis will permanently delete the test and ALL its questions. This cannot be undone!`)) {
    return;
  }

  try {
    const { error } = await supabaseClient
      .from('tests')
      .delete()
      .eq('id', id);

    if (error) throw error;

    showAlert('testsAlert', `‚úÖ Test "${testName}" deleted successfully`, 'success');
    loadTests();
    loadTestsDropdown();

  } catch (error) {
    console.error('Error deleting test:', error);
    showAlert('testsAlert', `‚ùå Error: ${error.message}`, 'error');
  }
}

let editingTestId = null;

async function editTest(id, name, system, description, isActive) {
  editingTestId = id;
  
  // Populate form
  document.getElementById('testSystem').value = system;
  document.getElementById('testName').value = name;
  document.getElementById('testDescription').value = description;
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Change button text
  const btn = document.querySelector('#testsTab .btn');
  btn.textContent = 'üíæ Update Test';
  btn.onclick = updateTest;
  
  // Add cancel button
  if (!document.getElementById('cancelEditBtn')) {
    const cancelBtn = document.createElement('button');
    cancelBtn.id = 'cancelEditBtn';
    cancelBtn.className = 'btn';
    cancelBtn.style.marginLeft = '10px';
    cancelBtn.style.background = 'rgba(239,68,68,0.2)';
    cancelBtn.style.borderColor = '#ef4444';
    cancelBtn.textContent = '‚ùå Cancel';
    cancelBtn.onclick = cancelEdit;
    btn.parentNode.appendChild(cancelBtn);
  }
  
  showAlert('testsAlert', `‚úèÔ∏è Editing "${name}" - Make changes and click Update`, 'info');
}

async function updateTest() {
  if (!editingTestId) return;
  
  const system = document.getElementById('testSystem').value.trim();
  const testName = document.getElementById('testName').value.trim();
  const description = document.getElementById('testDescription').value.trim();

  if (!system || !testName) {
    showAlert('testsAlert', '‚ö†Ô∏è Please fill in System and Test Name', 'error');
    return;
  }

  try {
    const { error } = await supabaseClient
      .from('tests')
      .update({
        system_category: system,
        test_name: testName,
        description: description || null,
        updated_at: new Date().toISOString()
      })
      .eq('id', editingTestId);

    if (error) throw error;

    showAlert('testsAlert', `‚úÖ Test "${testName}" updated successfully!`, 'success');
    
    cancelEdit();
    loadTests();
    loadTestsDropdown();

  } catch (error) {
    console.error('Error updating test:', error);
    showAlert('testsAlert', `‚ùå Error: ${error.message}`, 'error');
  }
}

function cancelEdit() {
  editingTestId = null;
  
  // Clear form
  document.getElementById('testSystem').value = '';
  document.getElementById('testName').value = '';
  document.getElementById('testDescription').value = '';
  
  // Reset button
  const btn = document.querySelector('#testsTab .btn');
  btn.textContent = 'üì¶ Create Test';
  btn.onclick = createNewTest;
  
  // Remove cancel button
  const cancelBtn = document.getElementById('cancelEditBtn');
  if (cancelBtn) cancelBtn.remove();
  
  showAlert('testsAlert', '', 'success');
}

// ========================================================
// INITIALIZE
// ========================================================
loadStats();
displayReactions();
loadTests();
loadTestsDropdown();
loadQBankDropdown();
updateCategoryDropdowns(); // Load saved custom categories
</script>

</body>
</html>
