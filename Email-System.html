<!doctype html>
<html lang="en">
  <!--
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë  ARNOMA EMAIL AUTOMATION SYSTEM v3.17.0                           ‚ïë
    ‚ïë  All 12 Production Templates Loaded by Default                   ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

    üéØ SYSTEM OVERVIEW:
    This is a standalone email automation system that integrates with ARNOMA
    via iframe + postMessage communication. It provides:

    ‚úÖ 5 default email templates (payment, receipt, reminder, etc.)
    ‚úÖ 12 test email templates with consistent .info-box design
    ‚úÖ 90+ trigger types across 9 categories
    ‚úÖ Advanced condition builder for smart filtering
    ‚úÖ Execution settings (priority, rate limiting, retries)
    ‚úÖ Sent email tracking with Resend delivery status
    ‚úÖ Full Supabase + Resend integration

    üî• TRIGGER CATEGORIES (9):
    1. Interval (time-based scheduling)
    2. System (startup, midnight, timezone shifts)
    3. Student (lifecycle events: added, updated, status changed)
    4. Payment (received, missing, credit actions)
    5. Class (before/after, start/end, canceled)
    6. Attendance (absences, activity tracking)
    7. Communication (manual, template updates)
    8. Webhook (Supabase realtime, row changes)
    9. Developer (custom events, scripts, API triggers)

    üì° COMMUNICATION PROTOCOL:
    Parent window can fire triggers via postMessage:

        window.postMessage({
            type: 'arnoma_event',
            category: 'payment',
            trigger: 'payment_received',
            data: {
                student: { name: 'John', email: 'john@example.com' },
                payment: { amount: 50, date: '2025-11-23' }
            }
        }, '*');

    Or directly via global API:

        window.arnoma_fireTrigger('student', 'student_added', {
            student: { name: 'Jane', email: 'jane@example.com' }
        });

    ‚öôÔ∏è CONDITION BUILDER:
    Automations can have multiple conditions (AND logic):
    - Field: student.status, student.balance, payment.amount, etc.
    - Operators: ==, !=, >, <, >=, <=, contains, in, etc.
    - Value: comparison value

    üéØ EXECUTION SETTINGS:
    - Run once per student (deduplication)
    - Rate limiting (max 1 email/hour/student)
    - Priority levels (low, normal, high, urgent)
    - Max retries (0-10)

    üìß EMAIL SENDING:
    Supabase Edge Function ‚Üí Resend API
    All emails tracked in localStorage with delivery status

    üîß DEVELOPER NOTES:
    - All existing functionality preserved (NEVER removed)
    - Only ADDITIONS made to extend system
    - Backward compatible with all existing automations
    - localStorage keys: arnoma-email-templates-v7, arnoma-automations-v1, arnoma-sent-emails-v1
-->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="version" content="3.20.2" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>ARNOMA Email System</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      @keyframes breathe {
        0%,

                            ${
                              auto.confirmBeforeSend
                                ? `<div style="margin-bottom: 16px; display: inline-flex; align-items: center; gap: 6px; background: rgba(251,191,36,0.15); border: 1px solid rgba(251,191,36,0.4); color: #fbbf24; padding: 8px 12px; border-radius: 999px; font-size: 12px;">
                                      ‚ö†Ô∏è Manual confirmation required
                                   </div>`
                                : ''
                            }
        100% {
          opacity: 0.4;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.1);
        }
      }

      @keyframes glow {
        0%,
        100% {
          box-shadow:
            0 0 20px rgba(102, 126, 234, 0.3),
            0 0 40px rgba(118, 75, 162, 0.2);
        }
        50% {
          box-shadow:
            0 0 30px rgba(102, 126, 234, 0.5),
            0 0 60px rgba(118, 75, 162, 0.3);
        }
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', sans-serif;
        background: #0f172a;
        min-height: 100vh;
        padding: 40px 20px;
        position: relative;
        overflow-x: hidden;
        color: rgba(255, 255, 255, 0.9);
      }

      body::before {
        content: '';
        position: fixed;
        width: 600px;
        height: 600px;
        background: radial-gradient(circle, rgba(102, 126, 234, 0.5) 0%, transparent 70%);
        top: -200px;
        right: -100px;
        border-radius: 50%;
        filter: blur(80px);
        pointer-events: none;
        z-index: 0;
        animation: breathe 8s ease-in-out infinite;
      }

      body::after {
        content: '';
        position: fixed;
        width: 700px;
        height: 700px;
        background: radial-gradient(circle, rgba(118, 75, 162, 0.4) 0%, transparent 70%);
        bottom: -150px;
        left: -150px;
        border-radius: 50%;
        filter: blur(80px);
        pointer-events: none;
        z-index: 0;
        animation: breathe 10s ease-in-out infinite reverse;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }

      /* GLASS HEADER */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        padding: 24px;
        background: rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(var(--card-blur));
        -webkit-backdrop-filter: blur(var(--card-blur));
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .header-title {
        font-size: 28px;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
      }

      .header-actions {
        display: flex;
        gap: 12px;
      }

      /* NEON GLASS BUTTONS */
      .btn {
        background: rgba(255, 255, 255, 0.06);
        backdrop-filter: blur(var(--modal-blur));
        -webkit-backdrop-filter: blur(var(--modal-blur));
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 12px;
        padding: 12px 24px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow:
          0 4px 16px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        position: relative;
      }

      .btn::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 12px;
        padding: 1px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.5), rgba(118, 75, 162, 0.5));
        -webkit-mask:
          linear-gradient(#fff 0 0) content-box,
          linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask:
          linear-gradient(#fff 0 0) content-box,
          linear-gradient(#fff 0 0);
        mask-composite: exclude;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow:
          0 0 24px rgba(102, 126, 234, 0.4),
          0 8px 24px rgba(0, 0, 0, 0.3);
        background: rgba(255, 255, 255, 0.1);
      }

      .btn:hover::before {
        opacity: 1;
      }

      /* GLASS SECTIONS */
      .section {
        background: rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(var(--card-blur));
        -webkit-backdrop-filter: blur(var(--card-blur));
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
      }

      .section h2 {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 20px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.7));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
      }

      /* INPUT FIELDS */
      .test-email-input {
        width: 100%;
        max-width: 400px;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 14px;
        margin-bottom: 20px;
        transition: all 0.3s;
      }

      .test-email-input:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(102, 126, 234, 0.6);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
      }

      .test-email-input::placeholder {
        color: rgba(255, 255, 255, 0.4);
      }

      /* TEST GRID */
      .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
      }

      .test-btn {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(var(--modal-blur));
        -webkit-backdrop-filter: blur(var(--modal-blur));
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 16px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .test-btn:hover {
        transform: translateY(-2px) scale(1.02);
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(16, 185, 129, 0.4);
        box-shadow:
          0 0 20px rgba(16, 185, 129, 0.2),
          0 8px 20px rgba(0, 0, 0, 0.3);
      }

      /* TEMPLATE GRID */
      #templatesGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 24px;
        align-items: stretch;
      }

      .template-card {
        background: rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(var(--modal-blur));
        -webkit-backdrop-filter: blur(var(--modal-blur));
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        display: grid;
        grid-template-rows: auto minmax(120px, 1fr) auto;
        position: relative;
        height: 100%;
      }

      .template-card:hover {
        transform: translateY(-4px);
        background: rgba(255, 255, 255, 0.06);
        box-shadow:
          0 0 30px rgba(118, 75, 162, 0.3),
          0 12px 32px rgba(0, 0, 0, 0.4);
        border-color: rgba(118, 75, 162, 0.4);
      }

      /* MODALS */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal.active {
        display: flex;
      }

      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(var(--panel-blur));
        -webkit-backdrop-filter: blur(var(--panel-blur));
      }

      .modal-card {
        position: relative;
        background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
        backdrop-filter: blur(var(--card-blur));
        -webkit-backdrop-filter: blur(var(--card-blur));
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 24px;
        max-width: 900px;
        width: 100%;
        max-height: 85vh;
        box-shadow:
          0 25px 60px rgba(0, 0, 0, 0.6),
          inset 0 1px 0 rgba(255, 255, 255, 0.08);
        display: flex;
        flex-direction: column;
        z-index: 1001;
        will-change: transform;
        transform: translateZ(0);
      }

      .modal-header {
        padding: 24px 28px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      }

      .modal-title {
        font-size: 22px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
      }

      .modal-close {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.15);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        color: rgba(255, 255, 255, 0.9);
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }

      .modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: rotate(90deg);
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
      }

      .modal-body {
        overflow-y: auto;
        padding: 28px;
        flex: 1;
      }

      .modal-body::-webkit-scrollbar {
        width: 8px;
      }

      .modal-body::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .modal-body::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 10px;
      }

      /* FORM ELEMENTS */
      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .form-input,
      .form-textarea,
      .form-select {
        width: 100%;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 14px;
        transition: all 0.3s;
      }

      .form-input:focus,
      .form-textarea:focus,
      .form-select:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(102, 126, 234, 0.6);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
      }

      .form-textarea {
        min-height: 200px;
        resize: vertical;
        font-family: 'Monaco', monospace;
        font-size: 13px;
      }

      .form-input::placeholder,
      .form-textarea::placeholder {
        color: rgba(255, 255, 255, 0.3);
      }

      .form-select option {
        background: #1a1d35;
        color: white;
      }

      .btn-group {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .btn-primary {
        flex: 1;
        padding: 14px 24px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: white;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        transition: all 0.3s;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow:
          0 0 30px rgba(102, 126, 234, 0.6),
          0 8px 24px rgba(0, 0, 0, 0.3);
      }

      .btn-secondary {
        flex: 1;
        padding: 14px 24px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      /* RICH TEXT EDITOR BUTTONS */
      .editor-btn {
        padding: 6px 10px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: #fff;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .editor-btn:hover {
        background: rgba(102, 126, 234, 0.3);
        border-color: rgba(102, 126, 234, 0.6);
        transform: translateY(-1px);
        box-shadow: 0 0 12px rgba(102, 126, 234, 0.4);
      }

      .editor-btn:active {
        transform: translateY(0);
      }

      .var-btn {
        padding: 5px 12px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
        border: 1.5px solid rgba(102, 126, 234, 0.4);
        border-radius: 8px;
        color: #a5b4fc;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .var-btn:hover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
        border-color: rgba(102, 126, 234, 0.7);
        transform: translateY(-2px);
        box-shadow: 0 0 16px rgba(102, 126, 234, 0.5);
        color: #c7d2fe;
      }

      .var-btn:active {
        transform: translateY(0);
      }

      /* EMPTY STATE */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: rgba(255, 255, 255, 0.5);
      }

      .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.6;
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
        }
        .test-grid,
        #templatesGrid {
          grid-template-columns: 1fr;
        }
      }

      /* ============================================================ */
      /* INFO ICON (‚ìò) TOOLTIP SYSTEM - UNIVERSAL */
      /* ============================================================ */
      .info-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: rgba(102, 126, 234, 0.15);
        border: 1px solid rgba(102, 126, 234, 0.4);
        color: rgba(167, 185, 252, 0.9);
        font-size: 11px;
        font-weight: 700;
        font-style: normal;
        cursor: help;
        margin-left: 6px;
        transition: all 0.2s ease;
        position: absolute;
        top: -8px;
        right: -8px;
        flex-shrink: 0;
        box-shadow: 0 0 8px rgba(102, 126, 234, 0.2);
      }

      .info-icon:hover {
        background: rgba(102, 126, 234, 0.25);
        border-color: rgba(102, 126, 234, 0.6);
        box-shadow: 0 0 12px rgba(102, 126, 234, 0.4);
        transform: scale(1.15);
      }

      .tooltip {
        display: none; /* Hidden by default */
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        padding: 24px 28px;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.98));
        backdrop-filter: blur(var(--card-blur));
        -webkit-backdrop-filter: blur(var(--card-blur));
        border: 2px solid rgba(102, 126, 234, 0.4);
        border-radius: 16px;
        box-shadow:
          0 20px 60px rgba(0, 0, 0, 0.6),
          0 0 40px rgba(102, 126, 234, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        line-height: 1.7;
        z-index: 1000000;
        pointer-events: auto;
        cursor: default;
        user-select: text;
        -webkit-user-select: text;
        opacity: 0;
        animation: tooltipFadeIn 0.25s ease forwards;
      }

      @keyframes tooltipFadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      .tooltip.show {
        display: block;
      }

      /* Tooltip backdrop/overlay */
      .tooltip-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(var(--list-blur));
        -webkit-backdrop-filter: blur(var(--list-blur));
        z-index: 999999;
        opacity: 0;
        animation: overlayFadeIn 0.2s ease forwards;
      }

      @keyframes overlayFadeIn {
        to {
          opacity: 1;
        }
      }

      .tooltip-overlay.show {
        display: block;
      }

      /* Close button */
      .tooltip-close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(102, 126, 234, 0.15);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        color: rgba(167, 185, 252, 0.9);
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 10;
      }

      .tooltip-close:hover {
        background: rgba(102, 126, 234, 0.25);
        border-color: rgba(102, 126, 234, 0.5);
        color: #fff;
        transform: scale(1.05);
      }

      /* Content area with padding to avoid close button */
      .tooltip-content {
        padding-right: 16px;
        margin-top: 8px;
      }

      .tooltip.dropdown-tooltip {
        max-width: 400px;
        font-size: 13px;
        padding: 20px 24px;
      }

      .tooltip strong {
        color: rgba(167, 185, 252, 0.95);
        font-weight: 600;
      }

      /* Remove the arrow */
      .tooltip::before {
        display: none;
      }

      .tooltip.position-top::before,
      .tooltip.position-bottom::before {
        display: none;
      }

      /* Test Email List Styles */
      .test-email-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        margin: 6px 0;
        background: rgba(102, 126, 234, 0.08);
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 10px;
        transition: all 0.2s ease;
      }

      .test-email-item:hover {
        background: rgba(102, 126, 234, 0.12);
        border-color: rgba(102, 126, 234, 0.3);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
      }

      .email-text {
        flex: 1;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.85);
        font-family: 'SF Mono', Monaco, monospace;
      }

      .email-actions {
        display: flex;
        gap: 6px;
      }

      .icon-btn {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .icon-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 0 12px rgba(102, 126, 234, 0.3);
      }

      .edit-btn:hover {
        background: rgba(102, 126, 234, 0.2);
        border-color: rgba(102, 126, 234, 0.4);
      }

      .delete-btn:hover {
        background: rgba(248, 113, 113, 0.2);
        border-color: rgba(248, 113, 113, 0.4);
      }

      .save-btn:hover {
        background: rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.4);
      }

      .cancel-btn:hover {
        background: rgba(251, 146, 60, 0.2);
        border-color: rgba(251, 146, 60, 0.4);
      }

      .design-dialog-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.82);
        backdrop-filter: blur(var(--modal-blur)) saturate(130%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.15s ease-out;
      }

      .design-dialog {
        width: min(420px, calc(100% - 32px));
        background: linear-gradient(145deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9));
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 18px;
        padding: 28px;
        box-shadow: 0 25px 70px rgba(7, 11, 25, 0.45);
        transform: translateY(10px) scale(0.98);
        animation: dialogPop 0.2s ease-out forwards;
      }

      .design-dialog-icon {
        width: 58px;
        height: 58px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        margin-bottom: 18px;
      }

      .design-dialog-icon.is-info {
        background: rgba(59, 130, 246, 0.12);
        color: #60a5fa;
      }

      .design-dialog-icon.is-success {
        background: rgba(34, 197, 94, 0.15);
        color: #34d399;
      }

      .design-dialog-icon.is-warning {
        background: rgba(245, 158, 11, 0.15);
        color: #fbbf24;
      }

      .design-dialog-icon.is-error {
        background: rgba(239, 68, 68, 0.15);
        color: #f87171;
      }

      .design-dialog-title {
        font-size: 20px;
        font-weight: 700;
        color: #f8fafc;
        margin: 0 0 10px 0;
      }

      .design-dialog-message {
        color: rgba(226, 232, 240, 0.85);
        font-size: 15px;
        line-height: 1.6;
        margin-bottom: 24px;
        white-space: pre-wrap;
      }

      .design-dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .design-dialog-btn {
        border: none;
        border-radius: 999px;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .design-dialog-btn:focus {
        outline: 2px solid rgba(147, 197, 253, 0.4);
        outline-offset: 2px;
      }

      .design-dialog-btn.primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #f8fafc;
        box-shadow: 0 10px 25px rgba(103, 114, 229, 0.35);
      }

      .design-dialog-btn.success {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #f8fafc;
        box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
      }

      .design-dialog-btn.danger {
        background: linear-gradient(135deg, #f43f5e, #e11d48);
        color: #f8fafc;
        box-shadow: 0 10px 25px rgba(244, 63, 94, 0.35);
      }

      .design-dialog-btn.secondary {
        background: rgba(148, 163, 184, 0.15);
        color: rgba(248, 250, 252, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.4);
      }

      .design-dialog-btn:hover {
        transform: translateY(-1px) scale(1.01);
      }

      .design-dialog-btn:active {
        transform: translateY(0);
      }

      @keyframes dialogPop {
        from {
          opacity: 0;
          transform: translateY(10px) scale(0.96);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Sent Email Card Hover Effect - No Flickering */
      .sent-email-card {
        cursor: pointer;
      }

      .sent-email-card:hover {
        transform: translateY(-2px);
        border-color: rgba(102,126,234,0.3) !important;
        box-shadow: 0 8px 20px rgba(102,126,234,0.15);
      }
    </style>
  <style>:root{--panel-blur:8px;--card-blur:8px;--modal-blur:14px;--list-blur:0px;}</style>
</head>
  <body>
    <div class="container">
      <!-- HEADER -->
      <div class="header">
        <div class="header-title">üìß ARNOMA Email System</div>
        <div class="header-actions">
          <button class="btn" onclick="openSentEmails()">üì® Sent Emails</button>
          <button class="btn" onclick="openAutomations()">‚öôÔ∏è Automations</button>
          <button class="btn" onclick="openEditor()">‚ú® Create Template</button>
        </div>
      </div>

      <!-- TEST EMAIL SECTION -->
      <div class="section">
        <h2>üß™ Test Email System</h2>
        <p style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin-bottom: 20px">
          Click any button below to preview how the email looks with sample data
        </p>
        <div class="test-grid">
          <button class="test-btn" onclick="openTestEmail('profile_update')">üìù Profile Update</button>
          <button class="test-btn" onclick="openTestEmail('alias_added')">üè∑Ô∏è Alias Added</button>
          <button class="test-btn" onclick="openTestEmail('schedule_update')">üìÖ Schedule Update</button>
          <button class="test-btn" onclick="openTestEmail('group_enrollment')">üë• Group Enrollment</button>
          <button class="test-btn" onclick="openTestEmail('credit_added')">üí∞ Credit Added</button>
          <button class="test-btn" onclick="openTestEmail('credit_applied')">‚úÖ Credit Applied</button>
          <button class="test-btn" onclick="openTestEmail('credit_edit')">‚úèÔ∏è Credit Edit</button>
          <button class="test-btn" onclick="openTestEmail('status_paused')">‚è∏Ô∏è Status: Paused</button>
          <button class="test-btn" onclick="openTestEmail('status_active')">‚ñ∂Ô∏è Status: Active</button>
          <button class="test-btn" onclick="openTestEmail('status_graduated')">üéì Status: Graduated</button>
          <button class="test-btn" onclick="openTestEmail('absence_marked')">üö´ Absence Marked</button>
          <button class="test-btn" onclick="openTestEmail('schedule_change')">üîÑ Schedule Change</button>
        </div>
      </div>

      <!-- TEMPLATES SECTION -->
      <div class="section">
        <h2>üìã Email Templates</h2>
        <div id="templatesGrid">
          <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <div>No templates yet</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SENT EMAILS MODAL -->
    <div id="sentEmailsModal" class="modal">
      <div class="modal-overlay" onclick="closeSentEmails()"></div>
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">üì® Sent Emails</div>
          <div style="display: flex; gap: 12px; align-items: center">
            <button
              class="btn"
              onclick="emailSystem.clearAllSentEmails()"
              style="
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
                color: #f87171;
                border: 1.5px solid rgba(239, 68, 68, 0.4);
                padding: 8px 16px;
                font-size: 13px;
                font-weight: 600;
              "
            >
              üóëÔ∏è Clear All
            </button>
            <button class="modal-close" onclick="closeSentEmails()">√ó</button>
          </div>
        </div>
        <div class="modal-body">
          <div class="empty-state">
            <div class="empty-icon">üì¨</div>
            <div>No emails sent yet</div>
          </div>
        </div>
      </div>
    </div>

    <!-- TEMPLATE EDITOR MODAL -->
    <div id="editorModal" class="modal">
      <div class="modal-overlay" onclick="closeEditor()"></div>
      <div class="modal-card" style="max-width: 1400px; width: 95vw">
        <div class="modal-header">
          <div class="modal-title">‚ú® Template Editor</div>
          <button class="modal-close" onclick="closeEditor()">√ó</button>
        </div>
        <div class="modal-body">
          <!-- Two Column Layout: Editor + Preview -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; height: calc(90vh - 200px)">
            <!-- LEFT COLUMN: Editor Form -->
            <div style="overflow-y: auto; padding-right: 12px">
              <form onsubmit="return false;">
                <div class="form-group">
                  <label class="form-label" style="display: block; position: relative; padding-right: 24px">
                    Template Name
                    <span
                      class="info-icon"
                      data-tooltip="<strong>What it does:</strong> Label that appears in your template dropdown when creating automations‚Äîstudents never see it.<br><br><strong>Best practice:</strong> Use '[Trigger] - [Audience]' format so you can scan the list fast.<br><br><strong>Good:</strong> 'Late Payment Warning - Active Students'<br><strong>Bad:</strong> 'Template 1' or 'Email'"
                    >
                      ‚ìò
                    </span>
                  </label>
                  <input
                    type="text"
                    id="templateName"
                    class="form-input"
                    placeholder="e.g., Welcome Email"
                    oninput="updatePreview()"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label" style="display: block; position: relative; padding-right: 24px">
                    Subject Line
                    <span
                      class="info-icon"
                      data-tooltip="<strong>What students see first</strong> in their inbox preview.<br><br><strong>Goal:</strong> Earn the open in 6 words or less.<br><br><strong>Good:</strong> 'Class tomorrow 8pm ‚Äì Zoom link inside'<br><strong>Better:</strong> 'Payment received: $45.00 ‚úÖ'<br><strong>Avoid:</strong> vague subjects like 'Update' or 'Notification'<br><br><strong>Tip:</strong> Use {{StudentName}} or {{Amount}} to personalize instantly."
                    >
                      ‚ìò
                    </span>
                  </label>
                  <input
                    type="text"
                    id="templateSubject"
                    class="form-input"
                    placeholder="e.g., Welcome to ARNOMA!"
                    oninput="updatePreview()"
                  />
                </div>
                <div class="form-group">
                  <label
                    class="form-label"
                    style="display: block; position: relative; padding-right: 24px; margin-bottom: 12px"
                  >
                    HTML Body
                    <span
                      class="info-icon"
                      data-tooltip="<strong>The full email content</strong> students read after opening.<br><br><strong>Supports:</strong> basic HTML tags, inline CSS, and ARNOMA variables like {{StudentName}}, {{Balance}}, {{ClassDate}}.<br><br><strong>Pro tip:</strong> Keep layouts simple‚ÄîGmail strips most CSS and complex nested divs break on mobile. Test by sending yourself a copy first.<br><br><strong>Available variables:</strong> hover 'Trigger Type' dropdown options to see what data each trigger provides."
                    >
                      ‚ìò
                    </span>
                  </label>

                  <!-- Rich Text Editor Toolbar -->
                  <div
                    style="
                      background: rgba(255, 255, 255, 0.05);
                      border: 1px solid rgba(255, 255, 255, 0.1);
                      border-radius: 12px 12px 0 0;
                      padding: 12px;
                      display: flex;
                      flex-wrap: wrap;
                      gap: 8px;
                      align-items: center;
                    "
                  >
                    <!-- Text Formatting Group -->
                    <div
                      style="
                        display: flex;
                        gap: 4px;
                        padding-right: 8px;
                        border-right: 1px solid rgba(255, 255, 255, 0.1);
                      "
                    >
                      <button type="button" onclick="formatText('bold')" class="editor-btn" title="Bold">
                        <strong>B</strong>
                      </button>
                      <button type="button" onclick="formatText('italic')" class="editor-btn" title="Italic">
                        <em>I</em>
                      </button>
                      <button type="button" onclick="formatText('underline')" class="editor-btn" title="Underline">
                        <u>U</u>
                      </button>
                    </div>

                    <!-- Font Size Picker -->
                    <div
                      style="
                        display: flex;
                        gap: 6px;
                        align-items: center;
                        padding-right: 8px;
                        border-right: 1px solid rgba(255, 255, 255, 0.1);
                      "
                    >
                      <label style="font-size: 11px; color: rgba(255, 255, 255, 0.6)">Size:</label>
                      <select
                        id="fontSize"
                        onchange="applyFontSize(this.value)"
                        style="
                          background: rgba(255, 255, 255, 0.08);
                          border: 1px solid rgba(255, 255, 255, 0.2);
                          color: #fff;
                          padding: 4px 8px;
                          border-radius: 6px;
                          font-size: 12px;
                          cursor: pointer;
                        "
                      >
                        <option value="12px">12px</option>
                        <option value="14px" selected>14px</option>
                        <option value="16px">16px</option>
                        <option value="18px">18px</option>
                        <option value="20px">20px</option>
                        <option value="24px">24px</option>
                        <option value="28px">28px</option>
                        <option value="32px">32px</option>
                      </select>
                    </div>

                    <!-- Font Family Picker -->
                    <div
                      style="
                        display: flex;
                        gap: 6px;
                        align-items: center;
                        padding-right: 8px;
                        border-right: 1px solid rgba(255, 255, 255, 0.1);
                      "
                    >
                      <label style="font-size: 11px; color: rgba(255, 255, 255, 0.6)">Font:</label>
                      <select
                        id="fontFamily"
                        onchange="applyFontFamily(this.value)"
                        style="
                          background: rgba(255, 255, 255, 0.08);
                          border: 1px solid rgba(255, 255, 255, 0.2);
                          color: #fff;
                          padding: 4px 8px;
                          border-radius: 6px;
                          font-size: 12px;
                          cursor: pointer;
                        "
                      >
                        <option value="Arial, sans-serif" selected>Arial</option>
                        <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                      </select>
                    </div>

                    <!-- Info Box Adder -->
                    <button
                      type="button"
                      onclick="insertInfoBox()"
                      class="editor-btn"
                      title="Insert Info Box"
                      style="padding: 6px 12px"
                    >
                      üì¶ Info Box
                    </button>
                  </div>

                  <!-- Variable Buttons Section -->
                  <div
                    style="
                      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
                      border-left: 1px solid rgba(255, 255, 255, 0.1);
                      border-right: 1px solid rgba(255, 255, 255, 0.1);
                      padding: 12px;
                      display: flex;
                      flex-wrap: wrap;
                      gap: 6px;
                      align-items: center;
                    "
                  >
                    <label
                      style="font-size: 11px; color: rgba(255, 255, 255, 0.7); font-weight: 600; margin-right: 8px"
                    >
                      üìå Variables:
                    </label>

                    <!-- Student Variables -->
                    <button type="button" onclick="insertVariable('{{StudentName}}')" class="var-btn">
                      üë§ StudentName
                    </button>
                    <button type="button" onclick="insertVariable('{{StudentEmail}}')" class="var-btn">üìß Email</button>
                    <button type="button" onclick="insertVariable('{{StudentPhone}}')" class="var-btn">üì± Phone</button>
                    <button type="button" onclick="insertVariable('{{Group}}')" class="var-btn">üë• Group</button>

                    <!-- Payment Variables -->
                    <button type="button" onclick="insertVariable('{{Balance}}')" class="var-btn">üí∞ Balance</button>
                    <button type="button" onclick="insertVariable('{{PricePerClass}}')" class="var-btn">
                      üíµ Price/Class
                    </button>
                    <button type="button" onclick="insertVariable('{{Amount}}')" class="var-btn">üí≥ Amount</button>
                    <button type="button" onclick="insertVariable('{{PaymentDate}}')" class="var-btn">
                      üìÖ PaymentDate
                    </button>

                    <!-- Schedule Variables -->
                    <button type="button" onclick="insertVariable('{{ClassDate}}')" class="var-btn">
                      üóìÔ∏è ClassDate
                    </button>
                    <button type="button" onclick="insertVariable('{{NextClassDate}}')" class="var-btn">
                      ‚è≠Ô∏è NextClass
                    </button>
                    <button type="button" onclick="insertVariable('{{Schedule}}')" class="var-btn">üìÜ Schedule</button>

                    <!-- Other Variables -->
                    <button type="button" onclick="insertVariable('{{Alias}}')" class="var-btn">üìõ Alias</button>
                    <button type="button" onclick="insertVariable('{{CreditAmount}}')" class="var-btn">
                      üéÅ CreditAmount
                    </button>
                  </div>

                  <!-- Editor Textarea -->
                  <div id="editorWrapper" style="position: relative">
                    <textarea
                      id="htmlBodyEditor"
                      class="form-textarea"
                      placeholder="Start typing your email content here... Use the toolbar above to format and insert variables."
                      style="
                        border-radius: 0 0 12px 12px;
                        min-height: 300px;
                        font-family: 'Courier New', monospace;
                        font-size: 13px;
                        line-height: 1.6;
                      "
                      oninput="updatePreview()"
                    ></textarea>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label" style="display: block; position: relative; padding-right: 24px">
                    Trigger Type
                    <span
                      class="info-icon"
                      data-tooltip="<strong>How this template gets sent:</strong><br><br><strong>Manual:</strong> You click 'Send' in the UI‚Äînothing automatic.<br><strong>Automated:</strong> Pair this with an automation rule so ARNOMA sends it when conditions match (e.g., payment received, class starting in 1 hour).<br><br><strong>Organizing tip:</strong> Tag all manual templates with 'Manual -' prefix and automated ones with the trigger name."
                    >
                      ‚ìò
                    </span>
                  </label>
                  <select id="templateTrigger" class="form-select" onchange="updatePreview()">
                    <option>Manual</option>
                    <option>New Student</option>
                    <option>Before Class</option>
                  </select>
                </div>
                <div class="btn-group">
                  <button type="button" class="btn-primary" onclick="saveTemplate()">üíæ Save Template</button>
                  <button type="button" class="btn-secondary" onclick="closeEditor()">Cancel</button>
                </div>
              </form>
            </div>

            <!-- RIGHT COLUMN: Live Preview -->
            <div
              style="
                background: rgba(255, 255, 255, 0.03);
                border: 2px solid rgba(102, 126, 234, 0.3);
                border-radius: 16px;
                padding: 20px;
                overflow-y: auto;
              "
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 16px;
                  padding-bottom: 12px;
                  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                "
              >
                <h3 style="margin: 0; font-size: 16px; color: #a5b4fc; display: flex; align-items: center; gap: 8px">
                  üëÅÔ∏è Live Preview
                </h3>
                <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5)">Using sample data</span>
              </div>

              <!-- Email Preview Container -->
              <div
                id="emailPreview"
                style="
                  background: #ffffff;
                  color: #000000;
                  border-radius: 12px;
                  padding: 32px;
                  min-height: 400px;
                  font-family: Arial, sans-serif;
                  line-height: 1.6;
                "
              >
                <div
                  style="
                    color: #999;
                    font-size: 13px;
                    margin-bottom: 20px;
                    padding-bottom: 16px;
                    border-bottom: 2px solid #f0f0f0;
                  "
                >
                  <strong>Subject:</strong>
                  <span id="previewSubject" style="color: #333">Your email subject will appear here...</span>
                </div>
                <div
                  id="previewBody"
                  contenteditable="true"
                  style="color: #333; outline: none; cursor: text"
                  oninput="syncPreviewToCode()"
                  onpaste="handlePreviewPaste(event)"
                  onmouseup="savePreviewSelection()"
                  onkeyup="savePreviewSelection()"
                  onfocus="savePreviewSelection()"
                  title="‚úèÔ∏è Click to edit - changes sync to code automatically"
                >
                  Start typing to see your email preview with sample student data...
                </div>
              </div>

              <!-- Editable Notice -->
              <div
                style="
                  margin-top: 12px;
                  padding: 12px 14px;
                  background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
                  border: 1.5px solid rgba(102, 126, 234, 0.4);
                  border-radius: 8px;
                  font-size: 11px;
                  color: #a5b4fc;
                "
              >
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px">
                  <span style="font-size: 16px">‚ú®</span>
                  <strong style="font-size: 12px">Synchronized Editor</strong>
                </div>
                <div style="font-size: 10px; color: rgba(167, 185, 252, 0.8); line-height: 1.5">
                  ‚Ä¢
                  <strong>Edit in preview</strong>
                  ‚Üí changes sync to code in real-time
                  <br />
                  ‚Ä¢
                  <strong>Edit in code editor</strong>
                  ‚Üí preview updates instantly
                  <br />
                  ‚Ä¢
                  <strong>Click where you want to insert</strong>
                  (preview OR code) ‚Üí then click variable/info box button
                  <br />
                  ‚Ä¢
                  <strong>Smart insertion:</strong>
                  Tracks your click position in either panel
                  <br />
                  ‚Ä¢
                  <strong>Both panels stay in sync</strong>
                  automatically
                </div>
              </div>

              <!-- Sample Data Info -->
              <div
                style="
                  margin-top: 16px;
                  padding: 12px;
                  background: rgba(102, 126, 234, 0.1);
                  border-radius: 8px;
                  font-size: 11px;
                  color: rgba(255, 255, 255, 0.7);
                "
              >
                <strong>üìã Sample Data:</strong>
                <br />
                Student: John Doe | Email: john@example.com | Phone: (555) 123-4567
                <br />
                Group: Group A - Monday 6PM | Balance: -$45.00 | Price: $40.00/class
                <br />
                Next Class: Nov 25, 2025 6:00 PM
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AUTOMATIONS MODAL -->
    <div id="automationsModal" class="modal">
      <div class="modal-overlay" onclick="closeAutomations()"></div>
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">‚öôÔ∏è Automations Manager</div>
          <button class="modal-close" onclick="closeAutomations()">√ó</button>
        </div>
        <div class="modal-body">
          <button class="btn-primary" style="width: 100%; margin-bottom: 20px" onclick="openAutomationEditor()">
            ‚ûï Create New Automation
          </button>
          <div id="automationsGrid"></div>
        </div>
      </div>
    </div>

    <!-- AUTOMATION EDITOR MODAL -->
    <div id="automationEditorModal" class="modal">
      <div class="modal-overlay" onclick="closeAutomationEditor()"></div>
      <div class="modal-card" style="max-width: 1100px">
        <div class="modal-header">
          <div class="modal-title" id="automationModalTitle">ü§ñ Create Automation</div>
          <button class="modal-close" onclick="closeAutomationEditor()">√ó</button>
        </div>
        <div class="modal-body">
          <form id="automationForm" onsubmit="return false;">
            <input type="hidden" id="automationId" value="" />

            <div class="form-group">
              <label class="form-label" style="display: block; position: relative; padding-right: 24px">
                Automation Name
                <span
                  class="info-icon"
                  data-tooltip="<strong>Shows up in:</strong> automation list, email logs, debugging traces.<br><br><strong>Format that works:</strong> '[Action] ‚Üí [Condition]'<br><br><strong>Example:</strong> 'Email late payment warning ‚Üí Balance below -$50'<br><strong>Also good:</strong> 'Send Zoom link ‚Üí 1hr before Group A class'<br><strong>Avoid:</strong> 'Automation 1' or 'Test'<br><br><strong>Why it matters:</strong> When you have 20+ automations and one breaks, a clear name = 10x faster debugging."
                >
                  ‚ìò
                </span>
              </label>
              <input
                type="text"
                id="automationName"
                class="form-input"
                placeholder="e.g., Send payment reminder before class"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" style="display: block; position: relative; padding-right: 24px">
                Description
                <span
                  class="info-icon"
                  data-tooltip="<strong>Internal notes for your future self.</strong><br><br><strong>Document:</strong><br>‚Ä¢ Why this automation exists<br>‚Ä¢ Edge cases or exceptions<br>‚Ä¢ Manual follow-ups needed<br><br><strong>Example:</strong> 'Reminder only fires if balance < 0 AND student has missed 2+ payments. Manual follow-up needed after 3 reminders.'<br><br><strong>Hidden from students‚Äî</strong>be honest and detailed."
                >
                  ‚ìò
                </span>
              </label>
              <input
                type="text"
                id="automationDescription"
                class="form-input"
                placeholder="Optional: What does this automation do?"
              />
            </div>

            <div class="form-group">
              <label class="form-label" style="display: block; position: relative; padding-right: 24px">
                üìß Email Template
                <span
                  class="info-icon"
                  data-tooltip="<strong>The actual email that gets sent</strong> when this automation fires.<br><br><strong>Before selecting:</strong><br>1. Verify the template subject matches this automation's scenario<br>2. Check that the template uses the right variables for this trigger (hover trigger options to see available data)<br><br><strong>If dropdown is empty:</strong> Go to 'Templates' tab and create your templates first, then come back here.<br><br><strong>Common mistake:</strong> Using a payment template for a class cancellation trigger‚Äîalways cross-check context."
                >
                  ‚ìò
                </span>
              </label>
              <select id="automationTemplate" class="form-select" required>
                <option value="">Select a template...</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" style="display: block; position: relative; padding-right: 24px">
                üì° Trigger Category
                <span
                  class="info-icon"
                  data-tooltip="<strong>Buckets events by data source.</strong><br><br><strong>How to choose:</strong> Think about *what changed* in ARNOMA that should fire the email.<br><br><strong>Student:</strong> Profile edits, status changes, new enrollments<br><strong>Payment:</strong> Transactions, balance updates<br><strong>Class:</strong> Schedule changes, cancellations<br><strong>Attendance:</strong> Absences, re-engagement<br><strong>Interval:</strong> Time-based (every Monday, 1hr before class)<br><br>Pick the category first, then narrow down to the specific trigger."
                >
                  ‚ìò
                </span>
              </label>
              <select id="triggerCategory" class="form-select" onchange="updateTriggerOptions()" required>
                <option value="">Select category...</option>
                <option
                  value="interval"
                  data-tooltip="‚è∞ <strong>Interval-Based Triggers</strong><br>Schedule automations based on time intervals (every N minutes, hours, days, weeks, months, or specific dates).<br><br><strong>Use for:</strong> Recurring reminders, scheduled reports, time-based notifications."
                >
                  ‚è∞ Interval-Based (Time Engine)
                </option>
                <option
                  value="system"
                  data-tooltip="üîß <strong>System Events</strong><br>Triggers based on system lifecycle events like startup, midnight rollover, timezone changes, and data refreshes.<br><br><strong>Use for:</strong> System health checks, daily resets, synchronization tasks."
                >
                  üîß System Events
                </option>
                <option
                  value="student"
                  data-tooltip="üë§ <strong>Student Lifecycle</strong><br>Fires when student data changes: new student added, profile updated, status changed, group changed, etc.<br><br><strong>Use for:</strong> Welcome emails, update confirmations, status notifications."
                >
                  üë§ Student Lifecycle
                </option>
                <option
                  value="payment"
                  data-tooltip="üí∞ <strong>Payment & Financial</strong><br>Triggers related to payments, credits, balances, and pricing changes.<br><br><strong>Use for:</strong> Payment receipts, overdue reminders, balance alerts, credit confirmations."
                >
                  üí∞ Payment & Financial
                </option>
                <option
                  value="class"
                  data-tooltip="üìÖ <strong>Class Schedule</strong><br>Fires before/after classes, when classes start/end, or when classes are canceled or rescheduled.<br><br><strong>Use for:</strong> Class reminders, Zoom links, post-class surveys, cancellation alerts."
                >
                  üìÖ Class Schedule
                </option>
                <option
                  value="attendance"
                  data-tooltip="‚úÖ <strong>Attendance & Activity</strong><br>Triggers when absences are recorded, repeated absences detected, or students are inactive.<br><br><strong>Use for:</strong> Absence confirmations, attendance warnings, re-engagement emails."
                >
                  ‚úÖ Attendance & Activity
                </option>
                <option
                  value="communication"
                  data-tooltip="üí¨ <strong>Communication & Workflow</strong><br>Manual triggers, template updates, and custom workflow events.<br><br><strong>Use for:</strong> On-demand emails, template testing, custom automation chains."
                >
                  üí¨ Communication & Workflow
                </option>
                <option
                  value="webhook"
                  data-tooltip="üîó <strong>External Webhooks</strong><br>Integrate with Supabase realtime subscriptions, database row changes, and external API events.<br><br><strong>Use for:</strong> Real-time sync, external system integration, advanced automation."
                >
                  üîó External Webhooks
                </option>
                <option
                  value="developer"
                  data-tooltip="üõ†Ô∏è <strong>Developer Extensions</strong><br>Custom events, JavaScript triggers, API endpoints, and advanced scripting capabilities.<br><br><strong>Use for:</strong> Complex automations, custom integrations, developer-defined triggers."
                >
                  üõ†Ô∏è Developer Extensions
                </option>
              </select>
            </div>

            <div class="form-group" id="triggerTypeGroup" style="display: none">
              <label class="form-label" style="display: block; position: relative; padding-right: 24px">
                Trigger Type
                <span
                  class="info-icon"
                  data-tooltip="<strong>The exact event</strong> inside the category that fires this automation.<br><br><strong>Pro tip:</strong> Hover each dropdown option to see what data it provides (StudentName, Balance, ClassDate, etc.)‚Äîyou'll need that when writing the email template.<br><br><strong>Example flow:</strong><br>1. Trigger: payment_received<br>2. Data available: {{PayerName}}, {{Amount}}, {{Date}}<br>3. Template uses: 'Thanks {{PayerName}}! We received ${{Amount}} on {{Date}}'<br><br>Always match trigger data to template variables."
                >
                  ‚ìò
                </span>
              </label>
              <select id="triggerType" class="form-select" onchange="updateTriggerParams()" required>
                <option value="">Select trigger...</option>
              </select>
            </div>

            <div id="triggerParamsContainer"></div>

            <div class="form-group">
              <label class="form-label" style="display: block; position: relative; padding-right: 24px">
                üë• Send To
                <span
                  class="info-icon"
                  data-tooltip="<strong>Who gets the email</strong> when this automation fires.<br><br><strong>Safest default:</strong> 'Triggered Student' (only the person who caused the event).<br><br><strong>All Active:</strong> Use sparingly‚Äîeveryone gets emailed, even if irrelevant to them.<br><strong>Specific Group:</strong> Good for group-level announcements (schedule changes for Group A).<br><strong>Filtered Students:</strong> Pro mode‚Äîcombine with conditions to target precisely (e.g., balance < -$100 AND 3+ absences).<br><br><strong>Common mistake:</strong> Selecting 'All Active' for a payment reminder = spam. Always filter."
                >
                  ‚ìò
                </span>
              </label>
              <select id="automationRecipients" class="form-select" onchange="updateRecipientOptions()">
                <option
                  value="all_active"
                  data-tooltip="<strong>All Active Students</strong><br>Sends email to every student with status = 'active'.<br><br><strong>Use for:</strong> System-wide announcements, general reminders, all-student updates."
                >
                  All Active Students
                </option>
                <option
                  value="specific_group"
                  data-tooltip="<strong>Specific Group</strong><br>Sends email only to students in a particular group (e.g., 'Group A').<br><br><strong>Use for:</strong> Group-specific announcements, class changes for one group."
                >
                  Specific Group
                </option>
                <option
                  value="specific_students"
                  data-tooltip="<strong>Specific Students</strong><br>Sends email to manually selected students by name.<br><br><strong>Use for:</strong> Targeted messages, individual notifications, custom recipient lists."
                >
                  Specific Students
                </option>
                <option
                  value="filtered"
                  data-tooltip="<strong>Filtered Students (Custom Conditions)</strong><br>Sends email to students matching custom filter criteria (e.g., balance < 0).<br><br><strong>Use for:</strong> Advanced targeting, conditional emails, smart segmentation."
                >
                  Filtered Students (Custom Conditions)
                </option>
                <option
                  value="triggered_student"
                  data-tooltip="<strong>Triggered Student Only</strong><br>Sends email ONLY to the student who caused the trigger to fire.<br><br><strong>Use for:</strong> Personal confirmations, individual receipts, student-specific notifications."
                >
                  Triggered Student Only
                </option>
              </select>
            </div>

            <div id="recipientOptionsContainer"></div>

            <!-- ADVANCED CONDITIONS (NEW) -->
            <div
              class="form-group"
              style="
                background: rgba(102, 126, 234, 0.08);
                padding: 16px;
                border-radius: 12px;
                border: 1.5px solid rgba(102, 126, 234, 0.2);
              "
            >
              <label class="form-label" style="display: flex; align-items: center; gap: 8px">
                ‚öôÔ∏è Advanced Conditions (Optional)
                <span style="font-size: 11px; color: rgba(255, 255, 255, 0.4); font-weight: normal">
                  (Only trigger if conditions match)
                </span>
              </label>
              <div id="conditionsContainer">
                <button
                  type="button"
                  onclick="addCondition()"
                  class="btn"
                  style="
                    width: 100%;
                    background: rgba(102, 126, 234, 0.2);
                    color: #a5b4fc;
                    border: 1.5px solid rgba(102, 126, 234, 0.4);
                    padding: 10px;
                    font-size: 13px;
                  "
                >
                  ‚ûï Add Condition
                </button>
              </div>
            </div>

            <!-- EXECUTION SETTINGS (NEW) -->
            <div
              class="form-group"
              style="
                background: rgba(118, 75, 162, 0.08);
                padding: 16px;
                border-radius: 12px;
                border: 1.5px solid rgba(118, 75, 162, 0.2);
              "
            >
              <label class="form-label" style="display: block; position: relative; padding-right: 24px">
                üéØ Execution Settings
                <span
                  class="info-icon"
                  data-tooltip="<strong>Safety controls</strong> to prevent email disasters.<br><br><strong>Run once:</strong> Each student receives this automation a maximum of 1 time, ever. Perfect for onboarding or contract signing.<br><br><strong>Rate limit:</strong> Throttle to 1 email/hour/student even if the trigger fires 10 times. Stops accidental spam.<br><br><strong>Priority:</strong> When multiple automations fire together, Urgent runs first. Use for time-sensitive messages like class cancellations.<br><br><strong>Retries:</strong> If Resend API hiccups, ARNOMA auto-retries. Set to 3-5 for critical emails, 0 for optional FYIs."
                >
                  ‚ìò
                </span>
              </label>
              <div style="display: grid; gap: 12px">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer">
                  <input type="checkbox" id="automationRunOnce" style="width: 18px; height: 18px" />
                  <span style="font-size: 13px; color: rgba(255, 255, 255, 0.8)">
                    Run only once per student (deduplicate)
                  </span>
                  <span
                    class="info-icon"
                    data-tooltip="<strong>One email per student, lifetime.</strong><br><br><strong>Perfect for:</strong> Welcome email, contract signed confirmation, graduation notice.<br><br><strong>How it works:</strong> ARNOMA tracks who already received this automation ID and skips them on future triggers, even if their profile changes 100 times."
                  >
                    ‚ìò
                  </span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer">
                  <input type="checkbox" id="automationRateLimited" style="width: 18px; height: 18px" />
                  <span style="font-size: 13px; color: rgba(255, 255, 255, 0.8)">
                    Rate limit (max 1 email per hour per student)
                  </span>
                  <span
                    class="info-icon"
                    data-tooltip="<strong>Stops spam from noisy triggers.</strong><br><br><strong>Example:</strong> If a student's balance updates 5 times in 10 minutes (payments processing), they only get 1 reminder email, not 5.<br><br><strong>When to use:</strong> Any automation that fires frequently (payment reminders, balance alerts). Disable for one-off events (welcome email)."
                  >
                    ‚ìò
                  </span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer">
                  <input type="checkbox" id="automationConfirmSend" style="width: 18px; height: 18px" />
                  <span style="font-size: 13px; color: rgba(255, 255, 255, 0.8)">
                    Require manual confirmation before sending
                  </span>
                  <span
                    class="info-icon"
                    data-tooltip="<strong>Pause & confirm every send.</strong><br><br>When a trigger fires, ARNOMA will show you the email details and ask if you want to continue. Turn this on while testing or for sensitive messages. Turn off for fully automated flows."
                  >
                    ‚ìò
                  </span>
                </label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
                  <div>
                    <label
                      style="
                        display: flex;
                        align-items: center;
                        font-size: 12px;
                        color: rgba(255, 255, 255, 0.6);
                        margin-bottom: 4px;
                      "
                    >
                      Priority
                      <span
                        class="info-icon"
                        data-tooltip="<strong>Execution order when multiple automations fire together.</strong><br><br><strong>Urgent:</strong> Class cancellations, emergencies (sent first)<br><strong>High:</strong> Payment due, absences (sent second)<br><strong>Normal:</strong> Receipts, updates (default)<br><strong>Low:</strong> Newsletters, FYI notices (sent last)<br><br>Only matters if 2+ automations trigger at the exact same moment."
                      >
                        ‚ìò
                      </span>
                    </label>
                    <select id="automationPriority" class="form-select" style="font-size: 13px">
                      <option
                        value="low"
                        data-tooltip="<strong>Low Priority</strong><br>Non-urgent updates and optional notifications.<br><br><strong>Use for:</strong> Weekly summaries, optional announcements, background tasks."
                      >
                        Low
                      </option>
                      <option
                        value="normal"
                        selected
                        data-tooltip="<strong>Normal Priority</strong><br>Standard email notifications with regular importance.<br><br><strong>Use for:</strong> Payment receipts, profile updates, routine reminders."
                      >
                        Normal
                      </option>
                      <option
                        value="high"
                        data-tooltip="<strong>High Priority</strong><br>Important alerts that need attention but aren't critical.<br><br><strong>Use for:</strong> Payment overdue notices, class reminders, schedule changes."
                      >
                        High
                      </option>
                      <option
                        value="urgent"
                        data-tooltip="<strong>Urgent Priority</strong><br>Critical messages requiring immediate attention.<br><br><strong>Use for:</strong> Class cancellations, emergency announcements, system alerts."
                      >
                        Urgent
                      </option>
                    </select>
                  </div>
                  <div>
                    <label
                      style="
                        display: flex;
                        align-items: center;
                        font-size: 12px;
                        color: rgba(255, 255, 255, 0.6);
                        margin-bottom: 4px;
                      "
                    >
                      Max Retries
                      <span
                        class="info-icon"
                        data-tooltip="<strong>Auto-retry if email API fails.</strong><br><br><strong>How it works:</strong> If Resend returns a 500 error or timeout, ARNOMA waits 30 seconds and tries again, up to this many times.<br><br><strong>Recommendations:</strong><br>‚Ä¢ Payment receipts / cancellations: 5 retries<br>‚Ä¢ Welcome emails: 3 retries<br>‚Ä¢ Optional newsletters: 0-1 retries<br><br><strong>Why limit?</strong> Prevents infinite loops if the template itself is broken."
                      >
                        ‚ìò
                      </span>
                    </label>
                    <input
                      type="number"
                      id="automationMaxRetries"
                      class="form-input"
                      value="3"
                      min="0"
                      max="10"
                      style="font-size: 13px"
                    />
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 12px; cursor: pointer">
                <input type="checkbox" id="automationActive" checked style="width: 20px; height: 20px" />
                <span class="form-label" style="margin: 0">‚úÖ Active (automation will run automatically)</span>
              </label>
            </div>

            <div class="btn-group">
              <button type="button" class="btn-primary" onclick="saveAutomation()">üíæ Save Automation</button>
              <button type="button" class="btn-secondary" onclick="closeAutomationEditor()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- EMAIL PREVIEW MODAL -->
    <div id="previewModal" class="modal">
      <div class="modal-overlay" onclick="closePreview()"></div>
      <div class="modal-card" style="max-width: 900px">
        <div class="modal-header">
          <div class="modal-title">üëÅÔ∏è Email Preview</div>
          <button class="modal-close" onclick="closePreview()">√ó</button>
        </div>
        <div class="modal-body" style="padding: 0">
          <iframe id="previewFrame" title="Email Preview" style="width: 100%; height: 60vh; border: none"></iframe>

          <!-- Send Test Email Section (UPGRADED - Persistent Multi-Email Support) -->
          <div
            style="
              padding: 24px;
              border-top: 1px solid rgba(255, 255, 255, 0.1);
              background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            "
          >
            <h4
              style="
                margin: 0 0 16px 0;
                font-size: 14px;
                font-weight: 600;
                color: rgba(255, 255, 255, 0.9);
                display: flex;
                align-items: center;
                gap: 8px;
              "
            >
              üì® Send Test Email
              <span style="font-size: 11px; font-weight: normal; color: rgba(255, 255, 255, 0.4)">
                (Saved addresses)
              </span>
            </h4>

            <!-- Saved Email List -->
            <div
              id="testEmailList"
              style="
                max-height: 200px;
                overflow-y: auto;
                margin-bottom: 16px;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 12px;
                padding: 8px;
              "
            >
              <!-- Emails render here dynamically -->
            </div>

            <!-- Add New Email -->
            <div style="display: flex; gap: 10px; margin-bottom: 16px">
              <input
                type="email"
                id="newTestEmail"
                class="form-input"
                placeholder="Add new test email address..."
                style="flex: 1; margin: 0; font-size: 13px"
                onkeypress="if(event.key==='Enter') addNewTestEmail()"
              />
              <button
                onclick="addNewTestEmail()"
                class="btn"
                style="
                  background: rgba(102, 126, 234, 0.2);
                  color: #a5b4fc;
                  border: 1.5px solid rgba(102, 126, 234, 0.4);
                  padding: 10px 20px;
                  white-space: nowrap;
                  margin: 0;
                "
              >
                ‚ûï Add
              </button>
            </div>

            <!-- Send Button -->
            <button
              onclick="sendTestEmail()"
              class="btn-primary"
              style="width: 100%; padding: 14px; font-size: 14px; font-weight: 600; margin: 0"
            >
              üì® Send Test to All Saved Emails
            </button>
            <p style="margin: 10px 0 0 0; font-size: 11px; color: rgba(255, 255, 255, 0.5); text-align: center">
              ‚ö° Sends preview with sample data to all saved addresses
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Notification Modal -->
    <div id="customNotificationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100000; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(var(--panel-blur)); align-items: center; justify-content: center;">
      <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)); backdrop-filter: blur(var(--card-blur)); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 20px; padding: 32px 40px; max-width: 480px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); animation: slideIn 0.3s ease;">
        <div id="customNotificationIcon" style="font-size: 48px; text-align: center; margin-bottom: 16px;">‚úÖ</div>
        <div id="customNotificationMessage" style="color: rgba(255, 255, 255, 0.95); font-size: 16px; text-align: center; line-height: 1.6; margin-bottom: 24px;"></div>
        <button onclick="closeCustomNotification()" style="width: 100%; padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
          Close
        </button>
      </div>
    </div>

    <style>
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // Custom notification system
      function showCustomNotification(message, type = 'success') {
        const modal = document.getElementById('customNotificationModal');
        const icon = document.getElementById('customNotificationIcon');
        const messageEl = document.getElementById('customNotificationMessage');
        
        // Set icon based on type
        const icons = {
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è'
        };
        
        icon.textContent = icons[type] || icons.success;
        messageEl.textContent = message;
        modal.style.display = 'flex';
      }
      
      function closeCustomNotification() {
        document.getElementById('customNotificationModal').style.display = 'none';
      }

      const dialogIcons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è',
      };

      function showDesignDialog({
        title = 'Heads up',
        message = '',
        type = 'info',
        confirmText = 'Got it',
        cancelText = 'Cancel',
        confirmVariant = 'primary',
        showCancel = false,
      }) {
        return new Promise(resolve => {
          const overlay = document.createElement('div');
          overlay.className = 'design-dialog-overlay';

          const iconClass = `is-${type}`;
          const icon = dialogIcons[type] || dialogIcons.info;

          overlay.innerHTML = `
            <div class="design-dialog">
              <div class="design-dialog-icon ${iconClass}">${icon}</div>
              <div class="design-dialog-title">${title}</div>
              <div class="design-dialog-message">${message}</div>
              <div class="design-dialog-actions">
                ${showCancel ? `<button class="design-dialog-btn secondary" data-role="cancel">${cancelText}</button>` : ''}
                <button class="design-dialog-btn ${confirmVariant}" data-role="confirm">${confirmText}</button>
              </div>
            </div>
          `;

          function cleanup(result) {
            overlay.remove();
            document.removeEventListener('keydown', handleKeyDown);
            resolve(result);
          }

          function handleKeyDown(event) {
            if (event.key === 'Escape' && showCancel) {
              cleanup(false);
            }
            if (event.key === 'Enter') {
              cleanup(true);
            }
          }

          overlay.addEventListener('click', event => {
            if (event.target === overlay && showCancel) {
              cleanup(false);
            }
          });

          const confirmBtn = overlay.querySelector('[data-role="confirm"]');
          confirmBtn.addEventListener('click', () => cleanup(true));

          if (showCancel) {
            const cancelBtn = overlay.querySelector('[data-role="cancel"]');
            cancelBtn.addEventListener('click', () => cleanup(false));
          }

          document.addEventListener('keydown', handleKeyDown);
          document.body.appendChild(overlay);
          setTimeout(() => confirmBtn?.focus(), 50);
        });
      }

      function showDesignAlert(message, options = {}) {
        const opts = typeof options === 'object' ? options : {};
        return showDesignDialog({
          title: opts.title || 'Heads up',
          message,
          type: opts.type || 'info',
          confirmText: opts.confirmText || 'Got it',
          confirmVariant: opts.confirmVariant || 'primary',
          showCancel: false,
        });
      }

      function showDesignConfirm(options = {}) {
        const opts = typeof options === 'string' ? { message: options } : options;
        return showDesignDialog({
          title: opts.title || 'Are you sure?',
          message: opts.message || '',
          type: opts.type || 'warning',
          confirmText: opts.confirmText || 'Confirm',
          cancelText: opts.cancelText || 'Cancel',
          confirmVariant: opts.confirmVariant || 'primary',
          showCancel: true,
        });
      }

      // ============================================================
      // SUPABASE CLIENT INITIALIZATION
      // ============================================================
      const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';

      let supabase = null;
      
      // ============================================================
      // ‚ö° PERFORMANCE UTILITIES
      // ============================================================
      
      // Production mode - set to false to disable debug logging
      const DEBUG_MODE = false;
      
      // Debug logging wrapper (only logs when DEBUG_MODE is true)
      function debugLog(...args) {
        if (DEBUG_MODE) debugLog(...args);
      }
      
      // DOM Cache
      const DOMCache = {
        templatesGrid: null,
        sentEmailsGrid: null,
        
        init() {
          this.templatesGrid = document.getElementById('templatesGrid');
          this.sentEmailsGrid = document.getElementById('sentEmailsGrid');
          debugLog('‚úÖ Email System DOM Cache initialized');
        },
        
        get(key) {
          return this[key] || document.getElementById(key);
        }
      };
      
      // Data Cache
      const DataCache = {
        templates: null,
        sentEmails: null,
        lastFetch: {},
        TTL: 5 * 60 * 1000,
        
        set(key, value) {
          this[key] = value;
          this.lastFetch[key] = Date.now();
        },
        
        get(key) {
          const age = Date.now() - (this.lastFetch[key] || 0);
          if (age > this.TTL) {
            this[key] = null;
            delete this.lastFetch[key];
            return null;
          }
          return this[key];
        }
      };

      // Initialize Supabase client
      if (window.supabase && window.supabase.createClient) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        debugLog('‚úÖ Supabase client initialized');
        
        // Verify session on load
        supabase.auth.getSession().then(({ data: { session } }) => {
          if (session) {
            debugLog('‚úÖ User session active:', session.user.email);
          } else {
            debugLog('‚ö†Ô∏è No active session - user may need to login');
          }
        });
      } else {
        console.error('‚ùå Supabase library not loaded');
      }

      // ============================================================
      // TEST EMAIL ADDRESS MANAGER (PERSISTENT STORAGE)
      // ============================================================
      const TestEmailManager = {
        emails: [],
        editingId: null,

        // Load all test emails from Supabase
        async loadEmails() {
          if (!supabase) {
            console.error('‚ùå Supabase not initialized');
            return [];
          }

          try {
            const { data, error } = await supabase
              .from('test_email_addresses')
              .select('*')
              .order('created_at', { ascending: true });

            if (error) throw error;

            this.emails = data || [];
            debugLog(`‚úÖ Loaded ${this.emails.length} test emails from Supabase`);
            return this.emails;
          } catch (error) {
            console.error('‚ùå Error loading test emails:', error);
            return [];
          }
        },

        // Add new test email
        async addEmail(email) {
          if (!supabase) return null;

          // Validate email
          if (!this.validateEmail(email)) {
            showDesignAlert('‚ùå Invalid email format', { type: 'error', title: 'Invalid Email' });
            return null;
          }

          try {
            const { data, error } = await supabase
              .from('test_email_addresses')
              .insert([{ email: email.trim().toLowerCase() }])
              .select()
              .single();

            if (error) throw error;

            debugLog('‚úÖ Test email added:', email);
            await this.loadEmails();
            await this.renderEmailList();
            return data;
          } catch (error) {
            console.error('‚ùå Error adding test email:', error);
            showDesignAlert(`‚ùå Error adding email: ${error.message}`, { type: 'error', title: 'Add Failed' });
            return null;
          }
        },

        // Update existing test email
        async updateEmail(id, newEmail) {
          if (!supabase) return null;

          // Validate email
          if (!this.validateEmail(newEmail)) {
            showDesignAlert('‚ùå Invalid email format', { type: 'error', title: 'Invalid Email' });
            return null;
          }

          try {
            const { data, error } = await supabase
              .from('test_email_addresses')
              .update({ email: newEmail.trim().toLowerCase() })
              .eq('id', id)
              .select()
              .single();

            if (error) throw error;

            debugLog('‚úÖ Test email updated:', newEmail);
            await this.loadEmails();
            await this.renderEmailList();
            return data;
          } catch (error) {
            console.error('‚ùå Error updating test email:', error);
            showDesignAlert(`‚ùå Error updating email: ${error.message}`, { type: 'error', title: 'Update Failed' });
            return null;
          }
        },

        // Delete test email
        async deleteEmail(id) {
          if (!supabase) return false;

          const confirmed = await showDesignConfirm({
            title: 'Delete test email?',
            message: 'This email will be removed from your saved list.',
            confirmText: 'Delete',
            confirmVariant: 'danger',
          });

          if (!confirmed) {
            return false;
          }

          try {
            const { error } = await supabase.from('test_email_addresses').delete().eq('id', id);

            if (error) throw error;

            debugLog('‚úÖ Test email deleted');
            await this.loadEmails();
            await this.renderEmailList();
            return true;
          } catch (error) {
            console.error('‚ùå Error deleting test email:', error);
            showDesignAlert(`‚ùå Error deleting email: ${error.message}`, { type: 'error', title: 'Delete Failed' });
            return false;
          }
        },

        // Validate email format
        validateEmail(email) {
          const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return re.test(email);
        },

        // Render email list in modal
        async renderEmailList() {
          const container = document.getElementById('testEmailList');
          if (!container) return;

          if (this.emails.length === 0) {
            container.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.4); font-size: 13px;">
                            üì≠ No test emails saved yet. Add one below!
                        </div>
                    `;
            return;
          }

          container.innerHTML = this.emails
            .map(item => {
              const isEditing = this.editingId === item.id;

              if (isEditing) {
                return `
                            <div class="test-email-item" style="background: rgba(102,126,234,0.15); border: 1.5px solid rgba(102,126,234,0.4);">
                                <input
                                    type="email"
                                    id="edit_${item.id}"
                                    value="${item.email}"
                                    class="form-input"
                                    style="flex: 1; margin: 0; font-size: 13px;"
                                    onkeypress="if(event.key==='Enter') TestEmailManager.saveEdit('${item.id}')"
                                >
                                <button onclick="TestEmailManager.saveEdit('${item.id}')" class="icon-btn save-btn" title="Save">
                                    üíæ
                                </button>
                                <button onclick="TestEmailManager.cancelEdit()" class="icon-btn cancel-btn" title="Cancel">
                                    ‚ùå
                                </button>
                            </div>
                        `;
              }

              return `
                        <div class="test-email-item">
                            <span class="email-text">${item.email}</span>
                            <div class="email-actions">
                                <button onclick="TestEmailManager.startEdit('${item.id}')" class="icon-btn edit-btn" title="Edit">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="TestEmailManager.deleteEmail('${item.id}')" class="icon-btn delete-btn" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
            })
            .join('');
        },

        // Start editing an email
        startEdit(id) {
          this.editingId = id;
          this.renderEmailList();
          setTimeout(() => {
            const input = document.getElementById(`edit_${id}`);
            if (input) {
              input.focus();
              input.select();
            }
          }, 50);
        },

        // Save edited email
        async saveEdit(id) {
          const input = document.getElementById(`edit_${id}`);
          if (!input) return;

          const newEmail = input.value.trim();
          if (!newEmail) {
            showDesignAlert('‚ùå Email cannot be empty', { type: 'warning', title: 'Missing Email' });
            return;
          }

          await this.updateEmail(id, newEmail);
          this.editingId = null;
        },

        // Cancel editing
        cancelEdit() {
          this.editingId = null;
          this.renderEmailList();
        },

        // Get all emails for sending
        getAllEmails() {
          return this.emails.map(item => item.email);
        },
      };

      // ============================================================
      // TEMPLATE MANAGEMENT SYSTEM (SUPABASE STORAGE)
      // ============================================================
      const TemplateManager = {
        templates: [],

        // Load all templates from Supabase
        async loadTemplates() {
          if (!supabase) {
            console.error('‚ùå Supabase not initialized');
            return [];
          }

          try {
            const { data, error } = await supabase
              .from('email_templates')
              .select('*')
              .order('created_at', { ascending: false });

            if (error) throw error;

            this.templates = data || [];
            debugLog(`‚úÖ Loaded ${this.templates.length} templates from Supabase`);
            return this.templates;
          } catch (error) {
            console.error('‚ùå Error loading templates:', error);
            return [];
          }
        },

        // Save template to Supabase
        async saveTemplate(template) {
          if (!supabase) {
            console.error('‚ùå Supabase not initialized');
            return null;
          }

          try {
            const { data, error } = await supabase
              .from('email_templates')
              .insert([
                {
                  name: template.name,
                  subject: template.subject,
                  body_html: template.body_html,
                  trigger_category: template.trigger_category,
                  trigger_type: template.trigger_type,
                  created_at: new Date().toISOString(),
                  updated_at: new Date().toISOString(),
                },
              ])
              .select()
              .single();

            if (error) throw error;

            debugLog('‚úÖ Template saved:', data.name);
            this.templates.push(data);
            return data;
          } catch (error) {
            console.error('‚ùå Error saving template:', error);
            return null;
          }
        },

        // Update existing template
        async updateTemplate(id, updates) {
          if (!supabase) return null;

          try {
            const { data, error } = await supabase
              .from('email_templates')
              .update({
                ...updates,
                updated_at: new Date().toISOString(),
              })
              .eq('id', id)
              .select()
              .single();

            if (error) throw error;

            // Update local cache
            const index = this.templates.findIndex(t => t.id === id);
            if (index !== -1) {
              this.templates[index] = data;
            }

            debugLog('‚úÖ Template updated:', data.name);
            return data;
          } catch (error) {
            console.error('‚ùå Error updating template:', error);
            return null;
          }
        },

        // Get template by ID
        getTemplate(id) {
          return this.templates.find(t => t.id === id);
        },

        // Get template by name
        getTemplateByName(name) {
          return this.templates.find(t => t.name === name);
        },

        // Initialize production templates from test emails
        async initializeProductionTemplates() {
          debugLog('üîß Initializing production templates from test emails...');

          // ARNOMA signature block (used in all templates)
          const arnomaSignature = `
                    <div style="margin-top: 40px; padding-top: 24px; border-top: 2px solid rgba(102,126,234,0.2);">
                        <p style="margin: 8px 0;">Best regards,</p>
                        <p style="margin: 8px 0; font-weight: 600; color: #667eea;">ARNOMA Team</p>
                        <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08)); border-radius: 12px; border: 1px solid rgba(102,126,234,0.2);">
                            <p style="margin: 6px 0; font-size: 13px; color: #6b7280;">
                                üìß <strong>Email:</strong> <a href="mailto:{{TeacherEmail}}" style="color: #667eea; text-decoration: none;">{{TeacherEmail}}</a>
                            </p>
                            <p style="margin: 6px 0; font-size: 13px; color: #6b7280;">
                                üë®‚Äçüè´ <strong>Teacher:</strong> {{TeacherName}}
                            </p>
                            <p style="margin: 12px 0 6px 0; font-size: 12px; color: #9ca3af;">
                                <em>This email was sent automatically from ARNOMA Student Management System</em>
                            </p>
                        </div>
                    </div>
                `;

          const productionTemplates = [
            {
              name: 'Profile Update',
              subject: 'Your Profile Has Been Updated',
              trigger_category: 'student',
              trigger_type: 'student_profile_updated',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0;">Profile Successfully Updated</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Your ARNOMA student profile has been updated with the following changes:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>üìß Email:</strong> {{StudentEmail}}</p>
                                <p style="margin: 8px 0;"><strong>üì± Phone:</strong> {{StudentPhone}}</p>
                                <p style="margin: 8px 0;"><strong>üë• Group:</strong> {{Group}}</p>
                                <p style="margin: 8px 0;"><strong>üíµ Price per Class:</strong> $\{{PricePerClass}}</p>
                            </div>

                            <p>If you didn't request these changes or notice any errors, please contact us immediately.</p>
                            <p style="margin-top: 24px;">Thank you for being part of ARNOMA! üéì</p>
                            ${arnomaSignature}
                        `,
            },
            {
              name: 'Alias Added',
              subject: 'New Payment Alias Added to Your Account',
              trigger_category: 'student',
              trigger_type: 'student_alias_added',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0;">New Payment Alias Added</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>A new payment alias has been added to your account to help us identify your payments automatically:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0; text-align: center; font-size: 20px;"><strong>üìõ "{{Alias}}"</strong></p>
                            </div>

                            <p>When sending payments via Zelle or other services, using <strong>"{{Alias}}"</strong> will help us match your payment to your account instantly.</p>
                            <p style="margin-top: 24px; font-size: 14px; color: #6b7280;">üí° <em>Tip: You can still use "{{StudentName}}" ‚Äî all your aliases work!</em></p>
                            ${arnomaSignature}
                        `,
            },
            {
              name: 'Schedule Update',
              subject: 'Your Class Schedule Has Changed',
              trigger_category: 'student',
              trigger_type: 'student_schedule_changed',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0;">Your Class Schedule Has Changed</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Your class schedule has been updated. Here's your new schedule:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>üìÜ New Schedule</strong></p>
                                <p style="margin: 8px 0; font-size: 18px;"><strong>{{NewSchedule}}</strong></p>
                                <p style="margin: 8px 0; color: #6b7280;">(Los Angeles Time)</p>
                            </div>

                            <p><strong>üìç Next Class:</strong> {{NextClassDate}}</p>
                            <p>If you have any questions about the schedule change, please don't hesitate to reach out!</p>
                            ${arnomaSignature}
                        `,
            },
            {
              name: 'Group Enrollment',
              subject: 'Welcome to Your New Group!',
              trigger_category: 'student',
              trigger_type: 'student_group_changed',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0;">Welcome to Your New Group!</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Congratulations! You've been enrolled in a new group:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0; font-size: 20px;"><strong>üéì {{NewGroup}}</strong></p>
                                <p style="margin: 8px 0; font-size: 16px;"><strong>{{NewSchedule}}</strong></p>
                                <p style="margin: 8px 0; color: #6b7280;">(Los Angeles Time)</p>
                            </div>

                            <p><strong>üöÄ First Class:</strong> {{NextClassDate}}</p>
                            <p><strong>üíµ Price per Class:</strong> $\{{PricePerClass}}</p>
                            <p style="margin-top: 24px;">We're excited to have you in this group! See you in class! üéâ</p>
                            ${arnomaSignature}
                        `,
            },
            {
              name: 'Credit Added',
              subject: 'Credit Added to Your Account',
              trigger_category: 'payment',
              trigger_type: 'payment_credit_added',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0;">Credit Added to Your Account</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>A credit has been added to your ARNOMA account balance:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>Credit Amount:</strong> +$\{{CreditAmount}}</p>
                                <p style="margin: 8px 0;"><strong>Added on:</strong> {{Date}}</p>
                                <p style="margin: 8px 0;"><strong>üìù Note:</strong> {{Notes}}</p>
                            </div>

                            <p>This credit will be automatically applied to future classes. Thank you for your continued participation!</p>
                            ${arnomaSignature}
                        `,
            },
            {
              name: 'Credit Applied',
              subject: 'Credit Applied to Class',
              trigger_category: 'payment',
              trigger_type: 'payment_credit_used',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0;">Credit Applied Successfully</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>A credit has been applied to one of your classes:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>üìÖ Class Date:</strong> {{ClassDate}}</p>
                                <p style="margin: 8px 0;"><strong>üíµ Credit Amount:</strong> $\{{CreditAmount}}</p>
                                <p style="margin: 8px 0;"><strong>üí≥ Payment Status:</strong> <span style="color: #10b981; font-weight: 600;">PAID</span></p>
                            </div>

                            <p>This class is now marked as paid using your account credit. No payment action required!</p>
                            <p style="margin-top: 24px; font-size: 14px; color: #6b7280;">üìä Check your student portal for updated balance information.</p>
                            ${arnomaSignature}
                        `,
            },
            {
              name: 'Credit Edit',
              subject: 'Credit Payment Updated',
              trigger_category: 'payment',
              trigger_type: 'payment_credit_edited',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0;">Credit Payment Modified</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>A credit payment on your account has been updated:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>Class Date:</strong> {{ClassDate}}</p>
                                <p style="margin: 8px 0;"><strong>Previous Amount:</strong> <s>$\{{OldAmount}}</s></p>
                                <p style="margin: 8px 0;"><strong>New Amount:</strong> $\{{CreditAmount}}</p>
                                <p style="margin: 8px 0;"><strong>Updated Note:</strong> {{Notes}}</p>
                            </div>

                            <p>Your account balance and payment history have been updated accordingly.</p>
                            ${arnomaSignature}
                        `,
            },
            {
              name: 'Status: Paused',
              subject: 'Your Account Has Been Paused',
              trigger_category: 'student',
              trigger_type: 'student_status_changed',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0;">Your Account Has Been Paused</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Your ARNOMA student account status has been changed to <strong>Paused</strong> effective {{Date}}.</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>What this means:</strong></p>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    <li>You won't be charged for upcoming classes</li>
                                    <li>Your spot in the group is temporarily on hold</li>
                                    <li>You can resume anytime by contacting us</li>
                                </ul>
                            </div>

                            <p style="margin-top: 24px;">When you're ready to return, just let us know! We'll be happy to have you back. üíú</p>
                            ${arnomaSignature}
                        `,
            },
            {
              name: 'Status: Active',
              subject: "Welcome Back! You're Active Again",
              trigger_category: 'student',
              trigger_type: 'student_status_changed',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0;">Welcome Back! You're Active Again</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Great news! Your ARNOMA student account has been reactivated effective {{Date}}.</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>Your Current Schedule:</strong></p>
                                <p style="margin: 8px 0; font-size: 16px;"><strong>üìÜ {{Schedule}}</strong></p>
                                <p style="margin: 8px 0; color: #6b7280;">(Los Angeles Time)</p>
                                <p style="margin: 12px 0 8px 0;"><strong>üìç Next Class:</strong> {{NextClassDate}}</p>
                            </div>

                            <p style="margin-top: 24px;">We're so happy to have you back! See you in class! üéâ</p>
                            ${arnomaSignature}
                        `,
            },
            {
              name: 'Status: Graduated',
              subject: 'Congratulations Graduate!',
              trigger_category: 'student',
              trigger_type: 'student_status_changed',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0; text-align: center;">üéì You've Graduated! üéâ</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Congratulations! Your ARNOMA student status has been updated to <strong>Graduated</strong> as of {{Date}}.</p>

                            <p style="text-align: center; font-size: 48px; margin: 24px 0;">üéì</p>

                            <p>Thank you for being part of the ARNOMA family! We're incredibly proud of your progress and achievements.</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>What's next?</strong></p>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    <li>Your account will remain in our system for records</li>
                                    <li>You're always welcome to return for advanced classes</li>
                                    <li>Stay in touch ‚Äî we'd love to hear from you!</li>
                                </ul>
                            </div>

                            <p style="margin-top: 32px; text-align: center; font-size: 18px; font-weight: 600;">Best wishes on your journey! üåü</p>
                            ${arnomaSignature}
                        `,
            },
            {
              name: 'Absence Marked',
              subject: 'Absence Recorded for Your Class',
              trigger_category: 'attendance',
              trigger_type: 'absence_recorded',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0;">Absence Marked for Class</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>We've recorded an absence for your class:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>üìÖ Class Date:</strong> {{ClassDate}}</p>
                                <p style="margin: 8px 0;"><strong>üïê Time:</strong> {{ClassTime}} (Los Angeles Time)</p>
                                <p style="margin: 8px 0;"><strong>üìä Status:</strong> <span style="color: #ef4444; font-weight: 600;">ABSENT</span></p>
                            </div>

                            <p><strong>üí° What happens next?</strong></p>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                <li>This absence is now recorded in your attendance history</li>
                                <li>If you pre-paid for this class, no refund is issued per policy</li>
                                <li>Contact us if you'd like to discuss makeup options</li>
                            </ul>

                            <p style="margin-top: 24px;">We hope to see you at the next class! üòä</p>
                            ${arnomaSignature}
                        `,
            },
            {
              name: 'Schedule Change',
              subject: 'Important: Schedule Change Alert',
              trigger_category: 'class',
              trigger_type: 'class_rescheduled',
              body_html: `
                            <h2 style="color: #667eea; margin-top: 0;">‚ö†Ô∏è Urgent Schedule Update</h2>
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p><strong>Important:</strong> Your class schedule has been modified. Please review the changes below:</p>

                            <div style="border: 3px solid #ef4444; background: rgba(254,226,226,0.2); border-radius: 16px; padding: 18px; margin: 20px 0;">
                                <p style="margin: 8px 0; color: #ef4444;"><strong>üîÑ Old Schedule</strong></p>
                                <p style="margin: 8px 0; color: #ef4444; text-decoration: line-through;">{{OldSchedule}}</p>
                            </div>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>‚ú® New Schedule</strong></p>
                                <p style="margin: 8px 0; font-size: 18px;"><strong>{{NewSchedule}}</strong></p>
                                <p style="margin: 8px 0; color: #6b7280;">(Los Angeles Time)</p>
                            </div>

                            <p><strong>üìç First Class on New Schedule:</strong> {{NextClassDate}}</p>
                            <p><strong>üìß Questions?</strong> Please reply to this email or contact us directly.</p>

                            <p style="margin-top: 24px;">Thank you for your flexibility! üôè</p>
                            ${arnomaSignature}
                        `,
            },
          ];

          // Check if templates already exist
          for (const template of productionTemplates) {
            const existing = this.getTemplateByName(template.name);
            if (!existing) {
              await this.saveTemplate(template);
            } else {
              debugLog(`‚è≠Ô∏è Template "${template.name}" already exists, skipping`);
            }
          }

          debugLog('‚úÖ Production templates initialized');
        },
      };

      // ============================================================
      // UNIVERSAL TOOLTIP ENGINE (‚ìò INFO ICONS)
      // ============================================================
      const TooltipEngine = {
        currentTooltip: null,
        overlay: null,
        hoverTimer: null,
        activeIcon: null,
        dropdownTooltip: null,

        init() {
          debugLog('üöÄ TooltipEngine.init() CALLED - Starting initialization...');

          // Create overlay
          const overlay = document.createElement('div');
          overlay.className = 'tooltip-overlay';
          overlay.id = 'tooltipOverlay';
          overlay.addEventListener('click', () => this.hide());
          document.body.appendChild(overlay);
          this.overlay = overlay;
          debugLog('‚úÖ Tooltip overlay created');

          // Create main tooltip element (for info icons)
          const tooltip = document.createElement('div');
          tooltip.className = 'tooltip';
          tooltip.id = 'universalTooltip';

          // Add close button
          const closeBtn = document.createElement('div');
          closeBtn.className = 'tooltip-close';
          closeBtn.innerHTML = '‚úï';
          closeBtn.addEventListener('click', () => this.hide());
          tooltip.appendChild(closeBtn);

          // Add content container
          const contentDiv = document.createElement('div');
          contentDiv.className = 'tooltip-content';
          tooltip.appendChild(contentDiv);

          document.body.appendChild(tooltip);
          this.currentTooltip = tooltip;
          debugLog('‚úÖ Main tooltip element created with close button');

          // Create dropdown tooltip element (for dropdown options)
          const dropdownTooltip = document.createElement('div');
          dropdownTooltip.className = 'tooltip dropdown-tooltip';
          dropdownTooltip.id = 'dropdownTooltip';

          const dropdownCloseBtn = document.createElement('div');
          dropdownCloseBtn.className = 'tooltip-close';
          dropdownCloseBtn.innerHTML = '‚úï';
          dropdownCloseBtn.addEventListener('click', () => this.hideDropdown());
          dropdownTooltip.appendChild(dropdownCloseBtn);

          const dropdownContentDiv = document.createElement('div');
          dropdownContentDiv.className = 'tooltip-content';
          dropdownTooltip.appendChild(dropdownContentDiv);

          document.body.appendChild(dropdownTooltip);
          this.dropdownTooltip = dropdownTooltip;
          debugLog('‚úÖ Dropdown tooltip element created with close button');

          // Click on info icon to show tooltip
          document.body.addEventListener('click', e => {
            const icon = e.target.closest('.info-icon');
            if (icon) {
              e.stopPropagation();
              debugLog('üîµ CLICK detected on info-icon!', icon);
              const tooltipText = icon.getAttribute('data-tooltip');
              if (tooltipText) {
                this.show(icon, tooltipText);
              }
            }
          });

          debugLog('‚úÖ Event listeners attached - click info icon to show popup');

          // Listen for dropdown option hover (kept for dropdowns)
          document.addEventListener(
            'mouseover',
            e => {
              if (e.target.tagName === 'OPTION' && e.target.hasAttribute('data-tooltip')) {
                this.handleDropdownEnter(e.target);
              }
            },
            true
          );

          document.addEventListener(
            'mouseout',
            e => {
              if (e.target.tagName === 'OPTION' && e.target.hasAttribute('data-tooltip')) {
                this.handleDropdownLeave();
              }
            },
            true
          );

          debugLog('‚ú® Tooltip popup system initialized');
          debugLog('üìä Info icons currently in DOM:', document.querySelectorAll('.info-icon').length);
        },

        handleDropdownEnter(option) {
          const tooltipText = option.getAttribute('data-tooltip');
          if (!tooltipText) return;

          // Clear any existing timer
          if (this.hoverTimer) {
            clearTimeout(this.hoverTimer);
          }

          // Show dropdown tooltip with shorter delay (200ms)
          this.hoverTimer = setTimeout(() => {
            this.showDropdown(option, tooltipText);
          }, 200);
        },

        handleDropdownLeave() {
          // Clear timer
          if (this.hoverTimer) {
            clearTimeout(this.hoverTimer);
            this.hoverTimer = null;
          }

          // Hide dropdown tooltip
          this.hideDropdown();
        },

        show(icon, text) {
          debugLog('üìç SHOW METHOD CALLED (Modal Popup):', {
            text: text.substring(0, 50) + '...',
            hasOverlay: !!this.overlay,
            hasTooltip: !!this.currentTooltip,
          });

          const tooltip = this.currentTooltip;
          if (!tooltip) {
            console.error('‚ùå Tooltip element missing!');
            return;
          }

          // Set content in the content div
          const contentDiv = tooltip.querySelector('.tooltip-content');
          if (contentDiv) {
            contentDiv.innerHTML = text;
          } else {
            // Fallback if content div doesn't exist
            tooltip.innerHTML = '<div class="tooltip-close">‚úï</div>' + text;
            tooltip.querySelector('.tooltip-close').addEventListener('click', () => this.hide());
          }

          // Show overlay
          if (this.overlay) {
            this.overlay.classList.add('show');
          }

          // Show tooltip popup (centered on screen)
          tooltip.classList.add('show');

          // Prevent body scroll when popup is open
          document.body.style.overflow = 'hidden';

          debugLog('‚ú® Tooltip popup displayed (centered modal with overlay)');
        },

        hide() {
          if (this.currentTooltip) {
            this.currentTooltip.classList.remove('show');
          }
          if (this.overlay) {
            this.overlay.classList.remove('show');
          }
          // Restore body scroll
          document.body.style.overflow = '';
          this.activeIcon = null;
          debugLog('üî¥ Tooltip popup hidden');
        },

        showDropdown(option, text) {
          const tooltip = this.dropdownTooltip;

          // Set content in the content div
          const contentDiv = tooltip.querySelector('.tooltip-content');
          if (contentDiv) {
            contentDiv.innerHTML = text;
          } else {
            tooltip.innerHTML = '<div class="tooltip-close">‚úï</div>' + text;
            tooltip.querySelector('.tooltip-close').addEventListener('click', () => this.hideDropdown());
          }

          // Show overlay
          if (this.overlay) {
            this.overlay.classList.add('show');
          }

          // Show dropdown tooltip as centered popup
          tooltip.classList.add('show');

          // Prevent body scroll
          document.body.style.overflow = 'hidden';
        },

        hideDropdown() {
          if (this.dropdownTooltip) {
            this.dropdownTooltip.classList.remove('show');
          }
          if (this.overlay) {
            this.overlay.classList.remove('show');
          }
          // Restore body scroll
          document.body.style.overflow = '';
        },
      };

      // ============================================================
      // TRIGGER TOOLTIP DATABASE
      // ============================================================
      const TriggerTooltips = {
        // Interval triggers
        interval_minute:
          'Fires every N minutes continuously.<br><strong>Use for:</strong> Frequent status checks, real-time monitoring.<br><strong>Example:</strong> Check for new payments every 5 minutes.',
        interval_hour:
          'Fires every N hours throughout the day.<br><strong>Use for:</strong> Hourly digests, periodic reminders.<br><strong>Example:</strong> Send hourly payment summary.',
        interval_day:
          'Fires once daily at a specific time.<br><strong>Use for:</strong> Daily reports, morning reminders.<br><strong>Example:</strong> Send daily class schedule at 8 AM.',
        interval_week:
          'Fires once weekly on a specific day and time.<br><strong>Use for:</strong> Weekly summaries, recurring reminders.<br><strong>Example:</strong> Send weekly progress report every Monday at 9 AM.',
        interval_month:
          'Fires monthly on a specific date and time.<br><strong>Use for:</strong> Monthly reports, billing reminders.<br><strong>Example:</strong> Send monthly invoice on 1st of every month.',
        interval_specific_date:
          'Fires once at a specific future date and time.<br><strong>Use for:</strong> One-time events, scheduled announcements.<br><strong>Example:</strong> Send exam reminder on specific date.',
        before_class_timer:
          'Fires N minutes before any class starts.<br><strong>Use for:</strong> Pre-class reminders, Zoom link delivery.<br><strong>Example:</strong> Send Zoom link 30 minutes before class.',
        after_class_timer:
          'Fires N minutes after any class ends.<br><strong>Use for:</strong> Post-class surveys, homework reminders.<br><strong>Example:</strong> Send homework 15 minutes after class.',
        developer_custom_interval:
          'Fires based on custom cron expression.<br><strong>Use for:</strong> Advanced scheduling patterns.<br><strong>Example:</strong> Run every Tuesday and Thursday at 3 PM.',

        // System triggers
        system_startup:
          'Fires when the email system initializes.<br><strong>Use for:</strong> System health checks, startup notifications.<br><strong>Example:</strong> Send admin alert when system starts.',
        system_midnight_rollover:
          'Fires at midnight (LA time) every day.<br><strong>Use for:</strong> Daily resets, midnight tasks.<br><strong>Example:</strong> Send daily summary at midnight.',
        system_timezone_shift:
          'Fires when timezone changes (DST).<br><strong>Use for:</strong> Schedule adjustments, DST notifications.<br><strong>Example:</strong> Alert students about time change.',
        system_data_refresh:
          'Fires when data is synced from parent window.<br><strong>Use for:</strong> Data synchronization tasks.<br><strong>Example:</strong> Update email lists after data refresh.',

        // Student triggers
        student_added:
          'Fires when a new student is created.<br><strong>Use for:</strong> Welcome emails, onboarding.<br><strong>Example:</strong> Send welcome email with course details.',
        student_updated:
          'Fires when student profile is modified.<br><strong>Use for:</strong> Update confirmations.<br><strong>Example:</strong> Confirm email address change.',
        student_removed:
          'Fires when a student is deleted.<br><strong>Use for:</strong> Goodbye emails, exit surveys.<br><strong>Example:</strong> Send exit survey to departed student.',
        student_status_changed:
          'Fires when student status changes (active/paused/graduated).<br><strong>Use for:</strong> Status notifications.<br><strong>Example:</strong> Congratulate student on graduation.',
        student_group_changed:
          'Fires when student moves to different group.<br><strong>Use for:</strong> Schedule updates, group changes.<br><strong>Example:</strong> Send new schedule after group change.',
        student_email_changed:
          "Fires when student's email address is updated.<br><strong>Use for:</strong> Email verification.<br><strong>Example:</strong> Send confirmation to new email.",
        student_profile_updated:
          'Fires when any profile field is modified.<br><strong>Use for:</strong> General update confirmations.<br><strong>Example:</strong> Confirm profile changes.',
        student_alias_added:
          'Fires when an alias/nickname is added to student.<br><strong>Use for:</strong> Alias confirmations.<br><strong>Example:</strong> Confirm nickname added.',
        student_schedule_changed:
          "Fires when student's class schedule is modified.<br><strong>Use for:</strong> Schedule notifications.<br><strong>Example:</strong> Alert about new class times.",

        // Payment triggers
        payment_received:
          'Fires when a payment is recorded for student.<br><strong>Use for:</strong> Receipts, payment confirmations.<br><strong>Example:</strong> Send payment receipt with balance.',
        payment_missing:
          'Fires when payment is overdue by N days.<br><strong>Use for:</strong> Payment reminders.<br><strong>Example:</strong> Remind student of 3-day overdue payment.',
        payment_upcoming:
          'Fires N days before payment is due.<br><strong>Use for:</strong> Payment reminders.<br><strong>Example:</strong> Remind 2 days before class payment due.',
        payment_credit_added:
          'Fires when credit is added to student account.<br><strong>Use for:</strong> Credit confirmations.<br><strong>Example:</strong> Confirm makeup class credit added.',
        payment_credit_used:
          'Fires when student uses stored credit.<br><strong>Use for:</strong> Credit usage notifications.<br><strong>Example:</strong> Notify credit applied to class.',
        payment_credit_edited:
          'Fires when credit amount is modified.<br><strong>Use for:</strong> Credit change notifications.<br><strong>Example:</strong> Confirm credit adjustment.',
        payment_price_changed:
          "Fires when student's class price is updated.<br><strong>Use for:</strong> Price change notifications.<br><strong>Example:</strong> Alert about new pricing.",
        payment_balance_low:
          'Fires when balance drops below threshold.<br><strong>Use for:</strong> Low balance warnings.<br><strong>Example:</strong> Alert when balance below $10.',
        payment_balance_negative:
          'Fires when student has negative balance.<br><strong>Use for:</strong> Payment requests.<br><strong>Example:</strong> Request payment for negative balance.',

        // Class triggers
        before_class:
          'Fires N minutes before a class starts.<br><strong>Use for:</strong> Pre-class reminders.<br><strong>Example:</strong> Send reminder 1 hour before class.',
        after_class:
          'Fires N minutes after a class ends.<br><strong>Use for:</strong> Post-class tasks.<br><strong>Example:</strong> Send notes 10 minutes after class.',
        class_start:
          "Fires exactly when a class begins.<br><strong>Use for:</strong> Real-time notifications.<br><strong>Example:</strong> Send 'Class starting now' alert.",
        class_end:
          'Fires exactly when a class completes.<br><strong>Use for:</strong> Immediate post-class actions.<br><strong>Example:</strong> Send feedback survey.',
        class_canceled:
          'Fires when a class is canceled.<br><strong>Use for:</strong> Cancellation notifications.<br><strong>Example:</strong> Alert students of class cancellation.',
        class_rescheduled:
          'Fires when a class is moved to new date/time.<br><strong>Use for:</strong> Schedule change alerts.<br><strong>Example:</strong> Notify of rescheduled class.',
        class_upcoming_for_group:
          'Fires before class for specific group only.<br><strong>Use for:</strong> Group-specific reminders.<br><strong>Example:</strong> Remind only Group A students.',

        // Attendance triggers
        absence_recorded:
          'Fires when student absence is marked.<br><strong>Use for:</strong> Absence notifications.<br><strong>Example:</strong> Confirm absence recorded.',
        absence_repeated:
          'Fires when student has multiple absences in timeframe.<br><strong>Use for:</strong> Attendance warnings.<br><strong>Example:</strong> Alert after 3 absences in 2 weeks.',
        absence_first_time:
          "Fires on student's first-ever absence.<br><strong>Use for:</strong> First absence notifications.<br><strong>Example:</strong> Send attendance policy reminder.",
        low_activity:
          'Fires when student is inactive for N days.<br><strong>Use for:</strong> Re-engagement emails.<br><strong>Example:</strong> Check in after 7 days inactive.',
        high_activity:
          'Fires when student shows high engagement.<br><strong>Use for:</strong> Engagement recognition.<br><strong>Example:</strong> Congratulate active participation.',

        // Communication triggers
        manual_trigger:
          'Fires when manually activated by user.<br><strong>Use for:</strong> On-demand emails.<br><strong>Example:</strong> Send custom announcement.',
        template_trigger:
          'Fires when email template is updated.<br><strong>Use for:</strong> Template change notifications.<br><strong>Example:</strong> Alert when template modified.',
        custom_event:
          'Fires on custom-defined events.<br><strong>Use for:</strong> Special workflows.<br><strong>Example:</strong> Trigger on custom business logic.',

        // Webhook triggers
        supabase_row_insert:
          'Fires when row is inserted in Supabase table.<br><strong>Use for:</strong> Database triggers.<br><strong>Example:</strong> Alert on new payment record.',
        supabase_row_update:
          'Fires when row is updated in Supabase table.<br><strong>Use for:</strong> Database change detection.<br><strong>Example:</strong> Alert on student update.',
        supabase_row_delete:
          'Fires when row is deleted from Supabase table.<br><strong>Use for:</strong> Deletion notifications.<br><strong>Example:</strong> Alert on record removal.',
        supabase_function_call:
          'Fires when Supabase Edge Function is called.<br><strong>Use for:</strong> Function execution tracking.<br><strong>Example:</strong> Log function calls.',
        supabase_realtime_change:
          'Fires on Supabase realtime subscription event.<br><strong>Use for:</strong> Real-time updates.<br><strong>Example:</strong> Immediate data sync alerts.',

        // Developer triggers
        developer_custom_event:
          'Fires on developer-defined custom events.<br><strong>Use for:</strong> Custom integrations.<br><strong>Example:</strong> External API triggers.',
        developer_script:
          'Fires when custom script executes.<br><strong>Use for:</strong> Script automation.<br><strong>Example:</strong> Run after batch processing.',
        developer_api_trigger:
          'Fires when external API endpoint is hit.<br><strong>Use for:</strong> External integrations.<br><strong>Example:</strong> Webhook from third-party service.',
      };

      // ============================================================
      // CONDITION BUILDER TOOLTIP DATABASE
      // ============================================================
      const ConditionTooltips = {
        // Fields
        fields: {
          'student.name':
            "Student's full name as stored in profile.<br><strong>Use for:</strong> Name-based filtering.<br><strong>Example:</strong> Name contains 'John'",
          'student.email':
            "Student's email address.<br><strong>Use for:</strong> Email filtering or validation.<br><strong>Example:</strong> Email ends with '@gmail.com'",
          'student.phone':
            "Student's phone number.<br><strong>Use for:</strong> Contact info filtering.<br><strong>Example:</strong> Phone starts with '+374'",
          'student.status':
            "Current student status (active/paused/graduated).<br><strong>Use for:</strong> Status-based emails.<br><strong>Example:</strong> Status equals 'active'",
          'student.group_name':
            "Name of student's current group.<br><strong>Use for:</strong> Group-specific emails.<br><strong>Example:</strong> Group equals 'Advanced Python'",
          'student.balance':
            'Current account balance (positive = credit, negative = owed).<br><strong>Use for:</strong> Balance-based reminders.<br><strong>Example:</strong> Balance less than -50',
          'student.price_per_class':
            'Per-class price for this student.<br><strong>Use for:</strong> Pricing tiers.<br><strong>Example:</strong> Price greater than 30',
          'student.created_at':
            "Date student was added to system.<br><strong>Use for:</strong> Enrollment age filtering.<br><strong>Example:</strong> Created before '2024-01-01'",
          'student.notes':
            "Internal notes about student.<br><strong>Use for:</strong> Note-based filtering.<br><strong>Example:</strong> Notes contains 'needs extra help'",
          'student.showInGrid':
            'Whether student appears on calendar (true/false).<br><strong>Use for:</strong> Visibility filtering.<br><strong>Example:</strong> ShowInGrid equals true',
          'payment.amount':
            'Payment amount in dollars.<br><strong>Use for:</strong> Amount-based triggers.<br><strong>Example:</strong> Amount greater than 100',
          'payment.date':
            "Date payment was received.<br><strong>Use for:</strong> Date-based filtering.<br><strong>Example:</strong> Date after '2024-01-01'",
          'payment.payer':
            'Name of person who made payment.<br><strong>Use for:</strong> Payer filtering.<br><strong>Example:</strong> Payer not equals student name',
          'class.date':
            'Date of class.<br><strong>Use for:</strong> Scheduling logic.<br><strong>Example:</strong> Date within next 7 days',
          'class.skip_type':
            "Type of class cancellation (canceled/skipped/holiday).<br><strong>Use for:</strong> Cancellation filtering.<br><strong>Example:</strong> Skip type equals 'holiday'",
          'absence.class_date':
            'Date of absence.<br><strong>Use for:</strong> Absence date filtering.<br><strong>Example:</strong> Class date in current month',
          'credit.amount':
            'Credit amount applied.<br><strong>Use for:</strong> Credit-based logic.<br><strong>Example:</strong> Amount equals price per class',
          'system.current_date':
            "Today's date (LA timezone).<br><strong>Use for:</strong> Date comparisons.<br><strong>Example:</strong> Current date after specific date",
          'system.current_time':
            'Current time (LA timezone).<br><strong>Use for:</strong> Time-based logic.<br><strong>Example:</strong> Current time between 9 AM and 5 PM',
          'system.day_of_week':
            "Current day of week (Monday-Sunday).<br><strong>Use for:</strong> Weekday filtering.<br><strong>Example:</strong> Day of week equals 'Monday'",
        },

        // Operators
        operators: {
          equals:
            "Exact match (case-sensitive).<br><strong>Use for:</strong> Precise comparisons.<br><strong>Example:</strong> Status equals 'active'",
          not_equals:
            "Does not match (case-sensitive).<br><strong>Use for:</strong> Exclusions.<br><strong>Example:</strong> Group not equals 'Beginners'",
          contains:
            "String includes value (case-insensitive).<br><strong>Use for:</strong> Partial matches.<br><strong>Example:</strong> Name contains 'Smith'",
          not_contains:
            "String does not include value.<br><strong>Use for:</strong> Excluding keywords.<br><strong>Example:</strong> Notes not contains 'inactive'",
          starts_with:
            "String begins with value.<br><strong>Use for:</strong> Prefix matching.<br><strong>Example:</strong> Email starts with 'admin'",
          ends_with:
            "String ends with value.<br><strong>Use for:</strong> Suffix matching.<br><strong>Example:</strong> Phone ends with '0000'",
          greater_than:
            'Numeric/date value is larger.<br><strong>Use for:</strong> Threshold checks.<br><strong>Example:</strong> Balance greater than 0',
          less_than:
            'Numeric/date value is smaller.<br><strong>Use for:</strong> Minimum checks.<br><strong>Example:</strong> Price less than 30',
          greater_or_equal:
            'Numeric/date value is ‚â•.<br><strong>Use for:</strong> Minimum inclusive checks.<br><strong>Example:</strong> Balance ‚â• -10',
          less_or_equal:
            'Numeric/date value is ‚â§.<br><strong>Use for:</strong> Maximum inclusive checks.<br><strong>Example:</strong> Days absent ‚â§ 3',
          between:
            'Value is within range (inclusive).<br><strong>Use for:</strong> Range filtering.<br><strong>Example:</strong> Balance between -50 and 0',
          is_empty:
            'Field has no value (null/empty string).<br><strong>Use for:</strong> Missing data checks.<br><strong>Example:</strong> Email is empty',
          is_not_empty:
            'Field has any value.<br><strong>Use for:</strong> Required field checks.<br><strong>Example:</strong> Phone is not empty',
          regex:
            "Matches regular expression pattern.<br><strong>Use for:</strong> Complex patterns.<br><strong>Example:</strong> Email regex '^[a-z]+@gmail\\.com$'",
          in_list:
            "Value matches any in comma-separated list.<br><strong>Use for:</strong> Multiple options.<br><strong>Example:</strong> Status in list 'active,paused'",
          not_in_list:
            "Value does not match any in list.<br><strong>Use for:</strong> Multiple exclusions.<br><strong>Example:</strong> Group not in list 'Test,Demo'",
        },
      };

      // ============================================================
      // MODAL CONTROLS
      // ============================================================
      function openSentEmails() {
        document.getElementById('sentEmailsModal').classList.add('active');
        document.body.style.overflow = 'hidden';
      }
      function closeSentEmails() {
        document.getElementById('sentEmailsModal').classList.remove('active');
        document.body.style.overflow = '';
      }
      function openEditor() {
        document.getElementById('editorModal').classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function saveTemplate() {
        const modal = document.getElementById('editorModal');
        const editingId = modal.dataset.editingId;

        const name = document.getElementById('templateName').value.trim();
        const subject = document.getElementById('templateSubject').value.trim();
        const body_html = document.getElementById('htmlBodyEditor').value.trim();
        const trigger = document.getElementById('templateTrigger').value;

        if (!name) {
          showDesignAlert('Please enter a template name', { type: 'warning', title: 'Name Required' });
          return;
        }

        if (!subject) {
          showDesignAlert('Please enter a subject line', { type: 'warning', title: 'Subject Required' });
          return;
        }

        if (!body_html) {
          showDesignAlert('Please enter email content', { type: 'warning', title: 'Email Body Required' });
          return;
        }

        if (editingId) {
          // Editing existing template
          const template = emailSystem._templates.find(t => t.id === editingId);
          if (template) {
            template.name = name;
            template.subject = subject;
            template.body_html = body_html;
            template.body = body_html; // Keep both for compatibility
            template.trigger = trigger;
            template.trigger_type = trigger.toLowerCase().replace(/ /g, '_');
            debugLog('‚úÖ Template updated:', name);
          }
        } else {
          // Creating new template
          const newTemplate = {
            id: `${Date.now()}_custom`,
            name,
            subject,
            body_html,
            body: body_html, // Keep both for compatibility
            trigger,
            trigger_type: trigger.toLowerCase().replace(/ /g, '_'),
            trigger_category: 'manual',
            active: true,
          };
          emailSystem._templates.push(newTemplate);
          debugLog('‚úÖ New template created:', name);
        }

        // Save to localStorage and Supabase
        emailSystem.saveTemplates();
        emailSystem.renderTemplates();

        // Clear the form and close
        delete modal.dataset.editingId;
        document.getElementById('templateName').value = '';
        document.getElementById('templateSubject').value = '';
        document.getElementById('htmlBodyEditor').value = '';
        document.getElementById('templateTrigger').value = 'Manual';

        closeEditor();
      }
      function closeEditor() {
        const modal = document.getElementById('editorModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
        modal.dataset.editingId = '';
      }

      // ============================================================
      // RICH TEXT EDITOR FUNCTIONS
      // ============================================================
      function formatText(command) {
        const textarea = document.getElementById('htmlBodyEditor');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);

        if (!selectedText) {
          showDesignAlert('Please select some text first!', { type: 'info', title: 'Select Text' });
          return;
        }

        let wrappedText = '';
        switch (command) {
          case 'bold':
            wrappedText = `<strong>${selectedText}</strong>`;
            break;
          case 'italic':
            wrappedText = `<em>${selectedText}</em>`;
            break;
          case 'underline':
            wrappedText = `<u>${selectedText}</u>`;
            break;
        }

        textarea.value = textarea.value.substring(0, start) + wrappedText + textarea.value.substring(end);

        // Restore focus and adjust selection
        textarea.focus();
        textarea.selectionStart = start;
        textarea.selectionEnd = start + wrappedText.length;

        // Update preview
        updatePreview();
      }

      function applyFontSize(size) {
        const textarea = document.getElementById('htmlBodyEditor');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);

        if (!selectedText) {
          showDesignAlert('Please select some text first!', { type: 'info', title: 'Select Text' });
          return;
        }

        const wrappedText = `<span style="font-size: ${size};">${selectedText}</span>`;
        textarea.value = textarea.value.substring(0, start) + wrappedText + textarea.value.substring(end);

        textarea.focus();
        textarea.selectionStart = start;
        textarea.selectionEnd = start + wrappedText.length;

        // Update preview
        updatePreview();
      }

      function applyFontFamily(font) {
        const textarea = document.getElementById('htmlBodyEditor');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);

        if (!selectedText) {
          showDesignAlert('Please select some text first!', { type: 'info', title: 'Select Text' });
          return;
        }

        const wrappedText = `<span style="font-family: ${font};">${selectedText}</span>`;
        textarea.value = textarea.value.substring(0, start) + wrappedText + textarea.value.substring(end);

        textarea.focus();
        textarea.selectionStart = start;
        textarea.selectionEnd = start + wrappedText.length;

        // Update preview
        updatePreview();
      }

      // ============================================================
      // SYNCHRONIZED EDITOR SYSTEM (PREVIEW ‚Üî CODE)
      // ============================================================
      let isUpdatingFromCode = false; // Prevent circular updates
      let isUpdatingFromPreview = false;
      let lastPreviewSelection = null;
      let lastPreviewClickPosition = null; // Track where user clicked in preview

      // Save cursor position in preview and calculate code editor position
      function savePreviewSelection() {
        const previewBody = document.getElementById('previewBody');
        const codeEditor = document.getElementById('htmlBodyEditor');

        if (document.activeElement === previewBody) {
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            lastPreviewSelection = selection.getRangeAt(0).cloneRange();

            // Calculate equivalent position in code editor
            // Get text offset from start of preview
            const range = selection.getRangeAt(0);
            const preContainer = range.startContainer;
            const preOffset = range.startOffset;

            // Create a range from start to cursor
            const startRange = document.createRange();
            startRange.selectNodeContents(previewBody);
            startRange.setEnd(preContainer, preOffset);

            // Get the HTML from start to cursor
            const beforeCursorHTML = getRangeHTML(startRange);

            // Find this position in the code editor
            const codeHTML = codeEditor.value;
            const position = codeHTML.indexOf(beforeCursorHTML);

            if (position >= 0) {
              lastPreviewClickPosition = position + beforeCursorHTML.length;
            } else {
              // Fallback: try to find approximate position
              lastPreviewClickPosition = Math.min(
                Math.floor(codeHTML.length * (beforeCursorHTML.length / previewBody.innerHTML.length)),
                codeHTML.length
              );
            }
          }
        }
      }

      // Helper function to get HTML from a range
      function getRangeHTML(range) {
        const div = document.createElement('div');
        div.appendChild(range.cloneContents());
        return div.innerHTML;
      }

      // Restore cursor position in preview
      function restorePreviewSelection() {
        if (lastPreviewSelection) {
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(lastPreviewSelection);
        }
      }

      // Update preview from code editor
      function updatePreview() {
        if (isUpdatingFromPreview) return; // Prevent sync loops

        isUpdatingFromCode = true;

        const subject = document.getElementById('templateSubject')?.value || '';
        const body = document.getElementById('htmlBodyEditor')?.value || '';

        // Sample student data
        const sampleData = {
          StudentName: 'John Doe',
          StudentEmail: 'john@example.com',
          StudentPhone: '(555) 123-4567',
          Group: 'Group A - Monday 6PM',
          Balance: '-$45.00',
          PricePerClass: '$40.00',
          Amount: '$40.00',
          PaymentDate: 'Nov 20, 2025',
          ClassDate: 'Nov 25, 2025 6:00 PM',
          NextClassDate: 'Nov 25, 2025 6:00 PM',
          Schedule: 'Monday 6:00 PM, Wednesday 6:00 PM',
          Alias: 'JohnD',
          CreditAmount: '$20.00',
        };

        // Replace all variables in subject and body
        let previewSubject = subject;
        let previewBody = body;

        for (const [key, value] of Object.entries(sampleData)) {
          const regex = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
          previewSubject = previewSubject.replace(regex, value);
          previewBody = previewBody.replace(regex, value);
        }

        // Update preview elements
        const subjectElement = document.getElementById('previewSubject');
        const bodyElement = document.getElementById('previewBody');

        if (subjectElement) {
          subjectElement.textContent = previewSubject || 'Your email subject will appear here...';
        }

        if (bodyElement) {
          // Save scroll position
          const scrollTop = bodyElement.scrollTop;

          bodyElement.innerHTML = previewBody || 'Start typing to see your email preview with sample student data...';

          // Restore scroll position
          bodyElement.scrollTop = scrollTop;
        }

        setTimeout(() => {
          isUpdatingFromCode = false;
        }, 50);
      }

      // Sync preview changes to code editor
      function syncPreviewToCode() {
        if (isUpdatingFromCode) return; // Prevent circular updates

        isUpdatingFromPreview = true;

        const previewBody = document.getElementById('previewBody');
        const codeEditor = document.getElementById('htmlBodyEditor');

        if (previewBody && codeEditor) {
          // Get the HTML from the editable preview
          const editedHTML = previewBody.innerHTML;

          // Save cursor position in code editor
          const cursorPos = codeEditor.selectionStart;

          // Update the code editor
          codeEditor.value = editedHTML;

          // Try to restore cursor position
          codeEditor.selectionStart = cursorPos;
          codeEditor.selectionEnd = cursorPos;
        }

        setTimeout(() => {
          isUpdatingFromPreview = false;
        }, 50);
      }

      // Handle preview paste events
      function handlePreviewPaste(event) {
        event.preventDefault();
        const text = (event.clipboardData || window.clipboardData).getData('text/plain');
        document.execCommand('insertText', false, text);
        syncPreviewToCode();
      }

      // Insert variable at cursor position (uses preview click position if available)
      function insertVariable(variable) {
        const textarea = document.getElementById('htmlBodyEditor');

        // Determine insert position:
        // 1. If user clicked in preview, use that mapped position
        // 2. Otherwise use code editor cursor position
        // 3. Fallback to end of document
        let insertPos, endPos;

        if (lastPreviewClickPosition !== null) {
          // Insert at preview click position WITHOUT deleting anything
          insertPos = lastPreviewClickPosition;
          endPos = lastPreviewClickPosition; // Same as start = no deletion
          lastPreviewClickPosition = null; // Reset after use
        } else {
          // Insert at code editor cursor (can replace selection if any)
          insertPos = textarea.selectionStart || textarea.value.length;
          endPos = textarea.selectionEnd || insertPos;
        }

        textarea.value = textarea.value.substring(0, insertPos) + variable + textarea.value.substring(endPos);

        // Move cursor after the variable
        const newPosition = insertPos + variable.length;
        textarea.selectionStart = newPosition;
        textarea.selectionEnd = newPosition;
        textarea.focus();

        // Update preview to reflect changes
        updatePreview();
      }

      // Insert info box at cursor position (uses preview click position if available)
      function insertInfoBox() {
        const textarea = document.getElementById('htmlBodyEditor');

        const infoBoxHTML = `
<div class="info-box">
    <p><strong>{{ClassTime}}</strong></p>
</div>`;

        // Determine insert position:
        // 1. If user clicked in preview, use that mapped position
        // 2. Otherwise use code editor cursor position
        // 3. Fallback to end of document
        let insertPos, endPos;

        if (lastPreviewClickPosition !== null) {
          // Insert at preview click position WITHOUT deleting anything
          insertPos = lastPreviewClickPosition;
          endPos = lastPreviewClickPosition; // Same as start = no deletion
          lastPreviewClickPosition = null; // Reset after use
        } else {
          // Insert at code editor cursor (can replace selection if any)
          insertPos = textarea.selectionStart || textarea.value.length;
          endPos = textarea.selectionEnd || insertPos;
        }

        textarea.value = textarea.value.substring(0, insertPos) + infoBoxHTML + textarea.value.substring(endPos);

        // Move cursor after the info box
        const newPosition = insertPos + infoBoxHTML.length;
        textarea.selectionStart = newPosition;
        textarea.selectionEnd = newPosition;
        textarea.focus();

        // Update preview to reflect changes
        updatePreview();
      }

      function openAutomations() {
        document.getElementById('automationsModal').classList.add('active');
        document.body.style.overflow = '';
      }
      function closeAutomations() {
        document.getElementById('automationsModal').classList.remove('active');
        document.body.style.overflow = '';
      }
      function openPreview() {
        document.getElementById('previewModal').classList.add('active');
        document.body.style.overflow = 'hidden';
      }
      function closePreview() {
        document.getElementById('previewModal').classList.remove('active');
        document.getElementById('previewFrame').srcdoc = '';
        document.body.style.overflow = '';
      }

      // ============================================================
      // TEST EMAIL SYSTEM
      // ============================================================
      async function openTestEmail(type) {
        // Load test emails from Supabase
        await TestEmailManager.loadEmails();
        await TestEmailManager.renderEmailList();

        const testEmails = {
          profile_update: {
            title: '‚úèÔ∏è Profile Updated',
            body: `
                        <h2 style="color: #667eea; margin-top: 0;">Profile Successfully Updated</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p>Your ARNOMA student profile has been updated with the following changes:</p>

                        <div class="info-box">
                            <p style="margin: 4px 0;"><strong>üìß Email:</strong> john.doe@example.com</p>
                            <p style="margin: 4px 0;"><strong>üì± Phone:</strong> +1 (555) 123-4567</p>
                            <p style="margin: 4px 0;"><strong>üë• Group:</strong> Group A - Monday 6PM</p>
                            <p style="margin: 4px 0;"><strong>üíµ Price per Class:</strong> $40.00</p>
                        </div>

                        <p>If you didn't request these changes or notice any errors, please contact us immediately.</p>
                        <p style="margin-top: 24px;">Thank you for being part of ARNOMA! üéì</p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
          alias_added: {
            title: 'üè∑Ô∏è Payment Alias Added',
            body: `
                        <h2 style="color: #667eea; margin-top: 0;">New Payment Alias Added</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p>A new payment alias has been added to your account to help us identify your payments automatically:</p>

                        <div class="info-box">
                            <p style="margin: 4px 0; text-align: center; font-size: 20px;"><strong>üìõ "Johnny D"</strong></p>
                        </div>

                        <p>When sending payments via Zelle or other services, using <strong>"Johnny D"</strong> will help us match your payment to your account instantly.</p>
                        <p style="margin-top: 24px; font-size: 14px; color: #6b7280;">üí° <em>Tip: You can still use "John Doe" ‚Äî all your aliases work!</em></p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
          schedule_update: {
            title: 'üìÖ Schedule Updated',
            body: `
                        <h2 style="color: #667eea; margin-top: 0;">Your Class Schedule Has Changed</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p>Your class schedule has been updated. Here's your new schedule:</p>

                        <div class="info-box">
                            <p style="margin: 4px 0;"><strong>üìÜ New Schedule</strong></p>
                            <p style="margin: 4px 0; font-size: 18px;"><strong>Tuesday & Thursday ‚Äî 7:30 PM</strong></p>
                            <p style="margin: 4px 0; color: #6b7280;">(Los Angeles Time)</p>
                        </div>

                        <p><strong>üìç Next Class:</strong> Tuesday, November 12, 2025 at 7:30 PM</p>
                        <p>If you have any questions about the schedule change, please don't hesitate to reach out!</p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
          group_enrollment: {
            title: 'üë• Group Enrollment Confirmation',
            body: `
                        <h2 style="color: #667eea; margin-top: 0;">Welcome to Your New Group!</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p>Congratulations! You've been enrolled in a new group:</p>

                        <div class="info-box">
                            <p style="margin: 4px 0; font-size: 20px;"><strong>üéì Group B - Advanced</strong></p>
                            <p style="margin: 4px 0; font-size: 16px;"><strong>Monday & Wednesday ‚Äî 8:00 PM</strong></p>
                            <p style="margin: 4px 0; color: #6b7280;">(Los Angeles Time)</p>
                        </div>

                        <p><strong>üöÄ First Class:</strong> Monday, November 11, 2025 at 8:00 PM</p>
                        <p><strong>üíµ Price per Class:</strong> $45.00</p>
                        <p style="margin-top: 24px;">We're excited to have you in this group! See you in class! üéâ</p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
          credit_added: {
            title: 'üí∞ Credit Added to Balance',
            body: `
                        <h2 style="color: #667eea; margin-top: 0;">Credit Added to Your Account</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p>A credit has been added to your ARNOMA account balance:</p>

                        <div class="info-box">
                            <p style="margin: 4px 0;"><strong>Credit Amount:</strong> +$120.00</p>
                            <p style="margin: 4px 0;"><strong>Added on:</strong> November 10, 2025</p>
                            <p style="margin: 4px 0;"><strong>üìù Note:</strong> Makeup class credit for Nov 6th</p>
                        </div>

                        <p>This credit will be automatically applied to future classes. Thank you for your continued participation!</p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
          credit_applied: {
            title: '‚úÖ Credit Applied to Class',
            body: `
                        <h2 style="color: #667eea; margin-top: 0;">Credit Applied Successfully</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p>A credit has been applied to one of your classes:</p>

                        <div class="info-box">
                            <p style="margin: 4px 0;"><strong>üìÖ Class Date:</strong> Monday, November 11, 2025</p>
                            <p style="margin: 4px 0;"><strong>üíµ Credit Amount:</strong> $40.00</p>
                            <p style="margin: 4px 0;"><strong>üí≥ Payment Status:</strong> <span style="color: #10b981; font-weight: 600;">PAID</span></p>
                        </div>

                        <p>This class is now marked as paid using your account credit. No payment action required!</p>
                        <p style="margin-top: 24px; font-size: 14px; color: #6b7280;">üìä Check your student portal for updated balance information.</p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
          credit_edit: {
            title: '‚úèÔ∏è Credit Payment Updated',
            body: `
                        <h2 style="color: #667eea; margin-top: 0;">Credit Payment Modified</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p>A credit payment on your account has been updated:</p>

                        <div class="info-box">
                            <p style="margin: 4px 0;"><strong>Class Date:</strong> Monday, November 11, 2025</p>
                            <p style="margin: 4px 0;"><strong>Previous Amount:</strong> <s>$40.00</s></p>
                            <p style="margin: 4px 0;"><strong>New Amount:</strong> $45.00</p>
                            <p style="margin: 4px 0;"><strong>Updated Note:</strong> Adjusted for new pricing</p>
                        </div>

                        <p>Your account balance and payment history have been updated accordingly.</p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
          status_paused: {
            title: '‚è∏Ô∏è Account Status: Paused',
            body: `
                        <h2 style="color: #667eea; margin-top: 0;">Your Account Has Been Paused</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p>Your ARNOMA student account status has been changed to <strong>Paused</strong> effective November 10, 2025.</p>

                        <div class="info-box">
                            <p style="margin: 4px 0;"><strong>What this means:</strong></p>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                <li>You won't be charged for upcoming classes</li>
                                <li>Your spot in the group is temporarily on hold</li>
                                <li>You can resume anytime by contacting us</li>
                            </ul>
                        </div>

                        <p style="margin-top: 24px;">When you're ready to return, just let us know! We'll be happy to have you back. üíú</p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
          status_active: {
            title: '‚úÖ Account Status: Active',
            body: `
                        <h2 style="color: #667eea; margin-top: 0;">Welcome Back! You're Active Again</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p>Great news! Your ARNOMA student account has been reactivated effective November 10, 2025.</p>

                        <div class="info-box">
                            <p style="margin: 4px 0;"><strong>Your Current Schedule:</strong></p>
                            <p style="margin: 4px 0; font-size: 16px;"><strong>üìÜ Monday & Wednesday ‚Äî 8:00 PM</strong></p>
                            <p style="margin: 4px 0; color: #6b7280;">(Los Angeles Time)</p>
                            <p style="margin: 12px 0 4px 0;"><strong>üìç Next Class:</strong> Monday, November 11, 2025 at 8:00 PM</p>
                        </div>

                        <p style="margin-top: 24px;">We're so happy to have you back! See you in class! üéâ</p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
          status_graduated: {
            title: 'üéì Congratulations Graduate!',
            body: `
                        <h2 style="color: #667eea; margin-top: 0; text-align: center;">üéì You've Graduated! üéâ</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p>Congratulations! Your ARNOMA student status has been updated to <strong>Graduated</strong> as of November 10, 2025.</p>

                        <p style="text-align: center; font-size: 48px; margin: 24px 0;">üéì</p>

                        <p>Thank you for being part of the ARNOMA family! We're incredibly proud of your progress and achievements.</p>

                        <div class="info-box">
                            <p style="margin: 4px 0;"><strong>What's next?</strong></p>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                <li>Your account will remain in our system for records</li>
                                <li>You're always welcome to return for advanced classes</li>
                                <li>Stay in touch ‚Äî we'd love to hear from you!</li>
                            </ul>
                        </div>

                        <p style="margin-top: 32px; text-align: center; font-size: 18px; font-weight: 600;">Best wishes on your journey! üåü</p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
          absence_marked: {
            title: 'üìç Absence Recorded',
            body: `
                        <h2 style="color: #667eea; margin-top: 0;">Absence Marked for Class</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p>We've recorded an absence for your class:</p>

                        <div class="info-box">
                            <p style="margin: 4px 0;"><strong>üìÖ Class Date:</strong> Monday, November 11, 2025</p>
                            <p style="margin: 4px 0;"><strong>üïê Time:</strong> 8:00 PM (Los Angeles Time)</p>
                            <p style="margin: 4px 0;"><strong>üìä Status:</strong> <span style="color: #ef4444; font-weight: 600;">ABSENT</span></p>
                        </div>

                        <p><strong>üí° What happens next?</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li>This absence is now recorded in your attendance history</li>
                            <li>If you pre-paid for this class, no refund is issued per policy</li>
                            <li>Contact us if you'd like to discuss makeup options</li>
                        </ul>

                        <p style="margin-top: 24px;">We hope to see you at the next class! üòä</p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
          schedule_change: {
            title: '‚ö†Ô∏è Important: Schedule Change',
            body: `
                        <h2 style="color: #667eea; margin-top: 0;">‚ö†Ô∏è Urgent Schedule Update</h2>
                        <p>Hi <strong>John Doe</strong>,</p>
                        <p><strong>Important:</strong> Your class schedule has been modified. Please review the changes below:</p>

                        <div style="border: 3px solid #ef4444; background: #fee2e2; border-radius: 10px; padding: 14px 18px; margin: 20px 0;">
                            <p style="margin: 4px 0; color: #991b1b;"><strong>üîÑ Old Schedule</strong></p>
                            <p style="margin: 4px 0; color: #991b1b; text-decoration: line-through;">Monday & Wednesday ‚Äî 8:00 PM</p>
                        </div>

                        <div class="info-box">
                            <p style="margin: 4px 0;"><strong>‚ú® New Schedule</strong></p>
                            <p style="margin: 4px 0; font-size: 18px;"><strong>Tuesday & Thursday ‚Äî 7:30 PM</strong></p>
                            <p style="margin: 4px 0; color: #6b7280;">(Los Angeles Time)</p>
                        </div>

                        <p><strong>üìç First Class on New Schedule:</strong> Tuesday, November 12, 2025 at 7:30 PM</p>
                        <p><strong>üìß Questions?</strong> Please reply to this email or contact us directly.</p>

                        <p style="margin-top: 24px;">Thank you for your flexibility! üôè</p>
                        <p>Best regards,<br><strong>ARNOMA Team</strong></p>
                    `,
          },
        };

        const emailData = testEmails[type];
        if (!emailData) {
          console.error('Unknown test email type:', type);
          return;
        }

        // Generate full email HTML using the wrapper
        const fullHTML = generateEmailHTML(emailData.title, emailData.body);

        // Load into preview modal
        const iframe = document.getElementById('previewFrame');
        iframe.srcdoc = fullHTML;
        openPreview();

        // Store current test type for sending
        window.currentTestEmailType = type;
        window.currentTestEmailHTML = fullHTML;
      }

      // ============================================================
      // ADD NEW TEST EMAIL ADDRESS
      // ============================================================
      async function addNewTestEmail() {
        const input = document.getElementById('newTestEmail');
        const email = input.value.trim();

        if (!email) {
          showDesignAlert('‚ö†Ô∏è Please enter an email address', { type: 'warning', title: 'Email Required' });
          return;
        }

        await TestEmailManager.addEmail(email);
        input.value = ''; // Clear input after adding
      }

      // ============================================================
      // SEND TEST EMAIL (UPDATED - MULTI-EMAIL SUPPORT)
      // ============================================================
      async function sendTestEmail() {
        // Get all saved test emails
        const savedEmails = TestEmailManager.getAllEmails();

        // Check if we have any emails to send to
        if (savedEmails.length === 0) {
          showDesignAlert('‚ö†Ô∏è No test email addresses saved. Please add at least one email address.', {
            type: 'warning',
            title: 'Add Test Emails',
          });
          return;
        }

        if (!window.currentTestEmailHTML || !window.currentTestEmailType) {
          showDesignAlert('‚ö†Ô∏è No test email loaded. Please select a test email first.', {
            type: 'warning',
            title: 'Select Template',
          });
          return;
        }

        // Get test email title
        const testEmailTitles = {
          profile_update: '‚úèÔ∏è Profile Updated',
          alias_added: 'üè∑Ô∏è Payment Alias Added',
          schedule_update: 'üìÖ Schedule Updated',
          group_enrollment: 'üë• Group Enrollment Confirmation',
          credit_added: 'üí∞ Credit Added to Balance',
          credit_applied: '‚úÖ Credit Applied to Class',
          credit_edit: '‚úèÔ∏è Credit Payment Updated',
          status_paused: '‚è∏Ô∏è Account Status: Paused',
          status_active: '‚úÖ Account Status: Active',
          status_graduated: 'üéì Congratulations Graduate!',
          absence_marked: 'üìç Absence Recorded',
          schedule_change: '‚ö†Ô∏è Important: Schedule Change',
        };

        const subject = testEmailTitles[window.currentTestEmailType] || 'Test Email from ARNOMA';

        try {
          // Show loading state
          const sendBtn = event.target;
          const originalText = sendBtn.textContent;
          sendBtn.textContent = `‚è≥ Sending to ${savedEmails.length} address${savedEmails.length > 1 ? 'es' : ''}...`;
          sendBtn.disabled = true;

          const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
          const SUPABASE_ANON_KEY =
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';

          // Send to all saved emails
          const sendPromises = savedEmails.map(async email => {
            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                to: email,
                subject: `[TEST] ${subject}`,
                html: window.currentTestEmailHTML,
              }),
            });

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(`Failed to send to ${email}: ${errorData.error || 'Unknown error'}`);
            }

            return await response.json();
          });

          // Wait for all emails to send
          const results = await Promise.all(sendPromises);

          debugLog('üìß All test emails sent:', results);

          // Track each sent email
          savedEmails.forEach((email, index) => {
            const responseData = results[index];
            const resendEmailId = responseData?.id || responseData?.emailId || null;

            emailSystem.addSentEmail({
              to: email,
              subject: `[TEST] ${subject}`,
              html: window.currentTestEmailHTML,
              status: 'sent',
              resendId: resendEmailId,
              deliveryStatus: 'pending',
              templateName: testEmailTitles[window.currentTestEmailType],
              type: 'test',
              responseData: responseData,
            });
          });

          // Success
          showCustomNotification(
            `Test emails sent successfully to ${savedEmails.length} address${savedEmails.length > 1 ? 'es' : ''}!`,
            'success'
          );

          // Reset button
          sendBtn.textContent = originalText;
          sendBtn.disabled = false;
        } catch (error) {
          console.error('Error sending test emails:', error);
          showCustomNotification('Failed to send test emails. Check console for details.', 'error');

          // Reset button
          event.target.textContent = 'üì® Send Test to All Saved Emails';
          event.target.disabled = false;
        }
      }

      // ============================================================
      // EMAIL HTML GENERATOR (FROM email-system-complete.html)
      // ============================================================
      function generateEmailHTML(title, bodyContent) {
        return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARNOMA NCLEX-RN Email</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px 20px;
    }
    .email-wrapper {
      max-width: 600px;
      margin: 0 auto;
    }
    .email-container {
      background-color: #ffffff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .email-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 45px 35px 35px;
      text-align: center;
    }
    .email-header img {
      width: 140px;
      height: 140px;
      margin-bottom: 15px;
      filter: drop-shadow(0 0 6px rgba(255,255,255,0.7))
              drop-shadow(0 0 12px rgba(255,255,255,0.4))
              drop-shadow(0 0 3px rgba(255,255,255,0.8));
      animation: fadeIn 1.5s ease-in-out;
    }
    .email-header h1 {
      color: #fff;
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.5px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .email-body {
      padding: 35px;
      color: #333;
      font-size: 16px;
      line-height: 1.6;
    }
    .email-body p {
      margin: 0 0 16px 0;
    }
    .email-body img {
      display: block;
      max-width: 100%;
      height: auto;
      margin: 20px auto;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .payment-frame {
      background-color: #f8f9fc;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .payment-frame img {
      margin: 12px auto;
      border-radius: 8px;
      box-shadow: none;
    }
    .info-box {
      background-color: #f6f8fe;
      border-left: 3px solid #3b82f6;
      border-radius: 10px;
      padding: 14px 18px;
      font-size: 15px;
      line-height: 1.5;
      color: #1e293b;
      margin: 20px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .info-box p {
      margin: 6px 0;
      text-align: left;
    }
    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(255,255,255,0.3) 20%, rgba(255,255,255,0.3) 80%, transparent);
      margin: 24px 0;
      border: none;
    }
    .email-footer {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      text-align: center;
      padding: 30px 20px;
    }
    .email-footer img {
      width: 100px;
      height: 100px;
      margin: 10px 0;
      filter: drop-shadow(0 0 5px rgba(255,255,255,0.6))
              drop-shadow(0 0 10px rgba(255,255,255,0.3))
              drop-shadow(0 0 2px rgba(255,255,255,0.8));
    }
    .email-footer p {
      margin: 6px 0;
      font-size: 13px;
    }
    @media (max-width: 600px) {
      body { padding: 20px 10px; }
      .email-body { padding: 25px 20px; font-size: 15px; }
      .email-header img { width: 110px; height: 110px; }
    }
  </style>
<style>:root{--panel-blur:8px;--card-blur:8px;--modal-blur:14px;--list-blur:0px;}</style>
</head>
<body>
  <div class="email-wrapper">
    <div class="email-container">
      <div class="email-header">
        <img src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png" alt="ARNOMA Logo">
        <h1>${title}</h1>
      </div>

      <div class="email-body">
        ${bodyContent}
      </div>

      <div class="email-footer">
        <img src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png" alt="ARNOMA Logo">
        <p><strong style="font-size: 18px;">ARNOMA ‚Äì NCLEX RN</strong></p>
        <p style="font-size: 14px;">Professional NCLEX Preparation & Medical Education</p>
        <p style="font-size: 13px;">
          nclex.rn@arnoma.us<br>
          richy@arnoma.us<br>
          909-808-1818
        </p>
        <p style="font-size: 12px; color: #95a5a6;">
          ¬© 2025 ARNOMA. All rights reserved.
        </p>
        <p style="font-size: 12px; color: #7f8c8d;">
          This is an automated notification from your ARNOMA NCLEX prep program.
        </p>
      </div>
    </div>
  </div>
</body>
</html>`;
      }

      // ============================================================
      // EMAIL SYSTEM (CONNECTED TO SUPABASE)
      // ============================================================
      const emailSystem = {
        _templates: [],
        _sentEmails: [],

        async init() {
          await this.loadTemplates();
          await this.loadSentEmails();
          this.renderTemplates();
          this.renderSentEmails();
        },

        async loadTemplates() {
          if (!supabase) {
            console.error('‚ùå Supabase not initialized for templates');
            this._templates = this.getDefaultTemplates();
            return;
          }

          try {
            const { data, error } = await supabase
              .from('email_templates')
              .select('*')
              .order('created_at', { ascending: true });

            if (error) throw error;

            if (data && data.length > 0) {
              // Convert Supabase format to internal format
              this._templates = data.map(t => ({
                id: t.id.toString(),
                name: t.name,
                subject: t.subject,
                body: t.body_html || t.body,
                trigger: t.trigger_type || 'manual',
                active: true // Default to active since is_active column doesn't exist
              }));
              debugLog(`‚úÖ Loaded ${this._templates.length} templates from Supabase`);
            } else {
              debugLog('‚ö†Ô∏è No templates found, loading defaults');
              this._templates = this.getDefaultTemplates();
              await this.saveTemplates();
            }
          } catch (e) {
            console.error('‚ùå Error loading templates from Supabase:', e);
            this._templates = this.getDefaultTemplates();
          }
        },

        async saveTemplates() {
          if (!supabase) {
            console.error('‚ùå Supabase not initialized');
            return false;
          }

          try {
            // Sync all templates to Supabase (upsert)
            for (const template of this._templates) {
              // Build template data - omit id to let database handle UUID generation
              const templateData = {
                name: template.name,
                subject: template.subject,
                body_html: template.body,
                trigger_type: template.trigger
              };

              const { error } = await supabase
                .from('email_templates')
                .upsert(templateData, { onConflict: 'name' }); // Use name as conflict key instead of id

              if (error) {
                console.error(`‚ùå Error saving template "${template.name}":`, error);
              }
            }

            debugLog('‚úÖ Templates synced to Supabase');
            return true;
          } catch (e) {
            console.error('‚ùå Error saving templates to Supabase:', e);
            return false;
          }
        },

        getDefaultTemplates() {
          // ARNOMA signature block (used in all templates)
          const arnomaSignature = `
                    <div style="margin-top: 40px; padding-top: 24px; border-top: 2px solid rgba(102,126,234,0.2);">
                        <p style="margin: 8px 0;">Best regards,</p>
                        <p style="margin: 8px 0; font-weight: 600; color: #667eea;">ARNOMA Team</p>
                        <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08)); border-radius: 12px; border: 1px solid rgba(102,126,234,0.2);">
                            <p style="margin: 6px 0; font-size: 13px; color: #6b7280;">
                                üìß <strong>Email:</strong> <a href="mailto:{{TeacherEmail}}" style="color: #667eea; text-decoration: none;">{{TeacherEmail}}</a>
                            </p>
                            <p style="margin: 6px 0; font-size: 13px; color: #6b7280;">
                                üë®‚Äçüè´ <strong>Teacher:</strong> {{TeacherName}}
                            </p>
                            <p style="margin: 12px 0 6px 0; font-size: 12px; color: #9ca3af;">
                                <em>This email was sent automatically from ARNOMA Student Management System</em>
                            </p>
                        </div>
                    </div>
                `;

          const timestamp = Date.now();
          return [
            {
              id: `${timestamp}_1`,
              name: 'Profile Update',
              subject: 'Your Profile Has Been Updated',
              body: generateEmailHTML(
                'Profile Successfully Updated',
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Your ARNOMA student profile has been updated with the following changes:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>üìß Email:</strong> {{StudentEmail}}</p>
                                <p style="margin: 8px 0;"><strong>üì± Phone:</strong> {{StudentPhone}}</p>
                                <p style="margin: 8px 0;"><strong>üë• Group:</strong> {{Group}}</p>
                                <p style="margin: 8px 0;"><strong>üíµ Price per Class:</strong> $\{{PricePerClass}}</p>
                            </div>

                            <p>If you didn't request these changes or notice any errors, please contact us immediately.</p>
                            <p style="margin-top: 24px;">Thank you for being part of ARNOMA! üéì</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_2`,
              name: 'Alias Added',
              subject: 'New Payment Alias Added to Your Account',
              body: generateEmailHTML(
                'New Payment Alias Added',
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>A new payment alias has been added to your account to help us identify your payments automatically:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0; text-align: center; font-size: 20px;"><strong>üìõ "{{Alias}}"</strong></p>
                            </div>

                            <p>When sending payments via Zelle or other services, using <strong>"{{Alias}}"</strong> will help us match your payment to your account instantly.</p>
                            <p style="margin-top: 24px; font-size: 14px; color: #6b7280;">üí° <em>Tip: You can still use "{{StudentName}}" ‚Äî all your aliases work!</em></p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_3`,
              name: 'Schedule Update',
              subject: 'Your Class Schedule Has Changed',
              body: generateEmailHTML(
                'Your Class Schedule Has Changed',
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Your class schedule has been updated. Here's your new schedule:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>üìÜ New Schedule</strong></p>
                                <p style="margin: 8px 0; font-size: 18px;"><strong>{{NewSchedule}}</strong></p>
                                <p style="margin: 8px 0; color: #6b7280;">(Los Angeles Time)</p>
                            </div>

                            <p><strong>üìç Next Class:</strong> {{NextClassDate}}</p>
                            <p>If you have any questions about the schedule change, please don't hesitate to reach out!</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_4`,
              name: 'Group Enrollment',
              subject: 'Welcome to Your New Group!',
              body: generateEmailHTML(
                'Welcome to Your New Group!',
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Congratulations! You've been enrolled in a new group:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0; font-size: 20px;"><strong>üéì {{NewGroup}}</strong></p>
                                <p style="margin: 8px 0; font-size: 16px;"><strong>{{NewSchedule}}</strong></p>
                                <p style="margin: 8px 0; color: #6b7280;">(Los Angeles Time)</p>
                            </div>

                            <p><strong>üöÄ First Class:</strong> {{NextClassDate}}</p>
                            <p><strong>üíµ Price per Class:</strong> $\{{PricePerClass}}</p>
                            <p style="margin-top: 24px;">We're excited to have you in this group! See you in class! üéâ</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_5`,
              name: 'Credit Added',
              subject: 'Credit Added to Your Account',
              body: generateEmailHTML(
                'Credit Added to Your Account',
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>A credit has been added to your ARNOMA account balance:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>Credit Amount:</strong> +$\{{CreditAmount}}</p>
                                <p style="margin: 8px 0;"><strong>Added on:</strong> {{Date}}</p>
                                <p style="margin: 8px 0;"><strong>üìù Note:</strong> {{Notes}}</p>
                            </div>

                            <p>This credit will be automatically applied to future classes. Thank you for your continued participation!</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_6`,
              name: 'Credit Applied',
              subject: 'Credit Applied to Class',
              body: generateEmailHTML(
                'Credit Applied Successfully',
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>A credit has been applied to one of your classes:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>üìÖ Class Date:</strong> {{ClassDate}}</p>
                                <p style="margin: 8px 0;"><strong>üíµ Credit Amount:</strong> $\{{CreditAmount}}</p>
                                <p style="margin: 8px 0;"><strong>üí≥ Payment Status:</strong> <span style="color: #10b981; font-weight: 600;">PAID</span></p>
                            </div>

                            <p>This class is now marked as paid using your account credit. No payment action required!</p>
                            <p style="margin-top: 24px; font-size: 14px; color: #6b7280;">üìä Check your student portal for updated balance information.</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_7`,
              name: 'Credit Edit',
              subject: 'Credit Payment Updated',
              body: generateEmailHTML(
                'Credit Payment Modified',
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>A credit payment on your account has been updated:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>Class Date:</strong> {{ClassDate}}</p>
                                <p style="margin: 8px 0;"><strong>Previous Amount:</strong> <s>$\{{OldAmount}}</s></p>
                                <p style="margin: 8px 0;"><strong>New Amount:</strong> $\{{CreditAmount}}</p>
                                <p style="margin: 8px 0;"><strong>Updated Note:</strong> {{Notes}}</p>
                            </div>

                            <p>Your account balance and payment history have been updated accordingly.</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_8`,
              name: 'Status: Paused',
              subject: 'Your Account Has Been Paused',
              body: generateEmailHTML(
                'Your Account Has Been Paused',
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Your ARNOMA student account status has been changed to <strong>Paused</strong> effective {{Date}}.</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>What this means:</strong></p>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    <li>You won't be charged for upcoming classes</li>
                                    <li>Your spot in the group is temporarily on hold</li>
                                    <li>You can resume anytime by contacting us</li>
                                </ul>
                            </div>

                            <p style="margin-top: 24px;">When you're ready to return, just let us know! We'll be happy to have you back. üíú</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_9`,
              name: 'Status: Active',
              subject: "Welcome Back! You're Active Again",
              body: generateEmailHTML(
                "Welcome Back! You're Active Again",
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Great news! Your ARNOMA student account has been reactivated effective {{Date}}.</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>Your Current Schedule:</strong></p>
                                <p style="margin: 8px 0; font-size: 16px;"><strong>üìÜ {{Schedule}}</strong></p>
                                <p style="margin: 8px 0; color: #6b7280;">(Los Angeles Time)</p>
                                <p style="margin: 12px 0 8px 0;"><strong>üìç Next Class:</strong> {{NextClassDate}}</p>
                            </div>

                            <p style="margin-top: 24px;">We're so happy to have you back! See you in class! üéâ</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_10`,
              name: 'Status: Graduated',
              subject: 'Congratulations Graduate!',
              body: generateEmailHTML(
                "üéì You've Graduated! üéâ",
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>Congratulations! Your ARNOMA student status has been updated to <strong>Graduated</strong> as of {{Date}}.</p>

                            <p style="text-align: center; font-size: 48px; margin: 24px 0;">üéì</p>

                            <p>Thank you for being part of the ARNOMA family! We're incredibly proud of your progress and achievements.</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>What's next?</strong></p>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    <li>Your account will remain in our system for records</li>
                                    <li>You're always welcome to return for advanced classes</li>
                                    <li>Stay in touch ‚Äî we'd love to hear from you!</li>
                                </ul>
                            </div>

                            <p style="margin-top: 32px; text-align: center; font-size: 18px; font-weight: 600;">Best wishes on your journey! üåü</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_11`,
              name: 'Absence Marked',
              subject: 'Absence Recorded for Your Class',
              body: generateEmailHTML(
                'Absence Marked for Class',
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>We've recorded an absence for your class:</p>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>üìÖ Class Date:</strong> {{ClassDate}}</p>
                                <p style="margin: 8px 0;"><strong>üïê Time:</strong> {{ClassTime}} (Los Angeles Time)</p>
                                <p style="margin: 8px 0;"><strong>üìä Status:</strong> <span style="color: #ef4444; font-weight: 600;">ABSENT</span></p>
                            </div>

                            <p><strong>üí° What happens next?</strong></p>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                <li>This absence is now recorded in your attendance history</li>
                                <li>If you pre-paid for this class, no refund is issued per policy</li>
                                <li>Contact us if you'd like to discuss makeup options</li>
                            </ul>

                            <p style="margin-top: 24px;">We hope to see you at the next class! üòä</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_12`,
              name: 'Schedule Change',
              subject: 'Important: Schedule Change Alert',
              body: generateEmailHTML(
                '‚ö†Ô∏è Urgent Schedule Update',
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p><strong>Important:</strong> Your class schedule has been modified. Please review the changes below:</p>

                            <div style="border: 3px solid #ef4444; background: rgba(254,226,226,0.2); border-radius: 16px; padding: 18px; margin: 20px 0;">
                                <p style="margin: 8px 0; color: #ef4444;"><strong>üîÑ Old Schedule</strong></p>
                                <p style="margin: 8px 0; color: #ef4444; text-decoration: line-through;">{{OldSchedule}}</p>
                            </div>

                            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 20px; margin: 24px 0; backdrop-filter: blur(var(--panel-blur));">
                                <p style="margin: 8px 0;"><strong>‚ú® New Schedule</strong></p>
                                <p style="margin: 8px 0; font-size: 18px;"><strong>{{NewSchedule}}</strong></p>
                                <p style="margin: 8px 0; color: #6b7280;">(Los Angeles Time)</p>
                            </div>

                            <p><strong>üìç First Class on New Schedule:</strong> {{NextClassDate}}</p>
                            <p><strong>üìß Questions?</strong> Please reply to this email or contact us directly.</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_13`,
              name: 'Payment Reminder',
              subject: 'üí≥ Payment Reminder',
              body: generateEmailHTML(
                'üí≥ Payment Reminder',
                `
                            <p>Hi <strong>{{StudentName}}</strong>,</p>
                            <p>This is a quick, automated check regarding your recent classes:</p>
                            
                            <div class="info-box">
                                <p><strong>Class Date:</strong> {{ClassDate}}</p>
                                <p><strong>Amount:</strong> ${'$'}{{PricePerClass}}</p>
                            </div>
                            
                            <p>Our records show that your payment hasn't been posted yet.</p>
                            
                            <p><strong>If you have already paid:</strong> Great! Please simply reply with the screenshot of your transfer. That's all we need to update our log and ensure you don't receive any more reminders.</p>
                            
                            <p><strong>If you still plan to pay:</strong> Please submit the payment at your earliest convenience. The system can only process and send your notes once payment is confirmed.</p>
                            
                            <div class="payment-frame">
                                <p style="font-size: 15px; margin: 8px 0;"><strong>ÔøΩ Payment Options</strong></p>
                                <p style="margin: 6px 0;">üì± <strong>Zelle:</strong> 909-808-1818</p>
                                <p style="margin: 6px 0;">üíö <strong>Venmo:</strong> @ARNOMA</p>
                                <p style="margin: 6px 0;">üíµ <strong>Cash:</strong> Accepted in class</p>
                                <img src="https://zlvnxvrzotamhpezqedr.supabase.co/storage/v1/object/public/email-assets/payment-qr.png" alt="Payment QR Code" style="max-width: 200px; margin: 12px auto;">
                            </div>
                            
                            <p>Thank you for your prompt attention to this!</p>
                            ${arnomaSignature}
                        `
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_13`,
              name: 'Payment Reminder',
              subject: 'Payment Reminder',
              body: `<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ARNOMA NCLEX-RN Email</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        margin: 0;
      }

      .email-wrapper {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .email-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .email-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px 30px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .email-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: pulse 15s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      .email-header img {
        width: 120px;
        height: auto;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1)) drop-shadow(0 0 10px rgba(255, 255, 255, 0.6)) drop-shadow(0 0 20px rgba(255, 255, 255, 0.4));
      }

      .email-header h1 {
        color: white;
        font-size: 32px;
        font-weight: 700;
        margin: 0;
        position: relative;
        z-index: 1;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .email-body {
        padding: 40px 30px;
        color: #1f2937;
        line-height: 1.8;
        background: white;
      }

      .email-body p {
        margin: 16px 0;
        font-size: 16px;
        color: #374151;
      }

      .email-body strong {
        color: #764ba2;
        font-weight: 600;
      }

      .info-box {
        background-color: #f6f8fe;
        border-left: 3px solid #3b82f6;
        border-radius: 10px;
        padding: 14px 18px;
        font-size: 15px;
        line-height: 1.5;
        color: #1e293b;
        margin: 20px 0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }

      .info-box p {
        margin: 6px 0;
        text-align: left;
      }

      .payment-instructions {
        background: #f9fafb;
        border-radius: 12px;
        padding: 24px;
        margin: 24px 0;
      }

      .payment-instructions h3 {
        color: #764ba2;
        font-size: 20px;
        margin-bottom: 16px;
        font-weight: 600;
      }

      .payment-instructions p {
        margin: 12px 0;
        color: #4b5563;
      }

      .payment-frame {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        border: 2px solid rgba(118, 75, 162, 0.2);
        border-radius: 16px;
        padding: 32px;
        margin: 32px 0;
        text-align: center;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
      }

      .payment-frame p {
        margin: 12px 0;
        font-size: 18px;
        color: #1f2937;
      }

      .payment-frame img {
        max-width: 240px;
        height: auto;
        margin: 20px auto;
        display: block;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .zelle-number {
        font-size: 24px;
        font-weight: 700;
        color: #764ba2;
        margin: 16px 0;
        letter-spacing: 1px;
      }

      .email-footer {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 32px 30px;
        text-align: center;
        color: white;
      }

      .email-footer img {
        width: 80px;
        height: auto;
        margin-bottom: 16px;
        filter: brightness(0) invert(1);
        opacity: 0.9;
      }

      .email-footer p {
        margin: 8px 0;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.9);
      }

      .email-footer strong {
        color: white;
        font-weight: 600;
      }

      .divider {
        height: 1px;
        background: linear-gradient(to right, transparent, rgba(118, 75, 162, 0.3), transparent);
        margin: 24px 0;
      }

      @media only screen and (max-width: 600px) {
        .email-wrapper {
          padding: 16px;
        }

        .email-header {
          padding: 30px 20px;
        }

        .email-header h1 {
          font-size: 24px;
        }

        .email-body {
          padding: 24px 20px;
        }

        .payment-frame {
          padding: 20px;
        }

        .payment-frame img {
          max-width: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div class="email-wrapper">
      <div class="email-container">
        <!-- Header -->
        <div class="email-header">
          <img
            src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png"
            alt="ARNOMA Logo"
          />
          <h1>Payment Reminder</h1>
        </div>

        <!-- Body -->
        <div class="email-body">
          <p>
            Hello
            <strong>{{StudentName}}</strong>
            ,
          </p>

          <p>This is a quick, automated check regarding your recent classes:</p>

          <div class="info-box">
            <p><strong>{{UnpaidClasses}}</strong></p>
          </div>

          <p>Our records show that your payment hasn't been posted yet.</p>

          <div class="divider"></div>

          <div class="payment-instructions">
            <h3>What to do:</h3>

            <p>
              <strong>If you have already paid:</strong>
              <br />
              Great! Please simply reply with the screenshot of your transfer. That's all we need to update our log and
              ensure you don't receive any more reminders.
            </p>

            <p>
              <strong>If you still plan to pay:</strong>
              <br />
              Please submit the payment at your earliest convenience. The system can only process and send your notes
              once payment is confirmed.
            </p>
          </div>

          <div class="divider"></div>

          <!-- Payment Frame -->
          <div class="payment-frame">
            <p style="font-size: 20px; margin-bottom: 8px">
              <strong>
                Send Money with
                <span style="color: #764ba2">Zelle¬Æ</span>
              </strong>
            </p>
            <p style="font-size: 14px; color: #6b7280; margin-bottom: 20px">Scan in your banking app to pay.</p>

            <p class="zelle-number">909-300-5155</p>

            <img
              src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/Arnoma%20Zelle.JPG"
              alt="Zelle QR Code"
            />

            <p style="font-size: 16px; color: #9ca3af; margin-top: 16px">
              <strong style="color: #764ba2">Zelle</strong>
            </p>
          </div>

          <p style="margin-top: 32px">Thank you for your prompt attention to this!</p>

          <p style="margin-top: 24px">
            Best regards,
            <br />
            <strong style="color: #764ba2">ARNOMA Team</strong>
          </p>
        </div>

        <!-- Footer -->
        <div class="email-footer">
          <img
            src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png"
            alt="ARNOMA Logo"
          />
          <p><strong>ARNOMA ‚Äì NCLEX RN</strong></p>
          <p style="margin-top: 12px">nclex.rn@arnoma.us | richy@arnoma.us | 909-808-1818</p>
          <p style="margin-top: 16px; font-size: 12px; opacity: 0.8">¬© 2025 ARNOMA. All rights reserved.</p>
        </div>
      </div>
    </div>
  </body>
</html>`,
              trigger: 'manual',
              active: true,
            },
          ];
        },

        renderTemplates() {
          const grid = document.getElementById('templatesGrid');

          if (this._templates.length === 0) {
            grid.innerHTML = '';
            return;
          }

          // Render existing templates
          const html = this._templates
            .map(template => {
              const rawBody = template.body_html || template.body || '';
              const isHTML = /<([a-z]+)([^<]+)*(?:>(.*)<\/\1>|\s+\/>)?/i.test(rawBody.trim());
              const bodyPreview = this.getPreviewText(rawBody, isHTML);

              return `
            <div class="template-card">
              <!-- Gradient Accent Strip (row 1) -->
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>

              <!-- Header Section (row 1) -->
              <div style="padding: 28px 24px 18px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 14px;">
                  <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                      <span style="font-size: 26px; flex-shrink: 0;">${template.trigger === 'manual' || template.trigger === 'Manual' ? 'üìß' : template.trigger === 'automatic' || template.trigger === 'Automatic' ? '‚ö°' : 'üéì'}</span>
                      <h3 style="margin: 0; font-size: 17px; font-weight: 700; color: rgba(255,255,255,0.95); line-height: 1.3; overflow: hidden; text-overflow: ellipsis;">${template.name}</h3>
                    </div>
                    <span style="
                      display: inline-block;
                      padding: 5px 14px;
                      background: ${template.trigger === 'automatic' || template.trigger === 'Automatic' ? 'rgba(16,185,129,0.15)' : 'rgba(102,126,234,0.15)'};
                      border: 1px solid ${template.trigger === 'automatic' || template.trigger === 'Automatic' ? 'rgba(16,185,129,0.3)' : 'rgba(102,126,234,0.3)'};
                      border-radius: 20px;
                      font-size: 11px;
                      color: ${template.trigger === 'automatic' || template.trigger === 'Automatic' ? '#10b981' : '#667eea'};
                      text-transform: uppercase;
                      font-weight: 700;
                      letter-spacing: 0.5px;
                    ">${this.getTriggerLabel(template.trigger)}</span>
                  </div>
                  
                  <label style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    cursor: pointer;
                    padding: 10px 14px;
                    background: rgba(255,255,255,0.04);
                    border-radius: 12px;
                    border: 1px solid rgba(255,255,255,0.1);
                    transition: all 0.3s;
                    flex-shrink: 0;
                  " onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='rgba(255,255,255,0.04)'">
                    <input type="checkbox" ${template.active ? 'checked' : ''} onchange="emailSystem.toggleActive('${template.id}')" style="width: 18px; height: 18px; cursor: pointer; margin: 0;">
                    <span style="font-size: 12px; color: rgba(255,255,255,0.7); font-weight: 600;">Active</span>
                  </label>
                </div>

                <!-- Subject -->
                <div style="
                  background: linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08));
                  padding: 14px 16px;
                  border-radius: 12px;
                  border-left: 3px solid #667eea;
                ">
                  <div style="font-weight: 700; color: rgba(255,255,255,0.5); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 7px;">Subject Line</div>
                  <div style="color: rgba(255,255,255,0.95); font-size: 14px; font-weight: 600; line-height: 1.5; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${template.subject}</div>
                </div>
              </div>

              <!-- Content Preview Section (row 2 - flexible) -->
              <div style="padding: 0 24px; display: flex; align-items: stretch;">
                <div style="
                  background: rgba(0,0,0,0.25);
                  padding: 14px 16px;
                  border-radius: 12px;
                  border: 1px solid rgba(255,255,255,0.06);
                  flex: 1;
                  display: flex;
                  flex-direction: column;
                ">
                  <div style="
                    font-weight: 700;
                    color: rgba(255,255,255,0.5);
                    font-size: 10px;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    margin-bottom: 8px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                  ">
                    <span>Content Preview</span>
                    ${isHTML ? '<span style="background: rgba(118,75,162,0.3); padding: 2px 8px; border-radius: 10px; font-size: 9px; color: #a78bfa;">HTML</span>' : ''}
                  </div>
                  <div style="
                    color: rgba(255,255,255,0.65);
                    font-size: 12px;
                    line-height: 1.6;
                    overflow: hidden;
                    display: -webkit-box;
                    -webkit-line-clamp: 4;
                    -webkit-box-orient: vertical;
                  ">
                    ${bodyPreview}
                  </div>
                </div>
              </div>

              <!-- Action Buttons (row 3 - fixed at bottom) -->
              <div style="padding: 18px 24px 24px;">
                <div style="display: grid; grid-template-columns: ${isHTML ? '1fr 1fr 1fr' : '1fr 1fr'}; gap: 10px;">
                  ${isHTML ? `
                  <button onclick="emailSystem.previewTemplate('${template.id}')" style="
                    background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.15));
                    color: #10b981;
                    border: 1.5px solid rgba(16,185,129,0.4);
                    padding: 11px 8px;
                    font-size: 12px;
                    font-weight: 600;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 6px;
                    transition: all 0.3s;
                    border-radius: 10px;
                    cursor: pointer;
                  " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 20px rgba(16,185,129,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                    üëÅÔ∏è Preview
                  </button>
                  ` : ''}
                  <button onclick="emailSystem.editTemplate('${template.id}')" style="
                    background: linear-gradient(135deg, rgba(165,180,252,0.15), rgba(129,140,248,0.15));
                    color: #a5b4fc;
                    border: 1.5px solid rgba(165,180,252,0.4);
                    padding: 11px 8px;
                    font-size: 12px;
                    font-weight: 600;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 6px;
                    transition: all 0.3s;
                    border-radius: 10px;
                    cursor: pointer;
                  " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 20px rgba(165,180,252,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                    ‚úèÔ∏è Edit
                  </button>
                  <button onclick="emailSystem.deleteTemplate('${template.id}')" style="
                    background: linear-gradient(135deg, rgba(248,113,113,0.15), rgba(239,68,68,0.15));
                    color: #f87171;
                    border: 1.5px solid rgba(248,113,113,0.4);
                    padding: 11px 8px;
                    font-size: 12px;
                    font-weight: 600;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 6px;
                    transition: all 0.3s;
                    border-radius: 10px;
                    cursor: pointer;
                  " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 20px rgba(248,113,113,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                    üóëÔ∏è Delete
                  </button>
                </div>
              </div>
            </div>
          `;
            })
            .join('');

          grid.innerHTML = html;
          requestAnimationFrame(() => this.equalizeTemplateCards());
        },

        equalizeTemplateCards() {
          const grid = document.getElementById('templatesGrid');
          if (!grid) return;

          const cards = grid.querySelectorAll('.template-card');
          if (!cards.length) return;

          let tallest = 0;
          cards.forEach(card => {
            card.style.height = 'auto';
            tallest = Math.max(tallest, card.offsetHeight);
          });

          cards.forEach(card => {
            card.style.height = `${tallest}px`;
          });
        },

        getPreviewText(content = '', isHTML = false) {
          if (!content) return '';

          let text = content;
          if (isHTML) {
            const temp = document.createElement('div');
            temp.innerHTML = content;
            text = temp.textContent || temp.innerText || '';
          }

          text = text
            .replace(/\s+/g, ' ')
            .replace(/&nbsp;/gi, ' ')
            .trim();

          if (text.length > 220) {
            text = `${text.substring(0, 217).trim()}...`;
          }

          return text;
        },

        getTriggerLabel(trigger) {
          const labels = {
            manual: 'Manual Send',
            automatic: 'Automatic',
            new_student: 'New Student',
            student_created: 'Student Created',
            before_class: 'Before Class',
            after_class: 'After Class',
            payment_due: 'Payment Due',
            countdown: 'Countdown',
          };
          return labels[trigger] || trigger;
        },

        toggleActive(id) {
          const template = this._templates.find(t => t.id === id);
          if (template) {
            template.active = !template.active;
            this.saveTemplates();
            this.renderTemplates();
            debugLog(`‚úÖ Template ${template.active ? 'activated' : 'deactivated'}`);
          }
        },

        editTemplate(id) {
          const template = this._templates.find(t => t.id === id);
          if (!template) return;

          debugLog('‚úèÔ∏è Editing template:', template.name);
          // TODO: Wire up to actual form
          openEditor();
        },

        async deleteTemplate(id) {
          const confirmed = await showDesignConfirm({
            title: 'Delete template?',
            message: 'This template will be removed from your workspace.',
            confirmText: 'Delete',
            confirmVariant: 'danger',
          });

          if (!confirmed) return;

          this._templates = this._templates.filter(t => t.id !== id);
          this.saveTemplates();
          this.renderTemplates();
          debugLog('üóëÔ∏è Template deleted');
        },

        editTemplate(id) {
          const template = this._templates.find(t => t.id === id);
          if (!template) {
            console.error('Template not found:', id);
            return;
          }

          debugLog('‚úèÔ∏è Editing template:', template.name);

          // Populate the editor form
          document.getElementById('templateName').value = template.name || '';
          document.getElementById('templateSubject').value = template.subject || '';
          document.getElementById('htmlBodyEditor').value = template.body_html || template.body || '';
          document.getElementById('templateTrigger').value = template.trigger_type || template.trigger || 'Manual';

          // Store the template ID for saving later
          document.getElementById('editorModal').dataset.editingId = id;

          // Update the preview
          updatePreview();

          // Open the editor modal
          openEditor();
        },

        previewTemplate(id) {
          const template = this._templates.find(t => t.id === id);
          if (!template) return;

          // Replace variables with sample data
          let previewHTML = template.body
            .replace(/\{\{StudentName\}\}/g, 'John Doe')
            .replace(/\{\{Group\}\}/g, 'Group A - Monday 6PM')
            .replace(/\{\{GroupName\}\}/g, 'Group A')
            .replace(/\{\{GroupSchedule\}\}/g, 'Monday & Wednesday ‚Äî 8:00 PM (Los Angeles Time)')
            .replace(/\{\{NextClass\}\}/g, 'Monday, November 11, 2025')
            .replace(/\{\{ClassTime\}\}/g, '6:00 PM PST')
            .replace(/\{\{ClassDate\}\}/g, 'November 11, 2025')
            .replace(/\{\{TimeOfDay\}\}/g, 'tonight')
            .replace(/\{\{PaymentAmount\}\}/g, '$120.00')
            .replace(/\{\{UnpaidClasses\}\}/g, 'Nov 4, Nov 6, Nov 8 (3 classes)')
            .replace(/\{\{PaymentMessage\}\}/g, '<p>Your payment is confirmed. See you in class!</p>')
            .replace(/\{\{ZoomLink\}\}/g, 'https://zoom.us/j/1234567890');

          // Open preview in modal
          const iframe = document.getElementById('previewFrame');
          iframe.srcdoc = previewHTML;
          openPreview();
        },

        // ============================================================
        // SENT EMAILS TRACKING (SUPABASE)
        // ============================================================
        async loadSentEmails() {
          if (!supabase) {
            console.error('‚ùå Supabase not initialized for sent emails');
            this._sentEmails = [];
            return;
          }

          try {
            const { data, error } = await supabase
              .from('sent_emails')
              .select('*')
              .order('sent_at', { ascending: false })
              .limit(500);

            if (error) throw error;

            if (data) {
              this._sentEmails = data.map(email => ({
                id: email.id,
                timestamp: email.sent_at,
                to: email.recipient_email || email.recipient,  // Use correct column name
                subject: email.subject,
                html: email.html_content || email.body_html || email.body_text,  // Try all variants
                status: email.status || 'sent',
                templateName: email.template_name,
                type: email.email_type || 'manual',
                resendId: email.resend_id || null,
                deliveryStatus: email.delivery_status || 'unknown'
              }));
              debugLog(`‚úÖ Loaded ${this._sentEmails.length} sent emails from Supabase`);
            } else {
              this._sentEmails = [];
            }
          } catch (e) {
            console.error('‚ùå Error loading sent emails from Supabase:', e);
            this._sentEmails = [];
          }
        },

        async saveSentEmails() {
          // Sent emails are saved individually via addSentEmail, no batch save needed
          return true;
        },

        async addSentEmail(emailData) {
          if (!supabase) {
            console.error('‚ùå Supabase not initialized');
            return null;
          }

          // Use correct column names for sent_emails table
          const sentEmail = {
            recipient_email: emailData.to,  // FIXED: was 'recipient'
            recipient_name: emailData.recipientName || emailData.to,
            subject: emailData.subject,
            html_content: emailData.html,  // FIXED: was 'body_html'
            status: emailData.status || 'sent',
            template_name: emailData.templateName,
            email_type: emailData.type || 'manual',
            resend_id: emailData.resendId || null,
            delivery_status: emailData.deliveryStatus || 'unknown',
            sent_at: new Date().toISOString()
          };

          try {
            // 1. Log to sent_emails table
            const { data, error } = await supabase
              .from('sent_emails')
              .insert([sentEmail])
              .select();

            if (error) throw error;

            debugLog('‚úÖ Sent email logged to Supabase:', data[0]);
            
            // 2. Log to notifications table (for Notification Center bell)
            try {
              const notificationRecord = {
                type: 'email_sent',
                category: 'email',
                title: `Email Sent: ${emailData.templateName || 'Custom Email'}`,
                description: `Sent to ${emailData.to} - ${emailData.subject}`,
                student_name: emailData.recipientName || null,
                metadata: {
                  email: emailData.to,
                  email_type: emailData.type || 'manual',
                  subject: emailData.subject,
                  html: emailData.html,
                  template_name: emailData.templateName
                },
                timestamp: new Date().toISOString(),
                read: false,
                created_at: new Date().toISOString()
              };
              
              const { error: notifError } = await supabase.from('notifications').insert([notificationRecord]);
              if (notifError) console.error('‚ö†Ô∏è Failed to log notification:', notifError);
            } catch (notifErr) {
              console.error('‚ö†Ô∏è Error logging notification (email still logged):', notifErr);
            }

            // Add to local array for immediate UI update
            this._sentEmails.unshift({
              id: data[0].id,
              timestamp: data[0].sent_at,
              to: data[0].recipient_email,  // FIXED: was 'recipient'
              subject: data[0].subject,
              html: data[0].html_content,  // FIXED: was 'body_html'
              status: data[0].status,
              templateName: data[0].template_name,
              type: data[0].email_type || 'manual',
              resendId: data[0].resend_id || null,
              deliveryStatus: data[0].delivery_status || 'unknown'
            });

            // Keep only last 500 in memory
            if (this._sentEmails.length > 500) {
              this._sentEmails = this._sentEmails.slice(0, 500);
            }

            this.renderSentEmails();
            return data[0];
          } catch (e) {
            console.error('‚ùå Error saving sent email to Supabase:', e);
            return null;
          }
        },

        // LEGACY: Remove old method, now handled in addSentEmail above
        /*
        addSentEmail(emailData) {
          const sentEmail = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            to: emailData.to,
            subject: emailData.subject,
            html: emailData.html,
            status: emailData.status || 'sent',
            resendId: emailData.resendId || null,
            deliveryStatus: emailData.deliveryStatus || 'unknown',
            templateName: emailData.templateName || 'Unknown',
            type: emailData.type || 'test',
            responseData: emailData.responseData || null,
          };

          this._sentEmails.unshift(sentEmail); // Add to beginning
          this.saveSentEmails();
          this.renderSentEmails();

          debugLog('üìß Sent email tracked:', sentEmail);

          // Fetch delivery status from Resend if we have an ID
          if (sentEmail.resendId) {
            this.checkDeliveryStatus(sentEmail.id, sentEmail.resendId);
          }

          return sentEmail;
        },
        */

        async checkDeliveryStatus(emailId, resendId) {
          try {
            // ============================================================
            // üîß RESEND API KEY CONFIGURED
            // ============================================================
            // Get from: https://resend.com/api-keys
            // ============================================================
            const RESEND_API_KEY = 're_C5EFCsXD_DU4fX9oysRKRNkv3KrcYoBPd';

            if (RESEND_API_KEY === 'YOUR_RESEND_API_KEY_HERE') {
              debugLog('‚ö†Ô∏è Resend API key not configured, skipping delivery status check');
              return;
            }

            const response = await fetch(`https://api.resend.com/emails/${resendId}`, {
              method: 'GET',
              headers: {
                Authorization: `Bearer ${RESEND_API_KEY}`,
                'Content-Type': 'application/json',
              },
            });

            if (response.ok) {
              const statusData = await response.json();
              debugLog('üìä Resend delivery status:', statusData);

              // Update email with delivery status
              const email = this._sentEmails.find(e => e.id === emailId);
              if (email) {
                email.deliveryStatus = statusData.last_event || statusData.status || 'unknown';
                email.deliveryData = statusData;
                this.saveSentEmails();
                this.renderSentEmails();
              }
            }
          } catch (error) {
            console.error('Error checking delivery status:', error);
          }
        },

        renderSentEmails() {
          const container = document.querySelector('#sentEmailsModal .modal-body');
          if (!container) return;

          if (this._sentEmails.length === 0) {
            container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.4);">
                            <div style="font-size: 64px; margin-bottom: 16px;">üì≠</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No Emails Sent Yet</div>
                            <div style="font-size: 14px;">Sent emails will appear here with full HTML preserved</div>
                        </div>
                    `;
            return;
          }

          const html = this._sentEmails
            .map(email => {
              const date = new Date(email.timestamp);
              const dateStr = date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
              });

              const statusColor = email.status === 'sent' ? '#10b981' : '#ef4444';
              const statusIcon = email.status === 'sent' ? '‚úì' : '‚úó';

              // Delivery status badge
              const deliveryStatusConfig = {
                delivered: { color: '#10b981', icon: '‚úì', label: 'Delivered' },
                sent: { color: '#3b82f6', icon: 'üì§', label: 'Sent' },
                pending: { color: '#f59e0b', icon: '‚è≥', label: 'Pending' },
                bounced: { color: '#ef4444', icon: '‚ö†Ô∏è', label: 'Bounced' },
                complained: { color: '#dc2626', icon: 'üö´', label: 'Complained' },
                unknown: { color: '#6b7280', icon: '‚ùì', label: 'Unknown' },
              };
              const deliveryConfig = deliveryStatusConfig[email.deliveryStatus] || deliveryStatusConfig.unknown;

              // Extract text preview from HTML
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = email.html;
              const textPreview = tempDiv.textContent.substring(0, 150).trim() + '...';

              return `
                        <div class="sent-email-card" style="background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); backdrop-filter: blur(var(--panel-blur)); -webkit-backdrop-filter: blur(var(--panel-blur)); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 20px; margin-bottom: 16px; transition: transform 0.2s ease, border-color 0.2s ease; will-change: transform;">
                            <!-- Header -->
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 14px;">
                                <div style="flex: 1;">
                                    <div style="color: rgba(255,255,255,0.95); font-size: 16px; font-weight: 600; margin-bottom: 4px;">${email.subject}</div>
                                    <div style="color: rgba(255,255,255,0.5); font-size: 12px;">To: ${email.to}</div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                    <div style="background: rgba(${statusColor === '#10b981' ? '16,185,129' : '239,68,68'},0.15); color: ${statusColor}; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                        ${statusIcon} ${email.status.toUpperCase()}
                                    </div>
                                    ${
                                      email.resendId
                                        ? `
                                        <div style="background: rgba(${deliveryConfig.color === '#10b981' ? '16,185,129' : deliveryConfig.color === '#3b82f6' ? '59,130,246' : deliveryConfig.color === '#f59e0b' ? '245,158,11' : deliveryConfig.color === '#ef4444' ? '239,68,68' : '107,114,128'},0.15); color: ${deliveryConfig.color}; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                            ${deliveryConfig.icon} ${deliveryConfig.label}
                                        </div>
                                    `
                                        : ''
                                    }
                                </div>
                            </div>

                            <!-- Email Body Preview -->
                            <div style="background: rgba(0,0,0,0.25); backdrop-filter: blur(var(--panel-blur)); padding: 12px 14px; border-radius: 10px; margin-bottom: 14px; border: 1px solid rgba(255,255,255,0.06);">
                                <div style="font-weight: 700; color: rgba(255,255,255,0.6); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">
                                    üìÑ Email Body Preview
                                </div>
                                <div style="color: rgba(255,255,255,0.65); font-size: 12px; line-height: 1.6; max-height: 48px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                    ${textPreview}
                                </div>
                            </div>

                            <!-- Metadata -->
                            <div style="display: grid; grid-template-columns: repeat(${email.resendId ? '4' : '3'}, 1fr); gap: 12px; margin-bottom: 14px;">
                                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
                                    <div style="color: rgba(255,255,255,0.5); font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Date</div>
                                    <div style="color: rgba(255,255,255,0.9); font-size: 12px; font-weight: 600;">${dateStr}</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
                                    <div style="color: rgba(255,255,255,0.5); font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Template</div>
                                    <div style="color: rgba(255,255,255,0.9); font-size: 12px; font-weight: 600;">${email.templateName}</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
                                    <div style="color: rgba(255,255,255,0.5); font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Type</div>
                                    <div style="color: rgba(255,255,255,0.9); font-size: 12px; font-weight: 600;">${email.type}</div>
                                </div>
                                ${
                                  email.resendId
                                    ? `
                                    <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
                                        <div style="color: rgba(255,255,255,0.5); font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Resend ID</div>
                                        <div style="color: rgba(255,255,255,0.9); font-size: 11px; font-weight: 600; font-family: monospace;">${email.resendId.substring(0, 8)}...</div>
                                    </div>
                                `
                                    : ''
                                }
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: grid; grid-template-columns: ${email.resendId ? '1fr 1fr 1fr' : '1fr 1fr'}; gap: 10px;">
                                <button onclick="emailSystem.viewSentEmail('${email.id}')" class="btn" style="background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15)); color: #a5b4fc; border: 1.5px solid rgba(102,126,234,0.4); padding: 10px; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                    <span style="font-size: 16px;">üëÅÔ∏è</span> View Email
                                </button>
                                ${
                                  email.resendId
                                    ? `
                                    <button onclick="emailSystem.refreshDeliveryStatus('${email.id}', '${email.resendId}')" class="btn" style="background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.15)); color: #60a5fa; border: 1.5px solid rgba(59,130,246,0.4); padding: 10px; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                        <span style="font-size: 16px;">üîÑ</span> Refresh Status
                                    </button>
                                `
                                    : ''
                                }
                                <button onclick="emailSystem.deleteSentEmail('${email.id}')" class="btn" style="background: linear-gradient(135deg, rgba(248,113,113,0.15), rgba(239,68,68,0.15)); color: #f87171; border: 1.5px solid rgba(248,113,113,0.4); padding: 10px; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                    <span style="font-size: 16px;">üóëÔ∏è</span> Delete
                                </button>
                            </div>
                        </div>
                    `;
            })
            .join('');

          container.innerHTML = html;
        },

        viewSentEmail(id) {
          const email = this._sentEmails.find(e => e.id === parseInt(id));
          if (!email) return;

          const iframe = document.getElementById('previewFrame');
          iframe.srcdoc = email.html;
          openPreview();
          closeSentEmails();
        },

        async refreshDeliveryStatus(emailId, resendId) {
          debugLog(`üîÑ Refreshing delivery status for email ${emailId}...`);
          await this.checkDeliveryStatus(parseInt(emailId), resendId);
        },

        async deleteSentEmail(id) {
          const confirmed = await showDesignConfirm({
            title: 'Delete sent email?',
            message: 'This record will be removed from history.',
            confirmText: 'Delete',
            confirmVariant: 'danger',
          });

          if (!confirmed) return;

          this._sentEmails = this._sentEmails.filter(e => e.id !== parseInt(id));
          this.saveSentEmails();
          this.renderSentEmails();
          debugLog('üóëÔ∏è Sent email deleted:', id);
        },

        async clearAllSentEmails() {
          const confirmed = await showDesignConfirm({
            title: 'Delete all records?',
            message: 'This action removes every sent email log and cannot be undone.',
            confirmText: 'Delete All',
            confirmVariant: 'danger',
          });

          if (!confirmed) return;

          this._sentEmails = [];
          this.saveSentEmails();
          this.renderSentEmails();
          debugLog('üóëÔ∏è All sent emails cleared');
        },
      };

      // ============================================================
      // AUTOMATION ENGINE (UNIVERSAL TRIGGER SYSTEM)
      // ============================================================
      const automationEngine = {
        _automations: [],

        triggers: {
          interval: {
            interval_minute: { label: 'Every N Minutes', params: ['minutes'] },
            interval_hour: { label: 'Every N Hours', params: ['hours'] },
            interval_day: { label: 'Daily at Specific Time', params: ['time'] },
            interval_week: { label: 'Weekly', params: ['dayOfWeek', 'time'] },
            interval_month: { label: 'Monthly', params: ['dayOfMonth', 'time'] },
            interval_specific_date: { label: 'One-Time Future Date', params: ['date', 'time'] },
            before_class_timer: { label: 'Before Class Timer', params: ['minutesBefore', 'groupFilter'] },
            after_class_timer: { label: 'After Class Timer', params: ['minutesAfter', 'groupFilter'] },
            developer_custom_interval: { label: 'Custom Cron Expression', params: ['cronExpression'] },
          },
          system: {
            system_startup: { label: 'System Startup', params: [] },
            system_midnight_rollover: { label: 'Midnight Rollover', params: [] },
            system_timezone_shift: { label: 'Timezone Shift Detected', params: [] },
            system_data_refresh: { label: 'Data Refresh from Parent', params: [] },
          },
          student: {
            student_added: { label: 'Student Added', params: [] },
            student_updated: { label: 'Student Updated', params: ['fields'] },
            student_removed: { label: 'Student Removed', params: [] },
            student_status_changed: { label: 'Status Changed', params: ['fromStatus', 'toStatus'] },
            student_group_changed: { label: 'Group Changed', params: ['fromGroup', 'toGroup'] },
            student_email_changed: { label: 'Email Changed', params: [] },
            student_profile_updated: { label: 'Profile Updated', params: [] },
            student_alias_added: { label: 'Alias Added', params: [] },
            student_schedule_changed: { label: 'Schedule Changed', params: [] },
          },
          payment: {
            payment_received: { label: 'Payment Received', params: [] },
            payment_missing: { label: 'Payment Missing', params: ['daysPast'] },
            payment_upcoming: { label: 'Payment Upcoming', params: ['daysBefore'] },
            payment_credit_added: { label: 'Credit Added', params: [] },
            payment_credit_used: { label: 'Credit Used', params: [] },
            payment_credit_edited: { label: 'Credit Edited', params: [] },
            payment_price_changed: { label: 'Price Changed', params: ['oldPrice', 'newPrice'] },
            payment_balance_low: { label: 'Balance Low', params: ['threshold'] },
            payment_balance_negative: { label: 'Balance Negative', params: [] },
          },
          class: {
            before_class: { label: 'Before Class', params: ['minutesBefore'] },
            after_class: { label: 'After Class', params: ['minutesAfter'] },
            class_start: { label: 'Class Start', params: [] },
            class_end: { label: 'Class End', params: [] },
            class_canceled: { label: 'Class Canceled', params: ['reason'] },
            class_rescheduled: { label: 'Class Rescheduled', params: ['oldDate', 'newDate'] },
            class_upcoming_for_group: { label: 'Upcoming for Specific Group', params: ['groupName'] },
          },
          attendance: {
            absence_recorded: { label: 'Absence Recorded', params: [] },
            absence_repeated: { label: 'Repeated Absences', params: ['count', 'days'] },
            absence_first_time: { label: 'First-Time Absence', params: [] },
            low_activity: { label: 'Low Activity', params: ['days'] },
            high_activity: { label: 'High Activity', params: [] },
          },
          communication: {
            manual_trigger: { label: 'Manual Trigger', params: [] },
            template_trigger: { label: 'Template Updated', params: ['templateId'] },
            custom_event: { label: 'Custom Event', params: ['eventName'] },
          },
          webhook: {
            supabase_row_insert: { label: 'Row Inserted', params: ['tableName'] },
            supabase_row_update: { label: 'Row Updated', params: ['tableName', 'columnName'] },
            supabase_row_delete: { label: 'Row Deleted', params: ['tableName'] },
            supabase_function_call: { label: 'Edge Function Called', params: ['functionName'] },
            supabase_realtime_change: { label: 'Realtime Change Detected', params: ['tableName'] },
          },
          developer: {
            developer_custom_event: { label: 'Custom Event', params: ['eventName', 'eventData'] },
            developer_script: { label: 'Custom Script', params: ['scriptName'] },
            developer_api_trigger: { label: 'API Trigger', params: ['endpoint', 'method'] },
          },
        },

        buildTriggerIdentifier(category, type, fallbackValue) {
          if (category && type) {
            return `${category}:${type}`;
          }
          if (type) return type;
          if (fallbackValue) return fallbackValue;
          return 'manual_trigger';
        },

        findTriggerCategory(type) {
          if (!type) return '';
          for (const [category, triggers] of Object.entries(this.triggers)) {
            if (triggers[type]) return category;
          }
          return '';
        },

        resolveTriggerMetadata(rawValue, storedCategory, storedType) {
          let category = storedCategory || '';
          let type = storedType || '';

          if (!type && typeof rawValue === 'string') {
            if (rawValue.includes(':')) {
              const [cat, sub] = rawValue.split(':');
              category = category || cat;
              type = sub || type;
            } else if (rawValue.includes('.')) {
              const [cat, sub] = rawValue.split('.');
              category = category || cat;
              type = sub || type;
            } else if (rawValue.includes('_')) {
              const [cat, ...rest] = rawValue.split('_');
              category = category || cat;
              type = rest.length > 0 ? rest.join('_') : type || cat;
            } else {
              type = rawValue;
            }
          }

          if (!category && type) {
            category = this.findTriggerCategory(type) || 'manual';
          }

          if (category && (!this.triggers[category] || !this.triggers[category][type])) {
            const fallbackCategory = this.findTriggerCategory(type);
            if (fallbackCategory) {
              category = fallbackCategory;
            }
          }

          return {
            category: category || '',
            type: type || rawValue || '',
          };
        },

        deserializeStoredSettings(storedConditions) {
          const defaults = {
            conditions: [],
            triggerParams: {},
            recipients: 'all_active',
            recipientOptions: {},
            runOnce: false,
            rateLimited: false,
            priority: 'normal',
            maxRetries: 3,
            confirmBeforeSend: false,
            triggerCategory: '',
            triggerType: '',
          };

          if (!storedConditions) {
            return defaults;
          }

          if (Array.isArray(storedConditions)) {
            return {
              ...defaults,
              conditions: storedConditions,
            };
          }

          if (typeof storedConditions === 'object') {
            return {
              conditions: Array.isArray(storedConditions.rules)
                ? storedConditions.rules
                : Array.isArray(storedConditions.conditions)
                  ? storedConditions.conditions
                  : defaults.conditions,
              triggerParams: storedConditions.triggerParams || storedConditions.params || defaults.triggerParams,
              recipients: storedConditions.recipients || defaults.recipients,
              recipientOptions: storedConditions.recipientOptions || defaults.recipientOptions,
              runOnce: storedConditions.runOnce ?? defaults.runOnce,
              rateLimited: storedConditions.rateLimited ?? defaults.rateLimited,
              priority: storedConditions.priority || defaults.priority,
              maxRetries: storedConditions.maxRetries ?? defaults.maxRetries,
              confirmBeforeSend: storedConditions.confirmBeforeSend ?? defaults.confirmBeforeSend,
              triggerCategory: storedConditions.triggerCategory || defaults.triggerCategory,
              triggerType: storedConditions.triggerType || defaults.triggerType,
            };
          }

          return defaults;
        },

        async init() {
          await this.loadAutomations();
          this.renderAutomations();
        },

        async loadAutomations() {
          if (!supabase) {
            console.error('‚ùå Supabase not initialized for automations');
            this._automations = [];
            return;
          }

          try {
            const { data, error } = await supabase
              .from('automations')
              .select(`
                *,
                email_templates (
                  id,
                  name,
                  subject,
                  body_html,
                  trigger_category,
                  trigger_type
                )
              `)
              .order('created_at', { ascending: true });

            if (error) throw error;

            if (data) {
              this._automations = data.map(auto => {
                const storedSettings = this.deserializeStoredSettings(auto.conditions);
                const triggerMeta = this.resolveTriggerMetadata(
                  auto.trigger_type,
                  storedSettings.triggerCategory,
                  storedSettings.triggerType
                );
                const triggerIdentifier = this.buildTriggerIdentifier(
                  triggerMeta.category,
                  triggerMeta.type,
                  auto.trigger_type
                );

                return {
                  id: auto.id?.toString(),
                  name: auto.name,
                  description: auto.description || '',
                  trigger: triggerIdentifier,
                  triggerCategory: triggerMeta.category,
                  triggerType: triggerMeta.type,
                  templateId: auto.template_id?.toString() || '',
                  template: auto.email_templates || null, // Include full template data
                  triggerParams: storedSettings.triggerParams,
                  recipients: storedSettings.recipients,
                  recipientOptions: storedSettings.recipientOptions,
                  active: auto.active !== false,
                  conditions: storedSettings.conditions,
                  runOnce: storedSettings.runOnce,
                  rateLimited: storedSettings.rateLimited,
                  priority: storedSettings.priority,
                  maxRetries: storedSettings.maxRetries,
                  confirmBeforeSend: storedSettings.confirmBeforeSend,
                  lastRun: auto.last_run,
                  runCount: auto.run_count || 0,
                  createdAt: auto.created_at,
                };
              });
              debugLog(`‚úÖ Loaded ${this._automations.length} automations from Supabase`);
            } else {
              this._automations = [];
            }
          } catch (e) {
            console.error('‚ùå Error loading automations from Supabase:', e);
            this._automations = [];
          }
        },

        async saveAutomations() {
          if (!supabase) {
            console.error('‚ùå Supabase not initialized');
            return false;
          }

          try {
            // Sync all automations to Supabase
            for (const automation of this._automations) {
              const numericId = Number.isFinite(Number(automation.id)) ? Number(automation.id) : null;
              const triggerIdentifier = this.buildTriggerIdentifier(
                automation.triggerCategory,
                automation.triggerType,
                automation.trigger
              );
              const normalizedConditions = {
                version: 'v2',
                rules: automation.conditions || [],
                triggerParams: automation.triggerParams || {},
                recipients: automation.recipients || 'all_active',
                recipientOptions: automation.recipientOptions || {},
                runOnce: automation.runOnce || false,
                rateLimited: automation.rateLimited || false,
                priority: automation.priority || 'normal',
                maxRetries: Number.isFinite(Number(automation.maxRetries)) ? Number(automation.maxRetries) : 3,
                confirmBeforeSend: automation.confirmBeforeSend || false,
                triggerCategory: automation.triggerCategory || '',
                triggerType: automation.triggerType || '',
              };
              // Keep template_id as string (UUID) - don't convert to number
              const templateId = automation.templateId || null;

              const automationData = {
                name: automation.name,
                description: automation.description || null,
                trigger_type: triggerIdentifier,
                template_id: templateId,
                active: automation.active !== false,
                conditions: normalizedConditions,
                last_run: automation.lastRun || null,
                run_count: automation.runCount || 0
              };

              // Only include id for existing automations (updates)
              if (numericId !== null) {
                automationData.id = numericId;
              }

              const { data, error } = await supabase
                .from('automations')
                .upsert(automationData, { onConflict: 'id' })
                .select();

              if (error) {
                console.error(`‚ùå Error saving automation "${automation.name}":`, error);
                console.error('Full error details:', JSON.stringify(error, null, 2));
                throw error; // Propagate error to stop save process
              } else if (Array.isArray(data) && data.length > 0) {
                const saved = data[0];
                if (saved?.id && automation.id !== saved.id.toString()) {
                  automation.id = saved.id.toString();
                  debugLog(`‚úÖ Automation "${automation.name}" saved with ID: ${saved.id}`);
                }
              }
            }

            debugLog('‚úÖ Automations synced to Supabase');
            return true;
          } catch (e) {
            console.error('‚ùå Error saving automations to Supabase:', e);
            return false;
          }
        },

        renderAutomations() {
          const grid = document.getElementById('automationsGrid');

          if (this._automations.length === 0) {
            grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ü§ñ</div>
                            <div>No automations configured yet</div>
                        </div>
                    `;
            return;
          }

          grid.innerHTML = this._automations
            .map(auto => {
              // Try Supabase templates first, fallback to localStorage
              let template = auto.template || TemplateManager.getTemplate(auto.templateId);
              if (!template) {
                template = emailSystem._templates.find(t => t.id === auto.templateId);
              }
              const templateName = template ? template.name : 'No Template';
              const hasTemplate = !!template;

              return `
                        <div class="template-card" style="padding: 20px; ${!auto.active ? 'opacity: 0.5;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 6px 0; font-size: 17px; color: rgba(255,255,255,0.95);">${auto.name}</h3>
                                    ${auto.description ? `<p style="margin: 0; font-size: 13px; color: rgba(255,255,255,0.5);">${auto.description}</p>` : ''}
                                </div>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                    <input type="checkbox" ${auto.active ? 'checked' : ''} onchange="automationEngine.toggleActive('${auto.id}')" style="width: 18px; height: 18px;">
                                    <span style="font-size: 12px; color: rgba(255,255,255,0.6);">Active</span>
                                </label>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                <div style="background: rgba(102,126,234,0.1); padding: 12px; border-radius: 10px; border-left: 3px solid #667eea;">
                                    <div style="font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Trigger</div>
                                    <div style="color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 600;">${this.getTriggerLabel(auto.triggerCategory, auto.triggerType)}</div>
                                </div>
                                <div style="background: rgba(118,75,162,0.1); padding: 12px; border-radius: 10px; border-left: 3px solid #764ba2;">
                                    <div style="font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Template</div>
                                    <div style="color: ${hasTemplate ? 'rgba(255,255,255,0.9)' : 'rgba(248,113,113,0.9)'}; font-size: 13px; font-weight: 600;">${templateName}</div>
                                </div>
                            </div>

                            ${
                              auto.triggerParams && Object.keys(auto.triggerParams).length > 0
                                ? `
                                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 16px;">
                                    <div style="font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">Parameters</div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                                        ${Object.entries(auto.triggerParams)
                                          .map(
                                            ([key, val]) =>
                                              `<span style="display: inline-block; margin-right: 12px;"><strong>${key}:</strong> ${val}</span>`
                                          )
                                          .join('')}
                                    </div>
                                </div>
                            `
                                : ''
                            }

                            <div style="display: flex; gap: 8px;">
                                ${hasTemplate ? `<button onclick="automationEngine.previewTemplate('${auto.id}')" class="btn" style="flex: 1; background: rgba(139,92,246,.2); color: #a78bfa; border: 2px solid rgba(139,92,246,.4); padding: 10px; font-size: 13px;">
                                    üëÅÔ∏è Preview
                                </button>` : ''}
                                <button onclick="automationEngine.editAutomation('${auto.id}')" class="btn" style="flex: 1; background: rgba(165,180,252,.2); color: #a5b4fc; border: 2px solid rgba(165,180,252,.4); padding: 10px; font-size: 13px;">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button onclick="automationEngine.testAutomation('${auto.id}')" class="btn" style="flex: 1; background: rgba(74,222,128,.2); color: #4ade80; border: 2px solid rgba(74,222,128,.4); padding: 10px; font-size: 13px;">
                                    üß™ Test
                                </button>
                                <button onclick="automationEngine.deleteAutomation('${auto.id}')" class="btn" style="flex: 1; background: rgba(248,113,113,.2); color: #f87171; border: 2px solid rgba(248,113,113,.4); padding: 10px; font-size: 13px;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `;
            })
            .join('');
        },

        getTriggerLabel(category, type) {
          if (!category || !type) return 'Unknown';
          const trigger = this.triggers[category]?.[type];
          return trigger ? trigger.label : type;
        },

        async toggleActive(id) {
          const auto = this._automations.find(a => a.id === id);
          if (!auto) return;

          const newState = !auto.active;
          const confirmed = await showDesignConfirm({
            title: newState ? 'Activate automation?' : 'Pause automation?',
            message: newState
              ? `"${auto.name}" will start running automatically whenever its trigger conditions are met.`
              : `"${auto.name}" will stop running until you turn it back on.`,
            confirmText: newState ? 'Activate' : 'Pause',
            confirmVariant: newState ? 'primary' : 'danger',
          });

          if (!confirmed) {
            this.renderAutomations();
            return;
          }

          auto.active = newState;
          this.saveAutomations();
          this.renderAutomations();
          debugLog(`${auto.active ? '‚úÖ' : '‚è∏Ô∏è'} Automation ${auto.active ? 'activated' : 'paused'}`);
        },

        editAutomation(id) {
          const auto = this._automations.find(a => a.id === id);
          if (!auto) return;

          document.getElementById('automationId').value = id;
          document.getElementById('automationName').value = auto.name;
          document.getElementById('automationDescription').value = auto.description || '';
          document.getElementById('automationTemplate').value = auto.templateId;
          document.getElementById('triggerCategory').value = auto.triggerCategory;
          document.getElementById('automationRecipients').value = auto.recipients || 'all_active';
          document.getElementById('automationActive').checked = auto.active;
          document.getElementById('automationRunOnce').checked = !!auto.runOnce;
          document.getElementById('automationRateLimited').checked = !!auto.rateLimited;
          document.getElementById('automationPriority').value = auto.priority || 'normal';
          document.getElementById('automationMaxRetries').value = auto.maxRetries ?? 3;
          document.getElementById('automationConfirmSend').checked = !!auto.confirmBeforeSend;

          updateTriggerOptions();
          document.getElementById('triggerType').value = auto.triggerType;
          updateTriggerParams();

          if (auto.triggerParams) {
            Object.entries(auto.triggerParams).forEach(([key, val]) => {
              const input = document.getElementById(`param_${key}`);
              if (input) input.value = val;
            });
          }

          document.getElementById('automationModalTitle').textContent = '‚úèÔ∏è Edit Automation';
          openAutomationEditor();
        },

        previewTemplate(id) {
          const auto = this._automations.find(a => a.id === id);
          if (!auto || !auto.template) {
            showDesignAlert({
              title: 'No Template',
              message: 'This automation does not have a template assigned.',
              variant: 'error'
            });
            return;
          }

          const template = auto.template;
          
          // Create preview modal
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(var(--panel-blur));
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
          `;

          modal.innerHTML = `
            <div style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); border-radius: 24px; max-width: 800px; width: 100%; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); border: 2px solid rgba(139,92,246,0.3);">
              <div style="padding: 24px; border-bottom: 2px solid rgba(139,92,246,0.2); display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h2 style="margin: 0; font-size: 24px; background: linear-gradient(135deg, #a78bfa, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    üëÅÔ∏è Email Preview
                  </h2>
                  <p style="margin: 8px 0 0 0; color: rgba(255,255,255,0.6); font-size: 14px;">
                    ${auto.name} ‚Üí ${template.name}
                  </p>
                </div>
                <button onclick="this.closest('div[style*=fixed]').remove()" style="background: rgba(248,113,113,0.2); color: #f87171; border: 2px solid rgba(248,113,113,0.4); border-radius: 12px; padding: 8px 16px; cursor: pointer; font-size: 14px; font-weight: 600;">
                  ‚úï Close
                </button>
              </div>
              
              <div style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 100px);">
                <div style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #8b5cf6;">
                  <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">Subject Line</div>
                  <div style="color: rgba(255,255,255,0.95); font-size: 16px; font-weight: 600;">${template.subject || 'No subject'}</div>
                </div>

                <div style="background: #1e293b; border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 3px solid #334155;">
                  <div style="background: #0f172a; border-radius: 8px; padding: 20px; border: 2px solid #475569; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);">
                    ${template.body_html || '<p style="color: #666;">No content</p>'}
                  </div>
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          
          // Close on background click
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        },

        async deleteAutomation(id) {
          const confirmed = await showDesignConfirm({
            title: 'Delete automation?',
            message: 'This rule will be permanently removed.',
            confirmText: 'Delete',
            confirmVariant: 'danger',
          });

          if (!confirmed) return;
          this._automations = this._automations.filter(a => a.id !== id);
          this.saveAutomations();
          this.renderAutomations();
          debugLog('üóëÔ∏è Automation deleted');
        },

        testAutomation(id) {
          const auto = this._automations.find(a => a.id === id);
          if (!auto) return;
          debugLog('üß™ Testing automation:', auto.name);
          const message =
            `This would trigger:\n‚Ä¢ Template: ${auto.templateId}\n‚Ä¢ Trigger: ${this.getTriggerLabel(auto.triggerCategory, auto.triggerType)}\n‚Ä¢ Recipients: ${auto.recipients || 'all_active'}\n\n(Actual sending not implemented yet)`;
          showDesignAlert(message, { title: 'üß™ Test Mode', type: 'info', confirmText: 'Nice' });
        },

        // ============================================================
        // TRIGGER EXECUTION ENGINE (NEW)
        // ============================================================
        async fireTrigger(triggerCategory, triggerType, eventData = {}) {
          debugLog(`üî• Trigger fired: ${triggerCategory}.${triggerType}`, eventData);

          // Find all active automations matching this trigger
          const matchingAutomations = this._automations.filter(
            auto => auto.active && auto.triggerCategory === triggerCategory && auto.triggerType === triggerType
          );

          if (matchingAutomations.length === 0) {
            debugLog(`‚ö†Ô∏è No active automations found for ${triggerCategory}.${triggerType}`);
            return;
          }

          debugLog(`üìã Found ${matchingAutomations.length} matching automation(s)`);

          for (const auto of matchingAutomations) {
            try {
              // Check conditions
              if (auto.conditions && auto.conditions.length > 0) {
                const conditionsMet = this.evaluateConditions(auto.conditions, eventData);
                if (!conditionsMet) {
                  debugLog(`‚è≠Ô∏è Skipping automation "${auto.name}" - conditions not met`);
                  continue;
                }
              }

              // Execute automation
              await this.executeAutomation(auto, eventData);
            } catch (error) {
              console.error(`‚ùå Error executing automation "${auto.name}":`, error);
            }
          }
        },

        evaluateConditions(conditions, eventData) {
          // Evaluate all conditions (AND logic)
          for (const condition of conditions) {
            const fieldValue = this.getFieldValue(condition.field, eventData);
            const conditionValue = condition.value;

            let result = false;
            switch (condition.operator) {
              case '==':
                result = fieldValue == conditionValue;
                break;
              case '!=':
                result = fieldValue != conditionValue;
                break;
              case '>':
                result = parseFloat(fieldValue) > parseFloat(conditionValue);
                break;
              case '<':
                result = parseFloat(fieldValue) < parseFloat(conditionValue);
                break;
              case '>=':
                result = parseFloat(fieldValue) >= parseFloat(conditionValue);
                break;
              case '<=':
                result = parseFloat(fieldValue) <= parseFloat(conditionValue);
                break;
              case 'contains':
                result = String(fieldValue).includes(conditionValue);
                break;
              case 'not_contains':
                result = !String(fieldValue).includes(conditionValue);
                break;
              case 'starts_with':
                result = String(fieldValue).startsWith(conditionValue);
                break;
              case 'ends_with':
                result = String(fieldValue).endsWith(conditionValue);
                break;
              case 'in':
                const list = conditionValue.split(',').map(v => v.trim());
                result = list.includes(String(fieldValue));
                break;
              case 'not_in':
                const notList = conditionValue.split(',').map(v => v.trim());
                result = !notList.includes(String(fieldValue));
                break;
            }

            if (!result) {
              debugLog(
                `‚ùå Condition failed: ${condition.field} ${condition.operator} ${condition.value} (actual: ${fieldValue})`
              );
              return false;
            }
          }

          debugLog(`‚úÖ All conditions met`);
          return true;
        },

        getFieldValue(field, eventData) {
          // Extract nested field values from eventData
          const parts = field.split('.');
          let value = eventData;

          for (const part of parts) {
            if (value && typeof value === 'object') {
              value = value[part];
            } else {
              return undefined;
            }
          }

          return value;
        },

        async executeAutomation(automation, eventData) {
          debugLog(`‚ö° Executing automation: ${automation.name}`);

          // Get template from Supabase
          let template = TemplateManager.getTemplate(automation.templateId);

          // Fallback to localStorage templates for backward compatibility
          if (!template) {
            template = emailSystem._templates.find(t => t.id === automation.templateId);
          }

          if (!template) {
            console.error(`‚ùå Template not found: ${automation.templateId}`);
            return;
          }

          debugLog(`üìß Using template: ${template.name}`);

          // Determine recipients
          let recipients = [];

          if (automation.recipients === 'triggered_student' && eventData.student) {
            recipients = [eventData.student];
          } else if (automation.recipients === 'specific_group' && automation.recipientOptions?.group) {
            // Would query students by group from parent window
            debugLog(`üìã Would send to group: ${automation.recipientOptions.group}`);
          } else if (automation.recipients === 'specific_students' && automation.recipientOptions?.students) {
            const names = automation.recipientOptions.students.split(',').map(n => n.trim());
            debugLog(`üìã Would send to students: ${names.join(', ')}`);
          } else if (automation.recipients === 'all_active') {
            debugLog(`üìã Would send to all active students`);
          } else if (automation.recipients === 'filtered' && automation.recipientOptions?.filter) {
            debugLog(`üìã Would send to filtered students: ${automation.recipientOptions.filter}`);
          }

          if (automation.confirmBeforeSend) {
            const summaryHtml = `
              <div style="text-align: left; line-height: 1.5; margin-top: 12px;">
                <div><strong>Template:</strong> ${template.name}</div>
                <div><strong>Recipients:</strong> ${automation.recipients || 'Custom selection'}</div>
                <div><strong>Trigger:</strong> ${this.getTriggerLabel(automation.triggerCategory, automation.triggerType)}</div>
              </div>
            `;

            const approved = await showDesignConfirm({
              title: `Send "${automation.name}" now?`,
              message: `‚ö†Ô∏è This automation requires manual approval before sending.${summaryHtml}`,
              confirmText: 'Send email',
              confirmVariant: 'primary',
            });

            if (!approved) {
              debugLog(`üö´ Automation "${automation.name}" canceled by user confirmation prompt`);
              return;
            }
          }

          debugLog(`‚úÖ Automation "${automation.name}" executed successfully`);
          debugLog(`üìß Template: ${template.name}`);
          debugLog(`üë• Recipients: ${automation.recipients}`);
          debugLog(`üéØ Priority: ${automation.priority || 'normal'}`);

          // Update automation run tracking
          automation.lastRun = new Date().toISOString();
          automation.runCount = (automation.runCount || 0) + 1;
          
          // Save updated tracking to Supabase
          await this.saveAutomations();

          // In production, this would actually send emails via Resend
          // For now, we log what would happen
        },

        // ============================================================
        // EVENT LISTENERS FOR PARENT WINDOW COMMUNICATION (NEW)
        // ============================================================
        initializeEventListeners() {
          // Listen for events from parent window (ARNOMA main system)
          window.addEventListener('message', event => {
            if (event.data && event.data.type === 'arnoma_event') {
              const { category, trigger, data } = event.data;
              debugLog(`üì® Received event from parent:`, category, trigger);
              this.fireTrigger(category, trigger, data);
            }
          });

          debugLog('üëÇ Event listeners initialized for parent window communication');
        },
      };

      // ============================================================
      // AUTOMATION EDITOR FUNCTIONS
      // ============================================================
      async function openAutomationEditor() {
        // Load templates from Supabase
        await TemplateManager.loadTemplates();

        const templateSelect = document.getElementById('automationTemplate');

        // Combine Supabase templates + localStorage templates
        const supabaseTemplates = TemplateManager.templates || [];
        const localTemplates = emailSystem._templates || [];

        templateSelect.innerHTML =
          '<option value="">Select a template...</option>' +
          supabaseTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('') +
          (localTemplates.length > 0
            ? '<optgroup label="Local Templates">' +
              localTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('') +
              '</optgroup>'
            : '');

        document.getElementById('automationEditorModal').classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeAutomationEditor() {
        document.getElementById('automationEditorModal').classList.remove('active');
        document.getElementById('automationForm').reset();
        document.getElementById('automationId').value = '';
        document.getElementById('automationModalTitle').textContent = 'ü§ñ Create Automation';
        document.getElementById('triggerParamsContainer').innerHTML = '';
        document.getElementById('recipientOptionsContainer').innerHTML = '';
        document.body.style.overflow = '';
      }

      function updateTriggerOptions() {
        const category = document.getElementById('triggerCategory').value;
        const typeGroup = document.getElementById('triggerTypeGroup');
        const typeSelect = document.getElementById('triggerType');

        if (!category) {
          typeGroup.style.display = 'none';
          return;
        }

        const triggers = automationEngine.triggers[category];
        typeSelect.innerHTML =
          '<option value="">Select trigger...</option>' +
          Object.entries(triggers)
            .map(([key, val]) => {
              // Get tooltip from TriggerTooltips database
              const tooltip = TriggerTooltips[key] || `${val.label} - No description available`;
              return `<option value="${key}" data-tooltip="${tooltip}">${val.label}</option>`;
            })
            .join('');

        typeGroup.style.display = 'block';
        document.getElementById('triggerParamsContainer').innerHTML = '';
      }

      function updateTriggerParams() {
        const category = document.getElementById('triggerCategory').value;
        const type = document.getElementById('triggerType').value;
        const container = document.getElementById('triggerParamsContainer');

        if (!category || !type) {
          container.innerHTML = '';
          return;
        }

        const trigger = automationEngine.triggers[category][type];
        if (!trigger.params || trigger.params.length === 0) {
          container.innerHTML = '';
          return;
        }

        container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">‚öôÔ∏è Trigger Parameters</label>
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 12px; border-left: 3px solid #667eea;">
                        ${trigger.params
                          .map(param => {
                            const paramLabel = param.replace(/([A-Z])/g, ' $1').trim();
                            const capitalized = paramLabel.charAt(0).toUpperCase() + paramLabel.slice(1);

                            let inputHTML = '';
                            if (param.includes('time') || param === 'time') {
                              inputHTML = `<input type="time" id="param_${param}" class="form-input" style="margin-bottom: 12px;">`;
                            } else if (param.includes('date') || param === 'date') {
                              inputHTML = `<input type="date" id="param_${param}" class="form-input" style="margin-bottom: 12px;">`;
                            } else if (param.includes('dayOfWeek')) {
                              inputHTML = `
                                    <select id="param_${param}" class="form-select" style="margin-bottom: 12px;">
                                        <option value="Mon">Monday</option>
                                        <option value="Tue">Tuesday</option>
                                        <option value="Wed">Wednesday</option>
                                        <option value="Thu">Thursday</option>
                                        <option value="Fri">Friday</option>
                                        <option value="Sat">Saturday</option>
                                        <option value="Sun">Sunday</option>
                                    </select>
                                `;
                            } else if (
                              param.includes('minutes') ||
                              param.includes('hours') ||
                              param.includes('days') ||
                              param.includes('count')
                            ) {
                              inputHTML = `<input type="number" id="param_${param}" class="form-input" placeholder="Enter ${paramLabel}" style="margin-bottom: 12px;">`;
                            } else {
                              inputHTML = `<input type="text" id="param_${param}" class="form-input" placeholder="Enter ${paramLabel}" style="margin-bottom: 12px;">`;
                            }

                            return `
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; color: rgba(255,255,255,0.7); font-size: 13px; font-weight: 600; margin-bottom: 6px;">${capitalized}</label>
                                    ${inputHTML}
                                </div>
                            `;
                          })
                          .join('')}
                    </div>
                </div>
            `;
      }

      function updateRecipientOptions() {
        const recipients = document.getElementById('automationRecipients').value;
        const container = document.getElementById('recipientOptionsContainer');

        if (recipients === 'specific_group') {
          container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Select Group</label>
                        <input type="text" id="recipientGroup" class="form-input" placeholder="e.g., Group A">
                    </div>
                `;
        } else if (recipients === 'specific_students') {
          container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Student Names (comma-separated)</label>
                        <input type="text" id="recipientStudents" class="form-input" placeholder="e.g., John Doe, Jane Smith">
                    </div>
                `;
        } else if (recipients === 'filtered') {
          container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Filter Conditions</label>
                        <textarea id="recipientFilter" class="form-textarea" style="min-height: 100px;" placeholder='e.g., {"status": "active", "balance": "<0"}'></textarea>
                    </div>
                `;
        } else {
          container.innerHTML = '';
        }
      }

      // ============================================================
      // CONDITION BUILDER (NEW)
      // ============================================================
      let conditionCounter = 0;

      function addCondition() {
        conditionCounter++;
        const container = document.getElementById('conditionsContainer');
        const conditionId = `condition_${conditionCounter}`;

        const conditionHTML = `
                <div id="${conditionId}" style="background: rgba(0,0,0,0.3); padding: 14px; border-radius: 10px; margin-top: 12px; border-left: 3px solid #667eea;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: end;">
                        <div>
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 4px;">
                                Field
                                <span class="info-icon" data-tooltip="The student/payment/class data field to check.<br><strong>Examples:</strong><br>‚Ä¢ student.status = Current student status<br>‚Ä¢ student.balance = Account balance<br>‚Ä¢ payment.amount = Payment amount<br>Choose the data you want to filter by.">‚ìò</span>
                            </label>
                            <select class="form-select" style="font-size: 13px;">
                                <option value="student.status" data-tooltip="<strong>Student Status</strong><br>Current status: active, paused, or graduated.<br><br><strong>Example:</strong> Only send to active students.">Student Status</option>
                                <option value="student.group" data-tooltip="<strong>Student Group</strong><br>The group/class the student belongs to.<br><br><strong>Example:</strong> Send only to Group A.">Student Group</option>
                                <option value="student.balance" data-tooltip="<strong>Balance</strong><br>Current account balance (positive or negative).<br><br><strong>Example:</strong> Alert if balance < -100.">Balance</option>
                                <option value="student.created_at" data-tooltip="<strong>Created Date</strong><br>Date when student was added to system.<br><br><strong>Example:</strong> Send to students added after 2024-01-01.">Created Date</option>
                                <option value="payment.amount" data-tooltip="<strong>Payment Amount</strong><br>Amount of payment received/expected.<br><br><strong>Example:</strong> Thank students who paid > 100.">Payment Amount</option>
                                <option value="payment.date" data-tooltip="<strong>Payment Date</strong><br>Date when payment was made.<br><br><strong>Example:</strong> Send receipts for payments after a specific date.">Payment Date</option>
                                <option value="class.date" data-tooltip="<strong>Class Date</strong><br>Date of upcoming or past class.<br><br><strong>Example:</strong> Remind about classes this week.">Class Date</option>
                                <option value="class.time" data-tooltip="<strong>Class Time</strong><br>Time of scheduled class.<br><br><strong>Example:</strong> Send to students with morning classes.">Class Time</option>
                                <option value="absence.count" data-tooltip="<strong>Absence Count</strong><br>Number of absences in timeframe.<br><br><strong>Example:</strong> Alert if absences > 3.">Absence Count</option>
                                <option value="custom" data-tooltip="<strong>Custom Field</strong><br>Use any custom student/payment field.<br><br><strong>Example:</strong> Filter by student.phone, student.notes, etc.">Custom Field</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 4px;">
                                Operator
                                <span class="info-icon" data-tooltip="The comparison method to use.<br><strong>Examples:</strong><br>‚Ä¢ <strong>Equals (==)</strong> = Exact match<br>‚Ä¢ <strong>Contains</strong> = Partial text match<br>‚Ä¢ <strong>Greater Than (>)</strong> = Numeric comparison<br>Determines how the field is compared to the value.">‚ìò</span>
                            </label>
                            <select class="form-select" style="font-size: 13px;">
                                <option value="==" data-tooltip="<strong>Equals (==)</strong><br>Exact match - field must equal value exactly.<br><br><strong>Example:</strong> status == 'active'">Equals (==)</option>
                                <option value="!=" data-tooltip="<strong>Not Equals (!=)</strong><br>Field must NOT equal value.<br><br><strong>Example:</strong> status != 'paused'">Not Equals (!=)</option>
                                <option value=">" data-tooltip="<strong>Greater Than (>)</strong><br>Numeric comparison - field must be greater than value.<br><br><strong>Example:</strong> balance > 0">Greater Than (>)</option>
                                <option value="<" data-tooltip="<strong>Less Than (<)</strong><br>Numeric comparison - field must be less than value.<br><br><strong>Example:</strong> balance < -50">Less Than (<)</option>
                                <option value=">=" data-tooltip="<strong>Greater or Equal (>=)</strong><br>Field must be greater than or equal to value.<br><br><strong>Example:</strong> payment.amount >= 100">Greater or Equal (>=)</option>
                                <option value="<=" data-tooltip="<strong>Less or Equal (<=)</strong><br>Field must be less than or equal to value.<br><br><strong>Example:</strong> absence.count <= 2">Less or Equal (<=)</option>
                                <option value="contains" data-tooltip="<strong>Contains</strong><br>Text field must contain substring.<br><br><strong>Example:</strong> group contains 'Group'">Contains</option>
                                <option value="not_contains" data-tooltip="<strong>Not Contains</strong><br>Text field must NOT contain substring.<br><br><strong>Example:</strong> email not_contains '@gmail'">Not Contains</option>
                                <option value="starts_with" data-tooltip="<strong>Starts With</strong><br>Text field must start with specific text.<br><br><strong>Example:</strong> name starts_with 'John'">Starts With</option>
                                <option value="ends_with" data-tooltip="<strong>Ends With</strong><br>Text field must end with specific text.<br><br><strong>Example:</strong> email ends_with '.edu'">Ends With</option>
                                <option value="in" data-tooltip="<strong>In List</strong><br>Field value must be in comma-separated list.<br><br><strong>Example:</strong> status in 'active,paused'">In List</option>
                                <option value="not_in" data-tooltip="<strong>Not In List</strong><br>Field value must NOT be in list.<br><br><strong>Example:</strong> group not_in 'Group A,Group B'">Not In List</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 4px;">
                                Value
                                <span class="info-icon" data-tooltip="The value to compare against.<br><strong>Examples:</strong><br>‚Ä¢ For status: <em>active</em><br>‚Ä¢ For balance: <em>-50</em><br>‚Ä¢ For date: <em>2024-01-01</em><br>Type the exact value you want to match.">‚ìò</span>
                            </label>
                            <input type="text" class="form-input" placeholder="Enter value" style="font-size: 13px;">
                        </div>
                        <button type="button" onclick="removeCondition('${conditionId}')" class="btn" style="background: rgba(248,113,113,0.2); color: #f87171; border: 1.5px solid rgba(248,113,113,0.4); padding: 10px 14px; font-size: 14px; height: 42px;">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `;

        container.insertAdjacentHTML('beforeend', conditionHTML);
      }

      function removeCondition(id) {
        document.getElementById(id)?.remove();
      }

      function getConditions() {
        const container = document.getElementById('conditionsContainer');
        const conditionDivs = container.querySelectorAll('[id^="condition_"]');
        const conditions = [];

        conditionDivs.forEach(div => {
          const selects = div.querySelectorAll('select');
          const input = div.querySelector('input');

          if (selects.length >= 2 && input) {
            conditions.push({
              field: selects[0].value,
              operator: selects[1].value,
              value: input.value,
            });
          }
        });

        return conditions;
      }

      async function saveAutomation() {
        const idField = document.getElementById('automationId').value;
        const id = idField || null; // Let Supabase auto-generate ID for new automations
        const name = document.getElementById('automationName').value;
        const description = document.getElementById('automationDescription').value;
        const templateId = document.getElementById('automationTemplate').value;
        const category = document.getElementById('triggerCategory').value;
        const type = document.getElementById('triggerType').value;
        const recipients = document.getElementById('automationRecipients').value;
        const active = document.getElementById('automationActive').checked;

        // NEW: Capture execution settings
        const runOnce = document.getElementById('automationRunOnce')?.checked || false;
        const rateLimited = document.getElementById('automationRateLimited')?.checked || false;
  const confirmBeforeSend = document.getElementById('automationConfirmSend')?.checked || false;
        const priority = document.getElementById('automationPriority')?.value || 'normal';
        const maxRetries = parseInt(document.getElementById('automationMaxRetries')?.value) || 3;

        // NEW: Capture conditions
        const conditions = getConditions();

        if (!name || !templateId || !category || !type) {
          showDesignAlert('‚ö†Ô∏è Please fill in all required fields', {
            title: 'Incomplete automation',
            type: 'warning',
          });
          return;
        }

        const trigger = automationEngine.triggers[category][type];
        const triggerParams = {};
        if (trigger.params && trigger.params.length > 0) {
          trigger.params.forEach(param => {
            const input = document.getElementById(`param_${param}`);
            if (input) triggerParams[param] = input.value;
          });
        }

        let recipientOptions = {};
        if (recipients === 'specific_group') {
          recipientOptions.group = document.getElementById('recipientGroup')?.value;
        } else if (recipients === 'specific_students') {
          recipientOptions.students = document.getElementById('recipientStudents')?.value;
        } else if (recipients === 'filtered') {
          recipientOptions.filter = document.getElementById('recipientFilter')?.value;
        }

        const automation = {
          id,
          name,
          description,
          templateId,
          triggerCategory: category,
          triggerType: type,
          triggerParams,
          recipients,
          recipientOptions,
          active,
          // NEW: Extended fields
          conditions,
          runOnce,
          rateLimited,
          priority,
          maxRetries,
          confirmBeforeSend,
          createdAt: Date.now(),
        };

        const existing = automationEngine._automations.findIndex(a => a.id === id);
        if (existing >= 0) {
          automationEngine._automations[existing] = automation;
          debugLog('‚úÖ Automation updated:', name);
          await automationEngine.saveAutomations();
          automationEngine.renderAutomations();
          closeAutomationEditor();
          showCustomNotification('‚úÖ Automation updated successfully', 'success');
        } else {
          // New automation - save to Supabase first to get real ID
          automationEngine._automations.push(automation);
          debugLog('‚úÖ Automation created:', name);
          const saved = await automationEngine.saveAutomations();
          if (saved) {
            await automationEngine.loadAutomations(); // Reload to get correct IDs from Supabase
            automationEngine.renderAutomations();
            closeAutomationEditor();
            showCustomNotification('ü§ñ Automation created and activated!', 'success');
          } else {
            showDesignAlert('‚ùå Failed to save automation to database. Please try again.', {
              title: 'Save failed',
              type: 'error',
            });
          }
        }
      }

      // ============================================================
      // INITIALIZE ON LOAD
      // ============================================================
      document.addEventListener('DOMContentLoaded', async () => {
        // ‚ö†Ô∏è CRITICAL FIX: Force reset body background (prevents gradient override)
        document.body.style.background = '#0f172a';

        debugLog('üìß ARNOMA Email System v3.20.2 - Connected to Supabase');
        debugLog('‚ú® Initializing email template system...');
        await emailSystem.init();

        debugLog('ü§ñ Initializing automation engine...');
        await automationEngine.init();
        automationEngine.initializeEventListeners();
        debugLog(`‚úÖ Loaded ${automationEngine._automations.length} automations from Supabase`);
        debugLog(`‚úÖ Loaded ${emailSystem._templates.length} templates from Supabase`);

        // Initialize Supabase templates
        debugLog('‚òÅÔ∏è Loading templates from Supabase...');
        await TemplateManager.loadTemplates();

        // Check if production templates need to be initialized
        if (TemplateManager.templates.length === 0) {
          debugLog('üîß No templates found - initializing production templates...');
          await TemplateManager.initializeProductionTemplates();
          await TemplateManager.loadTemplates(); // Reload after initialization
        }
        debugLog(`‚úÖ Loaded ${TemplateManager.templates.length} templates from Supabase`);

        // Count trigger types
        const triggerCount = Object.values(automationEngine.triggers).reduce(
          (sum, category) => sum + Object.keys(category).length,
          0
        );
        debugLog(
          `‚úÖ ${triggerCount} trigger types available across ${Object.keys(automationEngine.triggers).length} categories`
        );

        // Make automation engine globally accessible for manual triggers
        window.arnoma_automationEngine = automationEngine;
        window.arnoma_templateManager = TemplateManager;
        window.arnoma_testEmailManager = TestEmailManager;
        debugLog('üåç Automation engine exposed globally as window.arnoma_automationEngine');
        debugLog('üåç Template manager exposed globally as window.arnoma_templateManager');
        debugLog('üåç Test email manager exposed globally as window.arnoma_testEmailManager');

        // Initialize tooltip engine
        TooltipEngine.init();
        debugLog('‚ìò Tooltip engine initialized');
      });

      let templateResizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(templateResizeTimeout);
        templateResizeTimeout = setTimeout(() => emailSystem.equalizeTemplateCards(), 150);
      });

      // ============================================================
      // GLOBAL API FOR EXTERNAL TRIGGER FIRING (NEW)
      // ============================================================
      window.arnoma_fireTrigger = function (category, type, data = {}) {
        if (window.arnoma_automationEngine) {
          window.arnoma_automationEngine.fireTrigger(category, type, data);
        } else {
          console.error('‚ùå Automation engine not initialized yet');
        }
      };
    </script>
  </body>
</html>
