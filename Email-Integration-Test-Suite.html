<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìß Email Integration Test Suite - ARNOMA</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.6s ease-in;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.5s ease-out;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .metric-card h3 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-card .label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.95rem;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .test-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .log-entry.success {
            background: rgba(56, 239, 125, 0.2);
            border-left: 3px solid #38ef7d;
        }

        .log-entry.error {
            background: rgba(245, 87, 108, 0.2);
            border-left: 3px solid #f5576c;
        }

        .log-entry.info {
            background: rgba(79, 172, 254, 0.2);
            border-left: 3px solid #4facfe;
        }

        .log-entry.warning {
            background: rgba(255, 193, 7, 0.2);
            border-left: 3px solid #ffc107;
        }

        .timestamp {
            opacity: 0.7;
            font-size: 0.75rem;
            min-width: 80px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .test-results {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .test-result-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #fff;
        }

        .test-result-card.passed {
            border-left-color: #38ef7d;
        }

        .test-result-card.failed {
            border-left-color: #f5576c;
        }

        .test-result-card.pending {
            border-left-color: #ffc107;
        }

        .test-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .test-result-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .test-result-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-passed {
            background: rgba(56, 239, 125, 0.3);
            color: #38ef7d;
        }

        .status-failed {
            background: rgba(245, 87, 108, 0.3);
            color: #f5576c;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .test-result-details {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.5;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .warning-banner {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .warning-banner h3 {
            margin-bottom: 10px;
            color: #ffc107;
        }

        .warning-banner ul {
            margin-left: 20px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Email Integration Test Suite</h1>
            <p>End-to-End Testing: Edge Functions + Email Delivery + Automation Triggers</p>
        </div>

        <!-- Metrics Dashboard -->
        <div class="glass-panel">
            <h2 style="margin-bottom: 15px;">üìä Test Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Total Tests</h3>
                    <div class="value" id="totalTests">0</div>
                    <div class="label">Configured</div>
                </div>
                <div class="metric-card">
                    <h3>Passed</h3>
                    <div class="value" style="color: #38ef7d;" id="passedTests">0</div>
                    <div class="label">Success ‚úÖ</div>
                </div>
                <div class="metric-card">
                    <h3>Failed</h3>
                    <div class="value" style="color: #f5576c;" id="failedTests">0</div>
                    <div class="label">Errors ‚ùå</div>
                </div>
                <div class="metric-card">
                    <h3>Pass Rate</h3>
                    <div class="value" id="passRate">0%</div>
                    <div class="label">Overall</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
            </div>
        </div>

        <!-- Configuration Panel -->
        <div class="glass-panel">
            <div class="config-section">
                <h3>‚öôÔ∏è Test Configuration</h3>
                <div class="form-group">
                    <label>Test Email Address (where test emails will be sent):</label>
                    <input type="email" id="testEmail" value="hrachfilm@gmail.com" required>
                </div>
                <div class="form-group">
                    <label>Supabase URL:</label>
                    <input type="text" id="supabaseUrl" value="https://zlvnxvrzotamhpezqedr.supabase.co" required>
                </div>
                <div class="form-group">
                    <label>Supabase Anon Key:</label>
                    <input type="text" id="supabaseKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38" required>
                </div>
                <div class="form-group">
                    <label>Test Mode:</label>
                    <select id="testMode">
                        <option value="quick">Quick Test (Email Delivery Only)</option>
                        <option value="full">Full Test (Email + Automation)</option>
                        <option value="automation">Automation Only</option>
                    </select>
                </div>
            </div>

            <div class="warning-banner">
                <h3>‚ö†Ô∏è Important Notes</h3>
                <ul>
                    <li><strong>Real emails will be sent</strong> to the test email address above</li>
                    <li>Ensure your Supabase Edge Function is deployed and configured</li>
                    <li>Ensure Resend API key is properly set in Edge Function</li>
                    <li>Automation tests will create temporary records in your database</li>
                    <li>All test data will be cleaned up automatically</li>
                </ul>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="runTestsBtn" onclick="runAllTests()">
                    ‚ñ∂Ô∏è Run All Tests
                </button>
                <button class="btn btn-success" id="testEdgeFunctionBtn" onclick="testEdgeFunction()">
                    üîå Test Edge Function
                </button>
                <button class="btn btn-warning" id="testEmailDeliveryBtn" onclick="testEmailDelivery()">
                    üì® Test Email Delivery
                </button>
                <button class="btn btn-info" id="exportResultsBtn" onclick="exportResults()">
                    üíæ Export Results
                </button>
            </div>
        </div>

        <!-- Test Log -->
        <div class="glass-panel">
            <h2 style="margin-bottom: 15px;">üìã Test Log</h2>
            <div class="test-log" id="testLog">
                <div class="log-entry info">
                    <span class="timestamp">00:00:00</span>
                    <span>Waiting to start tests... Configure settings above and click "Run All Tests"</span>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="glass-panel">
            <h2 style="margin-bottom: 15px;">üéØ Detailed Test Results</h2>
            <div class="test-results" id="testResults">
                <!-- Test result cards will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global state
        let supabase = null;
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            tests: []
        };

        // Initialize
        function initSupabase() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();

            if (!url || !key) {
                logError('Please provide Supabase URL and Anon Key');
                return false;
            }

            try {
                supabase = window.supabase.createClient(url, key);
                logSuccess('Supabase client initialized');
                return true;
            } catch (error) {
                logError(`Failed to initialize Supabase: ${error.message}`);
                return false;
            }
        }

        // Logging functions
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `
                <span class="timestamp">${timestamp}</span>
                <span>${message}</span>
            `;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function logSuccess(message) { log(message, 'success'); }
        function logError(message) { log(message, 'error'); }
        function logWarning(message) { log(message, 'warning'); }
        function logInfo(message) { log(message, 'info'); }

        // Update metrics
        function updateMetrics() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            
            const passRate = testResults.total > 0 
                ? ((testResults.passed / testResults.total) * 100).toFixed(1)
                : 0;
            document.getElementById('passRate').textContent = `${passRate}%`;
            
            const progress = testResults.total > 0
                ? ((testResults.passed + testResults.failed) / testResults.total) * 100
                : 0;
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${progress}%`;
            progressFill.textContent = `${progress.toFixed(0)}%`;
        }

        // Add test result card
        function addTestResult(name, status, details, duration = null) {
            const resultsDiv = document.getElementById('testResults');
            const card = document.createElement('div');
            card.className = `test-result-card ${status}`;
            
            const durationText = duration ? `<br><strong>Duration:</strong> ${duration}ms` : '';
            
            card.innerHTML = `
                <div class="test-result-header">
                    <div class="test-result-title">${name}</div>
                    <div class="test-result-status status-${status}">
                        ${status === 'passed' ? '‚úÖ PASSED' : status === 'failed' ? '‚ùå FAILED' : '‚è≥ PENDING'}
                    </div>
                </div>
                <div class="test-result-details">${details}${durationText}</div>
            `;
            
            resultsDiv.appendChild(card);
            
            testResults.tests.push({ name, status, details, duration });
            testResults.total++;
            if (status === 'passed') testResults.passed++;
            if (status === 'failed') testResults.failed++;
            updateMetrics();
        }

        // TEST 1: Edge Function Health Check
        async function testEdgeFunction() {
            if (!initSupabase()) return;

            const testEmail = document.getElementById('testEmail').value.trim();
            if (!testEmail) {
                logError('Please provide a test email address');
                return;
            }

            logInfo('üîå Testing Edge Function health...');
            const startTime = performance.now();

            try {
                const response = await fetch(`${document.getElementById('supabaseUrl').value}/functions/v1/send-email`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${document.getElementById('supabaseKey').value}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: testEmail,
                        subject: '[TEST] Edge Function Health Check',
                        html: '<h1>‚úÖ Edge Function is Working!</h1><p>This is an automated test from Email Integration Test Suite.</p>',
                        email_type: 'test'
                    })
                });

                const duration = Math.round(performance.now() - startTime);

                if (response.ok) {
                    const data = await response.json();
                    logSuccess(`Edge Function responded successfully (${duration}ms)`);
                    addTestResult(
                        'üîå Edge Function Health Check',
                        'passed',
                        `Edge Function is accessible and responding. Response: ${JSON.stringify(data)}`,
                        duration
                    );
                    return true;
                } else {
                    const error = await response.text();
                    logError(`Edge Function returned error: ${response.status} - ${error}`);
                    addTestResult(
                        'üîå Edge Function Health Check',
                        'failed',
                        `Edge Function returned error ${response.status}: ${error}`,
                        duration
                    );
                    return false;
                }
            } catch (error) {
                const duration = Math.round(performance.now() - startTime);
                logError(`Failed to connect to Edge Function: ${error.message}`);
                addTestResult(
                    'üîå Edge Function Health Check',
                    'failed',
                    `Connection failed: ${error.message}. Ensure Edge Function is deployed.`,
                    duration
                );
                return false;
            }
        }

        // TEST 2: Email Delivery Test
        async function testEmailDelivery() {
            if (!initSupabase()) return;

            const testEmail = document.getElementById('testEmail').value.trim();
            if (!testEmail) {
                logError('Please provide a test email address');
                return;
            }

            logInfo('üì® Testing email delivery...');
            const startTime = performance.now();

            try {
                const testId = `test-${Date.now()}`;
                const response = await fetch(`${document.getElementById('supabaseUrl').value}/functions/v1/send-email`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${document.getElementById('supabaseKey').value}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: testEmail,
                        subject: `[TEST] Email Delivery Test - ${testId}`,
                        html: `
                            <h1>üìß Email Delivery Test</h1>
                            <p><strong>Test ID:</strong> ${testId}</p>
                            <p><strong>Timestamp:</strong> ${new Date().toISOString()}</p>
                            <p>If you received this email, email delivery is working correctly!</p>
                            <hr>
                            <p style="color: #666; font-size: 12px;">This is an automated test from ARNOMA Email Integration Test Suite</p>
                        `,
                        email_type: 'test'
                    })
                });

                const duration = Math.round(performance.now() - startTime);

                if (response.ok) {
                    const data = await response.json();
                    logSuccess(`Email sent successfully! Check ${testEmail} for delivery (${duration}ms)`);
                    logWarning(`‚ö†Ô∏è Manual verification required: Check your inbox for test email with ID: ${testId}`);
                    
                    addTestResult(
                        'üì® Email Delivery Test',
                        'passed',
                        `Email sent to ${testEmail}. Test ID: ${testId}. Response: ${JSON.stringify(data)}<br><br><strong>‚ö†Ô∏è MANUAL VERIFICATION REQUIRED:</strong> Check your inbox to confirm delivery.`,
                        duration
                    );
                    return true;
                } else {
                    const error = await response.text();
                    logError(`Email delivery failed: ${error}`);
                    addTestResult(
                        'üì® Email Delivery Test',
                        'failed',
                        `Failed to send email: ${error}`,
                        duration
                    );
                    return false;
                }
            } catch (error) {
                const duration = Math.round(performance.now() - startTime);
                logError(`Email delivery test failed: ${error.message}`);
                addTestResult(
                    'üì® Email Delivery Test',
                    'failed',
                    `Exception during email send: ${error.message}`,
                    duration
                );
                return false;
            }
        }

        // TEST 3: Database Logging Test
        async function testDatabaseLogging() {
            if (!supabase) return false;

            logInfo('üíæ Testing database logging (sent_emails table)...');
            const startTime = performance.now();

            try {
                // Check if sent_emails table exists and is accessible
                const { data, error } = await supabase
                    .from('sent_emails')
                    .select('id')
                    .limit(1);

                const duration = Math.round(performance.now() - startTime);

                if (error) {
                    logError(`Cannot access sent_emails table: ${error.message}`);
                    addTestResult(
                        'üíæ Database Logging Test',
                        'failed',
                        `Cannot query sent_emails table: ${error.message}`,
                        duration
                    );
                    return false;
                }

                logSuccess(`sent_emails table is accessible (${duration}ms)`);
                addTestResult(
                    'üíæ Database Logging Test',
                    'passed',
                    `sent_emails table exists and is queryable. Email history logging should work.`,
                    duration
                );
                return true;
            } catch (error) {
                const duration = Math.round(performance.now() - startTime);
                logError(`Database logging test failed: ${error.message}`);
                addTestResult(
                    'üíæ Database Logging Test',
                    'failed',
                    `Exception: ${error.message}`,
                    duration
                );
                return false;
            }
        }

        // TEST 4: Automation Trigger Test
        async function testAutomationTrigger() {
            if (!supabase) return false;

            const testEmail = document.getElementById('testEmail').value.trim();
            if (!testEmail) {
                logError('Please provide a test email address');
                return false;
            }

            logInfo('ü§ñ Testing automation trigger...');
            const startTime = performance.now();

            try {
                // Create a test student
                logInfo('Creating test student...');
                const { data: student, error: studentError } = await supabase
                    .from('students')
                    .insert({
                        name: 'AUTOMATION_TEST_STUDENT',
                        email: testEmail,
                        group_letter: 'A',
                        show_in_grid: false
                    })
                    .select()
                    .single();

                if (studentError) throw new Error(`Failed to create test student: ${studentError.message}`);

                const studentId = student.id;
                logSuccess(`Test student created (ID: ${studentId})`);

                // Create a test payment_record to trigger automation
                logInfo('Creating test payment to trigger automation...');
                const { data: payment, error: paymentError } = await supabase
                    .from('payment_records')
                    .insert({
                        student_id: studentId,
                        date: new Date().toISOString().split('T')[0],
                        amount: 100,
                        status: 'paid'
                    })
                    .select()
                    .single();

                if (paymentError) throw new Error(`Failed to create test payment: ${paymentError.message}`);

                logSuccess(`Test payment created (ID: ${payment.id})`);
                logInfo('Waiting 3 seconds for automation to trigger...');
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Check if email was logged in sent_emails
                const { data: sentEmails, error: emailError } = await supabase
                    .from('sent_emails')
                    .select('*')
                    .eq('email_type', 'automation')
                    .order('created_at', { ascending: false })
                    .limit(5);

                // Cleanup
                logInfo('Cleaning up test data...');
                await supabase.from('payment_records').delete().eq('id', payment.id);
                await supabase.from('students').delete().eq('id', studentId);
                logSuccess('Test data cleaned up');

                const duration = Math.round(performance.now() - startTime);

                if (emailError) {
                    logWarning(`Could not verify automation email: ${emailError.message}`);
                    addTestResult(
                        'ü§ñ Automation Trigger Test',
                        'failed',
                        `Automation may have triggered, but verification failed: ${emailError.message}`,
                        duration
                    );
                    return false;
                }

                const recentAutomation = sentEmails && sentEmails.length > 0;
                
                if (recentAutomation) {
                    logSuccess(`Automation triggered successfully! Found ${sentEmails.length} recent automation emails`);
                    addTestResult(
                        'ü§ñ Automation Trigger Test',
                        'passed',
                        `Automation system is working. Found ${sentEmails.length} recent automation emails. Latest: ${JSON.stringify(sentEmails[0])}`,
                        duration
                    );
                    return true;
                } else {
                    logWarning('No automation email found in sent_emails. Automation may not be configured.');
                    addTestResult(
                        'ü§ñ Automation Trigger Test',
                        'failed',
                        'Created test payment but no automation email was logged. Check if automation rules are configured in Email-System.html',
                        duration
                    );
                    return false;
                }
            } catch (error) {
                const duration = Math.round(performance.now() - startTime);
                logError(`Automation test failed: ${error.message}`);
                addTestResult(
                    'ü§ñ Automation Trigger Test',
                    'failed',
                    `Exception during automation test: ${error.message}`,
                    duration
                );
                return false;
            }
        }

        // TEST 5: Resend API Key Test
        async function testResendAPIKey() {
            logInfo('üîë Testing Resend API configuration...');
            const startTime = performance.now();

            try {
                const response = await fetch(`${document.getElementById('supabaseUrl').value}/functions/v1/send-email`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${document.getElementById('supabaseKey').value}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: 'test@test.com',
                        subject: 'API Key Test',
                        html: '<p>Test</p>',
                        test_mode: true // Signal to Edge Function not to actually send
                    })
                });

                const duration = Math.round(performance.now() - startTime);
                const data = await response.json();

                if (response.ok || (response.status === 400 && !data.message?.includes('API key'))) {
                    logSuccess('Resend API key appears to be configured');
                    addTestResult(
                        'üîë Resend API Configuration Test',
                        'passed',
                        'Edge Function can access Resend API credentials',
                        duration
                    );
                    return true;
                } else if (data.message?.includes('API key')) {
                    logError('Resend API key not configured or invalid');
                    addTestResult(
                        'üîë Resend API Configuration Test',
                        'failed',
                        'Resend API key is missing or invalid in Edge Function environment',
                        duration
                    );
                    return false;
                } else {
                    logWarning('Could not verify Resend API key status');
                    addTestResult(
                        'üîë Resend API Configuration Test',
                        'pending',
                        `Inconclusive result: ${JSON.stringify(data)}`,
                        duration
                    );
                    return false;
                }
            } catch (error) {
                const duration = Math.round(performance.now() - startTime);
                logError(`Resend API test failed: ${error.message}`);
                addTestResult(
                    'üîë Resend API Configuration Test',
                    'failed',
                    `Could not test API key: ${error.message}`,
                    duration
                );
                return false;
            }
        }

        // Run all tests
        async function runAllTests() {
            // Validate inputs
            const testEmail = document.getElementById('testEmail').value.trim();
            if (!testEmail) {
                alert('Please provide a test email address');
                return;
            }

            if (!initSupabase()) {
                alert('Please provide valid Supabase credentials');
                return;
            }

            // Reset state
            testResults = { total: 0, passed: 0, failed: 0, tests: [] };
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('testLog').innerHTML = '';
            updateMetrics();

            // Disable buttons
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => btn.disabled = true);

            const mode = document.getElementById('testMode').value;

            logInfo('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            logInfo('üöÄ Starting Email Integration Test Suite');
            logInfo(`üìß Test email: ${testEmail}`);
            logInfo(`üéØ Mode: ${mode}`);
            logInfo('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            try {
                if (mode === 'quick' || mode === 'full') {
                    await testEdgeFunction();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    await testEmailDelivery();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    await testDatabaseLogging();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                if (mode === 'full' || mode === 'automation') {
                    await testAutomationTrigger();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                logInfo('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                logInfo('‚úÖ All tests completed!');
                logInfo(`üìä Results: ${testResults.passed}/${testResults.total} passed`);
                logInfo('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                if (testResults.passed === testResults.total && testResults.total > 0) {
                    logSuccess('üéâ ALL TESTS PASSED! Email system is fully operational!');
                } else if (testResults.failed > 0) {
                    logWarning('‚ö†Ô∏è Some tests failed. Review the results above.');
                }
            } catch (error) {
                logError(`Test suite error: ${error.message}`);
            } finally {
                // Re-enable buttons
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        // Export results
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                testEmail: document.getElementById('testEmail').value,
                mode: document.getElementById('testMode').value,
                summary: {
                    total: testResults.total,
                    passed: testResults.passed,
                    failed: testResults.failed,
                    passRate: testResults.total > 0 ? ((testResults.passed / testResults.total) * 100).toFixed(1) + '%' : '0%'
                },
                tests: testResults.tests
            };

            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `email-integration-test-results-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            logSuccess('Test results exported successfully');
        }

        // Initialize on load
        window.addEventListener('load', () => {
            logInfo('Email Integration Test Suite loaded and ready');
            logInfo('Configure your settings above and click "Run All Tests" to begin');
        });
    </script>
</body>
</html>
