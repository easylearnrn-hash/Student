<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Protected Note Viewer - ARNOMA</title>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- PDF.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
      
      /* Disable text selection - CRITICAL */
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      -webkit-touch-callout: none !important;
    }
    
    /* Force disable selection on all elements */
    * {
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
    
    .viewer-container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .viewer-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .viewer-header h1 {
      font-size: 24px;
      font-weight: 700;
    }
    
    .viewer-header .student-name {
      font-size: 14px;
      opacity: 0.9;
      font-weight: 400;
    }
    
    .viewer-controls {
      background: #f7fafc;
      padding: 15px 30px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .control-btn {
      background: white;
      border: 1px solid #cbd5e0;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      color: #2d3748;
    }
    
    .control-btn:hover:not(:disabled) {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .print-btn {
      background: #48bb78;
      color: white;
      border-color: #48bb78;
    }
    
    .print-btn:hover {
      background: #38a169;
      border-color: #38a169;
    }
    
    .page-info {
      font-size: 14px;
      color: #4a5568;
      font-weight: 500;
    }
    
    .pdf-content {
      padding: 30px;
      background: #f7fafc;
      min-height: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      position: relative;
    }
    
    .page-container {
      position: relative;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .page-canvas {
      display: block;
      max-width: 100%;
      height: auto;
      pointer-events: none; /* Prevent any interaction with canvas */
    }
    
    .watermark-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 200px,
        rgba(102, 126, 234, 0.03) 200px,
        rgba(102, 126, 234, 0.03) 400px
      );
    }
    
    .watermark-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      opacity: 0.25;
    }
    
    .watermark-logo {
      font-size: 120px;
      font-weight: 900;
      color: rgba(102, 126, 234, 0.3);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      letter-spacing: 8px;
    }
    
    .watermark-text {
      font-size: 32px;
      font-weight: 700;
      color: rgba(102, 126, 234, 0.25);
      text-align: center;
      line-height: 1.6;
      transform: rotate(-25deg);
    }
    
    .watermark-info {
      font-size: 18px;
      font-weight: 600;
      color: rgba(102, 126, 234, 0.2);
      text-align: center;
    }
    
    .loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 30px;
      gap: 20px;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(102, 126, 234, 0.2);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 16px;
      color: #4a5568;
    }
    
    .error-message {
      background: #fed7d7;
      color: #c53030;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin: 40px;
    }
    
    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .zoom-level {
      font-size: 14px;
      color: #4a5568;
      min-width: 50px;
      text-align: center;
    }
    
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .viewer-header,
      .viewer-controls {
        display: none !important;
      }
      
      .viewer-container {
        box-shadow: none;
        border-radius: 0;
      }
      
      .pdf-content {
        padding: 0;
        background: white;
      }
      
      .page-container {
        page-break-after: always;
        page-break-inside: avoid;
        box-shadow: none;
        margin: 0;
        padding: 0;
      }
      
      .page-container:last-child {
        page-break-after: auto;
      }
      
      /* CRITICAL: Watermark must appear in print */
      .watermark-overlay {
        display: flex !important;
        opacity: 1 !important;
      }
      
      .watermark-content {
        opacity: 0.2 !important; /* Lighter on print but still visible */
      }
      
      /* Ensure canvas renders in print */
      .page-canvas {
        max-width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>
  <div class="viewer-container">
    <div class="viewer-header">
      <div>
        <h1 id="noteTitle">Loading Note...</h1>
        <div class="student-name" id="studentName"></div>
      </div>
    </div>
    
    <div class="viewer-controls" id="viewerControls" style="display: none;">
      <div class="control-group">
        <button class="control-btn" id="prevPage" onclick="changePage(-1)">‚óÄ Previous</button>
        <span class="page-info">
          Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <button class="control-btn" id="nextPage" onclick="changePage(1)">Next ‚ñ∂</button>
      </div>
      
      <div class="control-group">
        <div class="zoom-controls">
          <button class="control-btn" onclick="changeZoom(-0.1)">-</button>
          <span class="zoom-level" id="zoomLevel">100%</span>
          <button class="control-btn" onclick="changeZoom(0.1)">+</button>
        </div>
        <button class="control-btn print-btn" onclick="printNote()">üñ®Ô∏è Print</button>
      </div>
    </div>
    
    <div class="pdf-content" id="pdfContent">
      <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-text">Loading protected note...</div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // SUPABASE CONFIGURATION
    // ============================================================
    
    const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ============================================================
    // PDF.js CONFIGURATION
    // ============================================================
    
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // ============================================================
    // VERSION & DEBUG
    // ============================================================
    
    const VIEWER_VERSION = 'v2.1.0-signed-urls';
    console.log('üîµ PDF Viewer Version:', VIEWER_VERSION);
    console.log('üìÖ Loaded at:', new Date().toISOString());
    
    // ============================================================
    // GLOBAL VARIABLES
    // ============================================================
    
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let zoomLevel = 1.0;
    let currentStudent = null;
    let fallbackStudent = null;
    let noteData = null;

    const getStudentDisplayName = () => {
      return (currentStudent && currentStudent.name) || (fallbackStudent && fallbackStudent.name) || 'Authorized Student';
    };

    const getStudentDisplayGroup = () => {
      return (currentStudent && (currentStudent.group || currentStudent.group_name)) || (fallbackStudent && (fallbackStudent.group || fallbackStudent.group_name)) || 'N/A';
    };
    
    // ============================================================
    // DISABLE COPY/DOWNLOAD PROTECTION - ENHANCED
    // ============================================================
    
    // Disable right-click completely
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }, true);
    
    // Disable ALL keyboard shortcuts for save/copy/inspect
    document.addEventListener('keydown', (e) => {
      // Disable save shortcuts
      if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable copy shortcuts
      if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable select all
      if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'A')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable print shortcut (we have our own)
      if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
        e.preventDefault();
        e.stopPropagation();
        printNote(); // Use our protected print instead
        return false;
      }
      
      // Disable DevTools shortcuts
      if (e.key === 'F12' || 
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'i')) ||
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'J' || e.key === 'j')) ||
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'C' || e.key === 'c')) ||
          ((e.ctrlKey || e.metaKey) && (e.key === 'u' || e.key === 'U'))) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);
    
    // Disable text selection via mouse
    document.addEventListener('selectstart', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Disable drag-and-drop
    document.addEventListener('dragstart', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Disable copy event
    document.addEventListener('copy', (e) => {
      e.preventDefault();
      e.clipboardData.setData('text/plain', '');
      return false;
    }, true);
    
    // Disable cut event
    document.addEventListener('cut', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Monitor for DevTools (basic detection)
    let devtoolsOpen = false;
    const detectDevTools = () => {
      const threshold = 160;
      if (window.outerWidth - window.innerWidth > threshold || 
          window.outerHeight - window.innerHeight > threshold) {
        if (!devtoolsOpen) {
          devtoolsOpen = true;
          alert('‚ö†Ô∏è Developer tools detected. This content is protected.');
        }
      } else {
        devtoolsOpen = false;
      }
    };
    setInterval(detectDevTools, 1000);
    
    // ============================================================
    // INITIALIZATION
    // ============================================================
    
    (async function init() {
      try {
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const pdfUrl = urlParams.get('url');
        const noteTitle = urlParams.get('title') || 'Class Notes';
        const noteId = urlParams.get('note'); // Legacy support
        const studentName = urlParams.get('studentName'); // Passed from portal
        const studentGroup = urlParams.get('studentGroup'); // Passed from portal
        
        if (!pdfUrl && !noteId) {
          showError('No note specified');
          return;
        }
        
        // Check if student info was passed via URL (for impersonation or direct links)
        if (studentName) {
          fallbackStudent = {
            name: studentName,
            group_name: studentGroup,
            group: studentGroup
          };
          currentStudent = fallbackStudent;
        }
        
        // Check authentication (support both regular auth and impersonation)
        // First check for impersonation token (if student info wasn't passed via URL)
        if (!currentStudent) {
          const impersonationToken = sessionStorage.getItem('impersonation_token');
          if (impersonationToken) {
            try {
              const tokenData = JSON.parse(impersonationToken);
              const { data: student, error: studentError } = await supabase
                .from('students')
                .select('*')
                .eq('id', tokenData.studentId)
                .single();
              
              if (student && !studentError) {
                currentStudent = student;
              }
            } catch (e) {
              console.error('Error reading impersonation token:', e);
            }
          }
        }
        
        // If no impersonation, check regular auth session
        if (!currentStudent) {
          const { data: { session }, error: authError } = await supabase.auth.getSession();
          
          if (authError || !session) {
            showError('Please log in to view this note');
            window.location.href = 'index.html';
            return;
          }
          
          // Get current student data by email
          const { data: student, error: studentError } = await supabase
            .from('students')
            .select('*')
            .eq('email', session.user.email)
            .single();
          
          if (studentError || !student) {
            showError('Student profile not found');
            return;
          }
          
          currentStudent = student;
        }
        
        if (!currentStudent) {
          showError('Student profile not found');
          return;
        }
  document.getElementById('studentName').textContent = getStudentDisplayName();
        document.getElementById('noteTitle').textContent = noteTitle;
        
        // Create mock note data for watermarking
        noteData = {
          title: noteTitle,
          class_date: new Date().toISOString()
        };
        
        // If URL provided directly (from new group notes system)
        if (pdfUrl) {
          document.getElementById('viewerControls').style.display = 'flex';
          
          // Check if it's a storage path or a full URL
          if (pdfUrl.startsWith('http://') || pdfUrl.startsWith('https://')) {
            // It's already a full URL, use it directly
            await loadPDFFromURL(pdfUrl);
          } else {
            // It's a storage path, create signed URL from student-notes bucket
            await loadPDFFromStorage(pdfUrl);
          }
          return;
        }
        
        // Legacy: Load from student_notes table
        if (noteId) {
          const { data: note, error: noteError } = await supabase
            .from('student_notes')
            .select('*')
            .eq('id', noteId)
            .single();
          
          if (noteError || !note) {
            showError('Note not found');
            return;
          }
          
          noteData = note;
          
          // Verify student is in the correct group
          if (note.group_name !== currentStudent.group_name) {
            showError('This note is not for your group');
            return;
          }
          
          // Check if note requires payment
          if (note.requires_payment) {
            const { data: payments, error: paymentError } = await supabase
              .from('payment_records')
              .select('*')
              .eq('student_id', currentStudent.id)
              .eq('status', 'paid')
              .limit(1);
            
            if (paymentError || !payments || payments.length === 0) {
              showError('üîí This note is locked. Payment required to access.');
              return;
            }
          }
          
          document.getElementById('noteTitle').textContent = note.title || 'Class Notes';
          await loadPDF(note.pdf_url);
        }
        
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to load note: ' + error.message);
      }
    })();
    
    // ============================================================
    // PDF LOADING & RENDERING
    // ============================================================
    
    async function loadPDFFromURL(pdfUrl) {
      try {
        document.getElementById('loadingScreen').style.display = 'flex';
        
        console.log('üîó Loading PDF from URL:', pdfUrl);
        
        // Load PDF directly from URL
        const loadingTask = pdfjsLib.getDocument({
          url: pdfUrl,
          withCredentials: false
        });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        
        // Update UI
        document.getElementById('totalPages').textContent = totalPages;
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('viewerControls').style.display = 'flex';
        
        // Render first page
        await renderPage(1);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF: ' + error.message);
      }
    }
    
    async function loadPDFFromStorage(pdfPath) {
      try {
        console.log('üîç Loading PDF from storage path:', pdfPath);
        document.getElementById('loadingScreen').style.display = 'flex';
        
        // Create a signed URL with 1 hour expiration
        const { data: signedUrlData, error: signedUrlError } = await supabase.storage
          .from('student-notes')
          .createSignedUrl(pdfPath, 3600); // 1 hour
        
        if (signedUrlError) {
          console.error('‚ùå Error creating signed URL:', signedUrlError);
          throw new Error(`Could not create signed URL: ${signedUrlError.message}`);
        }
        
        if (!signedUrlData || !signedUrlData.signedUrl) {
          throw new Error('Signed URL was not generated');
        }
        
        console.log('‚úÖ Created signed URL for:', pdfPath);
        
        // Load PDF from signed URL
        const loadingTask = pdfjsLib.getDocument({
          url: signedUrlData.signedUrl,
          withCredentials: false
        });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        
        // Update UI
        document.getElementById('totalPages').textContent = totalPages;
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('viewerControls').style.display = 'flex';
        
        // Render first page
        await renderPage(1);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF: ' + error.message + '. Please ensure the file exists in storage.');
      }
    }
    
    async function loadPDF(pdfPath) {
      try {
        console.log('üîç Loading PDF from storage path (legacy):', pdfPath);
        
        // Try signed URL first
        await loadPDFFromStorage(pdfPath);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF. The file may not exist in storage. Please contact your administrator.');
      }
    }
    
    async function renderPage(pageNum) {
      try {
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: zoomLevel * 1.5 });
        
        // Create canvas for this page
        const canvas = document.createElement('canvas');
        canvas.className = 'page-canvas';
        const context = canvas.getContext('2d');
        
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        // Render PDF page
        await page.render({
          canvasContext: context,
          viewport: viewport
        }).promise;
        
        // Create page container with watermark
        const pageContainer = document.createElement('div');
        pageContainer.className = 'page-container';
        
        // Add watermark overlay with ARNOMA logo and student info
        const watermark = document.createElement('div');
        watermark.className = 'watermark-overlay';
        watermark.innerHTML = `
          <div class="watermark-content">
            <div class="watermark-logo">ARNOMA</div>
            <div class="watermark-text">
              ${getStudentDisplayName()}<br>
              Group ${getStudentDisplayGroup()}
            </div>
            <div class="watermark-info">
              ${new Date().toLocaleDateString()}<br>
              PROTECTED CONTENT
            </div>
          </div>
        `;
        
        pageContainer.appendChild(canvas);
        pageContainer.appendChild(watermark);
        
        // Clear and add to content
        const content = document.getElementById('pdfContent');
        content.innerHTML = '';
        content.appendChild(pageContainer);
        
        // Update page number
        currentPage = pageNum;
        document.getElementById('currentPage').textContent = currentPage;
        
        // Update button states
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
        
      } catch (error) {
        console.error('Page rendering error:', error);
        showError('Failed to render page: ' + error.message);
      }
    }
    
    // ============================================================
    // NAVIGATION CONTROLS
    // ============================================================
    
    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= totalPages) {
        renderPage(newPage);
      }
    }
    
    function changeZoom(delta) {
      zoomLevel = Math.max(0.5, Math.min(2.0, zoomLevel + delta));
      document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
      renderPage(currentPage);
    }
    
    // ============================================================
    // PRINT FUNCTION (WITH WATERMARK)
    // ============================================================
    
    async function printNote() {
      try {
        // Render all pages for printing
        const content = document.getElementById('pdfContent');
        content.innerHTML = '<div class="loading-text">Preparing for print...</div>';
        
        for (let i = 1; i <= totalPages; i++) {
          const page = await pdfDoc.getPage(i);
          const viewport = page.getViewport({ scale: 1.5 });
          
          const canvas = document.createElement('canvas');
          canvas.className = 'page-canvas';
          const context = canvas.getContext('2d');
          
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          
          await page.render({
            canvasContext: context,
            viewport: viewport
          }).promise;
          
          const pageContainer = document.createElement('div');
          pageContainer.className = 'page-container';
          
          const watermark = document.createElement('div');
          watermark.className = 'watermark-overlay';
          watermark.innerHTML = `
            <div class="watermark-content">
              <div class="watermark-logo">ARNOMA</div>
              <div class="watermark-text">
                ${currentStudent.name}<br>
                Group ${currentStudent.group || currentStudent.group_name || 'N/A'}
              </div>
              <div class="watermark-info">
                ${new Date().toLocaleDateString()}<br>
                PROTECTED CONTENT
              </div>
            </div>
          `;
          
          pageContainer.appendChild(canvas);
          pageContainer.appendChild(watermark);
          content.appendChild(pageContainer);
        }
        
        // Trigger print dialog
        setTimeout(() => {
          window.print();
          // Restore single page view after print
          renderPage(currentPage);
        }, 500);
        
      } catch (error) {
        console.error('Print error:', error);
        alert('Failed to prepare for printing');
      }
    }
    
    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================
    
    function showError(message) {
      const content = document.getElementById('pdfContent');
      content.innerHTML = `<div class="error-message">${message}</div>`;
    }
    
    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { 
        month: 'long', 
        day: 'numeric', 
        year: 'numeric' 
      });
    }
  </script>
</body>
</html>
