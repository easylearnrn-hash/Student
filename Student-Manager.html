<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>ARNOMA - Student Manager [Connected to Supabase]</title>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1"></script>
    
    <!-- Shared Dialogs -->
    <script src="shared-dialogs.js"></script>

    <!-- ARNOMA University Typefaces -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!--
      v2.20.6 - Complete Student Manager NEW Features Applied:

      HEADER SYSTEM:
      - Two-row glassmorphism header
      - Title with gradient text
      - Action buttons: Add Student, Bulk Add, Waiting List, Find Duplicates
      - Search input with icon
      - Filter dropdowns: Group, Status, Payment, Sort
      - Clear Filters button
      - All button hover effects and glassmorphism design

      ACTION MODALS (All 4 Modals):
      1. Add Student Modal:
         - Complete form with all fields (Name, Group, Pay, Credit, Phone, Email, Notes)
         - Group toggle buttons (A-F) + custom input
         - Pay amount quick select ($25, $50, $75, $100) + custom
         - Credit balance with gold styling

      2. Bulk Add Students Modal:
         - Large textarea for pasting student records
         - Flexible format support (comma-separated)
         - Info box with format examples
         - Monospace font for better readability

      3. Waiting List Modal:
         - Wide layout (1100px) for student grid
         - Add to waiting list button
         - Empty state with icon

      4. Find Duplicates Modal:
         - Success state (no duplicates found)
         - Clean empty state design

      Modal Features:
      - Glassmorphism design matching main app
      - Modal open/close with body scroll lock
      - Smooth animations (fadeIn, slideUp)
      - Click outside to close
      - Scrollable content areas

      CARD UI:
      - Subtle hover zoom (scale 1.02)
      - Fixed badge sizing with min-width
      - $ after amount (900 $)
      - Credit K formatting (1000+ = 1K $)
      - Active pill glow reduced 20%
      - Cursor pointer on cards

      EMAIL & PHONE:
      - Email one per line in display
      - Comma/newline separated in edit
      - Phone auto-format xxx-xxx-xxxx

      SELECTION LOGIC:
      - Amount buttons match numeric value
      - Toggle OFF sets price to 0 $

      MODAL FIXES:
      - Separated .modal-card (blur) from .modal-scroll (content)
      - Removed backdrop-filter from stats grid
      - Body scroll lock on modal open/close
      - All scrollable content has NO backdrop-filter
    -->
    <style>
      /* ==========================================================================
         CSS VARIABLES — ARNOMA UNIVERSITY ACADEMIC THEME
         Palette: Deep Navy · Warm Ivory · Antique Gold · Velvet Crimson
         ========================================================================== */
      :root {
        /* ── Backgrounds ── */
        --bg-base:           #0c0f1a;
        --bg-gradient-start: #0e1322;
        --bg-gradient-end:   #141926;

        /* ── Panel Glass ── */
        --panel-bg:     rgba(255, 252, 240, 0.035);
        --panel-dark:   rgba(10, 12, 22, 0.90);
        --glass-border: rgba(196, 164, 95, 0.22);

        /* ── Antique Gold Palette ── */
        --gold:            #c4a45f;
        --gold-light:      #d4b87a;
        --gold-pale:       #e8d5a3;
        --gold-glow:       rgba(196, 164, 95, 0.32);
        --gold-border:     rgba(196, 164, 95, 0.22);
        --gold-border-hover: rgba(196, 164, 95, 0.55);

        /* ── Typography ── */
        --text-strong: #f5f0e8;
        --text-body:   rgba(245, 240, 232, 0.88);
        --text-muted:  rgba(245, 240, 232, 0.55);
        --text-faint:  rgba(245, 240, 232, 0.32);

        /* ── Fonts ── */
        --font-serif: 'Playfair Display', 'Georgia', 'Times New Roman', serif;
        --font-sans:  'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

        /* ── Effects ── */
        --card-shadow:   0 20px 60px rgba(0, 0, 0, 0.55), 0 1px 0 rgba(196, 164, 95, 0.12) inset;
        --modal-shadow:  0 32px 80px rgba(0, 0, 0, 0.7), 0 1px 0 rgba(196, 164, 95, 0.18) inset;
        --panel-blur:    12px;
        --modal-blur:    18px;

        /* ── Status Colors ── */
        --status-active:    #5dd18a;
        --status-paused:    #f5c842;
        --status-graduated: #b89cf5;

        /* ── Danger ── */
        --crimson:      #b03040;
        --crimson-glow: rgba(176, 48, 64, 0.28);
      }

      /* ── Global Reset ── */
      *, *::before, *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        animation: none !important;
        animation-duration: 0s !important;
      }

      /* Re-enable transitions for interactive elements */
      button, input, select, textarea, .student-card, .modal-card,
      .action-modal-card, .elegant-toggle-slider, .toggle-slider,
      .filter-select, .search-input, .btn-wrapper, .status-pill {
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }

      /* Re-enable spinner */
      .spinner {
        animation: spin 0.9s linear infinite !important;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to   { transform: rotate(360deg); }
      }

      body {
        font-family: var(--font-sans);
        background:
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E"),
          radial-gradient(ellipse 120% 80% at 15% 0%, rgba(80, 60, 20, 0.18) 0%, transparent 55%),
          radial-gradient(ellipse 100% 70% at 85% 100%, rgba(60, 30, 80, 0.14) 0%, transparent 55%),
          linear-gradient(160deg, var(--bg-gradient-start) 0%, #111624 45%, var(--bg-gradient-end) 100%);
        min-height: 100vh;
        padding: 32px 24px;
        color: var(--text-strong);
        overflow-x: hidden;
      }

      /* ────────────────────────────────────────────
         KEYFRAMES
         ──────────────────────────────────────────── */
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to   { opacity: 1; transform: translateY(0);    }
      }
      @keyframes modalEnter {
        from { opacity: 0; transform: scale(0.96) translateY(24px); }
        to   { opacity: 1; transform: scale(1)    translateY(0);    }
      }

      /* ────────────────────────────────────────────
         HEADER
         ──────────────────────────────────────────── */
      .header {
        max-width: 1400px;
        margin: 0 auto 36px;
        background: linear-gradient(135deg, rgba(16, 20, 36, 0.97) 0%, rgba(12, 15, 26, 0.98) 100%);
        backdrop-filter: blur(var(--panel-blur));
        -webkit-backdrop-filter: blur(var(--panel-blur));
        border: 1px solid var(--glass-border);
        border-top: 2px solid rgba(196, 164, 95, 0.42);
        border-radius: 20px;
        padding: 26px 32px;
        box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6), 0 1px 0 rgba(196, 164, 95, 0.12) inset;
        position: relative;
        z-index: 100;
        overflow: hidden;
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(196, 164, 95, 0.5), transparent);
      }

      .header-row-1 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 22px;
        flex-wrap: wrap;
        gap: 16px;
      }

      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .header-row-2 {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      /* Page title */
      .demo-title {
        font-family: var(--font-serif);
        font-size: 26px;
        font-weight: 700;
        color: var(--text-strong);
        margin: 0;
        letter-spacing: -0.01em;
      }
      .demo-title .title-eyebrow {
        display: block;
        font-family: var(--font-sans);
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.22em;
        text-transform: uppercase;
        color: var(--gold-light);
        opacity: 0.8;
        margin-bottom: 4px;
      }
      .demo-title .title-main {
        background: linear-gradient(135deg, var(--text-strong) 30%, var(--gold-light) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-style: italic;
      }

      /* ── Header Buttons ── */
      .btn-header-primary {
        position: relative;
        padding: 10px 20px;
        background: rgba(196, 164, 95, 0.12);
        border: 1px solid rgba(196, 164, 95, 0.35);
        border-radius: 10px;
        color: var(--gold-light);
        font-family: var(--font-sans);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        letter-spacing: 0.02em;
        box-shadow: 0 0 14px rgba(196, 164, 95, 0.12);
      }
      .btn-header-primary:hover {
        background: rgba(196, 164, 95, 0.22) !important;
        border-color: rgba(196, 164, 95, 0.58) !important;
        color: var(--gold-pale) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 0 22px rgba(196, 164, 95, 0.28) !important;
      }

      .btn-header-secondary {
        position: relative;
        padding: 10px 20px;
        background: rgba(255, 252, 240, 0.04);
        border: 1px solid rgba(196, 164, 95, 0.18);
        border-radius: 10px;
        color: var(--text-muted);
        font-family: var(--font-sans);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        letter-spacing: 0.02em;
      }
      .btn-header-secondary:hover {
        background: rgba(196, 164, 95, 0.10) !important;
        border-color: rgba(196, 164, 95, 0.38) !important;
        color: var(--gold-light) !important;
        transform: translateY(-1px) !important;
      }
      .btn-header-secondary.has-notification {
        border-color: rgba(196, 164, 95, 0.4) !important;
        color: var(--gold-light) !important;
      }

      /* Notification badge */
      .notification-badge {
        position: absolute;
        top: -7px;
        right: -7px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        font-family: var(--font-sans);
        font-size: 10px;
        font-weight: 700;
        min-width: 18px;
        height: 18px;
        border-radius: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
      }

      /* ── Search Input ── */
      .search-input {
        flex: 1;
        min-width: 260px;
        padding: 11px 18px 11px 42px;
        background: rgba(255, 252, 240, 0.04);
        border: 1px solid var(--glass-border);
        border-radius: 10px;
        color: var(--text-body);
        font-family: var(--font-sans);
        font-size: 13px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='rgba(196,164,95,0.45)'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: 13px center;
        background-size: 18px 18px;
      }
      .search-input::placeholder { color: var(--text-faint); }
      .search-input:focus {
        outline: none !important;
        border-color: rgba(196, 164, 95, 0.5) !important;
        background-color: rgba(255, 252, 240, 0.06) !important;
        box-shadow: 0 0 0 3px rgba(196, 164, 95, 0.12), 0 0 18px rgba(196, 164, 95, 0.12) !important;
      }

      /* Search container with clear btn */
      .search-input-container {
        flex: 1;
        position: relative;
        display: flex;
        align-items: center;
      }
      .search-input-container .search-input { width: 100%; padding-right: 40px; }
      .search-input-container .search-clear-btn {
        position: absolute;
        right: 11px;
        background: none;
        border: none;
        color: var(--text-faint);
        cursor: pointer;
        padding: 4px 6px;
        display: none;
        font-size: 16px;
        line-height: 1;
        border-radius: 4px;
        font-family: inherit;
      }
      .search-input-container .search-clear-btn:hover { color: var(--text-body) !important; }
      .search-input-container .search-clear-btn.visible { display: block; }

      /* ── Filter Select ── */
      .filter-select {
        padding: 11px 34px 11px 14px;
        background: rgba(255, 252, 240, 0.04);
        border: 1px solid var(--glass-border);
        border-radius: 10px;
        color: var(--text-muted);
        font-family: var(--font-sans);
        font-size: 13px;
        font-weight: 500;
        min-width: 160px;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='rgba(196,164,95,0.5)'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 18px 18px;
      }
      .filter-select:hover {
        background-color: rgba(196, 164, 95, 0.06) !important;
        border-color: rgba(196, 164, 95, 0.35) !important;
        color: var(--text-body) !important;
      }
      .filter-select:focus {
        outline: none !important;
        border-color: rgba(196, 164, 95, 0.5) !important;
        box-shadow: 0 0 0 3px rgba(196, 164, 95, 0.12) !important;
      }
      .filter-select option { background: #131726; color: var(--text-body); }

      /* ── Clear Filters ── */
      .btn-header-clear {
        padding: 11px 18px;
        background: rgba(255, 252, 240, 0.03);
        border: 1px solid rgba(196, 164, 95, 0.15);
        border-radius: 10px;
        color: var(--text-faint);
        font-family: var(--font-sans);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
      }
      .btn-header-clear:hover {
        background: rgba(255, 252, 240, 0.07) !important;
        border-color: rgba(196, 164, 95, 0.3) !important;
        color: var(--text-muted) !important;
        transform: translateY(-1px) !important;
      }

      /* ────────────────────────────────────────────
         STUDENT GRID
         ──────────────────────────────────────────── */
      .students-grid {
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
        gap: 22px;
        contain: layout style;
      }

      /* ────────────────────────────────────────────
         STUDENT CARD
         ──────────────────────────────────────────── */
      .student-card {
        position: relative;
        background: var(--panel-bg);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 26px;
        cursor: pointer;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35), 0 1px 0 rgba(196, 164, 95, 0.08) inset;
        will-change: transform;
        contain: layout style paint;
        overflow: hidden;
      }
      .student-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(196, 164, 95, 0.28), transparent);
      }
      .student-card:hover {
        transform: translateY(-3px) !important;
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(196, 164, 95, 0.22), 0 1px 0 rgba(196, 164, 95, 0.12) inset !important;
        border-color: rgba(196, 164, 95, 0.38) !important;
      }

      .card-toggle { position: absolute; top: 16px; right: 16px; z-index: 10; }

      .student-card-content {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      /* Avatar */
      .avatar-container { position: relative; flex-shrink: 0; }

      .avatar-orbit {
        position: absolute;
        inset: -6px;
        border-radius: 22px;
        border: 1.5px solid transparent;
        background: linear-gradient(135deg, rgba(196, 164, 95, 0.5), rgba(120, 90, 160, 0.35)) border-box;
        -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
        opacity: 0.7;
      }

      .avatar {
        position: relative;
        width: 86px;
        height: 86px;
        border-radius: 18px;
        background: linear-gradient(135deg, rgba(196, 164, 95, 0.25) 0%, rgba(120, 90, 160, 0.25) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: var(--font-serif);
        font-size: 32px;
        font-weight: 700;
        color: var(--gold-light);
        border: 1px solid rgba(196, 164, 95, 0.22);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35), 0 0 20px rgba(196, 164, 95, 0.1) inset;
      }

      .status-badge {
        position: absolute;
        bottom: -5px;
        right: -5px;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--status-active), #3bba6e);
        border: 2px solid var(--bg-base);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 10px rgba(93, 209, 138, 0.45);
      }
      .status-badge svg { width: 13px; height: 13px; color: white; }
      .status-badge.paused  { background: linear-gradient(135deg, #f5c842, #d4a200); box-shadow: 0 3px 10px rgba(245, 200, 66, 0.45); }
      .status-badge.graduated { background: linear-gradient(135deg, #b89cf5, #7c5cc4); box-shadow: 0 3px 10px rgba(184, 156, 245, 0.45); }

      /* Identity */
      .identity-section { flex: 1; min-width: 0; }

      .profile-label {
        font-family: var(--font-sans);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: var(--gold);
        margin-bottom: 7px;
        font-weight: 500;
        opacity: 0.7;
      }

      .student-name {
        font-family: var(--font-serif);
        font-size: 17px;
        font-weight: 600;
        line-height: 1.3;
        margin-bottom: 10px;
        color: var(--text-strong);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
      }

      .meta-badges {
        display: flex;
        gap: 7px;
        flex-wrap: nowrap;
        align-items: center;
      }

      .meta-badge {
        display: flex;
        align-items: center;
        gap: 5px;
        background: rgba(255, 252, 240, 0.04);
        border: 1px solid rgba(196, 164, 95, 0.15);
        border-radius: 8px;
        padding: 5px 11px;
        font-family: var(--font-sans);
        font-size: 12px;
        font-weight: 600;
        min-width: 80px;
        justify-content: center;
        color: var(--text-muted);
      }
      .meta-badge.credit {
        color: var(--gold-light);
        background: rgba(196, 164, 95, 0.08);
        border-color: rgba(196, 164, 95, 0.22);
      }
      .meta-badge.credit svg { stroke: var(--gold); filter: drop-shadow(0 0 3px rgba(196,164,95,0.3)); }
      .meta-badge.price {
        color: var(--status-active);
        background: rgba(93, 209, 138, 0.07);
        border-color: rgba(93, 209, 138, 0.18);
      }
      .meta-badge.price svg { stroke: var(--status-active); }
      .meta-badge svg { width: 13px; height: 13px; opacity: 0.85; }

      /* Elegant card toggle */
      .elegant-toggle { position: relative; display: inline-block; width: 40px; height: 22px; }
      .elegant-toggle input { opacity: 0; width: 0; height: 0; }
      .elegant-toggle-slider {
        position: absolute; cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255, 252, 240, 0.07);
        border-radius: 22px;
        border: 1.5px solid rgba(196, 164, 95, 0.18);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
      }
      .elegant-toggle-slider:before {
        content: '';
        position: absolute;
        height: 15px; width: 15px;
        left: 2px; bottom: 2px;
        background: linear-gradient(135deg, #f5f0e8, #e8e0d0);
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }
      .elegant-toggle input:checked + .elegant-toggle-slider {
        background: linear-gradient(135deg, var(--gold) 0%, #b8944e 100%);
        border-color: rgba(196, 164, 95, 0.6);
        box-shadow: 0 0 12px rgba(196, 164, 95, 0.4), inset 0 1px 2px rgba(255,255,255,0.15);
      }
      .elegant-toggle input:checked + .elegant-toggle-slider:before { transform: translateX(18px); }

      /* Status pill (card) */
      .status-pill {
        padding: 7px 14px;
        border-radius: 10px;
        font-family: var(--font-sans);
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        white-space: nowrap;
        cursor: pointer;
        user-select: none;
      }
      .status-pill:hover { transform: scale(1.05) !important; }
      .status-pill.active {
        background: rgba(93, 209, 138, 0.12);
        color: var(--status-active);
        border: 1px solid rgba(93, 209, 138, 0.28);
        box-shadow: 0 0 12px rgba(93, 209, 138, 0.2);
      }
      .status-pill.paused {
        background: rgba(245, 200, 66, 0.12);
        color: var(--status-paused);
        border: 1px solid rgba(245, 200, 66, 0.28);
        box-shadow: 0 0 12px rgba(245, 200, 66, 0.2);
      }
      .status-pill.graduated {
        background: rgba(184, 156, 245, 0.12);
        color: var(--status-graduated);
        border: 1px solid rgba(184, 156, 245, 0.28);
        box-shadow: 0 0 12px rgba(184, 156, 245, 0.2);
      }

      /* ────────────────────────────────────────────
         ACTION MODALS (Add / Bulk / Waiting / Dupes)
         ──────────────────────────────────────────── */
      .action-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.78);
        backdrop-filter: blur(var(--panel-blur));
        -webkit-backdrop-filter: blur(var(--panel-blur));
        z-index: 70000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .action-modal-backdrop.active { display: flex; }

      .action-modal-card {
        background: linear-gradient(160deg, rgba(14, 18, 32, 0.98) 0%, rgba(10, 12, 22, 0.99) 100%);
        backdrop-filter: blur(var(--modal-blur));
        -webkit-backdrop-filter: blur(var(--modal-blur));
        border: 1px solid var(--glass-border);
        border-top: 1px solid rgba(196, 164, 95, 0.35);
        border-radius: 24px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: var(--modal-shadow);
        display: flex;
        flex-direction: column;
        animation: modalEnter 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards !important;
        position: relative;
      }
      .action-modal-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(196, 164, 95, 0.55), transparent);
      }

      .action-modal-scroll {
        overflow-y: auto;
        overflow-x: hidden;
        max-height: 100%;
      }
      .action-modal-scroll::-webkit-scrollbar { width: 6px; }
      .action-modal-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.15); }
      .action-modal-scroll::-webkit-scrollbar-thumb {
        background: rgba(196, 164, 95, 0.25);
        border-radius: 3px;
      }
      .action-modal-scroll::-webkit-scrollbar-thumb:hover { background: rgba(196, 164, 95, 0.45); }

      .action-modal-close {
        position: absolute;
        top: 18px; right: 18px;
        width: 34px; height: 34px;
        border-radius: 10px;
        background: rgba(255, 252, 240, 0.05);
        border: 1px solid rgba(196, 164, 95, 0.15);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        font-family: inherit;
        color: var(--text-muted);
        font-size: 22px; line-height: 1;
        padding: 0;
        z-index: 10;
      }
      .action-modal-close:hover {
        background: rgba(176, 48, 64, 0.18) !important;
        border-color: rgba(176, 48, 64, 0.4) !important;
        color: #f5a0a8 !important;
        transform: rotate(90deg) !important;
      }

      .action-modal-header {
        padding: 24px 28px 22px;
        background: rgba(196, 164, 95, 0.04);
        border-bottom: 1px solid rgba(196, 164, 95, 0.12);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }

      .action-modal-title {
        font-family: var(--font-serif);
        font-size: 1.4rem;
        font-weight: 700;
        font-style: italic;
        background: linear-gradient(135deg, var(--text-strong) 30%, var(--gold-light) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .action-modal-body { padding: 24px 28px; }

      /* Form elements */
      .form-group { margin-bottom: 22px; }

      .form-label {
        display: block;
        margin-bottom: 9px;
        font-family: var(--font-sans);
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--gold);
        opacity: 0.85;
      }

      .form-input,
      .form-textarea {
        width: 100%;
        padding: 12px 15px;
        background: rgba(255, 252, 240, 0.04);
        border: 1px solid rgba(196, 164, 95, 0.18);
        border-radius: 10px;
        color: var(--text-body);
        font-family: var(--font-sans);
        font-size: 14px;
        box-sizing: border-box;
      }
      .form-input::placeholder, .form-textarea::placeholder { color: var(--text-faint); }
      .form-input:focus, .form-textarea:focus {
        outline: none !important;
        background: rgba(255, 252, 240, 0.06) !important;
        border-color: rgba(196, 164, 95, 0.48) !important;
        box-shadow: 0 0 0 3px rgba(196, 164, 95, 0.10), 0 0 16px rgba(196, 164, 95, 0.10) !important;
      }
      .form-textarea { min-height: 110px; resize: vertical; }

      .button-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }

      .toggle-btn {
        padding: 9px 16px;
        background: rgba(255, 252, 240, 0.04);
        border: 1px solid rgba(196, 164, 95, 0.15);
        border-radius: 9px;
        color: var(--text-muted);
        font-family: var(--font-sans);
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        will-change: transform;
      }
      .toggle-btn:hover {
        background: rgba(196, 164, 95, 0.10) !important;
        border-color: rgba(196, 164, 95, 0.38) !important;
        color: var(--gold-light) !important;
        transform: translateY(-1px) !important;
      }
      .toggle-btn.active {
        background: rgba(196, 164, 95, 0.18) !important;
        border-color: rgba(196, 164, 95, 0.55) !important;
        color: var(--gold-light) !important;
        box-shadow: 0 0 14px rgba(196, 164, 95, 0.2) !important;
      }

      .action-modal-footer {
        padding: 20px 28px;
        background: rgba(196, 164, 95, 0.025);
        border-top: 1px solid rgba(196, 164, 95, 0.10);
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .btn-modal-save {
        padding: 11px 26px;
        background: rgba(196, 164, 95, 0.15);
        border: 1px solid rgba(196, 164, 95, 0.42);
        border-radius: 10px;
        color: var(--gold-light);
        font-family: var(--font-sans);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 0 14px rgba(196, 164, 95, 0.12);
        letter-spacing: 0.02em;
      }
      .btn-modal-save:hover {
        background: rgba(196, 164, 95, 0.25) !important;
        border-color: rgba(196, 164, 95, 0.65) !important;
        box-shadow: 0 0 22px rgba(196, 164, 95, 0.28) !important;
        transform: translateY(-1px) !important;
      }

      .btn-modal-cancel {
        padding: 11px 22px;
        background: rgba(255, 252, 240, 0.04);
        border: 1px solid rgba(196, 164, 95, 0.12);
        border-radius: 10px;
        color: var(--text-faint);
        font-family: var(--font-sans);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
      }
      .btn-modal-cancel:hover {
        background: rgba(255, 252, 240, 0.08) !important;
        border-color: rgba(196, 164, 95, 0.22) !important;
        color: var(--text-muted) !important;
        transform: translateY(-1px) !important;
      }

      /* ────────────────────────────────────────────
         EDIT MODAL (full-screen student card)
         ──────────────────────────────────────────── */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.78);
        backdrop-filter: blur(var(--panel-blur));
        -webkit-backdrop-filter: blur(var(--panel-blur));
        z-index: 50000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .modal-backdrop.active { display: flex; }

      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideUp {
        from { opacity: 0; transform: scale(0.95) translateY(32px); }
        to   { opacity: 1; transform: scale(1)    translateY(0);    }
      }

      .modal-card {
        background: linear-gradient(160deg, rgba(14, 18, 32, 0.99) 0%, rgba(8, 10, 20, 0.99) 100%);
        backdrop-filter: blur(var(--modal-blur));
        -webkit-backdrop-filter: blur(var(--modal-blur));
        border: 1px solid var(--glass-border);
        border-top: 1px solid rgba(196, 164, 95, 0.42);
        border-radius: 24px;
        max-width: 860px;
        width: 100%;
        max-height: 92vh;
        overflow: hidden;
        box-shadow: var(--modal-shadow);
        animation: slideUp 0.38s cubic-bezier(0.16, 1, 0.3, 1) forwards !important;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      .modal-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(196, 164, 95, 0.6), transparent);
      }

      .modal-scroll {
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
      }
      .modal-scroll::-webkit-scrollbar { width: 5px; }
      .modal-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.15); }
      .modal-scroll::-webkit-scrollbar-thumb { background: rgba(196,164,95,0.25); border-radius: 3px; }
      .modal-scroll::-webkit-scrollbar-thumb:hover { background: rgba(196,164,95,0.45); }

      /* Close button */
      .modal-close {
        position: absolute;
        top: 18px; right: 18px;
        width: 34px; height: 34px;
        border-radius: 10px;
        background: rgba(255, 252, 240, 0.05);
        border: 1px solid rgba(196, 164, 95, 0.15);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        padding: 0;
        font-family: inherit;
        z-index: 10;
        color: var(--text-muted);
        transition: all 0.2s ease;
      }
      .modal-close:hover {
        background: rgba(176, 48, 64, 0.18) !important;
        border-color: rgba(176, 48, 64, 0.4) !important;
        transform: rotate(90deg) !important;
      }

      /* ── Profile modal layout ── */
      .profile-hero {
        padding: 32px 36px 24px;
        background: linear-gradient(135deg, rgba(196,164,95,0.06) 0%, rgba(10,12,22,0) 70%);
        border-bottom: 1px solid rgba(196,164,95,0.12);
        display: flex;
        align-items: flex-start;
        gap: 24px;
        position: relative;
      }
      .profile-avatar-large {
        width: 78px; height: 78px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--gold), #8a6d3b);
        display: flex; align-items: center; justify-content: center;
        font-family: var(--font-serif);
        font-size: 2rem; font-weight: 700;
        color: var(--bg-base);
        flex-shrink: 0;
        box-shadow: 0 0 0 3px rgba(196,164,95,0.22), 0 8px 24px rgba(0,0,0,0.35);
        position: relative;
      }
      .profile-hero-info { flex: 1; min-width: 0; }
      .profile-hero-name {
        font-family: var(--font-serif);
        font-size: 1.85rem; font-weight: 700; font-style: italic;
        background: linear-gradient(135deg, var(--text-strong) 30%, var(--gold-light) 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        line-height: 1.15; margin-bottom: 5px;
      }
      .profile-hero-sub {
        display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
        margin-bottom: 10px;
      }
      .profile-group-pill {
        font-family: var(--font-sans); font-size: 11px; font-weight: 700;
        letter-spacing: 0.1em; text-transform: uppercase;
        padding: 3px 10px; border-radius: 20px;
        background: rgba(196,164,95,0.12); border: 1px solid rgba(196,164,95,0.3);
        color: var(--gold);
      }
      .profile-college-line {
        font-family: var(--font-sans); font-size: 12px;
        color: rgba(138,180,255,0.65);
      }
      .profile-hero-stats {
        display: flex; gap: 18px; flex-wrap: wrap;
      }
      .profile-hero-stat {
        display: flex; flex-direction: column; align-items: flex-start;
      }
      .profile-hero-stat-label {
        font-family: var(--font-sans); font-size: 9px; font-weight: 600;
        text-transform: uppercase; letter-spacing: 0.12em;
        color: var(--gold); opacity: 0.65; margin-bottom: 2px;
      }
      .profile-hero-stat-val {
        font-family: var(--font-sans); font-size: 15px; font-weight: 700;
        color: var(--gold-light);
      }
      .profile-status-btn {
        padding: 6px 14px; border-radius: 8px;
        font-family: var(--font-sans); font-size: 11px; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.06em;
        cursor: pointer; border: 2px solid transparent;
        background: transparent; transition: all 0.2s;
        align-self: flex-start; margin-top: 2px;
      }
      .profile-status-btn:hover { transform: scale(1.05); }
      .profile-status-btn.active {
        background: rgba(93,209,138,0.12); border-color: var(--status-active); color: var(--status-active);
        box-shadow: 0 0 12px rgba(93,209,138,0.22);
      }
      .profile-status-btn.paused {
        background: rgba(245,200,66,0.12); border-color: var(--status-paused); color: var(--status-paused);
        box-shadow: 0 0 12px rgba(245,200,66,0.22);
      }
      .profile-status-btn.graduated {
        background: rgba(184,156,245,0.12); border-color: var(--status-graduated); color: var(--status-graduated);
        box-shadow: 0 0 12px rgba(184,156,245,0.22);
      }
      .profile-status-btn.inactive {
        background: rgba(150,150,150,0.12); border-color: rgba(150,150,150,0.5); color: rgba(180,180,180,0.9);
      }

      /* Profile two-column body */
      .profile-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0;
      }
      .profile-col {
        padding: 26px 32px;
        border-right: 1px solid rgba(196,164,95,0.07);
      }
      .profile-col:last-child { border-right: none; }
      .profile-section-title {
        font-family: var(--font-sans); font-size: 10px; font-weight: 600;
        text-transform: uppercase; letter-spacing: 0.14em;
        color: var(--gold); opacity: 0.6; margin-bottom: 16px;
        padding-bottom: 8px; border-bottom: 1px solid rgba(196,164,95,0.1);
      }
      .profile-field { margin-bottom: 18px; }
      .profile-field-label {
        font-family: var(--font-sans); font-size: 10px; font-weight: 600;
        text-transform: uppercase; letter-spacing: 0.1em;
        color: var(--text-faint); margin-bottom: 6px;
      }
      .profile-field-input {
        width: 100%; background: rgba(255,252,240,0.04);
        border: 1px solid rgba(196,164,95,0.14);
        border-radius: 10px; padding: 10px 13px;
        font-family: var(--font-sans); font-size: 14px; font-weight: 500;
        color: var(--text-strong); outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
        resize: none; box-sizing: border-box;
      }
      .profile-field-input:focus {
        border-color: rgba(196,164,95,0.4);
        box-shadow: 0 0 0 3px rgba(196,164,95,0.08);
        background: rgba(196,164,95,0.04);
      }
      .profile-field-input.credit-input { color: #fbbf24; }
      .profile-field-input.phone-input  { color: #c084fc; }
      .profile-field-input.email-input  { color: rgba(148,163,184,0.9); font-size: 13px; }
      .profile-field-input.aliases-input { color: #fbbf24; font-size: 13px; }
      .profile-field-input.college-input { color: #8ab4ff; }
      .profile-field-input.notes-input  { color: #a78bfa; font-size: 13px; min-height: 80px; }

      /* Group selector */
      .group-selector { display: flex; gap: 8px; flex-wrap: wrap; }
      .group-btn {
        width: 44px; height: 44px; border-radius: 50%;
        border: 2px solid rgba(196,164,95,0.2);
        background: rgba(255,252,240,0.04);
        font-family: var(--font-sans); font-size: 14px; font-weight: 700;
        color: var(--text-muted); cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
      }
      .group-btn:hover { border-color: rgba(196,164,95,0.45); color: var(--gold); }
      .group-btn.active {
        background: linear-gradient(135deg, var(--gold), #b8944e);
        border-color: transparent; color: var(--bg-base);
        box-shadow: 0 0 14px rgba(196,164,95,0.4);
        transform: scale(1.08);
      }

      /* Price selector */
      .price-selector { display: flex; gap: 8px; flex-wrap: wrap; }
      .price-btn {
        padding: 8px 14px; border-radius: 10px;
        border: 1px solid rgba(196,164,95,0.2);
        background: rgba(255,252,240,0.04);
        font-family: var(--font-sans); font-size: 13px; font-weight: 600;
        color: var(--text-muted); cursor: pointer;
        transition: all 0.2s;
      }
      .price-btn:hover { border-color: rgba(196,164,95,0.4); color: var(--gold); }
      .price-btn.active {
        background: rgba(196,164,95,0.14);
        border-color: var(--gold); color: var(--gold-light);
        box-shadow: 0 0 10px rgba(196,164,95,0.2);
      }

      /* Calendar toggle row */
      .profile-toggle-row {
        display: flex; align-items: center; justify-content: space-between;
        padding: 14px 20px;
        background: rgba(196,164,95,0.04);
        border-radius: 12px; margin-bottom: 18px;
        border: 1px solid rgba(196,164,95,0.1);
      }
      .profile-toggle-label {
        font-family: var(--font-sans); font-size: 13px; font-weight: 500;
        color: var(--text-muted);
      }
      .profile-toggle-label span {
        font-size: 10px; display: block;
        color: var(--text-faint); margin-top: 2px;
      }

      /* Modal footer */
      .modal-footer {
        padding: 18px 32px;
        border-top: 1px solid rgba(196,164,95,0.12);
        display: flex; align-items: center; justify-content: space-between;
        gap: 12px;
        background: rgba(8,10,20,0.6);
        flex-shrink: 0;
      }
      .modal-footer-left { display: flex; gap: 10px; }
      .modal-footer-right { display: flex; gap: 10px; }
      .btn-profile-save {
        padding: 10px 28px; border-radius: 10px;
        background: linear-gradient(135deg, var(--gold), #b8944e);
        border: none; color: var(--bg-base);
        font-family: var(--font-sans); font-size: 13px; font-weight: 700;
        letter-spacing: 0.04em; cursor: pointer;
        box-shadow: 0 4px 14px rgba(196,164,95,0.3);
        transition: all 0.2s;
      }
      .btn-profile-save:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(196,164,95,0.4); }
      .btn-profile-save:active { transform: scale(0.98); }
      .btn-profile-delete {
        padding: 10px 18px; border-radius: 10px;
        background: rgba(176,48,64,0.1); border: 1px solid rgba(176,48,64,0.3);
        color: #f87171; font-family: var(--font-sans); font-size: 13px; font-weight: 600;
        cursor: pointer; transition: all 0.2s;
      }
      .btn-profile-delete:hover { background: rgba(176,48,64,0.2); border-color: rgba(176,48,64,0.5); }
      .btn-profile-close {
        padding: 10px 18px; border-radius: 10px;
        background: rgba(255,252,240,0.04); border: 1px solid rgba(196,164,95,0.15);
        color: var(--text-muted); font-family: var(--font-sans); font-size: 13px; font-weight: 500;
        cursor: pointer; transition: all 0.2s;
      }
      .btn-profile-close:hover { background: rgba(255,252,240,0.07); border-color: rgba(196,164,95,0.28); }
      .save-indicator {
        font-family: var(--font-sans); font-size: 12px; color: var(--status-active);
        opacity: 0; transition: opacity 0.3s;
        display: flex; align-items: center; gap: 5px;
      }
      .save-indicator.visible { opacity: 1; }

      @media (max-width: 700px) {
        .profile-body { grid-template-columns: 1fr; }
        .profile-col { border-right: none; border-bottom: 1px solid rgba(196,164,95,0.07); }
        .profile-hero { flex-direction: column; align-items: center; text-align: center; }
        .profile-hero-sub { justify-content: center; }
        .profile-hero-stats { justify-content: center; }
        .modal-footer { flex-direction: column; }
      }

      /* Modal glass header */
      .glass-header-modal {
        padding: 26px 32px 22px;
        background: rgba(196, 164, 95, 0.04);
        border-bottom: 1px solid rgba(196, 164, 95, 0.12);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        position: relative;
      }

      .glass-name {
        font-family: var(--font-serif);
        font-size: 1.9rem;
        font-weight: 700;
        font-style: italic;
        background: linear-gradient(135deg, var(--text-strong) 30%, var(--gold-light) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1.2;
      }

      .glass-subtitle {
        font-family: var(--font-sans);
        font-size: 13px;
        color: var(--gold);
        margin-top: 5px;
        font-weight: 500;
        letter-spacing: 0.08em;
        opacity: 0.8;
      }

      .glass-meta {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-right: 46px;
        margin-top: 4px;
      }

      /* Status badges in modal */
      .status-badge-modal {
        padding: 6px 14px;
        border-radius: 8px;
        font-family: var(--font-sans);
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        display: inline-block;
        cursor: pointer;
        background: transparent;
        border: 2px solid transparent;
      }
      .status-badge-modal:hover { transform: scale(1.05) !important; }
      .status-badge-modal.active {
        background: rgba(93, 209, 138, 0.14);
        border-color: var(--status-active);
        color: var(--status-active);
        box-shadow: 0 0 14px rgba(93, 209, 138, 0.25), 0 0 28px rgba(93, 209, 138, 0.12);
      }
      .status-badge-modal.paused {
        background: rgba(245, 200, 66, 0.14);
        border-color: var(--status-paused);
        color: var(--status-paused);
        box-shadow: 0 0 14px rgba(245, 200, 66, 0.25), 0 0 28px rgba(245, 200, 66, 0.12);
      }
      .status-badge-modal.graduated {
        background: rgba(184, 156, 245, 0.14);
        border-color: var(--status-graduated);
        color: var(--status-graduated);
        box-shadow: 0 0 14px rgba(184, 156, 245, 0.25), 0 0 28px rgba(184, 156, 245, 0.12);
      }

      /* Calendar visibility toggle */
      .toggle { position: relative; display: inline-block; width: 44px; height: 24px; }
      .toggle input { opacity: 0; width: 0; height: 0; }
      .toggle-slider {
        position: absolute; cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255, 252, 240, 0.07);
        border-radius: 24px;
        border: 1.5px solid rgba(196, 164, 95, 0.18);
      }
      .toggle-slider:before {
        content: '';
        position: absolute;
        height: 16px; width: 16px;
        left: 2px; bottom: 2px;
        background: #f5f0e8;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }
      input:checked + .toggle-slider {
        background: linear-gradient(135deg, var(--gold), #b8944e);
        border-color: rgba(196, 164, 95, 0.55);
        box-shadow: 0 0 10px rgba(196, 164, 95, 0.35);
      }
      input:checked + .toggle-slider:before { transform: translateX(20px); }

      /* Glass stats grid */
      .glass-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1px;
        background: rgba(196, 164, 95, 0.07);
      }
      .glass-stat {
        padding: 18px 20px;
        background: rgba(10, 12, 22, 0.6);
        text-align: center;
      }
      .glass-stat-label {
        font-family: var(--font-sans);
        font-size: 10px;
        color: var(--gold);
        text-transform: uppercase;
        letter-spacing: 0.14em;
        margin-bottom: 8px;
        font-weight: 500;
        opacity: 0.75;
      }
      .glass-stat-value {
        font-family: var(--font-sans);
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--gold-light);
        line-height: 1.3;
        padding: 8px 10px 6px;
        min-height: 38px;
      }

      /* Editable stat inputs */
      .glass-stat-input {
        font-family: var(--font-sans);
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--gold-light);
        background: transparent;
        border: 1px solid transparent;
        border-radius: 8px;
        padding: 8px 10px;
        text-align: center;
        width: 100%;
        outline: none;
        cursor: pointer;
        line-height: 1.3;
        resize: none;
        min-height: 38px;
        white-space: pre-wrap;
      }
      .glass-stat-input:focus {
        background: rgba(196, 164, 95, 0.07) !important;
        border-color: rgba(196, 164, 95, 0.4) !important;
        box-shadow: 0 0 10px rgba(196, 164, 95, 0.15) !important;
        cursor: text;
      }
      .glass-stat-input::placeholder { color: transparent; }

      /* Glass actions (group/amount buttons) */
      .glass-actions {
        padding: 22px 28px;
        background: rgba(196, 164, 95, 0.025);
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      .glass-section-title {
        font-family: var(--font-sans);
        font-size: 10px;
        color: var(--gold);
        text-transform: uppercase;
        letter-spacing: 0.14em;
        margin-bottom: 10px;
        text-align: center;
        opacity: 0.65;
      }
      .glass-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: nowrap;
        justify-content: center;
        align-items: center;
        margin-bottom: 14px;
      }
      .glass-buttons:last-child { margin-bottom: 0; }

      /* White emboss buttons */
      .btn-wrapper {
        --size: 50px;
        --padding: 5px;
        --hue: 50deg;
        width: var(--size);
        height: var(--size);
        border-radius: 50%;
        background: #f5f0e8;
        display: flex; align-items: center; justify-content: center;
        box-shadow:
          0 8px 20px rgba(0,0,0,0.14),
          0 3px 8px rgba(0,0,0,0.08),
          inset 2px 2px 5px rgba(255,255,255,0.85),
          inset -2px -2px 6px rgba(0,0,0,0.06);
      }
      .btn-wrapper:has(.btn.active) {
        --size: 58px;
        box-shadow:
          0 0 16px hsla(var(--hue), 80%, 55%, 0.38),
          0 0 32px hsla(var(--hue), 80%, 55%, 0.18),
          0 8px 20px rgba(0,0,0,0.14),
          inset 2px 2px 5px rgba(255,255,255,0.85),
          inset -2px -2px 6px rgba(0,0,0,0.06);
      }
      .btn-wrapper.group-A { --hue: 346deg; }
      .btn-wrapper.group-B { --hue: 23deg;  }
      .btn-wrapper.group-C { --hue: 50deg;  }
      .btn-wrapper.group-D { --hue: 145deg; }
      .btn-wrapper.group-E { --hue: 204deg; }
      .btn-wrapper.group-F { --hue: 260deg; }
      .btn-wrapper.amount  { --hue: 48deg;  }

      .btn-wrapper.amount .btn.active .btn-txt {
        background: linear-gradient(180deg, hsla(48, 70%, 40%, 1), hsla(48, 65%, 28%, 1));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 6px hsla(48, 70%, 38%, 0.8));
      }

      .btn {
        width: calc(100% - 2 * var(--padding));
        height: calc(100% - 2 * var(--padding));
        border-radius: 50%;
        border: none;
        cursor: pointer;
        background: #ede8df;
        display: flex; align-items: center; justify-content: center;
        box-shadow:
          inset 3px 3px 6px rgba(0,0,0,0.10),
          inset -3px -3px 7px rgba(255,255,255,0.92),
          0 2px 5px rgba(0,0,0,0.06);
      }
      .btn-txt {
        font-family: var(--font-sans);
        font-size: 16px;
        font-weight: 700;
        line-height: 1;
        color: #4a3f2e;
        display: flex; align-items: center;
      }
      .btn-txt.small { font-size: 12px; }
      .btn.active {
        box-shadow:
          inset 2px 2px 6px rgba(255,255,255,0.9),
          inset -4px -4px 12px rgba(0,0,0,0.07),
          0 0 16px hsla(var(--hue), 80%, 60%, 0.22);
      }
      .btn.active .btn-txt {
        background: linear-gradient(180deg, hsla(var(--hue), 100%, 44%, 1), hsla(var(--hue), 90%, 32%, 1));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 6px hsla(var(--hue), 100%, 44%, 0.9));
      }
      .btn:active { transform: scale(0.96) !important; }

      @media (max-width: 768px) {
        .students-grid { grid-template-columns: 1fr; }
        .header { padding: 20px 18px; }
      }

      /* ────────────────────────────────────────────
         NOTIFICATION CENTER
         ──────────────────────────────────────────── */
      .notification-badge-bell {
        position: absolute;
        top: -5px; right: -5px;
        min-width: 16px; height: 16px;
        padding: 0 4px;
        border-radius: 8px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        font-family: var(--font-sans);
        font-size: 10px;
        font-weight: 700;
        display: none;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 7px rgba(239, 68, 68, 0.55);
      }
      .btn-header-secondary.has-unread .notification-badge-bell { display: flex; }

      .notification-center-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(var(--panel-blur));
        -webkit-backdrop-filter: blur(var(--panel-blur));
        z-index: 10000;
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding-top: 80px;
      }
      .notification-center-overlay.active { display: flex; }

      .notification-center-panel {
        width: 100%;
        max-width: 500px;
        max-height: calc(100vh - 100px);
        background: linear-gradient(160deg, rgba(14, 18, 32, 0.98) 0%, rgba(10, 12, 22, 0.99) 100%);
        border: 1px solid var(--glass-border);
        border-top: 1px solid rgba(196, 164, 95, 0.35);
        border-radius: 20px;
        backdrop-filter: blur(var(--modal-blur));
        -webkit-backdrop-filter: blur(var(--modal-blur));
        box-shadow: var(--modal-shadow);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }
      .notification-center-panel::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(196, 164, 95, 0.55), transparent);
      }

      .notification-center-header {
        padding: 22px 26px;
        border-bottom: 1px solid rgba(196, 164, 95, 0.12);
        background: rgba(196, 164, 95, 0.03);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .notification-center-title {
        font-family: var(--font-serif);
        font-size: 18px;
        font-weight: 700;
        font-style: italic;
        background: linear-gradient(135deg, var(--text-strong) 30%, var(--gold-light) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .notification-center-close {
        width: 32px; height: 32px;
        border-radius: 9px;
        background: rgba(255, 252, 240, 0.05);
        border: 1px solid rgba(196, 164, 95, 0.15);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 18px;
        padding: 0;
        font-family: inherit;
        line-height: 1;
      }
      .notification-center-close:hover {
        background: rgba(176, 48, 64, 0.18) !important;
        border-color: rgba(176, 48, 64, 0.4) !important;
        color: #f5a0a8 !important;
        transform: rotate(90deg) !important;
      }
      .clear-notifications-btn {
        padding: 7px 13px;
        border-radius: 9px;
        background: rgba(176, 48, 64, 0.08);
        border: 1px solid rgba(176, 48, 64, 0.25);
        color: #f5a0a8;
        font-family: var(--font-sans);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
      }
      .clear-notifications-btn:hover {
        background: rgba(176, 48, 64, 0.18) !important;
        border-color: rgba(176, 48, 64, 0.45) !important;
        transform: translateY(-1px) !important;
      }

      .notification-center-body {
        flex: 1;
        overflow-y: auto;
        padding: 14px 0;
      }
      .notification-center-body::-webkit-scrollbar { width: 5px; }
      .notification-center-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
      .notification-center-body::-webkit-scrollbar-thumb { background: rgba(196,164,95,0.22); border-radius: 3px; }

      .notification-group { margin-bottom: 20px; }
      .notification-group-label {
        padding: 7px 24px;
        font-family: var(--font-sans);
        font-size: 11px;
        font-weight: 600;
        color: var(--gold);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        opacity: 0.7;
      }

      .notification-item {
        margin: 6px 14px;
        padding: 14px 18px;
        background: rgba(255, 252, 240, 0.025);
        border: 1px solid rgba(196, 164, 95, 0.10);
        border-radius: 14px;
        cursor: pointer;
      }
      .notification-item:hover {
        background: rgba(196, 164, 95, 0.07) !important;
        border-color: rgba(196, 164, 95, 0.25) !important;
        transform: scale(1.01) !important;
      }
      .notification-item.unread {
        background: rgba(196, 164, 95, 0.04);
        border-color: rgba(196, 164, 95, 0.18);
      }

      .notification-item-header {
        display: flex;
        align-items: flex-start;
        gap: 11px;
        margin-bottom: 6px;
      }
      .notification-icon {
        width: 36px; height: 36px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 16px; flex-shrink: 0;
      }
      .notification-icon.student  { background: rgba(196,164,95,0.12); border: 1px solid rgba(196,164,95,0.22); }
      .notification-icon.system   { background: rgba(176,48,64,0.12);  border: 1px solid rgba(176,48,64,0.22); }
      .notification-icon.success  { background: rgba(93,209,138,0.12); border: 1px solid rgba(93,209,138,0.22); }
      .notification-icon.info     { background: rgba(196,164,95,0.10); border: 1px solid rgba(196,164,95,0.18); }

      .notification-content { flex: 1; }
      .notification-title {
        font-family: var(--font-sans);
        font-size: 13px; font-weight: 700;
        color: var(--text-body); margin-bottom: 3px;
      }
      .notification-message {
        font-family: var(--font-sans);
        font-size: 12px; color: var(--text-muted); line-height: 1.4;
      }
      .notification-meta { display: flex; align-items: center; gap: 10px; margin-top: 7px; }
      .notification-time {
        font-family: var(--font-sans);
        font-size: 10px; color: var(--gold); opacity: 0.65; font-weight: 600;
      }
      .notification-new-badge {
        padding: 2px 7px;
        border-radius: 5px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        font-family: var(--font-sans);
        font-size: 9px; font-weight: 700; color: white;
        text-transform: uppercase; letter-spacing: 0.05em;
      }

      .notification-empty {
        padding: 50px 24px;
        text-align: center;
        color: var(--text-faint);
      }
      .notification-empty-icon { font-size: 42px; margin-bottom: 14px; opacity: 0.28; }
      .notification-empty-text { font-family: var(--font-sans); font-size: 13px; font-weight: 500; }
    </style>
  </head>
  <body>
    <!-- Header Section -->
    <div class="header">
      <div class="header-row-1">
        <h1 class="demo-title">Student Manager</h1>
        <div class="header-actions">
          <button class="btn-header-primary" onclick="openAddStudentModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Student
          </button>
          <button class="btn-header-secondary" onclick="openBulkAddModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            Bulk Add
          </button>
          <button class="btn-header-secondary" onclick="openUploadNotesModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            Upload Notes
          </button>
          <button class="btn-header-secondary" onclick="openWaitingListModal()" id="waitingListBtn" style="position: relative;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            Waiting List
            <span class="notification-badge" id="waitingListBadge" style="display: none;">0</span>
          </button>
          <button class="btn-header-secondary" onclick="openDuplicatesModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            Find Duplicates
          </button>
          <button class="btn-header-secondary" onclick="openPortalRegistrationModal()" title="Portal Registration Instructions">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
          </button>
          <button class="btn-header-secondary" onclick="toggleNotificationCenter()" id="notificationBellBtn" title="Notifications" style="position: relative;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <span class="notification-badge-bell" id="notificationBadge" style="display: none;">0</span>
          </button>
        </div>
      </div>
      <div class="header-row-2">
        <div class="search-input-container">
          <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--gold); opacity: 0.7; pointer-events: none;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="Search by name, group, phone, email, notes, aliases, credit, price..."
            style="padding-left: 42px;"
          />
          <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()" title="Clear search">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
        <select id="groupFilter" class="filter-select">
          <option value="">All Groups</option>
          <option value="A">Group A</option>
          <option value="B">Group B</option>
          <option value="C">Group C</option>
          <option value="D">Group D</option>
          <option value="E">Group E</option>
          <option value="F">Group F</option>
          <option value="no-group">No Group</option>
        </select>
        <select id="statusFilter" class="filter-select">
          <option value="" selected>All Statuses</option>
          <option value="active">Active</option>
          <option value="paused">Paused</option>
          <option value="graduated">Graduated</option>
        </select>
        <select id="paymentFilter" class="filter-select">
          <option value="">All Payment Status</option>
          <option value="unpaid">Unpaid Classes</option>
          <option value="credit">Has Credit Balance</option>
        </select>
        <select id="sortFilter" class="filter-select">
          <option value="">Default Sort (Group + Name)</option>
          <option value="highest">Price: Highest First</option>
          <option value="lowest">Price: Lowest First</option>
        </select>
        <button class="btn-header-clear" id="clearFiltersBtn">Clear Filters</button>
      </div>
    </div>

    <div class="students-grid" id="studentsGrid"></div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="action-modal-backdrop" onclick="if(event.target.id==='addStudentModal'){closeAddStudentModal();}">
      <div class="action-modal-card" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="action-modal-header">
          <h2 class="action-modal-title">Add New Student</h2>
          <button class="action-modal-close" onclick="closeAddStudentModal()">&times;</button>
        </div>

        <!-- Scrollable Content -->
        <div class="action-modal-scroll">
          <div class="action-modal-body">
            <!-- Student Name -->
            <div class="form-group">
              <label class="form-label">Student Name *</label>
              <input type="text" id="newStudentName" class="form-input" placeholder="Enter full name" />
            </div>

            <!-- Group Selection -->
            <div class="form-group">
              <label class="form-label">Group(s)</label>
              <div class="button-group" id="newStudentGroupButtons">
                <button class="toggle-btn" onclick="this.classList.toggle('active')">A</button>
                <button class="toggle-btn" onclick="this.classList.toggle('active')">B</button>
                <button class="toggle-btn" onclick="this.classList.toggle('active')">C</button>
                <button class="toggle-btn" onclick="this.classList.toggle('active')">D</button>
                <button class="toggle-btn" onclick="this.classList.toggle('active')">E</button>
                <button class="toggle-btn" onclick="this.classList.toggle('active')">F</button>
              </div>
              <input type="text" id="newStudentCustomGroup" class="form-input" placeholder="Or enter custom groups (comma-separated)" />
            </div>

            <!-- College -->
            <div class="form-group">
              <label class="form-label">🎓 College/University</label>
              <input type="text" id="newStudentCollege" class="form-input" placeholder="e.g., UCLA, USC, Community College" />
            </div>

            <!-- Pay Per Class -->
            <div class="form-group">
              <label class="form-label">Pay Per Class</label>
              <div class="button-group" id="newStudentPriceButtons">
                <button class="toggle-btn" data-value="25" onclick="this.classList.toggle('active')">$25</button>
                <button class="toggle-btn" data-value="50" onclick="this.classList.toggle('active')">$50</button>
                <button class="toggle-btn" data-value="75" onclick="this.classList.toggle('active')">$75</button>
                <button class="toggle-btn" data-value="100" onclick="this.classList.toggle('active')">$100</button>
              </div>
              <input type="number" id="newStudentCustomPrice" class="form-input" placeholder="Or enter custom amount" />
            </div>

            <!-- Credit Balance -->
            <div class="form-group">
              <label class="form-label" style="color: #eab308">💰 Credit Balance</label>
              <input
                type="number"
                id="newStudentBalance"
                class="form-input"
                placeholder="0.00"
                style="background: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.3); color: #eab308"
              />
            </div>

            <!-- Phone -->
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input type="tel" id="newStudentPhone" class="form-input" placeholder="(555) 123-4567" />
            </div>

            <!-- Email -->
            <div class="form-group">
              <label class="form-label">Email(s)</label>
              <input type="text" id="newStudentEmail" class="form-input" placeholder="email1@example.com, email2@example.com" />
            </div>

            <!-- Notes -->
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea id="newStudentNotes" class="form-textarea" placeholder="Additional notes..."></textarea>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="action-modal-footer">
          <button class="btn-modal-cancel" onclick="closeAddStudentModal()">Cancel</button>
          <button class="btn-modal-save" onclick="handleAddStudent()">Save Student</button>
        </div>
      </div>
    </div>

    <!-- Bulk Add Students Modal -->
    <div id="bulkAddModal" class="action-modal-backdrop" onclick="if(event.target.id==='bulkAddModal'){closeBulkAddModal();}">
      <div class="action-modal-card" onclick="event.stopPropagation()" style="max-width: 750px">
        <!-- Header -->
        <div class="action-modal-header">
          <div>
            <h2 class="action-modal-title">📋 Bulk Add Students</h2>
            <div style="font-size: 14px; color: rgba(138, 180, 255, 0.7); margin-top: 4px; font-weight: 600">Paste or Type Below</div>
          </div>
          <button class="action-modal-close" onclick="closeBulkAddModal()">&times;</button>
        </div>

        <!-- Scrollable Content -->
        <div class="action-modal-scroll">
          <div class="action-modal-body">
            <div style="padding: 14px 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; color: rgba(147, 197, 253, 0.9); font-size: 13px; line-height: 1.6; margin-bottom: 20px">
              <strong style="color: #60a5fa">Flexible Format:</strong> One student per line — comma-separated or labeled
              <br />
              <code style="background: rgba(0, 0, 0, 0.3); padding: 2px 8px; border-radius: 4px; color: #e5e7eb; font-size: 12px">Name, Email, Phone, Group, $Amount</code>
              <br />
              <code style="background: rgba(0, 0, 0, 0.3); padding: 2px 8px; border-radius: 4px; color: #e5e7eb; font-size: 12px">Name (Alias), Email, Phone, Group, $Amount</code>
            </div>

            <div style="margin-bottom: 16px; padding: 10px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.5); font-size: 12px">
              <strong style="color: rgba(255, 255, 255, 0.7)">Examples:</strong>
              <br />
              <span style="font-family: monospace; color: #8ab4ff">
                Hasmik Antonova (Level Up), Hasmik.Antonova@gmail.com, 909-555-4321, A, $100
              </span>
              <br />
              <span style="font-family: monospace; color: #8ab4ff">
                Varduni Nerseyan, Varduni1982@yahoo.com, (818)299-7867, E, $100
              </span>
            </div>

            <textarea
              class="form-textarea"
              placeholder="Paste student records here (one per line)..."
              style="min-height: 280px; font-family: monospace; line-height: 1.8"
            ></textarea>
          </div>
        </div>

        <!-- Footer -->
        <div class="action-modal-footer">
          <button class="btn-modal-cancel" onclick="closeBulkAddModal()">Cancel</button>
          <button class="btn-modal-save" onclick="customAlert('Demo Mode', 'Students added!'); closeBulkAddModal()">Add Students</button>
        </div>
      </div>
    </div>

    <!-- Waiting List Modal -->
    <div id="waitingListModal" class="action-modal-backdrop" onclick="if(event.target.id==='waitingListModal'){closeWaitingListModal();}">
      <div class="action-modal-card" onclick="event.stopPropagation()" style="max-width: 820px">
        <!-- Header -->
        <div class="action-modal-header">
          <div>
            <h2 class="action-modal-title">Student Waiting List</h2>
            <div style="font-family:var(--font-sans);font-size:12px;color:var(--gold);opacity:0.6;margin-top:3px;letter-spacing:0.06em;">PENDING REGISTRATIONS</div>
          </div>
          <button class="action-modal-close" onclick="closeWaitingListModal()" aria-label="Close">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>

        <!-- Scrollable Content -->
        <div class="action-modal-scroll">
          <div class="action-modal-body">
            <!-- Loading State -->
            <div id="waitingListLoading" style="padding: 60px 40px; text-align: center; color: var(--text-faint);">
              <div style="font-size:38px;margin-bottom:14px;opacity:0.5;">⏳</div>
              <div style="font-family:var(--font-sans);font-size:13px;letter-spacing:0.06em;">Loading registrations...</div>
            </div>
            
            <!-- Empty State -->
            <div id="waitingListEmpty" style="display:none;padding:70px 40px;text-align:center;">
              <div style="width:60px;height:60px;border-radius:50%;background:rgba(196,164,95,0.08);border:1px solid rgba(196,164,95,0.15);display:flex;align-items:center;justify-content:center;margin:0 auto 18px;font-size:26px;opacity:0.5;">📭</div>
              <div style="font-family:var(--font-serif);font-size:17px;font-style:italic;color:var(--text-muted);margin-bottom:8px;">No Pending Registrations</div>
              <div style="font-family:var(--font-sans);font-size:12px;color:var(--text-faint);">New students who sign up will appear here</div>
            </div>
            
            <!-- Waiting List Content -->
            <div id="waitingListContent" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Find Duplicates Modal -->
    <div id="duplicatesModal" class="action-modal-backdrop" onclick="if(event.target.id==='duplicatesModal'){closeDuplicatesModal();}">
      <div class="action-modal-card" onclick="event.stopPropagation()" style="max-width: 950px">
        <!-- Header -->
        <div class="action-modal-header">
          <h2 class="action-modal-title">🔍 Duplicate Students</h2>
          <button class="action-modal-close" onclick="closeDuplicatesModal()">&times;</button>
        </div>

        <!-- Scrollable Content -->
        <div class="action-modal-scroll">
          <div class="action-modal-body">
            <div style="padding: 40px; text-align: center; color: rgba(255, 255, 255, 0.4); font-size: 14px">
              <div style="font-size: 48px; margin-bottom: 16px">✓</div>
              <div style="color: #6ee7b7; font-size: 16px; font-weight: 600">No Duplicates Found</div>
              <div style="font-size: 12px; margin-top: 8px">All student records are unique</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Notes Modal -->
    <div id="uploadNotesModal" class="action-modal-backdrop" onclick="if(event.target.id==='uploadNotesModal'){closeUploadNotesModal();}">
      <div class="action-modal-card" onclick="event.stopPropagation()" style="max-width: 650px">
        <div style="padding: 32px 32px 24px">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px">
            <h2 class="action-modal-title">📄 Upload Class Notes (PDF)</h2>
            <button class="modal-close-button" onclick="closeUploadNotesModal()">✕</button>
          </div>

          <!-- Form -->
          <div style="display: flex; flex-direction: column; gap: 20px">
            <!-- Title -->
            <div>
              <label class="form-label">Note Title *</label>
              <input type="text" id="noteTitle" class="form-input" placeholder="e.g., Lecture 1 - Introduction" />
            </div>

            <!-- Description -->
            <div>
              <label class="form-label">Description (Optional)</label>
              <textarea id="noteDescription" class="form-input" rows="2" placeholder="Brief description of the content..."></textarea>
            </div>

            <!-- Group Selection -->
            <div>
              <label class="form-label">For Group *</label>
              <div class="group-buttons" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px">
                <button type="button" class="group-btn" onclick="selectNoteGroup('A')" data-group="A">A</button>
                <button type="button" class="group-btn" onclick="selectNoteGroup('B')" data-group="B">B</button>
                <button type="button" class="group-btn" onclick="selectNoteGroup('C')" data-group="C">C</button>
                <button type="button" class="group-btn" onclick="selectNoteGroup('D')" data-group="D">D</button>
                <button type="button" class="group-btn" onclick="selectNoteGroup('E')" data-group="E">E</button>
                <button type="button" class="group-btn" onclick="selectNoteGroup('F')" data-group="F">F</button>
              </div>
            </div>

            <!-- Class Date -->
            <div>
              <label class="form-label">Class Date *</label>
              <input type="date" id="noteDate" class="form-input" />
            </div>

            <!-- PDF Upload -->
            <div>
              <label class="form-label">PDF File *</label>
              <div style="position: relative">
                <input 
                  type="file" 
                  id="pdfFileInput" 
                  accept=".pdf" 
                  class="form-input"
                  onchange="handlePDFSelect(event)"
                  style="cursor: pointer"
                />
                <div id="pdfFileName" style="margin-top: 8px; font-size: 13px; color: rgba(255,255,255,0.6); display: none;">
                  <span id="pdfFileNameText"></span>
                  <span id="pdfFileSize" style="color: rgba(255,255,255,0.4); margin-left: 8px"></span>
                </div>
              </div>
              <div style="margin-top: 8px; padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: rgba(147, 197, 253, 0.9); font-size: 12px; line-height: 1.5">
                <div><strong>Note:</strong> Students can only view this PDF if they have a paid payment record for this class date.</div>
                <div style="margin-top: 4px">The PDF will be protected (no download, copy disabled, watermarked).</div>
              </div>
            </div>

            <!-- Upload Progress -->
            <div id="uploadProgress" style="display: none;">
              <div style="background: rgba(255,255,255,0.05); border-radius: 8px; height: 6px; overflow: hidden;">
                <div id="uploadProgressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s;"></div>
              </div>
              <div id="uploadProgressText" style="margin-top: 8px; text-align: center; font-size: 13px; color: rgba(255,255,255,0.6);"></div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="action-modal-footer">
          <button class="btn-modal-cancel" onclick="closeUploadNotesModal()">Cancel</button>
          <button class="btn-modal-save" onclick="uploadNote()" id="uploadNoteBtn">📤 Upload Note</button>
        </div>
      </div>
    </div>

    <!-- Student Profile Modal -->
    <div class="modal-backdrop" id="modalBackdrop" onclick="if(event.target.id==='modalBackdrop'){closeModal();}">
      <div
        class="modal-card"
        id="modalCard"
        role="dialog"
        aria-modal="true"
        aria-labelledby="modalName"
        onclick="event.stopPropagation()"
      >
        <button class="modal-close" onclick="closeModal()" aria-label="Close">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>

        <div class="modal-scroll">

          <!-- ── Hero Banner ── -->
          <div class="profile-hero">
            <div class="profile-avatar-large" id="modalAvatar">?</div>
            <div class="profile-hero-info">
              <div class="profile-hero-name" id="modalName">—</div>
              <div class="profile-hero-sub">
                <div class="profile-group-pill" id="modalGroup">—</div>
                <div class="profile-college-line" id="modalCollegeDisplay"></div>
              </div>
              <div class="profile-hero-stats">
                <div class="profile-hero-stat">
                  <div class="profile-hero-stat-label">Pay / Class</div>
                  <div class="profile-hero-stat-val" id="modalPrice">—</div>
                </div>
                <div class="profile-hero-stat">
                  <div class="profile-hero-stat-label">Credit Balance</div>
                  <div class="profile-hero-stat-val" id="modalCreditDisplay" style="color:#fbbf24;">—</div>
                </div>
              </div>
            </div>
            <button
              class="profile-status-btn active"
              id="modalStatusBadge"
              onclick="cycleModalStatus()"
              aria-label="Cycle student status"
            ></button>
          </div>

          <!-- ── Two-column body ── -->
          <div class="profile-body">

            <!-- LEFT COLUMN -->
            <div class="profile-col">
              <div class="profile-section-title">Contact Information</div>

              <div class="profile-field">
                <div class="profile-field-label">Full Name</div>
                <input type="text" id="modalNameInput" class="profile-field-input"
                  placeholder="Student name" />
              </div>

              <div class="profile-field">
                <div class="profile-field-label">Phone</div>
                <input type="tel" id="modalPhone" class="profile-field-input phone-input"
                  placeholder="xxx-xxx-xxxx" />
              </div>

              <div class="profile-field">
                <div class="profile-field-label">Email(s)</div>
                <textarea id="modalEmail" class="profile-field-input email-input"
                  rows="2" placeholder="email@example.com"></textarea>
              </div>

              <div class="profile-field">
                <div class="profile-field-label">College / University</div>
                <input type="text" id="modalCollege" class="profile-field-input college-input"
                  placeholder="e.g., UCLA, USC" />
              </div>

              <div class="profile-section-title" style="margin-top:22px;">Financial</div>

              <div class="profile-field">
                <div class="profile-field-label">Credit Balance ($)</div>
                <input type="text" id="modalCredit" class="profile-field-input credit-input"
                  placeholder="0" />
              </div>

              <div class="profile-field">
                <div class="profile-field-label">Price Per Class</div>
                <div class="price-selector" id="amountButtons">
                  <button class="price-btn" onclick="selectAmount('25 $', this)">$25</button>
                  <button class="price-btn" onclick="selectAmount('50 $', this)">$50</button>
                  <button class="price-btn" onclick="selectAmount('75 $', this)">$75</button>
                  <button class="price-btn" onclick="selectAmount('100 $', this)">$100</button>
                </div>
              </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="profile-col">
              <div class="profile-section-title">Group Assignment</div>

              <div class="profile-field">
                <div class="profile-field-label">Group</div>
                <div class="group-selector" id="groupButtons">
                  <button class="group-btn" onclick="selectGroup('A', this)">A</button>
                  <button class="group-btn" onclick="selectGroup('B', this)">B</button>
                  <button class="group-btn" onclick="selectGroup('C', this)">C</button>
                  <button class="group-btn" onclick="selectGroup('D', this)">D</button>
                  <button class="group-btn" onclick="selectGroup('E', this)">E</button>
                  <button class="group-btn" onclick="selectGroup('F', this)">F</button>
                </div>
              </div>

              <div class="profile-section-title" style="margin-top:22px;">Visibility</div>

              <div class="profile-toggle-row">
                <div class="profile-toggle-label">
                  Show in Calendar
                  <span>Include this student in calendar payment grid</span>
                </div>
                <label class="elegant-toggle" onclick="event.stopPropagation()">
                  <input type="checkbox" id="modalCalendarToggle"
                    onchange="handleModalCalendarToggle(this)" />
                  <span class="elegant-toggle-slider"></span>
                </label>
              </div>

              <div class="profile-section-title" style="margin-top:4px;">Notes & Aliases</div>

              <div class="profile-field">
                <div class="profile-field-label">Payment Aliases</div>
                <textarea id="modalAliases" class="profile-field-input aliases-input"
                  rows="2" placeholder="Comma-separated names used in Zelle/Venmo"></textarea>
              </div>

              <div class="profile-field">
                <div class="profile-field-label">Internal Notes</div>
                <textarea id="modalNotes" class="profile-field-input notes-input"
                  rows="4" placeholder="Any notes about this student..."></textarea>
              </div>
            </div>

          </div><!-- /.profile-body -->
        </div><!-- /.modal-scroll -->

        <!-- ── Footer ── -->
        <div class="modal-footer">
          <div class="modal-footer-left">
            <button class="btn-profile-delete" onclick="handleModalDelete()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:5px;vertical-align:middle;"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
              Delete Student
            </button>
          </div>
          <div class="modal-footer-right">
            <span class="save-indicator" id="modalSaveIndicator">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
              Saved
            </span>
            <button class="btn-profile-close" onclick="closeModal()">Close</button>
            <button class="btn-profile-save" onclick="handleModalSave()">Save Changes</button>
          </div>
        </div>

      </div>
    </div>

    <!-- Portal Registration Instructions - Select Students Modal -->
    <div id="portalRegistrationModal" class="action-modal-backdrop" onclick="if(event.target.id==='portalRegistrationModal'){closePortalRegistrationModal();}">
      <div class="action-modal-card" onclick="event.stopPropagation()" style="max-width: 800px">
        <!-- Header -->
        <div class="action-modal-header">
          <h2 class="action-modal-title">📧 Send Portal Registration Instructions</h2>
          <button class="action-modal-close" onclick="closePortalRegistrationModal()">&times;</button>
        </div>

        <!-- Scrollable Content -->
        <div class="action-modal-scroll">
          <div class="action-modal-body">
            <!-- Search Box -->
            <div style="margin-bottom: 20px;">
              <input 
                type="text" 
                id="portalRegSearchInput" 
                class="search-input" 
                placeholder="🔍 Search by name or email..." 
                oninput="filterPortalRegistrationStudents()"
                style="width: 100%; max-width: 100%;"
              />
            </div>

            <!-- Group Filter -->
            <div style="margin-bottom: 20px;">
              <select id="portalRegGroupFilter" class="filter-select" onchange="filterPortalRegistrationStudents()" style="width: 200px;">
                <option value="">All Groups</option>
                <option value="A">Group A</option>
                <option value="B">Group B</option>
                <option value="C">Group C</option>
                <option value="D">Group D</option>
                <option value="E">Group E</option>
                <option value="F">Group F</option>
                <option value="no-group">No Group</option>
              </select>
            </div>

            <!-- Select All -->
            <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: rgba(255, 255, 255, 0.8); font-size: 14px;">
                <input 
                  type="checkbox" 
                  id="selectAllPortalReg" 
                  onchange="toggleSelectAllPortalReg()"
                  style="width: 18px; height: 18px; cursor: pointer;"
                />
                <span>Select All</span>
              </label>
              <span id="portalRegSelectedCount" style="color: rgba(255, 255, 255, 0.5); font-size: 13px;">Selected: 0</span>
            </div>

            <!-- Student List -->
            <div id="portalRegStudentList" style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;">
              <!-- Students will be rendered here -->
            </div>

            <!-- Footer Buttons -->
            <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
              <button class="btn-modal-cancel" onclick="closePortalRegistrationModal()">Cancel</button>
              <button class="btn-modal-save" onclick="openPortalRegistrationPreview()" id="portalRegNextBtn" disabled>
                Next (Review Email)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Portal Registration Instructions - Email Preview Modal -->
    <div id="portalRegistrationPreviewModal" class="action-modal-backdrop" onclick="if(event.target.id==='portalRegistrationPreviewModal'){closePortalRegistrationPreview();}">
      <div class="action-modal-card" onclick="event.stopPropagation()" style="max-width: 900px">
        <!-- Header -->
        <div class="action-modal-header">
          <h2 class="action-modal-title">📧 Preview & Send Portal Registration Instructions</h2>
          <button class="action-modal-close" onclick="closePortalRegistrationPreview()">&times;</button>
        </div>

        <!-- Scrollable Content -->
        <div class="action-modal-scroll">
          <div class="action-modal-body">
            <!-- Recipients -->
            <div style="margin-bottom: 20px;">
              <label class="form-label">To:</label>
              <div id="portalRegRecipientsList" style="padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; font-size: 13px; color: rgba(255, 255, 255, 0.7); max-height: 120px; overflow-y: auto;">
                <!-- Recipients will be listed here -->
              </div>
            </div>

            <!-- Subject -->
            <div style="margin-bottom: 20px;">
              <label class="form-label">Subject:</label>
              <input 
                type="text" 
                id="portalRegSubject" 
                class="form-input" 
                value="Portal Registration Instructions"
              />
            </div>

            <!-- Email Preview (HTML) -->
            <div style="margin-bottom: 20px;">
              <label class="form-label">Email Preview:</label>
              <div style="background: #f5f5f5; border-radius: 8px; padding: 16px; max-height: 500px; overflow-y: auto; border: 1px solid rgba(255, 255, 255, 0.1);">
                <iframe 
                  id="portalRegEmailPreview" 
                  style="width: 100%; min-height: 600px; border: none; background: white; border-radius: 4px;"
                  title="Email Preview"
                ></iframe>
              </div>
              <div style="font-size: 12px; color: rgba(255, 255, 255, 0.4); margin-top: 8px;">
                Preview shows how the email will appear to {{student_name}}
              </div>
            </div>

            <!-- Editable Body (Hidden by default, can be toggled) -->
            <div style="margin-bottom: 20px; display: none;" id="portalRegEditBodySection">
              <label class="form-label">Message Body (Advanced Edit):</label>
              <textarea 
                id="portalRegBody" 
                class="form-input" 
                rows="15" 
                style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 14px; line-height: 1.6; white-space: pre-wrap;"
              ></textarea>
              <div style="font-size: 12px; color: rgba(255, 255, 255, 0.4); margin-top: 8px;">
                Variables: {{student_name}}, {{student_email}}
              </div>
            </div>

            <!-- Progress Indicator -->
            <div id="portalRegProgress" style="display: none; margin-bottom: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; text-align: center;">
              <div style="font-size: 14px; color: rgba(147, 197, 253, 0.9); margin-bottom: 8px;">
                <span id="portalRegProgressText">Sending emails...</span>
              </div>
              <div style="width: 100%; height: 6px; background: rgba(0, 0, 0, 0.3); border-radius: 3px; overflow: hidden;">
                <div id="portalRegProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease;"></div>
              </div>
            </div>

            <!-- Footer Buttons -->
            <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
              <button class="btn-modal-cancel" onclick="closePortalRegistrationPreview()" id="portalRegBackBtn">Back</button>
              <button class="btn-modal-save" onclick="sendPortalRegistrationEmails()" id="portalRegSendBtn">
                ✉️ Confirm & Send
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ============================================================
      // UTILITY FUNCTIONS
      // ============================================================
      
      // Debounce function to limit how often a function is called
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
      
      // Throttle function to ensure function is called at most once per interval
      function throttle(func, limit) {
        let inThrottle;
        return function(...args) {
          if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      }

      function canonicalizeGroupCode(value) {
        if (!value) return '';
        const raw = value.toString().trim();
        if (!raw) return '';
        
        // Handle special "No Group" cases
        if (/^(no\s*group|nogroup)$/i.test(raw)) return '';
        
        let normalized = raw.replace(/^group\s+/i, '');
        normalized = normalized.replace(/[^a-z0-9]/gi, '');
        return normalized.toUpperCase();
      }

      function formatGroupDisplay(code) {
        if (!code) return 'No Group';
        return `Group ${code}`;
      }

      async function normalizeStudentGroupNames(fixes = []) {
        if (!Array.isArray(fixes) || fixes.length === 0 || !supabaseClient) {
          return;
        }

        const chunkSize = 10;
        for (let i = 0; i < fixes.length; i += chunkSize) {
          const chunk = fixes.slice(i, i + chunkSize);
          const updates = chunk.map(async fix => {
            const { error } = await supabaseClient
              .from('students')
              .update({ group_name: fix.groupCode })
              .eq('id', fix.id);

            if (error) {
              console.error('❌ Failed to normalize group name', fix, error);
            }
          });

          await Promise.allSettled(updates);
        }
      }

      async function normalizeStudentEmails(fixes = []) {
        if (!Array.isArray(fixes) || fixes.length === 0 || !supabaseClient) {
          return;
        }

        const chunkSize = 10;
        for (let i = 0; i < fixes.length; i += chunkSize) {
          const chunk = fixes.slice(i, i + chunkSize);
          const updates = chunk.map(async fix => {
            const { error } = await supabaseClient
              .from('students')
              .update({ email: fix.email })
              .eq('id', fix.id);

            if (error) {
              console.error('❌ Failed to normalize email address', fix, error);
            }
          });

          await Promise.allSettled(updates);
        }
      }
      
      // ============================================================
      // ⚡ PERFORMANCE OPTIMIZATION UTILITIES
      // ============================================================
      
      // Production mode flag - set to false to disable debug logging
      const DEBUG_MODE = false;
      
      // Debug logging wrapper
      function debugLog(...args) {
        if (DEBUG_MODE) console.log(...args);
      }
      
      // DOM Cache for frequently accessed elements
      const DOMCache = {
        studentsGrid: null,
        searchInput: null,
        groupFilter: null,
        statusFilter: null,
        paymentFilter: null,
        sortSelect: null,
        modals: {},
        modalFields: {}, // Cache modal form fields
        
        init() {
          this.studentsGrid = document.getElementById('studentsGrid');
          this.searchInput = document.getElementById('searchInput');
          this.groupFilter = document.getElementById('groupFilter');
          this.statusFilter = document.getElementById('statusFilter');
          this.paymentFilter = document.getElementById('paymentFilter');
          this.sortSelect = document.getElementById('sortSelect');
          
          // Cache modal backdrop
          this.modalBackdrop = document.getElementById('modalBackdrop');
          
          // Cache modal form fields for instant access
          const modalFieldIds = [
            'modalName', 'modalNameInput', 'modalGroup', 'modalPrice', 'modalCreditDisplay',
            'modalCredit', 'modalPhone', 'modalEmail', 'modalCollege', 'modalCollegeDisplay',
            'modalAliases', 'modalNotes', 'modalStatusBadge', 'modalAvatar',
            'modalCalendarToggle', 'modalSaveIndicator', 'groupButtons', 'amountButtons'
          ];
          modalFieldIds.forEach(id => {
            this.modalFields[id] = document.getElementById(id);
          });
          
          // Cache modal elements
          ['addStudentModal', 'bulkAddModal', 'waitingListModal', 'duplicatesModal', 'studentModal'].forEach(id => {
            const modal = document.getElementById(id);
            if (modal) {
              this.modals[id] = {
                element: modal,
                title: modal.querySelector('.action-modal-title, .modal-title'),
                body: modal.querySelector('.action-modal-body, .modal-body'),
                content: modal.querySelector('.modal-content')
              };
            }
          });
          
          debugLog('✅ DOM Cache initialized');
        },
        
        get(key) {
          return this[key] || document.getElementById(key);
        },
        
        invalidate(key) {
          if (key) {
            this[key] = null;
          } else {
            Object.keys(this).forEach(k => {
              if (typeof this[k] !== 'function') this[k] = null;
            });
          }
        }
      };
      
      // Data Cache for expensive computations
      const DataCache = {
        students: null,
        groups: null,
        lastFetch: {},
        computedValues: new Map(),
        
        TTL: 5 * 60 * 1000, // 5 minutes
        
        set(key, value) {
          this[key] = value;
          this.lastFetch[key] = Date.now();
        },
        
        get(key) {
          const now = Date.now();
          const lastFetch = this.lastFetch[key] || 0;
          
          if (this[key] && (now - lastFetch) < this.TTL) {
            debugLog(`✅ Cache HIT: ${key}`);
            return this[key];
          }
          
          debugLog(`⚠️ Cache MISS: ${key}`);
          return null;
        },
        
        invalidate(key) {
          if (key) {
            this[key] = null;
            this.lastFetch[key] = 0;
            debugLog(`🔄 Cache invalidated: ${key}`);
          } else {
            Object.keys(this).forEach(k => {
              if (typeof this[k] !== 'function' && k !== 'TTL' && k !== 'computedValues') {
                this[k] = null;
              }
            });
            this.lastFetch = {};
            this.computedValues.clear();
            debugLog('🔄 All caches cleared');
          }
        }
      };
      
      // RequestAnimationFrame wrapper for smooth UI updates
      let rafCallbacks = {};
      
      function scheduleRAF(key, callback) {
        if (rafCallbacks[key]) {
          cancelAnimationFrame(rafCallbacks[key]);
        }
        
        rafCallbacks[key] = requestAnimationFrame(() => {
          callback();
          delete rafCallbacks[key];
        });
      }
      
      function cancelRAF(key) {
        if (rafCallbacks[key]) {
          cancelAnimationFrame(rafCallbacks[key]);
          delete rafCallbacks[key];
        }
      }
      
      // ============================================================
      // SUPABASE CLIENT INITIALIZATION
      // ============================================================
  const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';

      let supabaseClient = null;
      let students = [];
      let filteredStudents = [];
      
      // Make variables globally accessible for debugging
      window.students = students;
      window.filteredStudents = filteredStudents;

      // ============================================================
      // 🔒 ADMIN AUTHENTICATION
      // ============================================================
      async function requireAdminSession() {
        try {
          const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
          
          if (sessionError || !session) {
            console.error('❌ No session found:', sessionError);
            console.log('📍 Current Supabase URL:', SUPABASE_URL);
            alert('⛔ Access Denied\n\nThis page is for administrators only.\n\nYou will be redirected to the login page.');
            window.location.href = 'index.html';
            return false;
          }

          console.log('✅ Session found for:', session.user.email, '| User ID:', session.user.id);
          console.log('📍 Checking admin_accounts in:', SUPABASE_URL);
          
          // Check if user is in admin_accounts table
          const { data: adminAccount, error: adminError } = await supabaseClient
            .from('admin_accounts')
            .select('*')
            .eq('auth_user_id', session.user.id)
            .maybeSingle();

          if (adminError) {
            console.error('❌ Admin check query failed:', adminError);
            console.log('📊 Query details - auth_user_id:', session.user.id);
            alert('⛔ Access Denied\n\nDatabase error checking admin status.\n\nError: ' + adminError.message + '\n\nYou will be redirected to the login page.');
            window.location.href = 'index.html';
            return false;
          }
          
          if (!adminAccount) {
            console.log('❌ User is not an admin (no record in admin_accounts)');
            console.log('📊 Searched for auth_user_id:', session.user.id);
            console.log('💡 TIP: This user may need to be added to admin_accounts table');
            alert('⛔ Access Denied\n\nThis page is for administrators only.\n\nYour account (' + session.user.email + ') is not in the admin list.\n\nYou will be redirected to the login page.');
            window.location.href = 'index.html';
            return false;
          }

          console.log('✅ Admin access verified:', adminAccount.email, '| Role:', adminAccount.role || 'N/A');
          return true;
        } catch (error) {
          console.error('❌ Admin auth error:', error);
          alert('⛔ Access Denied\n\nUnexpected error checking admin status.\n\nError: ' + error.message + '\n\nYou will be redirected to the login page.');
          window.location.href = 'index.html';
          return false;
        }
      }

      // Initialize Supabase client
      if (window.supabase && window.supabase.createClient) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        debugLog('✅ Supabase client initialized');
        
        // 🔒 AUTHENTICATION CHECK - Require admin access
        supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
          if (!session) {
            // No session - redirect to login
            debugLog('❌ No active session - redirecting to login');
            window.location.href = 'index.html';
            return;
          }
          
          debugLog('🔒 Checking admin access...');
          
          // 🔒 CRITICAL: Verify admin access BEFORE loading any data
          const isAdmin = await requireAdminSession();
          if (!isAdmin) {
            return; // Stop execution - user will be redirected
          }
          
          debugLog('✅ Admin access verified, loading students...');
          loadStudents();
        });
      } else {
        // Keep errors visible even in production
        console.error('❌ Supabase library not loaded');
      }

      // ============================================================
      // LOAD STUDENTS FROM SUPABASE
      // ============================================================
      
      function toNumericAmount(value) {
        if (typeof value === 'number' && Number.isFinite(value)) {
          return value;
        }
        if (typeof value === 'string') {
          const cleaned = value.replace(/[^0-9.-]/g, '');
          const parsed = parseFloat(cleaned);
          return Number.isFinite(parsed) ? parsed : 0;
        }
        const numeric = Number(value);
        return Number.isFinite(numeric) ? numeric : 0;
      }

      // Helper function to format price for display
      function formatPrice(value) {
        if (typeof value === 'string') {
          // If already formatted like "100 $", return as-is
          if (value.includes('$')) return value;
          // Otherwise parse and format
          const num = toNumericAmount(value);
          return `${num || 0} $`;
        }
        // If number, format it
        return `${toNumericAmount(value) || 0} $`;
      }

      // Helper function to format credit for display (including +/- and K format)
      function formatCredit(value) {
        const amount = toNumericAmount(value);
        const absAmount = Math.abs(amount);

        const formatAmount = (amt) => {
          if (amt >= 1000) {
            const formatted = (amt / 1000).toFixed(amt % 1000 === 0 ? 0 : 1).replace(/\.0$/, '');
            return `${formatted}K $`;
          }
          return `${Math.round(amt)} $`;
        };

        if (amount > 0) {
          return `+${formatAmount(absAmount)}`;
        }
        if (amount < 0) {
          return `-${formatAmount(absAmount)}`;
        }
        return '0 $';
      }
      
      // Helper function to parse email field (handles JSON strings, arrays, and regular strings)
      function parseEmailField(emailData) {
        if (!emailData) return [];
        
        // If it's already an array, return it
        if (Array.isArray(emailData)) {
          return emailData;
        }
        
        // If it's a string that looks like JSON array
        if (typeof emailData === 'string') {
          // Try to parse as JSON
          if (emailData.startsWith('[') && emailData.endsWith(']')) {
            try {
              const parsed = JSON.parse(emailData);
              return Array.isArray(parsed) ? parsed : [emailData];
            } catch (e) {
              // If parsing fails, treat as single email
              return [emailData];
            }
          }
          // Regular string email
          return [emailData];
        }
        
        return [];
      }

      function toEmailEntryArray(emailData) {
        if (!emailData) return [];
        if (Array.isArray(emailData)) return emailData;
        if (typeof emailData === 'string') {
          return emailData.split(/[\n,]/);
        }
        return [];
      }

      function normalizeEmailList(emailData) {
        const seen = new Set();
        return toEmailEntryArray(emailData)
          .map(entry => typeof entry === 'string' ? entry.trim().toLowerCase() : '')
          .filter(entry => entry && !seen.has(entry) && (seen.add(entry) || true));
      }

      function getPrimaryEmailValue(emailData) {
        const normalized = normalizeEmailList(emailData);
        return normalized.length ? normalized[0] : null;
      }

      function requiresEmailNormalization(rawEmailValue) {
        if (!rawEmailValue) return false;
        if (Array.isArray(rawEmailValue)) return true;
        if (typeof rawEmailValue === 'string') {
          const trimmed = rawEmailValue.trim();
          return trimmed.startsWith('[') && trimmed.endsWith(']');
        }
        return false;
      }

      // ============================================================
      // ALIAS PARSING & CLEANING UTILITIES
      // ============================================================
      
      /**
       * Parse aliases field from database - handles arrays, JSON strings, and comma-separated strings
       * Also CLEANS weird characters that shouldn't be in names
       */
      function parseAliasesField(aliasData) {
        if (!aliasData) return [];
        
        let rawAliases = [];
        
        // If it's already an array, use it
        if (Array.isArray(aliasData)) {
          rawAliases = aliasData;
        }
        // If it's a string that looks like JSON array
        else if (typeof aliasData === 'string') {
          const trimmed = aliasData.trim();
          
          // Try to parse as JSON array
          if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
            try {
              const parsed = JSON.parse(trimmed);
              rawAliases = Array.isArray(parsed) ? parsed : [trimmed];
            } catch (e) {
              // If parsing fails, treat as comma-separated
              rawAliases = trimmed.split(',');
            }
          }
          // Comma-separated string
          else if (trimmed.includes(',')) {
            rawAliases = trimmed.split(',');
          }
          // Single alias string
          else {
            rawAliases = [trimmed];
          }
        }
        
        // Clean each alias: remove weird characters, trim whitespace
        return rawAliases
          .map(alias => {
            if (typeof alias !== 'string') return '';
            
            return alias
              .trim()
              // Remove control characters, zero-width spaces, etc.
              .replace(/[\u0000-\u001F\u007F-\u009F\u200B-\u200D\uFEFF]/g, '')
              // Remove bracket characters [] that appear in alias text
              .replace(/[\[\]]/g, '')
              // Remove any other weird invisible characters
              .replace(/\s+/g, ' ') // Normalize multiple spaces to single space
              .trim();
          })
          .filter(alias => alias && alias.length > 0); // Remove empty strings
      }
      
      /**
       * Clean and normalize aliases before saving to database
       */
      function cleanAliasesForSave(aliases) {
        if (!Array.isArray(aliases)) return [];
        
        return aliases
          .map(alias => {
            if (typeof alias !== 'string') return '';
            
            return alias
              .trim()
              // Remove ALL control characters, zero-width spaces, invisible chars
              .replace(/[\u0000-\u001F\u007F-\u009F\u200B-\u200D\uFEFF]/g, '')
              // Remove bracket characters [] that appear in alias text
              .replace(/[\[\]]/g, '')
              // Normalize whitespace
              .replace(/\s+/g, ' ')
              .trim();
          })
          .filter(alias => alias && alias.length > 0); // Remove empty entries
      }

      async function loadStudents() {
        if (!supabaseClient) {
          console.error('❌ Supabase not initialized');
          students = [];
          return;
        }

        try {
          const { data, error } = await supabaseClient
            .from('students')
            .select('*')
            .order('group_name', { ascending: true })
            .order('name', { ascending: true });

          if (error) throw error;

          const pendingGroupFixes = [];
          const pendingEmailFixes = [];

          if (data) {
            debugLog('🔍 STUDENT MANAGER DEBUG: Raw Supabase data:', data);
            
            // Convert Supabase format to internal format
            students = data.map(s => {
              const groupCode = canonicalizeGroupCode(s.group_name || s.group || '');
              if (
                s.group_name &&
                groupCode &&
                s.group_name !== groupCode
              ) {
                pendingGroupFixes.push({ id: s.id, groupCode });
              }
              const existingEmailList = parseEmailField(s.email);
              const normalizedEmails = normalizeEmailList(existingEmailList);
              const primaryEmail = normalizedEmails[0] || '';
              if (primaryEmail && requiresEmailNormalization(s.email)) {
                pendingEmailFixes.push({ id: s.id, email: primaryEmail });
              }
              const mappedStudent = {
                id: s.id,
                name: s.name,
                group: formatGroupDisplay(groupCode),
                groupCode,
                price_per_class: s.price_per_class || 0,
                balance: s.balance || 0,
                phone: s.phone || '',
                email: primaryEmail,
                college: s.college || '',
                aliases: parseAliasesField(s.aliases),
                notes: s.notes || '',
                status: s.status || 'active',
                showInCalendar: s.show_in_grid !== false
              };
              
              debugLog(`👤 Student ${mappedStudent.id} (${mappedStudent.name}):`, {
                supabase_show_in_grid: s.show_in_grid,
                mapped_showInCalendar: mappedStudent.showInCalendar,
                calculation: `${s.show_in_grid} !== false = ${s.show_in_grid !== false}`
              });
              
              return mappedStudent;
            });

            if (pendingGroupFixes.length) {
              debugLog(`🧹 Normalizing ${pendingGroupFixes.length} legacy group names...`);
              await normalizeStudentGroupNames(pendingGroupFixes);
            }
            if (pendingEmailFixes.length) {
              debugLog(`✉️ Normalizing ${pendingEmailFixes.length} legacy email entries...`);
              await normalizeStudentEmails(pendingEmailFixes);
            }
            debugLog(`✅ Loaded ${students.length} students from Supabase`);
            debugLog('📊 Students by Group:', students.reduce((acc, s) => {
              acc[s.groupCode] = (acc[s.groupCode] || 0) + 1;
              return acc;
            }, {}));
          } else {
            students = [];
          }

          // Initialize filtered students
          filteredStudents = students;
          
          // Update window references for console debugging
          window.students = students;
          window.filteredStudents = filteredStudents;
          
          debugLog(`✅ Students loaded and accessible via console: window.students (${students.length}), window.filteredStudents (${filteredStudents.length})`);
          
          // Apply default filters (active status)
          applyFilters();
        } catch (e) {
          console.error('❌ Error loading students from Supabase:', e);
          students = [];
          filteredStudents = [];
          renderStudentCards();
        }
      }

      // ============================================================
      // ENSURE GROUP EXISTS IN GROUPS TABLE (AUTO-CREATE)
      // ============================================================
      async function ensureGroupExists(groupCode) {
        if (!groupCode || groupCode.trim() === '') return;
        
        try {
          const normalizedGroup = groupCode.toString().trim().toUpperCase();
          console.log('🔍 Checking if group exists:', normalizedGroup);
          
          // Check if group already exists
          const { data: existingGroups, error: fetchError } = await supabaseClient
            .from('groups')
            .select('*')
            .eq('group_name', normalizedGroup);
          
          if (fetchError) {
            console.error('❌ Error checking for existing group:', fetchError);
            return;
          }
          
          if (existingGroups && existingGroups.length > 0) {
            console.log('✅ Group already exists:', normalizedGroup);
            return; // Group already exists
          }
          
          // Create the group with default settings
          console.log('📝 Creating new group in database:', normalizedGroup);
          const { data: newGroup, error: insertError } = await supabaseClient
            .from('groups')
            .insert([{
              group_name: normalizedGroup,
              schedule: 'Friday: 8:00 AM', // Default schedule - admin can change in Group Manager
              one_time_schedules: [],
              active: true, // Active by default
              color: null,
              updated_at: new Date().toISOString()
            }])
            .select();
          
          if (insertError) {
            console.error('❌ Error creating group:', insertError);
            return;
          }
          
          console.log('✅ Group created successfully:', newGroup[0]);
        } catch (err) {
          console.error('❌ Exception in ensureGroupExists:', err);
        }
      }

      // ============================================================
      // SAVE STUDENT TO SUPABASE
      // ============================================================
      async function saveStudent(student) {
        if (!supabaseClient) {
          console.error('❌ Supabase not initialized');
          return false;
        }

        let studentData = null; // Declare here so it's accessible in catch block

        try {
          const resolvedGroupCode = student.groupCode || canonicalizeGroupCode(student.group || '');
          const resolvedGroupName = formatGroupDisplay(resolvedGroupCode);
          student.groupCode = resolvedGroupCode;
          student.group = resolvedGroupName;
          
          // ✅ AUTO-CREATE GROUP: Ensure group exists in groups table when assigning to student
          if (resolvedGroupCode && resolvedGroupCode.trim() !== '') {
            await ensureGroupExists(resolvedGroupCode);
          }
          
          const normalizedEmailList = normalizeEmailList(student.email);
          const primaryEmail = normalizedEmailList[0] || null;
          student.email = primaryEmail;

          // Generate student_id if creating new student (not updating)
          // Use timestamp + random to ensure uniqueness
          const generatedStudentId = !student.id ? Date.now() : null;
          
          studentData = {
            name: student.name,
            group_name: resolvedGroupCode || null,
            price_per_class: typeof student.price_per_class === 'number' 
              ? student.price_per_class 
              : parseInt(student.price_per_class) || 0,
            balance: typeof student.balance === 'number'
              ? student.balance
              : parseInt(student.balance) || 0,
            phone: student.phone || null,  // Ensure null instead of empty string
            email: primaryEmail,
            college: student.college || null,
            aliases: (() => {
              const cleaned = cleanAliasesForSave(student.aliases || []);
              // CRITICAL: Convert array to comma-separated TEXT (not JSON!)
              // Database expects "Alias1, Alias2" not ["Alias1","Alias2"]
              return cleaned.length > 0 ? cleaned.join(', ') : null;
            })(),
            notes: student.notes || '',
            status: student.status || 'active',
            role: student.role || 'student',  // CRITICAL: Must be 'student' or 'admin'
            show_in_grid: student.showInCalendar !== false
          };
          
          // Add student_id for new students only
          if (generatedStudentId) {
            studentData.student_id = generatedStudentId;
          }

          console.log('📝 Student data to save:', {
            name: studentData.name,
            group: studentData.group_name,
            phone: studentData.phone,
            email: studentData.email,
            student_id: studentData.student_id,
            aliases: studentData.aliases,
            aliasesType: typeof studentData.aliases,
            fullStudentData: studentData
          });

          debugLog(`💾 Saving ${student.name}:`, {
            showInCalendar_JS: student.showInCalendar,
            show_in_grid_DB: studentData.show_in_grid
          });

          let result;
          if (student.id) {
            // Update existing student
            result = await supabaseClient
              .from('students')
              .update(studentData)
              .eq('id', student.id)
              .select();
          } else {
            // Insert new student
            result = await supabaseClient
              .from('students')
              .insert([studentData])
              .select();
          }

          if (result.error) {
            // Special handling for aliases constraint violation
            if (result.error.code === '23514' && result.error.message.includes('aliases_no_special_chars')) {
              console.error('❌ Aliases constraint violation. Retrying with NULL aliases...');
              
              // Retry with NULL aliases (not empty array, as [] gets stringified to "[]")
              studentData.aliases = null;
              
              if (student.id) {
                result = await supabaseClient
                  .from('students')
                  .update(studentData)
                  .eq('id', student.id)
                  .select();
              } else {
                result = await supabaseClient
                  .from('students')
                  .insert([studentData])
                  .select();
              }
              
              if (result.error) throw result.error;
              
              console.warn('⚠️ Student saved with NULL aliases. Original aliases had special characters.');
            } else {
              throw result.error;
            }
          }

          debugLog('✅ Student saved to Supabase:', result.data[0]);
          debugLog(`   show_in_grid saved as:`, result.data[0].show_in_grid);
          return result.data[0];
        } catch (e) {
          console.error('❌ Error saving student to Supabase:', e);
          console.error('❌ Full error object:', JSON.stringify(e, null, 2));
          console.error('❌ Error details:', {
            message: e.message,
            code: e.code,
            details: e.details,
            hint: e.hint,
            studentData: studentData
          });
          return false;
        }
      }

      // ============================================================
      // DELETE STUDENT FROM SUPABASE
      // ============================================================
      async function deleteStudentFromDB(studentId) {
        if (!supabaseClient) {
          console.error('❌ Supabase not initialized');
          return false;
        }

        try {
          const { error } = await supabaseClient
            .from('students')
            .delete()
            .eq('id', studentId);

          if (error) throw error;

          debugLog('✅ Student deleted from Supabase:', studentId);
          return true;
        } catch (e) {
          console.error('❌ Error deleting student from Supabase:', e);
          return false;
        }
      }

      // ============================================================
      // STUDENT UI FUNCTIONS
      // ============================================================

      function getGroupLetter(groupValue) {
        const source = typeof groupValue === 'string'
          ? groupValue
          : groupValue?.groupCode || groupValue?.group || '';
        const normalized = canonicalizeGroupCode(source);
        if (!normalized) return ''; // Return empty string instead of '?'
        const trailingLetters = normalized.match(/[A-Z]+$/);
        if (trailingLetters && trailingLetters[0]) {
          return trailingLetters[0];
        }
        return normalized.slice(-2) || normalized;
      }

      let currentStudent = null;

      // ✅ formatCredit() and formatPrice() now defined at line ~1928 (removed duplicates)

      // Format phone to xxx-xxx-xxxx
      function formatPhone(phone) {
        if (!phone) return '';
        const cleaned = phone.replace(/\D/g, '');
        if (cleaned.length === 10) {
          return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
        }
        return phone;
      }

      function getStatusIcon(status) {
        if (status === 'active') {
          return `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
        } else if (status === 'paused') {
          return `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 9v6m4-6v6"></path></svg>`;
        } else {
          return `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        }
      }

      // Cache for SVG icons to avoid recreating them
      const svgIconCache = {
        dollar: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>`
      };

      // Lazy loading configuration
      let currentlyRenderedCount = 30; // Initial cards to render
      const cardsPerBatch = 20; // Load this many more when scrolling
      let isLoadingMore = false;

      function renderStudentCards(forceFullRender = false) {
        // ⚡ Performance: Use cached DOM element
        const grid = DOMCache.studentsGrid || document.getElementById('studentsGrid');
        
        // Use filtered students if filters are active, otherwise use all students
        const sourceStudents = filteredStudents.length > 0 || 
                               DOMCache.searchInput?.value || 
                               DOMCache.groupFilter?.value ||
                               DOMCache.paymentFilter?.value ||
                               DOMCache.sortFilter?.value
          ? filteredStudents 
          : students;
        
        // DEBUG: Check which array we're using
        debugLog(`📋 Rendering from:`, filteredStudents.length > 0 ? 'filteredStudents' : 'students');
        debugLog(`   Total students: ${students.length}, Filtered students: ${filteredStudents.length}`);
        debugLog(`   Source students to render: ${sourceStudents.length}`);
        const hiddenStudents = students.filter(s => !sourceStudents.includes(s));
        if (hiddenStudents.length > 0) {
          debugLog(`   ⚠️ Hidden students (${hiddenStudents.length}):`, hiddenStudents.map(s => `${s.name} (showInCalendar=${s.showInCalendar})`));
        }
        
        // Determine how many cards to render
        const studentsToRender = forceFullRender ? sourceStudents : sourceStudents.slice(0, currentlyRenderedCount);
        
        // Debug: Log first 3 students' toggle states
        debugLog('🎨 Rendering cards - Toggle states:');
        studentsToRender.slice(0, 3).forEach(s => {
          debugLog(`  ${s.name}: showInCalendar=${s.showInCalendar}, will render as ${s.showInCalendar ? 'CHECKED' : 'UNCHECKED'}`);
        });
        
        // Use DocumentFragment for better performance
        const fragment = document.createDocumentFragment();
        const tempDiv = document.createElement('div');
        
        // Show "no results" message if filtered and empty
        if (studentsToRender.length === 0) {
          grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.5); font-size: 16px;">No students found matching your filters.</div>';
          return;
        }
        
        // Build HTML string (faster than creating elements one by one)
        const cardsHTML = studentsToRender
          .map(student => {
            const balanceAmount = toNumericAmount(student.balance);
            return `
          <div class="student-card" data-student-id="${student.id}">
            <div class="card-toggle">
              <label class="elegant-toggle" onclick="event.stopPropagation()">
                <input type="checkbox" ${student.showInCalendar ? 'checked' : ''} data-action="toggle-calendar" data-student-id="${student.id}" />
                <span class="elegant-toggle-slider"></span>
              </label>
            </div>
            <div class="student-card-content">
              <div class="avatar-container">
                <div class="avatar-orbit"></div>
                <div class="avatar">${getGroupLetter(student.groupCode || student.group)}</div>
                <div class="status-badge ${student.status}">
                  ${getStatusIcon(student.status)}
                </div>
              </div>
              <div class="identity-section">
                <div class="profile-label">STUDENT PROFILE</div>
                <div class="student-name" title="${student.name}">${student.name}</div>
                ${student.college ? `<div style="font-size: 11px; color: rgba(138, 180, 255, 0.6); margin-bottom: 8px;">🎓 ${student.college}</div>` : ''}
                <div class="meta-badges">
                  <div class="meta-badge credit">
                    ${svgIconCache.dollar}
                    ${formatCredit(balanceAmount)}
                  </div>
                  <div class="meta-badge price">
                    ${svgIconCache.dollar}
                    ${formatPrice(student.price_per_class)}
                  </div>
                </div>
              </div>
              <div class="status-pill ${student.status}" data-action="cycle-status" data-student-id="${student.id}">${student.status}</div>
            </div>
          </div>
        `;
          })
          .join('');
        
        // Single DOM update instead of multiple
        tempDiv.innerHTML = cardsHTML;
        while (tempDiv.firstChild) {
          fragment.appendChild(tempDiv.firstChild);
        }
        
        // Clear and append in one operation
        grid.innerHTML = '';
        grid.appendChild(fragment);
        
        // Show loading indicator if there are more students to load
        if (!forceFullRender && studentsToRender.length < sourceStudents.length) {
          const loadingDiv = document.createElement('div');
          loadingDiv.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 20px; color: rgba(255,255,255,0.5); font-size: 14px;';
          loadingDiv.textContent = `Showing ${studentsToRender.length} of ${sourceStudents.length} students`;
          grid.appendChild(loadingDiv);
        }
      }
      
      // Throttled scroll handler for lazy loading
      const handleScroll = throttle(() => {
        const sourceStudents = filteredStudents.length > 0 || 
                               document.getElementById('searchInput')?.value || 
                               document.getElementById('groupFilter')?.value ||
                               document.getElementById('paymentFilter')?.value ||
                               document.getElementById('sortFilter')?.value
          ? filteredStudents 
          : students;
          
        if (isLoadingMore || currentlyRenderedCount >= sourceStudents.length) return;
        
        const scrollPosition = window.scrollY + window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        // Load more when user is 300px from bottom
        if (scrollPosition > documentHeight - 300) {
          isLoadingMore = true;
          currentlyRenderedCount += cardsPerBatch;
          renderStudentCards();
          isLoadingMore = false;
        }
      }, 200);

      async function cycleStatus(studentId) {
        const student = students.find(s => s.id === studentId);
        if (!student) return;

        const statusOrder = ['active', 'paused', 'graduated'];
        const currentIndex = statusOrder.indexOf(student.status);
        student.status = statusOrder[(currentIndex + 1) % statusOrder.length];

        debugLog(`Status changed to: ${student.status}`);
        
        // Save to Supabase
        await saveStudent(student);
        
        renderStudentCards();
      }

      // ============================================
      //  SEARCH AND FILTER FUNCTIONS
      // ============================================
      
      function applyFilters() {
        const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
        const groupFilter = document.getElementById('groupFilter')?.value || '';
        const statusFilter = document.getElementById('statusFilter')?.value || '';
        const paymentFilter = document.getElementById('paymentFilter')?.value || '';
        const sortFilter = document.getElementById('sortFilter')?.value || '';
        
        // Start with all students
        filteredStudents = students.filter(student => {
          // Search filter - searches across all fields
          if (searchTerm) {
            const searchableText = [
              student.name,
              student.group,
              student.phone,
              Array.isArray(student.email) ? student.email.join(' ') : student.email,
              student.notes,
              Array.isArray(student.aliases) ? student.aliases.join(' ') : student.aliases,
              student.balance,
              student.price_per_class,
              student.status
            ].filter(Boolean).join(' ').toLowerCase();
            
            if (!searchableText.includes(searchTerm)) {
              return false;
            }
          }
          
          // Group filter
          if (groupFilter) {
            const normalizedCode = student.groupCode || canonicalizeGroupCode(student.group || '');
            if (groupFilter === 'no-group') {
              if (normalizedCode) return false;
            } else {
              const studentGroup = getGroupLetter(normalizedCode);
              if (studentGroup !== groupFilter) return false;
            }
          }
          
          // Status filter — graduated students are hidden by default
          // and only shown when the status filter is explicitly set to 'graduated'
          if (student.status === 'graduated' && statusFilter !== 'graduated') {
            return false;
          }
          if (statusFilter && student.status !== statusFilter) {
            return false;
          }
          
          // Payment filter
          if (paymentFilter === 'unpaid') {
            const credit = student.balance || 0;
            if (credit >= 0) return false;
          } else if (paymentFilter === 'credit') {
            const credit = student.balance || 0;
            if (credit <= 0) return false;
          }
          
          return true;
        });
        
        // Apply sorting
        if (sortFilter === 'highest') {
          filteredStudents.sort((a, b) => {
            const priceA = a.price_per_class || 0;
            const priceB = b.price_per_class || 0;
            return priceB - priceA;
          });
        } else if (sortFilter === 'lowest') {
          filteredStudents.sort((a, b) => {
            const priceA = a.price_per_class || 0;
            const priceB = b.price_per_class || 0;
            return priceA - priceB;
          });
        }
        
        // Reset pagination
        currentlyRenderedCount = 30;
        
        // Render filtered results
        renderStudentCards();
      }
      
      // Debounced search for better performance
      // Debounced version of applyFilters (optimized to 150ms for better UX)
      const debouncedApplyFilters = debounce(applyFilters, 150);
      
      /**
       * Clears the search input and updates the student grid
       */
      function clearSearch() {
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('searchClearBtn');
        
        if (searchInput) {
          searchInput.value = '';
          searchInput.focus();
        }
        
        if (clearBtn) {
          clearBtn.classList.remove('visible');
        }
        
        applyFilters();
      }
      
      function clearAllFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('groupFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('paymentFilter').value = '';
        document.getElementById('sortFilter').value = '';
        
        // Hide clear button
        const clearBtn = document.getElementById('searchClearBtn');
        if (clearBtn) {
          clearBtn.classList.remove('visible');
        }
        
        applyFilters();
      }

      // ============================================
      //  MODAL FUNCTIONS
      // ============================================

      function openAddStudentModal() {
        const modal = document.getElementById('addStudentModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeAddStudentModal() {
        const modal = document.getElementById('addStudentModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
        // Clear form fields
        document.getElementById('newStudentName').value = '';
        document.getElementById('newStudentCustomGroup').value = '';
        document.getElementById('newStudentCustomPrice').value = '';
        document.getElementById('newStudentBalance').value = '';
        document.getElementById('newStudentPhone').value = '';
        document.getElementById('newStudentEmail').value = '';
        document.getElementById('newStudentCollege').value = '';
        document.getElementById('newStudentNotes').value = '';
        // Clear active buttons
        document.querySelectorAll('#newStudentGroupButtons .toggle-btn.active').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#newStudentPriceButtons .toggle-btn.active').forEach(btn => btn.classList.remove('active'));
      }

      async function handleAddStudent() {
        console.log('🆕 Starting handleAddStudent...');
        
        // Get form values
        const name = document.getElementById('newStudentName').value.trim();
        
        console.log('📝 Form values:', {
          name,
          nameElement: document.getElementById('newStudentName')
        });
        
        if (!name) {
          await customAlert('Validation Error', 'Please enter a student name.', 'error');
          return;
        }

        // Get selected groups
        const activeGroupButtons = document.querySelectorAll('#newStudentGroupButtons .toggle-btn.active');
        const selectedGroups = Array.from(activeGroupButtons).map(btn => btn.textContent);
        const customGroups = document.getElementById('newStudentCustomGroup').value.trim();
        let groupCode = '';
        if (selectedGroups.length > 0) {
          groupCode = selectedGroups.join('');
        } else if (customGroups) {
          groupCode = customGroups;
        }

        // Get price
        const activePriceButton = document.querySelector('#newStudentPriceButtons .toggle-btn.active');
        const customPrice = document.getElementById('newStudentCustomPrice').value;
        let pricePerClass = 0;
        if (activePriceButton) {
          pricePerClass = parseInt(activePriceButton.getAttribute('data-value')) || 0;
        } else if (customPrice) {
          pricePerClass = parseInt(customPrice) || 0;
        }

        // Create student object
        const newStudent = {
          name: name,
          groupCode: groupCode,
          price_per_class: pricePerClass,
          balance: parseInt(document.getElementById('newStudentBalance').value) || 0,
          phone: document.getElementById('newStudentPhone').value.trim(),
          email: document.getElementById('newStudentEmail').value.trim(),
          college: document.getElementById('newStudentCollege').value.trim(),
          notes: document.getElementById('newStudentNotes').value.trim(),
          status: 'active',
          showInCalendar: true
        };
        
        console.log('📋 Student object created:', newStudent);

        // Save to database
        console.log('💾 Calling saveStudent...');
        const result = await saveStudent(newStudent);
        console.log('💾 saveStudent result:', result);
        
        if (result) {
          await customAlert('Success', 'Student added successfully!', 'success');
          closeAddStudentModal();
          // Reload students list
          await loadStudents();
        } else {
          await customAlert('Error', 'Failed to add student. Please try again.', 'error');
        }
      }

      function openBulkAddModal() {
        const modal = document.getElementById('bulkAddModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeBulkAddModal() {
        const modal = document.getElementById('bulkAddModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }

      async function openWaitingListModal() {
        const modal = document.getElementById('waitingListModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Load waiting list data
        await loadWaitingList();
      }

      async function loadWaitingList() {
        const loadingDiv = document.getElementById('waitingListLoading');
        const emptyDiv = document.getElementById('waitingListEmpty');
        const contentDiv = document.getElementById('waitingListContent');
        
        // Show loading
        loadingDiv.style.display = 'block';
        emptyDiv.style.display = 'none';
        contentDiv.style.display = 'none';
        
        try {
          const { data: waitingList, error } = await supabaseClient
            .from('student_waiting_list')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          
          // Update badge with total count
          const waitingListBadge = document.getElementById('waitingListBadge');
          if (waitingList && waitingList.length > 0) {
            waitingListBadge.textContent = waitingList.length;
            waitingListBadge.style.display = 'flex';
          } else {
            waitingListBadge.style.display = 'none';
          }
          
          // Hide loading
          loadingDiv.style.display = 'none';
          
          if (!waitingList || waitingList.length === 0) {
            emptyDiv.style.display = 'block';
            return;
          }
          
          // Show content
          contentDiv.style.display = 'block';
          
          // Build waiting list HTML
          contentDiv.innerHTML = `
            <div style="
              display:flex; align-items:center; gap:12px;
              margin-bottom:24px; padding:14px 18px;
              background:rgba(196,164,95,0.07);
              border:1px solid rgba(196,164,95,0.18);
              border-radius:12px;
            ">
              <div style="
                width:32px;height:32px;border-radius:50%;
                background:linear-gradient(135deg,rgba(196,164,95,0.25),rgba(196,164,95,0.1));
                border:1px solid rgba(196,164,95,0.3);
                display:flex;align-items:center;justify-content:center;
                font-family:var(--font-sans);font-size:14px;font-weight:700;color:var(--gold);
                flex-shrink:0;
              ">${waitingList.length}</div>
              <div>
                <div style="font-family:var(--font-sans);font-size:13px;font-weight:600;color:var(--gold);">
                  ${waitingList.length === 1 ? '1 Pending Registration' : `${waitingList.length} Pending Registrations`}
                </div>
                <div style="font-family:var(--font-sans);font-size:11px;color:var(--text-faint);margin-top:2px;">
                  Review and approve or dismiss each applicant below
                </div>
              </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:12px;">
              ${waitingList.map(student => {
                const isContacted = !!student.contacted_at;
                const regDate = new Date(student.created_at).toLocaleString('en-US', {
                  month: 'short', day: 'numeric', year: 'numeric',
                  hour: 'numeric', minute: '2-digit'
                });
                const initials = ((student.first_name || '?').charAt(0) + (student.last_name || '').charAt(0)).toUpperCase();
                return `
                <div style="
                  background:linear-gradient(135deg,rgba(255,252,240,0.03) 0%,rgba(10,12,22,0.5) 100%);
                  border:1px solid rgba(196,164,95,0.12);
                  border-top:1px solid rgba(196,164,95,0.22);
                  border-radius:16px;
                  overflow:hidden;
                  transition:border-color 0.2s;
                " onmouseover="this.style.borderColor='rgba(196,164,95,0.28)'" onmouseout="this.style.borderColor='rgba(196,164,95,0.12)'">

                  <!-- Card header -->
                  <div style="
                    display:flex;align-items:center;gap:14px;
                    padding:18px 20px 14px;
                  ">
                    <!-- Avatar -->
                    <div style="
                      width:46px;height:46px;border-radius:50%;flex-shrink:0;
                      background:linear-gradient(135deg,var(--gold),#8a6d3b);
                      display:flex;align-items:center;justify-content:center;
                      font-family:var(--font-serif);font-size:16px;font-weight:700;
                      color:var(--bg-base);
                      box-shadow:0 0 0 2px rgba(196,164,95,0.2),0 4px 12px rgba(0,0,0,0.3);
                    ">${initials}</div>

                    <!-- Name + date -->
                    <div style="flex:1;min-width:0;">
                      <div style="
                        font-family:var(--font-serif);font-size:1.05rem;font-weight:700;font-style:italic;
                        color:var(--text-strong);line-height:1.2;margin-bottom:3px;
                      ">${student.first_name} ${student.last_name}</div>
                      <div style="font-family:var(--font-sans);font-size:11px;color:var(--text-faint);">
                        Registered ${regDate}
                      </div>
                    </div>

                    <!-- Status pill -->
                    ${isContacted
                      ? `<div style="
                          padding:5px 12px;border-radius:20px;flex-shrink:0;
                          background:rgba(93,209,138,0.1);
                          border:1px solid rgba(93,209,138,0.3);
                          font-family:var(--font-sans);font-size:11px;font-weight:700;
                          letter-spacing:0.06em;color:var(--status-active);
                          display:flex;align-items:center;gap:5px;
                        ">
                          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                          Contacted
                        </div>`
                      : `<div style="
                          padding:5px 12px;border-radius:20px;flex-shrink:0;
                          background:rgba(245,200,66,0.1);
                          border:1px solid rgba(245,200,66,0.28);
                          font-family:var(--font-sans);font-size:11px;font-weight:700;
                          letter-spacing:0.06em;color:var(--status-paused);
                        ">PENDING</div>`
                    }
                  </div>

                  <!-- Detail fields -->
                  <div style="
                    display:grid;grid-template-columns:repeat(3,1fr);gap:0;
                    border-top:1px solid rgba(196,164,95,0.08);
                    border-bottom:1px solid rgba(196,164,95,0.08);
                  ">
                    ${[
                      { label: 'EMAIL', value: student.email },
                      { label: 'PHONE', value: student.phone || '—' },
                      { label: 'LANGUAGE', value: student.preferred_language || '—' }
                    ].map((f, i) => `
                      <div style="
                        padding:12px 18px;
                        ${i < 2 ? 'border-right:1px solid rgba(196,164,95,0.08);' : ''}
                        background:rgba(196,164,95,0.02);
                      ">
                        <div style="
                          font-family:var(--font-sans);font-size:9px;font-weight:600;
                          text-transform:uppercase;letter-spacing:0.14em;
                          color:var(--gold);opacity:0.6;margin-bottom:5px;
                        ">${f.label}</div>
                        <div style="
                          font-family:var(--font-sans);font-size:13px;font-weight:500;
                          color:var(--text-strong);word-break:break-all;
                        ">${f.value}</div>
                      </div>
                    `).join('')}
                  </div>

                  <!-- Actions -->
                  <div style="
                    display:flex;gap:8px;padding:14px 18px;
                    flex-wrap:wrap;align-items:center;
                  ">
                    <button
                      onclick="approveWaitingListStudent('${student.id}','${student.first_name}','${student.last_name}','${student.email}','${student.phone || ''}','${student.preferred_language || ''}')"
                      style="
                        flex:1;min-width:180px;
                        padding:10px 18px;border:none;border-radius:10px;
                        background:linear-gradient(135deg,#5dd18a,#3daa68);
                        font-family:var(--font-sans);font-size:13px;font-weight:700;
                        color:#fff;cursor:pointer;letter-spacing:0.03em;
                        box-shadow:0 4px 14px rgba(93,209,138,0.25);
                        transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:7px;
                      "
                      onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 6px 20px rgba(93,209,138,0.38)'"
                      onmouseout="this.style.transform='';this.style.boxShadow='0 4px 14px rgba(93,209,138,0.25)'"
                    >
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                      Approve &amp; Create Student
                    </button>

                    ${!isContacted ? `
                    <button
                      onclick="markAsContacted('${student.id}')"
                      style="
                        padding:10px 16px;border-radius:10px;
                        background:rgba(196,164,95,0.08);
                        border:1px solid rgba(196,164,95,0.22);
                        font-family:var(--font-sans);font-size:13px;font-weight:600;
                        color:var(--gold);cursor:pointer;
                        transition:all 0.2s;display:flex;align-items:center;gap:6px;
                      "
                      onmouseover="this.style.background='rgba(196,164,95,0.15)'"
                      onmouseout="this.style.background='rgba(196,164,95,0.08)'"
                    >
                      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 13a19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 3.6 2.18h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 9.91a16 16 0 0 0 6.29 6.29l.91-.92a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                      Mark Contacted
                    </button>
                    ` : ''}

                    <button
                      onclick="deleteWaitingListStudent('${student.id}','${student.first_name} ${student.last_name}')"
                      style="
                        padding:10px 14px;border-radius:10px;
                        background:rgba(176,48,64,0.08);
                        border:1px solid rgba(176,48,64,0.22);
                        font-family:var(--font-sans);font-size:13px;font-weight:600;
                        color:#f87171;cursor:pointer;
                        transition:all 0.2s;display:flex;align-items:center;gap:6px;
                      "
                      onmouseover="this.style.background='rgba(176,48,64,0.18)'"
                      onmouseout="this.style.background='rgba(176,48,64,0.08)'"
                    >
                      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path></svg>
                      Delete
                    </button>
                  </div>

                </div>
              `}).join('')}
            </div>
          `;
          
        } catch (error) {
          console.error('Error loading waiting list:', error);
          loadingDiv.style.display = 'none';
          contentDiv.style.display = 'block';
          contentDiv.innerHTML = `
            <div style="padding:60px 40px;text-align:center;">
              <div style="width:52px;height:52px;border-radius:50%;background:rgba(176,48,64,0.1);border:1px solid rgba(176,48,64,0.25);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:22px;">⚠️</div>
              <div style="font-family:var(--font-serif);font-size:16px;font-style:italic;color:var(--text-muted);margin-bottom:8px;">Failed to Load Registrations</div>
              <div style="font-family:var(--font-sans);font-size:12px;color:var(--text-faint);">${error.message}</div>
            </div>
          `;
        }
      }

      async function approveWaitingListStudent(id, firstName, lastName, email, phone, language) {
        const confirmed = await customConfirm(
          'Approve Student',
          `Create student account for ${firstName} ${lastName}?\n\nEmail: ${email}\nPhone: ${phone || 'Not provided'}`
        );
        
        if (!confirmed) return;
        
        try {
          // Check for existing students with same email or name
          const fullName = `${firstName} ${lastName}`;
          let existingStudents = [];
          
          if (email) {
            // Check by email
            const { data: emailMatches, error: emailError } = await supabaseClient
              .from('students')
              .select('*')
              .ilike('email', email.trim());
            
            if (!emailError && emailMatches && emailMatches.length > 0) {
              existingStudents = existingStudents.concat(emailMatches);
            }
          }
          
          // Check by name (case-insensitive)
          const { data: nameMatches, error: nameError } = await supabaseClient
            .from('students')
            .select('*')
            .ilike('name', fullName.trim());
          
          if (!nameError && nameMatches && nameMatches.length > 0) {
            // Add name matches that aren't already in the list
            nameMatches.forEach(match => {
              if (!existingStudents.find(s => s.id === match.id)) {
                existingStudents.push(match);
              }
            });
          }
          
          // If duplicates found, show warning with options
          if (existingStudents.length > 0) {
            const duplicateNames = existingStudents.map(s => s.name).join(', ');
            const duplicateEmails = existingStudents.map(s => s.email || 'No email').join(', ');
            
            // Create custom three-button dialog
            const choice = await new Promise((resolve) => {
              // Create overlay - 50% transparency, NO BLUR
              const overlay = document.createElement('div');
              overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 100000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.2s ease;
              `;
              
              // Create dialog with shadow
              const dialog = document.createElement('div');
              dialog.style.cssText = `
                background: linear-gradient(135deg, rgba(31, 20, 60, 0.98), rgba(20, 15, 40, 0.98));
                border: 2px solid rgba(138, 180, 255, 0.3);
                border-radius: 24px;
                padding: 32px;
                max-width: 520px;
                width: 90%;
                box-shadow: 
                  0 30px 80px rgba(0, 0, 0, 0.8),
                  0 10px 40px rgba(0, 0, 0, 0.6),
                  0 0 60px rgba(138, 180, 255, 0.25),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
                animation: slideUp 0.3s ease;
              `;
              
              dialog.innerHTML = `
                <div style="text-align: center; margin-bottom: 24px;">
                  <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
                  <h2 style="
                    font-size: 24px;
                    font-weight: 800;
                    background: linear-gradient(135deg, #fbbf24, #f59e0b);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    background-clip: text;
                    margin: 0 0 16px 0;
                  ">Possible Duplicate Student Found</h2>
                  <p style="
                    color: rgba(255, 255, 255, 0.8);
                    font-size: 15px;
                    line-height: 1.6;
                    margin: 0;
                  ">
                    A student with similar information already exists:
                  </p>
                </div>
                
                <div style="
                  background: rgba(0, 0, 0, 0.3);
                  border: 1px solid rgba(138, 180, 255, 0.2);
                  border-radius: 16px;
                  padding: 20px;
                  margin-bottom: 28px;
                ">
                  <div style="margin-bottom: 12px;">
                    <div style="
                      color: rgba(138, 180, 255, 0.7);
                      font-size: 11px;
                      text-transform: uppercase;
                      letter-spacing: 1px;
                      margin-bottom: 6px;
                    ">Name</div>
                    <div style="
                      color: white;
                      font-size: 16px;
                      font-weight: 600;
                    ">${duplicateNames}</div>
                  </div>
                  <div>
                    <div style="
                      color: rgba(138, 180, 255, 0.7);
                      font-size: 11px;
                      text-transform: uppercase;
                      letter-spacing: 1px;
                      margin-bottom: 6px;
                    ">Email</div>
                    <div style="
                      color: white;
                      font-size: 16px;
                      font-weight: 600;
                    ">${duplicateEmails}</div>
                  </div>
                </div>
                
                <div style="
                  display: flex;
                  flex-direction: column;
                  gap: 12px;
                ">
                  <button class="choice-btn" data-choice="update" style="
                    background: linear-gradient(135deg, #10b981, #059669);
                    border: 2px solid rgba(16, 185, 129, 0.4);
                    color: white;
                    padding: 16px 24px;
                    border-radius: 16px;
                    font-size: 15px;
                    font-weight: 700;
                    cursor: pointer;
                    transition: all 0.2s;
                    box-shadow: 
                      0 4px 16px rgba(16, 185, 129, 0.3),
                      inset 0 1px 0 rgba(255, 255, 255, 0.2);
                    font-family: inherit;
                  ">
                    ✅ Update Existing Student
                    <div style="
                      font-size: 12px;
                      font-weight: 500;
                      opacity: 0.9;
                      margin-top: 4px;
                    ">Fill in missing info & mark as active</div>
                  </button>
                  
                  <button class="choice-btn" data-choice="add" style="
                    background: linear-gradient(135deg, #3b82f6, #2563eb);
                    border: 2px solid rgba(59, 130, 246, 0.4);
                    color: white;
                    padding: 16px 24px;
                    border-radius: 16px;
                    font-size: 15px;
                    font-weight: 700;
                    cursor: pointer;
                    transition: all 0.2s;
                    box-shadow: 
                      0 4px 16px rgba(59, 130, 246, 0.3),
                      inset 0 1px 0 rgba(255, 255, 255, 0.2);
                    font-family: inherit;
                  ">
                    ➕ Add as New Student
                    <div style="
                      font-size: 12px;
                      font-weight: 500;
                      opacity: 0.9;
                      margin-top: 4px;
                    ">Create separate record anyway</div>
                  </button>
                  
                  <button class="choice-btn" data-choice="cancel" style="
                    background: rgba(255, 255, 255, 0.08);
                    border: 2px solid rgba(255, 255, 255, 0.15);
                    color: rgba(255, 255, 255, 0.9);
                    padding: 14px 24px;
                    border-radius: 16px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
                    font-family: inherit;
                  ">
                    ✖️ Cancel
                  </button>
                </div>
              `;
              
              // Add hover effects
              const style = document.createElement('style');
              style.textContent = `
                .choice-btn:hover {
                  transform: translateY(-2px);
                  box-shadow: 
                    0 6px 24px rgba(0, 0, 0, 0.4),
                    0 0 20px currentColor;
                }
                .choice-btn:active {
                  transform: translateY(0);
                }
              `;
              document.head.appendChild(style);
              
              overlay.appendChild(dialog);
              document.body.appendChild(overlay);
              
              // Add click handlers
              dialog.querySelectorAll('.choice-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                  const choice = btn.getAttribute('data-choice');
                  overlay.remove();
                  style.remove();
                  resolve(choice);
                });
              });
              
              // Click outside to cancel
              overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                  overlay.remove();
                  style.remove();
                  resolve('cancel');
                }
              });
            });
            
            if (choice === 'cancel') {
              await customAlert('Cancelled', 'No changes were made.');
              return;
            }
            
            if (choice === 'update') {
              // Update existing student
              const existingStudent = existingStudents[0];
              
              // Build update object with new information
              const updates = {};
              
              // Update email if missing or different
              if (email && (!existingStudent.email || existingStudent.email.trim() === '')) {
                updates.email = email;
              }
              
              // Update phone if missing or different
              if (phone && (!existingStudent.phone || existingStudent.phone.trim() === '')) {
                updates.phone = phone;
              }
              
              // Update notes with registration info
              const registrationDate = new Date().toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
              });
              
              const newNote = `\n✅ Updated from waiting list on ${registrationDate}`;
              updates.notes = (existingStudent.notes || '') + newNote;
              
              // Ensure student is active and shown in grid
              if (existingStudent.status !== 'active') {
                updates.status = 'active';
              }
              if (existingStudent.show_in_grid === false) {
                updates.show_in_grid = true;
              }
              
              // Perform update
              const { error: updateError } = await supabaseClient
                .from('students')
                .update(updates)
                .eq('id', existingStudent.id);
              
              if (updateError) throw updateError;
              
              // Delete from waiting list
              const { error: deleteError } = await supabaseClient
                .from('student_waiting_list')
                .delete()
                .eq('id', id);
              
              if (deleteError) throw deleteError;
              
              await customAlert(
                'Student Updated',
                `Updated existing student: ${existingStudent.name}\n\n` +
                `${Object.keys(updates).length > 0 ? 'Updated fields: ' + Object.keys(updates).join(', ') : 'No new information to add'}`
              );
              
              // Reload waiting list
              await loadWaitingList();
              
              // Reload students list
              await loadStudents();
              
              return;
            }
            
            // If choice is 'add', continue with creating new student (code below)
          }
          
          // Build notes with registration info
          const registrationDate = new Date().toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric'
          });
          
          const notes = `✅ Registered via waiting list on ${registrationDate}`;

          // Generate student_id for new student (required by schema)
          const generatedStudentId = Date.now();
          
          // Create student record with essential contact information
          const { data: newStudent, error: studentError } = await supabaseClient
            .from('students')
            .insert([{
              student_id: generatedStudentId,
              name: `${firstName} ${lastName}`,
              email: email || null,
              phone: phone || null,
              status: 'active',
              show_in_grid: true,
              balance: 0,
              price_per_class: 0,
              notes: notes
            }])
            .select()
            .single();
          
          if (studentError) throw studentError;
          
          // Send welcome email if email is provided
          if (email) {
            try {
              const welcomeEmailHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;">
    <div style="max-width: 600px; margin: 40px auto; background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 32px; text-align: center;">
            <h1 style="color: white; margin: 0; font-size: 32px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">🎓 Welcome to ARNOMA!</h1>
        </div>
        <div style="padding: 40px 32px; line-height: 1.6; color: #374151;">
            <p style="font-size: 18px; margin-top: 0;">Hi <strong>${firstName}</strong>,</p>
            <p>Congratulations! Your student account has been approved and is now active. We're excited to have you join ARNOMA! 🎉</p>
            
            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 24px; margin: 24px 0;">
                <h3 style="color: #667eea; margin-top: 0;">📋 Next Steps</h3>
                <ol style="margin: 16px 0; padding-left: 20px;">
                    <li style="margin: 8px 0;">Check your email for your student portal login credentials</li>
                    <li style="margin: 8px 0;">Access your student portal to view notes, tests, and schedule</li>
                    <li style="margin: 8px 0;">Your teacher will contact you shortly with class schedule details</li>
                </ol>
            </div>

            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid rgba(102,126,234,0.3); border-radius: 16px; padding: 24px; margin: 24px 0;">
                <h3 style="color: #667eea; margin-top: 0;">📚 Getting Started</h3>
                <ul style="margin: 16px 0; padding-left: 20px;">
                    <li style="margin: 8px 0;"><strong>Student Portal:</strong> Access your notes, tests, and class materials</li>
                    <li style="margin: 8px 0;"><strong>Payment Information:</strong> Payment details will be shared by your teacher</li>
                    <li style="margin: 8px 0;"><strong>Class Schedule:</strong> You'll receive your personalized schedule soon</li>
                </ul>
            </div>

            <p style="margin-top: 32px;">If you have any questions, don't hesitate to reach out. We're here to help! 💜</p>

            <div style="margin-top: 40px; padding-top: 24px; border-top: 2px solid rgba(102,126,234,0.2);">
                <p style="margin: 8px 0;">Best regards,</p>
                <p style="margin: 8px 0; font-weight: 600; color: #667eea;">ARNOMA Team</p>
                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08)); border-radius: 12px; border: 1px solid rgba(102,126,234,0.2);">
                    <p style="margin: 6px 0; font-size: 13px; color: #6b7280;">
                        <em>This email was sent automatically from ARNOMA Student Management System</em>
                    </p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>`;

              const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
              const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
              
              const emailResponse = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                },
                body: JSON.stringify({
                  to: email,
                  subject: '🎓 Welcome to ARNOMA - Your Account is Active!',
                  html: welcomeEmailHTML
                })
              });

              if (emailResponse.ok) {
                debugLog('✅ Welcome email sent to:', email);
              } else {
                console.warn('⚠️ Failed to send welcome email, but student was created successfully');
              }
            } catch (emailError) {
              console.warn('⚠️ Email sending failed:', emailError);
              // Don't throw - student creation succeeded
            }
          }
          
          // Delete from waiting list
          const { error: deleteError } = await supabaseClient
            .from('student_waiting_list')
            .delete()
            .eq('id', id);
          
          if (deleteError) throw deleteError;
          
          await customAlert(
            'Success', 
            `✅ Student account created for ${firstName} ${lastName}!\n\n` +
            `${email ? 'A welcome email has been sent to ' + email : 'The student has been added to your active students list.'}`
          );
          
          // Reload waiting list
          await loadWaitingList();
          
          // Refresh main student list
          await loadStudents();
          
        } catch (error) {
          console.error('Error approving student:', error);
          await customAlert('Error', `Failed to create student account: ${error.message}`);
        }
      }

      async function markAsContacted(id) {
        try {
          const { error } = await supabaseClient
            .from('student_waiting_list')
            .update({ contacted_at: new Date().toISOString() })
            .eq('id', id);
          
          if (error) throw error;
          
          // Reload waiting list
          await loadWaitingList();
          
        } catch (error) {
          console.error('Error marking as contacted:', error);
          await customAlert('Error', `Failed to update: ${error.message}`);
        }
      }

      async function deleteWaitingListStudent(id, name) {
        const confirmed = await customConfirm(
          'Delete Registration',
          `Delete ${name} from waiting list? This cannot be undone.`
        );
        
        if (!confirmed) return;
        
        try {
          const { error } = await supabaseClient
            .from('student_waiting_list')
            .delete()
            .eq('id', id);
          
          if (error) throw error;
          
          await customAlert('Deleted', `${name} removed from waiting list.`);
          
          // Reload waiting list
          await loadWaitingList();
          
        } catch (error) {
          console.error('Error deleting student:', error);
          await customAlert('Error', `Failed to delete: ${error.message}`);
        }
      }

      function closeWaitingListModal() {
        const modal = document.getElementById('waitingListModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }

      function openDuplicatesModal() {
        const modal = document.getElementById('duplicatesModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeDuplicatesModal() {
        const modal = document.getElementById('duplicatesModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }

      // ============================================================
      // PORTAL REGISTRATION INSTRUCTIONS
      // ============================================================
      
      let portalRegSelectedStudents = [];
      let portalRegAllStudents = [];

      // Generate professional HTML email template
      function generatePortalRegistrationEmailHTML(title, bodyContent) {
        return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARNOMA NCLEX-RN Email</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px 20px;
    }
    .email-wrapper {
      max-width: 600px;
      margin: 0 auto;
    }
    .email-container {
      background-color: #ffffff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .email-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 45px 35px 35px;
      text-align: center;
    }
    .email-header img {
      width: 140px;
      height: 140px;
      margin-bottom: 15px;
      filter: drop-shadow(0 0 6px rgba(255,255,255,0.7))
              drop-shadow(0 0 12px rgba(255,255,255,0.4))
              drop-shadow(0 0 3px rgba(255,255,255,0.8));
      animation: fadeIn 1.5s ease-in-out;
    }
    .email-header h1 {
      color: #fff;
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.5px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .email-body {
      padding: 35px;
      color: #333;
      font-size: 16px;
      line-height: 1.4;
    }
    .email-body p {
      margin: 0 0 12px 0;
    }
    .email-body-content {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .info-box {
      background-color: #f6f8fe;
      border-left: 3px solid #3b82f6;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 15px;
      line-height: 1.4;
      color: #1e293b;
      margin: 10px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .info-box p {
      margin: 4px 0;
    }
    .warning-box {
      background-color: #fef3c7;
      border-left: 4px solid #f59e0b;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 10px 0;
    }
    .success-box {
      background-color: #f0fdf4;
      border-left: 4px solid #10b981;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 10px 0;
    }
    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(200,200,200,0.5) 20%, rgba(200,200,200,0.5) 80%, transparent);
      margin: 10px 0;
      border: none;
    }
    .email-footer {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      text-align: center;
      padding: 30px 20px;
    }
    .email-footer img {
      width: 100px;
      height: 100px;
      margin: 10px 0;
      filter: drop-shadow(0 0 5px rgba(255,255,255,0.6))
              drop-shadow(0 0 10px rgba(255,255,255,0.3))
              drop-shadow(0 0 2px rgba(255,255,255,0.8));
    }
    .email-footer p {
      margin: 6px 0;
      font-size: 13px;
    }
    @media (max-width: 600px) {
      body { padding: 20px 10px; }
      .email-body { padding: 25px 20px; font-size: 15px; }
      .email-header img { width: 110px; height: 110px; }
    }
  </style>
</head>
<body>
  <div class="email-wrapper">
    <div class="email-container">
      <div class="email-header">
        <img src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png" alt="ARNOMA Logo">
        <h1>${title}</h1>
      </div>

      <div class="email-body">
        <div class="email-body-content">${bodyContent}</div>
      </div>

      <div class="email-footer">
        <img src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png" alt="ARNOMA Logo">
        <p><strong style="font-size: 18px;">ARNOMA – NCLEX RN</strong></p>
        <p style="font-size: 14px;">Professional NCLEX Preparation & Medical Education</p>
        <p style="font-size: 13px;">
          nclex.rn@arnoma.us<br>
          richy@arnoma.us<br>
          909-808-1818
        </p>
        <p style="font-size: 12px; color: #95a5a6;">
          © 2025 ARNOMA. All rights reserved.
        </p>
        <p style="font-size: 12px; color: #7f8c8d;">
          This is an automated notification from your ARNOMA NCLEX prep program.
        </p>
      </div>
    </div>
  </div>
</body>
</html>`;
      }

      async function openPortalRegistrationModal() {
        const modal = document.getElementById('portalRegistrationModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Reset state
        portalRegSelectedStudents = [];
        portalRegAllStudents = [...students].filter(s => s.email && s.email.trim() !== '');
        
        // Reset search and filter
        document.getElementById('portalRegSearchInput').value = '';
        document.getElementById('portalRegGroupFilter').value = '';
        document.getElementById('selectAllPortalReg').checked = false;
        
        // Render student list
        renderPortalRegistrationStudents();
        updatePortalRegSelectedCount();
      }

      function closePortalRegistrationModal() {
        const modal = document.getElementById('portalRegistrationModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }

      function renderPortalRegistrationStudents() {
        const listContainer = document.getElementById('portalRegStudentList');
        const searchTerm = document.getElementById('portalRegSearchInput').value.toLowerCase();
        const groupFilter = document.getElementById('portalRegGroupFilter').value;

        // Filter students
        let filteredStudents = portalRegAllStudents.filter(student => {
          const matchesSearch = !searchTerm || 
            student.name.toLowerCase().includes(searchTerm) || 
            student.email.toLowerCase().includes(searchTerm);
          
          const matchesGroup = !groupFilter || 
            (groupFilter === 'no-group' ? !student.groupCode : student.groupCode === groupFilter);
          
          return matchesSearch && matchesGroup;
        });

        // Render
        if (filteredStudents.length === 0) {
          listContainer.innerHTML = `
            <div style="padding: 40px; text-align: center; color: rgba(255, 255, 255, 0.4);">
              <div style="font-size: 32px; margin-bottom: 8px;">📭</div>
              <div>No students found</div>
            </div>
          `;
          return;
        }

        listContainer.innerHTML = filteredStudents.map(student => {
          const isSelected = portalRegSelectedStudents.some(s => s.id === student.id);
          return `
            <label style="
              display: flex; 
              align-items: center; 
              gap: 12px; 
              padding: 12px 16px; 
              background: rgba(255, 255, 255, 0.05); 
              border: 1px solid rgba(255, 255, 255, 0.1); 
              border-radius: 8px; 
              cursor: pointer;
              transition: all 0.2s ease;
            " onmouseover="this.style.background='rgba(255, 255, 255, 0.08)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
              <input 
                type="checkbox" 
                ${isSelected ? 'checked' : ''} 
                onchange="togglePortalRegStudent('${student.id}')"
                style="width: 18px; height: 18px; cursor: pointer;"
              />
              <div style="flex: 1;">
                <div style="color: rgba(255, 255, 255, 0.9); font-weight: 500; margin-bottom: 4px;">
                  ${student.name}
                  ${student.groupCode ? `<span style="color: rgba(255, 255, 255, 0.4); font-size: 12px; margin-left: 8px;">Group ${student.groupCode}</span>` : ''}
                </div>
                <div style="color: rgba(255, 255, 255, 0.5); font-size: 13px;">${student.email}</div>
              </div>
            </label>
          `;
        }).join('');
      }

      function filterPortalRegistrationStudents() {
        renderPortalRegistrationStudents();
        
        // Update "Select All" checkbox state
        const searchTerm = document.getElementById('portalRegSearchInput').value.toLowerCase();
        const groupFilter = document.getElementById('portalRegGroupFilter').value;
        const filteredStudents = portalRegAllStudents.filter(student => {
          const matchesSearch = !searchTerm || 
            student.name.toLowerCase().includes(searchTerm) || 
            student.email.toLowerCase().includes(searchTerm);
          const matchesGroup = !groupFilter || 
            (groupFilter === 'no-group' ? !student.groupCode : student.groupCode === groupFilter);
          return matchesSearch && matchesGroup;
        });
        
        const selectAllCheckbox = document.getElementById('selectAllPortalReg');
        const allVisibleSelected = filteredStudents.every(s => 
          portalRegSelectedStudents.some(sel => sel.id === s.id)
        );
        selectAllCheckbox.checked = filteredStudents.length > 0 && allVisibleSelected;
      }

      function togglePortalRegStudent(studentId) {
        // Convert studentId to number if it's a string (from HTML onclick)
        const numericId = typeof studentId === 'string' ? parseInt(studentId, 10) : studentId;
        
        const student = portalRegAllStudents.find(s => s.id === numericId);
        if (!student) {
          console.warn('Student not found:', studentId, numericId);
          return;
        }

        const index = portalRegSelectedStudents.findIndex(s => s.id === numericId);
        if (index > -1) {
          portalRegSelectedStudents.splice(index, 1);
        } else {
          portalRegSelectedStudents.push(student);
        }

        updatePortalRegSelectedCount();
        
        // Update "Select All" checkbox state after individual selection
        const searchTerm = document.getElementById('portalRegSearchInput').value.toLowerCase();
        const groupFilter = document.getElementById('portalRegGroupFilter').value;
        const filteredStudents = portalRegAllStudents.filter(s => {
          const matchesSearch = !searchTerm || 
            s.name.toLowerCase().includes(searchTerm) || 
            s.email.toLowerCase().includes(searchTerm);
          const matchesGroup = !groupFilter || 
            (groupFilter === 'no-group' ? !s.groupCode : s.groupCode === groupFilter);
          return matchesSearch && matchesGroup;
        });
        
        const selectAllCheckbox = document.getElementById('selectAllPortalReg');
        const allVisibleSelected = filteredStudents.every(s => 
          portalRegSelectedStudents.some(sel => sel.id === s.id)
        );
        selectAllCheckbox.checked = filteredStudents.length > 0 && allVisibleSelected;
      }

      function toggleSelectAllPortalReg() {
        const selectAllCheckbox = document.getElementById('selectAllPortalReg');
        const searchTerm = document.getElementById('portalRegSearchInput').value.toLowerCase();
        const groupFilter = document.getElementById('portalRegGroupFilter').value;
        
        // Get filtered students
        const filteredStudents = portalRegAllStudents.filter(student => {
          const matchesSearch = !searchTerm || 
            student.name.toLowerCase().includes(searchTerm) || 
            student.email.toLowerCase().includes(searchTerm);
          const matchesGroup = !groupFilter || 
            (groupFilter === 'no-group' ? !student.groupCode : student.groupCode === groupFilter);
          return matchesSearch && matchesGroup;
        });

        if (selectAllCheckbox.checked) {
          // Add all filtered students
          filteredStudents.forEach(student => {
            if (!portalRegSelectedStudents.some(s => s.id === student.id)) {
              portalRegSelectedStudents.push(student);
            }
          });
        } else {
          // Remove all filtered students
          portalRegSelectedStudents = portalRegSelectedStudents.filter(selected => 
            !filteredStudents.some(filtered => filtered.id === selected.id)
          );
        }

        renderPortalRegistrationStudents();
        updatePortalRegSelectedCount();
      }

      function updatePortalRegSelectedCount() {
        const count = portalRegSelectedStudents.length;
        document.getElementById('portalRegSelectedCount').textContent = `Selected: ${count}`;
        
        const nextBtn = document.getElementById('portalRegNextBtn');
        if (count > 0) {
          nextBtn.disabled = false;
          nextBtn.removeAttribute('disabled');
          nextBtn.style.opacity = '1';
          nextBtn.style.cursor = 'pointer';
          nextBtn.style.pointerEvents = 'auto';
        } else {
          nextBtn.disabled = true;
          nextBtn.setAttribute('disabled', 'disabled');
          nextBtn.style.opacity = '0.5';
          nextBtn.style.cursor = 'not-allowed';
          nextBtn.style.pointerEvents = 'none';
        }
      }

      function openPortalRegistrationPreview() {
        if (portalRegSelectedStudents.length === 0) {
          customAlert('No Students Selected', 'Please select at least one student.');
          return;
        }

        // Close first modal
        closePortalRegistrationModal();

        // Open preview modal
        const modal = document.getElementById('portalRegistrationPreviewModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Populate recipients
        const recipientsList = document.getElementById('portalRegRecipientsList');
        if (portalRegSelectedStudents.length <= 5) {
          recipientsList.innerHTML = portalRegSelectedStudents.map(s => 
            `<div>${s.name} &lt;${s.email}&gt;</div>`
          ).join('');
        } else {
          const firstThree = portalRegSelectedStudents.slice(0, 3).map(s => 
            `<div>${s.name} &lt;${s.email}&gt;</div>`
          ).join('');
          recipientsList.innerHTML = `
            ${firstThree}
            <div style="color: rgba(255, 255, 255, 0.5); margin-top: 8px;">
              ... and ${portalRegSelectedStudents.length - 3} more recipients
            </div>
          `;
        }

        // Set default subject
        document.getElementById('portalRegSubject').value = 'Portal Registration Instructions';

        // Set default body template with professional formatting
        const defaultBody = `<p style="font-size: 16px; color: #1e293b; line-height: 1.4; margin: 0 0 10px 0;">Dear <strong>{{student_name}}</strong>,</p>

<p style="font-size: 15px; color: #334155; line-height: 1.4; margin: 0 0 10px 0;">Welcome to the <strong>ARNOMA Student Portal</strong>! Follow these simple steps to create your account and access all your course materials, notes, and resources.</p>

<hr class="divider">

<div class="info-box">
<p style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #1e40af;">📝 Step-by-Step Registration Guide</p>

<p style="margin: 6px 0 2px 0; font-size: 15px;"><strong>Step 1:</strong> Visit the Student Portal</p>
<p style="margin: 0 0 8px 20px; font-size: 14px; color: #475569;">Go to: <a href="https://student.richyfesta.com" style="color: #3b82f6; text-decoration: none; font-weight: 600;">student.richyfesta.com</a></p>

<p style="margin: 6px 0 2px 0; font-size: 15px;"><strong>Step 2:</strong> Click the "Register" Button</p>
<p style="margin: 0 0 8px 20px; font-size: 14px; color: #475569;">Look for the registration button on the homepage</p>

<p style="margin: 6px 0 2px 0; font-size: 15px;"><strong>Step 3:</strong> Enter Your Information</p>
<p style="margin: 0 0 2px 20px; font-size: 14px; color: #475569;">• Email: <strong>{{student_email}}</strong></p>
<p style="margin: 0 0 2px 20px; font-size: 14px; color: #475569;">• Create a secure password</p>
<p style="margin: 0 0 8px 20px; font-size: 14px; color: #475569;">• Confirm your password</p>

<p style="margin: 6px 0 2px 0; font-size: 15px;"><strong>Step 4:</strong> Submit Registration</p>
<p style="margin: 0 0 8px 20px; font-size: 14px; color: #475569;">Click the "Register" button to submit your information</p>

<p style="margin: 6px 0 2px 0; font-size: 15px;"><strong>Step 5:</strong> Check Your Email</p>
<p style="margin: 0 0 8px 20px; font-size: 14px; color: #475569;">Look for a confirmation email from ARNOMA (check spam folder if needed)</p>

<p style="margin: 6px 0 2px 0; font-size: 15px;"><strong>Step 6:</strong> Confirm Your Email Address</p>
<p style="margin: 0 0 8px 20px; font-size: 14px; color: #475569;">Click the "Confirm Email Address" button in the email</p>

<p style="margin: 6px 0 2px 0; font-size: 15px;"><strong>Step 7:</strong> Log In & Start Learning!</p>
<p style="margin: 0 0 0 20px; font-size: 14px; color: #475569;">Return to <a href="https://student.richyfesta.com" style="color: #3b82f6; text-decoration: none; font-weight: 600;">student.richyfesta.com</a> and log in with your credentials</p>
</div>

<hr class="divider">

<div style="background-color: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin: 10px 0;">
<p style="margin: 0 0 6px 0; font-size: 15px; font-weight: 600; color: #92400e;">⚠️ Important Reminders:</p>
<p style="margin: 2px 0; font-size: 14px; color: #78350f;">• <strong>Use the exact email address shown above</strong> when registering</p>
<p style="margin: 2px 0; font-size: 14px; color: #78350f;">• Keep your password secure and don't share it with anyone</p>
<p style="margin: 2px 0; font-size: 14px; color: #78350f;">• If you don't receive the confirmation email within 5 minutes, check your spam folder</p>
</div>

<hr class="divider">

<div style="background-color: #f0fdf4; border-left: 4px solid #10b981; border-radius: 8px; padding: 12px 16px; margin: 10px 0;">
<p style="margin: 0 0 6px 0; font-size: 15px; font-weight: 600; color: #065f46;">✨ What You'll Get Access To:</p>
<p style="margin: 2px 0; font-size: 14px; color: #064e3b;">✓ Class notes and study materials</p>
<p style="margin: 2px 0; font-size: 14px; color: #064e3b;">✓ Practice tests and quizzes</p>
<p style="margin: 2px 0; font-size: 14px; color: #064e3b;">✓ Payment history and class schedule</p>
<p style="margin: 2px 0; font-size: 14px; color: #064e3b;">✓ Direct communication with instructors</p>
<p style="margin: 2px 0; font-size: 14px; color: #064e3b;">✓ Progress tracking and analytics</p>
</div>

<hr class="divider">

<p style="font-size: 15px; color: #334155; line-height: 1.4; margin: 10px 0 0 0;">Need assistance? We're here to help! Reply to this email or contact us at <a href="mailto:student-services@acnhs.am" style="color: #3b82f6; text-decoration: none; font-weight: 600;">student-services@acnhs.am</a></p>

<p style="font-size: 15px; color: #334155; line-height: 1.4; margin: 10px 0 0 0;">We're excited to have you in the program!</p>

<p style="font-size: 15px; color: #1e293b; font-weight: 600; margin: 10px 0 0 0;">Best regards,<br>ACNHS Student Services Team</p>`;

        document.getElementById('portalRegBody').value = defaultBody;

        // Generate HTML preview with first student's data as example
        const firstStudent = portalRegSelectedStudents[0];
        const previewBody = defaultBody
          .replace(/{{student_name}}/g, firstStudent.name)
          .replace(/{{student_email}}/g, firstStudent.email);
        
        // Body is already HTML, no need to convert
        const fullHTML = generatePortalRegistrationEmailHTML('Portal Registration Instructions', previewBody);
        
        // Display in iframe
        const iframe = document.getElementById('portalRegEmailPreview');
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(fullHTML);
        iframeDoc.close();

        // Hide progress, show buttons
        document.getElementById('portalRegProgress').style.display = 'none';
        document.getElementById('portalRegBackBtn').style.display = 'inline-block';
        document.getElementById('portalRegSendBtn').style.display = 'inline-block';
      }

      function closePortalRegistrationPreview() {
        const modal = document.getElementById('portalRegistrationPreviewModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
        
        // Re-open the first modal
        setTimeout(() => openPortalRegistrationModal(), 100);
      }

      async function sendPortalRegistrationEmails() {
        const subject = document.getElementById('portalRegSubject').value.trim();
        const bodyTemplate = document.getElementById('portalRegBody').value.trim();

        if (!subject || !bodyTemplate) {
          await customAlert('Missing Information', 'Please provide both subject and message body.');
          return;
        }

        // Confirm before sending
        const confirmed = await customConfirm(
          'Send Emails?',
          `Are you sure you want to send registration instructions to ${portalRegSelectedStudents.length} student${portalRegSelectedStudents.length > 1 ? 's' : ''}?`
        );

        if (!confirmed) return;

        // Show progress
        const progressDiv = document.getElementById('portalRegProgress');
        const progressText = document.getElementById('portalRegProgressText');
        const progressBar = document.getElementById('portalRegProgressBar');
        const sendBtn = document.getElementById('portalRegSendBtn');
        const backBtn = document.getElementById('portalRegBackBtn');

        progressDiv.style.display = 'block';
        sendBtn.style.display = 'none';
        backBtn.style.display = 'none';

        let successCount = 0;
        let failCount = 0;
        const errors = [];

        // Send emails
        for (let i = 0; i < portalRegSelectedStudents.length; i++) {
          const student = portalRegSelectedStudents[i];
          
          progressText.textContent = `Sending ${i + 1}/${portalRegSelectedStudents.length}...`;
          progressBar.style.width = ((i / portalRegSelectedStudents.length) * 100) + '%';

          try {
            // Replace variables in body
            const personalizedBody = bodyTemplate
              .replace(/{{student_name}}/g, student.name)
              .replace(/{{student_email}}/g, student.email);

            // Generate full HTML email with ARNOMA template
            const fullHTML = generatePortalRegistrationEmailHTML('Portal Registration Instructions', personalizedBody);

            // Send email via Supabase Edge Function
            const emailResponse = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
              },
              body: JSON.stringify({
                to: student.email,
                subject: subject,
                html: fullHTML
              })
            });

            if (!emailResponse.ok) {
              const errorData = await emailResponse.json().catch(() => ({}));
              throw new Error(errorData.error || 'Failed to send email');
            }

            const responseData = await emailResponse.json();
            const resendEmailId = responseData?.id || responseData?.emailId || null;

            // Log to sent_emails table
            try {
              await supabaseClient.from('sent_emails').insert({
                recipient_email: student.email,
                recipient_name: student.name,
                subject: subject,
                body: fullHTML,
                email_type: 'portal_registration',
                template_id: null,
                resend_id: resendEmailId,
                delivery_status: 'pending',
                sent_by: 'admin'
              });
            } catch (logError) {
              console.warn('Failed to log email:', logError);
            }

            successCount++;

            // Small delay to avoid rate limiting
            if (i < portalRegSelectedStudents.length - 1) {
              await new Promise(resolve => setTimeout(resolve, 100));
            }

          } catch (error) {
            console.error(`Failed to send to ${student.email}:`, error);
            failCount++;
            errors.push(`${student.name}: ${error.message}`);
          }
        }

        // Complete
        progressBar.style.width = '100%';
        progressText.textContent = 'Complete!';

        // Show results
        await new Promise(resolve => setTimeout(resolve, 500));

        let resultMessage = '';
        if (successCount > 0) {
          resultMessage = `✅ Successfully sent ${successCount} email${successCount > 1 ? 's' : ''}`;
        }
        if (failCount > 0) {
          resultMessage += `\n\n❌ Failed to send ${failCount} email${failCount > 1 ? 's' : ''}:\n${errors.join('\n')}`;
        }

        await customAlert('Email Sending Complete', resultMessage);

        // Close modal
        document.getElementById('portalRegistrationPreviewModal').classList.remove('active');
        document.body.style.overflow = '';

        // Reset state
        portalRegSelectedStudents = [];
      }

      function openModal(studentId) {
        currentStudent = students.find(s => s.id === studentId);
        if (!currentStudent) return;

        const s = currentStudent;
        const groupLetter = (s.groupCode || '').replace(/[^A-Z]/gi, '').charAt(0).toUpperCase();
        const emailArray = Array.isArray(s.email) ? s.email : (s.email ? [s.email] : []);
        const aliasesArray = Array.isArray(s.aliases) ? s.aliases : (s.aliases ? [s.aliases] : []);

        // Hero banner
        document.getElementById('modalAvatar').textContent = s.name ? s.name.charAt(0).toUpperCase() : '?';
        document.getElementById('modalName').textContent = s.name || '—';
        document.getElementById('modalNameInput').value = s.name || '';
        document.getElementById('modalGroup').textContent = formatGroupDisplay(s.groupCode || s.group || '') || 'No Group';
        document.getElementById('modalPrice').textContent = formatPrice(s.price_per_class);
        document.getElementById('modalCreditDisplay').textContent = `$${s.balance || 0}`;

        const collegeDisplay = document.getElementById('modalCollegeDisplay');
        collegeDisplay.textContent = s.college ? `🎓 ${s.college}` : '';

        // Status badge
        const badge = document.getElementById('modalStatusBadge');
        badge.textContent = (s.status || 'active').toUpperCase();
        badge.className = `profile-status-btn ${s.status || 'active'}`;

        // Contact fields
        document.getElementById('modalPhone').value = formatPhone(s.phone) || '';
        document.getElementById('modalEmail').value = emailArray.join('\n');
        document.getElementById('modalCollege').value = s.college || '';

        // Financial
        document.getElementById('modalCredit').value = s.balance || 0;

        // Price buttons
        const currentPrice = s.price_per_class || 0;
        document.querySelectorAll('#amountButtons .price-btn').forEach(btn => {
          const val = parseInt(btn.textContent.replace(/[^0-9]/g, '')) || 0;
          btn.classList.toggle('active', val === currentPrice);
        });

        // Group buttons
        document.querySelectorAll('#groupButtons .group-btn').forEach(btn => {
          btn.classList.toggle('active', btn.textContent.trim() === groupLetter);
        });

        // Calendar toggle
        const calToggle = document.getElementById('modalCalendarToggle');
        if (calToggle) calToggle.checked = !!s.showInCalendar;

        // Aliases & notes
        document.getElementById('modalAliases').value = aliasesArray.join(', ');
        document.getElementById('modalNotes').value = s.notes || '';

        // Auto-save on blur
        ['modalPhone','modalEmail','modalCollege','modalCredit','modalAliases','modalNotes','modalNameInput'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.onblur = autoSaveField;
        });

        // Focus handler: email comma format
        document.getElementById('modalEmail').onfocus = function() {
          this.value = emailArray.join(', ');
        };

        // Hide save indicator
        const ind = document.getElementById('modalSaveIndicator');
        if (ind) ind.classList.remove('visible');

        // Lock scroll & show
        document.body.style.overflow = 'hidden';
        DOMCache.modalBackdrop.classList.add('active');
      }

      function handleModalSave() {
        if (!currentStudent) return;
        // Read all fields and save
        currentStudent.name = document.getElementById('modalNameInput').value.trim() || currentStudent.name;
        currentStudent.phone = formatPhone(document.getElementById('modalPhone').value);
        const rawEmail = document.getElementById('modalEmail').value;
        currentStudent.email = rawEmail.split(/[,\n]+/).map(e => e.trim()).filter(Boolean);
        currentStudent.college = document.getElementById('modalCollege').value.trim();
        currentStudent.balance = parseInt(document.getElementById('modalCredit').value) || 0;
        currentStudent.aliases = document.getElementById('modalAliases').value.split(',').map(a => a.trim()).filter(Boolean);
        currentStudent.notes = document.getElementById('modalNotes').value;

        saveStudent(currentStudent).then(() => {
          renderStudentCards();
          // Update hero display
          document.getElementById('modalName').textContent = currentStudent.name;
          document.getElementById('modalPrice').textContent = formatPrice(currentStudent.price_per_class);
          document.getElementById('modalCreditDisplay').textContent = `$${currentStudent.balance || 0}`;
          document.getElementById('modalCollegeDisplay').textContent = currentStudent.college ? `🎓 ${currentStudent.college}` : '';
          // Flash save indicator
          const ind = document.getElementById('modalSaveIndicator');
          if (ind) {
            ind.classList.add('visible');
            setTimeout(() => ind.classList.remove('visible'), 2500);
          }
        });
      }

      async function handleModalDelete() {
        if (!currentStudent) return;
        const confirmed = await customConfirm('Delete Student', `Permanently delete "${currentStudent.name}"? This cannot be undone.`);
        if (!confirmed) return;
        const id = currentStudent.id;
        closeModal();
        const ok = await deleteStudentFromDB(id);
        if (ok) {
          students = students.filter(s => s.id !== id);
          filteredStudents = filteredStudents.filter(s => s.id !== id);
          renderStudentCards();
        }
      }

      function handleModalCalendarToggle(checkbox) {
        if (!currentStudent) return;
        toggleCalendarVisibility(currentStudent.id, checkbox.checked);
      }

      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // Optimized auto-save with debouncing and batch updates
      const autoSaveField = (function() {
        let pendingUpdates = new Set();
        let updateTimer = null;
        
        const performUpdate = () => {
          if (!currentStudent || pendingUpdates.size === 0) return;
          
          // Save to database once for all fields
          saveStudent(currentStudent);
          
          // Update UI once
          renderStudentCards();
          
          // Clear pending updates
          pendingUpdates.clear();
          updateTimer = null;
        };
        
        const debouncedUpdate = debounce(performUpdate, 500);
        
        return async function(event) {
          if (!currentStudent) return;

          const fieldId = event.target.id;
          const value = event.target.value;
          
          // Track that this field needs updating
          pendingUpdates.add(fieldId);

          // Update student data based on which field was edited
          if (fieldId === 'modalNameInput') {
            currentStudent.name = value.trim();
            document.getElementById('modalName').textContent = currentStudent.name;
            debugLog('✅ Name queued for save:', currentStudent.name);
          } else if (fieldId === 'modalCredit') {
            currentStudent.balance = typeof value === 'number' ? value : parseInt(value) || 0;
            debugLog('✅ Credit balance queued for save:', currentStudent.balance);
          } else if (fieldId === 'modalPhone') {
            // Format phone on save
            const formatted = formatPhone(value);
            currentStudent.phone = formatted;
            event.target.value = formatted;
            debugLog('✅ Phone queued for save:', formatted);
          } else if (fieldId === 'modalEmail') {
            const emailsRaw = value
              .split(/[\n,]/)
              .map(e => e.trim())
              .filter(e => e);

            if (emailsRaw.length > 0) {
              const invalidEmails = emailsRaw.filter(email => !validateEmail(email));

              if (invalidEmails.length > 0) {
                console.error('❌ Invalid email format:', invalidEmails);
                await customAlert('Invalid Email', `Invalid email format: ${invalidEmails.join(', ')}`);
                pendingUpdates.delete(fieldId);
                return;
              }

              if (emailsRaw.length > 1) {
                await customAlert('Multiple Emails Detected', 'Only the first email will be saved for registration. Additional entries will be ignored.');
              }

              const primaryEmail = emailsRaw[0].toLowerCase();
              currentStudent.email = primaryEmail;
              debugLog('✅ Primary email queued for save:', primaryEmail);
              event.target.value = primaryEmail;
            } else {
              currentStudent.email = '';
              event.target.value = '';
              debugLog('🧹 Email cleared for student.');
            }
          } else if (fieldId === 'modalCollege') {
            // Save college name
            currentStudent.college = value.trim();
            debugLog('✅ College queued for save:', currentStudent.college);
          } else if (fieldId === 'modalAliases') {
            // Parse comma-separated aliases into array
            const aliasesRaw = value
              .split(',')
              .map(a => a.trim())
              .filter(a => a);

            // Validate that no alias is empty after trimming
            if (aliasesRaw.length === 0 && value.trim() !== '') {
              console.error('❌ Invalid aliases: empty values found');
              await customAlert('Invalid Input', 'Aliases cannot be empty');
              pendingUpdates.delete(fieldId);
              return;
            }

            // Save as array
            currentStudent.aliases = aliasesRaw;
            debugLog('✅ Aliases queued for save:', aliasesRaw);

            // Update display to show stacked format
            event.target.value = aliasesRaw.join('\n');
          } else if (fieldId === 'modalNotes') {
            // Notes are saved as-is (can have line breaks)
            currentStudent.notes = value;
            debugLog('✅ Notes queued for save:', value);
          }

          // Debounce the actual save and render
          debouncedUpdate();
        };
      })();

      function cycleModalStatus() {
        if (!currentStudent) return;

        const statusOrder = ['active', 'paused', 'graduated', 'inactive'];
        const currentIndex = statusOrder.indexOf(currentStudent.status || 'active');
        currentStudent.status = statusOrder[(currentIndex + 1) % statusOrder.length];

        const badge = document.getElementById('modalStatusBadge');
        badge.textContent = currentStudent.status.toUpperCase();
        badge.className = `profile-status-btn ${currentStudent.status}`;

        debugLog(`Modal status changed to: ${currentStudent.status}`);
        saveStudent(currentStudent);
        renderStudentCards();
      }

      async function selectGroup(letter, btn) {
        console.log('🔄 selectGroup called:', { letter, currentStudent: currentStudent?.name });
        
        try {
          const normalizedLetter = canonicalizeGroupCode(letter);
          console.log('✅ Normalized letter:', normalizedLetter);
          
          // Remove active from all group buttons
          document.querySelectorAll('#groupButtons .group-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          if (currentStudent) {
            currentStudent.groupCode = normalizedLetter;
            currentStudent.group = formatGroupDisplay(normalizedLetter);
            document.getElementById('modalGroup').textContent = currentStudent.group;
            console.log(`✅ Group changed to: ${currentStudent.group}`);
            
            const result = await saveStudent(currentStudent);
            console.log('✅ Save result:', result);
            
            await renderStudentCards();
            console.log('✅ Cards rendered');
          } else {
            console.error('❌ No currentStudent set!');
          }
        } catch (error) {
          console.error('❌ Error in selectGroup:', error);
          alert(`Error changing group: ${error.message}`);
        }
      }

      function selectAmount(amount, btn) {
        // Remove active from all amount buttons
        document.querySelectorAll('#amountButtons .price-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        if (currentStudent) {
          // Parse amount if it's a string like "100 $"
          const numericAmount = typeof amount === 'string'
            ? parseInt(amount.replace(/[^0-9]/g, '')) || 0
            : amount;
          
          currentStudent.price_per_class = numericAmount;
          document.getElementById('modalPrice').textContent = formatPrice(numericAmount);
          debugLog(`Price per class changed to: ${numericAmount}`);
          saveStudent(currentStudent);
          renderStudentCards();
        }
      }

      async function toggleCalendarVisibility(studentId, isVisible) {
        debugLog(`🔄 toggleCalendarVisibility called: studentId=${studentId}, isVisible=${isVisible}`);
        
        const student = students.find(s => s.id === studentId);
        if (!student) {
          console.error(`❌ Student with ID ${studentId} not found!`);
          return;
        }

        debugLog(`📝 BEFORE toggle: ${student.name} - showInCalendar=${student.showInCalendar}`);
        student.showInCalendar = isVisible;
        debugLog(`📝 AFTER toggle: ${student.name} - showInCalendar=${student.showInCalendar}`);

        // If toggled OFF, set price_per_class to 0
        if (!isVisible) {
          student.price_per_class = 0;
          debugLog(`${student.name} calendar visibility: OFF - price_per_class set to 0`);
        } else {
          debugLog(`${student.name} calendar visibility: ON`);
        }

        // Save to Supabase
        debugLog(`💾 About to save ${student.name} to Supabase...`);
        try {
          const result = await saveStudent(student);
          debugLog(`✅ Save successful for ${student.name}:`, result);
        } catch (error) {
          console.error(`❌ Save FAILED for ${student.name}:`, error);
          return;
        }

        // 🔄 UPDATE CALENDAR'S STUDENT CACHE AND REFRESH CALENDAR
        // If Calendar module is loaded, update its studentsCache
        if (window.studentsCache && Array.isArray(window.studentsCache)) {
          const cachedStudent = window.studentsCache.find(s => s.id === studentId);
          if (cachedStudent) {
            cachedStudent.show_in_grid = isVisible;
            debugLog(`✅ Updated Calendar cache for ${student.name}: show_in_grid=${isVisible}`);
            
            // Clear month cache to force recalculation
            if (typeof window.clearMonthCache === 'function') {
              window.clearMonthCache();
              debugLog(`🔄 Cleared month cache`);
            }
            
            // Trigger calendar re-render if function exists
            if (typeof window.renderCalendar === 'function') {
              window.renderCalendar();
              debugLog(`🔄 Re-rendered calendar`);
            }
          }
        }

        renderStudentCards();
      }

      function closeModal() {
        // Restore body scroll
        document.body.style.overflow = '';

        // ⚡ Performance: Use cached backdrop
        DOMCache.modalBackdrop.classList.remove('active');
        currentStudent = null;
      }

      // Close on backdrop click - use cached element
      DOMCache.modalBackdrop?.addEventListener('click', closeModal);

      // Close on ESC key
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeModal();
      });

      // Initial render - Load students from Supabase
      // NOTE: loadStudents() is now called after auth check passes (see Supabase init section)

      // ============================================================
      // REAL-TIME NOTIFICATIONS FOR NEW STUDENT REGISTRATIONS
      // ============================================================
      let newRegistrationsCount = 0;

      // Update notification badge
      function updateNotificationBadge(count) {
        const waitingListBtn = document.getElementById('waitingListBtn');
        const waitingListBadge = document.getElementById('waitingListBadge');
        
        if (!waitingListBadge || !waitingListBtn) return;
        
        if (count > 0) {
          waitingListBadge.textContent = count;
          waitingListBadge.style.display = 'flex';
          waitingListBtn.classList.add('has-notification');
        } else {
          waitingListBadge.style.display = 'none';
          waitingListBtn.classList.remove('has-notification');
        }
      }

      // Subscribe to real-time changes on student_waiting_list table
      async function subscribeToRegistrations() {
        if (!supabaseClient) {
          console.warn('⚠️ Supabase not initialized, skipping real-time subscription');
          return null;
        }

        try {
          debugLog('👂 Subscribing to student_waiting_list real-time updates...');

          // Get current count of ALL waiting list students
          const { data: initialData, error: initialError } = await supabaseClient
            .from('student_waiting_list')
            .select('id');

          if (!initialError && initialData) {
            newRegistrationsCount = initialData.length;
            updateNotificationBadge(newRegistrationsCount);
            debugLog(`📊 Initial waiting list count: ${newRegistrationsCount}`);
          }

          // Subscribe to INSERT and DELETE events on student_waiting_list
          const subscription = supabaseClient
            .channel('student_registrations')
            .on(
              'postgres_changes',
              {
                event: 'INSERT',
                schema: 'public',
                table: 'student_waiting_list',
              },
              payload => {
                debugLog('🔔 New registration received!', payload);

                const newStudent = payload.new;
                const studentName = `${newStudent.first_name} ${newStudent.last_name}`;

                // Increment counter
                newRegistrationsCount++;
                updateNotificationBadge(newRegistrationsCount);

                // Add to notification center
                addNotification(
                  'New Student Registration! 🎓',
                  `${studentName} has registered and is waiting for approval.`,
                  'student'
                );

                // Log to console
                debugLog(`✨ New student registered: ${studentName} (${newStudent.email})`);
              }
            )
            .on(
              'postgres_changes',
              {
                event: 'DELETE',
                schema: 'public',
                table: 'student_waiting_list',
              },
              payload => {
                debugLog('🗑️ Student removed from waiting list', payload);

                // Decrement counter
                newRegistrationsCount = Math.max(0, newRegistrationsCount - 1);
                updateNotificationBadge(newRegistrationsCount);
              }
            )
            .subscribe(status => {
              if (status === 'SUBSCRIBED') {
                debugLog('✅ Successfully subscribed to student registration notifications');
              } else if (status === 'CHANNEL_ERROR') {
                console.warn('⚠️ Real-time channel error - continuing without live notifications');
              } else if (status === 'TIMED_OUT') {
                console.warn('⚠️ Real-time subscription timed out - continuing without live notifications');
              } else if (status === 'CLOSED') {
                console.warn('⚠️ Real-time channel closed');
              }
            });

          return subscription;
        } catch (error) {
          console.warn('⚠️ Could not subscribe to real-time updates:', error.message);
          debugLog('💡 App will continue to work without live notifications');
          return null;
        }
      }

      // Override openWaitingListModal to refresh badge on open
      const originalOpenWaitingListModal = window.openWaitingListModal;
      window.openWaitingListModal = function () {
        // Note: Badge will be updated by loadWaitingList() with actual count

        // Call original function
        if (originalOpenWaitingListModal) {
          originalOpenWaitingListModal();
        }
      };

      // Initialize notifications on page load
      window.addEventListener('DOMContentLoaded', async () => {
        // ⚡ Initialize performance optimizations
        DOMCache.init();
        debugLog('⚡ Performance optimizations initialized');
        
        try {
          await loadNotifications();
        } catch (error) {
          console.warn('⚠️ Could not load notifications:', error);
        }
        
        try {
          await subscribeToRegistrations();
        } catch (error) {
          console.warn('⚠️ Could not subscribe to registrations:', error);
        }
        
        // Add scroll listener for lazy loading
        window.addEventListener('scroll', handleScroll, { passive: true });
        
        // NOTE: filteredStudents will be initialized in loadStudents() after auth check
        // Don't initialize here as students array is still empty
        
        // Use cached DOM elements instead of querying again
        if (DOMCache.searchInput) {
          DOMCache.searchInput.addEventListener('input', (e) => {
            debouncedApplyFilters();
            // Show/hide clear button
            const clearBtn = document.getElementById('searchClearBtn');
            if (clearBtn) {
              clearBtn.classList.toggle('visible', e.target.value.length > 0);
            }
          });
        }
        
        if (DOMCache.groupFilter) {
          DOMCache.groupFilter.addEventListener('change', applyFilters);
        }
        
        if (DOMCache.statusFilter) {
          DOMCache.statusFilter.addEventListener('change', applyFilters);
        }
        
        if (DOMCache.paymentFilter) {
          DOMCache.paymentFilter.addEventListener('change', applyFilters);
        }
        
        const sortFilter = document.getElementById('sortFilter');
        if (sortFilter) {
          sortFilter.addEventListener('change', applyFilters);
        }
        
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        if (clearFiltersBtn) {
          clearFiltersBtn.addEventListener('click', clearAllFilters);
        }
        
        // Add event delegation for student cards
        const studentsGrid = document.getElementById('studentsGrid');
        if (studentsGrid) {
          // ⚡ Performance: Event delegation - single listener for all cards
          studentsGrid.addEventListener('click', function(e) {
            // Find the closest student card
            const card = e.target.closest('.student-card');
            if (!card) return;
            
            const studentId = parseInt(card.dataset.studentId);
            
            // Check if clicked on toggle calendar checkbox
            if (e.target.type === 'checkbox' && e.target.dataset.action === 'toggle-calendar') {
              debugLog(`🖱️ Toggle clicked! studentId=${studentId}, checked=${e.target.checked}`);
              toggleCalendarVisibility(studentId, e.target.checked);
              return;
            }
            
            // Check if clicked on status pill
            if (e.target.dataset.action === 'cycle-status') {
              e.stopPropagation();
              cycleStatus(studentId);
              return;
            }
            
            // Otherwise open modal
            if (!e.target.closest('.card-toggle') && !e.target.closest('.status-pill')) {
              openModal(studentId);
            }
          });

          // Also listen for change events on checkboxes (backup)
          studentsGrid.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' && e.target.dataset.action === 'toggle-calendar') {
              const card = e.target.closest('.student-card');
              if (!card) return;
              const studentId = parseInt(card.dataset.studentId);
              debugLog(`🔄 Toggle changed! studentId=${studentId}, checked=${e.target.checked}`);
              toggleCalendarVisibility(studentId, e.target.checked);
            }
          });
        }
      });

      // ============================================================
      // NOTIFICATION CENTER SYSTEM
      // ============================================================

      let allNotifications = [];
      let unreadCount = 0;

      // Load notifications from Supabase
      async function loadNotifications() {
        try {
          debugLog('🔔 Loading notifications from Supabase...');

          const { data, error } = await supabaseClient
            .from('notifications')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(100);

          if (error) {
            console.error('❌ Error loading notifications:', error);
            return;
          }

          allNotifications = data || [];
          unreadCount = allNotifications.filter(n => !n.read).length;

          debugLog(`✅ Loaded ${allNotifications.length} notifications (${unreadCount} unread)`);

          updateNotificationBadge();
          renderNotificationCenter();

        } catch (err) {
          console.error('❌ Exception loading notifications:', err);
        }
      }

      // Update notification badge
      function updateNotificationBadge() {
        const badge = document.getElementById('notificationBadge');
        const bellBtn = document.getElementById('notificationBellBtn');

        if (!badge || !bellBtn) return;

        if (unreadCount > 0) {
          badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
          badge.style.display = 'flex';
          bellBtn.classList.add('has-unread');
        } else {
          badge.style.display = 'none';
          bellBtn.classList.remove('has-unread');
        }
      }

      // Toggle notification center
      function toggleNotificationCenter() {
        const overlay = document.getElementById('notificationCenterOverlay');
        if (!overlay) return;

        if (overlay.classList.contains('active')) {
          closeNotificationCenter();
        } else {
          openNotificationCenter();
        }
      }

      // Open notification center
      async function openNotificationCenter() {
        debugLog('🔔 Opening Notification Center');

        const overlay = document.getElementById('notificationCenterOverlay');
        if (!overlay) return;

        overlay.classList.add('active');

        // Mark all as read after 2 seconds
        setTimeout(async () => {
          await markAllAsRead();
        }, 2000);
      }

      // Close notification center
      function closeNotificationCenter() {
        const overlay = document.getElementById('notificationCenterOverlay');
        if (!overlay) return;

        overlay.classList.remove('active');
        debugLog('🔔 Notification Center closed');
      }

      // Mark all notifications as read
      async function markAllAsRead() {
        try {
          const unreadIds = allNotifications.filter(n => !n.read).map(n => n.id);

          if (unreadIds.length === 0) return;

          debugLog(`🔔 Marking ${unreadIds.length} notifications as read`);

          const { error } = await supabaseClient
            .from('notifications')
            .update({ read: true })
            .in('id', unreadIds);

          if (error) {
            console.error('❌ Error marking notifications as read:', error);
            return;
          }

          // Update local state
          allNotifications.forEach(n => {
            if (unreadIds.includes(n.id)) {
              n.read = true;
            }
          });

          unreadCount = 0;
          updateNotificationBadge();
        } catch (err) {
          console.error('❌ Error in markAllAsRead:', err);
        }
      }

      // Clear all notifications
      async function clearAllNotifications() {
        if (allNotifications.length === 0) {
          await customAlert('No Notifications', 'There are no notifications to clear.');
          return;
        }

        const confirmed = await customConfirm(
          'Clear All Notifications',
          `Are you sure you want to permanently delete all ${allNotifications.length} notifications?`,
          true
        );

        if (!confirmed) return;

        try {
          debugLog(`🗑️ Deleting ${allNotifications.length} notifications from database`);

          const { error } = await supabaseClient
            .from('notifications')
            .delete()
            .neq('id', 0);

          if (error) {
            console.error('❌ Error deleting notifications:', error);
            await customAlert('Error', 'Failed to clear notifications. Please try again.');
            return;
          }

          // Clear local state
          allNotifications = [];
          unreadCount = 0;

          // Update UI
          updateNotificationBadge();
          renderNotificationCenter();

          debugLog('✅ All notifications cleared');

        } catch (err) {
          console.error('❌ Error in clearAllNotifications:', err);
          await customAlert('Error', 'Failed to clear notifications. Please try again.');
        }
      }

      // Add notification to database
      async function addNotification(title, message, category = 'system') {
        try {
          const { data, error } = await supabaseClient
            .from('notifications')
            .insert([
              {
                title: title,
                message: message,
                category: category,
                read: false,
                created_at: new Date().toISOString()
              }
            ])
            .select();

          if (error) {
            console.error('❌ Error adding notification:', error);
            return;
          }

          debugLog('✅ Notification added:', title);

          // Reload notifications to update UI
          await loadNotifications();

        } catch (err) {
          console.error('❌ Error in addNotification:', err);
        }
      }

      // Get category icon
      function getCategoryIcon(category) {
        const icons = {
          student: '👤',
          system: '⚠️',
          success: '✅',
          info: 'ℹ️',
          error: '❌'
        };
        return icons[category] || '🔔';
      }

      // Format notification time
      function formatNotificationTime(timestamp) {
        const now = new Date();
        const date = new Date(timestamp);
        const diff = now - date;

        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;

        return date.toLocaleDateString();
      }

      // Group notifications by time period
      function groupNotifications(notifications) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const thisWeek = new Date(today);
        thisWeek.setDate(thisWeek.getDate() - 7);

        const groups = {
          today: [],
          yesterday: [],
          thisWeek: [],
          older: []
        };

        notifications.forEach(notification => {
          const date = new Date(notification.created_at);

          if (date >= today) {
            groups.today.push(notification);
          } else if (date >= yesterday) {
            groups.yesterday.push(notification);
          } else if (date >= thisWeek) {
            groups.thisWeek.push(notification);
          } else {
            groups.older.push(notification);
          }
        });

        return groups;
      }

      // Render notification center
      function renderNotificationCenter() {
        const container = document.getElementById('notificationCenterBody');
        if (!container) return;

        if (allNotifications.length === 0) {
          container.innerHTML = `
            <div class="notification-empty">
              <div class="notification-empty-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                  <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
              </div>
              <div class="notification-empty-text">No notifications yet</div>
            </div>
          `;
          return;
        }

        const groups = groupNotifications(allNotifications);
        let html = '';

        const groupLabels = {
          today: 'Today',
          yesterday: 'Yesterday',
          thisWeek: 'This Week',
          older: 'Older'
        };

        Object.entries(groups).forEach(([key, notifications]) => {
          if (notifications.length === 0) return;

          html += `<div class="notification-group">`;
          html += `<div class="notification-group-label">${groupLabels[key]}</div>`;

          notifications.forEach(notification => {
            const icon = getCategoryIcon(notification.category);
            const time = formatNotificationTime(notification.created_at);
            const unreadClass = notification.read ? '' : 'unread';
            
            html += `
              <div class="notification-item ${unreadClass}">
                <div class="notification-item-header">
                  <div class="notification-icon ${notification.category}">
                    ${icon}
                  </div>
                  <div class="notification-content">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-meta">
                      <span class="notification-time">${time}</span>
                      ${!notification.read ? '<span class="notification-new-badge">NEW</span>' : ''}
                    </div>
                  </div>
                </div>
              </div>
            `;
          });

          html += `</div>`;
        });

        container.innerHTML = html;
      }

      // Close notification center on overlay click
      document.addEventListener('click', (e) => {
        const overlay = document.getElementById('notificationCenterOverlay');
        if (overlay && e.target === overlay) {
          closeNotificationCenter();
        }
      });

      // ============================================================
      // UPLOAD NOTES MODAL
      // ============================================================
      let selectedNoteGroup = '';
      let selectedPDFFile = null;

      function openUploadNotesModal() {
        document.getElementById('uploadNotesModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        resetUploadForm();
      }

      function closeUploadNotesModal() {
        document.getElementById('uploadNotesModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        resetUploadForm();
      }

      function resetUploadForm() {
        document.getElementById('noteTitle').value = '';
        document.getElementById('noteDescription').value = '';
        document.getElementById('noteDate').value = '';
        document.getElementById('pdfFileInput').value = '';
        document.getElementById('pdfFileName').style.display = 'none';
        document.getElementById('uploadProgress').style.display = 'none';
        selectedNoteGroup = '';
        selectedPDFFile = null;
        
        // Reset group buttons
        document.querySelectorAll('#uploadNotesModal .group-btn').forEach(btn => {
          btn.classList.remove('active');
        });
      }

      function selectNoteGroup(group) {
        selectedNoteGroup = group;
        
        // Update button states
        document.querySelectorAll('#uploadNotesModal .group-btn').forEach(btn => {
          if (btn.getAttribute('data-group') === group) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      function handlePDFSelect(event) {
        const file = event.target.files[0];
        if (!file) {
          selectedPDFFile = null;
          document.getElementById('pdfFileName').style.display = 'none';
          return;
        }

        // Check if it's a PDF
        if (file.type !== 'application/pdf') {
          customAlert('Invalid File', 'Please select a PDF file.');
          event.target.value = '';
          return;
        }

        // Check file size (limit to 50MB)
        const maxSize = 50 * 1024 * 1024; // 50MB
        if (file.size > maxSize) {
          customAlert('File Too Large', 'PDF file must be smaller than 50MB.');
          event.target.value = '';
          return;
        }

        selectedPDFFile = file;
        const fileSize = formatFileSize(file.size);
        document.getElementById('pdfFileNameText').textContent = file.name;
        document.getElementById('pdfFileSize').textContent = `(${fileSize})`;
        document.getElementById('pdfFileName').style.display = 'block';
      }

      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }

      async function uploadNote() {
        const title = document.getElementById('noteTitle').value.trim();
        const description = document.getElementById('noteDescription').value.trim();
        const classDate = document.getElementById('noteDate').value;

        // Validation
        if (!title) {
          customAlert('Missing Title', 'Please enter a note title.');
          return;
        }

        if (!selectedNoteGroup) {
          customAlert('Missing Group', 'Please select a group.');
          return;
        }

        if (!classDate) {
          customAlert('Missing Date', 'Please select a class date.');
          return;
        }

        if (!selectedPDFFile) {
          customAlert('Missing File', 'Please select a PDF file to upload.');
          return;
        }

        try {
          // Disable upload button
          const uploadBtn = document.getElementById('uploadNoteBtn');
          uploadBtn.disabled = true;
          uploadBtn.textContent = '⏳ Uploading...';

          // Show progress
          document.getElementById('uploadProgress').style.display = 'block';
          updateProgress(0, 'Preparing upload...');

          // Upload PDF to storage
          const fileName = `${selectedNoteGroup}/${classDate}_${Date.now()}.pdf`;
          updateProgress(25, 'Uploading PDF...');

          const { data: fileData, error: uploadError } = await supabaseClient.storage
            .from('student-notes')
            .upload(fileName, selectedPDFFile, {
              contentType: 'application/pdf',
              cacheControl: '3600',
              upsert: false
            });

          if (uploadError) {
            console.error('Upload error:', uploadError);
            throw new Error('Failed to upload PDF: ' + uploadError.message);
          }

          updateProgress(50, 'Saving note record...');

          // Get current user email
          const { data: { user } } = await supabaseClient.auth.getUser();

          // Save note metadata to database
          const { data: noteData, error: dbError } = await supabaseClient
            .from('student_notes')
            .insert({
              title: title,
              description: description || null,
              group_name: selectedNoteGroup,
              class_date: classDate,
              pdf_url: fileName,
              file_name: selectedPDFFile.name,
              file_size: selectedPDFFile.size,
              uploaded_by: user?.email || 'admin',
              deleted: false
            })
            .select()
            .single();

          if (dbError) {
            console.error('Database error:', dbError);
            // Try to delete the uploaded file
            await supabaseClient.storage.from('student-notes').remove([fileName]);
            throw new Error('Failed to save note record: ' + dbError.message);
          }

          updateProgress(100, 'Upload complete!');

          // Success
          setTimeout(() => {
            customAlert('Upload Successful', `Note "${title}" uploaded successfully for Group ${selectedNoteGroup}!`);
            closeUploadNotesModal();
          }, 500);

        } catch (error) {
          console.error('Error uploading note:', error);
          customAlert('Upload Failed', error.message || 'An error occurred while uploading the note. Please try again.');
          
          // Re-enable button
          const uploadBtn = document.getElementById('uploadNoteBtn');
          uploadBtn.disabled = false;
          uploadBtn.textContent = '📤 Upload Note';
          document.getElementById('uploadProgress').style.display = 'none';
        }
      }

      function updateProgress(percent, text) {
        document.getElementById('uploadProgressBar').style.width = percent + '%';
        document.getElementById('uploadProgressText').textContent = text;
      }
    </script>

    <!-- ============================================================
         NOTIFICATION CENTER
         ============================================================ -->
    <div id="notificationCenterOverlay" class="notification-center-overlay">
      <div class="notification-center-panel">
        <div class="notification-center-header">
          <div class="notification-center-title">🔔 Notification Center</div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button class="clear-notifications-btn" onclick="clearAllNotifications()" title="Clear all notifications">
              🗑️ Clear All
            </button>
            <button class="notification-center-close" onclick="closeNotificationCenter()" aria-label="Close notification center">×</button>
          </div>
        </div>
        <div class="notification-center-body" id="notificationCenterBody">
          <!-- Notifications will be rendered here -->
          <div class="notification-empty">
            <div class="notification-empty-icon">🔔</div>
            <div class="notification-empty-text">No notifications yet</div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
