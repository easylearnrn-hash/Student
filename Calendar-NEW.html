<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
    <title>üìÖ Calendar - ARNOMA Admin</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1"></script>
    
    <style>
      /* ============================================================
         üé® GLASSMORPHISM DESIGN SYSTEM
         ============================================================ */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --panel-blur: 8px;
        --modal-blur: 14px;
        --list-blur: 0px;
        --accent-cyan: #26ffe6;
        --accent-magenta: #ff00ff;
        --accent-gold: #ffd700;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', sans-serif;
        background: linear-gradient(135deg, #0b0b10 0%, #1a1a2e 100%);
        min-height: 100vh;
        padding: 12px;
        color: rgba(255, 255, 255, 0.9);
        overflow-x: hidden;
      }

      /* Calendar Container */
      .calendar-container {
        max-width: 1600px;
        margin: 0 auto;
        height: calc(100vh - 24px);
      }

      /* Main Calendar Area */
      .calendar-main {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(var(--panel-blur));
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        overflow-y: auto;
        height: 100%;
      }

      /* Calendar Header */
      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .calendar-nav {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: var(--accent-cyan);
        box-shadow: 0 0 15px rgba(38, 255, 230, 0.3);
      }

      .month-display {
        font-size: 24px;
        font-weight: 600;
        color: var(--accent-cyan);
        text-shadow: 0 0 20px rgba(38, 255, 230, 0.4);
      }

      /* Elite Refresh Button */
      .refresh-btn {
        position: relative;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        border: 1px solid rgba(38, 255, 230, 0.3);
        background: linear-gradient(135deg, rgba(38, 255, 230, 0.15), rgba(138, 77, 255, 0.15));
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-left: 12px;
        overflow: hidden;
      }

      .refresh-btn::before {
        content: '';
        position: absolute;
        inset: 0;
        background: var(--primary-gradient);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .refresh-btn:hover::before {
        opacity: 0.2;
      }

      .refresh-btn:hover {
        border-color: rgba(38, 255, 230, 0.6);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(38, 255, 230, 0.3);
      }

      .refresh-btn:active {
        transform: translateY(0);
      }

      .refresh-btn.loading {
        pointer-events: none;
      }

      .refresh-btn.loading .refresh-icon {
        animation: spin 0.8s linear infinite;
      }

      .refresh-icon {
        width: 20px;
        height: 20px;
        fill: none;
        stroke: #26ffe6;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        transition: filter 0.3s ease;
        position: relative;
        z-index: 1;
      }

      .refresh-btn:hover .refresh-icon {
        stroke: #26ffe6;
        filter: drop-shadow(0 0 8px rgba(38, 255, 230, 0.6));
      }

      /* Calendar Grid */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin-top: 20px;
      }

      .day-header-cell {
        text-align: center;
        padding: 10px;
        font-weight: 600;
        color: var(--accent-cyan);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .day-cell {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px;
        min-height: 120px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }

      .day-cell:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: var(--accent-cyan);
        box-shadow: 0 0 20px rgba(38, 255, 230, 0.2);
        transform: translateY(-2px);
      }

      .day-cell.today {
        border: 2px solid var(--accent-cyan);
        box-shadow: 0 0 25px rgba(38, 255, 230, 0.4);
      }

      .day-cell.other-month {
        opacity: 0.3;
        pointer-events: none;
      }

      .day-number {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.9);
      }

      /* Payment Summary in Day Cell */
      .day-payment-summary {
        position: absolute;
        top: 8px;
        right: 8px;
        font-size: 0.7rem;
        font-weight: 600;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 4px;
        z-index: 1;
        white-space: nowrap;
      }

      .day-payment-paid {
        color: #22c55e;
      }

      .day-payment-unpaid {
        color: #ef4444;
      }

      .day-payment-divider {
        color: rgba(255, 255, 255, 0.4);
      }

      /* Dot Indicators */
      .day-dots {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 8px;
      }

      .group-row {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }

      .group-label {
        font-size: 11px;
        font-weight: 700;
        color: var(--accent-cyan);
        min-width: 15px;
        text-shadow: 0 0 8px rgba(38, 255, 230, 0.5);
      }

      .group-dots-container {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }

      .group-separator {
        width: 100%;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(38, 255, 230, 0.3), transparent);
        margin: 2px 0;
      }

      .indicator-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
      }

      .indicator-dot:hover {
        transform: scale(1.5);
        box-shadow: 0 0 10px currentColor;
      }

      .dot-paid {
        background: linear-gradient(135deg, #00ff41 0%, #00cc33 100%);
        box-shadow: 0 0 6px rgba(0, 255, 65, 0.5);
      }

      .dot-manual {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 0 6px rgba(59, 130, 246, 0.5);
      }

      .dot-unpaid {
        background: linear-gradient(135deg, #ff1744 0%, #cc1133 100%);
        box-shadow: 0 0 6px rgba(255, 23, 68, 0.5);
      }

      .dot-absent {
        background: linear-gradient(135deg, #9e9e9e 0%, #666666 100%);
        box-shadow: 0 0 6px rgba(158, 158, 158, 0.5);
      }

      .dot-credit {
        background: linear-gradient(135deg, #ffeb3b 0%, #ffc107 100%);
        box-shadow: 0 0 6px rgba(255, 235, 59, 0.5);
      }

      .dot-skipped {
        background: linear-gradient(135deg, #757575 0%, #424242 100%);
        box-shadow: 0 0 6px rgba(117, 117, 117, 0.5);
      }

      .dot-gray {
        background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
        box-shadow: 0 0 6px rgba(158, 158, 158, 0.3);
      }

      .dot-canceled {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 0 6px rgba(107, 114, 128, 0.5);
        opacity: 0.6;
      }

      /* Filters */
      /* Modal Overlay */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: rgba(30, 30, 50, 0.95);
        backdrop-filter: blur(var(--modal-blur));
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 30px;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
      }

      .modal-title {
        font-size: 24px;
        color: var(--accent-cyan);
      }

      .close-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
      }

      /* Modal Tabs */
      .modal-tabs {
        display: flex;
        gap: 8px;
        margin: 18px 0;
        padding: 0;
        border-bottom: none;
        overflow-x: auto;
        flex-shrink: 0;
      }

      .modal-tabs::-webkit-scrollbar {
        height: 0;
      }

      .modal-tab {
        padding: 8px 16px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.04);
        color: rgba(255,255,255,0.7);
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.2s ease;
      }

      .modal-tab:hover {
        background: rgba(255,255,255,0.08);
      }

      .modal-tab.active {
        background: linear-gradient(135deg, rgba(102,126,234,0.3), rgba(139,92,246,0.3));
        border-color: rgba(139,92,246,0.6);
        color: white;
      }

      .modal-tab-content {
        padding: 0;
        overflow-y: visible;
        flex: 1;
      }

      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: block;
      }

      /* Note Tags Section */
      .class-tags-section {
        margin-bottom: 18px;
      }

      .tag-search {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.05);
        color: white;
        margin-bottom: 8px;
        font-size: 13px;
        font-family: inherit;
        transition: all 0.2s ease;
      }

      .tag-search::placeholder {
        color: rgba(255, 255, 255, 0.4);
      }

      .tag-search:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.08);
      }

      .search-results {
        display: none;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 10px;
        max-height: 200px;
        overflow-y: auto;
      }

      .search-results::-webkit-scrollbar {
        width: 6px;
      }

      .search-results::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
      }

      .search-results::-webkit-scrollbar-thumb {
        background: rgba(138, 180, 255, 0.3);
        border-radius: 3px;
      }

      .search-item {
        padding: 8px 12px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.06);
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s ease;
        color: rgba(255, 255, 255, 0.9);
      }

      .search-item:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      .class-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 28px;
      }

      .class-tag {
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.35), rgba(139, 92, 246, 0.35));
        border: 1px solid rgba(139, 92, 246, 0.5);
        color: white;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .class-tag:hover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.5), rgba(139, 92, 246, 0.5));
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }

      .class-tag .remove-tag {
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s ease;
        font-size: 14px;
        line-height: 1;
      }

      .class-tag .remove-tag:hover {
        opacity: 1;
      }

      .tags-placeholder {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.3);
        font-style: italic;
      }

      .group-section {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 18px;
        padding: 16px;
        margin-bottom: 20px;
      }

      /* Student Info Modal */
      .student-modal {
        background: linear-gradient(135deg, rgba(30, 30, 50, 0.98) 0%, rgba(20, 20, 35, 0.98) 100%);
        backdrop-filter: blur(var(--modal-blur));
        border: 1px solid rgba(138, 180, 255, 0.3);
        border-radius: 20px;
        padding: 0;
        max-width: 420px;
        width: 90%;
        max-height: 85vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      .student-modal-header {
        background: linear-gradient(135deg, rgba(38, 255, 230, 0.1) 0%, rgba(138, 77, 255, 0.1) 100%);
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }

      .student-header-content {
        flex: 1;
      }

      .student-name-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(38, 255, 230, 0.15);
        color: var(--accent-cyan);
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 6px;
        border: 1px solid rgba(38, 255, 230, 0.3);
      }

      .student-counter {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.5);
      }

      .student-name-title {
        font-size: 22px;
        font-weight: 700;
        color: white;
        margin: 0;
        text-shadow: 0 0 20px rgba(38, 255, 230, 0.3);
      }

      .student-group-label {
        color: rgba(255, 255, 255, 0.5);
        font-size: 12px;
        margin-top: 2px;
      }

      .nav-arrows {
        display: flex;
        gap: 6px;
        position: absolute;
        right: 95px;
        top: 50%;
        transform: translateY(-50%);
      }

      .nav-arrow {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .nav-arrow:hover:not(:disabled) {
        background: rgba(38, 255, 230, 0.2);
        border-color: var(--accent-cyan);
        box-shadow: 0 0 15px rgba(38, 255, 230, 0.3);
      }

      .nav-arrow:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .day-nav-arrows {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .student-modal-body {
        padding: 16px 20px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 12px;
      }

      .info-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 10px 12px;
      }

      .info-card.full-width {
        grid-column: 1 / -1;
      }

      .info-label {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .info-value {
        font-size: 18px;
        font-weight: 600;
        color: white;
      }

      .balance-card {
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }

      .balance-card:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--accent-cyan);
        box-shadow: 0 0 15px rgba(38, 255, 230, 0.2);
      }

      .balance-card .info-value {
        color: var(--accent-cyan);
        font-size: 24px;
      }

      .balance-input {
        background: transparent;
        border: none;
        outline: none;
        color: var(--accent-cyan);
        font-size: 24px;
        font-weight: 600;
        font-family: inherit;
        width: 100%;
        cursor: pointer;
        padding: 0;
        text-align: left;
      }

      .balance-input:focus {
        cursor: text;
        border-bottom: 2px solid var(--accent-cyan);
        padding-bottom: 2px;
      }

      .click-to-edit {
        font-size: 9px;
        color: rgba(255, 255, 255, 0.4);
        margin-top: 2px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .quick-actions {
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      .action-btn {
        padding: 10px 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .action-btn-icon {
        font-size: 18px;
      }

      .action-btn.email {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15));
        border-color: rgba(59, 130, 246, 0.3);
        color: #60a5fa;
      }

      .action-btn.email:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(37, 99, 235, 0.25));
        border-color: rgba(59, 130, 246, 0.5);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
      }

      .action-btn.absent {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
        border-color: rgba(239, 68, 68, 0.3);
        color: #f87171;
      }

      .action-btn.absent:hover {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.25));
        border-color: rgba(239, 68, 68, 0.5);
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
      }

      .action-btn.credit {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(22, 163, 74, 0.15));
        border-color: rgba(34, 197, 94, 0.3);
        color: #4ade80;
      }

      .action-btn.credit:hover {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(22, 163, 74, 0.25));
        border-color: rgba(34, 197, 94, 0.5);
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
      }

      /* Stats Bar */
      .stats-bar {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--accent-cyan);
        margin-bottom: 5px;
      }

      #statUnpaid {
        color: #ef4444;
      }

      .stat-label {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* Loading State */
      #calendarGrid .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 400px;
        font-size: 18px;
        color: var(--accent-cyan);
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(38, 255, 230, 0.2);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* Scrollbar Styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(38, 255, 230, 0.3);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(38, 255, 230, 0.5);
      }

      /* ============================================================
         ‚ö° ACTION ICON BUTTONS
         ============================================================ */
      .student-actions {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .action-icon-btn {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.15);
        background: rgba(255,255,255,0.06);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .action-icon-btn:hover {
        background: rgba(255,255,255,0.12);
        transform: translateY(-1px);
      }

      .action-icon-btn .btn-icon {
        font-size: 14px;
        flex-shrink: 0;
      }

      .action-icon-btn .btn-label {
        display: none;
      }

      /* Pause/Resume Button */
      .action-icon-btn.pause {
        border-color: rgba(245, 158, 11, 0.3);
        background: rgba(245, 158, 11, 0.08);
      }

      .action-icon-btn.pause:hover {
        border-color: rgba(245, 158, 11, 0.5);
        background: rgba(245, 158, 11, 0.15);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
      }

      .action-icon-btn.pause.paused {
        border-color: rgba(16, 185, 129, 0.3);
        background: rgba(16, 185, 129, 0.08);
      }

      .action-icon-btn.pause.paused:hover {
        border-color: rgba(16, 185, 129, 0.5);
        background: rgba(16, 185, 129, 0.15);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
      }

      /* Send Email Button */
      .action-icon-btn.send {
        border-color: rgba(103, 126, 234, 0.3);
        background: rgba(103, 126, 234, 0.08);
      }

      .action-icon-btn.send:hover {
        border-color: rgba(103, 126, 234, 0.5);
        background: rgba(103, 126, 234, 0.15);
        box-shadow: 0 4px 12px rgba(103, 126, 234, 0.2);
      }

      .action-icon-btn.send svg {
        width: 16px;
        height: 16px;
      }

      /* Mark Paid Button */
      .action-icon-btn.mark-paid {
        border-color: rgba(5, 150, 105, 0.3);
        background: rgba(5, 150, 105, 0.08);
      }

      .action-icon-btn.mark-paid:hover {
        border-color: rgba(5, 150, 105, 0.5);
        background: rgba(5, 150, 105, 0.15);
        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
      }

      /* Credit Button */
      .action-icon-btn.credit {
        border-color: rgba(59, 130, 246, 0.3);
        background: rgba(59, 130, 246, 0.08);
      }

      .action-icon-btn.credit:hover {
        border-color: rgba(59, 130, 246, 0.5);
        background: rgba(59, 130, 246, 0.15);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
      }

      /* Absent Button */
      .action-icon-btn.absent {
        border-color: rgba(239, 68, 68, 0.3);
        background: rgba(239, 68, 68, 0.08);
      }

      .action-icon-btn.absent:hover {
        border-color: rgba(239, 68, 68, 0.5);
        background: rgba(239, 68, 68, 0.15);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
      }

      /* Unmark Absent Button */
      .action-icon-btn.unmark {
        border-color: rgba(16, 185, 129, 0.3);
        background: rgba(16, 185, 129, 0.08);
      }

      .action-icon-btn.unmark:hover {
        border-color: rgba(16, 185, 129, 0.5);
        background: rgba(16, 185, 129, 0.15);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
      }

      .action-icon-btn:active {
        transform: scale(0.96);
      }

      /* Tooltip */
      .action-icon-btn[data-tooltip] {
        position: relative;
      }

      .action-icon-btn[data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: calc(100% + 6px);
        left: 50%;
        transform: translateX(-50%);
        padding: 6px 10px;
        background: rgba(0, 0, 0, 0.95);
        color: white;
        font-size: 0.75rem;
        white-space: nowrap;
        border-radius: 6px;
        z-index: 10000;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <!-- Main Container -->
    <div class="calendar-container">
      <!-- Main Calendar -->
      <div class="calendar-main">
        <!-- Header -->
        <div class="calendar-header">
          <div class="calendar-nav">
            <button class="nav-btn" id="prevMonth">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="vertical-align: middle; margin-right: 4px;">
                <path d="M10 13L5 8L10 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Previous
            </button>
            <button class="nav-btn" id="todayBtn">Today</button>
            <button class="nav-btn" id="nextMonth">
              Next
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="vertical-align: middle; margin-left: 4px;">
                <path d="M6 3L11 8L6 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          <div class="month-display">
            <span id="currentMonth">January</span> <span id="currentYear">2025</span>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <!-- Status Filter Dropdown -->
            <div style="position: relative;">
              <button 
                id="statusFilterBtn" 
                style="padding: 10px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(138,180,255,0.3); border-radius: 10px; color: white; outline: none; font-size: 14px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                onclick="toggleStatusDropdown(event)"
              >
                <span id="statusFilterLabel">All Statuses</span>
                <span style="font-size: 10px;">‚ñº</span>
              </button>
              <div 
                id="statusFilterDropdown" 
                style="position: fixed; background: rgba(255,255,255,0.04); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255,255,255,0.15); border-radius: 14px; padding: 8px; min-width: 220px; z-index: 9999999; box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(138,180,255,0.15); opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.2s ease, transform 0.2s ease;"
                onclick="event.stopPropagation()"
              >
                <label style="display: flex; align-items: center; padding: 10px 12px; cursor: pointer; border-radius: 10px; transition: all 0.2s ease; font-size: 14px; color: white;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='transparent'">
                  <input type="checkbox" value="paid" style="margin-right: 12px; width: 16px; height: 16px; cursor: pointer; accent-color: #22c55e;" onchange="updateStatusFilter()">
                  <span style="color: #22c55e; font-weight: 500;">‚úÖ Paid</span>
                </label>
                <label style="display: flex; align-items: center; padding: 10px 12px; cursor: pointer; border-radius: 10px; transition: all 0.2s ease; font-size: 14px; color: white;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='transparent'">
                  <input type="checkbox" value="unpaid" style="margin-right: 12px; width: 16px; height: 16px; cursor: pointer; accent-color: #ef4444;" onchange="updateStatusFilter()">
                  <span style="color: #ef4444; font-weight: 500;">‚ùå Unpaid</span>
                </label>
                <label style="display: flex; align-items: center; padding: 10px 12px; cursor: pointer; border-radius: 10px; transition: all 0.2s ease; font-size: 14px; color: white;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='transparent'">
                  <input type="checkbox" value="credit" style="margin-right: 12px; width: 16px; height: 16px; cursor: pointer; accent-color: #3b82f6;" onchange="updateStatusFilter()">
                  <span style="color: #3b82f6; font-weight: 500;">üí≥ Credit</span>
                </label>
                <label style="display: flex; align-items: center; padding: 10px 12px; cursor: pointer; border-radius: 10px; transition: all 0.2s ease; font-size: 14px; color: white;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='transparent'">
                  <input type="checkbox" value="absent" style="margin-right: 12px; width: 16px; height: 16px; cursor: pointer; accent-color: #f59e0b;" onchange="updateStatusFilter()">
                  <span style="color: #f59e0b; font-weight: 500;">üö´ Absent</span>
                </label>
                <label style="display: flex; align-items: center; padding: 10px 12px; cursor: pointer; border-radius: 10px; transition: all 0.2s ease; font-size: 14px; color: white;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='transparent'">
                  <input type="checkbox" value="canceled" style="margin-right: 12px; width: 16px; height: 16px; cursor: pointer; accent-color: #6b7280;" onchange="updateStatusFilter()">
                  <span style="color: #9ca3af; font-weight: 500;">‚≠ï Canceled</span>
                </label>
                <label style="display: flex; align-items: center; padding: 10px 12px; cursor: pointer; border-radius: 10px; transition: all 0.2s ease; font-size: 14px; color: white;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='transparent'">
                  <input type="checkbox" value="partial" style="margin-right: 12px; width: 16px; height: 16px; cursor: pointer; accent-color: #eab308;" onchange="updateStatusFilter()">
                  <span style="color: #eab308; font-weight: 500;">‚ö†Ô∏è Partial</span>
                </label>
              </div>
            </div>

            <!-- Student Search -->
            <div style="position: relative; display: flex; align-items: center;">
              <svg viewBox="0 0 24 24" style="position: absolute; left: 12px; width: 18px; height: 18px; fill: none; stroke: rgba(138,180,255,0.6); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; pointer-events: none;">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input 
                type="text" 
                id="studentSearchInput" 
                placeholder="Search students..." 
                style="padding: 10px 16px 10px 40px; background: rgba(255,255,255,0.08); border: 1px solid rgba(138,180,255,0.3); border-radius: 10px; color: white; outline: none; font-size: 14px; width: 220px; transition: all 0.2s ease;"
                onfocus="this.style.background='rgba(255,255,255,0.12)'; this.style.borderColor='rgba(138,180,255,0.5)'; this.previousElementSibling.style.stroke='rgba(138,180,255,1)';"
                onblur="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='rgba(138,180,255,0.3)'; this.previousElementSibling.style.stroke='rgba(138,180,255,0.6)';"
              />
            </div>

            <!-- Refresh Button -->
            <button class="refresh-btn" id="refreshBtn" title="Refresh calendar data">
              <svg viewBox="0 0 24 24" class="refresh-icon">
                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
          <div class="stat-card">
            <div class="stat-value" id="statClasses">0</div>
            <div class="stat-label">Classes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPaid">$0</div>
            <div class="stat-label">Paid</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statUnpaid">$0</div>
            <div class="stat-label">Unpaid</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statAbsences">0</div>
            <div class="stat-label">Absences</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statCanceled">0</div>
            <div class="stat-label">Canceled</div>
          </div>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-grid" id="calendarGrid">
          <!-- Day headers -->
          <div class="day-header-cell">Sun</div>
          <div class="day-header-cell">Mon</div>
          <div class="day-header-cell">Tue</div>
          <div class="day-header-cell">Wed</div>
          <div class="day-header-cell">Thu</div>
          <div class="day-header-cell">Fri</div>
          <div class="day-header-cell">Sat</div>
          <!-- Days will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Day Details Modal -->
    <div class="modal-overlay" id="dayModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title" id="modalDate">Loading...</div>
          
          <div style="display: flex; align-items: center; gap: 8px;">
            <!-- Day Navigation Arrows -->
            <div class="day-nav-arrows">
              <button class="nav-arrow" id="prevDayBtn" onclick="navigateDay(-1, event)">
                <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                  <path d="M12 16L6 10L12 4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button class="nav-arrow" id="nextDayBtn" onclick="navigateDay(1, event)">
                <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                  <path d="M8 4L14 10L8 16" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
            
            <button class="close-btn" id="closeModal">√ó</button>
          </div>
        </div>
        <div id="modalBody">
          <!-- Modal content will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Student Info Modal -->
    <div class="modal-overlay" id="studentModal" style="display: none;">
      <div class="modal student-modal">
        <div class="student-modal-header">
          <div class="student-header-content">
            <div class="student-name-badge">
              <span>STUDENT</span>
              <span class="student-counter" id="studentCounter">1/1</span>
            </div>
            <h2 class="student-name-title" id="studentNameTitle">Loading...</h2>
            <div class="student-group-label" id="studentGroupLabel">Group: ‚îÄ</div>
          </div>
          
          <!-- Navigation Arrows -->
          <div class="nav-arrows">
            <button class="nav-arrow" id="prevStudentBtn" onclick="navigateStudent(-1)">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M12 16L6 10L12 4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button class="nav-arrow" id="nextStudentBtn" onclick="navigateStudent(1)">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M8 4L14 10L8 16" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          
          <button class="close-btn" onclick="closeStudentModal()">‚úï</button>
        </div>
        
        <div class="student-modal-body">
          <!-- Info Grid (2 columns) -->
          <div class="info-grid">
            <!-- Class Date -->
            <div class="info-card full-width">
              <div class="info-label">Class Date</div>
              <div class="info-value" id="studentClassDate">‚îÄ</div>
            </div>

            <!-- Price Per Class -->
            <div class="info-card">
              <div class="info-label">Price</div>
              <div class="info-value" id="studentPrice">‚îÄ</div>
            </div>

            <!-- Payment Status -->
            <div class="info-card">
              <div class="info-label">Status</div>
              <div class="info-value" id="studentStatus">‚îÄ</div>
            </div>

            <!-- Balance (Editable) -->
            <div class="info-card balance-card" id="balanceCard">
              <div class="info-label">Balance</div>
              <input 
                type="text" 
                class="info-value balance-input" 
                id="studentBalance" 
                value="0"
                onfocus="this.select()"
                onblur="saveBalance()"
                onkeydown="if(event.key==='Enter') this.blur()"
              />
              <div class="click-to-edit">
                <span>‚úèÔ∏è</span>
                <span>Click to edit</span>
              </div>
            </div>
          </div>

          <!-- Quick Actions (dynamic) -->
          <div class="quick-actions" id="studentQuickActions">
            <button class="action-btn email" onclick="sendEmailReminder()">
              <span class="action-btn-icon">üìß</span>
              <span>Email</span>
            </button>
            <button class="action-btn absent" onclick="markAsAbsent()">
              <span class="action-btn-icon">üö´</span>
              <span>Absent</span>
            </button>
            <button class="action-btn credit" onclick="addCredit()">
              <span class="action-btn-icon">üí≥</span>
              <span>Credit</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ============================================================
      // üîß SUPABASE CLIENT INITIALIZATION
      // ============================================================
      const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
      
      // Wait for Supabase SDK to load
      if (typeof window.supabase === 'undefined') {
        console.error('‚ùå Supabase SDK not loaded! Make sure you are accessing via http://localhost:8000, not file://');
        
        // Create error overlay immediately
        const errorOverlay = document.createElement('div');
        errorOverlay.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: linear-gradient(135deg, #1a1f35 0%, #0f1419 100%);
          border: 1px solid rgba(239, 68, 68, 0.5);
          border-radius: 16px;
          padding: 32px;
          max-width: 500px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
          z-index: 99999999;
          animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        `;
        errorOverlay.innerHTML = `
          <h3 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600; color: #ef4444; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
            ‚ùå Supabase SDK Failed to Load
          </h3>
          <div style="margin-bottom: 24px; color: rgba(255,255,255,0.85); font-size: 15px; line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
            <p style="margin: 0 0 12px 0;">Please ensure you are accessing the page via:</p>
            <p style="margin: 0 0 12px 0; padding: 12px; background: rgba(138, 180, 255, 0.1); border: 1px solid rgba(138, 180, 255, 0.3); border-radius: 8px; font-family: 'Courier New', monospace;">
              http://localhost:8000/Calendar-NEW.html
            </p>
            <p style="margin: 0; color: rgba(255,255,255,0.6);">Not: <span style="font-family: 'Courier New', monospace;">file:///...</span></p>
          </div>
        `;
        document.body.appendChild(errorOverlay);
        throw new Error('Supabase SDK not loaded');
      }
      
      const supabaseClient = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ============================================================
      // üîí ADMIN AUTHENTICATION
      // ============================================================
      async function requireAdminSession() {
        try {
          const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
          
          if (sessionError || !session) {
            // Access denied notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: linear-gradient(135deg, #1a1f35 0%, #0f1419 100%);
              border: 1px solid rgba(239, 68, 68, 0.5);
              border-radius: 16px;
              padding: 32px;
              max-width: 400px;
              box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
              z-index: 99999999;
              text-align: center;
              animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            `;
            errorOverlay.innerHTML = `
              <div style="font-size: 48px; margin-bottom: 16px;">‚õî</div>
              <h3 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 600; color: #ef4444; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                Access Denied
              </h3>
              <p style="margin: 0 0 16px 0; color: rgba(255,255,255,0.85); font-size: 15px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                Admin Only
              </p>
              <p style="margin: 0; color: rgba(255,255,255,0.6); font-size: 14px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                Redirecting to student portal...
              </p>
            `;
            document.body.appendChild(errorOverlay);
            
            setTimeout(() => {
              window.location.href = 'student-portal.html';
            }, 2000);
            return false;
          }

          const { data: adminAccount, error: adminError } = await supabaseClient
            .from('admin_accounts')
            .select('*')
            .eq('auth_user_id', session.user.id)
            .single();

          if (adminError || !adminAccount) {
            // Access denied notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: linear-gradient(135deg, #1a1f35 0%, #0f1419 100%);
              border: 1px solid rgba(239, 68, 68, 0.5);
              border-radius: 16px;
              padding: 32px;
              max-width: 400px;
              box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
              z-index: 99999999;
              text-align: center;
              animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            `;
            errorOverlay.innerHTML = `
              <div style="font-size: 48px; margin-bottom: 16px;">‚õî</div>
              <h3 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 600; color: #ef4444; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                Access Denied
              </h3>
              <p style="margin: 0 0 16px 0; color: rgba(255,255,255,0.85); font-size: 15px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                Admin Only
              </p>
              <p style="margin: 0; color: rgba(255,255,255,0.6); font-size: 14px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                Redirecting to student portal...
              </p>
            `;
            document.body.appendChild(errorOverlay);
            
            setTimeout(() => {
              window.location.href = 'student-portal.html';
            }, 2000);
            return false;
          }

          return true;
        } catch (error) {
          console.error('‚ùå Admin auth error:', error);
          
          // Access denied notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1f35 0%, #0f1419 100%);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 99999999;
            text-align: center;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          `;
          errorOverlay.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 16px;">‚õî</div>
            <h3 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 600; color: #ef4444; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
              Access Denied
            </h3>
            <p style="margin: 0; color: rgba(255,255,255,0.85); font-size: 15px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
              Admin Only
            </p>
          `;
          document.body.appendChild(errorOverlay);
          
          setTimeout(() => {
            window.location.href = 'student-portal.html';
          }, 2000);
          return false;
        }
      }

      // ============================================================
      // üìä DATA MANAGEMENT
      // ============================================================
      
  const LA_TIMEZONE = 'America/Los_Angeles';
  window.CALENDAR_DEBUG = false; // Set to true in console to debug specific students
  const DEBUG_STUDENT_NAME = 'sona husikyan';
  const DEBUG_TARGET_DATE = '2026-01-29'; // Focus on problematic date
      const laDateFormatter = new Intl.DateTimeFormat('en-CA', {
        timeZone: LA_TIMEZONE,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });

      function getLATodayISO() {
        return laDateFormatter.format(new Date());
      }

      function getLATodayDate() {
        const parts = laDateFormatter.formatToParts(new Date());
        const year = Number(parts.find(part => part.type === 'year')?.value);
        const month = Number(parts.find(part => part.type === 'month')?.value);
        const day = Number(parts.find(part => part.type === 'day')?.value);
        return new Date(year, month - 1, day);
      }

      function getLAWeekday(dateStr) {
        const normalized = normalizeDateString(dateStr);
        if (!normalized) return '';
        const date = new Date(`${normalized}T12:00:00Z`);
        return new Intl.DateTimeFormat('en-US', {
          timeZone: LA_TIMEZONE,
          weekday: 'long'
        }).format(date);
      }

      // Global data stores
      let currentDate = getLATodayDate();
      let studentsData = [];
      let groupsData = [];
      let paymentsData = [];
      let paymentRecordsData = [];
      let absencesData = [];
      let skippedClassesData = [];
      let creditPaymentsData = [];
      
      // Note names cache for tag search autocomplete
      window.noteNamesCache = [];

      // Performance: Cache payment matching results
      let paymentCache = new Map(); // Key: "studentId-date", Value: boolean
      
      // Performance: Pre-parsed student aliases
      let studentAliasesCache = new Map(); // Key: studentId, Value: aliases array
      let nameToStudentIds = new Map(); // Key: normalized name/alias, Value: Set(studentIds) for payment index
      
      // Performance: Indexed data structures
      let absencesByDateStudent = new Map(); // Key: "date-studentId", Value: true
      let skippedClassesByDateGroup = new Map(); // Key: "date-groupName", Value: true
      let studentsByGroup = new Map(); // Key: groupName, Value: students[] (precomputed filter)
      
      // ‚ö° PERFORMANCE: Payment index for O(1) lookups instead of O(n) scans
      // Structure: paymentIndex[date] = Set(studentIds)
      let paymentIndex = new Map(); // Key: "date", Value: Set of student IDs who paid

      function clearAllCaches() {
        // ‚ö° PERFORMANCE: Only clear payment cache on month navigation
        // Keep indexes intact - they're rebuilt on data refresh only (refresh button)
        // This preserves the O(1) lookup performance across month changes
        paymentCache.clear();
      }

      function clearPaymentCache() {
        paymentCache.clear();
      }
      
      function rebuildAllIndexes() {
        // Clear and rebuild ALL caches - used on data refresh
        paymentCache.clear();
        studentAliasesCache.clear();
        nameToStudentIds.clear();
        absencesByDateStudent.clear();
        skippedClassesByDateGroup.clear();
        studentsByGroup.clear();
        paymentIndex.clear();
        buildIndexes();
      }
      
      function buildIndexes() {
        // Pre-parse all student aliases FIRST (needed by payment index)
        studentAliasesCache.clear();
        studentsData.forEach(student => {
          let aliases = [];
          
          if (Array.isArray(student.aliases)) {
            aliases = student.aliases;
          } else if (typeof student.aliases === 'string' && student.aliases.trim()) {
            try {
              const parsed = JSON.parse(student.aliases);
              
              if (Array.isArray(parsed)) {
                aliases = parsed;
              } else {
                aliases = [];
              }
            } catch (e) {
              aliases = student.aliases.split(',').map(a => a.trim()).filter(a => a);
            }
          }
          
          studentAliasesCache.set(student.id, aliases);
        });
        
        // ‚ö° PERFORMANCE: Build name ‚Üí studentIds lookup for O(1) payment matching
        // Converts O(payments √ó students) to O(1) during payment index build
        nameToStudentIds.clear();
        studentsData.forEach(student => {
          // Add student name (use normalizeName for fuzzy matching like "Sona Husikyan")
          const normalizedName = normalizeName(student.name);
          if (normalizedName) {
            if (!nameToStudentIds.has(normalizedName)) {
              nameToStudentIds.set(normalizedName, new Set());
            }
            nameToStudentIds.get(normalizedName).add(String(student.id));
          }
          
          // Add all aliases
          const aliases = getStudentAliases(student.id);
          aliases.forEach(alias => {
            const normalizedAlias = normalizeName(alias);
            if (normalizedAlias) {
              if (!nameToStudentIds.has(normalizedAlias)) {
                nameToStudentIds.set(normalizedAlias, new Set());
              }
              nameToStudentIds.get(normalizedAlias).add(String(student.id));
            }
          });
        });
        
        // ‚ö° PERFORMANCE: Precompute students by group (avoid repeated filters)
        studentsByGroup.clear();
        studentsData.forEach(student => {
          const groupName = student.group_name;
          if (!groupName) return;
          
          if (!studentsByGroup.has(groupName)) {
            studentsByGroup.set(groupName, []);
          }
          studentsByGroup.get(groupName).push(student);
        });
        
        // Index absences for O(1) lookup
        absencesByDateStudent.clear();
        absencesData.forEach(a => {
          const date = (a.class_date || '').split('T')[0];
          const key = `${date}-${a.student_id}`;
          absencesByDateStudent.set(key, true);
        });
        
        // Index skipped classes for O(1) lookup
        skippedClassesByDateGroup.clear();
        skippedClassesData.forEach(s => {
          const date = (s.class_date || '').split('T')[0];
          const key = `${date}-${s.group_name}`;
          skippedClassesByDateGroup.set(key, true);
        });
        
        // ‚ö° PERFORMANCE: Build payment index for O(1) lookups
        paymentIndex.clear();
        
        // Index payments table
        paymentsData.forEach(p => {
          const forClassDates = extractForClassDates(p, p.date);
          forClassDates.forEach(dateStr => {
            const normalizedDate = normalizeDateString(dateStr);
            
            if (!paymentIndex.has(normalizedDate)) {
              paymentIndex.set(normalizedDate, new Set());
            }
            
            const studentIds = paymentIndex.get(normalizedDate);
            
            // Add all possible student IDs from this payment
            const paymentStudentId = p.student_id || p.linked_student_id || p.derived_student_id || 
                                    p.resolved_student_id || p.studentid || null;
            
            if (paymentStudentId) {
              studentIds.add(String(paymentStudentId));
            }
            
            // ‚ö° OPTIMIZED: Use name lookup instead of scanning all students
            // Match by payer_name, resolved_student_name, student_name
            const namesToCheck = [
              p.payer_name,
              p.resolved_student_name,
              p.student_name,
              p.student_full_name,
              p.studentname,
              p.studentNameFromMessage,
              p.studentNameHint,
              p.student_name_hint,
              p.studentName,
              p.student_display_name,
              p.student_name_display,
              p.student
            ].filter(Boolean);
            
            namesToCheck.forEach(name => {
              const normalizedName = normalizeName(name);
              if (normalizedName && nameToStudentIds.has(normalizedName)) {
                const matchedIds = nameToStudentIds.get(normalizedName);
                matchedIds.forEach(id => studentIds.add(id));
              }
            });
          });
        });
        
        // Index payment_records table
        paymentRecordsData.forEach(pr => {
          const forClassDates = extractForClassDates(pr, pr.date);
          forClassDates.forEach(dateStr => {
            const normalizedDate = normalizeDateString(dateStr);
            
            if (!paymentIndex.has(normalizedDate)) {
              paymentIndex.set(normalizedDate, new Set());
            }
            
            const studentIds = paymentIndex.get(normalizedDate);
            
            if (pr.student_id) {
              studentIds.add(String(pr.student_id));
            }
            
            // ‚ö° OPTIMIZED: Use name lookup instead of scanning all students
            const namesToCheck = [
              pr.student_name,
              pr.student_full_name,
              pr.student
            ].filter(Boolean);
            
            namesToCheck.forEach(name => {
              const normalizedName = normalizeName(name);
              if (normalizedName && nameToStudentIds.has(normalizedName)) {
                const matchedIds = nameToStudentIds.get(normalizedName);
                matchedIds.forEach(id => studentIds.add(id));
              }
            });
          });
        });

        // Index credit_payments table (applied_class_date is the date it covers)
        creditPaymentsData.forEach(cp => {
          const dateStr = (cp.applied_class_date || cp.class_date || '').split('T')[0];
          if (!dateStr) return;
          const normalizedDate = normalizeDateString(dateStr);
          if (!paymentIndex.has(normalizedDate)) {
            paymentIndex.set(normalizedDate, new Set());
          }
          if (cp.student_id) {
            paymentIndex.get(normalizedDate).add(String(cp.student_id));
          }
        });
      }
      
      function getStudentAliases(studentId) {
        return studentAliasesCache.get(studentId) || [];
      }
      
      function isAbsentCached(dateStr, studentId) {
        const key = `${dateStr}-${studentId}`;
        return absencesByDateStudent.has(key);
      }
      
      function isClassSkippedCached(dateStr, groupName) {
        const key = `${dateStr}-${groupName}`;
        return skippedClassesByDateGroup.has(key);
      }

      function hasPaymentCached(studentId, dateStr, student) {
        const cacheKey = `${studentId}-${dateStr}`;
        
        if (paymentCache.has(cacheKey)) {
          return paymentCache.get(cacheKey);
        }

        const normalizedDateStr = normalizeDateString(dateStr);
        
        // ‚ö° OPTIMIZED: Use payment index for O(1) lookup instead of O(n) scan
        const hasPayment = paymentIndex.has(normalizedDateStr) && 
                          paymentIndex.get(normalizedDateStr).has(String(studentId));
        
        // Check if payment is manual (from payment_records table with payment_method='cash')
        let isManual = false;
        let isCredit = false;
        if (hasPayment) {
          const manualPayment = paymentRecordsData.find(pr => 
            String(pr.student_id) === String(studentId) && 
            normalizeDateString(pr.date) === normalizedDateStr &&
            pr.payment_method === 'cash'
          );
          isManual = !!manualPayment;

          if (!isManual) {
            const creditPayment = creditPaymentsData.find(cp =>
              String(cp.student_id) === String(studentId) &&
              normalizeDateString(cp.applied_class_date || cp.class_date) === normalizedDateStr
            );
            isCredit = !!creditPayment;
          }
        }
        
        const result = { hasPayment, isManual, isCredit };
        paymentCache.set(cacheKey, result);
        return result;
      }

      // Active filters
      const filters = {
        classes: true,
        payments: true,
        absences: true,
        skipped: true
      };

      // Month names
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];

      // ============================================================
      // üîÑ DATA LOADING FUNCTIONS
      // ============================================================

      async function loadStudents() {
        try {
          const { data, error } = await supabaseClient
            .from('students')
            .select('*')
            .order('name', { ascending: true });

          if (error) throw error;
          studentsData = data || [];
          
          return studentsData;
        } catch (error) {
          console.error('‚ùå Error loading students:', error);
          return [];
        }
      }

      async function loadGroups() {
        try {
          const { data, error } = await supabaseClient
            .from('groups')
            .select('*')
            .eq('active', true)
            .order('group_name', { ascending: true });

          if (error) throw error;
          groupsData = data || [];
          return groupsData;
        } catch (error) {
          console.error('‚ùå Error loading groups:', error);
          return [];
        }
      }

      async function loadPayments() {
        try {
          const { data, error } = await supabaseClient
            .from('payments')
            .select('*')
            .order('date', { ascending: false });

          if (error) throw error;
          paymentsData = data || [];
          
          return paymentsData;
        } catch (error) {
          console.error('‚ùå Error loading payments:', error);
          console.error('Supabase client exists:', !!supabaseClient);
          console.error('Error details:', error.message, error.code, error.details);
          return [];
        }
      }

      async function loadPaymentRecords() {
        try {
          const { data, error } = await supabaseClient
            .from('payment_records')
            .select('*')
            .eq('status', 'paid')
            .order('date', { ascending: false });

          if (error) throw error;
          paymentRecordsData = data || [];
          
          return paymentRecordsData;
        } catch (error) {
          console.error('‚ùå Error loading payment records:', error);
          return [];
        }
      }

      async function loadAbsences() {
        try {
          const { data, error } = await supabaseClient
            .from('student_absences')
            .select('*')
            .order('class_date', { ascending: false });

          if (error) throw error;
          absencesData = data || [];
          return absencesData;
        } catch (error) {
          console.error('‚ùå Error loading absences:', error);
          return [];
        }
      }

      async function loadSkippedClasses() {
        try {
          const { data, error } = await supabaseClient
            .from('skipped_classes')
            .select('*')
            .order('class_date', { ascending: false });

          if (error) throw error;
          skippedClassesData = data || [];
          return skippedClassesData;
        } catch (error) {
          console.error('‚ùå Error loading skipped classes:', error);
          return [];
        }
      }

      async function loadCreditPayments() {
        try {
          const { data, error } = await supabaseClient
            .from('credit_payments')
            .select('*')
            .order('created_at', { ascending: false });

          if (error) throw error;
          creditPaymentsData = data || [];
          return creditPaymentsData;
        } catch (error) {
          console.error('‚ùå Error loading credit payments:', error);
          return [];
        }
      }

      // Load note names for tag autocomplete
      async function loadNoteNames() {
        try {
          const { data, error } = await supabaseClient
            .from('student_notes')
            .select('title')
            .order('title');
          
          if (error) {
            console.error('‚ùå Error loading note names:', error);
            return;
          }
          
          window.noteNamesCache = data.map(note => note.title).filter(Boolean);
        } catch (err) {
          console.error('‚ùå Error loading note names:', err);
        }
      }

      async function loadAllData() {
        const loadingEl = document.createElement('div');
        loadingEl.className = 'loading';
        loadingEl.innerHTML = '<div class="spinner"></div> <span style="margin-left: 15px;">Loading calendar data...</span>';
        
        const grid = document.getElementById('calendarGrid');
        const originalContent = grid.innerHTML;
        grid.innerHTML = '';
        grid.appendChild(loadingEl);

        try {
          await Promise.all([
            loadStudents(),
            loadGroups(),
            loadPayments(),
            loadPaymentRecords(),
            loadAbsences(),
            loadSkippedClasses(),
            loadCreditPayments(),
            loadNoteNames() // Load note names for tag autocomplete
          ]);

          // Build indexes for optimized lookups
          buildIndexes();
        } catch (error) {
          console.error('‚ùå Error loading data:', error);
          
          // Error notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = '‚ùå Failed to load calendar data. Please refresh the page.';
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 5000);
        } finally {
          grid.innerHTML = originalContent;
        }
      }

      // ============================================================
      // üìÖ CALENDAR RENDERING
      // ============================================================

      // Parse schedule string (e.g., "Mon 8:00 PM, Wed 8:00 PM")
      function parseScheduleString(scheduleStr) {
        if (!scheduleStr || typeof scheduleStr !== 'string') return [];
        
        const rawInput = scheduleStr.trim();
        if (!rawInput || /^[-‚Äì‚Äî]+$/.test(rawInput) || /^(?:n[\/\.\s]?a|none|null|tbd|tba)$/i.test(rawInput)) {
          return [];
        }

        const sessions = [];
        const normalizedSchedule = rawInput
          .replace(/\s*;\s*/g, ',')
          .replace(/\s+/g, ' ');
          
        const parts = normalizedSchedule.split(',').map(p => p.trim()).filter(Boolean);
        if (!parts.length) return [];

        const normalizeDay = day => {
          if (!day) return '';
          const cleaned = day.trim().toLowerCase().replace(/[^a-z]/g, '');
          const map = {
            sun: 'Sunday', sunday: 'Sunday',
            mon: 'Monday', monday: 'Monday',
            tue: 'Tuesday', tues: 'Tuesday', tuesday: 'Tuesday',
            wed: 'Wednesday', weds: 'Wednesday', wednesday: 'Wednesday',
            thu: 'Thursday', thur: 'Thursday', thurs: 'Thursday', thursday: 'Thursday',
            fri: 'Friday', friday: 'Friday',
            sat: 'Saturday', saturday: 'Saturday',
          };
          return map[cleaned] || '';
        };

        parts.forEach(part => {
          const match = part.match(/^([A-Za-z/]+)\s+(.+)$/);
          if (!match) return;

          const daySegment = match[1];
          const timeSegment = match[2];

          daySegment.split('/').forEach(day => {
            const fullDay = normalizeDay(day);
            if (fullDay) {
              sessions.push({ day: fullDay, time: timeSegment });
            }
          });
        });

        return sessions;
      }

      // Check if a date matches a group's schedule
      function isScheduledClassDate(dateStr, group) {
        if (!group || !group.schedule) return false;
        
        const sessions = parseScheduleString(group.schedule);
        if (sessions.length === 0) return false;

        const dayName = getLAWeekday(dateStr);

        return sessions.some(session => session.day === dayName);
      }

      // Check if a class is skipped/canceled
      function isClassSkipped(dateStr, groupName) {
        return skippedClassesData.some(skip => {
          const skipDate = skip.class_date?.split('T')[0] || skip.class_date;
          return skipDate === dateStr && skip.group_name === groupName;
        });
      }

      function normalizeDateString(value) {
        if (!value) return '';

        if (value instanceof Date) {
          return value.toISOString().split('T')[0];
        }

        if (typeof value === 'number' && Number.isFinite(value)) {
          const millis = value > 1e12 ? value : value * 1000;
          return new Date(millis).toISOString().split('T')[0];
        }

        const raw = String(value).trim();
        if (!raw) return '';

        if (/^\d{10,}$/.test(raw)) {
          const numericValue = Number(raw);
          if (Number.isFinite(numericValue)) {
            const millis = raw.length >= 13 ? numericValue : numericValue * 1000;
            return new Date(millis).toISOString().split('T')[0];
          }
        }

        const datePart = raw.split('T')[0];
        const separator = datePart.includes('/') ? '/' : '-';
        const parts = datePart.split(separator).map(part => part.trim());

        if (parts.length !== 3) return datePart;

        if (parts[0].length === 4) {
          return `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
        }

        if (parts[2].length === 4) {
          return `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
        }

        return datePart;
      }

      function normalizeName(value) {
        return String(value || '')
          .toLowerCase()
          .replace(/[.,'"()]/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      }

      function namesMatch(nameA, nameB) {
        const normalizedA = normalizeName(nameA);
        const normalizedB = normalizeName(nameB);

        if (!normalizedA || !normalizedB) return false;
        if (normalizedA === normalizedB) return true;

        const tokensA = normalizedA.match(/[a-z0-9]+/g) || [];
        const tokensB = normalizedB.match(/[a-z0-9]+/g) || [];

        if (tokensA.length === 0 || tokensB.length === 0) return false;

        const [shorter, longer] = tokensA.length <= tokensB.length
          ? [tokensA, tokensB]
          : [tokensB, tokensA];

        return shorter.every(token => longer.includes(token));
      }

      function isDebugStudent(studentName) {
        return normalizeName(studentName) === DEBUG_STUDENT_NAME;
      }

      function shouldDebugStudent(studentName, dateStr) {
        if (!window.CALENDAR_DEBUG || !isDebugStudent(studentName)) return false;
        if (!DEBUG_TARGET_DATE) return true;
        return normalizeDateString(dateStr) === DEBUG_TARGET_DATE;
      }

      function extractForClassDates(record, fallbackDate) {
        if (!record) return [];

        let rawDates = record.for_class_dates ?? record.for_class ?? [];

        // CRITICAL: Handle PostgreSQL array notation like {value1,value2}
        if (typeof rawDates === 'string') {
          const trimmed = rawDates.trim();
          if (!trimmed || trimmed === '[]' || trimmed === '{}' || trimmed === 'null') {
            rawDates = [];
          } else if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
            // PostgreSQL array format: {2026-01-29,2026-02-05}
            const inner = trimmed.slice(1, -1);
            rawDates = inner.split(',').map(d => d.trim()).filter(d => d && d !== 'null');
          } else {
            try {
              rawDates = JSON.parse(trimmed);
            } catch (e) {
              rawDates = trimmed.split(',').map(d => d.trim());
            }
          }
        }

        // Handle non-array objects
        if (rawDates && !Array.isArray(rawDates) && typeof rawDates === 'object') {
          rawDates = Object.values(rawDates);
        }

        // Ensure we have an array at this point
        if (!Array.isArray(rawDates)) {
          rawDates = rawDates ? [rawDates] : [];
        }

        const normalizedDates = rawDates
          .map(entry => {
            // Skip null/undefined/empty
            if (!entry || entry === 'null' || entry === 'NULL') return '';
            
            // Handle nested objects
            if (typeof entry === 'object') {
              return entry.class_date || entry.date || entry.for_class || entry.classDate || entry.value || '';
            }
            
            // Handle direct values
            return String(entry).trim();
          })
          .map(entry => normalizeDateString(entry))
          .filter(Boolean); // Remove empty strings

        // Fallback to payment date if no for_class dates exist
        if (normalizedDates.length === 0 && fallbackDate) {
          const fallback = normalizeDateString(fallbackDate);
          return fallback ? [fallback] : [];
        }

        return normalizedDates;
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // Update header
        document.getElementById('currentMonth').textContent = monthNames[month];
        document.getElementById('currentYear').textContent = year;

        // Get first day of month and total days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        const grid = document.getElementById('calendarGrid');
        
        // Clear existing days (keep headers)
        while (grid.children.length > 7) {
          grid.removeChild(grid.lastChild);
        }

        // Add previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
          const day = daysInPrevMonth - i;
          const cell = createDayCell(day, true);
          grid.appendChild(cell);
        }

        // Add current month days
  const today = getLATodayDate();
  const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

        for (let day = 1; day <= daysInMonth; day++) {
          const isToday = isCurrentMonth && today.getDate() === day;
          const cell = createDayCell(day, false, isToday, year, month);
          grid.appendChild(cell);
        }

        // Add next month days to fill grid
        const totalCells = firstDay + daysInMonth;
        const remainingCells = 42 - totalCells; // 6 rows √ó 7 days
        for (let day = 1; day <= remainingCells; day++) {
          const cell = createDayCell(day, true);
          grid.appendChild(cell);
        }

        updateStats();
      }

      function createDayCell(day, isOtherMonth, isToday = false, year = null, month = null) {
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        
        if (isOtherMonth) {
          cell.classList.add('other-month');
        }
        if (isToday) {
          cell.classList.add('today');
        }

        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        cell.appendChild(dayNumber);

        if (!isOtherMonth && year !== null && month !== null) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          cell.dataset.date = dateStr;

          // Calculate paid/unpaid totals for this day
          let paidTotal = 0;
          let unpaidTotal = 0;
          const today = getLATodayISO();

          groupsData.forEach(group => {
            if (isScheduledClassDate(dateStr, group) && !isClassSkippedCached(dateStr, group.group_name)) {
              studentsData.forEach(student => {
                if (student.group_name === group.group_name && student.show_in_grid !== false) {
                  // IMPORTANT: Only count classes after student's creation date
                  if (student.created_at) {
                    const studentCreatedDate = new Date(student.created_at).toISOString().split('T')[0];
                    if (dateStr < studentCreatedDate) {
                      return; // Skip this student for dates before creation
                    }
                  }
                  
                  const paymentInfo = hasPaymentCached(student.id, dateStr, student);
                  const isAbsent = isAbsentCached(dateStr, student.id);
                  const pricePerClass = parseFloat(student.price_per_class || 0);
                  
                  if (paymentInfo.hasPayment) {
                    paidTotal += pricePerClass;
                  } else if (!isAbsent && dateStr <= today) {
                    unpaidTotal += pricePerClass;
                  }
                }
              });
            }
          });

          // Add payment summary if there are amounts
          if (paidTotal > 0 || unpaidTotal > 0) {
            const paymentSummary = document.createElement('div');
            paymentSummary.className = 'day-payment-summary';

            // Paid amount
            const paidSpan = document.createElement('span');
            paidSpan.className = 'day-payment-paid';
            paidSpan.textContent = `${formatCurrency(paidTotal)} $`;
            paymentSummary.appendChild(paidSpan);

            // Divider
            const divider = document.createElement('span');
            divider.className = 'day-payment-divider';
            divider.textContent = '/';
            paymentSummary.appendChild(divider);

            // Unpaid amount
            const unpaidSpan = document.createElement('span');
            unpaidSpan.className = 'day-payment-unpaid';
            unpaidSpan.textContent = `${formatCurrency(unpaidTotal)} $`;
            paymentSummary.appendChild(unpaidSpan);

            cell.appendChild(paymentSummary);
          }

          // Add dots based on data
          const dots = createDots(dateStr);
          if (dots) {
            cell.appendChild(dots);
          }

          // Add click handler
          cell.addEventListener('click', () => openDayModal(dateStr));
        }

        return cell;
      }

      function createDots(dateStr) {
        const container = document.createElement('div');
        container.className = 'day-dots';

        const normalizedCellDate = normalizeDateString(dateStr);

        const events = [];

        // üé® GRAY DOTS - Scheduled classes from Group Manager
        groupsData.forEach(group => {
          if (isScheduledClassDate(dateStr, group)) {
            // Check if class is skipped/canceled using cached lookup
            const isSkipped = isClassSkippedCached(dateStr, group.group_name);
            
            // ‚ö° OPTIMIZED: Use precomputed studentsByGroup instead of filtering every time
            const groupStudents = (studentsByGroup.get(group.group_name) || [])
              .filter(s => s.show_in_grid !== false);

            // Add a dot for each active student in the scheduled class
            groupStudents.forEach(student => {
              // IMPORTANT: Only show classes after student's creation date
              if (student.created_at) {
                const studentCreatedDate = new Date(student.created_at).toISOString().split('T')[0];
                if (dateStr < studentCreatedDate) {
                  return; // Skip this student for dates before creation
                }
              }
              
              // Get pre-parsed aliases from cache
              const aliases = getStudentAliases(student.id);

              const normalizedSearch = searchQuery.trim();
              const matchesSearch = !normalizedSearch ||
                student.name.toLowerCase().includes(normalizedSearch) ||
                aliases.some(alias => String(alias).toLowerCase().includes(normalizedSearch));

              if (!matchesSearch) {
                return;
              }

              // Check payment status using cached function
              const paymentInfo = hasPaymentCached(student.id, dateStr, student);

              // Check absence using indexed lookup
              const isAbsent = isAbsentCached(dateStr, student.id);

              // Determine dot type and label
              let dotType = 'gray'; // Default scheduled class
              let dotLabel = `${group.group_name}: ${student.name}`;

              if (isSkipped) {
                dotType = 'canceled';
                dotLabel += ' (Canceled)';
              } else if (isAbsent) {
                dotType = 'absent';
                dotLabel += ' (Absent)';
              } else if (paymentInfo.hasPayment) {
                // Gold for credit, blue for cash, green for automated payments
                if (paymentInfo.isCredit) {
                  dotType = 'credit';
                  dotLabel += ' (Credit)';
                } else if (paymentInfo.isManual) {
                  dotType = 'manual';
                  dotLabel += ' (Cash Payment)';
                } else {
                  dotType = 'paid';
                  dotLabel += ' (Paid)';
                }
              } else if (dateStr <= getLATodayISO()) {
                dotType = 'unpaid';
                dotLabel += ' (Unpaid)';
              }

              events.push({
                type: dotType,
                label: dotLabel,
                studentName: student.name,
                groupName: group.group_name,
                classDate: dateStr,
                studentId: student.id,
                price: student.price_per_class || 0,
                balance: student.balance || 0
              });
            });
          }
        });

        // Group events by group name
        const eventsByGroup = {};
        events.forEach(event => {
          const groupKey = event.groupName || 'Other';
          if (!eventsByGroup[groupKey]) {
            eventsByGroup[groupKey] = [];
          }
          eventsByGroup[groupKey].push(event);
        });

        // Sort groups alphabetically
        const sortedGroups = Object.keys(eventsByGroup).sort();

        // Build grouped display with separators
        if (sortedGroups.length > 0) {
          sortedGroups.forEach((groupName, index) => {
            const groupEvents = eventsByGroup[groupName];
            
            // Create group row container
            const groupRow = document.createElement('div');
            groupRow.className = 'group-row';

            // Add group label (e.g., "A:")
            const label = document.createElement('div');
            label.className = 'group-label';
            label.textContent = `${groupName}:`;
            groupRow.appendChild(label);

            // Add dots container for this group
            const dotsContainer = document.createElement('div');
            dotsContainer.className = 'group-dots-container';

            groupEvents.forEach(event => {
              const dot = document.createElement('div');
              dot.className = `indicator-dot dot-${event.type}`;
              dot.title = event.label;
              
              // Store student data for modal
              dot.dataset.studentData = JSON.stringify({
                studentName: event.studentName,
                groupName: event.groupName,
                classDate: event.classDate,
                studentId: event.studentId,
                price: event.price,
                balance: event.balance,
                status: event.type
              });
              
              // Add click handler to open student modal
              dot.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent day modal from opening
                openStudentModal(JSON.parse(dot.dataset.studentData));
              });
              
              dotsContainer.appendChild(dot);
            });

            groupRow.appendChild(dotsContainer);
            container.appendChild(groupRow);

            // Add separator between groups (but not after the last group)
            if (index < sortedGroups.length - 1) {
              const separator = document.createElement('div');
              separator.className = 'group-separator';
              container.appendChild(separator);
            }
          });
        }

        return container.children.length > 0 ? container : null;
      }

      // ============================================================
      // üìä STATS UPDATE
      // ============================================================

      // Format currency with thousand separators
      function formatCurrency(amount) {
        const num = Math.round(amount);
        return num.toLocaleString('en-US');
      }

      function updateStats() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        let classCount = 0; // Count of CLASSES (not student enrollments)
        let paidTotal = 0;
        let unpaidTotal = 0;
        let absenceCount = 0;
        let canceledCount = 0;

        // Clear payment cache before recalculating
        clearPaymentCache();

        // Count scheduled classes for the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          
          groupsData.forEach(group => {
            if (isScheduledClassDate(dateStr, group)) {
              // Count the CLASS itself (not each student)
              const isSkipped = isClassSkippedCached(dateStr, group.group_name);
              
              if (isSkipped) {
                canceledCount++; // Count canceled classes (not student enrollments)
              } else {
                classCount++; // Count scheduled classes (not student enrollments)
              }
            }
          });
        }

        // Calculate paid/unpaid totals
        const today = getLATodayISO();
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          
          groupsData.forEach(group => {
            if (isScheduledClassDate(dateStr, group) && !isClassSkippedCached(dateStr, group.group_name)) {
              studentsData.forEach(student => {
                if (student.group_name === group.group_name && student.show_in_grid !== false) {
                  // IMPORTANT: Only count classes after student's creation date
                  if (student.created_at) {
                    const studentCreatedDate = new Date(student.created_at).toISOString().split('T')[0];
                    if (dateStr < studentCreatedDate) {
                      return; // Skip this student for dates before creation
                    }
                  }
                  
                  const paymentInfo = hasPaymentCached(student.id, dateStr, student);
                  
                  if (paymentInfo.hasPayment) {
                    paidTotal += parseFloat(student.price_per_class || 0);
                  } else if (dateStr <= today) {
                    // Only count unpaid for past/today dates - using cached lookup for performance
                    const isAbsent = isAbsentCached(dateStr, student.id);
                    
                    if (!isAbsent) {
                      unpaidTotal += parseFloat(student.price_per_class || 0);
                    }
                  }
                }
              });
            }
          });
        }

        // Count absences for current month
        absenceCount = absencesData.filter(a => {
          const absenceDate = (a.class_date || '').split('T')[0];
          return absenceDate.startsWith(monthStr);
        }).length;

        // Update UI
        document.getElementById('statClasses').textContent = classCount;
        document.getElementById('statPaid').textContent = `${formatCurrency(paidTotal)} $`;
        document.getElementById('statUnpaid').textContent = `${formatCurrency(unpaidTotal)} $`;
        document.getElementById('statAbsences').textContent = absenceCount;
        document.getElementById('statCanceled').textContent = canceledCount;
      }

      // ============================================================
      // üéØ MODAL FUNCTIONS
      // ============================================================

      function openDayModal(dateStr) {
        const modal = document.getElementById('dayModal');
        const modalDate = document.getElementById('modalDate');
        const modalBody = document.getElementById('modalBody');

        // Store current modal date for navigation
        currentModalDate = dateStr;

        // Format the date for display
        const dateObj = new Date(dateStr + 'T12:00:00');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = dateObj.toLocaleDateString('en-US', options);
        
        modalDate.textContent = formattedDate;

        // Get all students who have classes on this date
        const studentsOnDate = [];
        
        studentsData.forEach(student => {
          if (!student.show_in_grid || !student.group_name) return;
          
          const group = groupsData.find(g => g.group_name === student.group_name);
          if (!group) return;
          
          // Check if this group has class on this date
          if (isScheduledClassDate(dateStr, group)) {
            // IMPORTANT: Only show classes after student's creation date
            if (student.created_at) {
              const studentCreatedDate = new Date(student.created_at).toISOString().split('T')[0];
              if (dateStr < studentCreatedDate) {
                // Don't show this student for classes before they were created
                return;
              }
            }
            
            // Check payment status
            const paymentInfo = hasPaymentCached(student.id, dateStr, student);
            const hasAbsence = isAbsentCached(dateStr, student.id);
            const isSkipped = isClassSkippedCached(dateStr, group.group_name);
            
            let status = 'upcoming';
            if (isSkipped) {
              status = 'canceled';
            } else if (hasAbsence) {
              status = 'absent';
            } else if (paymentInfo.hasPayment) {
              status = 'paid';
            } else {
              status = 'unpaid';
            }
            
            studentsOnDate.push({
              ...student,
              groupName: group.group_name,
              status: status,
              hasPayment: paymentInfo.hasPayment,
              isManualCashPayment: paymentInfo.isManual,
              isCreditPayment: paymentInfo.isCredit,
              hasAbsence: hasAbsence,
              isSkipped: isSkipped
            });
          }
        });

        // Group students by their group_name
        const groupedStudents = {};
        studentsOnDate.forEach(student => {
          if (!groupedStudents[student.groupName]) {
            groupedStudents[student.groupName] = [];
          }
          groupedStudents[student.groupName].push(student);
        });

        // Build tabs and content
        let tabsHtml = '';
        let tabPanelsHtml = '';
        
        if (studentsOnDate.length === 0) {
          modalBody.innerHTML = `
            <div class="modal-tab-content">
              <div style="padding: 40px 20px; text-align: center; color: rgba(255,255,255,0.5);">
                <div style="font-size: 48px; margin-bottom: 10px;">üìÖ</div>
                <div style="font-size: 16px;">No classes scheduled for this date</div>
              </div>
            </div>
          `;
          modal.classList.add('active');
          return;
        }

        // Create "Unpaid" tab first
        const unpaidStudents = studentsOnDate.filter(s => s.status === 'unpaid');
        tabsHtml += `<div class="modal-tab active" onclick="switchModalTab(event, 'unpaid')">Unpaid (${unpaidStudents.length})</div>`;
        
        let unpaidContent = '';
        if (unpaidStudents.length > 0) {
          unpaidContent = unpaidStudents.map(student => {
            const studentBalance = parseFloat(student.balance || 0);
            const pricePerClass = parseFloat(student.price_per_class || 0);
            const safeName = student.name.replace(/'/g, "\\'");
            
            // Build action buttons for unpaid students
            let actionButtons = `
              <div class="student-actions">
                <button class="action-icon-btn send"
                        data-tooltip="Send Email"
                        onclick="event.stopPropagation(); sendManualReminder(${student.id}, '${safeName}', '${dateStr}', ${pricePerClass})">
                  <span class="btn-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                  </span>
                </button>
                <button class="action-icon-btn mark-paid"
                        data-tooltip="Cash Payment"
                        onclick="event.stopPropagation(); markPaidManually(${student.id}, '${dateStr}', ${pricePerClass}, '${safeName}')">
                  <span class="btn-icon">üíµ</span>
                </button>
                ${studentBalance >= pricePerClass && pricePerClass > 0 ? `
                  <button class="action-icon-btn credit"
                          data-tooltip="Use Credit"
                          onclick="event.stopPropagation(); applyFromCredit(${student.id}, '${dateStr}', ${pricePerClass})">
                    <span class="btn-icon">üí≥</span>
                  </button>
                ` : ''}
                <button class="action-icon-btn absent"
                        data-tooltip="Mark Absent"
                        onclick="event.stopPropagation(); markAbsent(${student.id}, '${dateStr}')">
                  <span class="btn-icon">üö´</span>
                </button>
              </div>
            `;
            
            return `
              <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease;" onclick='openStudentModal({studentId: ${student.id}, classDate: "${dateStr}", studentName: "${safeName}", groupName: "${student.groupName}", balance: ${student.balance || 0}, status: "${student.status}"})' onmouseover="this.style.background='rgba(255,255,255,0.06)'; this.style.borderColor='rgba(102,126,234,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.03)'; this.style.borderColor='rgba(255,255,255,0.1)'">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                  <div style="flex: 1; min-width: 0;">
                    <div style="color: white; font-weight: 500; margin-bottom: 4px;">${student.name}</div>
                    <div style="color: rgba(255,255,255,0.5); font-size: 12px;">Group ${student.groupName} ‚Ä¢ Owes: $${pricePerClass} ‚Ä¢ Credit: $${student.balance || 0}</div>
                  </div>
                  ${actionButtons}
                  <div style="padding: 6px 12px; background: rgba(248,113,113,0.2); border: 1px solid rgba(248,113,113,0.5); border-radius: 8px; color: #f87171; font-size: 11px; font-weight: 600; letter-spacing: 0.5px;">UNPAID</div>
                </div>
              </div>
            `;
          }).join('');
        } else {
          unpaidContent = `
            <div style="padding: 40px 20px; text-align: center; color: rgba(255,255,255,0.5);">
              <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
              <div style="font-size: 16px;">All students are paid! üéâ</div>
            </div>
          `;
        }
        
        tabPanelsHtml += `<div class="tab-panel active" data-tab="unpaid">${unpaidContent}</div>`;

        // Create tabs for each group
        let groupIndex = 0;
        for (const groupName in groupedStudents) {
          const groupStudents = groupedStudents[groupName];
          const tabId = `group-${groupIndex}`;
          const searchId = `tag-search-${groupIndex}`;
          const resultsId = `tag-results-${groupIndex}`;
          const tagsId = `tags-${groupName}-${dateStr}`;
          
          tabsHtml += `<div class="modal-tab" onclick="switchModalTab(event, '${tabId}')">${groupName} (${groupStudents.length})</div>`;
          
          const studentsHtml = groupStudents.map(student => {
            let statusBadge = '';
            let statusColor = '';
            let statusBg = '';
            let statusBorder = '';
            
            if (student.status === 'paid') {
              if (student.isCreditPayment) {
                statusBadge = 'CREDIT';
                statusColor = '#fbbf24';
                statusBg = 'rgba(251,191,36,0.2)';
                statusBorder = 'rgba(251,191,36,0.5)';
              } else if (student.isManualCashPayment) {
                statusBadge = 'CASH';
                statusColor = '#60a5fa';
                statusBg = 'rgba(96,165,250,0.2)';
                statusBorder = 'rgba(96,165,250,0.5)';
              } else {
                statusBadge = 'PAID';
                statusColor = '#4ade80';
                statusBg = 'rgba(74,222,128,0.2)';
                statusBorder = 'rgba(74,222,128,0.5)';
              }
            } else if (student.status === 'unpaid') {
              statusBadge = 'UNPAID';
              statusColor = '#f87171';
              statusBg = 'rgba(248,113,113,0.2)';
              statusBorder = 'rgba(248,113,113,0.5)';
            } else if (student.status === 'absent') {
              statusBadge = 'ABSENT';
              statusColor = '#fbbf24';
              statusBg = 'rgba(251,191,36,0.2)';
              statusBorder = 'rgba(251,191,36,0.5)';
            } else if (student.status === 'canceled') {
              statusBadge = 'CANCELED';
              statusColor = '#94a3b8';
              statusBg = 'rgba(148,163,184,0.2)';
              statusBorder = 'rgba(148,163,184,0.5)';
            }
            
            // Build action buttons based on status
            let actionButtons = '';
            const studentBalance = parseFloat(student.balance || 0);
            const pricePerClass = parseFloat(student.price_per_class || 0);
            const safeName = student.name.replace(/'/g, "\\'");
            
            if (student.status === 'absent') {
              // Unmark absent button only
              actionButtons = `
                <div class="student-actions">
                  <button class="action-icon-btn unmark"
                          data-tooltip="Unmark Absent"
                          onclick="event.stopPropagation(); unmarkAbsent(${student.id}, '${dateStr}')">
                    <span class="btn-icon">‚Ü©Ô∏è</span>
                  </button>
                </div>
              `;
            } else if (student.status === 'unpaid') {
              // Full action buttons for unpaid students
              actionButtons = `
                <div class="student-actions">
                  <button class="action-icon-btn send"
                          data-tooltip="Send Email"
                          onclick="event.stopPropagation(); sendManualReminder(${student.id}, '${safeName}', '${dateStr}', ${pricePerClass})">
                    <span class="btn-icon">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                      </svg>
                    </span>
                  </button>
                  <button class="action-icon-btn mark-paid"
                          data-tooltip="Cash Payment"
                          onclick="event.stopPropagation(); markPaidManually(${student.id}, '${dateStr}', ${pricePerClass}, '${safeName}')">
                    <span class="btn-icon">üíµ</span>
                  </button>
                  ${studentBalance >= pricePerClass && pricePerClass > 0 ? `
                    <button class="action-icon-btn credit"
                            data-tooltip="Use Credit"
                            onclick="event.stopPropagation(); applyFromCredit(${student.id}, '${dateStr}', ${pricePerClass})">
                      <span class="btn-icon">üí≥</span>
                    </button>
                  ` : ''}
                  <button class="action-icon-btn absent"
                          data-tooltip="Mark Absent"
                          onclick="event.stopPropagation(); markAbsent(${student.id}, '${dateStr}')">
                    <span class="btn-icon">üö´</span>
                  </button>
                </div>
              `;
            } else if (student.status === 'paid' && student.isManualCashPayment) {
              // Unpay button ‚Äî only for manual cash payments
              actionButtons = `
                <div class="student-actions">
                  <button class="action-icon-btn unmark"
                          data-tooltip="Unpay (remove cash payment)"
                          onclick="event.stopPropagation(); unpayManually(${student.id}, '${dateStr}', '${safeName}')">
                    <span class="btn-icon">‚Ü©Ô∏è</span>
                  </button>
                </div>
              `;
            } else if (student.status === 'paid' && student.isCreditPayment) {
              // Undo credit payment button
              actionButtons = `
                <div class="student-actions">
                  <button class="action-icon-btn unmark"
                          data-tooltip="Undo credit payment"
                          onclick="event.stopPropagation(); undoCreditPayment(${student.id}, '${dateStr}', '${safeName}', ${parseFloat(student.price_per_class || 0)})">
                    <span class="btn-icon">‚Ü©Ô∏è</span>
                  </button>
                </div>
              `;
            }
            
            return `
              <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease;" onclick='openStudentModal({studentId: ${student.id}, classDate: "${dateStr}", studentName: "${safeName}", groupName: "${student.groupName}", balance: ${student.balance || 0}, status: "${student.status}"})' onmouseover="this.style.background='rgba(255,255,255,0.06)'; this.style.borderColor='rgba(102,126,234,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.03)'; this.style.borderColor='rgba(255,255,255,0.1)'">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                  <div style="flex: 1; min-width: 0;">
                    <div style="color: white; font-weight: 500; margin-bottom: 4px;">${student.name}</div>
                    <div style="color: rgba(255,255,255,0.5); font-size: 12px;">${student.status === 'unpaid' ? `Owes: $${pricePerClass} ‚Ä¢ Credit: $${student.balance || 0}` : `Credit: $${student.balance || 0}`}</div>
                  </div>
                  ${actionButtons}
                  <div style="padding: 6px 12px; background: ${statusBg}; border: 1px solid ${statusBorder}; border-radius: 8px; color: ${statusColor}; font-size: 11px; font-weight: 600; letter-spacing: 0.5px;">${statusBadge}</div>
                </div>
              </div>
            `;
          }).join('');
          
          // Check if this group's class is skipped/canceled
          const isSkipped = isClassSkippedCached(dateStr, groupName);
          const cancelButton = isSkipped
            ? `<button class="quick-action-btn secondary" onclick="event.stopPropagation(); uncancelClass('${groupName}', '${dateStr}')" style="padding: 8px 16px; font-size: 12px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); color: #22c55e; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">‚Ü©Ô∏è Uncancel</button>`
            : `<button class="quick-action-btn tertiary" onclick="event.stopPropagation(); cancelClass('${groupName}', '${dateStr}')" style="padding: 8px 16px; font-size: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">üö´ Cancel Class</button>`;
          
          const groupContent = `
            <div class="group-section">
              <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="color: var(--accent-cyan); margin: 0; font-size: 16px;">Group ${groupName}</h3>
                ${cancelButton}
              </div>
              
              <!-- CLASS TAGS SECTION -->
              <div class="class-tags-section">
                <input 
                  class="tag-search" 
                  id="${searchId}"
                  placeholder="Search note names‚Ä¶" 
                  autocomplete="off">
                <div class="search-results" id="${resultsId}"></div>
                <div class="class-tags" id="${tagsId}">
                  <span class="tags-placeholder">No notes assigned yet</span>
                </div>
              </div>
              
              <div class="students-list">
                ${studentsHtml}
              </div>
            </div>
          `;
          
          tabPanelsHtml += `<div class="tab-panel" data-tab="${tabId}">${groupContent}</div>`;
          groupIndex++;
        }

        // Build final modal structure
        modalBody.innerHTML = `
          <div class="modal-tabs">
            ${tabsHtml}
          </div>
          <div class="modal-tab-content">
            ${tabPanelsHtml}
          </div>
        `;

        modal.classList.add('active');
        
        // Initialize tag search for each group after DOM is ready
        setTimeout(() => {
          let idx = 0;
          for (const groupName in groupedStudents) {
            const searchId = `tag-search-${idx}`;
            const resultsId = `tag-results-${idx}`;
            const tagsId = `tags-${groupName}-${dateStr}`;
            initializeTagSearch(groupName, dateStr, searchId, resultsId, tagsId);
            idx++;
          }
        }, 100);
      }

      function switchModalTab(event, tabId) {
        // Remove active class from all tabs and panels
        const tabs = document.querySelectorAll('.modal-tab');
        const panels = document.querySelectorAll('.tab-panel');
        
        tabs.forEach(tab => tab.classList.remove('active'));
        panels.forEach(panel => panel.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding panel
        event.currentTarget.classList.add('active');
        const targetPanel = document.querySelector(`[data-tab="${tabId}"]`);
        if (targetPanel) {
          targetPanel.classList.add('active');
        }
      }

      function closeDayModal() {
        document.getElementById('dayModal').classList.remove('active');
      }

      let currentModalDate = null;

      function navigateDay(direction, event) {
        if (event) {
          event.stopPropagation();
          event.preventDefault();
        }
        
        if (!currentModalDate) {
          return;
        }
        
        const [year, month, day] = currentModalDate.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        date.setDate(date.getDate() + direction);

        const newDateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        
        // Check if the new date is within the current displayed month
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        if (date.getMonth() !== currentMonth || date.getFullYear() !== currentYear) {
          // Navigate to the new month
          currentDate = new Date(date);
          renderCalendar();
        }
        
        // Open the modal for the new date (this will set currentModalDate inside openDayModal)
        openDayModal(newDateStr);
      }

      // ============================================================
      // üè∑Ô∏è NOTE TAGS FUNCTIONS
      // ============================================================

      function initializeTagSearch(groupName, dateStr, searchInputId, resultsId, tagsContainerId) {
        const searchInput = document.getElementById(searchInputId);
        const resultsContainer = document.getElementById(resultsId);
        const tagsContainer = document.getElementById(tagsContainerId);
        
        if (!searchInput || !resultsContainer || !tagsContainer) {
          console.error('‚ùå Tag elements not found:', { searchInputId, resultsId, tagsContainerId });
          return;
        }
        
        // Load existing tags
        loadTagsForGroup(groupName, dateStr, tagsContainer);
        
        // Handle search input
        searchInput.addEventListener('input', () => {
          const query = searchInput.value.toLowerCase().trim();
          resultsContainer.innerHTML = '';
          
          if (!query) {
            resultsContainer.style.display = 'none';
            return;
          }
          
          // Get existing tags to filter them out
          const existingTags = getTagsFromLocalStorage(groupName, dateStr);
          
          // Filter note names
          const filteredNotes = (window.noteNamesCache || [])
            .filter(name => 
              name.toLowerCase().includes(query) && 
              !existingTags.includes(name)
            )
            .slice(0, 10); // Limit to 10 results
          
          if (filteredNotes.length === 0) {
            resultsContainer.style.display = 'none';
            return;
          }
          
          // Display results
          filteredNotes.forEach(noteName => {
            const item = document.createElement('div');
            item.className = 'search-item';
            item.textContent = noteName;
            item.onclick = () => addTag(groupName, dateStr, noteName, tagsContainer, searchInput, resultsContainer);
            resultsContainer.appendChild(item);
          });
          
          resultsContainer.style.display = 'flex';
        });
        
        // Close results when clicking outside
        document.addEventListener('click', (e) => {
          if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
          }
        });
      }
      
      // Add a tag
      async function addTag(groupName, dateStr, noteName, tagsContainer, searchInput, resultsContainer) {
        try {
          // Save to localStorage
          const tags = getTagsFromLocalStorage(groupName, dateStr);
          if (tags.includes(noteName)) {
            return;
          }
          
          tags.push(noteName);
          saveTagsToLocalStorage(groupName, dateStr, tags);
          
          // Save to database
          const { error } = await supabaseClient
            .from('class_tags')
            .insert([{
              class_date: dateStr,
              group_name: groupName,
              note_name: noteName
            }]);
          
          if (error) {
            console.error('‚ùå Error saving tag to database:', error);
          }
          
          // Update UI
          renderTags(groupName, dateStr, tagsContainer);
          searchInput.value = '';
          resultsContainer.style.display = 'none';
          
        } catch (err) {
          console.error('‚ùå Error adding tag:', err);
        }
      }
      
      // Remove a tag
      async function removeTag(groupName, dateStr, noteName, tagsContainer) {
        try {
          // Remove from localStorage
          let tags = getTagsFromLocalStorage(groupName, dateStr);
          tags = tags.filter(t => t !== noteName);
          saveTagsToLocalStorage(groupName, dateStr, tags);
          
          // Remove from database
          const { error } = await supabaseClient
            .from('class_tags')
            .delete()
            .eq('class_date', dateStr)
            .eq('group_name', groupName)
            .eq('note_name', noteName);
          
          if (error) {
            console.error('‚ùå Error removing tag from database:', error);
          }
          
          // Update UI
          renderTags(groupName, dateStr, tagsContainer);
          
        } catch (err) {
          console.error('‚ùå Error removing tag:', err);
        }
      }
      
      // Load tags from database and localStorage
      async function loadTagsForGroup(groupName, dateStr, tagsContainer) {
        try {
          // Try to load from database first
          const { data, error } = await supabaseClient
            .from('class_tags')
            .select('note_name')
            .eq('class_date', dateStr)
            .eq('group_name', groupName);
          
          if (error) {
            console.error('‚ùå Error loading tags from database:', error);
          } else if (data && data.length > 0) {
            // Save to localStorage and render
            const tagNames = data.map(t => t.note_name);
            saveTagsToLocalStorage(groupName, dateStr, tagNames);
            renderTags(groupName, dateStr, tagsContainer);
            return;
          }
          
          // Fallback to localStorage
          renderTags(groupName, dateStr, tagsContainer);
          
        } catch (err) {
          console.error('‚ùå Error loading tags:', err);
          renderTags(groupName, dateStr, tagsContainer);
        }
      }
      
      // Render tags in the UI
      function renderTags(groupName, dateStr, tagsContainer) {
        const tags = getTagsFromLocalStorage(groupName, dateStr);
        tagsContainer.innerHTML = '';
        
        if (tags.length === 0) {
          const placeholder = document.createElement('div');
          placeholder.className = 'tags-placeholder';
          placeholder.textContent = 'No notes assigned yet';
          tagsContainer.appendChild(placeholder);
          return;
        }
        
        tags.forEach(tagName => {
          const tagEl = document.createElement('span');
          tagEl.className = 'class-tag';
          tagEl.innerHTML = `
            ${tagName}
            <span class="remove-tag" onclick="removeTag('${groupName}', '${dateStr}', '${tagName.replace(/'/g, "\\'")}', document.getElementById('tags-${groupName}-${dateStr}'))">√ó</span>
          `;
          tagsContainer.appendChild(tagEl);
        });
      }
      
      // LocalStorage helpers
      function getTagsFromLocalStorage(groupName, dateStr) {
        const key = `class-tags:${dateStr}:${groupName}`;
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : [];
      }
      
      function saveTagsToLocalStorage(groupName, dateStr, tags) {
        const key = `class-tags:${dateStr}:${groupName}`;
        localStorage.setItem(key, JSON.stringify(tags));
      }
      
      // Make functions globally available
      window.initializeTagSearch = initializeTagSearch;
      window.addTag = addTag;
      window.removeTag = removeTag;
      window.loadTagsForGroup = loadTagsForGroup;

      // ============================================================
      // üîç FILTER FUNCTIONS
      // ============================================================

      let activeStatusFilters = new Set();
      let searchQuery = '';

      function toggleStatusDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('statusFilterDropdown');
        const button = document.getElementById('statusFilterBtn');
        const rect = button.getBoundingClientRect();
        
        const isVisible = dropdown.style.opacity === '1';
        
        if (isVisible) {
          dropdown.style.opacity = '0';
          dropdown.style.visibility = 'hidden';
          dropdown.style.pointerEvents = 'none';
        } else {
          dropdown.style.left = rect.left + 'px';
          dropdown.style.top = (rect.bottom + 8) + 'px';
          dropdown.style.opacity = '1';
          dropdown.style.visibility = 'visible';
          dropdown.style.pointerEvents = 'auto';
        }
      }

      function updateStatusFilter() {
        const checkboxes = document.querySelectorAll('#statusFilterDropdown input[type="checkbox"]');
        activeStatusFilters.clear();
        
        checkboxes.forEach(checkbox => {
          if (checkbox.checked) {
            activeStatusFilters.add(checkbox.value);
          }
        });

        // Update button label
        const label = document.getElementById('statusFilterLabel');
        if (activeStatusFilters.size === 0) {
          label.textContent = 'All Statuses';
        } else if (activeStatusFilters.size === 1) {
          const status = Array.from(activeStatusFilters)[0];
          const statusLabels = {
            paid: '‚úÖ Paid',
            unpaid: '‚ùå Unpaid',
            credit: 'üí≥ Credit',
            absent: 'üö´ Absent',
            canceled: '‚≠ï Canceled',
            partial: '‚ö†Ô∏è Partial'
          };
          label.textContent = statusLabels[status] || status;
        } else {
          label.textContent = `${activeStatusFilters.size} Statuses`;
        }

        renderCalendar();
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('statusFilterDropdown');
        const button = document.getElementById('statusFilterBtn');
        if (dropdown && button && !dropdown.contains(e.target) && !button.contains(e.target)) {
          dropdown.style.opacity = '0';
          dropdown.style.visibility = 'hidden';
          dropdown.style.pointerEvents = 'none';
        }
      });

      // Student search handler with debounce
      let searchDebounceTimer = null;
      
      function handleStudentSearch() {
        const input = document.getElementById('studentSearchInput');
        const newQuery = input.value.toLowerCase();
        
        // Clear existing timer
        if (searchDebounceTimer) {
          clearTimeout(searchDebounceTimer);
        }
        
        // ‚ö° PERFORMANCE: Debounce search to prevent re-render on every keystroke
        searchDebounceTimer = setTimeout(() => {
          searchQuery = newQuery;
          renderCalendar();
        }, 250); // Wait 250ms after user stops typing
      }

      // ============================================================
      // üé¨ EVENT LISTENERS
      // ============================================================

      function attachEventListeners() {
        // Navigation
        document.getElementById('prevMonth').addEventListener('click', () => {
          currentDate.setMonth(currentDate.getMonth() - 1);
          clearAllCaches(); // Clear all caches when month changes
          renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
          currentDate.setMonth(currentDate.getMonth() + 1);
          clearAllCaches(); // Clear all caches when month changes
          renderCalendar();
        });

        document.getElementById('todayBtn').addEventListener('click', () => {
          currentDate = getLATodayDate();
          clearAllCaches(); // Clear all caches when jumping to today
          renderCalendar();
        });

        document.getElementById('refreshBtn').addEventListener('click', async () => {
          const btn = document.getElementById('refreshBtn');
          
          // Reset animation by removing and re-adding class
          btn.classList.remove('loading');
          void btn.offsetWidth; // Force reflow
          btn.classList.add('loading');
          
          // Clear all caches and indexes before data refresh (will be rebuilt in loadAllData)
          paymentCache.clear();
          studentAliasesCache.clear();
          nameToStudentIds.clear();
          absencesByDateStudent.clear();
          skippedClassesByDateGroup.clear();
          studentsByGroup.clear();
          paymentIndex.clear();
          
          await loadAllData();
          renderCalendar();
          
          // Remove loading class after animation completes
          setTimeout(() => {
            btn.classList.remove('loading');
          }, 500);
        });

        // Student search
        document.getElementById('studentSearchInput').addEventListener('input', handleStudentSearch);

        // Modal close
        document.getElementById('closeModal').addEventListener('click', closeDayModal);
        document.getElementById('dayModal').addEventListener('click', (e) => {
          if (e.target.id === 'dayModal') {
            closeDayModal();
          }
        });
      }

      // ============================================================
      // ÔøΩ STUDENT MODAL FUNCTIONS
      // ============================================================

      let currentStudentData = null;
      let allStudentsOnDate = [];
      let currentStudentIndex = 0;

      function openStudentModal(studentData) {
        // Find all students on this date
        const dateStr = studentData.classDate;
        allStudentsOnDate = [];
        
        // Collect all student data for this date from the dots
        const dayCell = document.querySelector(`[data-date="${dateStr}"]`);
        if (dayCell) {
          const dots = dayCell.querySelectorAll('.indicator-dot');
          dots.forEach(dot => {
            if (dot.dataset.studentData) {
              allStudentsOnDate.push(JSON.parse(dot.dataset.studentData));
            }
          });
        }
        
        // Find current student index
        currentStudentIndex = allStudentsOnDate.findIndex(s => 
          s.studentId === studentData.studentId
        );
        
        if (currentStudentIndex === -1) {
          currentStudentIndex = 0;
        }
        
        // Display the student
        displayStudent(currentStudentIndex);
        
        // Show modal
        document.getElementById('studentModal').style.display = 'flex';
      }

      function displayStudent(index) {
        if (index < 0 || index >= allStudentsOnDate.length) return;
        
        currentStudentIndex = index;
        currentStudentData = allStudentsOnDate[index];
        
        // Update counter
        document.getElementById('studentCounter').textContent = `${index + 1}/${allStudentsOnDate.length}`;
        
        // Populate modal
        document.getElementById('studentNameTitle').textContent = currentStudentData.studentName;
        document.getElementById('studentGroupLabel').textContent = `Group: ${currentStudentData.groupName || 'No Group'}`;
        document.getElementById('studentClassDate').textContent = new Date(currentStudentData.classDate).toLocaleDateString('en-US', { 
          timeZone: LA_TIMEZONE,
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        document.getElementById('studentPrice').textContent = formatCurrency(currentStudentData.price) + ' $';

        // Set payment status
        const statusMap = {
          paid: 'Paid',
          manual: 'Paid (Cash)',
          unpaid: 'Unpaid',
          absent: 'Absent',
          credit: 'Credit Applied',
          skipped: 'Skipped',
          gray: 'Scheduled',
          canceled: 'Canceled'
        };
        const statusValue = statusMap[currentStudentData.status] || 'Unpaid';
        const statusEl = document.getElementById('studentStatus');
        statusEl.textContent = statusValue;
        const statusColorMap = {
          paid: '#22c55e',
          manual: '#22c55e',
          unpaid: '#ef4444'
        };
        statusEl.style.color = statusColorMap[currentStudentData.status] || 'rgba(255,255,255,0.8)';
        
        // Set balance input value (just the number, formatted)
        const balanceInput = document.getElementById('studentBalance');
        balanceInput.value = formatCurrency(currentStudentData.balance) + ' $';
        balanceInput.dataset.originalValue = currentStudentData.balance;
        
        // Update navigation buttons
        document.getElementById('prevStudentBtn').disabled = (index === 0);
        document.getElementById('nextStudentBtn').disabled = (index === allStudentsOnDate.length - 1);

        // Rebuild quick actions based on payment status
        updateStudentModalActions(currentStudentData);
      }

      function updateStudentModalActions(data) {
        const container = document.getElementById('studentQuickActions');
        if (!container) return;

        const { studentId, studentName, classDate, price, balance, status } = data;
        const canApplyCredit = (parseFloat(balance) || 0) >= (parseFloat(price) || 0);

        let html = '';

        if (status === 'manual') {
          // Cash payment ‚Äî show Unpay only
          html = `
            <button class="action-btn" style="background:linear-gradient(135deg,rgba(239,68,68,0.25)0%,rgba(220,38,38,0.15)100%);border-color:rgba(239,68,68,0.4);"
              onclick="unpayManually(${studentId},'${classDate}','${studentName}')">
              <span class="action-btn-icon">‚Ü©Ô∏è</span>
              <span>Unpay</span>
            </button>`;
        } else if (status === 'credit') {
          // Credit payment ‚Äî show Undo Credit only
          html = `
            <button class="action-btn" style="background:linear-gradient(135deg,rgba(239,68,68,0.25)0%,rgba(220,38,38,0.15)100%);border-color:rgba(239,68,68,0.4);"
              onclick="undoCreditPayment(${studentId},'${classDate}','${studentName}',${price})">
              <span class="action-btn-icon">‚Ü©Ô∏è</span>
              <span>Undo Credit</span>
            </button>`;
        } else if (status === 'paid') {
          // Standard payment ‚Äî Email only
          html = `
            <button class="action-btn email" onclick="sendEmailReminder()">
              <span class="action-btn-icon">üìß</span>
              <span>Email</span>
            </button>`;
        } else if (status === 'absent') {
          // Absent ‚Äî Email only (absent actions handled in day modal)
          html = `
            <button class="action-btn email" onclick="sendEmailReminder()">
              <span class="action-btn-icon">üìß</span>
              <span>Email</span>
            </button>`;
        } else {
          // Unpaid (or gray/scheduled) ‚Äî Email, Absent, Cash Payment, Apply Credit (if balance allows)
          html = `
            <button class="action-btn email" onclick="sendEmailReminder()">
              <span class="action-btn-icon">üìß</span>
              <span>Email</span>
            </button>
            <button class="action-btn absent" onclick="markAsAbsent()">
              <span class="action-btn-icon">üö´</span>
              <span>Absent</span>
            </button>
            <button class="action-btn" style="background:linear-gradient(135deg,rgba(96,165,250,0.25)0%,rgba(59,130,246,0.15)100%);border-color:rgba(96,165,250,0.4);"
              onclick="markPaidManually(${studentId},'${classDate}',${price},'${studentName}')">
              <span class="action-btn-icon">üíµ</span>
              <span>Cash</span>
            </button>`;
          if (canApplyCredit) {
            html += `
            <button class="action-btn credit" onclick="applyFromCredit(${studentId},'${classDate}',${price})">
              <span class="action-btn-icon">üí≥</span>
              <span>Apply Credit</span>
            </button>`;
          } else {
            html += `
            <button class="action-btn credit" onclick="addCredit()">
              <span class="action-btn-icon">üí≥</span>
              <span>Add Credit</span>
            </button>`;
          }
        }

        container.innerHTML = html;
      }

      function navigateStudent(direction) {
        const newIndex = currentStudentIndex + direction;
        if (newIndex >= 0 && newIndex < allStudentsOnDate.length) {
          displayStudent(newIndex);
        }
      }

      function closeStudentModal() {
        document.getElementById('studentModal').style.display = 'none';
        currentStudentData = null;
        allStudentsOnDate = [];
        currentStudentIndex = 0;
      }

      // ============================================================
      // ‚ö° STUDENT ACTIONS (Mark Absent, Mark Paid, Apply Credit)
      // ============================================================

      async function markAbsent(studentId, dateStr) {
        try {
          const student = studentsData.find(s => s.id === studentId);
          if (!student) {
            // Error notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              color: white;
              padding: 16px 24px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
              z-index: 10000000;
              font-weight: 600;
              animation: slideInRight 0.3s ease;
            `;
            errorOverlay.textContent = '‚ùå Student not found';
            document.body.appendChild(errorOverlay);
            setTimeout(() => errorOverlay.remove(), 3000);
            return;
          }

          const confirmed = await showConfirmDialog(
            'Mark as Absent?',
            `
              <div style="text-align: left; line-height: 1.6;">
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Student:</strong> ${student.name}</div>
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Date:</strong> ${dateStr}</div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; font-size: 14px; color: rgba(255,255,255,0.85);">
                  üö´ This will mark the student as absent for this class.
                </div>
              </div>
            `
          );
          if (!confirmed) return;

          // Insert absence record
          const { error } = await supabaseClient
            .from('student_absences')
            .insert([{
              student_id: studentId,
              class_date: dateStr
            }]);

          if (error) {
            console.error('‚ùå Error marking absent:', error);
            
            // Error notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              color: white;
              padding: 16px 24px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
              z-index: 10000000;
              font-weight: 600;
              animation: slideInRight 0.3s ease;
            `;
            errorOverlay.textContent = '‚ùå Failed to mark absent. Please try again.';
            document.body.appendChild(errorOverlay);
            setTimeout(() => errorOverlay.remove(), 4000);
            return;
          }

          // Reload data and refresh
          await loadAbsences();
          
          // Refresh the calendar
          renderCalendar();
          
          // Refresh the day modal if it's still open
          if (currentModalDate === dateStr) {
            openDayModal(dateStr);
          }
          
          // Success notification
          const successOverlay = document.createElement('div');
          successOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(138, 180, 255, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          successOverlay.textContent = `‚úÖ ${student.name} marked as absent`;
          document.body.appendChild(successOverlay);
          setTimeout(() => successOverlay.remove(), 3000);
        } catch (err) {
          console.error('‚ùå Error marking absent:', err);
          
          // Error notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = '‚ùå Error marking absent. Please try again.';
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 4000);
        }
      }

      async function unmarkAbsent(studentId, dateStr) {
        try {
          const student = studentsData.find(s => s.id === studentId);
          if (!student) {
            // Error notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              color: white;
              padding: 16px 24px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
              z-index: 10000000;
              font-weight: 600;
              animation: slideInRight 0.3s ease;
            `;
            errorOverlay.textContent = '‚ùå Student not found';
            document.body.appendChild(errorOverlay);
            setTimeout(() => errorOverlay.remove(), 3000);
            return;
          }

          const confirmed = await showConfirmDialog(
            'Remove Absent Status?',
            `
              <div style="text-align: left; line-height: 1.6;">
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Student:</strong> ${student.name}</div>
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Date:</strong> ${dateStr}</div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; font-size: 14px; color: rgba(255,255,255,0.85);">
                  ‚Ü©Ô∏è This will remove the absent status for this student.
                </div>
              </div>
            `
          );
          if (!confirmed) return;

          // Delete absence record
          const { error } = await supabaseClient
            .from('student_absences')
            .delete()
            .eq('student_id', studentId)
            .eq('class_date', dateStr);

          if (error) {
            console.error('‚ùå Error unmarking absent:', error);
            
            // Error notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              color: white;
              padding: 16px 24px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
              z-index: 10000000;
              font-weight: 600;
              animation: slideInRight 0.3s ease;
            `;
            errorOverlay.textContent = '‚ùå Failed to unmark absent. Please try again.';
            document.body.appendChild(errorOverlay);
            setTimeout(() => errorOverlay.remove(), 4000);
            return;
          }

          // Reload data and refresh
          await loadAbsences();
          
          // Refresh the calendar
          renderCalendar();
          
          // Refresh the day modal if it's still open
          if (currentModalDate === dateStr) {
            openDayModal(dateStr);
          }
          
          // Success notification
          const successOverlay = document.createElement('div');
          successOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(138, 180, 255, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          successOverlay.textContent = `‚úÖ Removed absent status for ${student.name}`;
          document.body.appendChild(successOverlay);
          setTimeout(() => successOverlay.remove(), 3000);
        } catch (err) {
          console.error('‚ùå Error unmarking absent:', err);
          
          // Error notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = '‚ùå Error unmarking absent. Please try again.';
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 4000);
        }
      }

      async function markPaidManually(studentId, dateStr, pricePerClass, studentName) {
        try {
          const student = studentsData.find(s => s.id === studentId);
          if (!student) {
            // Error notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              color: white;
              padding: 16px 24px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
              z-index: 10000000;
              font-weight: 600;
              animation: slideInRight 0.3s ease;
            `;
            errorOverlay.textContent = '‚ùå Student not found';
            document.body.appendChild(errorOverlay);
            setTimeout(() => errorOverlay.remove(), 3000);
            return;
          }

          // Show custom input dialog
          const amount = await showInputDialog(
            'Cash Payment',
            `
              <div style="text-align: left; line-height: 1.6;">
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Student:</strong> ${student.name}</div>
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Date:</strong> ${dateStr}</div>
                <div style="margin-bottom: 16px; font-size: 15px;"><strong style="color: #8ab4ff;">Default Amount:</strong> $${pricePerClass}</div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(138, 180, 255, 0.1); border: 1px solid rgba(138, 180, 255, 0.3); border-radius: 8px; font-size: 14px; color: rgba(255,255,255,0.85);">
                  üíµ Enter the cash payment amount received.
                </div>
              </div>
            `,
            pricePerClass
          );
          
          if (!amount) return;

          const paymentAmount = parseFloat(amount);
          if (isNaN(paymentAmount) || paymentAmount <= 0) {
            // Error notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              color: white;
              padding: 16px 24px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
              z-index: 10000000;
              font-weight: 600;
              animation: slideInRight 0.3s ease;
            `;
            errorOverlay.textContent = '‚ùå Invalid amount';
            document.body.appendChild(errorOverlay);
            setTimeout(() => errorOverlay.remove(), 3000);
            return;
          }

          // Create payment record in payment_records table (for manual cash payments)
          const { data: insertedData, error } = await supabaseClient
            .from('payment_records')
            .insert([{
              student_id: studentId,
              date: dateStr,
              amount: paymentAmount,
              status: 'paid',
              payment_method: 'cash'
            }])
            .select();

          if (error) {
            console.error('‚ùå Error creating payment:', error);
            
            // Error notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              color: white;
              padding: 16px 24px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
              z-index: 10000000;
              font-weight: 600;
              animation: slideInRight 0.3s ease;
            `;
            errorOverlay.textContent = '‚ùå Failed to record payment. Please try again.';
            document.body.appendChild(errorOverlay);
            setTimeout(() => errorOverlay.remove(), 4000);
            return;
          }

          // Immediately add to local data
          if (insertedData && insertedData[0]) {
            paymentRecordsData.push(insertedData[0]);
          }
          
          // Immediately update payment index for this student/date
          const normalizedDate = normalizeDateString(dateStr);
          if (!paymentIndex.has(normalizedDate)) {
            paymentIndex.set(normalizedDate, new Set());
          }
          paymentIndex.get(normalizedDate).add(String(studentId));
          
          // Clear payment cache to force recalculation
          clearPaymentCache();
          
          // Reload data in background
          loadPayments().catch(console.error);
          loadPaymentRecords().catch(console.error);
          
          // Refresh the calendar (visual update)
          renderCalendar();
          
          // Refresh the day modal if it's still open
          if (currentModalDate === dateStr) {
            openDayModal(dateStr);
          }
          
          // Success notification
          const successOverlay = document.createElement('div');
          successOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(138, 180, 255, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          successOverlay.textContent = `‚úÖ Cash payment of $${paymentAmount} recorded for ${student.name}`;
          document.body.appendChild(successOverlay);
          setTimeout(() => successOverlay.remove(), 3000);
        } catch (err) {
          console.error('‚ùå Error marking paid:', err);
          
          // Error notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = '‚ùå Error recording payment. Please try again.';
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 4000);
        }
      }

      async function unpayManually(studentId, dateStr, studentName) {
        try {
          const confirmed = await showConfirmDialog(
            'Remove Cash Payment',
            `Remove the cash payment for <strong>${studentName}</strong> on <strong>${dateStr}</strong>?<br><br>This will delete the payment record and mark the student as unpaid.`
          );
          if (!confirmed) return;

          const normalizedDate = normalizeDateString(dateStr);

          // Find the cash payment record to delete
          const record = paymentRecordsData.find(pr =>
            String(pr.student_id) === String(studentId) &&
            normalizeDateString(pr.date) === normalizedDate &&
            pr.payment_method === 'cash'
          );

          if (!record) {
            const errOverlay = document.createElement('div');
            errOverlay.style.cssText = `position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 24px rgba(239,68,68,0.4);z-index:10000000;font-weight:600;animation:slideInRight 0.3s ease;`;
            errOverlay.textContent = '‚ùå Cash payment record not found.';
            document.body.appendChild(errOverlay);
            setTimeout(() => errOverlay.remove(), 3000);
            return;
          }

          const { error } = await supabaseClient
            .from('payment_records')
            .delete()
            .eq('id', record.id);

          if (error) throw error;

          // Remove from local data
          paymentRecordsData = paymentRecordsData.filter(pr => pr.id !== record.id);

          // Update payment index
          if (paymentIndex.has(normalizedDate)) {
            paymentIndex.get(normalizedDate).delete(String(studentId));
          }

          // Clear payment cache to force recalculation
          clearPaymentCache();

          // Reload data and refresh UI
          loadPayments().catch(console.error);
          loadPaymentRecords().catch(console.error);
          renderCalendar();

          if (currentModalDate === dateStr) {
            openDayModal(dateStr);
          }

          const successOverlay = document.createElement('div');
          successOverlay.style.cssText = `position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 24px rgba(245,158,11,0.4);z-index:10000000;font-weight:600;animation:slideInRight 0.3s ease;`;
          successOverlay.textContent = `‚Ü©Ô∏è Cash payment removed for ${studentName}`;
          document.body.appendChild(successOverlay);
          setTimeout(() => successOverlay.remove(), 3000);
        } catch (err) {
          console.error('‚ùå Error removing cash payment:', err);
          const errOverlay = document.createElement('div');
          errOverlay.style.cssText = `position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 24px rgba(239,68,68,0.4);z-index:10000000;font-weight:600;animation:slideInRight 0.3s ease;`;
          errOverlay.textContent = '‚ùå Failed to remove payment. Please try again.';
          document.body.appendChild(errOverlay);
          setTimeout(() => errOverlay.remove(), 4000);
        }
      }

      async function undoCreditPayment(studentId, dateStr, studentName, pricePerClass) {
        try {
          const normalizedDate = normalizeDateString(dateStr);
          const student = studentsData.find(s => s.id === studentId);
          if (!student) return;

          const confirmed = await showConfirmDialog(
            'Undo Credit Payment',
            `Remove the credit payment for <strong>${studentName}</strong> on <strong>${dateStr}</strong>?<br><br>$${pricePerClass.toFixed(2)} will be refunded back to their balance.`
          );
          if (!confirmed) return;

          // Find the credit payment record
          const record = creditPaymentsData.find(cp =>
            String(cp.student_id) === String(studentId) &&
            normalizeDateString(cp.applied_class_date || cp.class_date) === normalizedDate
          );

          if (!record) {
            const errOverlay = document.createElement('div');
            errOverlay.style.cssText = `position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 24px rgba(239,68,68,0.4);z-index:10000000;font-weight:600;animation:slideInRight 0.3s ease;`;
            errOverlay.textContent = '‚ùå Credit payment record not found.';
            document.body.appendChild(errOverlay);
            setTimeout(() => errOverlay.remove(), 3000);
            return;
          }

          // Delete the credit_payments record
          const { error: deleteError } = await supabaseClient
            .from('credit_payments')
            .delete()
            .eq('id', record.id);

          if (deleteError) throw deleteError;

          // Restore the balance
          const newBalance = parseFloat(student.balance || 0) + pricePerClass;
          const { error: updateError } = await supabaseClient
            .from('students')
            .update({ balance: newBalance })
            .eq('id', studentId);

          if (updateError) throw updateError;

          // Update local state
          student.balance = newBalance;
          creditPaymentsData = creditPaymentsData.filter(cp => cp.id !== record.id);

          // Remove from payment index
          if (paymentIndex.has(normalizedDate)) {
            paymentIndex.get(normalizedDate).delete(String(studentId));
          }

          clearPaymentCache();
          await loadCreditPayments();
          renderCalendar();

          if (currentModalDate === dateStr) {
            openDayModal(dateStr);
          }

          const successOverlay = document.createElement('div');
          successOverlay.style.cssText = `position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 24px rgba(245,158,11,0.4);z-index:10000000;font-weight:600;animation:slideInRight 0.3s ease;`;
          successOverlay.textContent = `‚Ü©Ô∏è Credit payment undone for ${studentName}. Balance restored to $${newBalance.toFixed(2)}.`;
          document.body.appendChild(successOverlay);
          setTimeout(() => successOverlay.remove(), 4000);
        } catch (err) {
          console.error('‚ùå Error undoing credit payment:', err);
          const errOverlay = document.createElement('div');
          errOverlay.style.cssText = `position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 24px rgba(239,68,68,0.4);z-index:10000000;font-weight:600;animation:slideInRight 0.3s ease;`;
          errOverlay.textContent = '‚ùå Failed to undo credit payment. Please try again.';
          document.body.appendChild(errOverlay);
          setTimeout(() => errOverlay.remove(), 4000);
        }
      }

      async function applyFromCredit(studentId, dateStr, pricePerClass) {
        try {
          const student = studentsData.find(s => s.id === studentId);
          if (!student) {
            // Error notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              color: white;
              padding: 16px 24px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
              z-index: 10000000;
              font-weight: 600;
              animation: slideInRight 0.3s ease;
            `;
            errorOverlay.textContent = '‚ùå Student not found';
            document.body.appendChild(errorOverlay);
            setTimeout(() => errorOverlay.remove(), 3000);
            return;
          }

          const currentBalance = parseFloat(student.balance || 0);
          
          if (currentBalance < pricePerClass) {
            // Insufficient credit notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              color: white;
              padding: 16px 24px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
              z-index: 10000000;
              font-weight: 600;
              animation: slideInRight 0.3s ease;
            `;
            errorOverlay.textContent = `‚ùå Insufficient credit! Need $${(pricePerClass - currentBalance).toFixed(2)} more.`;
            document.body.appendChild(errorOverlay);
            setTimeout(() => errorOverlay.remove(), 4000);
            return;
          }

          const newBalance = currentBalance - pricePerClass;
          const confirmed = await showConfirmDialog(
            'Apply Credit Payment?',
            `
              <div style="text-align: left; line-height: 1.6;">
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Student:</strong> ${student.name}</div>
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Class Price:</strong> $${pricePerClass}</div>
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Current Balance:</strong> $${currentBalance.toFixed(2)}</div>
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">New Balance:</strong> $${newBalance.toFixed(2)}</div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(138, 180, 255, 0.1); border: 1px solid rgba(138, 180, 255, 0.3); border-radius: 8px; font-size: 14px; color: rgba(255,255,255,0.85);">
                  üí≥ Credit will be deducted from student balance to pay for this class.
                </div>
              </div>
            `
          );
          
          if (!confirmed) return;

          // Update balance
          const { error: updateError } = await supabaseClient
            .from('students')
            .update({ balance: newBalance })
            .eq('id', studentId);

          if (updateError) {
            console.error('‚ùå Error updating balance:', updateError);
            
            // Error notification
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              color: white;
              padding: 16px 24px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
              z-index: 10000000;
              font-weight: 600;
              animation: slideInRight 0.3s ease;
            `;
            errorOverlay.textContent = '‚ùå Failed to update balance. Please try again.';
            document.body.appendChild(errorOverlay);
            setTimeout(() => errorOverlay.remove(), 4000);
            return;
          }

          // Create credit payment record
          const { error: creditError } = await supabaseClient
            .from('credit_payments')
            .insert([{
              student_id: studentId,
              class_date: dateStr,
              amount: pricePerClass,
              applied_class_date: dateStr
            }]);

          if (creditError) {
            console.error('‚ùå Error creating credit payment:', creditError);
            // Balance already updated, so we continue
          }

          // Update local cache
          student.balance = newBalance;
          
          // Reload data and refresh
          await loadCreditPayments();
          
          // Refresh the calendar (this rebuilds payment index)
          renderCalendar();
          
          // Clear payment cache AFTER index rebuild
          clearPaymentCache();
          
          // Refresh the day modal if it's still open
          if (currentModalDate === dateStr) {
            openDayModal(dateStr);
          }
          
          // Success notification
          const successOverlay = document.createElement('div');
          successOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(138, 180, 255, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          successOverlay.textContent = `‚úÖ Credit payment applied! New balance: $${newBalance.toFixed(2)}`;
          document.body.appendChild(successOverlay);
          setTimeout(() => successOverlay.remove(), 3000);
        } catch (err) {
          console.error('‚ùå Error applying credit:', err);
          
          // Error notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = '‚ùå Error applying credit. Please try again.';
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 4000);
        }
      }

      // ============================================================
      // üö´ CLASS CANCELLATION FUNCTIONS
      // ============================================================

      async function cancelClass(groupName, dateStr) {
        try {
          // ‚ö° OPTIMIZED: Use precomputed studentsByGroup
          const groupStudents = (studentsByGroup.get(groupName) || [])
            .filter(s => s.show_in_grid !== false);
          
          // Show confirmation dialog
          const confirmed = await showConfirmDialog(
            'Cancel Class?',
            `
              <div style="text-align: left; line-height: 1.6;">
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Group:</strong> ${groupName}</div>
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Date:</strong> ${dateStr}</div>
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Students:</strong> ${groupStudents.length}</div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; font-size: 14px; color: rgba(255,255,255,0.85);">
                  ÔøΩ This will cancel the class for all students in Group ${groupName}.
                </div>
              </div>
            `
          );

          if (!confirmed) return;

          // Save to Supabase
          const { error: insertError } = await supabaseClient
            .from('skipped_classes')
            .insert({
              group_name: groupName,
              class_date: dateStr,
              skip_type: 'class-canceled',
              note: 'Class canceled'
            });

          if (insertError) {
            throw new Error(`Failed to cancel class: ${insertError.message}`);
          }

          // Success notification
          const successOverlay = document.createElement('div');
          successOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(138, 180, 255, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          successOverlay.textContent = `‚úÖ Class canceled for Group ${groupName}`;
          document.body.appendChild(successOverlay);
          setTimeout(() => successOverlay.remove(), 3000);

          // Close the modal
          closeDayModal();

          // Reload skipped classes and refresh calendar
          await loadSkippedClasses();
          renderCalendar();
        } catch (error) {
          console.error('‚ùå Failed to cancel class:', error);
          
          // Error notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = `‚ùå Failed to cancel class: ${error.message}`;
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 4000);
        }
      }

      async function uncancelClass(groupName, dateStr) {
        try {
          // Show confirmation dialog
          const confirmed = await showConfirmDialog(
            'Restore Class?',
            `
              <div style="text-align: left; line-height: 1.6;">
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Group:</strong> ${groupName}</div>
                <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Date:</strong> ${dateStr}</div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; font-size: 14px; color: rgba(255,255,255,0.85);">
                  ‚Ü©Ô∏è The class will be restored to the schedule for Group ${groupName}.
                </div>
              </div>
            `
          );

          if (!confirmed) return;

          // Delete from Supabase
          const { error: deleteError } = await supabaseClient
            .from('skipped_classes')
            .delete()
            .eq('group_name', groupName)
            .eq('class_date', dateStr);

          if (deleteError) {
            throw new Error(`Failed to restore class: ${deleteError.message}`);
          }

          // Success notification
          const successOverlay = document.createElement('div');
          successOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(138, 180, 255, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          successOverlay.textContent = `‚úÖ Class restored for Group ${groupName}`;
          document.body.appendChild(successOverlay);
          setTimeout(() => successOverlay.remove(), 3000);

          // Close the modal
          closeDayModal();

          // Reload skipped classes and refresh calendar
          await loadSkippedClasses();
          renderCalendar();
        } catch (error) {
          console.error('‚ùå Failed to restore class:', error);
          
          // Error notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = `‚ùå Failed to restore class: ${error.message}`;
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 4000);
        }
      }

      // Custom Confirm Dialog
      function showConfirmDialog(title, message) {
        return new Promise((resolve) => {
          // Create overlay
          const overlay = document.createElement('div');
          overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999999;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            animation: fadeIn 0.2s ease;
          `;

          // Create dialog
          const dialog = document.createElement('div');
          dialog.style.cssText = `
            background: linear-gradient(135deg, #1a1f35 0%, #0f1419 100%);
            border: 1px solid rgba(138, 180, 255, 0.3);
            border-radius: 16px;
            padding: 32px;
            min-width: 450px;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          `;

          dialog.innerHTML = `
            <h3 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600; color: #8ab4ff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">${title}</h3>
            <div style="margin-bottom: 24px; color: rgba(255,255,255,0.85); font-size: 15px; line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
              ${message}
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button id="confirmCancel" style="
                padding: 10px 24px;
                background: rgba(255,255,255,0.08);
                border: none;
                border-radius: 8px;
                color: rgba(255,255,255,0.7);
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
              ">Cancel</button>
              <button id="confirmOk" style="
                padding: 10px 24px;
                background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
                border: none;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
              ">Confirm</button>
            </div>
          `;

          overlay.appendChild(dialog);
          document.body.appendChild(overlay);

          // Add hover effects
          const cancelBtn = dialog.querySelector('#confirmCancel');
          const okBtn = dialog.querySelector('#confirmOk');
          
          cancelBtn.addEventListener('mouseover', () => {
            cancelBtn.style.background = 'rgba(255,255,255,0.12)';
            cancelBtn.style.color = 'white';
          });
          cancelBtn.addEventListener('mouseout', () => {
            cancelBtn.style.background = 'rgba(255,255,255,0.08)';
            cancelBtn.style.color = 'rgba(255,255,255,0.7)';
          });
          
          okBtn.addEventListener('mouseover', () => {
            okBtn.style.transform = 'translateY(-1px)';
            okBtn.style.boxShadow = '0 4px 12px rgba(138, 180, 255, 0.4)';
          });
          okBtn.addEventListener('mouseout', () => {
            okBtn.style.transform = 'translateY(0)';
            okBtn.style.boxShadow = 'none';
          });

          // Handle responses
          const cleanup = (result) => {
            overlay.remove();
            resolve(result);
          };

          cancelBtn.addEventListener('click', () => cleanup(false));
          okBtn.addEventListener('click', () => cleanup(true));
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) cleanup(false);
          });
        });
      }

      function showInputDialog(title, message, defaultValue = '') {
        return new Promise((resolve) => {
          // Create overlay
          const overlay = document.createElement('div');
          overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999999;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            animation: fadeIn 0.2s ease;
          `;

          // Create dialog
          const dialog = document.createElement('div');
          dialog.style.cssText = `
            background: linear-gradient(135deg, #1a1f35 0%, #0f1419 100%);
            border: 1px solid rgba(138, 180, 255, 0.3);
            border-radius: 16px;
            padding: 32px;
            min-width: 450px;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          `;

          dialog.innerHTML = `
            <h3 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600; color: #8ab4ff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">${title}</h3>
            <div style="margin-bottom: 20px; color: rgba(255,255,255,0.85); font-size: 15px; line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
              ${message}
            </div>
            <input 
              type="number" 
              id="dialogInput" 
              value="${defaultValue}"
              step="0.01"
              style="
                width: 100%;
                padding: 12px 16px;
                background: rgba(255,255,255,0.08);
                border: 1px solid rgba(138,180,255,0.3);
                border-radius: 8px;
                color: white;
                font-size: 16px;
                font-weight: 600;
                outline: none;
                margin-bottom: 24px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                transition: all 0.2s ease;
              "
            />
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button id="inputCancel" style="
                padding: 10px 24px;
                background: rgba(255,255,255,0.08);
                border: none;
                border-radius: 8px;
                color: rgba(255,255,255,0.7);
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
              ">Cancel</button>
              <button id="inputOk" style="
                padding: 10px 24px;
                background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
                border: none;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
              ">Confirm</button>
            </div>
          `;

          overlay.appendChild(dialog);
          document.body.appendChild(overlay);

          // Get elements
          const inputField = document.getElementById('dialogInput');
          const cancelBtn = document.getElementById('inputCancel');
          const okBtn = document.getElementById('inputOk');

          // Focus input and select all
          setTimeout(() => {
            inputField.focus();
            inputField.select();
          }, 100);

          // Add hover effects and input focus effects
          inputField.addEventListener('focus', () => {
            inputField.style.borderColor = 'rgba(138,180,255,0.6)';
            inputField.style.background = 'rgba(255,255,255,0.12)';
          });
          inputField.addEventListener('blur', () => {
            inputField.style.borderColor = 'rgba(138,180,255,0.3)';
            inputField.style.background = 'rgba(255,255,255,0.08)';
          });

          cancelBtn.addEventListener('mouseover', () => {
            cancelBtn.style.background = 'rgba(255,255,255,0.12)';
            cancelBtn.style.color = 'white';
          });
          cancelBtn.addEventListener('mouseout', () => {
            cancelBtn.style.background = 'rgba(255,255,255,0.08)';
            cancelBtn.style.color = 'rgba(255,255,255,0.7)';
          });
          
          okBtn.addEventListener('mouseover', () => {
            okBtn.style.transform = 'translateY(-1px)';
            okBtn.style.boxShadow = '0 4px 12px rgba(138, 180, 255, 0.4)';
          });
          okBtn.addEventListener('mouseout', () => {
            okBtn.style.transform = 'translateY(0)';
            okBtn.style.boxShadow = 'none';
          });

          // Handle responses
          const cleanup = (value) => {
            overlay.remove();
            resolve(value);
          };

          cancelBtn.addEventListener('click', () => cleanup(null));
          okBtn.addEventListener('click', () => cleanup(inputField.value));
          
          // Handle Enter key
          inputField.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              cleanup(inputField.value);
            } else if (e.key === 'Escape') {
              cleanup(null);
            }
          });

          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) cleanup(null);
          });
        });
      }

      // ============================================================
      // üìß EMAIL PAYMENT REMINDER SYSTEM
      // ============================================================

      async function sendManualReminder(studentId, studentName, classDate = null, pricePerClass = null) {
        try {
          console.log(`Preparing to send manual payment reminder to ${studentName}`, { studentId });

          const templateChoice = await showEmailTemplatePicker(studentName);
          if (!templateChoice) return;

          let payload = null;
          if (templateChoice === 'payment_failed') {
            payload = await buildFailedPaymentPayload(studentId, classDate, pricePerClass);
          } else {
            payload = await buildPaymentReminderPayload(studentId);
          }

          const previewConfirmed = await showEmailPreviewDialog(payload.subject, payload.html, templateChoice);
          if (!previewConfirmed) return;

          // Send email
          const result = await sendEmailPayload(payload);
          await logSentEmail(payload, result);

          // Success notification - matching design system
          const successOverlay = document.createElement('div');
          successOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(138, 180, 255, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          successOverlay.textContent = `‚úÖ Email sent to ${studentName}!`;
          document.body.appendChild(successOverlay);
          setTimeout(() => successOverlay.remove(), 3000);

          console.log(`‚úÖ Manual reminder sent to ${studentName}`);
          return result;
        } catch (emailErr) {
          console.error('‚ùå Failed to send payment reminder email:', emailErr);

          // Error notification - matching design system
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = `‚ùå Failed to send email: ${emailErr.message}`;
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 4000);
        }
      }

      function showEmailTemplatePicker(studentName) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999999;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            animation: fadeIn 0.2s ease;
          `;

          const dialog = document.createElement('div');
          dialog.style.cssText = `
            background: linear-gradient(135deg, #1a1f35 0%, #0f1419 100%);
            border: 1px solid rgba(138, 180, 255, 0.3);
            border-radius: 16px;
            padding: 28px;
            min-width: 460px;
            max-width: 520px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          `;

          dialog.innerHTML = `
            <h3 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 600; color: #8ab4ff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">Choose Email Template</h3>
            <div style="margin-bottom: 20px; color: rgba(255,255,255,0.85); font-size: 14px; line-height: 1.6;">
              Select which email to send for <strong>${studentName}</strong>.
            </div>
            <div style="display: grid; gap: 12px;">
              <button id="templateReminder" style="
                text-align: left;
                padding: 14px 16px;
                background: rgba(138, 180, 255, 0.12);
                border: 1px solid rgba(138, 180, 255, 0.35);
                border-radius: 10px;
                color: white;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
              ">üíå Payment Reminder (current template)</button>
              <button id="templateFailed" style="
                text-align: left;
                padding: 14px 16px;
                background: rgba(248, 113, 113, 0.12);
                border: 1px solid rgba(248, 113, 113, 0.35);
                border-radius: 10px;
                color: white;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
              ">‚ö†Ô∏è Payment Failed Notice</button>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
              <button id="templateCancel" style="
                padding: 10px 22px;
                background: rgba(255,255,255,0.08);
                border: none;
                border-radius: 8px;
                color: rgba(255,255,255,0.7);
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
              ">Cancel</button>
            </div>
          `;

          overlay.appendChild(dialog);
          document.body.appendChild(overlay);

          const cleanup = (value) => {
            overlay.remove();
            resolve(value);
          };

          dialog.querySelector('#templateReminder').addEventListener('click', () => cleanup('payment_reminder'));
          dialog.querySelector('#templateFailed').addEventListener('click', () => cleanup('payment_failed'));
          dialog.querySelector('#templateCancel').addEventListener('click', () => cleanup(null));
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) cleanup(null);
          });
        });
      }

      function showEmailPreviewDialog(subject, html, templateKey) {
        const templateLabel = templateKey === 'payment_failed' ? 'Payment Failed Notice' : 'Payment Reminder';
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999999;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            animation: fadeIn 0.2s ease;
          `;

          const dialog = document.createElement('div');
          dialog.style.cssText = `
            background: linear-gradient(135deg, #1a1f35 0%, #0f1419 100%);
            border: 1px solid rgba(138, 180, 255, 0.3);
            border-radius: 16px;
            padding: 24px;
            min-width: 520px;
            max-width: 720px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          `;

          dialog.innerHTML = `
            <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600; color: #8ab4ff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">Preview: ${templateLabel}</h3>
            <div style="margin-bottom: 16px; color: rgba(255,255,255,0.85); font-size: 14px;">Subject: <strong>${subject}</strong></div>
            <div style="background: white; border-radius: 10px; padding: 14px; max-height: 320px; overflow-y: auto; color: #111;">
              ${html}
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
              <button id="previewCancel" style="
                padding: 10px 22px;
                background: rgba(255,255,255,0.08);
                border: none;
                border-radius: 8px;
                color: rgba(255,255,255,0.7);
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
              ">Cancel</button>
              <button id="previewSend" style="
                padding: 10px 22px;
                background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
                border: none;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
              ">Send Email</button>
            </div>
          `;

          overlay.appendChild(dialog);
          document.body.appendChild(overlay);

          const cleanup = (value) => {
            overlay.remove();
            resolve(value);
          };

          dialog.querySelector('#previewCancel').addEventListener('click', () => cleanup(false));
          dialog.querySelector('#previewSend').addEventListener('click', () => cleanup(true));
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) cleanup(false);
          });
        });
      }

      async function sendPaymentReminderEmail(studentId) {
        const payload = await buildPaymentReminderPayload(studentId);
        const result = await sendEmailPayload(payload);
        await logSentEmail(payload, result);
        return result;
      }

      async function getStudentEmailInfo(studentId) {
        console.log('üìß Preparing email payload...', { studentId });

        const student = studentsData.find(s => s.id === parseInt(studentId));
        if (!student) {
          throw new Error('Student not found');
        }

        console.log('üìß Student email check:', {
          name: student.name,
          email: student.email,
          emailType: typeof student.email
        });

        if (!student.email) {
          throw new Error('Student has no email address');
        }

        // Parse email if it's JSON array string
        let cleanEmail = String(student.email).trim();
        if (cleanEmail.startsWith('[') && cleanEmail.endsWith(']')) {
          try {
            const parsed = JSON.parse(cleanEmail);
            if (Array.isArray(parsed) && parsed.length > 0) {
              cleanEmail = String(parsed[0]).trim();
              console.log('üìß Parsed email from JSON array:', cleanEmail);
            }
          } catch (e) {
            console.warn('‚ö†Ô∏è Failed to parse email JSON:', e);
          }
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(cleanEmail)) {
          throw new Error(`Invalid email format: "${cleanEmail}" - Please update student's email in Student Manager`);
        }

        return { student, cleanEmail };
      }

      async function buildPaymentReminderPayload(studentId) {
        const { student, cleanEmail } = await getStudentEmailInfo(studentId);

        const balance = Number(student.balance) || 0;
        const pricePerClass = Number(student.price_per_class) || 15;

        const unpaidClassDetails = [];
        let unpaidAmountFromCalendar = 0;

        try {
          const group = groupsData.find(g => g.group_name === student.group_name);
          if (group) {
            const CUTOFF_DATE = new Date('2026-02-01');
            const today = new Date();
            let startDate = CUTOFF_DATE;

            if (student.created_at) {
              const studentCreatedDate = new Date(student.created_at);
              if (studentCreatedDate > startDate) {
                startDate = studentCreatedDate;
                console.log('üÜï Student created after Feb 1, checking from creation date:', startDate.toISOString().split('T')[0]);
              } else {
                console.log('üìÖ Using Feb 1, 2026 cutoff date for unpaid calculation');
              }
            }

            for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
              const dateStr = d.toISOString().split('T')[0];

              if (student.created_at) {
                const studentCreatedDate = new Date(student.created_at).toISOString().split('T')[0];
                if (dateStr < studentCreatedDate) {
                  continue;
                }
              }

              if (isScheduledClassDate(dateStr, group)) {
                const paymentInfo = hasPaymentCached(student.id, dateStr, student);
                const hasAbsence = isAbsentCached(dateStr, student.id);
                const isSkipped = isClassSkippedCached(dateStr, group.group_name);

                if (!paymentInfo.hasPayment && !hasAbsence && !isSkipped) {
                  const formattedDate = new Date(dateStr + 'T12:00:00').toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  });

                  unpaidClassDetails.push({
                    date: dateStr,
                    formattedDate,
                    amount: pricePerClass
                  });

                  unpaidAmountFromCalendar += pricePerClass;
                }
              }
            }
          }

          console.log('üí∞ Found unpaid classes from calendar logic:', {
            studentId,
            studentName: student.name,
            groupName: student.group_name,
            createdAt: student.created_at,
            unpaidClassesCount: unpaidClassDetails.length,
            unpaidAmount: unpaidAmountFromCalendar,
            unpaidDates: unpaidClassDetails.map(c => c.date)
          });
        } catch (err) {
          console.warn('‚ö†Ô∏è Could not calculate unpaid classes, using balance:', err);
        }

        const finalBalance = unpaidAmountFromCalendar > 0 ? unpaidAmountFromCalendar : balance;
        const finalPrice = pricePerClass || 15;

        console.log('üí∞ Payment reminder calculation:', {
          studentId,
          studentName: student.name,
          unpaidClassesCount: unpaidClassDetails.length,
          unpaidAmountFromCalendar,
          studentBalance: balance,
          finalBalance,
          unpaidClassDetails
        });

        const emailHTML = await generatePaymentReminderEmailHTML(
          student.name,
          finalBalance,
          finalPrice,
          studentId,
          unpaidClassDetails
        );

        return {
          studentId,
          student,
          cleanEmail,
          subject: 'Payment Reminder - ARNOMA NCLEX-RN',
          html: emailHTML,
          emailType: 'payment_reminder',
          templateName: 'Payment Reminder',
          amount: finalBalance
        };
      }

      async function buildFailedPaymentPayload(studentId, classDate = null, pricePerClass = null) {
        const { student, cleanEmail } = await getStudentEmailInfo(studentId);

        const amount = Number(pricePerClass || student.price_per_class || 15);
        const emailHTML = await generateFailedPaymentEmailHTML(
          student.name,
          classDate,
          amount
        );

        return {
          studentId,
          student,
          cleanEmail,
          subject: 'Payment Failed - ARNOMA NCLEX-RN',
          html: emailHTML,
          emailType: 'payment_failed',
          templateName: 'Payment Failed',
          amount
        };
      }

      async function sendEmailPayload(payload) {
        console.log('üìß Sending email to:', payload.cleanEmail);

        const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({
            to: payload.cleanEmail,
            subject: payload.subject,
            html: payload.html,
          }),
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('‚ùå Email API error response:', errorData);
          const errorMsg = errorData.error?.message || errorData.error || 'Unknown error';
          throw new Error(`Email API error: ${errorMsg}`);
        }

        const result = await response.json();
        if (result.data && result.data.error) {
          console.error('‚ùå Email service error:', result.data.error);
          throw new Error(`Email service error: ${result.data.error.message || JSON.stringify(result.data.error)}`);
        }

        console.log('‚úÖ Email sent successfully:', result);
        return result;
      }

      async function logSentEmail(payload, result) {
        try {
          const resendEmailId = result?.id || result?.data?.id || null;

          const sentEmailRecord = {
            recipient_email: payload.cleanEmail,
            recipient_name: payload.student.name,
            subject: payload.subject,
            html_content: payload.html,
            template_name: payload.templateName,
            email_type: payload.emailType,
            resend_id: resendEmailId,
            delivery_status: 'delivered',
            status: 'sent',
            sent_at: new Date().toISOString()
          };

          const { data: logData, error: logError } = await supabaseClient
            .from('sent_emails')
            .insert([sentEmailRecord])
            .select();

          if (logError) {
            console.error('‚ö†Ô∏è Failed to log to sent_emails:', logError);
          } else {
            console.log('‚úÖ Email logged to sent_emails:', logData[0]);
          }

          const notificationRecord = {
            type: 'email_sent',
            category: 'email',
            title: payload.templateName + ' Sent',
            description: `Sent ${payload.templateName.toLowerCase()} to ${payload.student.name} (${payload.cleanEmail}) for $${payload.amount}`,
            student_name: payload.student.name,
            metadata: {
              student_id: payload.studentId,
              student_name: payload.student.name,
              email: payload.cleanEmail,
              amount: payload.amount,
              email_type: payload.emailType,
              subject: payload.subject,
              html: payload.html
            },
            timestamp: new Date().toISOString(),
            read: false,
            created_at: new Date().toISOString()
          };

          const { data: notifData, error: notifError } = await supabaseClient
            .from('notifications')
            .insert([notificationRecord])
            .select();

          if (notifError) {
            console.error('‚ö†Ô∏è Failed to log to notifications:', notifError);
          } else {
            console.log('‚úÖ Notification logged:', notifData[0]);
          }
        } catch (logErr) {
          console.error('‚ö†Ô∏è Error logging notifications (email still sent):', logErr);
        }
      }

      async function generatePaymentReminderEmailHTML(studentName, balance, pricePerClass, studentId = null, unpaidClassDetails = []) {
        // Helper function to format date beautifully
        function formatClassDate(dateStr) {
          const date = new Date(dateStr + 'T12:00:00');
          const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
          return date.toLocaleDateString('en-US', options);
        }
        
        const normalizedPricePerClass = Number(pricePerClass) > 0 ? Number(pricePerClass) : 15;
        const unpaidClasses = (Array.isArray(unpaidClassDetails) ? unpaidClassDetails : []).map(cls => {
          const rawDate = cls.date || cls.class_date || null;
          const formattedDate = cls.formattedDate || (rawDate ? formatClassDate(rawDate) : 'Class date pending');
          const amount = Number(cls.amount);
          return {
            date: rawDate,
            formattedDate,
            amount: Number.isFinite(amount) && amount > 0 ? amount : normalizedPricePerClass
          };
        });
        
        // Calculate unpaid amount from student balance
        let actualAmountDue = 0;
        let actualUnpaidCount = 0;
        
        if (studentId && balance && balance > 0) {
          // Student has positive balance = money owed
          actualAmountDue = balance;
          
          // Calculate number of unpaid classes based on price per class
          actualUnpaidCount = Math.ceil(actualAmountDue / normalizedPricePerClass);
          
          console.log('üí∞ Payment reminder - using student balance:', {
            studentId,
            studentName,
            balance,
            pricePerClass: normalizedPricePerClass,
            unpaidCount: actualUnpaidCount,
            amountDue: actualAmountDue
          });
        } else {
          console.log('üí∞ Payment reminder - no balance owed:', {
            studentId,
            studentName,
            balance
          });
        }
        
        // Build unpaid classes summary HTML
        let unpaidClassesSummary = '';
        
        // Calculate actual amounts from unpaid classes
        if (unpaidClasses.length > 0) {
          actualUnpaidCount = unpaidClasses.length;
          actualAmountDue = unpaidClasses.reduce((sum, cls) => sum + cls.amount, 0);
          
          if (unpaidClasses.length === 1) {
            // Single unpaid class - simple format
            unpaidClassesSummary = `
              <div style="background: #f0f4ff; border-left: 4px solid #667eea; padding: 16px; margin: 16px 0; border-radius: 6px;">
                <p style="margin: 4px 0; font-size: 15px;"><strong>üìÖ ${unpaidClasses[0].formattedDate}</strong></p>
                <p style="margin: 4px 0; font-size: 15px;"><strong>Amount Due:</strong> $${unpaidClasses[0].amount.toFixed(2)}</p>
              </div>
            `;
          } else {
            // Multiple unpaid classes - beautiful list
            const classList = unpaidClasses.map((cls, index) => `
              <div style="background: ${index === unpaidClasses.length - 1 ? '#fff9e6' : '#ffffff'}; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #e5e7eb;">
                <p style="margin: 4px 0; font-size: 14px; color: #6b7280;">Class ${index + 1}</p>
                <p style="margin: 4px 0; font-size: 15px;"><strong>${index === unpaidClasses.length - 1 ? 'üëâ ' : ''}${cls.formattedDate}</strong></p>
                <p style="margin: 4px 0; font-size: 15px; text-align: right;"><strong>$${cls.amount.toFixed(2)}</strong></p>
              </div>
            `).join('');
            
            unpaidClassesSummary = `
              <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin: 20px 0;">
                <h3 style="margin: 0 0 16px 0; color: #764ba2; font-size: 18px;">üí≥ Outstanding Classes</h3>
                ${classList}
                <div style="background: #667eea; color: white; padding: 12px; margin: 12px 0 0 0; border-radius: 6px; text-align: right;">
                  <strong style="font-size: 16px;">Total Amount Due: $${actualAmountDue.toFixed(2)}</strong>
                </div>
              </div>
            `;
          }
        } else {
          // Fallback: calculate from balance if we couldn't fetch classes
          const normalizedBalance = Number(balance) || 0;
          actualAmountDue = normalizedBalance > 0 ? normalizedBalance : 0;
          
          // Validate pricePerClass to prevent NaN
          actualUnpaidCount = Math.ceil(actualAmountDue / normalizedPricePerClass);
          
          // Ensure actualUnpaidCount is a valid number
          if (!Number.isFinite(actualUnpaidCount) || actualUnpaidCount < 0) {
            actualUnpaidCount = 0;
          }
          
          console.log('üí∞ Using fallback calculation:', {
            balance: normalizedBalance,
            actualAmountDue,
            pricePerClass: normalizedPricePerClass,
            unpaidCount: actualUnpaidCount
          });
          
          unpaidClassesSummary = `${actualUnpaidCount} unpaid ${actualUnpaidCount === 1 ? 'class' : 'classes'} - Total: $${actualAmountDue.toFixed(2)}`;
        }
        
        try {
          // Try to load Payment Reminder template from Email System (Supabase)
          const { data: templates, error } = await supabaseClient
            .from('email_templates')
            .select('*')
            .eq('name', 'Payment Reminder')
            .maybeSingle();
          
          if (!error && templates && templates.body) {
            console.log('‚úÖ Using Payment Reminder template from Email System');
            console.log(`üìä Payment details: ${actualUnpaidCount} classes, $${actualAmountDue.toFixed(2)} total`);
            
            // Replace template variables with actual data (case-insensitive)
            let emailHTML = templates.body
              .replace(/\{\{StudentName\}\}/gi, studentName)
              .replace(/\{\{UnpaidClasses\}\}/gi, unpaidClassesSummary)
              .replace(/\{\{ClassDate\}\}/gi, new Date().toLocaleDateString())
              .replace(/\{\{PricePerClass\}\}/gi, normalizedPricePerClass.toFixed(2))
              .replace(/\{\{Balance\}\}/gi, actualAmountDue.toFixed(2))
              .replace(/\{\{AmountDue\}\}/gi, actualAmountDue.toFixed(2))
              .replace(/\{\{UnpaidClassCount\}\}/gi, actualUnpaidCount.toString())
              .replace(/\{\{TeacherEmail\}\}/gi, 'arnomaschool@gmail.com')
              .replace(/\{\{TeacherName\}\}/gi, 'ARNOMA Team');
            
            return emailHTML;
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Could not load template from Email System, using fallback:', e);
        }
        
        // FALLBACK: Use hardcoded template if Email System template not found
        console.log('‚ÑπÔ∏è Using fallback payment reminder template');
        const fallbackHTML = `<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ARNOMA NCLEX-RN Email</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        margin: 0;
      }

      .email-wrapper {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .email-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .email-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px 30px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .email-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: none;
      }

      .email-header img {
        width: 120px;
        height: auto;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1)) drop-shadow(0 0 10px rgba(255, 255, 255, 0.6)) drop-shadow(0 0 20px rgba(255, 255, 255, 0.4));
      }

      .email-header h1 {
        color: white;
        font-size: 32px;
        font-weight: 700;
        margin: 0;
        position: relative;
        z-index: 1;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .email-body {
        padding: 40px 30px;
        color: #1f2937;
        line-height: 1.8;
        background: white;
      }

      .email-body p {
        margin: 16px 0;
        font-size: 16px;
        color: #374151;
      }

      .email-body strong {
        color: #764ba2;
        font-weight: 600;
      }

      .info-box {
        background-color: #f6f8fe;
        border-left: 3px solid #3b82f6;
        border-radius: 10px;
        padding: 14px 18px;
        font-size: 15px;
        line-height: 1.5;
        color: #1e293b;
        margin: 20px 0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }

      .info-box p {
        margin: 6px 0;
        text-align: left;
      }

      .payment-instructions {
        background: #f9fafb;
        border-radius: 12px;
        padding: 24px;
        margin: 24px 0;
      }

      .payment-instructions h3 {
        color: #764ba2;
        font-size: 20px;
        margin-bottom: 16px;
        font-weight: 600;
      }

      .payment-instructions p {
        margin: 12px 0;
        color: #4b5563;
      }

      .payment-frame {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        border: 2px solid rgba(118, 75, 162, 0.2);
        border-radius: 16px;
        padding: 32px;
        margin: 32px 0;
        text-align: center;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
      }

      .payment-frame p {
        margin: 12px 0;
        font-size: 18px;
        color: #1f2937;
      }

      .payment-frame img {
        max-width: 240px;
        height: auto;
        margin: 20px auto;
        display: block;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .zelle-number {
        font-size: 24px;
        font-weight: 700;
        color: #764ba2;
        margin: 16px 0;
        letter-spacing: 1px;
      }

      .email-footer {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 32px 30px;
        text-align: center;
        color: white;
      }

      .email-footer img {
        width: 80px;
        height: auto;
        margin-bottom: 16px;
        filter: brightness(0) invert(1);
        opacity: 0.9;
      }

      .email-footer p {
        margin: 8px 0;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.9);
      }

      .email-footer strong {
        color: white;
        font-weight: 600;
      }

      .divider {
        height: 1px;
        background: linear-gradient(to right, transparent, rgba(118, 75, 162, 0.3), transparent);
        margin: 24px 0;
      }

      @media only screen and (max-width: 600px) {
        .email-wrapper {
          padding: 16px;
        }

        .email-header {
          padding: 30px 20px;
        }

        .email-header h1 {
          font-size: 24px;
        }

        .email-body {
          padding: 24px 20px;
        }

        .payment-frame {
          padding: 20px;
        }

        .payment-frame img {
          max-width: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div class="email-wrapper">
      <div class="email-container">
        <!-- Header -->
        <div class="email-header">
          <img
            src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png"
            alt="ARNOMA Logo"
          />
          <h1>Payment Reminder</h1>
        </div>

        <!-- Body -->
        <div class="email-body">
          <p>
            Hello
            <strong>${studentName}</strong>
            ,
          </p>

          <p>This is a quick, automated check regarding your recent classes:</p>

          <div class="info-box">
            <p><strong>${unpaidClassesSummary}</strong></p>
          </div>

          <p>Our records show that your payment hasn't been posted yet.</p>

          <div class="divider"></div>

          <div class="payment-instructions">
            <h3>What to do:</h3>

            <p>
              <strong>If you have already paid:</strong>
              <br />
              Great! Please simply reply with the screenshot of your transfer. That's all we need to update our log and
              ensure you don't receive any more reminders.
            </p>

            <p>
              <strong>If you still plan to pay:</strong>
              <br />
              Please submit the payment at your earliest convenience. The system can only process and send your notes
              once payment is confirmed.
            </p>
          </div>

          <div class="divider"></div>

          <!-- Payment Frame -->
          <div class="payment-frame">
            <p style="font-size: 20px; margin-bottom: 8px">
              <strong>
                Send Money with
                <span style="color: #764ba2">Zelle¬Æ</span>
              </strong>
            </p>
            <p style="font-size: 14px; color: #6b7280; margin-bottom: 20px">Scan in your banking app to pay.</p>

            <p class="zelle-number">909-300-5155</p>

            <img
              src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/Arnoma%20Zelle.JPG"
              alt="Zelle QR Code"
            />

            <p style="font-size: 16px; color: #9ca3af; margin-top: 16px">
              <strong style="color: #764ba2">Zelle</strong>
            </p>
          </div>

          <p style="margin-top: 32px">Thank you for your prompt attention to this!</p>

          <p style="margin-top: 24px">
            Best regards,
            <br />
            <strong style="color: #764ba2">ARNOMA Team</strong>
          </p>
        </div>

        <!-- Footer -->
        <div class="email-footer">
          <img
            src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png"
            alt="ARNOMA Logo"
          />
          <p><strong>ARNOMA ‚Äì NCLEX RN</strong></p>
          <p style="margin-top: 12px">nclex.rn@arnoma.us | richy@arnoma.us | 909-808-1818</p>
          <p style="margin-top: 16px; font-size: 12px; opacity: 0.8">¬© 2025 ARNOMA. All rights reserved.</p>
        </div>
      </div>
    </div>
  </body>
</html>`;
        
        return fallbackHTML;
      }

      async function generateFailedPaymentEmailHTML(studentName, classDate = null, amount = null) {
        const formattedDate = classDate
          ? new Date(classDate + 'T12:00:00').toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })
          : new Date().toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
        const formattedAmount = Number(amount || 0).toFixed(2);

        return `<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Failed</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      }
      .email-wrapper {
        padding: 20px;
        max-width: 100%;
      }
      .email-container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
      }
      .email-header {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        padding: 40px 30px;
        text-align: center;
        color: white;
      }
      .email-header img {
        width: 80px;
        height: auto;
        margin-bottom: 16px;
        filter: brightness(0) invert(1);
        opacity: 0.9;
      }
      .email-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -0.5px;
      }
      .email-body {
        padding: 32px 30px;
        color: #1f2937;
        line-height: 1.8;
        font-size: 16px;
      }
      .email-body p {
        margin: 16px 0;
      }
      .email-body strong {
        color: #111827;
        font-weight: 600;
      }
      .info-box {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(220, 38, 38, 0.08));
        border-left: 4px solid #ef4444;
        border-radius: 12px;
        padding: 20px;
        margin: 24px 0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }
      .info-box p {
        margin: 6px 0;
        text-align: left;
      }
      .divider {
        height: 1px;
        background: linear-gradient(to right, transparent, rgba(239, 68, 68, 0.3), transparent);
        margin: 24px 0;
      }
      .email-footer {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 32px 30px;
        text-align: center;
        color: white;
      }
      .email-footer img {
        width: 80px;
        height: auto;
        margin-bottom: 16px;
        filter: brightness(0) invert(1);
        opacity: 0.9;
      }
      .email-footer p {
        margin: 8px 0;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.9);
      }
      .email-footer strong {
        color: white;
        font-weight: 600;
      }
      @media only screen and (max-width: 600px) {
        .email-wrapper {
          padding: 16px;
        }
        .email-header {
          padding: 30px 20px;
        }
        .email-header h1 {
          font-size: 24px;
        }
        .email-body {
          padding: 24px 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="email-wrapper">
      <div class="email-container">
        <!-- Header -->
        <div class="email-header">
          <img
            src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png"
            alt="ARNOMA Logo"
          />
          <h1>Payment Failed</h1>
        </div>

        <!-- Body -->
        <div class="email-body">
          <p>Dear <strong>${studentName}</strong>,</p>

          <p>We have received a notification from the bank indicating that your recent payment attempt was unsuccessful and the funds were not deposited.</p>

          <div class="info-box">
            <p><strong>Payment Details</strong></p>
            <p><strong>Date:</strong> ${formattedDate}</p>
            <p><strong>Amount:</strong> $${formattedAmount}</p>
          </div>

          <p>Kindly check with your bank to confirm that the payment has been returned to your account. Once confirmed, we would appreciate it if you could resend the payment at your earliest convenience.</p>

          <p>Thank you for your attention to this matter.</p>

          <div class="divider"></div>

          <p style="margin-top: 24px">
            Best regards,
            <br />
            <strong style="color: #ef4444">ARNOMA Team</strong>
          </p>
        </div>

        <!-- Footer -->
        <div class="email-footer">
          <img
            src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png"
            alt="ARNOMA Logo"
          />
          <p><strong>ARNOMA ‚Äì NCLEX RN</strong></p>
          <p style="margin-top: 12px">nclex.rn@arnoma.us | richy@arnoma.us | 909-808-1818</p>
          <p style="margin-top: 16px; font-size: 12px; opacity: 0.8">¬© 2025 ARNOMA. All rights reserved.</p>
        </div>
      </div>
    </div>
  </body>
</html>`;
      }

      async function saveBalance() {
        if (!currentStudentData) return;
        
        const balanceInput = document.getElementById('studentBalance');
        const inputValue = balanceInput.value.replace(/[^0-9.-]/g, ''); // Remove $ and commas
        const newBalance = parseFloat(inputValue);
        const originalBalance = parseFloat(balanceInput.dataset.originalValue);
        
        // If no change or invalid, revert to original
        if (isNaN(newBalance) || newBalance === originalBalance) {
          balanceInput.value = formatCurrency(originalBalance) + ' $';
          return;
        }
        
        try {
          // Update in database
          const { error } = await supabaseClient
            .from('students')
            .update({ balance: newBalance })
            .eq('id', currentStudentData.studentId);
          
          if (error) throw error;
          
          // Update current data
          currentStudentData.balance = newBalance;
          balanceInput.dataset.originalValue = newBalance;
          balanceInput.value = formatCurrency(newBalance) + ' $';
          
          // Update the student in the array
          allStudentsOnDate[currentStudentIndex].balance = newBalance;
          
          // Reload students data to update calendar
          await loadStudents();
          renderCalendar();
        } catch (error) {
          console.error('‚ùå Error updating balance:', error);
          
          // Error notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = '‚ùå Failed to update balance. Please try again.';
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 4000);
          
          // Revert to original
          balanceInput.value = formatCurrency(originalBalance) + ' $';
        }
      }

      async function sendEmailReminder() {
        if (!currentStudentData) return;
        
        // Call the actual email sending function
        await sendManualReminder(
          currentStudentData.studentId,
          currentStudentData.studentName,
          currentStudentData.classDate,
          currentStudentData.price
        );
      }

      async function markAsAbsent() {
        if (!currentStudentData) return;
        
        const confirmed = await showConfirmDialog(
          'Mark as Absent?',
          `
            <div style="text-align: left; line-height: 1.6;">
              <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Student:</strong> ${currentStudentData.studentName}</div>
              <div style="margin-bottom: 12px; font-size: 15px;"><strong style="color: #8ab4ff;">Date:</strong> ${currentStudentData.classDate}</div>
              <div style="margin-top: 16px; padding: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; font-size: 14px; color: rgba(255,255,255,0.85);">
                üö´ This will mark the student as absent for this class.
              </div>
            </div>
          `
        );
        if (!confirmed) return;
        
        try {
          // Check if absence already exists
          const { data: existing } = await supabaseClient
            .from('student_absences')
            .select('id')
            .eq('student_id', currentStudentData.studentId)
            .eq('class_date', currentStudentData.classDate)
            .single();
          
          if (existing) {
            // Warning notification
            const warningOverlay = document.createElement('div');
            warningOverlay.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
              color: white;
              padding: 16px 24px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(245, 158, 11, 0.4);
              z-index: 10000000;
              font-weight: 600;
              animation: slideInRight 0.3s ease;
            `;
            warningOverlay.textContent = '‚ö†Ô∏è This student is already marked absent for this date.';
            document.body.appendChild(warningOverlay);
            setTimeout(() => warningOverlay.remove(), 3000);
            return;
          }
          
          // Insert absence record
          const { error } = await supabaseClient
            .from('student_absences')
            .insert({
              student_id: currentStudentData.studentId,
              class_date: currentStudentData.classDate,
              created_at: new Date().toISOString()
            });
          
          if (error) throw error;
          
          // Reload data
          await loadAbsences();
          renderCalendar();
          closeStudentModal();
          
          // Success notification
          const successOverlay = document.createElement('div');
          successOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(138, 180, 255, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          successOverlay.textContent = '‚úÖ Student marked as absent!';
          document.body.appendChild(successOverlay);
          setTimeout(() => successOverlay.remove(), 3000);
        } catch (error) {
          console.error('‚ùå Error marking absent:', error);
          
          // Error notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = '‚ùå Failed to mark absence. Please try again.';
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 4000);
        }
      }

      async function addCredit() {
        if (!currentStudentData) return;
        
        const creditAmount = prompt(`Add credit for ${currentStudentData.studentName}\n\nEnter credit amount:`, currentStudentData.price);
        if (creditAmount === null) return;
        
        const amount = parseFloat(creditAmount);
        if (isNaN(amount) || amount <= 0) {
          // Error notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = '‚ùå Invalid amount. Please enter a positive number.';
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 3000);
          return;
        }
        
        try {
          // Add credit payment
          const { error } = await supabaseClient
            .from('credit_payments')
            .insert({
              student_id: currentStudentData.studentId,
              class_date: currentStudentData.classDate,
              amount: amount,
              applied_class_date: null,
              created_at: new Date().toISOString()
            });
          
          if (error) throw error;
          
          // Update student balance
          const newBalance = currentStudentData.balance + amount;
          await supabaseClient
            .from('students')
            .update({ balance: newBalance })
            .eq('id', currentStudentData.studentId);
          
          // Reload data
          await loadCreditPayments();
          await loadStudents();
          renderCalendar();
          
          currentStudentData.balance = newBalance;
          document.getElementById('studentBalance').textContent = formatCurrency(newBalance) + ' $';
          
          // Success notification
          const successOverlay = document.createElement('div');
          successOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8ab4ff 0%, #a855f7 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(138, 180, 255, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          successOverlay.innerHTML = `‚úÖ Credit of ${formatCurrency(amount)} $ added!<br>New balance: ${formatCurrency(newBalance)} $`;
          document.body.appendChild(successOverlay);
          setTimeout(() => successOverlay.remove(), 3000);
        } catch (error) {
          console.error('‚ùå Error adding credit:', error);
          
          // Error notification
          const errorOverlay = document.createElement('div');
          errorOverlay.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            z-index: 10000000;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
          `;
          errorOverlay.textContent = '‚ùå Failed to add credit. Please try again.';
          document.body.appendChild(errorOverlay);
          setTimeout(() => errorOverlay.remove(), 4000);
        }
      }

      // Close student modal when clicking outside & keyboard navigation
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('studentModal')?.addEventListener('click', (e) => {
          if (e.target.id === 'studentModal') {
            closeStudentModal();
          }
        });
        
        // Keyboard navigation for student modal
        document.addEventListener('keydown', (e) => {
          const modal = document.getElementById('studentModal');
          if (modal && modal.style.display === 'flex') {
            if (e.key === 'ArrowLeft') {
              e.preventDefault();
              navigateStudent(-1);
            } else if (e.key === 'ArrowRight') {
              e.preventDefault();
              navigateStudent(1);
            } else if (e.key === 'Escape') {
              closeStudentModal();
            }
          }
        });
      });

      // ============================================================
      // üöÄ INITIALIZATION
      // ============================================================

      async function init() {
        // Check admin auth
        const hasAccess = await requireAdminSession();
        if (!hasAccess) return;

        // Load all data
        await loadAllData();

        // Render calendar
        renderCalendar();

        // Attach event listeners
        attachEventListeners();
      }

      // Start when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    </script>
  </body>
</html>
