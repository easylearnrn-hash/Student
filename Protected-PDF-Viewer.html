<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Study Notes ‚Äî ARNOMA University</title>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- PDF.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- ARNOMA University Typefaces -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* ==========================================================================
       CSS VARIABLES ‚Äî ARNOMA UNIVERSITY ACADEMIC THEME
       Palette: Deep Navy ¬∑ Warm Ivory ¬∑ Antique Gold
       ========================================================================== */
    :root {
      --bg-base:            #0c0f1a;
      --bg-gradient-start:  #0e1322;
      --bg-gradient-end:    #141926;

      --panel-light:  rgba(255, 252, 240, 0.04);
      --panel-dark:   rgba(10, 12, 22, 0.82);
      --glass-border: rgba(196, 164, 95, 0.22);

      --accent-primary:   #c4a45f;
      --accent-secondary: #d4b87a;
      --accent-tertiary:  #e8d5a3;
      --glow-gold:        rgba(196, 164, 95, 0.35);

      --text-strong:  #f5f0e8;
      --text-muted:   rgba(245, 240, 232, 0.65);

      --font-serif: 'Playfair Display', 'Georgia', 'Times New Roman', serif;
      --font-sans:  'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

      --card-shadow: 0 24px 80px rgba(0, 0, 0, 0.65), 0 1px 0 rgba(196, 164, 95, 0.15) inset;
      --panel-blur:  12px;
      --modal-blur:  18px;
      --rule-gold:   1px solid rgba(196, 164, 95, 0.25);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: var(--font-sans);
      background:
        radial-gradient(ellipse 120% 80% at 15% 0%, rgba(80, 60, 20, 0.18) 0%, transparent 55%),
        radial-gradient(ellipse 100% 70% at 85% 100%, rgba(60, 30, 80, 0.14) 0%, transparent 55%),
        linear-gradient(160deg, var(--bg-gradient-start) 0%, #111624 45%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      padding: 32px;
      overflow-x: hidden;
      position: relative;
      color: var(--text-strong);
      
      /* Disable text selection - CRITICAL */
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      -webkit-touch-callout: none !important;
    }

    /* Force disable selection on all elements */
    * {
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
    
    /* ‚îÄ‚îÄ Viewer shell ‚îÄ‚îÄ */
    .viewer-container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--panel-dark);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      position: relative;
      z-index: 1;
    }
    
    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .viewer-header {
      background: linear-gradient(135deg,
        rgba(196, 164, 95, 0.10) 0%,
        rgba(10, 12, 22, 0.60) 100%);
      border-bottom: var(--rule-gold);
      padding: 28px 36px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .viewer-header h1 {
      font-family: var(--font-serif);
      font-size: 24px;
      font-weight: 600;
      font-style: italic;
      color: var(--accent-secondary);
      letter-spacing: 0.01em;
      line-height: 1.2;
    }
    
    .viewer-header .student-name {
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
      margin-top: 6px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ ARNOMA wordmark in header ‚îÄ‚îÄ */
    .viewer-header-brand {
      font-family: var(--font-serif);
      font-size: 13px;
      font-weight: 600;
      color: var(--accent-primary);
      letter-spacing: 0.18em;
      text-transform: uppercase;
      opacity: 0.75;
    }
    
    /* ‚îÄ‚îÄ Controls bar ‚îÄ‚îÄ */
    .viewer-controls {
      background: rgba(196, 164, 95, 0.04);
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      padding: 16px 36px;
      border-bottom: var(--rule-gold);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .control-btn {
      background: rgba(196, 164, 95, 0.08);
      border: 1px solid rgba(196, 164, 95, 0.28);
      padding: 9px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.02em;
      transition: all 0.22s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--accent-secondary);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    
    .control-btn:hover:not(:disabled) {
      background: rgba(196, 164, 95, 0.16);
      border-color: var(--accent-primary);
      box-shadow: 0 6px 20px rgba(196, 164, 95, 0.22);
      transform: translateY(-1px);
    }

    .control-btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .control-btn:disabled {
      opacity: 0.35;
      cursor: not-allowed;
    }
    
    .print-btn {
      background: rgba(196, 164, 95, 0.12);
      color: var(--accent-tertiary);
      border-color: rgba(196, 164, 95, 0.35);
    }
    
    .print-btn:hover {
      background: rgba(196, 164, 95, 0.22);
      border-color: var(--accent-primary);
      box-shadow: 0 6px 20px rgba(196, 164, 95, 0.25);
    }
    
    .page-info {
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--text-strong);
      font-weight: 600;
      padding: 7px 14px;
      background: rgba(196, 164, 95, 0.07);
      border-radius: 8px;
      border: 1px solid rgba(196, 164, 95, 0.20);
      letter-spacing: 0.01em;
    }
    
    /* ‚îÄ‚îÄ PDF canvas area ‚îÄ‚îÄ */
    .pdf-content {
      padding: 36px;
      background: rgba(8, 10, 20, 0.45);
      min-height: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      position: relative;
    }
    
    .page-container {
      position: relative;
      background: #ffffff;
      box-shadow: 0 16px 56px rgba(0, 0, 0, 0.50), 0 0 0 1px rgba(196, 164, 95, 0.12);
      margin-bottom: 24px;
      border-radius: 10px;
      overflow: hidden;
    }

    .page-screenshot-frame {
      position: relative;
      width: 100%;
      background: #ffffff;
      border-radius: 10px;
      overflow: hidden;
      background-repeat: no-repeat;
      background-position: top center;
      background-size: contain;
    }

    .page-screenshot-image {
      width: 100%;
      height: auto;
      display: block;
      background: #ffffff;
    }

    .page-screenshot-canvas {
      display: none;
    }

    .page-screenshot-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 5px 12px;
      border-radius: 999px;
      font-family: var(--font-sans);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: rgba(10, 12, 22, 0.72);
      color: var(--accent-secondary);
      border: 1px solid rgba(196, 164, 95, 0.38);
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.40);
    }
    
    .page-canvas {
      display: block;
      max-width: 100%;
      height: auto;
      pointer-events: none;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      image-rendering: high-quality;
      -ms-interpolation-mode: bicubic;
    }
    
    /* ‚îÄ‚îÄ Watermark ‚îÄ‚îÄ */
    .watermark-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px;
    }
    
    .watermark-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      opacity: 0.18;
      transform: rotate(-45deg) translateX(40px);
      width: 120%;
      max-width: none;
    }
    
    .watermark-logo {
      font-family: var(--font-serif);
      font-size: 180px;
      font-weight: 700;
      font-style: italic;
      color: var(--accent-primary);
      letter-spacing: 8px;
      margin: 0;
      line-height: 1;
    }
    
    .watermark-text {
      font-family: var(--font-sans);
      font-size: 42px;
      font-weight: 700;
      color: var(--accent-primary);
      text-align: center;
      line-height: 1.8;
      margin: 0;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    
    .watermark-info {
      display: none;
    }
    
    /* ‚îÄ‚îÄ Loading screen ‚îÄ‚îÄ */
    .loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 40px;
      gap: 20px;
    }
    
    .spinner {
      width: 52px;
      height: 52px;
      border: 3px solid rgba(196, 164, 95, 0.18);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-family: var(--font-sans);
      font-size: 14px;
      color: var(--text-muted);
      font-weight: 500;
      letter-spacing: 0.03em;
    }
    
    /* ‚îÄ‚îÄ Error state ‚îÄ‚îÄ */
    .error-message {
      background: rgba(176, 48, 64, 0.12);
      color: #ffb3bc;
      padding: 24px 32px;
      border-radius: 14px;
      text-align: center;
      margin: 48px;
      border: 1px solid rgba(176, 48, 64, 0.28);
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      font-weight: 500;
      font-family: var(--font-sans);
    }
    
    /* ‚îÄ‚îÄ Zoom controls ‚îÄ‚îÄ */
    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .zoom-level {
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--text-strong);
      font-weight: 600;
      min-width: 56px;
      text-align: center;
      padding: 6px 12px;
      background: rgba(196, 164, 95, 0.07);
      border-radius: 8px;
      border: 1px solid rgba(196, 164, 95, 0.20);
    }
    
    /* ==========================================================================
       RESPONSIVE
       ========================================================================== */
    
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }

      .viewer-header {
        padding: 20px 22px;
      }

      .viewer-header h1 {
        font-size: 20px;
      }

      .viewer-controls {
        padding: 14px 18px;
        flex-direction: column;
        gap: 10px;
      }

      .control-group {
        width: 100%;
        justify-content: space-between;
      }

      .pdf-content {
        padding: 18px 14px;
      }

      .watermark-logo {
        font-size: 100px;
        letter-spacing: 6px;
      }

      .watermark-text {
        font-size: 28px;
      }
    }

    /* ==========================================================================
       PRINT ‚Äî ANTI-PDF-SAVE PROTECTION
       ========================================================================== */
    
    @page {
      size: auto;
      margin: 0;
    }

    /* ==========================================================================
       MEDIA PANEL ‚Äî Study Resources Sidebar
       ========================================================================== */
    .media-panel {
      position: fixed;
      right: -420px;
      top: 80px;
      bottom: 80px;
      width: 400px;
      background: var(--panel-dark);
      border: 1px solid var(--glass-border);
      border-right: none;
      border-radius: 20px 0 0 20px;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      box-shadow: -12px 0 48px rgba(0, 0, 0, 0.55);
      transition: right 0.32s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .media-panel.open {
      right: 0;
    }

    .media-panel-toggle {
      position: fixed;
      right: 28px;
      bottom: 28px;
      width: 58px;
      height: 58px;
      background: var(--panel-dark);
      border: 1px solid rgba(196, 164, 95, 0.40);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 8px 28px rgba(0, 0, 0, 0.45),
        0 0 18px rgba(196, 164, 95, 0.18),
        inset 0 1px 2px rgba(255, 255, 255, 0.06);
      z-index: 999;
      overflow: hidden;
    }

    .media-panel-toggle:hover {
      transform: translateY(-3px);
      border-color: var(--accent-primary);
      box-shadow: 
        0 12px 36px rgba(0, 0, 0, 0.55),
        0 0 28px rgba(196, 164, 95, 0.32),
        inset 0 1px 3px rgba(255, 255, 255, 0.1);
    }

    .media-panel-toggle:active {
      transform: translateY(-1px);
    }

    .media-panel-toggle svg {
      width: 24px;
      height: 24px;
      fill: none;
      stroke: var(--accent-primary);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      position: relative;
      z-index: 1;
      transition: all 0.25s ease;
    }

    .media-panel-toggle:hover svg {
      stroke: var(--accent-secondary);
      transform: scale(1.08);
    }

    .media-panel-header {
      padding: 24px;
      background: linear-gradient(135deg,
        rgba(196, 164, 95, 0.08) 0%,
        rgba(10, 12, 22, 0.40) 100%);
      border-bottom: var(--rule-gold);
    }

    .media-panel-header h3 {
      font-family: var(--font-serif);
      color: var(--accent-secondary);
      font-size: 17px;
      font-weight: 600;
      font-style: italic;
      margin: 0 0 14px 0;
    }

    .media-search-box {
      position: relative;
      width: 100%;
    }

    .media-search-box input {
      width: 100%;
      padding: 10px 38px 10px 14px;
      background: rgba(196, 164, 95, 0.06);
      border: 1px solid rgba(196, 164, 95, 0.25);
      border-radius: 10px;
      color: var(--text-strong);
      font-family: var(--font-sans);
      font-size: 13px;
      transition: all 0.2s ease;
    }

    .media-search-box input::placeholder {
      color: rgba(245, 240, 232, 0.35);
    }

    .media-search-box input:focus {
      outline: none;
      border-color: var(--accent-primary);
      background: rgba(196, 164, 95, 0.10);
      box-shadow: 0 0 0 3px rgba(196, 164, 95, 0.10);
    }

    .media-search-icon {
      position: absolute;
      right: 13px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(245, 240, 232, 0.38);
      font-size: 14px;
      pointer-events: none;
    }

    .media-panel-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .media-panel-content::-webkit-scrollbar {
      width: 6px;
    }

    .media-panel-content::-webkit-scrollbar-track {
      background: rgba(196, 164, 95, 0.04);
      border-radius: 3px;
    }

    .media-panel-content::-webkit-scrollbar-thumb {
      background: rgba(196, 164, 95, 0.28);
      border-radius: 3px;
    }

    .media-item {
      margin-bottom: 20px;
      background: rgba(196, 164, 95, 0.05);
      border: 1px solid rgba(196, 164, 95, 0.18);
      border-radius: 14px;
      padding: 14px;
      transition: all 0.2s ease;
    }

    .media-item:hover {
      background: rgba(196, 164, 95, 0.09);
      border-color: rgba(196, 164, 95, 0.32);
      transform: translateX(-3px);
    }

    .media-item h4 {
      font-family: var(--font-serif);
      color: var(--accent-secondary);
      font-size: 15px;
      font-weight: 600;
      font-style: italic;
      margin: 0 0 10px 0;
    }

    .media-item img, .media-item video {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 10px;
      border: 1px solid rgba(196, 164, 95, 0.18);
    }

    .media-item p {
      color: var(--text-muted);
      font-family: var(--font-sans);
      font-size: 13px;
      line-height: 1.65;
      margin: 0;
    }

    .media-item a {
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .media-item a:hover {
      color: var(--accent-secondary);
      text-decoration: underline;
    }

    /* ‚îÄ‚îÄ Video containers ‚îÄ‚îÄ */
    .protected-video-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      margin-bottom: 10px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(196, 164, 95, 0.20);
      background: rgba(0, 0, 0, 0.4);
    }

    .protected-video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 10px;
      pointer-events: auto;
    }

    .video-unavailable {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-muted);
      font-size: 13px;
      text-align: center;
      padding: 20px;
    }

    .custom-video-player {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      margin-bottom: 10px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(196, 164, 95, 0.25);
      background: rgba(0, 0, 0, 0.9);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .custom-video-player video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }

    .video-controls-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.88), transparent);
      padding: 20px 14px 14px;
      opacity: 0;
      transition: opacity 0.25s ease;
      z-index: 10;
    }

    .custom-video-player:hover .video-controls-overlay,
    .video-controls-overlay.show {
      opacity: 1;
    }

    .video-controls-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .video-play-btn,
    .video-volume-btn,
    .video-settings-btn,
    .video-fullscreen-btn {
      background: rgba(196, 164, 95, 0.18);
      border: 1px solid rgba(196, 164, 95, 0.35);
      border-radius: 8px;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--accent-primary);
      font-size: 16px;
      flex-shrink: 0;
    }

    .video-play-btn:hover,
    .video-volume-btn:hover,
    .video-settings-btn:hover,
    .video-fullscreen-btn:hover {
      background: rgba(196, 164, 95, 0.28);
      border-color: var(--accent-primary);
    }

    .video-settings-btn {
      position: relative;
    }

    .video-progress-container {
      flex: 1;
      height: 5px;
      background: rgba(196, 164, 95, 0.18);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .video-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      width: 0%;
      transition: width 0.1s linear;
      border-radius: 3px;
      position: relative;
    }

    .video-progress-bar::after {
      content: '';
      position: absolute;
      right: -5px;
      top: 50%;
      transform: translateY(-50%);
      width: 10px;
      height: 10px;
      background: var(--accent-primary);
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(196, 164, 95, 0.55);
    }

    .video-time {
      color: var(--text-strong);
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 600;
      min-width: 84px;
      text-align: center;
      flex-shrink: 0;
    }

    .video-settings-menu {
      position: absolute;
      bottom: 48px;
      right: 0;
      background: var(--panel-dark);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 10px;
      min-width: 170px;
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      display: none;
      z-index: 20;
    }

    .video-settings-menu.show {
      display: block;
    }

    .video-settings-option {
      padding: 9px 12px;
      color: var(--text-strong);
      font-family: var(--font-sans);
      font-size: 13px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.18s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .video-settings-option:hover {
      background: rgba(196, 164, 95, 0.12);
    }

    .video-settings-option.active {
      background: rgba(196, 164, 95, 0.18);
      color: var(--accent-primary);
    }

    .video-loading-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
    }

    .video-spinner {
      width: 46px;
      height: 46px;
      border: 3px solid rgba(196, 164, 95, 0.18);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }

    /* ==========================================================================
       CUSTOM ALERT MODAL
       ========================================================================== */
    .custom-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.72);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.25s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .custom-alert-modal {
      background: var(--panel-dark);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 44px 40px 36px;
      max-width: 480px;
      width: 90%;
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      animation: slideUp 0.28s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(24px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .custom-alert-icon {
      font-size: 44px;
      text-align: center;
      margin-bottom: 18px;
    }

    .custom-alert-title {
      font-family: var(--font-serif);
      font-size: 22px;
      font-weight: 600;
      font-style: italic;
      text-align: center;
      margin-bottom: 14px;
      color: var(--accent-secondary);
    }

    .custom-alert-message {
      color: var(--text-muted);
      font-family: var(--font-sans);
      font-size: 15px;
      line-height: 1.75;
      text-align: center;
      margin-bottom: 28px;
    }

    .custom-alert-button {
      background: linear-gradient(135deg,
        rgba(196, 164, 95, 0.90) 0%,
        rgba(212, 184, 122, 0.90) 100%);
      border: none;
      border-radius: 10px;
      padding: 13px 28px;
      color: #0c0f1a;
      font-family: var(--font-sans);
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 0.04em;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s ease;
      box-shadow: 0 4px 14px rgba(196, 164, 95, 0.28);
    }

    .custom-alert-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 22px rgba(196, 164, 95, 0.42);
    }

    .custom-alert-button:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="viewer-container">
    <div class="viewer-header">
      <div>
        <h1 id="noteTitle">Loading note...</h1>
        <div class="student-name" id="studentName"></div>
      </div>
      <div class="viewer-header-brand">ARNOMA</div>
    </div>
    
    <div class="viewer-controls" id="viewerControls" style="display: none;">
      <div class="control-group">
        <button class="control-btn" id="prevPage" onclick="changePage(-1)">‚óÄ Previous</button>
        <span class="page-info">
          Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <button class="control-btn" id="nextPage" onclick="changePage(1)">Next ‚ñ∂</button>
      </div>
      
      <div class="control-group">
        <div class="zoom-controls">
          <button class="control-btn" onclick="changeZoom(-0.1)">-</button>
          <span class="zoom-level" id="zoomLevel">150%</span>
          <button class="control-btn" onclick="changeZoom(0.1)">+</button>
        </div>
  <button class="control-btn print-btn" id="printButton" onclick="printNote()">üñ®Ô∏è Print</button>
      </div>
    </div>
    
    <div class="pdf-content" id="pdfContent">
      <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingStatus">Preparing your notes...</div>
      </div>
    </div>
  </div>

  <!-- Floating Media Button -->
  <button class="media-panel-toggle" id="mediaPanelToggle" onclick="toggleMediaPanel()" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
      <circle cx="12" cy="13" r="4"></circle>
    </svg>
  </button>

  <!-- Media Panel -->
  <div class="media-panel" id="mediaPanel">
    <div class="media-panel-header">
      <h3>üìö Study Resources</h3>
      <div class="media-search-box">
        <input 
          type="text" 
          id="mediaSearchInput" 
          placeholder="Search resources..." 
          oninput="filterMediaItems()"
        >
        <span class="media-search-icon">üîç</span>
      </div>
    </div>
    <div class="media-panel-content" id="mediaPanelContent">
      <!-- Media items will be loaded here -->
    </div>
  </div>

  <script>
    // ============================================================
    // CONSOLE PROTECTION - Filter out Drive URL leaks
    // ============================================================
    
    (function() {
      const originalError = console.error;
      const originalWarn = console.warn;
      const originalLog = console.log;
      
      // Keywords that indicate Drive/video URL exposure
      const blockedPatterns = [
        /drive\.google\.com/i,
        /youtube\.com/i,
        /youtu\.be/i,
        /allow-popups/i,
        /sandboxed frame/i,
        /file\/d\//i,
        /\?t=/i
      ];
      
      function shouldBlock(args) {
        const message = args.join(' ');
        return blockedPatterns.some(pattern => pattern.test(message));
      }
      
      console.error = function(...args) {
        if (!shouldBlock(args)) {
          originalError.apply(console, args);
        }
      };
      
      console.warn = function(...args) {
        if (!shouldBlock(args)) {
          originalWarn.apply(console, args);
        }
      };
      
      console.log = function(...args) {
        if (!shouldBlock(args)) {
          originalLog.apply(console, args);
        }
      };
    })();
    
    // ============================================================
    // SUPABASE CONFIGURATION
    // ============================================================
    
    const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================================
    // PAYMENT ELIGIBILITY HELPERS
    // Mirrors Calendar-NEW.html green dot logic exactly.
    // A student who shows a green dot on Calendar for a given date
    // MUST be allowed to open notes for that date here.
    // ============================================================

    /**
     * Normalizes any date-like value to YYYY-MM-DD.
     * Identical to Calendar-NEW.html normalizeDateString().
     */
    function normalizeDateString(value) {
      if (!value) return null;
      const str = String(value).trim();
      if (!str || str === 'null' || str === 'NULL') return null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
      if (str.includes('T')) return str.split('T')[0];
      const sep = str.includes('/') ? '/' : str.includes('-') ? '-' : null;
      if (sep) {
        const parts = str.split(sep).map(p => p.trim());
        if (parts.length === 3) {
          if (parts[0].length === 4) return `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
          if (parts[2].length === 4) return `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
        }
      }
      return str;
    }

    /**
     * Extracts all class dates covered by a payment record.
     * Identical to Calendar-NEW.html extractForClassDates().
     * Priority: for_class_dates ‚Üí for_class ‚Üí fallbackDate (record.date)
     */
    function extractForClassDates(record, fallbackDate) {
      if (!record) return [];
      let rawDates = record.for_class_dates != null ? record.for_class_dates
                   : record.for_class != null       ? record.for_class
                   : [];
      if (typeof rawDates === 'string') {
        const trimmed = rawDates.trim();
        if (!trimmed || trimmed === '[]' || trimmed === '{}' || trimmed === 'null') {
          rawDates = [];
        } else if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
          rawDates = trimmed.slice(1,-1).split(',').map(d=>d.trim()).filter(d=>d&&d!=='null');
        } else {
          try { rawDates = JSON.parse(trimmed); }
          catch(e) { rawDates = trimmed.split(',').map(d=>d.trim()); }
        }
      }
      if (rawDates && !Array.isArray(rawDates) && typeof rawDates === 'object') rawDates = Object.values(rawDates);
      if (!Array.isArray(rawDates)) rawDates = rawDates ? [rawDates] : [];
      const normalized = rawDates
        .map(entry => {
          if (!entry || entry === 'null' || entry === 'NULL') return '';
          if (typeof entry === 'object') return entry.class_date||entry.date||entry.for_class||entry.classDate||entry.value||'';
          return String(entry).trim();
        })
        .map(e => normalizeDateString(e))
        .filter(Boolean);
      if (normalized.length === 0 && fallbackDate) {
        const fb = normalizeDateString(fallbackDate);
        return fb ? [fb] : [];
      }
      return normalized;
    }

    /**
     * Builds the complete set of paid class dates for a student from all payment sources.
     * Returns the same set of dates that Calendar-NEW shows as green dots.
     *
     * @param {Array} manualPayments  - Rows from payment_records (status='paid')
     * @param {Array} autoPayments    - Rows from payments table (Zelle/Venmo)
     * @param {Array} creditPayments  - Rows from credit_payments table
     * @returns {Set<string>} YYYY-MM-DD dates the student has paid for
     */
    function buildPaidDatesSetFromSources(manualPayments, autoPayments, creditPayments) {
      const paidDates = new Set();

      // Manual payment_records ‚Äî expand for_class_dates array
      (manualPayments || []).forEach(p => {
        extractForClassDates(p, p.date).forEach(d => paidDates.add(d));
      });

      // Automated payments (Zelle/Venmo) ‚Äî expand for_class_dates array
      (autoPayments || []).forEach(p => {
        extractForClassDates(p, p.date).forEach(d => paidDates.add(d));
      });

      // Credit payments ‚Äî single class_date per row
      (creditPayments || []).forEach(p => {
        if (p.class_date) {
          const d = normalizeDateString(p.class_date);
          if (d) paidDates.add(d);
        }
      });

      return paidDates;
    }
    
    // ============================================================
    // PDF.js CONFIGURATION
    // ============================================================
    
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // ============================================================
    // VERSION & DEBUG
    // ============================================================
    
    const VIEWER_VERSION = 'v2.1.0-signed-urls';
    console.log('üîµ PDF Viewer Version:', VIEWER_VERSION);
    console.log('üìÖ Loaded at:', new Date().toISOString());
    
    // ============================================================
    // GLOBAL VARIABLES
    // ============================================================
    
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let zoomLevel = 1.5; // 150% initial zoom
    let currentStudent = null;
    let fallbackStudent = null;
    let noteData = null;
    let currentLoadingMessage = 'Preparing your notes...';
    let isPreparingPrint = false;

    // Page render cache: key = `${pageNum}_${zoomLevel}`, value = pageContainer DOM node
    const pageRenderCache = new Map();

    // ============================================================
    // PRINT DEBUGGING HELPERS (toggle via console)
    // ============================================================
    window.ARNOMA_PRINT_DEBUG = window.ARNOMA_PRINT_DEBUG === true;
    window.enablePrintDebug = () => {
      window.ARNOMA_PRINT_DEBUG = true;
      console.info('%cARNOMA print debug ENABLED. The next print job will keep the preview iframe so you can inspect layout.', 'color:#10b981;font-weight:600;');
    };
    window.disablePrintDebug = () => {
      window.ARNOMA_PRINT_DEBUG = false;
      console.info('%cARNOMA print debug DISABLED. Print flow will clean up as normal.', 'color:#f97316;font-weight:600;');
    };
    window.inspectPrintFrame = () => {
      if (!window.__arnomaLastPrintFrame) {
        console.error('%c‚ùå No print frame found. Enable debug mode with window.enablePrintDebug() then print again.', 'color:#ef4444;font-weight:600;');
        return;
      }
      const frameDoc = window.__arnomaLastPrintFrame.contentDocument;
      const pages = frameDoc.querySelectorAll('.print-page');
      console.group('%cüîç Print Frame Inspection', 'color:#f59e0b;font-weight:700;font-size:14px;');
      pages.forEach((page, i) => {
        const img = page.querySelector('img');
        const overlays = page.querySelectorAll('.watermark-overlay');
        console.log(`\nüìÑ Page ${i+1}:`);
        console.log('  Container:', {
          computedHeight: getComputedStyle(page).height,
          offsetHeight: page.offsetHeight + 'px',
          scrollHeight: page.scrollHeight + 'px',
          clientHeight: page.clientHeight + 'px'
        });
        console.log('  Image:', img ? {
          naturalWidth: img.naturalWidth + 'px',
          naturalHeight: img.naturalHeight + 'px',
          displayWidth: img.offsetWidth + 'px',
          displayHeight: img.offsetHeight + 'px'
        } : '‚ùå MISSING');
        console.log('  Watermarks:', overlays.length, 'overlays found');
      });
      console.groupEnd();
    };

    function updateLoadingStatus(message) {
      currentLoadingMessage = message;
      const statusEl = document.getElementById('loadingStatus');
      if (statusEl) {
        statusEl.textContent = message;
      }
    }

    function showLoadingScreen(message = currentLoadingMessage) {
      updateLoadingStatus(message);
      const loadingEl = document.getElementById('loadingScreen');
      if (loadingEl) {
        loadingEl.style.display = 'flex';
      }
    }

    function hideLoadingScreen() {
      const loadingEl = document.getElementById('loadingScreen');
      if (loadingEl) {
        loadingEl.style.display = 'none';
      }
    }

    const getStudentDisplayName = () => {
      return (currentStudent && currentStudent.name) || (fallbackStudent && fallbackStudent.name) || 'Authorized Student';
    };

    const getStudentDisplayGroup = () => {
      return (currentStudent && (currentStudent.group || currentStudent.group_name)) || (fallbackStudent && (fallbackStudent.group || fallbackStudent.group_name)) || 'N/A';
    };
    
    // ============================================================
    // DISABLE COPY/DOWNLOAD PROTECTION - ENHANCED
    // ============================================================
    
    // Disable right-click completely
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }, true);
    
    // Disable ALL keyboard shortcuts for save/copy/inspect
    document.addEventListener('keydown', (e) => {
      // Disable save shortcuts
      if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable copy shortcuts
      if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable select all
      if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'A')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable print shortcut (we have our own)
      if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
        e.preventDefault();
        e.stopPropagation();
        printNote(); // Use our protected print instead
        return false;
      }
      
      // Disable DevTools shortcuts
      if (e.key === 'F12' || 
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'i')) ||
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'J' || e.key === 'j')) ||
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'C' || e.key === 'c')) ||
          ((e.ctrlKey || e.metaKey) && (e.key === 'u' || e.key === 'U'))) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);
    
    // Disable text selection via mouse
    document.addEventListener('selectstart', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Disable drag-and-drop
    document.addEventListener('dragstart', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Disable copy event
    document.addEventListener('copy', (e) => {
      e.preventDefault();
      e.clipboardData.setData('text/plain', '');
      return false;
    }, true);
    
    // Disable cut event
    document.addEventListener('cut', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Monitor for DevTools (basic detection)
    let devtoolsOpen = false;
    const detectDevTools = () => {
      const threshold = 160;
      if (window.outerWidth - window.innerWidth > threshold || 
          window.outerHeight - window.innerHeight > threshold) {
        if (!devtoolsOpen) {
          devtoolsOpen = true;
          showCustomAlert();
        }
      } else {
        devtoolsOpen = false;
      }
    };
    setInterval(detectDevTools, 3000);
    
    // ============================================================
    // INITIALIZATION
    // ============================================================
    
    (async function init() {
      try {
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const pdfUrl = urlParams.get('url');
        const noteTitle = urlParams.get('title') || 'Class Notes';
        const noteId = urlParams.get('note'); // Legacy support
        const studentName = urlParams.get('studentName'); // Passed from portal
        const studentGroup = urlParams.get('studentGroup'); // Passed from portal
        const studentIdParam = urlParams.get('studentId');
        const classDateOverride = urlParams.get('classDate'); // üî• Group-specific post date from portal
        const parsedStudentId = studentIdParam && !Number.isNaN(Number(studentIdParam))
          ? Number(studentIdParam)
          : null;
        const urlGroupLetter = studentGroup
          ? studentGroup.toString().trim().toUpperCase().replace(/^GROUP\s*/i, '').charAt(0)
          : null;
        
        if (!pdfUrl && !noteId) {
          showError('No note specified');
          return;
        }
        
        // Check if student info was passed via URL (for impersonation or direct links)
        if (studentName) {
          fallbackStudent = {
            id: parsedStudentId || undefined,
            name: studentName,
            group_name: studentGroup,
            group: studentGroup,
            group_letter: urlGroupLetter || undefined
          };
          currentStudent = fallbackStudent;
        }
        
        // Check authentication (support both regular auth and impersonation)
        // First check for impersonation token (if student info wasn't passed via URL)
        if (!currentStudent || !currentStudent.id) {
          const impersonationToken = sessionStorage.getItem('impersonation_token');
        if (impersonationToken) {
          try {
            const tokenData = JSON.parse(impersonationToken);
            const { data: student, error: studentError } = await supabaseClient
              .from('students')
              .select('*')
              .eq('id', tokenData.studentId)
              .single();              if (student && !studentError) {
                currentStudent = student;
              }
            } catch (e) {
              console.error('Error reading impersonation token:', e);
            }
          }
        }
        
        // If no impersonation, check regular auth session
        if (!currentStudent || !currentStudent.id) {
          const { data: { session }, error: authError } = await supabaseClient.auth.getSession();
          
          if (authError || !session) {
            showError('Please log in to view this note');
            window.location.href = 'index.html';
            return;
          }
          
          // Get current student data by email ‚Äî fire immediately after session resolves
          const { data: student, error: studentError } = await supabaseClient
            .from('students')
            .select('*')
            .eq('email', session.user.email)
            .single();
          
          if (studentError || !student) {
            showError('Student profile not found');
            return;
          }
          
          currentStudent = student;
        }
        
        if (!currentStudent) {
          showError('Student profile not found');
          return;
        }
  document.getElementById('studentName').textContent = getStudentDisplayName();
        document.getElementById('noteTitle').textContent = noteTitle.replace(/\.pdf$/i, '');
        
        // Create mock note data for watermarking
        noteData = {
          title: noteTitle,
          class_date: new Date().toISOString()
        };
        
        // If URL provided directly (from new group notes system)
        if (pdfUrl) {
          document.getElementById('viewerControls').style.display = 'flex';
        showMediaPanelToggle();
          
          // CRITICAL: Fetch note data from database to verify group access
          if (noteId) {
            try {
              updateLoadingStatus('Locating note details...');
              const { data: note, error: noteError } = await supabaseClient
                .from('student_notes')
                .select('*')
                .eq('id', noteId)
                .single();
              
              if (noteError || !note) {
                console.error('Note not found in database:', noteError);
                showError('‚ùå Note not found in database');
                return;
              }
              
              // ============================================================
              // GROUP ACCESS VALIDATION - CRITICAL SECURITY CHECK
              // ============================================================
              
              // Normalize student's group (handle group_letter, group_name, group)
              const studentGroup = (
                currentStudent.group_letter || 
                currentStudent.group_name || 
                currentStudent.group || 
                ''
              ).toString().trim().toUpperCase().replace(/^GROUP\s*/i, '');
              const normalizedGroupName = studentGroup ? `Group ${studentGroup}` : '';
              
              updateLoadingStatus('Confirming group permissions...');
              console.log('üîê Group Access Check:');
              console.log('  Student Group:', studentGroup);
              console.log('  Student ID:', currentStudent.id);
              console.log('  Note ID:', noteId);
              
              // Check if student has access via note_free_access table
              // Fire free-access + both permission queries in parallel
              const orConditions = [];
              if (studentGroup) orConditions.push(`group_letter.eq.${studentGroup}`);
              if (currentStudent.id) orConditions.push(`student_id.eq.${currentStudent.id}`);

              let freeAccessQuery = supabaseClient
                .from('note_free_access')
                .select('*')
                .eq('note_id', noteId);
              if (orConditions.length > 0) freeAccessQuery = freeAccessQuery.or(orConditions.join(','));

              const individualPermQuery = currentStudent.id
                ? supabaseClient
                    .from('student_note_permissions')
                    .select('id, student_id, group_name, is_accessible')
                    .eq('note_id', noteId)
                    .eq('student_id', currentStudent.id)
                    .eq('is_accessible', true)
                : Promise.resolve({ data: [], error: null });

              const groupPermQuery = normalizedGroupName
                ? supabaseClient
                    .from('student_note_permissions')
                    .select('id, student_id, group_name, is_accessible')
                    .eq('note_id', noteId)
                    .is('student_id', null)
                    .eq('group_name', normalizedGroupName)
                    .eq('is_accessible', true)
                : Promise.resolve({ data: [], error: null });

              const [
                { data: accessGrants, error: accessError },
                individualResult,
                groupResult
              ] = await Promise.all([freeAccessQuery, individualPermQuery, groupPermQuery]);

              if (accessError) {
                console.error('‚ùå Error checking note access:', accessError);
                showError('‚ùå Error checking note access permissions');
                return;
              }

              const permissionErrors = [individualResult?.error, groupResult?.error].filter(Boolean);
              if (permissionErrors.length > 0) {
                console.error('‚ùå Permission verification failed:', permissionErrors[0]);
                showError('‚ùå Error checking note access permissions');
                return;
              }

              const permissionGrants = [...(individualResult?.data || []), ...(groupResult?.data || [])];
              const hasPermissionAccess = permissionGrants.length > 0;
              
              const hasFreeAccess = Array.isArray(accessGrants) && accessGrants.length > 0;
              
              // If no access grants found, deny access
              if (!hasFreeAccess && !hasPermissionAccess) {
                console.error('‚ùå No access granted! Student:', studentGroup, 'Note ID:', noteId);
                showError(`üö´ Access Denied: You don't have permission to view this note.`);
                return;
              }
              
              console.log('‚úÖ Group access verified:', {
                freeAccessGrants: accessGrants?.length || 0,
                permissionGrants: permissionGrants.length
              });
              
              // üîí NOTE: video_allowed_groups check is handled in loadMediaContent()
              // The note PDF is always accessible if student has free/permission access
              // But videos are blocked if: (1) note is free OR (2) student not in video_allowed_groups
              
              // Check if note requires payment (FREE access overrides payment enforcement)
              if (note.requires_payment && !hasFreeAccess) {
                // Use group-specific date from URL if provided, else note.class_date
                const checkDate = classDateOverride || (note.class_date ? note.class_date.split('T')[0] : null);
                console.log('üí≥ Checking payment for class date:', checkDate,
                  '| source:', classDateOverride ? 'URL (group-specific)' : 'note.class_date');

                // ‚úÖ CALENDAR-MIRRORED: Load ALL three payment sources and expand for_class_dates,
                // exactly as Calendar-NEW does when computing green dots. Any student with a green
                // dot on Calendar-NEW for this date will have that date in paidDates here.
                updateLoadingStatus('Confirming payment status...');
                const [manualResult, autoResult, creditResult] = await Promise.all([
                  supabaseClient
                    .from('payment_records')
                    .select('date, for_class_dates, for_class, status')
                    .eq('student_id', currentStudent.id)
                    .eq('status', 'paid'),
                  supabaseClient
                    .from('payments')
                    .select('date, for_class_dates, for_class')
                    .or(`student_id.eq.${currentStudent.id},linked_student_id.eq.${currentStudent.id}`),
                  supabaseClient
                    .from('credit_payments')
                    .select('class_date')
                    .eq('student_id', currentStudent.id)
                ]);

                const manualPayments = manualResult?.data || [];
                const autoPayments   = autoResult?.data  || [];
                const creditPayments = creditResult?.data || [];

                // Build paidDates using the same extractForClassDates logic as Calendar-NEW
                const paidDates = buildPaidDatesSetFromSources(manualPayments, autoPayments, creditPayments);

                console.log('üí∞ Payment sources (Calendar-mirrored):', {
                  manual: manualPayments.length,
                  auto:   autoPayments.length,
                  credit: creditPayments.length,
                  totalPaidDates: paidDates.size,
                  paidDates: Array.from(paidDates).sort()
                });

                // Primary: exact date match (student has green dot for this specific class)
                const hasPaidForThisDate = checkDate ? paidDates.has(checkDate) : false;

                // Fallback: note was explicitly posted to student's group (hasPermissionAccess)
                // AND student has ANY paid date at all ‚Äî i.e. they are a paying student.
                // This handles notes where the stored class_date doesn't precisely align
                // with a payment date (e.g. older records without class_date, or date
                // discrepancy between note posting and payment entry).
                const hasAnyPayment  = paidDates.size > 0;
                const hasPaidAccess  = hasPaidForThisDate || (hasPermissionAccess && hasAnyPayment);

                console.log('ÔøΩ Access decision:', {
                  checkDate,
                  hasPaidForThisDate,
                  hasPermissionAccess,
                  hasAnyPayment,
                  hasPaidAccess
                });

                if (!hasPaidAccess) {
                  console.error('‚ùå Payment required but not found for date:', checkDate);
                  showError('üîí This note is locked. Payment is required to access these notes.');
                  return;
                }
                console.log('‚úÖ Payment verified:', hasPaidForThisDate
                  ? `exact date match (${checkDate})`
                  : 'any-payment fallback (permission-based access)');
              } else if (note.requires_payment && hasFreeAccess) {
                console.log('üÜì FREE ACCESS: skipping payment check for note', noteId);
              }
              
              // Determine how the student gained access (paid vs free)
              const accessMode = note.requires_payment
                ? (hasFreeAccess ? 'free-grant' : 'paid')
                : 'free-note';

              // Store full note data (include access mode for media rules)
              noteData = {
                ...noteData,
                ...note,
                video_url: note.video_url,
                video_allowed_groups: note.video_allowed_groups,
                video_controls: note.video_controls,
                video_title: note.video_title,
                title: note.title,
                accessMode,
                hasFreeAccess,
                hasPermissionAccess
              };
              
            } catch (e) {
              console.error('Error validating note access:', e);
              showError('Failed to validate access to this note');
              return;
            }
          } else {
            // No noteId provided - can't validate group access
            console.warn('‚ö†Ô∏è No noteId provided - skipping group validation');
          }
          
          // Check if it's a storage path or a full URL
          // Fire media panel load in parallel with PDF load ‚Äî media panel DB query
          // does NOT need the PDF to be rendered; they are fully independent.
          const mediaContentPromise = loadMediaContent();
          if (pdfUrl.startsWith('http://') || pdfUrl.startsWith('https://')) {
            // It's already a full URL, use it directly
            showLoadingScreen('Fetching note...');
            await loadPDFFromURL(pdfUrl);
          } else {
            // It's a storage path, create signed URL from student-notes bucket
            showLoadingScreen('Fetching note...');
            await loadPDFFromStorage(pdfUrl);
          }
          // Await media in case it errored (errors are handled internally)
          await mediaContentPromise;
          return;
        }
        
        // Legacy: Load from student_notes table
        if (noteId) {
          const { data: note, error: noteError } = await supabaseClient
            .from('student_notes')
            .select('*')
            .eq('id', noteId)
            .single();
          
          if (noteError || !note) {
            showError('Note not found');
            return;
          }
          
          noteData = note;
          
          // ============================================================
          // GROUP ACCESS VALIDATION - CRITICAL SECURITY CHECK
          // ============================================================
          
          // Normalize student's group (handle group_letter, group_name, group)
          const studentGroup = (
            currentStudent.group_letter || 
            currentStudent.group_name || 
            currentStudent.group || 
            ''
          ).toString().trim().toUpperCase().replace(/^GROUP\s*/i, '');
          
          // Normalize note's group (handle group_letter, group_name, group)
          const noteGroup = (
            note.group_letter || 
            note.group_name || 
            note.group || 
            ''
          ).toString().trim().toUpperCase().replace(/^GROUP\s*/i, '');
          
          console.log('üîê Group Access Check (Legacy):');
          console.log('  Student Group:', studentGroup);
          console.log('  Note Group:', noteGroup);
          
          // Verify student is in the correct group
          if (noteGroup && studentGroup !== noteGroup) {
            console.error('‚ùå Group mismatch! Student:', studentGroup, 'Note:', noteGroup);
            showError(`üö´ Access Denied: This note is for Group ${noteGroup}. You are in Group ${studentGroup}.`);
            return;
          }
          
          console.log('‚úÖ Group access verified (legacy path)');
          
          // Check if note requires payment (legacy path ‚Äî uses same Calendar-mirrored helpers)
          if (note.requires_payment) {
            const legacyCheckDate = note.class_date ? note.class_date.split('T')[0] : null;
            const [lgManual, lgAuto, lgCredit] = await Promise.all([
              supabaseClient
                .from('payment_records')
                .select('date, for_class_dates, for_class, status')
                .eq('student_id', currentStudent.id)
                .eq('status', 'paid'),
              supabaseClient
                .from('payments')
                .select('date, for_class_dates, for_class')
                .or(`student_id.eq.${currentStudent.id},linked_student_id.eq.${currentStudent.id}`),
              supabaseClient
                .from('credit_payments')
                .select('class_date')
                .eq('student_id', currentStudent.id)
            ]);
            const legacyPaidDates = buildPaidDatesSetFromSources(
              lgManual?.data || [], lgAuto?.data || [], lgCredit?.data || []
            );
            const legacyPaid = legacyCheckDate
              ? legacyPaidDates.has(legacyCheckDate)
              : legacyPaidDates.size > 0;

            if (!legacyPaid) {
              showError('üîí This note is locked. Payment is required to access these notes.');
              return;
            }
          }
          
          document.getElementById('noteTitle').textContent = (note.title || 'Class Notes').replace(/\.pdf$/i, '');
          await loadPDF(note.pdf_url);
          
          // Load media content (videos) for this note
          await loadMediaContent();
        }
        
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to load note: ' + error.message);
      }
    })();
    
    // ============================================================
    // PDF LOADING & RENDERING
    // ============================================================
    
    async function loadPDFFromURL(pdfUrl) {
      try {
  showLoadingScreen('Connecting to secure PDF...');
        
        console.log('üîó Loading PDF from URL:', pdfUrl);
        
        // Load PDF directly from URL
        const loadingTask = pdfjsLib.getDocument({
          url: pdfUrl,
          withCredentials: false
        });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        
        // Update UI
  document.getElementById('totalPages').textContent = totalPages;
  hideLoadingScreen();
        document.getElementById('viewerControls').style.display = 'flex';
        showMediaPanelToggle();
        
        // Render first page
        await renderPage(1);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF: ' + error.message);
      }
    }
    
    async function loadPDFFromStorage(pdfPath) {
      try {
        console.log('üîç Loading PDF from storage path:', pdfPath);
        console.log('üóÇÔ∏è Bucket: student-notes');
        console.log('üìç Full storage reference: student-notes/' + pdfPath);
        
        if (!pdfPath || typeof pdfPath !== 'string' || pdfPath.trim() === '') {
          throw new Error('Invalid PDF path provided');
        }
        
  showLoadingScreen('Building secure link to storage...');
        
        // Get public URL (bucket is public)
        const { data: publicUrlData, error: urlError } = supabaseClient.storage
          .from('student-notes')
          .getPublicUrl(pdfPath);
        
        if (urlError) {
          console.error('‚ùå Error generating public URL:', urlError);
          throw new Error(`Failed to generate URL: ${urlError.message || 'Unknown error'}`);
        }
        
        if (!publicUrlData || !publicUrlData.publicUrl) {
          throw new Error('Public URL was not generated');
        }
        
        const pdfUrl = publicUrlData.publicUrl;
        console.log('‚úÖ Created public URL for:', pdfPath);
        console.log('üîó URL:', pdfUrl);
        
        // Load PDF from public URL
        const loadingTask = pdfjsLib.getDocument({
          url: pdfUrl,
          withCredentials: false,
          // Add error handling for PDF.js loading
          httpHeaders: {},
          withCredentials: false,
          isEvalSupported: false,
          cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
          cMapPacked: true,
          rangeChunkSize: 262144,
          useSystemFonts: true,
          useWorkerFetch: true,
          disableAutoFetch: false,
          disableStream: false
        });
        
        // Handle PDF.js specific loading errors
        loadingTask.onProgress = function(progressData) {
          const percent = Math.round((progressData.loaded / progressData.total) * 100);
          updateLoadingStatus(`Decrypting and securing note... ${percent}%`);
          console.log(`Loading PDF: ${percent}%`);
        };
        
        pdfDoc = await loadingTask.promise;
        
        if (!pdfDoc) {
          throw new Error('PDF document failed to load');
        }
        
        totalPages = pdfDoc.numPages;
        
        if (!totalPages || totalPages < 1) {
          throw new Error('Invalid PDF: No pages found');
        }
        
        // Update UI
  document.getElementById('totalPages').textContent = totalPages;
  hideLoadingScreen();
        document.getElementById('viewerControls').style.display = 'flex';
        showMediaPanelToggle();
        
        // Render first page
        await renderPage(1);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF: ' + error.message + '. Please ensure the file exists in storage.');
      }
    }
    
    async function loadPDF(pdfPath) {
      try {
        console.log('üîç Loading PDF from storage path (legacy):', pdfPath);
        
        // Try signed URL first
        await loadPDFFromStorage(pdfPath);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF. The file may not exist in storage. Please contact your administrator.');
      }
    }
    
    async function renderPage(pageNum) {
      try {
        // Validate inputs
        if (!pdfDoc) {
          throw new Error('PDF document not loaded');
        }
        
        if (!pageNum || pageNum < 1 || pageNum > totalPages) {
          throw new Error(`Invalid page number: ${pageNum}. Valid range: 1-${totalPages}`);
        }

        // ‚îÄ‚îÄ Cache lookup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const cacheKey = `${pageNum}_${zoomLevel}`;
        const cached = pageRenderCache.get(cacheKey);
        if (cached) {
          const content = document.getElementById('pdfContent');
          content.innerHTML = '';
          content.appendChild(cached.cloneNode(true));
          currentPage = pageNum;
          document.getElementById('currentPage').textContent = currentPage;
          document.getElementById('prevPage').disabled = currentPage === 1;
          document.getElementById('nextPage').disabled = currentPage === totalPages;
          return;
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const page = await pdfDoc.getPage(pageNum);
        if (!page) {
          throw new Error(`Failed to load page ${pageNum}`);
        }
        
        // High-quality rendering: 3x scale for retina displays
        const scale = zoomLevel * 3.0;
        const viewport = page.getViewport({ scale: scale });
        
        if (!viewport) {
          throw new Error('Failed to create viewport');
        }
        
        // Create canvas for this page
        const canvas = document.createElement('canvas');
        canvas.className = 'page-canvas';
        const context = canvas.getContext('2d');
        
        if (!context) {
          throw new Error('Failed to get canvas context');
        }
        
        // Set high-resolution canvas dimensions
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        // Scale down display size while maintaining quality
        canvas.style.width = (viewport.width / 3) + 'px';
        canvas.style.height = (viewport.height / 3) + 'px';
        
        // Render PDF page with high quality
        const renderTask = page.render({
          canvasContext: context,
          viewport: viewport
        });
        
        await renderTask.promise;
        
        // Create page container with watermark
        const pageContainer = document.createElement('div');
        pageContainer.className = 'page-container';
        
        // Add watermark overlay with ARNOMA logo and student info
        const studentNameSafe = escapeHtml(getStudentDisplayName());
        const studentGroupSafe = escapeHtml(getStudentDisplayGroup());
        const watermark = document.createElement('div');
        watermark.className = 'watermark-overlay';
        watermark.innerHTML = `
          <div class="watermark-content">
            <div class="watermark-logo">ARNOMA</div>
            <div class="watermark-text">
              ${studentNameSafe}<br>
              Group ${studentGroupSafe}
            </div>
          </div>
        `;
        
        pageContainer.appendChild(canvas);
        pageContainer.appendChild(watermark);

        // Store in render cache (cap at 20 entries to avoid memory pressure)
        const cacheKey2 = `${pageNum}_${zoomLevel}`;
        if (pageRenderCache.size >= 20) {
          pageRenderCache.delete(pageRenderCache.keys().next().value);
        }
        pageRenderCache.set(cacheKey2, pageContainer.cloneNode(true));
        
        // Clear and add to content
        const content = document.getElementById('pdfContent');
        content.innerHTML = '';
        content.appendChild(pageContainer);
        
        // Update page number
        currentPage = pageNum;
        document.getElementById('currentPage').textContent = currentPage;
        
        // Update button states
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
        
      } catch (error) {
        console.error('Page rendering error:', error);
        showError('Failed to render page: ' + error.message);
      }
    }
    
    // ============================================================
    // NAVIGATION CONTROLS
    // ============================================================
    
    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= totalPages) {
        renderPage(newPage);
      }
    }
    
    function changeZoom(delta) {
      zoomLevel = Math.max(0.5, Math.min(2.5, zoomLevel + delta));
      document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
      pageRenderCache.clear(); // zoom change invalidates all cached renders
      renderPage(currentPage);
    }
    
    // ============================================================
    // PRINT CONSTANTS - DO NOT GUESS DPI
    // ============================================================
    
    const PRINT_DPI = 300;
    const SCREEN_DPI = 96;
    const PRINT_SCALE = PRINT_DPI / 72; // PDF.js uses 72 DPI as base
    const PAGE_SIZE = 'letter'; // or 'A4'
    
    // ============================================================
    // WATERMARK FUNCTION - CANVAS-SAFE
    // ============================================================
    
    function drawWatermark(ctx, w, h, name, group) {
      ctx.save();
      ctx.globalAlpha = 0.22;
      ctx.fillStyle = '#667eea';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      ctx.font = 'bold 140px sans-serif';
      ctx.fillText('ARNOMA', w / 2, h / 2 - 80);

      ctx.font = 'bold 32px sans-serif';
      ctx.fillText(name, w / 2, h / 2 + 10);
      ctx.fillText(`Group ${group}`, w / 2, h / 2 + 50);

      ctx.font = 'bold 20px sans-serif';
      ctx.fillText('NOT FOR REDISTRIBUTION', w / 2, h / 2 + 90);

      // Corners
      ctx.globalAlpha = 0.35;
      ctx.font = 'bold 18px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText('ARNOMA', 20, 30);
      ctx.textAlign = 'right';
      ctx.fillText('ARNOMA', w - 20, 30);
      ctx.fillText('ARNOMA', w - 20, h - 20);
      ctx.textAlign = 'left';
      ctx.fillText('ARNOMA', 20, h - 20);

      ctx.restore();
    }
    
    // ============================================================
    // PRINT FUNCTION - SAFE & STABLE (NO DOM DESTRUCTION)
    // ============================================================
    
    async function printNote() {
      if (isPreparingPrint) return;
      if (!pdfDoc || totalPages === 0) {
        alert('Still preparing this note. Please try printing again in a moment.');
        return;
      }

      await showPrintWarning();

      isPreparingPrint = true;
      const printButton = document.getElementById('printButton');
      const originalButtonLabel = printButton?.innerHTML;

      if (printButton) {
        printButton.disabled = true;
        printButton.innerHTML = 'Preparing‚Ä¶';
      }

      const restoreButtonState = () => {
        if (printButton && originalButtonLabel) {
          printButton.innerHTML = originalButtonLabel;
          printButton.disabled = false;
        }
      };

      try {
        const studentName = escapeHtml(getStudentDisplayName());
        const studentGroup = escapeHtml(getStudentDisplayGroup());

        // 1Ô∏è‚É£ Create iframe (VISIBLE but offscreen with z-index)
        const frame = document.createElement('iframe');
        frame.style.position = 'fixed';
        frame.style.top = '0';
        frame.style.left = '0';
        frame.style.width = '100vw';
        frame.style.height = '100vh';
        frame.style.border = '0';
        frame.style.background = 'white';
        frame.style.zIndex = '-1'; // visible to browser, invisible to user
        document.body.appendChild(frame);

        if (window.ARNOMA_PRINT_DEBUG) {
          frame.style.zIndex = '9999';
          frame.style.background = 'white';
        }

        const doc = frame.contentDocument;
        doc.open();
        doc.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Print</title>
            <style>
              @page { size: ${PAGE_SIZE}; margin: 0.5in; }
              * { -webkit-print-color-adjust: exact; print-color-adjust: exact; box-sizing: border-box; }
              html, body { margin: 0; padding: 0; background: white; width: 100%; height: auto; }
              body { min-height: 100%; width: 100%; }
              .page { margin: 0; padding: 0; width: 100%; }
              img { display: block; margin: 0; padding: 0; width: 100%; height: auto; max-width: 100%; }
            </style>
          </head>
          <body></body>
          </html>
        `);
        doc.close();

        // 2Ô∏è‚É£ Render each page OFFSCREEN (never touches visible viewer)
        for (let i = 1; i <= pdfDoc.numPages; i++) {
          const page = await pdfDoc.getPage(i);

          const viewport = page.getViewport({ scale: PRINT_SCALE });
          const baseViewport = page.getViewport({ scale: 1 });
          const widthInches = baseViewport.width / 72;
          const heightInches = baseViewport.height / 72;
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          canvas.width = viewport.width;
          canvas.height = viewport.height;

          await page.render({ canvasContext: ctx, viewport }).promise;

          // 3Ô∏è‚É£ Draw watermark DIRECTLY INTO CANVAS
          drawWatermark(ctx, canvas.width, canvas.height, studentName, studentGroup);

          // 4Ô∏è‚É£ Convert to image (JPEG = smaller, faster)
          const img = doc.createElement('img');
          img.src = canvas.toDataURL('image/jpeg', 0.95);

          const pageDiv = doc.createElement('div');
          pageDiv.className = 'page';
          pageDiv.appendChild(img);
          doc.body.appendChild(pageDiv);
        }

        // 5Ô∏è‚É£ Wait for layout + paint to complete
        await new Promise(resolve => requestAnimationFrame(() => requestAnimationFrame(resolve)));

        if (window.ARNOMA_PRINT_DEBUG) {
          console.group('%cPrint Debug', 'color:#38bdf8;font-weight:700;');
          console.log('Pages rendered:', pdfDoc.numPages);
          console.log('Print scale:', PRINT_SCALE);
          console.log('Print DPI:', PRINT_DPI);
          console.log('Page size:', PAGE_SIZE);
          console.groupEnd();
        }

        // 6Ô∏è‚É£ Print using native browser dialog
        frame.contentWindow.focus();
        frame.contentWindow.print();

        // 7Ô∏è‚É£ Cleanup after print dialog closes
        const cleanup = () => {
          if (frame.parentNode && !window.ARNOMA_PRINT_DEBUG) {
            document.body.removeChild(frame);
          }
          restoreButtonState();
          isPreparingPrint = false;
        };

        frame.contentWindow.onafterprint = cleanup;
        setTimeout(cleanup, 1000); // Fallback if event doesn't fire
        
      } catch (error) {
        console.error('Print error:', error);
        alert('Failed to prepare this note for printing. Please try again.');
        restoreButtonState();
        isPreparingPrint = false;
      }
    }

    function obfuscateCanvasForPrint(sourceCanvas) {
      try {
        const pixelationFactor = 2.8; // Higher value => more pixelation
        const downscaledWidth = Math.max(1, Math.round(sourceCanvas.width / pixelationFactor));
        const downscaledHeight = Math.max(1, Math.round(sourceCanvas.height / pixelationFactor));
        
        const pixelatedCanvas = document.createElement('canvas');
        pixelatedCanvas.width = downscaledWidth;
        pixelatedCanvas.height = downscaledHeight;
        const pixelCtx = pixelatedCanvas.getContext('2d');
        disableImageSmoothing(pixelCtx);
        pixelCtx.drawImage(sourceCanvas, 0, 0, downscaledWidth, downscaledHeight);
        
        const outputCanvas = document.createElement('canvas');
        outputCanvas.width = sourceCanvas.width;
        outputCanvas.height = sourceCanvas.height;
        const outputCtx = outputCanvas.getContext('2d');
        disableImageSmoothing(outputCtx);
        outputCtx.drawImage(
          pixelatedCanvas,
          0,
          0,
          downscaledWidth,
          downscaledHeight,
          0,
          0,
          outputCanvas.width,
          outputCanvas.height
        );

        applyNoiseOverlay(outputCtx, outputCanvas.width, outputCanvas.height);
        drawMicroGrid(outputCtx, outputCanvas.width, outputCanvas.height);

        return outputCanvas;
      } catch (error) {
        console.warn('Raster obfuscation fallback (canvas locked):', error);
        return sourceCanvas;
      }
    }

    function disableImageSmoothing(ctx) {
      if (!ctx) return;
      ctx.imageSmoothingEnabled = false;
      ctx.mozImageSmoothingEnabled = false;
      ctx.webkitImageSmoothingEnabled = false;
      ctx.msImageSmoothingEnabled = false;
    }

    function applyNoiseOverlay(ctx, width, height) {
      try {
        const noiseTile = 96;
        const noiseCanvas = document.createElement('canvas');
        noiseCanvas.width = noiseTile;
        noiseCanvas.height = noiseTile;
        const noiseCtx = noiseCanvas.getContext('2d');
        const imageData = noiseCtx.createImageData(noiseTile, noiseTile);
        const buffer = imageData.data;
        
        for (let i = 0; i < buffer.length; i += 4) {
          const shade = 215 + Math.floor(Math.random() * 35); // 215-249 range
          buffer[i] = shade;
          buffer[i + 1] = shade;
          buffer[i + 2] = shade;
          buffer[i + 3] = Math.floor(Math.random() * 45); // alpha 0-45
        }
        
        noiseCtx.putImageData(imageData, 0, 0);
        const pattern = ctx.createPattern(noiseCanvas, 'repeat');
        if (pattern) {
          ctx.save();
          ctx.globalAlpha = 0.18;
          ctx.fillStyle = pattern;
          ctx.fillRect(0, 0, width, height);
          ctx.restore();
        }
      } catch (error) {
        console.warn('Noise overlay skipped:', error);
      }
    }

    function drawMicroGrid(ctx, width, height) {
      ctx.save();
      ctx.globalAlpha = 0.08;
      ctx.strokeStyle = 'rgba(15, 23, 42, 0.45)';
      ctx.lineWidth = 0.75;
      const spacing = 12;
      for (let x = 0; x <= width; x += spacing) {
        ctx.beginPath();
        ctx.moveTo(x + 0.5, 0);
        ctx.lineTo(x + 0.5, height);
        ctx.stroke();
      }
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.25)';
      for (let y = 0; y <= height; y += spacing) {
        ctx.beginPath();
        ctx.moveTo(0, y + 0.5);
        ctx.lineTo(width, y + 0.5);
        ctx.stroke();
      }
      ctx.restore();
    }
    
    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================
    
    function escapeHtml(value = '') {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function showError(message) {
      const content = document.getElementById('pdfContent');
      content.innerHTML = `<div class="error-message">${message}</div>`;
    }
    
    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { 
        month: 'long', 
        day: 'numeric', 
        year: 'numeric' 
      });
    }

    // Custom Alert Function
    function showCustomAlert() {
      const studentName = getStudentDisplayName();
      
      const overlay = document.createElement('div');
      overlay.className = 'custom-alert-overlay';
      overlay.innerHTML = `
        <div class="custom-alert-modal">
          <div class="custom-alert-icon">‚ö†Ô∏è</div>
          <div class="custom-alert-title">ATTENTION</div>
          <div class="custom-alert-message">
            This document belongs to <strong>ARNOMA</strong> and is provided exclusively for <strong>${studentName}</strong>.<br><br>
            Kindly respect the copyright and refrain from sharing it with others.<br><br>
            Thank you for your understanding.
          </div>
          <button class="custom-alert-button" onclick="this.closest('.custom-alert-overlay').remove()">
            I Understand
          </button>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      // Close on overlay click
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
    }

    // Print Warning Function - Shows alert and waits for user confirmation
    function showPrintWarning() {
      return new Promise((resolve) => {
        const studentName = getStudentDisplayName();
        
        const overlay = document.createElement('div');
        overlay.className = 'custom-alert-overlay';
        overlay.innerHTML = `
          <div class="custom-alert-modal">
            <div class="custom-alert-icon">‚ö†Ô∏è</div>
            <div class="custom-alert-title">ATTENTION</div>
            <div class="custom-alert-message">
              This document belongs to <strong>ARNOMA</strong> and is provided exclusively for <strong>${studentName}</strong>.<br><br>
              Kindly respect the copyright and refrain from sharing it with others.<br><br>
              Thank you for your understanding.
            </div>
            <button class="custom-alert-button" id="printWarningBtn">
              I Understand
            </button>
          </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Resolve promise and remove overlay when button is clicked
        const button = overlay.querySelector('#printWarningBtn');
        button.addEventListener('click', () => {
          overlay.remove();
          resolve();
        });
        
        // Prevent closing on overlay click for print warning
        overlay.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      });
    }

    // ============================================================
    // MEDIA PANEL FUNCTIONS
    // ============================================================
    
    /**
     * Extract YouTube video ID from various URL formats
     * Supports: youtube.com/watch?v=..., youtu.be/..., youtube.com/embed/...
     * CRITICAL: Never expose the full URL to the student - only use for iframe src
     */
    function extractYouTubeVideoId(url) {
      if (!url) return null;
      
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
        /^([a-zA-Z0-9_-]{11})$/ // Raw video ID
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      
      return null;
    }

    /**
     * Extract Google Drive file ID from various URL formats
     * Supports: drive.google.com/file/d/{id}/view, drive.google.com/open?id={id}
     */
    function extractGoogleDriveFileId(url) {
      if (!url) return null;
      
      const patterns = [
        /\/file\/d\/([a-zA-Z0-9_-]+)/, // /file/d/{fileId}/view or /file/d/{fileId}/edit
        /id=([a-zA-Z0-9_-]+)/, // ?id={fileId}
        /\/open\?id=([a-zA-Z0-9_-]+)/, // /open?id={fileId}
        /^([a-zA-Z0-9_-]{25,})$/ // Raw file ID (typically 25+ chars)
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      
      return null;
    }

    /**
     * Detect video source type (YouTube or Google Drive)
     */
    function detectVideoSource(url) {
      if (!url) return null;
      
      if (url.includes('youtube.com') || url.includes('youtu.be')) {
        return 'youtube';
      }
      
      if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
        return 'googledrive';
      }
      
      // Try to detect by ID pattern
      const youtubeId = extractYouTubeVideoId(url);
      if (youtubeId) return 'youtube';
      
      const driveId = extractGoogleDriveFileId(url);
      if (driveId) return 'googledrive';
      
      return null;
    }

    /**
     * Create a protected YouTube iframe embed
     * MAXIMUM SECURITY:
     * - No URL exposure anywhere (sandboxed iframe)
     * - Custom controls based on admin settings
     * - No right-click, inspect, or dev tools access to URL
     * - Privacy-enhanced mode (youtube-nocookie.com)
     */
    function createProtectedYouTubeEmbed(videoId, title = 'Study Video', controls = null) {
      if (!videoId) {
        return `
          <div class="media-item">
            <h4>üé• ${title}</h4>
            <div class="protected-video-container">
              <div class="video-unavailable">
                ‚ö†Ô∏è Video unavailable<br>
                <small>Invalid video link</small>
              </div>
            </div>
          </div>
        `;
      }
      
      // CRITICAL SECURITY: Use autoplay=1 to skip the red YouTube play button
      // When autoplay is enabled, video starts immediately with NO branding overlay
      // Combined with mute=1, this provides silent autoplay which students can unmute
      
      const embedUrl = `https://www.youtube-nocookie.com/embed/${videoId}?` + 
        'autoplay=1&' +                         // Autoplay to skip red button
        'mute=1&' +                             // Muted autoplay (required by browsers)
        'controls=0&' +                         // ZERO controls = NO YouTube branding
        'rel=0&' +                              // No related videos
        'modestbranding=1&' +                   // Minimal branding
        'showinfo=0&' +                         // No video info
        'fs=0&' +                               // NO fullscreen button
        'disablekb=1&' +                        // NO keyboard shortcuts
        'iv_load_policy=3&' +                   // No annotations
        'playsinline=1&' +                      // Inline playback
        'loop=0&' +                             // No loop
        'enablejsapi=0&' +                      // No JS API access
        'origin=' + window.location.origin;     // Restrict to our domain only
      
      return `
        <div class="media-item">
          <h4>üé• ${title}</h4>
          <div class="protected-video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; pointer-events: auto;">
            <iframe 
              src="${embedUrl}"
              title="Protected Video"
              frameborder="0"
              allow="autoplay; encrypted-media"
              sandbox="allow-scripts allow-same-origin"
              loading="lazy"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; pointer-events: auto;"
              oncontextmenu="return false;"
            ></iframe>
            <!-- Overlay to block YouTube branding that might appear -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 60px; pointer-events: none; z-index: 1;"></div>
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 60px; pointer-events: none; z-index: 1; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);"></div>
          </div>
          <p style="color: var(--accent-primary); font-size: 12px; margin-top: 8px; text-align: center;">
            üîí <strong>Protected ARNOMA Content</strong> - Sharing prohibited<br>
            <small style="opacity: 0.7;">Video starts muted - click to unmute and control</small>
          </p>
        </div>
      `;
    }

    /**
     * Create custom HTML5 video player with Google Drive source
     * MAXIMUM SECURITY & FLEXIBILITY:
     * - Uses signed Supabase URLs (stored from Drive, never exposed)
     * - Complete control over UI (no external branding)
     * - Custom controls (play, pause, volume, speed, quality, fullscreen)
     * - URL never visible to student (blob URLs or signed URLs)
     */
    function createCustomVideoPlayer(videoUrl, title = 'Study Video', videoId = null) {
      const playerId = `video-player-${Date.now()}`;
      
      return `
        <div class="media-item">
          <h4>üé• ${title}</h4>
          <div class="custom-video-player" id="${playerId}-container">
            <video 
              id="${playerId}"
              preload="metadata"
              playsinline
              controlsList="nodownload nofullscreen noremoteplayback"
              disablePictureInPicture
              oncontextmenu="return false;"
            >
              <source src="${videoUrl}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
            
            <div class="video-loading-overlay" id="${playerId}-loading" style="display: none;">
              <div class="video-spinner"></div>
            </div>
            
            <div class="video-controls-overlay" id="${playerId}-controls">
              <div class="video-controls-row">
                <button class="video-play-btn" id="${playerId}-play" onclick="togglePlayPause('${playerId}')">
                  ‚ñ∂Ô∏è
                </button>
                
                <div class="video-progress-container" id="${playerId}-progress-container" onclick="seekVideo(event, '${playerId}')">
                  <div class="video-progress-bar" id="${playerId}-progress"></div>
                </div>
                
                <div class="video-time" id="${playerId}-time">0:00 / 0:00</div>
                
                <button class="video-volume-btn" id="${playerId}-volume" onclick="toggleMute('${playerId}')">
                  üîä
                </button>
                
                <button class="video-settings-btn" id="${playerId}-settings" onclick="toggleSettings('${playerId}')">
                  ‚öôÔ∏è
                  <div class="video-settings-menu" id="${playerId}-settings-menu">
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 0.5)">
                      Speed: 0.5x
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 0.75)">
                      Speed: 0.75x
                    </div>
                    <div class="video-settings-option active" onclick="setPlaybackSpeed('${playerId}', 1)">
                      Speed: 1x ‚úì
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 1.25)">
                      Speed: 1.25x
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 1.5)">
                      Speed: 1.5x
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 2)">
                      Speed: 2x
                    </div>
                  </div>
                </button>
                
                <button class="video-fullscreen-btn" id="${playerId}-fullscreen" onclick="toggleFullscreen('${playerId}')">
                  ‚õ∂
                </button>
              </div>
            </div>
          </div>
          <p style="color: var(--accent-primary); font-size: 12px; margin-top: 8px; text-align: center;">
            üîí <strong>Protected ARNOMA Content</strong> - Sharing prohibited
          </p>
        </div>
      `;
    }

    // Video player control functions
    function togglePlayPause(playerId) {
      const video = document.getElementById(playerId);
      const playBtn = document.getElementById(`${playerId}-play`);
      
      if (video.paused) {
        video.play();
        playBtn.textContent = '‚è∏Ô∏è';
      } else {
        video.pause();
        playBtn.textContent = '‚ñ∂Ô∏è';
      }
    }

    function toggleMute(playerId) {
      const video = document.getElementById(playerId);
      const volumeBtn = document.getElementById(`${playerId}-volume`);
      
      video.muted = !video.muted;
      volumeBtn.textContent = video.muted ? 'üîá' : 'üîä';
    }

    function toggleSettings(playerId) {
      const settingsMenu = document.getElementById(`${playerId}-settings-menu`);
      settingsMenu.classList.toggle('show');
      
      // Close menu when clicking outside
      if (settingsMenu.classList.contains('show')) {
        setTimeout(() => {
          document.addEventListener('click', function closeSettings(e) {
            if (!settingsMenu.contains(e.target) && !e.target.closest(`#${playerId}-settings`)) {
              settingsMenu.classList.remove('show');
              document.removeEventListener('click', closeSettings);
            }
          });
        }, 10);
      }
    }

    function setPlaybackSpeed(playerId, speed) {
      const video = document.getElementById(playerId);
      const settingsMenu = document.getElementById(`${playerId}-settings-menu`);
      
      video.playbackRate = speed;
      
      // Update active state
      settingsMenu.querySelectorAll('.video-settings-option').forEach(opt => {
        opt.classList.remove('active');
        if (opt.textContent.includes(`${speed}x`)) {
          opt.classList.add('active');
          opt.innerHTML = opt.innerHTML.replace('‚úì', '') + ' ‚úì';
        } else {
          opt.innerHTML = opt.innerHTML.replace(' ‚úì', '');
        }
      });
      
      settingsMenu.classList.remove('show');
    }

    function toggleFullscreen(playerId) {
      const container = document.getElementById(`${playerId}-container`);
      
      if (!document.fullscreenElement) {
        if (container.requestFullscreen) {
          container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
          container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
          container.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    }

    function seekVideo(event, playerId) {
      const video = document.getElementById(playerId);
      const progressContainer = document.getElementById(`${playerId}-progress-container`);
      
      const rect = progressContainer.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      const percentage = clickX / rect.width;
      
      video.currentTime = percentage * video.duration;
    }

    function formatVideoTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }

    // Initialize video player event listeners
    function initializeVideoPlayer(playerId) {
      const video = document.getElementById(playerId);
      if (!video) return;
      
      const playBtn = document.getElementById(`${playerId}-play`);
      const progressBar = document.getElementById(`${playerId}-progress`);
      const timeDisplay = document.getElementById(`${playerId}-time`);
      const loadingOverlay = document.getElementById(`${playerId}-loading`);
      const controlsOverlay = document.getElementById(`${playerId}-controls`);
      
      // Show loading spinner
      video.addEventListener('waiting', () => {
        loadingOverlay.style.display = 'block';
      });
      
      video.addEventListener('canplay', () => {
        loadingOverlay.style.display = 'none';
      });
      
      // Update progress bar and time
      video.addEventListener('timeupdate', () => {
        const percentage = (video.currentTime / video.duration) * 100;
        progressBar.style.width = `${percentage}%`;
        
        timeDisplay.textContent = `${formatVideoTime(video.currentTime)} / ${formatVideoTime(video.duration)}`;
      });
      
      // Update play button on play/pause
      video.addEventListener('play', () => {
        playBtn.textContent = '‚è∏Ô∏è';
      });
      
      video.addEventListener('pause', () => {
        playBtn.textContent = '‚ñ∂Ô∏è';
      });
      
      // Show controls on hover or touch
      let controlsTimeout;
      const showControls = () => {
        controlsOverlay.classList.add('show');
        clearTimeout(controlsTimeout);
        controlsTimeout = setTimeout(() => {
          if (!video.paused) {
            controlsOverlay.classList.remove('show');
          }
        }, 3000);
      };
      
      video.addEventListener('mousemove', showControls);
      video.addEventListener('touchstart', showControls);
      
      // Click video to play/pause
      video.addEventListener('click', () => {
        togglePlayPause(playerId);
      });
      
      // Prevent right-click
      video.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        return false;
      });
    }

    /**
     * Create a protected Google Drive video embed with fullscreen support
     * MAXIMUM SECURITY + FULL FEATURES:
     * - Settings: Quality, Speed, Subtitles (native Drive controls)
     * - Play/Pause, Mute, Fullscreen (enabled)
     * - No URL exposure (sandboxed iframe)
     * - No download button (controlled by Drive sharing settings)
     */
    function createProtectedGoogleDriveEmbed(fileId, title = 'Study Video') {
      if (!fileId) {
        return `
          <div class="media-item">
            <h4>üé• ${title}</h4>
            <div class="protected-video-container">
              <div class="video-unavailable">
                ‚ö†Ô∏è Video unavailable<br>
                <small>Invalid Google Drive link</small>
              </div>
            </div>
          </div>
        `;
      }
      
      // CRITICAL SECURITY: Google Drive preview mode with fullscreen enabled
      // Students CANNOT access the file ID through iframe sandbox
      const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
      const playerId = `drive-player-${Date.now()}`;
      
      return `
        <div class="media-item">
          <h4>üé• ${title}</h4>
          <div class="protected-video-container" id="${playerId}-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px;">
            <iframe 
              id="${playerId}"
              src="${embedUrl}"
              title="Protected Video"
              frameborder="0"
              allow="autoplay; encrypted-media"
              allowfullscreen
              webkitallowfullscreen
              mozallowfullscreen
              sandbox="allow-scripts allow-same-origin"
              loading="lazy"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 12px;"
              oncontextmenu="return false;"
            ></iframe>
          </div>
          <p style="color: var(--accent-primary); font-size: 12px; margin-top: 8px; text-align: center;">
            üîí <strong>Protected ARNOMA Content</strong> - Sharing prohibited<br>
            <small style="opacity: 0.7;">Click ‚öôÔ∏è in video for quality & speed ‚Ä¢ Click ‚õ∂ for fullscreen</small>
          </p>
        </div>
      `;
    }

    /**
     * Create protected video embed (auto-detects YouTube or Google Drive)
     * - YouTube: Uses iframe with maximum security parameters
     * - Google Drive: Uses custom HTML5 player with signed URLs
     */
    function createProtectedVideoEmbed(videoUrl, title = 'Study Video', controls = null) {
      const source = detectVideoSource(videoUrl);
      
      if (source === 'youtube') {
        const videoId = extractYouTubeVideoId(videoUrl);
        return createProtectedYouTubeEmbed(videoId, title, controls);
      } else if (source === 'googledrive') {
        // For Google Drive, use custom HTML5 player
        // Admin stores Drive URL in database, we display with custom controls
        const fileId = extractGoogleDriveFileId(videoUrl);
        
        // Use iframe embed method (students can't download from preview mode)
        return createProtectedGoogleDriveEmbed(fileId, title);
      } else {
        return `
          <div class="media-item">
            <h4>üé• ${title}</h4>
            <div class="protected-video-container">
              <div class="video-unavailable">
                ‚ö†Ô∏è Video unavailable<br>
                <small>Unsupported video source. Use YouTube or Google Drive links.</small>
              </div>
            </div>
          </div>
        `;
      }
    }

    /**
     * Load media content for the current note
     * Fetches video_url from student_notes table and displays it securely
     * üîí CRITICAL SECURITY RULES:
     * 1. If note requires_payment = false (FREE) ‚Üí NO VIDEO ACCESS for anyone
     * 2. If note requires_payment = true AND student paid AND in video_allowed_groups ‚Üí Video access
     * 3. PDF is always accessible if student has note access (free or paid)
     */
    async function loadMediaContent() {
      const mediaPanelContent = document.getElementById('mediaPanelContent');
      
      try {
        const accessMode = noteData?.accessMode || 'unknown';
        const isFreeAccess = accessMode === 'free-note' || accessMode === 'free-grant';

        // üîí CRITICAL RULE: If note is FREE or accessed via free grant, BLOCK all media access
        // Videos are ONLY for PAID students in allowed groups
        if (isFreeAccess) {
          console.log('üîí MEDIA BLOCKED:', {
            reason: accessMode === 'free-note' ? 'Note is free' : 'Free access grant',
            accessMode,
            noteId: noteData?.id,
            student: currentStudent?.name || currentStudent?.id
          });
          mediaPanelContent.innerHTML = `
            <div class="media-item">
              <h4>üìö Study Resources</h4>
              <p style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                üîí Video content is only available to paid students in approved groups.
              </p>
            </div>
          `;
          return;
        }
        
        // üîí STEP 1: Check group access for PAID notes
        const hasGroupAccess = checkVideoGroupAccess(noteData);
        
        if (!hasGroupAccess) {
          // Group restriction: Student's group NOT in video_allowed_groups
          console.log('üîí MEDIA ACCESS DENIED:', {
            studentGroup: currentStudent?.group_letter || currentStudent?.group_name,
            allowedGroups: noteData?.video_allowed_groups,
            noteId: noteData?.id,
            requiresPayment: noteData?.requires_payment
          });
          
          mediaPanelContent.innerHTML = `
            <div class="media-item">
              <h4>üìö Study Resources</h4>
              <p style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                üîí Media content not available for your group.
              </p>
            </div>
          `;
          return;
        }
        
        console.log('‚úÖ MEDIA ACCESS GRANTED:', {
          studentGroup: currentStudent?.group_letter || currentStudent?.group_name,
          allowedGroups: noteData?.video_allowed_groups,
          requiresPayment: noteData?.requires_payment,
          noteId: noteData?.id,
          accessMode
        });
        
        // üîí STEP 2: If group access passed, load media from pdf_media table
        let mediaHTML = '';
        
        // Load media items from pdf_media table
        const { data: mediaItems, error: mediaError } = await supabaseClient
          .from('pdf_media')
          .select('*')
          .eq('note_id', noteData.id)
          .order('created_at', { ascending: true });
        
        if (mediaError) {
          console.error('‚ùå Error loading media:', mediaError);
        }
        
        // Render media items (GIFs, videos, links)
        if (mediaItems && mediaItems.length > 0) {
          console.log(`‚úÖ Loaded ${mediaItems.length} media items for note ${noteData.id} (Group ${currentStudent?.group_letter || currentStudent?.group_name} access)`);
          
          mediaItems.forEach(item => {
            if (item.type === 'image') {
              mediaHTML += `
                <div class="media-item">
                  <h4>üì∏ ${item.title}</h4>
                  ${item.description ? `<p>${item.description}</p>` : ''}
                  <div style="margin-top: 12px;">
                    <img src="${item.url}" alt="${item.title}" style="max-width: 100%; border-radius: 8px;">
                  </div>
                </div>
              `;
            } else if (item.type === 'video') {
              const videoEmbed = createProtectedVideoEmbed(item.url, item.title, true);
              mediaHTML += `
                <div class="media-item">
                  <h4>üé¨ ${item.title}</h4>
                  ${item.description ? `<p>${item.description}</p>` : ''}
                  ${videoEmbed}
                </div>
              `;
            } else if (item.type === 'link') {
              mediaHTML += `
                <div class="media-item">
                  <h4>üîó ${item.title}</h4>
                  ${item.description ? `<p>${item.description}</p>` : ''}
                  <div style="margin-top: 12px;">
                    <a href="${item.url}" target="_blank" rel="noopener noreferrer" 
                       style="color: var(--accent-primary); text-decoration: none;">
                      Open Link ‚Üí
                    </a>
                  </div>
                </div>
              `;
            }
          });
        }
        
        // Legacy: Also check for old video_url field in student_notes
        if (noteData && noteData.video_url) {
          const videoTitle = noteData.video_title || noteData.title || 'Study Video';
          const videoEmbed = createProtectedVideoEmbed(noteData.video_url, videoTitle, noteData.video_controls);
          mediaHTML += `
            <div class="media-item">
              <h4>üé¨ ${videoTitle}</h4>
              ${videoEmbed}
            </div>
          `;
        }
        
        // Display media or show "no media" message
        if (mediaHTML) {
          mediaPanelContent.innerHTML = mediaHTML;
        } else {
          mediaPanelContent.innerHTML = `
            <div class="media-item">
              <h4>üìö Study Resources</h4>
              <p style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                No additional media available for this note.
              </p>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('‚ùå Error loading media content:', error);
        mediaPanelContent.innerHTML = `
          <div class="media-item">
            <h4>‚ùå Error</h4>
            <p style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
              Failed to load media content.
            </p>
          </div>
        `;
      }
    }

    /**
     * Check if current student's group has access to media for this note
     * Returns true if:
     * - video_allowed_groups is NULL (all groups allowed)
     * - video_allowed_groups is empty array (all groups allowed)
     * - student's group is in video_allowed_groups array
     * 
     * üîí CRITICAL: This controls access to ALL media (video_url + pdf_media items)
     */
    function checkVideoGroupAccess(note) {
      // If no restriction set (NULL or empty), allow all groups
      if (!note.video_allowed_groups || note.video_allowed_groups.length === 0) {
        console.log('‚úÖ No group restrictions - allowing all groups');
        return true;
      }
      
      // Get student's group letter
      const studentGroup = currentStudent?.group_letter || 
                          currentStudent?.group_name || 
                          currentStudent?.group || 
                          fallbackStudent?.group_letter ||
                          fallbackStudent?.group_name ||
                          fallbackStudent?.group;
      
      if (!studentGroup) {
        console.log('‚ùå Student has no group assigned');
        return false;
      }
      
      // Normalize to single letter (handle "Group A" or "A")
      const groupLetter = studentGroup.toString().trim().toUpperCase().replace(/^GROUP\s*/i, '').charAt(0);
      
      console.log('üîç Checking group access:', {
        studentGroup: groupLetter,
        allowedGroups: note.video_allowed_groups,
        noteId: note.id
      });
      
      // Check if student's group is in allowed list
      const hasAccess = note.video_allowed_groups.some(allowedGroup => {
        const normalizedAllowed = allowedGroup.toString().trim().toUpperCase().replace(/^GROUP\s*/i, '').charAt(0);
        return normalizedAllowed === groupLetter;
      });
      
      if (hasAccess) {
        console.log(`‚úÖ Group ${groupLetter} HAS ACCESS to note ${note.id}`);
      } else {
        console.log(`üîí Group ${groupLetter} BLOCKED from note ${note.id} (allowed: ${note.video_allowed_groups.join(', ')})`);
      }
      
      return hasAccess;
    }
    
    function toggleMediaPanel(event) {
      if (event) {
        event.stopPropagation(); // Prevent immediate close from document click
      }
      
      const panel = document.getElementById('mediaPanel');
      panel.classList.toggle('open');
      
      // Clear search when closing
      if (!panel.classList.contains('open')) {
        const searchInput = document.getElementById('mediaSearchInput');
        if (searchInput) {
          searchInput.value = '';
          filterMediaItems();
        }
      }
    }

    // Filter media items based on search input
    function filterMediaItems() {
      const searchInput = document.getElementById('mediaSearchInput');
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      const mediaItems = document.querySelectorAll('.media-item');
      
      mediaItems.forEach(item => {
        const title = item.querySelector('h4')?.textContent.toLowerCase() || '';
        const description = item.querySelector('p')?.textContent.toLowerCase() || '';
        
        if (title.includes(searchTerm) || description.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Show media panel toggle when PDF is loaded
    function showMediaPanelToggle() {
      document.getElementById('mediaPanelToggle').style.display = 'flex';
    }

    // Close media panel when clicking outside
    document.addEventListener('click', function(event) {
      const panel = document.getElementById('mediaPanel');
      const toggle = document.getElementById('mediaPanelToggle');
      
      if (panel && panel.classList.contains('open')) {
        // Check if click is outside both panel and toggle button
        if (!panel.contains(event.target) && !toggle.contains(event.target)) {
          panel.classList.remove('open');
        }
      }
    });

    // ============================================================
    // GLOBAL ERROR HANDLERS - ROBUSTNESS
    // ============================================================
    
    // Catch all unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      console.error('‚ùå Unhandled Promise Rejection:', event.reason);
      showError('An unexpected error occurred: ' + (event.reason?.message || event.reason || 'Unknown error'));
      event.preventDefault();
    });
    
    // Catch all uncaught errors
    window.addEventListener('error', function(event) {
      console.error('‚ùå Uncaught Error:', event.error);
      
      // Don't show error for script loading failures (CDN issues)
      if (event.message && event.message.includes('Script error')) {
        console.warn('Script loading error detected, but PDF viewer may still work');
        return;
      }
      
      showError('An unexpected error occurred. Please refresh the page.');
      event.preventDefault();
    });
    
    // Monitor PDF.js worker errors
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    
    // Verify critical dependencies on load
    if (typeof window.supabase === 'undefined') {
      showError('‚ùå CRITICAL: Supabase SDK failed to load. Please check your internet connection and refresh.');
    }
    
    if (typeof pdfjsLib === 'undefined') {
      showError('‚ùå CRITICAL: PDF.js library failed to load. Please check your internet connection and refresh.');
    }
    
    console.log('‚úÖ Protected PDF Viewer initialized with robust error handling');
  </script>
</body>
</html>
