<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Protected Note Viewer - ARNOMA</title>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- PDF.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  <style>
    /* ==========================================================================
       CSS VARIABLES - Liquid Glass Design System
       ========================================================================== */
    :root {
      --bg-base: #020510;
      --bg-gradient-start: #030a1f;
      --bg-gradient-end: #050d2c;
      --panel-light: rgba(37, 56, 117, 0.85);
      --panel-dark: rgba(16, 24, 47, 0.92);
      --glass-border: rgba(125, 211, 252, 0.35);
      --accent-primary: #7dd3fc;
      --accent-secondary: #c084fc;
      --accent-tertiary: #f9a8d4;
      --glow-blue: rgba(125, 211, 252, 0.65);
      --glow-purple: rgba(192, 132, 252, 0.6);
      --text-strong: #f8fbff;
      --text-muted: rgba(255, 255, 255, 0.7);
      --card-shadow: 0 30px 120px rgba(3, 6, 19, 0.65);
      --panel-blur: 8px;
      --modal-blur: 14px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      min-height: 100vh;
      padding: 30px;
      overflow-x: hidden;
      position: relative;
      
      /* Disable text selection - CRITICAL */
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      -webkit-touch-callout: none !important;
    }

    /* Liquid Glass Background Effect */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(102,126,234,0.12) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(118,75,162,0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    /* Force disable selection on all elements */
    * {
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
    
    .viewer-container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(16, 24, 47, 0.75);
      border: 1px solid rgba(125, 211, 252, 0.25);
      border-radius: 24px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      position: relative;
      z-index: 1;
    }
    
    .viewer-header {
      background: linear-gradient(135deg, rgba(125, 211, 252, 0.15), rgba(192, 132, 252, 0.15));
      border-bottom: 1px solid rgba(125, 211, 252, 0.2);
      color: var(--text-strong);
      padding: 28px 36px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .viewer-header h1 {
      font-size: 26px;
      font-weight: 700;
      background: linear-gradient(120deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }
    
    .viewer-header .student-name {
      font-size: 18px;
      color: var(--text-muted);
      font-weight: 500;
      margin-top: 6px;
    }
    
    .viewer-controls {
      background: rgba(37, 56, 117, 0.4);
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      padding: 18px 36px;
      border-bottom: 1px solid rgba(125, 211, 252, 0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .control-btn {
      background: rgba(125, 211, 252, 0.1);
      border: 1px solid rgba(125, 211, 252, 0.3);
      padding: 10px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--accent-primary);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    
    .control-btn:hover:not(:disabled) {
      background: rgba(125, 211, 252, 0.2);
      border-color: var(--accent-primary);
      box-shadow: 0 8px 24px rgba(125, 211, 252, 0.3);
      transform: translateY(-2px);
    }

    .control-btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .control-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: rgba(125, 211, 252, 0.05);
      border-color: rgba(125, 211, 252, 0.1);
    }
    
    .print-btn {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
      color: #6ee7b7;
      border-color: rgba(16, 185, 129, 0.4);
    }
    
    .print-btn:hover {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3));
      border-color: #10b981;
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
    }
    
    .page-info {
      font-size: 14px;
      color: var(--text-strong);
      font-weight: 600;
      padding: 8px 16px;
      background: rgba(125, 211, 252, 0.08);
      border-radius: 8px;
      border: 1px solid rgba(125, 211, 252, 0.2);
    }
    
    .pdf-content {
      padding: 36px;
      background: rgba(2, 5, 16, 0.3);
      min-height: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      position: relative;
    }
    
    .page-container {
      position: relative;
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
      margin-bottom: 24px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(125, 211, 252, 0.1);
    }
    
    .page-canvas {
      display: block;
      max-width: 100%;
      height: auto;
      pointer-events: none; /* Prevent any interaction with canvas */
      
      /* High-quality rendering settings */
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      image-rendering: high-quality;
      -ms-interpolation-mode: bicubic;
    }
    
    .watermark-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 200px,
        rgba(125, 211, 252, 0.025) 200px,
        rgba(125, 211, 252, 0.025) 400px
      );
    }
    
    .watermark-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      opacity: 0.18;
    }
    
    .watermark-logo {
      font-size: 140px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
      letter-spacing: 12px;
      transform: rotate(-45deg);
    }
    
    .watermark-text {
      font-size: 36px;
      font-weight: 700;
      background: linear-gradient(120deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      line-height: 1.6;
      transform: rotate(-25deg);
    }
    
    .watermark-info {
      font-size: 20px;
      font-weight: 600;
      background: linear-gradient(120deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
    }
    
    .loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 40px;
      gap: 24px;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(125, 211, 252, 0.2);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 16px;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .error-message {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
      color: #fca5a5;
      padding: 24px 32px;
      border-radius: 16px;
      text-align: center;
      margin: 48px;
      border: 1px solid rgba(239, 68, 68, 0.3);
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      font-weight: 500;
    }
    
    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .zoom-level {
      font-size: 14px;
      color: var(--text-strong);
      font-weight: 600;
      min-width: 60px;
      text-align: center;
      padding: 6px 12px;
      background: rgba(125, 211, 252, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(125, 211, 252, 0.2);
    }
    
    /* ==========================================================================
       RESPONSIVE DESIGN
       ========================================================================== */
    
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }

      .viewer-header {
        padding: 20px 24px;
      }

      .viewer-header h1 {
        font-size: 22px;
      }

      .viewer-controls {
        padding: 16px 20px;
        flex-direction: column;
        gap: 12px;
      }

      .control-group {
        width: 100%;
        justify-content: space-between;
      }

      .pdf-content {
        padding: 20px 16px;
      }

      .watermark-logo {
        font-size: 80px;
        transform: rotate(-45deg);
      }

      .watermark-text {
        font-size: 24px;
      }

      .watermark-info {
        font-size: 16px;
      }
    }

    /* ==========================================================================
       PRINT STYLES
       ========================================================================== */
    
    @media print {
      body {
        background: white;
        padding: 0;
      }

      body::before {
        display: none;
      }
      
      .viewer-header,
      .viewer-controls {
        display: none !important;
      }
      
      .viewer-container {
        box-shadow: none;
        border-radius: 0;
        background: white;
        border: none;
      }
      
      .pdf-content {
        padding: 0;
        background: white;
      }
      
      .page-container {
        page-break-after: always;
        page-break-inside: avoid;
        box-shadow: none;
        margin: 0;
        padding: 0;
        border: none;
        border-radius: 0;
        background: white;
      }
      
      .page-container:last-child {
        page-break-after: auto;
      }
      
      /* CRITICAL: Watermark must appear in print */
      .watermark-overlay {
        display: flex !important;
        opacity: 1 !important;
        background: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 200px,
          rgba(125, 211, 252, 0.02) 200px,
          rgba(125, 211, 252, 0.02) 400px
        );
      }
      
      .watermark-content {
        opacity: 0.15 !important; /* Lighter on print but still visible */
      }
      
      /* Ensure canvas renders in print */
      .page-canvas {
        max-width: 100%;
        height: auto;
      }
    }

    /* ==========================================================================
       MEDIA PANEL - For GIFs, Videos, Interactive Content
       ========================================================================== */
    .media-panel {
      position: fixed;
      right: -420px;
      top: 80px;
      bottom: 80px;
      width: 400px;
      background: rgba(16, 24, 47, 0.95);
      border: 1px solid rgba(125, 211, 252, 0.3);
      border-right: none;
      border-radius: 24px 0 0 24px;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .media-panel.open {
      right: 0;
    }

    .media-panel-toggle {
      position: fixed;
      right: 30px;
      bottom: 30px;
      width: 64px;
      height: 64px;
      background: rgba(16, 24, 47, 0.85);
      border: 2px solid rgba(125, 211, 252, 0.5);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 8px 24px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(125, 211, 252, 0.3),
        inset 0 1px 2px rgba(255, 255, 255, 0.1);
      z-index: 999;
      overflow: hidden;
    }

    .media-panel-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(125, 211, 252, 0.15), 
        rgba(192, 132, 252, 0.15));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .media-panel-toggle:hover::before {
      opacity: 1;
    }

    .media-panel-toggle:hover {
      transform: translateY(-4px);
      border-color: var(--accent-primary);
      box-shadow: 
        0 12px 32px rgba(0, 0, 0, 0.5),
        0 0 30px rgba(125, 211, 252, 0.6),
        inset 0 1px 3px rgba(255, 255, 255, 0.2);
    }

    .media-panel-toggle:active {
      transform: translateY(-2px);
    }

    /* Camera Icon SVG */
    .media-panel-toggle svg {
      width: 28px;
      height: 28px;
      fill: none;
      stroke: var(--accent-primary);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .media-panel-toggle:hover svg {
      stroke: var(--accent-secondary);
      transform: scale(1.1);
    }

    .media-panel-header {
      padding: 24px;
      background: linear-gradient(135deg, rgba(125, 211, 252, 0.1), rgba(192, 132, 252, 0.1));
      border-bottom: 1px solid rgba(125, 211, 252, 0.2);
    }

    .media-panel-header h3 {
      color: var(--text-strong);
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .media-panel-content {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .media-panel-content::-webkit-scrollbar {
      width: 8px;
    }

    .media-panel-content::-webkit-scrollbar-track {
      background: rgba(125, 211, 252, 0.05);
      border-radius: 4px;
    }

    .media-panel-content::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 4px;
    }

    .media-item {
      margin-bottom: 24px;
      background: rgba(37, 56, 117, 0.3);
      border: 1px solid rgba(125, 211, 252, 0.2);
      border-radius: 16px;
      padding: 16px;
      transition: all 0.2s ease;
    }

    .media-item:hover {
      background: rgba(37, 56, 117, 0.4);
      border-color: rgba(125, 211, 252, 0.4);
      transform: translateX(-4px);
    }

    .media-item h4 {
      color: var(--accent-primary);
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
    }

    .media-item img, .media-item video {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(125, 211, 252, 0.2);
    }

    .media-item p {
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.6;
      margin: 0;
    }

    .media-item a {
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .media-item a:hover {
      color: var(--accent-secondary);
      text-decoration: underline;
    }

    /* ==========================================================================
       CUSTOM ALERT MODAL
       ========================================================================== */
    .custom-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .custom-alert-modal {
      background: rgba(16, 24, 47, 0.95);
      border: 2px solid rgba(125, 211, 252, 0.4);
      border-radius: 24px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    .custom-alert-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 20px;
    }

    .custom-alert-title {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .custom-alert-message {
      color: var(--text-muted);
      font-size: 16px;
      line-height: 1.8;
      text-align: center;
      margin-bottom: 30px;
    }

    .custom-alert-button {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      border-radius: 12px;
      padding: 14px 32px;
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(125, 211, 252, 0.3);
    }

    .custom-alert-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(125, 211, 252, 0.5);
    }

    .custom-alert-button:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="viewer-container">
    <div class="viewer-header">
      <div>
        <h1 id="noteTitle">Loading Note...</h1>
        <div class="student-name" id="studentName"></div>
      </div>
    </div>
    
    <div class="viewer-controls" id="viewerControls" style="display: none;">
      <div class="control-group">
        <button class="control-btn" id="prevPage" onclick="changePage(-1)">‚óÄ Previous</button>
        <span class="page-info">
          Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <button class="control-btn" id="nextPage" onclick="changePage(1)">Next ‚ñ∂</button>
      </div>
      
      <div class="control-group">
        <div class="zoom-controls">
          <button class="control-btn" onclick="changeZoom(-0.1)">-</button>
          <span class="zoom-level" id="zoomLevel">100%</span>
          <button class="control-btn" onclick="changeZoom(0.1)">+</button>
        </div>
        <button class="control-btn print-btn" onclick="printNote()">üñ®Ô∏è Print</button>
      </div>
    </div>
    
    <div class="pdf-content" id="pdfContent">
      <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-text">Loading protected note...</div>
      </div>
    </div>
  </div>

  <!-- Floating Media Button -->
  <button class="media-panel-toggle" id="mediaPanelToggle" onclick="toggleMediaPanel()" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
      <circle cx="12" cy="13" r="4"></circle>
    </svg>
  </button>

  <!-- Media Panel -->
  <div class="media-panel" id="mediaPanel">
    <div class="media-panel-header">
      <h3>üìö Study Resources</h3>
    </div>
    <div class="media-panel-content" id="mediaPanelContent">
      <!-- Media items will be loaded here -->
      <div class="media-item">
        <h4>ü´Ä Cardiovascular System</h4>
        <img src="https://media.giphy.com/media/l0HlHFRbmaZtBRhXG/giphy.gif" alt="Blood flow animation">
        <p>The blood flows from the right atrium ‚Üí right ventricle ‚Üí pulmonary artery ‚Üí lungs ‚Üí pulmonary veins ‚Üí left atrium ‚Üí left ventricle ‚Üí aorta ‚Üí body.</p>
      </div>
      
      <div class="media-item">
        <h4>üìñ Additional Resources</h4>
        <p>
          <a href="https://www.khanacademy.org/science/biology/human-biology/circulatory-pulmonary" target="_blank">Khan Academy - Circulatory System</a>
        </p>
        <p style="margin-top: 8px;">
          <a href="https://www.youtube.com/watch?v=CWFyxn0qDEU" target="_blank">YouTube - Heart Animation</a>
        </p>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // SUPABASE CONFIGURATION
    // ============================================================
    
    const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ============================================================
    // PDF.js CONFIGURATION
    // ============================================================
    
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // ============================================================
    // VERSION & DEBUG
    // ============================================================
    
    const VIEWER_VERSION = 'v2.1.0-signed-urls';
    console.log('üîµ PDF Viewer Version:', VIEWER_VERSION);
    console.log('üìÖ Loaded at:', new Date().toISOString());
    
    // ============================================================
    // GLOBAL VARIABLES
    // ============================================================
    
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let zoomLevel = 1.0;
    let currentStudent = null;
    let fallbackStudent = null;
    let noteData = null;

    const getStudentDisplayName = () => {
      return (currentStudent && currentStudent.name) || (fallbackStudent && fallbackStudent.name) || 'Authorized Student';
    };

    const getStudentDisplayGroup = () => {
      return (currentStudent && (currentStudent.group || currentStudent.group_name)) || (fallbackStudent && (fallbackStudent.group || fallbackStudent.group_name)) || 'N/A';
    };
    
    // ============================================================
    // DISABLE COPY/DOWNLOAD PROTECTION - ENHANCED
    // ============================================================
    
    // Disable right-click completely
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }, true);
    
    // Disable ALL keyboard shortcuts for save/copy/inspect
    document.addEventListener('keydown', (e) => {
      // Disable save shortcuts
      if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable copy shortcuts
      if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable select all
      if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'A')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable print shortcut (we have our own)
      if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
        e.preventDefault();
        e.stopPropagation();
        printNote(); // Use our protected print instead
        return false;
      }
      
      // Disable DevTools shortcuts
      if (e.key === 'F12' || 
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'i')) ||
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'J' || e.key === 'j')) ||
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'C' || e.key === 'c')) ||
          ((e.ctrlKey || e.metaKey) && (e.key === 'u' || e.key === 'U'))) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);
    
    // Disable text selection via mouse
    document.addEventListener('selectstart', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Disable drag-and-drop
    document.addEventListener('dragstart', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Disable copy event
    document.addEventListener('copy', (e) => {
      e.preventDefault();
      e.clipboardData.setData('text/plain', '');
      return false;
    }, true);
    
    // Disable cut event
    document.addEventListener('cut', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Monitor for DevTools (basic detection)
    let devtoolsOpen = false;
    const detectDevTools = () => {
      const threshold = 160;
      if (window.outerWidth - window.innerWidth > threshold || 
          window.outerHeight - window.innerHeight > threshold) {
        if (!devtoolsOpen) {
          devtoolsOpen = true;
          showCustomAlert();
        }
      } else {
        devtoolsOpen = false;
      }
    };
    setInterval(detectDevTools, 1000);
    
    // ============================================================
    // INITIALIZATION
    // ============================================================
    
    (async function init() {
      try {
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const pdfUrl = urlParams.get('url');
        const noteTitle = urlParams.get('title') || 'Class Notes';
        const noteId = urlParams.get('note'); // Legacy support
        const studentName = urlParams.get('studentName'); // Passed from portal
        const studentGroup = urlParams.get('studentGroup'); // Passed from portal
        
        if (!pdfUrl && !noteId) {
          showError('No note specified');
          return;
        }
        
        // Check if student info was passed via URL (for impersonation or direct links)
        if (studentName) {
          fallbackStudent = {
            name: studentName,
            group_name: studentGroup,
            group: studentGroup
          };
          currentStudent = fallbackStudent;
        }
        
        // Check authentication (support both regular auth and impersonation)
        // First check for impersonation token (if student info wasn't passed via URL)
        if (!currentStudent) {
          const impersonationToken = sessionStorage.getItem('impersonation_token');
          if (impersonationToken) {
            try {
              const tokenData = JSON.parse(impersonationToken);
              const { data: student, error: studentError } = await supabase
                .from('students')
                .select('*')
                .eq('id', tokenData.studentId)
                .single();
              
              if (student && !studentError) {
                currentStudent = student;
              }
            } catch (e) {
              console.error('Error reading impersonation token:', e);
            }
          }
        }
        
        // If no impersonation, check regular auth session
        if (!currentStudent) {
          const { data: { session }, error: authError } = await supabase.auth.getSession();
          
          if (authError || !session) {
            showError('Please log in to view this note');
            window.location.href = 'index.html';
            return;
          }
          
          // Get current student data by email
          const { data: student, error: studentError } = await supabase
            .from('students')
            .select('*')
            .eq('email', session.user.email)
            .single();
          
          if (studentError || !student) {
            showError('Student profile not found');
            return;
          }
          
          currentStudent = student;
        }
        
        if (!currentStudent) {
          showError('Student profile not found');
          return;
        }
  document.getElementById('studentName').textContent = getStudentDisplayName();
        document.getElementById('noteTitle').textContent = noteTitle.replace(/\.pdf$/i, '');
        
        // Create mock note data for watermarking
        noteData = {
          title: noteTitle,
          class_date: new Date().toISOString()
        };
        
        // If URL provided directly (from new group notes system)
        if (pdfUrl) {
          document.getElementById('viewerControls').style.display = 'flex';
        showMediaPanelToggle();
          
          // Check if it's a storage path or a full URL
          if (pdfUrl.startsWith('http://') || pdfUrl.startsWith('https://')) {
            // It's already a full URL, use it directly
            await loadPDFFromURL(pdfUrl);
          } else {
            // It's a storage path, create signed URL from student-notes bucket
            await loadPDFFromStorage(pdfUrl);
          }
          return;
        }
        
        // Legacy: Load from student_notes table
        if (noteId) {
          const { data: note, error: noteError } = await supabase
            .from('student_notes')
            .select('*')
            .eq('id', noteId)
            .single();
          
          if (noteError || !note) {
            showError('Note not found');
            return;
          }
          
          noteData = note;
          
          // Verify student is in the correct group
          if (note.group_name !== currentStudent.group_name) {
            showError('This note is not for your group');
            return;
          }
          
          // Check if note requires payment
          if (note.requires_payment) {
            const { data: payments, error: paymentError } = await supabase
              .from('payment_records')
              .select('*')
              .eq('student_id', currentStudent.id)
              .eq('status', 'paid')
              .limit(1);
            
            if (paymentError || !payments || payments.length === 0) {
              showError('üîí This note is locked. Payment required to access.');
              return;
            }
          }
          
          document.getElementById('noteTitle').textContent = (note.title || 'Class Notes').replace(/\.pdf$/i, '');
          await loadPDF(note.pdf_url);
        }
        
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to load note: ' + error.message);
      }
    })();
    
    // ============================================================
    // PDF LOADING & RENDERING
    // ============================================================
    
    async function loadPDFFromURL(pdfUrl) {
      try {
        document.getElementById('loadingScreen').style.display = 'flex';
        
        console.log('üîó Loading PDF from URL:', pdfUrl);
        
        // Load PDF directly from URL
        const loadingTask = pdfjsLib.getDocument({
          url: pdfUrl,
          withCredentials: false
        });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        
        // Update UI
        document.getElementById('totalPages').textContent = totalPages;
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('viewerControls').style.display = 'flex';
        showMediaPanelToggle();
        
        // Render first page
        await renderPage(1);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF: ' + error.message);
      }
    }
    
    async function loadPDFFromStorage(pdfPath) {
      try {
        console.log('üîç Loading PDF from storage path:', pdfPath);
        document.getElementById('loadingScreen').style.display = 'flex';
        
        // Create a signed URL with 1 hour expiration
        const { data: signedUrlData, error: signedUrlError } = await supabase.storage
          .from('student-notes')
          .createSignedUrl(pdfPath, 3600); // 1 hour
        
        if (signedUrlError) {
          console.error('‚ùå Error creating signed URL:', signedUrlError);
          throw new Error(`Could not create signed URL: ${signedUrlError.message}`);
        }
        
        if (!signedUrlData || !signedUrlData.signedUrl) {
          throw new Error('Signed URL was not generated');
        }
        
        console.log('‚úÖ Created signed URL for:', pdfPath);
        
        // Load PDF from signed URL
        const loadingTask = pdfjsLib.getDocument({
          url: signedUrlData.signedUrl,
          withCredentials: false
        });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        
        // Update UI
        document.getElementById('totalPages').textContent = totalPages;
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('viewerControls').style.display = 'flex';
        showMediaPanelToggle();
        
        // Render first page
        await renderPage(1);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF: ' + error.message + '. Please ensure the file exists in storage.');
      }
    }
    
    async function loadPDF(pdfPath) {
      try {
        console.log('üîç Loading PDF from storage path (legacy):', pdfPath);
        
        // Try signed URL first
        await loadPDFFromStorage(pdfPath);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF. The file may not exist in storage. Please contact your administrator.');
      }
    }
    
    async function renderPage(pageNum) {
      try {
        const page = await pdfDoc.getPage(pageNum);
        
        // High-quality rendering: 3x scale for retina displays
        const scale = zoomLevel * 3.0;
        const viewport = page.getViewport({ scale: scale });
        
        // Create canvas for this page
        const canvas = document.createElement('canvas');
        canvas.className = 'page-canvas';
        const context = canvas.getContext('2d');
        
        // Set high-resolution canvas dimensions
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        // Scale down display size while maintaining quality
        canvas.style.width = (viewport.width / 3) + 'px';
        canvas.style.height = (viewport.height / 3) + 'px';
        
        // Render PDF page with high quality
        await page.render({
          canvasContext: context,
          viewport: viewport
        }).promise;
        
        // Create page container with watermark
        const pageContainer = document.createElement('div');
        pageContainer.className = 'page-container';
        
        // Add watermark overlay with ARNOMA logo and student info
        const watermark = document.createElement('div');
        watermark.className = 'watermark-overlay';
        watermark.innerHTML = `
          <div class="watermark-content">
            <div class="watermark-logo">ARNOMA</div>
            <div class="watermark-text">
              ${getStudentDisplayName()}<br>
              Group ${getStudentDisplayGroup()}
            </div>
            <div class="watermark-info">
              ${new Date().toLocaleDateString()}<br>
              PROTECTED CONTENT
            </div>
          </div>
        `;
        
        pageContainer.appendChild(canvas);
        pageContainer.appendChild(watermark);
        
        // Clear and add to content
        const content = document.getElementById('pdfContent');
        content.innerHTML = '';
        content.appendChild(pageContainer);
        
        // Update page number
        currentPage = pageNum;
        document.getElementById('currentPage').textContent = currentPage;
        
        // Update button states
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
        
      } catch (error) {
        console.error('Page rendering error:', error);
        showError('Failed to render page: ' + error.message);
      }
    }
    
    // ============================================================
    // NAVIGATION CONTROLS
    // ============================================================
    
    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= totalPages) {
        renderPage(newPage);
      }
    }
    
    function changeZoom(delta) {
      zoomLevel = Math.max(0.5, Math.min(2.0, zoomLevel + delta));
      document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
      renderPage(currentPage);
    }
    
    // ============================================================
    // PRINT FUNCTION (WITH WATERMARK)
    // ============================================================
    
    async function printNote() {
      try {
        // Render all pages for printing
        const content = document.getElementById('pdfContent');
        content.innerHTML = '<div class="loading-text">Preparing for print...</div>';
        
        for (let i = 1; i <= totalPages; i++) {
          const page = await pdfDoc.getPage(i);
          
          // High-quality print rendering: 2.5x scale
          const scale = 2.5;
          const viewport = page.getViewport({ scale: scale });
          
          const canvas = document.createElement('canvas');
          canvas.className = 'page-canvas';
          const context = canvas.getContext('2d');
          
          // High-resolution canvas
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          
          // Scale display for print
          canvas.style.width = (viewport.width / scale) + 'px';
          canvas.style.height = (viewport.height / scale) + 'px';
          
          await page.render({
            canvasContext: context,
            viewport: viewport
          }).promise;
          
          const pageContainer = document.createElement('div');
          pageContainer.className = 'page-container';
          
          const watermark = document.createElement('div');
          watermark.className = 'watermark-overlay';
          watermark.innerHTML = `
            <div class="watermark-content">
              <div class="watermark-logo">ARNOMA</div>
              <div class="watermark-text">
                ${currentStudent.name}<br>
                Group ${currentStudent.group || currentStudent.group_name || 'N/A'}
              </div>
              <div class="watermark-info">
                ${new Date().toLocaleDateString()}<br>
                PROTECTED CONTENT
              </div>
            </div>
          `;
          
          pageContainer.appendChild(canvas);
          pageContainer.appendChild(watermark);
          content.appendChild(pageContainer);
        }
        
        // Trigger print dialog
        setTimeout(() => {
          window.print();
          // Restore single page view after print
          renderPage(currentPage);
        }, 500);
        
      } catch (error) {
        console.error('Print error:', error);
        alert('Failed to prepare for printing');
      }
    }
    
    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================
    
    function showError(message) {
      const content = document.getElementById('pdfContent');
      content.innerHTML = `<div class="error-message">${message}</div>`;
    }
    
    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { 
        month: 'long', 
        day: 'numeric', 
        year: 'numeric' 
      });
    }

    // Custom Alert Function
    function showCustomAlert() {
      const studentName = getStudentDisplayName();
      
      const overlay = document.createElement('div');
      overlay.className = 'custom-alert-overlay';
      overlay.innerHTML = `
        <div class="custom-alert-modal">
          <div class="custom-alert-icon">‚ö†Ô∏è</div>
          <div class="custom-alert-title">ATTENTION</div>
          <div class="custom-alert-message">
            This note belongs to <strong>ARNOMA</strong> and is provided exclusively for <strong>${studentName}</strong>.<br><br>
            Kindly respect the copyright and refrain from sharing it with others.<br><br>
            Thank you for your understanding.
          </div>
          <button class="custom-alert-button" onclick="this.closest('.custom-alert-overlay').remove()">
            I Understand
          </button>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      // Close on overlay click
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
    }

    // ============================================================
    // MEDIA PANEL FUNCTIONS
    // ============================================================
    
    function toggleMediaPanel(event) {
      if (event) {
        event.stopPropagation(); // Prevent immediate close from document click
      }
      
      const panel = document.getElementById('mediaPanel');
      panel.classList.toggle('open');
    }

    // Show media panel toggle when PDF is loaded
    function showMediaPanelToggle() {
      document.getElementById('mediaPanelToggle').style.display = 'flex';
    }

    // Close media panel when clicking outside
    document.addEventListener('click', function(event) {
      const panel = document.getElementById('mediaPanel');
      const toggle = document.getElementById('mediaPanelToggle');
      
      if (panel && panel.classList.contains('open')) {
        // Check if click is outside both panel and toggle button
        if (!panel.contains(event.target) && !toggle.contains(event.target)) {
          panel.classList.remove('open');
        }
      }
    });
  </script>
</body>
</html>
