<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="version" content="2.1.1">
  <title>Protected PDF Viewer - ARNOMA</title>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1"></script>
  
  <!-- PDF.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  <style>
    /* ==========================================================================
       CSS VARIABLES - Liquid Glass Design System
       ========================================================================== */
    :root {
      --bg-base: #020510;
      --bg-gradient-start: #030a1f;
      --bg-gradient-end: #050d2c;
      --panel-light: rgba(37, 56, 117, 0.85);
      --panel-dark: rgba(16, 24, 47, 0.92);
      --glass-border: rgba(125, 211, 252, 0.35);
      --accent-primary: #7dd3fc;
      --accent-secondary: #c084fc;
      --accent-tertiary: #f9a8d4;
      --glow-blue: rgba(125, 211, 252, 0.65);
      --glow-purple: rgba(192, 132, 252, 0.6);
      --text-strong: #f8fbff;
      --text-muted: rgba(255, 255, 255, 0.7);
      --card-shadow: 0 30px 120px rgba(3, 6, 19, 0.65);
      --panel-blur: 8px;
      --modal-blur: 14px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      min-height: 100vh;
      padding: 30px;
      overflow-x: hidden;
      position: relative;
      
      /* Disable text selection - CRITICAL */
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      -webkit-touch-callout: none !important;
    }

    /* Liquid Glass Background Effect */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(102,126,234,0.12) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(118,75,162,0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    /* Force disable selection on all elements */
    * {
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
    
    .viewer-container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(16, 24, 47, 0.75);
      border: 1px solid rgba(125, 211, 252, 0.25);
      border-radius: 24px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      position: relative;
      z-index: 1;
    }
    
    .viewer-header {
      background: linear-gradient(135deg, rgba(125, 211, 252, 0.15), rgba(192, 132, 252, 0.15));
      border-bottom: 1px solid rgba(125, 211, 252, 0.2);
      color: var(--text-strong);
      padding: 28px 36px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .viewer-header h1 {
      font-size: 26px;
      font-weight: 700;
      background: linear-gradient(120deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }
    
    .viewer-header .student-name {
      font-size: 18px;
      color: var(--text-muted);
      font-weight: 500;
      margin-top: 6px;
    }
    
    .viewer-controls {
      background: rgba(37, 56, 117, 0.4);
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      padding: 18px 36px;
      border-bottom: 1px solid rgba(125, 211, 252, 0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .control-btn {
      background: rgba(125, 211, 252, 0.1);
      border: 1px solid rgba(125, 211, 252, 0.3);
      padding: 10px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--accent-primary);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    
    .control-btn:hover:not(:disabled) {
      background: rgba(125, 211, 252, 0.2);
      border-color: var(--accent-primary);
      box-shadow: 0 8px 24px rgba(125, 211, 252, 0.3);
      transform: translateY(-2px);
    }

    .control-btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .control-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: rgba(125, 211, 252, 0.05);
      border-color: rgba(125, 211, 252, 0.1);
    }
    
    .print-btn {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
      color: #6ee7b7;
      border-color: rgba(16, 185, 129, 0.4);
    }
    
    .print-btn:hover {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3));
      border-color: #10b981;
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
    }
    
    .page-info {
      font-size: 14px;
      color: var(--text-strong);
      font-weight: 600;
      padding: 8px 16px;
      background: rgba(125, 211, 252, 0.08);
      border-radius: 8px;
      border: 1px solid rgba(125, 211, 252, 0.2);
    }
    
    .pdf-content {
      padding: 36px;
      background: rgba(2, 5, 16, 0.3);
      min-height: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      position: relative;
    }
    
    .page-container {
      position: relative;
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
      margin-bottom: 24px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(125, 211, 252, 0.1);
    }
    
    .page-canvas {
      display: block;
      max-width: 100%;
      height: auto;
      pointer-events: none; /* Prevent any interaction with canvas */
      
      /* High-quality rendering settings */
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      image-rendering: high-quality;
      -ms-interpolation-mode: bicubic;
    }
    
    .watermark-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px;
    }
    
    .watermark-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      opacity: 0.25;
      transform: rotate(-45deg) translateX(40px);
      width: 120%;
      max-width: none;
    }
    
    .watermark-logo {
      font-size: 200px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
      letter-spacing: 12px;
      margin: 0;
      line-height: 1;
    }
    
    .watermark-text {
      font-size: 48px;
      font-weight: 700;
      background: linear-gradient(120deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      line-height: 1.8;
      margin: 0;
    }
    
    .watermark-info {
      display: none;
    }
    
    .loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 40px;
      gap: 24px;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(125, 211, 252, 0.2);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 16px;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .error-message {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
      color: #fca5a5;
      padding: 24px 32px;
      border-radius: 16px;
      text-align: center;
      margin: 48px;
      border: 1px solid rgba(239, 68, 68, 0.3);
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      font-weight: 500;
    }

    .error-message p {
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .error-actions {
      margin-top: 12px;
    }

    .retry-btn {
      margin-top: 8px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      border-radius: 12px;
      padding: 10px 28px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(125, 211, 252, 0.25);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .retry-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(125, 211, 252, 0.35);
    }

    .retry-btn:active {
      transform: translateY(0);
    }
    
    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .zoom-level {
      font-size: 14px;
      color: var(--text-strong);
      font-weight: 600;
      min-width: 60px;
      text-align: center;
      padding: 6px 12px;
      background: rgba(125, 211, 252, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(125, 211, 252, 0.2);
    }
    
    /* ==========================================================================
       RESPONSIVE DESIGN
       ========================================================================== */
    
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }

      .viewer-header {
        padding: 20px 24px;
      }

      .viewer-header h1 {
        font-size: 22px;
      }

      .viewer-controls {
        padding: 16px 20px;
        flex-direction: column;
        gap: 12px;
      }

      .control-group {
        width: 100%;
        justify-content: space-between;
      }

      .pdf-content {
        padding: 20px 16px;
      }

      .watermark-overlay {
        padding: 40px;
      }

      .watermark-logo {
        font-size: 120px;
        letter-spacing: 8px;
      }

      .watermark-text {
        font-size: 32px;
      }

      .watermark-info {
        font-size: 16px;
      }
    }

    /* ==========================================================================
       PRINT STYLES
       ========================================================================== */
    
    @media print {
      body {
        background: white;
        padding: 0;
      }

      body::before {
        display: none;
      }
      
      .viewer-header,
      .viewer-controls {
        display: none !important;
      }
      
      .viewer-container {
        box-shadow: none;
        border-radius: 0;
        background: white;
        border: none;
      }
      
      .pdf-content {
        padding: 0;
        background: white;
      }
      
      .page-container {
        page-break-after: always;
        page-break-inside: avoid;
        box-shadow: none;
        margin: 0;
        padding: 0;
        border: none;
        border-radius: 0;
        background: white;
      }
      
      .page-container:last-child {
        page-break-after: auto;
      }
      
      /* CRITICAL: Watermark must appear in print */
      .watermark-overlay {
        display: flex !important;
        opacity: 1 !important;
        background: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 200px,
          rgba(125, 211, 252, 0.02) 200px,
          rgba(125, 211, 252, 0.02) 400px
        );
      }
      
      .watermark-content {
        opacity: 0.15 !important; /* Lighter on print but still visible */
      }
      
      /* Ensure canvas renders in print */
      .page-canvas {
        max-width: 100%;
        height: auto;
      }
    }

    /* ==========================================================================
       MEDIA PANEL - For GIFs, Videos, Interactive Content
       ========================================================================== */
    .media-panel {
      position: fixed;
      right: -420px;
      top: 80px;
      bottom: 80px;
      width: 400px;
      background: rgba(16, 24, 47, 0.95);
      border: 1px solid rgba(125, 211, 252, 0.3);
      border-right: none;
      border-radius: 24px 0 0 24px;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .media-panel.open {
      right: 0;
    }

    .media-panel-toggle {
      position: fixed;
      right: 30px;
      bottom: 30px;
      width: 64px;
      height: 64px;
      background: rgba(16, 24, 47, 0.85);
      border: 2px solid rgba(125, 211, 252, 0.5);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 8px 24px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(125, 211, 252, 0.3),
        inset 0 1px 2px rgba(255, 255, 255, 0.1);
      z-index: 999;
      overflow: hidden;
    }

    .media-panel-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(125, 211, 252, 0.15), 
        rgba(192, 132, 252, 0.15));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .media-panel-toggle:hover::before {
      opacity: 1;
    }

    .media-panel-toggle:hover {
      transform: translateY(-4px);
      border-color: var(--accent-primary);
      box-shadow: 
        0 12px 32px rgba(0, 0, 0, 0.5),
        0 0 30px rgba(125, 211, 252, 0.6),
        inset 0 1px 3px rgba(255, 255, 255, 0.2);
    }

    .media-panel-toggle:active {
      transform: translateY(-2px);
    }

    /* Camera Icon SVG */
    .media-panel-toggle svg {
      width: 28px;
      height: 28px;
      fill: none;
      stroke: var(--accent-primary);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .media-panel-toggle:hover svg {
      stroke: var(--accent-secondary);
      transform: scale(1.1);
    }

    .media-panel-header {
      padding: 24px;
      background: linear-gradient(135deg, rgba(125, 211, 252, 0.1), rgba(192, 132, 252, 0.1));
      border-bottom: 1px solid rgba(125, 211, 252, 0.2);
    }

    .media-panel-header h3 {
      color: var(--text-strong);
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 16px 0;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .media-search-box {
      position: relative;
      width: 100%;
    }

    .media-search-box input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      background: rgba(37, 56, 117, 0.4);
      border: 1px solid rgba(125, 211, 252, 0.3);
      border-radius: 12px;
      color: var(--text-strong);
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .media-search-box input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .media-search-box input:focus {
      outline: none;
      border-color: var(--accent-primary);
      background: rgba(37, 56, 117, 0.6);
      box-shadow: 0 0 0 3px rgba(125, 211, 252, 0.1);
    }

    .media-search-icon {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.5);
      font-size: 16px;
      pointer-events: none;
    }

    .media-panel-content {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .media-panel-content::-webkit-scrollbar {
      width: 8px;
    }

    .media-panel-content::-webkit-scrollbar-track {
      background: rgba(125, 211, 252, 0.05);
      border-radius: 4px;
    }

    .media-panel-content::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 4px;
    }

    .media-item {
      margin-bottom: 24px;
      background: rgba(37, 56, 117, 0.3);
      border: 1px solid rgba(125, 211, 252, 0.2);
      border-radius: 16px;
      padding: 16px;
      transition: all 0.2s ease;
    }

    .media-item:hover {
      background: rgba(37, 56, 117, 0.4);
      border-color: rgba(125, 211, 252, 0.4);
      transform: translateX(-4px);
    }

    .media-item h4 {
      color: var(--accent-primary);
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
    }

    .media-item img, .media-item video {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(125, 211, 252, 0.2);
    }

    .media-item p {
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.6;
      margin: 0;
    }

    .media-item a {
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .media-item a:hover {
      color: var(--accent-secondary);
      text-decoration: underline;
    }

    /* Protected YouTube Video Container */
    .protected-video-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      margin-bottom: 12px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(125, 211, 252, 0.2);
      background: rgba(0, 0, 0, 0.4);
    }

    .protected-video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
      pointer-events: auto;
    }

    .video-unavailable {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-muted);
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }

    /* Custom HTML5 Video Player */
    .custom-video-player {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      margin-bottom: 12px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(125, 211, 252, 0.3);
      background: rgba(0, 0, 0, 0.9);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .custom-video-player video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }

    .video-controls-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
      padding: 20px 16px 16px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 10;
    }

    .custom-video-player:hover .video-controls-overlay,
    .video-controls-overlay.show {
      opacity: 1;
    }

    .video-controls-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .video-play-btn {
      background: rgba(125, 211, 252, 0.2);
      border: 1px solid rgba(125, 211, 252, 0.4);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--accent-primary);
      font-size: 18px;
      flex-shrink: 0;
    }

    .video-play-btn:hover {
      background: rgba(125, 211, 252, 0.3);
      border-color: var(--accent-primary);
      transform: scale(1.05);
    }

    .video-progress-container {
      flex: 1;
      height: 6px;
      background: rgba(125, 211, 252, 0.2);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .video-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      width: 0%;
      transition: width 0.1s linear;
      border-radius: 3px;
      position: relative;
    }

    .video-progress-bar::after {
      content: '';
      position: absolute;
      right: -6px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: var(--accent-primary);
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(125, 211, 252, 0.6);
    }

    .video-time {
      color: var(--text-strong);
      font-size: 13px;
      font-weight: 600;
      min-width: 90px;
      text-align: center;
      flex-shrink: 0;
    }

    .video-volume-btn {
      background: rgba(125, 211, 252, 0.2);
      border: 1px solid rgba(125, 211, 252, 0.4);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--accent-primary);
      font-size: 18px;
      flex-shrink: 0;
    }

    .video-volume-btn:hover {
      background: rgba(125, 211, 252, 0.3);
      border-color: var(--accent-primary);
    }

    .video-settings-btn {
      background: rgba(125, 211, 252, 0.2);
      border: 1px solid rgba(125, 211, 252, 0.4);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--accent-primary);
      font-size: 18px;
      flex-shrink: 0;
      position: relative;
    }

    .video-settings-btn:hover {
      background: rgba(125, 211, 252, 0.3);
      border-color: var(--accent-primary);
    }

    .video-fullscreen-btn {
      background: rgba(125, 211, 252, 0.2);
      border: 1px solid rgba(125, 211, 252, 0.4);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--accent-primary);
      font-size: 18px;
      flex-shrink: 0;
    }

    .video-fullscreen-btn:hover {
      background: rgba(125, 211, 252, 0.3);
      border-color: var(--accent-primary);
    }

    .video-settings-menu {
      position: absolute;
      bottom: 50px;
      right: 0;
      background: rgba(16, 24, 47, 0.98);
      border: 1px solid rgba(125, 211, 252, 0.3);
      border-radius: 12px;
      padding: 12px;
      min-width: 180px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      display: none;
      z-index: 20;
    }

    .video-settings-menu.show {
      display: block;
    }

    .video-settings-option {
      padding: 10px 12px;
      color: var(--text-strong);
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .video-settings-option:hover {
      background: rgba(125, 211, 252, 0.15);
    }

    .video-settings-option.active {
      background: rgba(125, 211, 252, 0.2);
      color: var(--accent-primary);
    }

    .video-loading-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
    }

    .video-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(125, 211, 252, 0.2);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* ==========================================================================
       CUSTOM ALERT MODAL
       ========================================================================== */
    .custom-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .custom-alert-modal {
      background: rgba(16, 24, 47, 0.95);
      border: 2px solid rgba(125, 211, 252, 0.4);
      border-radius: 24px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    .custom-alert-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 20px;
    }

    .custom-alert-title {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .custom-alert-message {
      color: var(--text-muted);
      font-size: 16px;
      line-height: 1.8;
      text-align: center;
      margin-bottom: 30px;
    }

    .custom-alert-button {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      border-radius: 12px;
      padding: 14px 32px;
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(125, 211, 252, 0.3);
    }

    .custom-alert-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(125, 211, 252, 0.5);
    }

    .custom-alert-button:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="viewer-container">
    <div class="viewer-header">
      <div>
        <h1 id="noteTitle">Loading PDF...</h1>
        <div class="student-name" id="studentName"></div>
      </div>
    </div>
    
    <div class="viewer-controls" id="viewerControls" style="display: none;">
      <div class="control-group">
        <button class="control-btn" id="prevPage" onclick="changePage(-1)">‚óÄ Previous</button>
        <span class="page-info">
          Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <button class="control-btn" id="nextPage" onclick="changePage(1)">Next ‚ñ∂</button>
      </div>
      
      <div class="control-group">
        <div class="zoom-controls">
          <button class="control-btn" onclick="changeZoom(-0.1)">-</button>
          <span class="zoom-level" id="zoomLevel">150%</span>
          <button class="control-btn" onclick="changeZoom(0.1)">+</button>
        </div>
        <button class="control-btn print-btn" onclick="printNote()">üñ®Ô∏è Print</button>
      </div>
    </div>
    
    <div class="pdf-content" id="pdfContent">
      <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-text">Loading protected PDF...</div>
      </div>
    </div>
  </div>

  <!-- Floating Media Button -->
  <button class="media-panel-toggle" id="mediaPanelToggle" onclick="toggleMediaPanel()" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
      <circle cx="12" cy="13" r="4"></circle>
    </svg>
  </button>

  <!-- Media Panel -->
  <div class="media-panel" id="mediaPanel">
    <div class="media-panel-header">
      <h3>üìö Study Resources</h3>
      <div class="media-search-box">
        <input 
          type="text" 
          id="mediaSearchInput" 
          placeholder="Search resources..." 
          oninput="filterMediaItems()"
        >
        <span class="media-search-icon">üîç</span>
      </div>
    </div>
    <div class="media-panel-content" id="mediaPanelContent">
      <!-- Media items will be loaded here -->
    </div>
  </div>

  <script>
    // ============================================================
    // CONSOLE PROTECTION - Filter out Drive URL leaks
    // ============================================================
    
    (function() {
      const originalError = console.error;
      const originalWarn = console.warn;
      const originalLog = console.log;
      
      // Keywords that indicate Drive/video URL exposure
      const blockedPatterns = [
        /drive\.google\.com/i,
        /youtube\.com/i,
        /youtu\.be/i,
        /allow-popups/i,
        /sandboxed frame/i,
        /file\/d\//i,
        /\?t=/i
      ];
      
      function shouldBlock(args) {
        const message = args.join(' ');
        return blockedPatterns.some(pattern => pattern.test(message));
      }
      
      console.error = function(...args) {
        if (!shouldBlock(args)) {
          originalError.apply(console, args);
        }
      };
      
      console.warn = function(...args) {
        if (!shouldBlock(args)) {
          originalWarn.apply(console, args);
        }
      };
      
      console.log = function(...args) {
        if (!shouldBlock(args)) {
          originalLog.apply(console, args);
        }
      };
    })();
    
    // ============================================================
    // SUPABASE CONFIGURATION
    // ============================================================
    
    const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
    let supabaseClient = null;

    try {
      if (!window.supabase || typeof window.supabase.createClient !== 'function') {
        throw new Error('Supabase SDK failed to load');
      }
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (supabaseInitError) {
      console.error('Supabase initialization failed:', supabaseInitError);
    }
    
    // ============================================================
    // PDF.js CONFIGURATION
    // ============================================================
    
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // ============================================================
    // VERSION & DEBUG
    // ============================================================
    
    const VIEWER_VERSION = 'v2.1.2-correct-supabase';
    console.log('üîµ PDF Viewer Version:', VIEWER_VERSION);
    console.log('üìÖ Loaded at:', new Date().toISOString());
    
    // ============================================================
    // GLOBAL VARIABLES
    // ============================================================
    
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let zoomLevel = 1.5; // 150% initial zoom
    let currentStudent = null;
    let fallbackStudent = null;
  let noteData = null;
  const attemptedPdfPaths = new Set();

    const getStudentDisplayName = () => {
      return (currentStudent && currentStudent.name) || (fallbackStudent && fallbackStudent.name) || 'Authorized Student';
    };

    const getStudentDisplayGroup = () => {
      return (currentStudent && (currentStudent.group || currentStudent.group_name)) || (fallbackStudent && (fallbackStudent.group || fallbackStudent.group_name)) || 'N/A';
    };

    const STORAGE_BUCKET = 'student-notes';
    const LOAD_TIMEOUT_MS = 15000;
    let loadingTimeoutHandle = null;
    let pendingRetryAction = null;
    let lastPdfLoader = null;
    let pdfHasRendered = false;

    const rememberLastPdfLoader = (loaderFn) => {
      lastPdfLoader = typeof loaderFn === 'function' ? loaderFn : null;
    };

    const retryLastPdfRequest = () => {
      if (typeof lastPdfLoader === 'function') {
        return lastPdfLoader();
      }
      return Promise.resolve();
    };

    const startLoadingState = (message = 'Loading protected PDF...') => {
      pdfHasRendered = false;
      const loadingScreen = document.getElementById('loadingScreen');
      if (loadingScreen) {
        loadingScreen.style.display = 'flex';
        const textEl = loadingScreen.querySelector('.loading-text');
        if (textEl) {
          textEl.textContent = message;
        }
      }
      clearTimeout(loadingTimeoutHandle);
      loadingTimeoutHandle = setTimeout(() => {
        if (!pdfHasRendered) {
          showError('This is taking longer than expected. Requesting a new secure link usually fixes it.', {
            retryAction: () => retryLastPdfRequest(),
            retryLabel: 'Retry Secure Load'
          });
        }
      }, LOAD_TIMEOUT_MS);
    };

    const stopLoadingState = () => {
      clearTimeout(loadingTimeoutHandle);
      const loadingScreen = document.getElementById('loadingScreen');
      if (loadingScreen) {
        loadingScreen.style.display = 'none';
      }
    };

    const clearPendingRetryAction = () => {
      pendingRetryAction = null;
    };

    const setViewerReadyState = () => {
      const totalPagesElement = document.getElementById('totalPages');
      if (totalPagesElement) {
        totalPagesElement.textContent = totalPages;
      }
      const controls = document.getElementById('viewerControls');
      if (controls) {
        controls.style.display = 'flex';
      }
      showMediaPanelToggle();
      pdfHasRendered = true;
      stopLoadingState();
      clearPendingRetryAction();
    };

    async function retryPendingAction() {
      if (typeof pendingRetryAction === 'function') {
        const action = pendingRetryAction;
        pendingRetryAction = null;
        await action();
      }
    }
    
    // ============================================================
    // DISABLE COPY/DOWNLOAD PROTECTION - ENHANCED
    // ============================================================
    
    // Disable right-click completely
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }, true);
    
    // Disable ALL keyboard shortcuts for save/copy/inspect
    document.addEventListener('keydown', (e) => {
      // Disable save shortcuts
      if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable copy shortcuts
      if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable select all
      if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'A')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable print shortcut (we have our own)
      if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
        e.preventDefault();
        e.stopPropagation();
        printNote(); // Use our protected print instead
        return false;
      }
      
      // Disable DevTools shortcuts
      if (e.key === 'F12' || 
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'i')) ||
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'J' || e.key === 'j')) ||
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'C' || e.key === 'c')) ||
          ((e.ctrlKey || e.metaKey) && (e.key === 'u' || e.key === 'U'))) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);
    
    // Disable text selection via mouse
    document.addEventListener('selectstart', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Disable drag-and-drop
    document.addEventListener('dragstart', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Disable copy event
    document.addEventListener('copy', (e) => {
      e.preventDefault();
      e.clipboardData.setData('text/plain', '');
      return false;
    }, true);
    
    // Disable cut event
    document.addEventListener('cut', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Monitor for DevTools (basic detection)
    let devtoolsOpen = false;
    const detectDevTools = () => {
      const threshold = 160;
      if (window.outerWidth - window.innerWidth > threshold || 
          window.outerHeight - window.innerHeight > threshold) {
        if (!devtoolsOpen) {
          devtoolsOpen = true;
          showCustomAlert();
        }
      } else {
        devtoolsOpen = false;
      }
    };
    setInterval(detectDevTools, 1000);
    
    // ============================================================
    // INITIALIZATION
    // ============================================================
    
    (async function init() {
      try {
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const pdfUrl = urlParams.get('url');
        const noteTitle = urlParams.get('title') || 'Class Notes';
        const noteId = urlParams.get('note'); // Legacy support
        const studentName = urlParams.get('studentName'); // Passed from portal
        const studentGroup = urlParams.get('studentGroup'); // Passed from portal

        if (!supabaseClient) {
          showError('Secure storage connection is unavailable. Please refresh the page to try again.', {
            retryAction: () => window.location.reload(),
            retryLabel: 'Refresh Page'
          });
          return;
        }
        
        if (!pdfUrl && !noteId) {
          showError('No note specified');
          return;
        }
        
        // Check if student info was passed via URL (for impersonation or direct links)
        if (studentName) {
          fallbackStudent = {
            name: studentName,
            group_name: studentGroup,
            group: studentGroup
          };
          currentStudent = fallbackStudent;
        }
        
        // Check authentication (support both regular auth and impersonation)
        // First check for impersonation token (if student info wasn't passed via URL)
        if (!currentStudent) {
          const impersonationToken = sessionStorage.getItem('impersonation_token');
          if (impersonationToken) {
            try {
              const tokenData = JSON.parse(impersonationToken);
              const { data: student, error: studentError } = await supabaseClient
                .from('students')
                .select('*')
                .eq('id', tokenData.studentId)
                .single();
              
              if (student && !studentError) {
                currentStudent = student;
              }
            } catch (e) {
              console.error('Error reading impersonation token:', e);
            }
          }
        }
        
        // If no impersonation, check regular auth session
        if (!currentStudent) {
          const { data: { session }, error: authError } = await supabaseClient.auth.getSession();
          
          if (authError || !session) {
            showError('Please log in to view this note');
            window.location.href = 'index.html';
            return;
          }
          
          // Get current student data by email
          const { data: student, error: studentError } = await supabaseClient
            .from('students')
            .select('*')
            .eq('email', session.user.email)
            .single();
          
          if (studentError || !student) {
            showError('Student profile not found');
            return;
          }
          
          currentStudent = student;
        }
        
        if (!currentStudent) {
          showError('Student profile not found');
          return;
        }
        document.getElementById('studentName').textContent = getStudentDisplayName();
        document.getElementById('noteTitle').textContent = noteTitle.replace(/\.pdf$/i, '');
        
        // Create mock note data for watermarking
        noteData = {
          title: noteTitle,
          class_date: new Date().toISOString()
        };
        
        // If URL provided directly (from new group notes system)
        if (pdfUrl) {
          document.getElementById('viewerControls').style.display = 'flex';
          showMediaPanelToggle();
          
          // CRITICAL: Fetch note metadata FIRST so we have pdf_url for fallback
          if (noteId) {
            try {
              console.log('üìã Fetching metadata for note ID:', noteId);
              const { data: note, error: noteError } = await supabaseClient
                .from('student_notes')
                .select('pdf_url, video_url, title, video_allowed_groups, video_controls, video_title')
                .eq('id', noteId)
                .single();
              
              if (noteError) {
                console.error('‚ùå Error loading note metadata:', noteError);
              } else if (note) {
                console.log('‚úÖ Loaded metadata. Canonical pdf_url:', note.pdf_url);
                noteData = {
                  ...noteData,
                  // Capture the canonical pdf_url from metadata so we can recover if the direct path breaks
                  pdf_url: note.pdf_url,
                  video_url: note.video_url,
                  video_allowed_groups: note.video_allowed_groups,
                  video_controls: note.video_controls,
                  video_title: note.video_title,
                  title: note.title
                };
              } else {
                console.warn('‚ö†Ô∏è No note metadata found for ID:', noteId);
              }
            } catch (e) {
              console.error('‚ùå Exception loading note metadata:', e);
            }
          } else {
            console.warn('‚ö†Ô∏è No noteId provided - fallback recovery will not be available');
          }
          
          // Check if it's a storage path or a full URL
          if (pdfUrl.startsWith('http://') || pdfUrl.startsWith('https://')) {
            // It's already a full URL, use it directly
            await loadPDFFromURL(pdfUrl);
          } else {
            // It's a storage path, create signed URL from student-notes bucket
            await loadPDFFromStorage(pdfUrl);
          }
          
          // Load media content after PDF is loaded
          await loadMediaContent();
          return;
        }
        
        // Legacy: Load from student_notes table
        if (noteId) {
          const { data: note, error: noteError } = await supabaseClient
            .from('student_notes')
            .select('*')
            .eq('id', noteId)
            .single();
          
          if (noteError || !note) {
            showError('Note not found');
            return;
          }
          
          noteData = note;
          
          // Verify student is in the correct group
          if (note.group_name !== currentStudent.group_name) {
            showError('This note is not for your group');
            return;
          }
          
          // Check if note requires payment
          if (note.requires_payment) {
            const { data: payments, error: paymentError } = await supabaseClient
              .from('payment_records')
              .select('*')
              .eq('student_id', currentStudent.id)
              .eq('status', 'paid')
              .limit(1);
            
            if (paymentError || !payments || payments.length === 0) {
              showError('üîí This note is locked. Payment required to access.');
              return;
            }
          }
          
          document.getElementById('noteTitle').textContent = (note.title || 'Class Notes').replace(/\.pdf$/i, '');
          await loadPDF(note.pdf_url);
          
          // Load media content (videos) for this note
          await loadMediaContent();
        }
        
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to load note: ' + error.message);
      }
    })();
    
    // ============================================================
    // PDF LOADING & RENDERING
    // ============================================================
    
    async function loadPDFFromURL(pdfUrl) {
      rememberLastPdfLoader(() => loadPDFFromURL(pdfUrl));
      startLoadingState('Loading protected PDF...');
      try {
        console.log('üîó Loading PDF from URL:', pdfUrl);
        const loadingTask = pdfjsLib.getDocument({
          url: pdfUrl,
          withCredentials: false
        });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        setViewerReadyState();
        await renderPage(1);
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF: ' + error.message, {
          retryAction: () => loadPDFFromURL(pdfUrl),
          retryLabel: 'Retry Secure Load'
        });
      }
    }
    
    async function loadPDFFromStorage(pdfPath) {
      if (!pdfPath) {
        showError('This note is missing its PDF file. Please contact your instructor.');
        return;
      }

      if (pdfPath.startsWith('http://') || pdfPath.startsWith('https://')) {
        await loadPDFFromURL(pdfPath);
        return;
      }

      if (!supabaseClient) {
        showError('Secure storage connection is unavailable. Please refresh the page.', {
          retryAction: () => window.location.reload(),
          retryLabel: 'Refresh Page'
        });
        return;
      }

      if (!attemptedPdfPaths.has(pdfPath)) {
        attemptedPdfPaths.add(pdfPath);
      }

      rememberLastPdfLoader(() => loadPDFFromStorage(pdfPath));
      startLoadingState('Generating secure link...');

      try {
        console.log('üîç Loading PDF from storage path:', pdfPath);
        const { data: signedUrlData, error: signedUrlError } = await supabaseClient.storage
          .from(STORAGE_BUCKET)
          .createSignedUrl(pdfPath, 3600);

        if (signedUrlError) {
          console.error('‚ùå Error creating signed URL:', signedUrlError);
          
          // Check if we can fallback to metadata pdf_url before failing
          const errorMessage = signedUrlError.message || 'Unknown storage error';
          const normalizedMessage = errorMessage.toLowerCase();
          const storageMissing = normalizedMessage.includes('object not found');
          const metadataFallbackPath = noteData && noteData.pdf_url && noteData.pdf_url !== pdfPath ? noteData.pdf_url : null;
          const canAttemptFallback = storageMissing && metadataFallbackPath && !attemptedPdfPaths.has(metadataFallbackPath);

          // Diagnostics: list available files in the same folder when storage says missing
          if (storageMissing) {
            try {
              const folderPrefix = pdfPath.includes('/') ? pdfPath.split('/').slice(0, -1).join('/') : '';
              const { data: listData, error: listError } = await supabaseClient.storage
                .from(STORAGE_BUCKET)
                .list(folderPrefix || undefined);
              if (listError) {
                console.warn('‚ö†Ô∏è Could not list storage folder for diagnostics:', listError.message);
              } else {
                console.warn(`üìÇ Storage contents for prefix "${folderPrefix || '[root]'}":`, listData?.map(item => item.name));
              }
            } catch (listEx) {
              console.warn('‚ö†Ô∏è Storage list diagnostic failed:', listEx);
            }
          }

          if (canAttemptFallback) {
            // Storage says the primary object is missing; try the canonical pdf_url stored in metadata
            console.warn('‚ö†Ô∏è Primary PDF path missing. Attempting metadata fallback:', metadataFallbackPath);
            await loadPDFFromStorage(metadataFallbackPath);
            return;
          }
          
          throw new Error(`Could not create signed URL: ${signedUrlError.message}`);
        }

        if (!signedUrlData || !signedUrlData.signedUrl) {
          throw new Error('Signed URL was not generated');
        }

        console.log('‚úÖ Created signed URL for:', pdfPath);

        const loadingTask = pdfjsLib.getDocument({
          url: signedUrlData.signedUrl,
          withCredentials: false
        });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        setViewerReadyState();
        await renderPage(1);
      } catch (error) {
        console.error('PDF loading error:', error);

        const errorMessage = (error && error.message) ? error.message : 'Unknown storage error';
        const normalizedMessage = errorMessage.toLowerCase();
        const storageMissing = normalizedMessage.includes('object not found');

        const details = storageMissing
          ? 'This secure file could not be found in storage. Please ask your instructor to re-upload it or update the PDF path.'
          : '';

        showError('Failed to load PDF: ' + errorMessage, {
          retryAction: () => loadPDFFromStorage(pdfPath),
          retryLabel: 'Retry Secure Load',
          details
        });
      }
    }
    
    async function loadPDF(pdfPath) {
      if (!pdfPath) {
        showError('This note is missing its PDF file. Please contact your instructor.');
        return;
      }
      await loadPDFFromStorage(pdfPath);
    }
    
    async function renderPage(pageNum) {
      try {
        const page = await pdfDoc.getPage(pageNum);
        
        // High-quality rendering: 3x scale for retina displays
        const scale = zoomLevel * 3.0;
        const viewport = page.getViewport({ scale: scale });
        
        // Create canvas for this page
        const canvas = document.createElement('canvas');
        canvas.className = 'page-canvas';
        const context = canvas.getContext('2d');
        
        // Set high-resolution canvas dimensions
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        // Scale down display size while maintaining quality
        canvas.style.width = (viewport.width / 3) + 'px';
        canvas.style.height = (viewport.height / 3) + 'px';
        
        // Render PDF page with high quality
        await page.render({
          canvasContext: context,
          viewport: viewport
        }).promise;
        
        // Create page container with watermark
        const pageContainer = document.createElement('div');
        pageContainer.className = 'page-container';
        
        // Add watermark overlay with ARNOMA logo and student info
        const watermark = document.createElement('div');
        watermark.className = 'watermark-overlay';
        watermark.innerHTML = `
          <div class="watermark-content">
            <div class="watermark-logo">ARNOMA</div>
            <div class="watermark-text">
              ${getStudentDisplayName()}<br>
              Group ${getStudentDisplayGroup()}
            </div>
          </div>
        `;
        
        pageContainer.appendChild(canvas);
        pageContainer.appendChild(watermark);
        
        // Clear and add to content
        const content = document.getElementById('pdfContent');
        content.innerHTML = '';
        content.appendChild(pageContainer);
        
        // Update page number
        currentPage = pageNum;
        document.getElementById('currentPage').textContent = currentPage;
        
        // Update button states
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
        if (!pdfHasRendered) {
          pdfHasRendered = true;
          stopLoadingState();
        }
        
      } catch (error) {
        console.error('Page rendering error:', error);
        showError('Failed to render page: ' + error.message);
      }
    }
    
    // ============================================================
    // NAVIGATION CONTROLS
    // ============================================================
    
    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= totalPages) {
        renderPage(newPage);
      }
    }
    
    function changeZoom(delta) {
      zoomLevel = Math.max(0.5, Math.min(2.5, zoomLevel + delta));
      document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
      renderPage(currentPage);
    }
    
    // ============================================================
    // PRINT FUNCTION (WITH WATERMARK)
    // ============================================================
    
    async function printNote() {
      try {
        // Render all pages for printing
        const content = document.getElementById('pdfContent');
        content.innerHTML = '<div class="loading-text">Preparing for print...</div>';
        
        for (let i = 1; i <= totalPages; i++) {
          const page = await pdfDoc.getPage(i);
          
          // High-quality print rendering: 2.5x scale
          const scale = 2.5;
          const viewport = page.getViewport({ scale: scale });
          
          const canvas = document.createElement('canvas');
          canvas.className = 'page-canvas';
          const context = canvas.getContext('2d');
          
          // High-resolution canvas
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          
          // Scale display for print
          canvas.style.width = (viewport.width / scale) + 'px';
          canvas.style.height = (viewport.height / scale) + 'px';
          
          await page.render({
            canvasContext: context,
            viewport: viewport
          }).promise;
          
          const pageContainer = document.createElement('div');
          pageContainer.className = 'page-container';
          
          const watermark = document.createElement('div');
          watermark.className = 'watermark-overlay';
          watermark.innerHTML = `
            <div class="watermark-content">
              <div class="watermark-logo">ARNOMA</div>
              <div class="watermark-text">
                ${currentStudent.name}<br>
                Group ${currentStudent.group || currentStudent.group_name || 'N/A'}
              </div>
            </div>
          `;
          
          pageContainer.appendChild(canvas);
          pageContainer.appendChild(watermark);
          content.appendChild(pageContainer);
        }
        
        // Trigger print dialog
        setTimeout(() => {
          window.print();
          // Restore single page view after print
          renderPage(currentPage);
        }, 500);
        
      } catch (error) {
        console.error('Print error:', error);
        alert('Failed to prepare for printing');
      }
    }
    
    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================
    
    function showError(message, options = {}) {
      stopLoadingState();
      const content = document.getElementById('pdfContent');
      if (!content) return;
      const { retryAction = null, retryLabel = 'Try Again', details = '' } = options;
      pendingRetryAction = typeof retryAction === 'function' ? retryAction : null;
      const detailHtml = details ? `<p>${details}</p>` : '';
      const actionHtml = pendingRetryAction ? `
        <div class="error-actions">
          <button class="retry-btn" onclick="retryPendingAction()">${retryLabel}</button>
        </div>
      ` : '';
      content.innerHTML = `
        <div class="error-message">
          <p>${message}</p>
          ${detailHtml}
          ${actionHtml}
        </div>
      `;
    }
    
    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { 
        month: 'long', 
        day: 'numeric', 
        year: 'numeric' 
      });
    }

    // Custom Alert Function
    function showCustomAlert() {
      const studentName = getStudentDisplayName();
      
      const overlay = document.createElement('div');
      overlay.className = 'custom-alert-overlay';
      overlay.innerHTML = `
        <div class="custom-alert-modal">
          <div class="custom-alert-icon">‚ö†Ô∏è</div>
          <div class="custom-alert-title">ATTENTION</div>
          <div class="custom-alert-message">
            This document belongs to <strong>ARNOMA</strong> and is provided exclusively for <strong>${studentName}</strong>.<br><br>
            Kindly respect the copyright and refrain from sharing it with others.<br><br>
            Thank you for your understanding.
          </div>
          <button class="custom-alert-button" onclick="this.closest('.custom-alert-overlay').remove()">
            I Understand
          </button>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      // Close on overlay click
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
    }

    // ============================================================
    // MEDIA PANEL FUNCTIONS
    // ============================================================
    
    /**
     * Extract YouTube video ID from various URL formats
     * Supports: youtube.com/watch?v=..., youtu.be/..., youtube.com/embed/...
     * CRITICAL: Never expose the full URL to the student - only use for iframe src
     */
    function extractYouTubeVideoId(url) {
      if (!url) return null;
      
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
        /^([a-zA-Z0-9_-]{11})$/ // Raw video ID
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      
      return null;
    }

    /**
     * Extract Google Drive file ID from various URL formats
     * Supports: drive.google.com/file/d/{id}/view, drive.google.com/open?id={id}
     */
    function extractGoogleDriveFileId(url) {
      if (!url) return null;
      
      const patterns = [
        /\/file\/d\/([a-zA-Z0-9_-]+)/, // /file/d/{fileId}/view or /file/d/{fileId}/edit
        /id=([a-zA-Z0-9_-]+)/, // ?id={fileId}
        /\/open\?id=([a-zA-Z0-9_-]+)/, // /open?id={fileId}
        /^([a-zA-Z0-9_-]{25,})$/ // Raw file ID (typically 25+ chars)
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      
      return null;
    }

    /**
     * Detect video source type (YouTube or Google Drive)
     */
    function detectVideoSource(url) {
      if (!url) return null;
      
      if (url.includes('youtube.com') || url.includes('youtu.be')) {
        return 'youtube';
      }
      
      if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
        return 'googledrive';
      }
      
      // Try to detect by ID pattern
      const youtubeId = extractYouTubeVideoId(url);
      if (youtubeId) return 'youtube';
      
      const driveId = extractGoogleDriveFileId(url);
      if (driveId) return 'googledrive';
      
      return null;
    }

    /**
     * Create a protected YouTube iframe embed
     * MAXIMUM SECURITY:
     * - No URL exposure anywhere (sandboxed iframe)
     * - Custom controls based on admin settings
     * - No right-click, inspect, or dev tools access to URL
     * - Privacy-enhanced mode (youtube-nocookie.com)
     */
    function createProtectedYouTubeEmbed(videoId, title = 'Study Video', controls = null) {
      if (!videoId) {
        return `
          <div class="media-item">
            <h4>üé• ${title}</h4>
            <div class="protected-video-container">
              <div class="video-unavailable">
                ‚ö†Ô∏è Video unavailable<br>
                <small>Invalid video link</small>
              </div>
            </div>
          </div>
        `;
      }
      
      // CRITICAL SECURITY: Use autoplay=1 to skip the red YouTube play button
      // When autoplay is enabled, video starts immediately with NO branding overlay
      // Combined with mute=1, this provides silent autoplay which students can unmute
      
      const embedUrl = `https://www.youtube-nocookie.com/embed/${videoId}?` + 
        'autoplay=1&' +                         // Autoplay to skip red button
        'mute=1&' +                             // Muted autoplay (required by browsers)
        'controls=0&' +                         // ZERO controls = NO YouTube branding
        'rel=0&' +                              // No related videos
        'modestbranding=1&' +                   // Minimal branding
        'showinfo=0&' +                         // No video info
        'fs=0&' +                               // NO fullscreen button
        'disablekb=1&' +                        // NO keyboard shortcuts
        'iv_load_policy=3&' +                   // No annotations
        'playsinline=1&' +                      // Inline playback
        'loop=0&' +                             // No loop
        'enablejsapi=0&' +                      // No JS API access
        'origin=' + window.location.origin;     // Restrict to our domain only
      
      return `
        <div class="media-item">
          <h4>üé• ${title}</h4>
          <div class="protected-video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; pointer-events: auto;">
            <iframe 
              src="${embedUrl}"
              title="Protected Video"
              frameborder="0"
              allow="autoplay; encrypted-media"
              sandbox="allow-scripts allow-same-origin"
              loading="lazy"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; pointer-events: auto;"
              oncontextmenu="return false;"
            ></iframe>
            <!-- Overlay to block YouTube branding that might appear -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 60px; pointer-events: none; z-index: 1;"></div>
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 60px; pointer-events: none; z-index: 1; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);"></div>
          </div>
          <p style="color: var(--accent-primary); font-size: 12px; margin-top: 8px; text-align: center;">
            üîí <strong>Protected ARNOMA Content</strong> - Sharing prohibited<br>
            <small style="opacity: 0.7;">Video starts muted - click to unmute and control</small>
          </p>
        </div>
      `;
    }

    /**
     * Create custom HTML5 video player with Google Drive source
     * MAXIMUM SECURITY & FLEXIBILITY:
     * - Uses signed Supabase URLs (stored from Drive, never exposed)
     * - Complete control over UI (no external branding)
     * - Custom controls (play, pause, volume, speed, quality, fullscreen)
     * - URL never visible to student (blob URLs or signed URLs)
     */
    function createCustomVideoPlayer(videoUrl, title = 'Study Video', videoId = null) {
      const playerId = `video-player-${Date.now()}`;
      
      return `
        <div class="media-item">
          <h4>üé• ${title}</h4>
          <div class="custom-video-player" id="${playerId}-container">
            <video 
              id="${playerId}"
              preload="metadata"
              playsinline
              controlsList="nodownload nofullscreen noremoteplayback"
              disablePictureInPicture
              oncontextmenu="return false;"
            >
              <source src="${videoUrl}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
            
            <div class="video-loading-overlay" id="${playerId}-loading" style="display: none;">
              <div class="video-spinner"></div>
            </div>
            
            <div class="video-controls-overlay" id="${playerId}-controls">
              <div class="video-controls-row">
                <button class="video-play-btn" id="${playerId}-play" onclick="togglePlayPause('${playerId}')">
                  ‚ñ∂Ô∏è
                </button>
                
                <div class="video-progress-container" id="${playerId}-progress-container" onclick="seekVideo(event, '${playerId}')">
                  <div class="video-progress-bar" id="${playerId}-progress"></div>
                </div>
                
                <div class="video-time" id="${playerId}-time">0:00 / 0:00</div>
                
                <button class="video-volume-btn" id="${playerId}-volume" onclick="toggleMute('${playerId}')">
                  üîä
                </button>
                
                <button class="video-settings-btn" id="${playerId}-settings" onclick="toggleSettings('${playerId}')">
                  ‚öôÔ∏è
                  <div class="video-settings-menu" id="${playerId}-settings-menu">
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 0.5)">
                      Speed: 0.5x
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 0.75)">
                      Speed: 0.75x
                    </div>
                    <div class="video-settings-option active" onclick="setPlaybackSpeed('${playerId}', 1)">
                      Speed: 1x ‚úì
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 1.25)">
                      Speed: 1.25x
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 1.5)">
                      Speed: 1.5x
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 2)">
                      Speed: 2x
                    </div>
                  </div>
                </button>
                
                <button class="video-fullscreen-btn" id="${playerId}-fullscreen" onclick="toggleFullscreen('${playerId}')">
                  ‚õ∂
                </button>
              </div>
            </div>
          </div>
          <p style="color: var(--accent-primary); font-size: 12px; margin-top: 8px; text-align: center;">
            üîí <strong>Protected ARNOMA Content</strong> - Sharing prohibited
          </p>
        </div>
      `;
    }

    // Video player control functions
    function togglePlayPause(playerId) {
      const video = document.getElementById(playerId);
      const playBtn = document.getElementById(`${playerId}-play`);
      
      if (video.paused) {
        video.play();
        playBtn.textContent = '‚è∏Ô∏è';
      } else {
        video.pause();
        playBtn.textContent = '‚ñ∂Ô∏è';
      }
    }

    function toggleMute(playerId) {
      const video = document.getElementById(playerId);
      const volumeBtn = document.getElementById(`${playerId}-volume`);
      
      video.muted = !video.muted;
      volumeBtn.textContent = video.muted ? 'üîá' : 'üîä';
    }

    function toggleSettings(playerId) {
      const settingsMenu = document.getElementById(`${playerId}-settings-menu`);
      settingsMenu.classList.toggle('show');
      
      // Close menu when clicking outside
      if (settingsMenu.classList.contains('show')) {
        setTimeout(() => {
          document.addEventListener('click', function closeSettings(e) {
            if (!settingsMenu.contains(e.target) && !e.target.closest(`#${playerId}-settings`)) {
              settingsMenu.classList.remove('show');
              document.removeEventListener('click', closeSettings);
            }
          });
        }, 10);
      }
    }

    function setPlaybackSpeed(playerId, speed) {
      const video = document.getElementById(playerId);
      const settingsMenu = document.getElementById(`${playerId}-settings-menu`);
      
      video.playbackRate = speed;
      
      // Update active state
      settingsMenu.querySelectorAll('.video-settings-option').forEach(opt => {
        opt.classList.remove('active');
        if (opt.textContent.includes(`${speed}x`)) {
          opt.classList.add('active');
          opt.innerHTML = opt.innerHTML.replace('‚úì', '') + ' ‚úì';
        } else {
          opt.innerHTML = opt.innerHTML.replace(' ‚úì', '');
        }
      });
      
      settingsMenu.classList.remove('show');
    }

    function toggleFullscreen(playerId) {
      const container = document.getElementById(`${playerId}-container`);
      
      if (!document.fullscreenElement) {
        if (container.requestFullscreen) {
          container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
          container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
          container.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    }

    function seekVideo(event, playerId) {
      const video = document.getElementById(playerId);
      const progressContainer = document.getElementById(`${playerId}-progress-container`);
      
      const rect = progressContainer.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      const percentage = clickX / rect.width;
      
      video.currentTime = percentage * video.duration;
    }

    function formatVideoTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }

    // Initialize video player event listeners
    function initializeVideoPlayer(playerId) {
      const video = document.getElementById(playerId);
      if (!video) return;
      
      const playBtn = document.getElementById(`${playerId}-play`);
      const progressBar = document.getElementById(`${playerId}-progress`);
      const timeDisplay = document.getElementById(`${playerId}-time`);
      const loadingOverlay = document.getElementById(`${playerId}-loading`);
      const controlsOverlay = document.getElementById(`${playerId}-controls`);
      
      // Show loading spinner
      video.addEventListener('waiting', () => {
        loadingOverlay.style.display = 'block';
      });
      
      video.addEventListener('canplay', () => {
        loadingOverlay.style.display = 'none';
      });
      
      // Update progress bar and time
      video.addEventListener('timeupdate', () => {
        const percentage = (video.currentTime / video.duration) * 100;
        progressBar.style.width = `${percentage}%`;
        
        timeDisplay.textContent = `${formatVideoTime(video.currentTime)} / ${formatVideoTime(video.duration)}`;
      });
      
      // Update play button on play/pause
      video.addEventListener('play', () => {
        playBtn.textContent = '‚è∏Ô∏è';
      });
      
      video.addEventListener('pause', () => {
        playBtn.textContent = '‚ñ∂Ô∏è';
      });
      
      // Show controls on hover or touch
      let controlsTimeout;
      const showControls = () => {
        controlsOverlay.classList.add('show');
        clearTimeout(controlsTimeout);
        controlsTimeout = setTimeout(() => {
          if (!video.paused) {
            controlsOverlay.classList.remove('show');
          }
        }, 3000);
      };
      
      video.addEventListener('mousemove', showControls);
      video.addEventListener('touchstart', showControls);
      
      // Click video to play/pause
      video.addEventListener('click', () => {
        togglePlayPause(playerId);
      });
      
      // Prevent right-click
      video.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        return false;
      });
    }

    /**
     * Create a protected Google Drive video embed with fullscreen support
     * MAXIMUM SECURITY + FULL FEATURES:
     * - Settings: Quality, Speed, Subtitles (native Drive controls)
     * - Play/Pause, Mute, Fullscreen (enabled)
     * - No URL exposure (sandboxed iframe)
     * - No download button (controlled by Drive sharing settings)
     */
    function createProtectedGoogleDriveEmbed(fileId, title = 'Study Video') {
      if (!fileId) {
        return `
          <div class="media-item">
            <h4>üé• ${title}</h4>
            <div class="protected-video-container">
              <div class="video-unavailable">
                ‚ö†Ô∏è Video unavailable<br>
                <small>Invalid Google Drive link</small>
              </div>
            </div>
          </div>
        `;
      }
      
      // CRITICAL SECURITY: Google Drive preview mode with fullscreen enabled
      // Students CANNOT access the file ID through iframe sandbox
      const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
      const playerId = `drive-player-${Date.now()}`;
      
      return `
        <div class="media-item">
          <h4>üé• ${title}</h4>
          <div class="protected-video-container" id="${playerId}-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px;">
            <iframe 
              id="${playerId}"
              src="${embedUrl}"
              title="Protected Video"
              frameborder="0"
              allow="autoplay; encrypted-media"
              allowfullscreen
              webkitallowfullscreen
              mozallowfullscreen
              sandbox="allow-scripts allow-same-origin"
              loading="lazy"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 12px;"
              oncontextmenu="return false;"
            ></iframe>
          </div>
          <p style="color: var(--accent-primary); font-size: 12px; margin-top: 8px; text-align: center;">
            üîí <strong>Protected ARNOMA Content</strong> - Sharing prohibited<br>
            <small style="opacity: 0.7;">Click ‚öôÔ∏è in video for quality & speed ‚Ä¢ Click ‚õ∂ for fullscreen</small>
          </p>
        </div>
      `;
    }

    /**
     * Create protected video embed (auto-detects YouTube or Google Drive)
     * - YouTube: Uses iframe with maximum security parameters
     * - Google Drive: Uses custom HTML5 player with signed URLs
     */
    function createProtectedVideoEmbed(videoUrl, title = 'Study Video', controls = null) {
      const source = detectVideoSource(videoUrl);
      
      if (source === 'youtube') {
        const videoId = extractYouTubeVideoId(videoUrl);
        return createProtectedYouTubeEmbed(videoId, title, controls);
      } else if (source === 'googledrive') {
        // For Google Drive, use custom HTML5 player
        // Admin stores Drive URL in database, we display with custom controls
        const fileId = extractGoogleDriveFileId(videoUrl);
        
        // Use iframe embed method (students can't download from preview mode)
        return createProtectedGoogleDriveEmbed(fileId, title);
      } else {
        return `
          <div class="media-item">
            <h4>üé• ${title}</h4>
            <div class="protected-video-container">
              <div class="video-unavailable">
                ‚ö†Ô∏è Video unavailable<br>
                <small>Unsupported video source. Use YouTube or Google Drive links.</small>
              </div>
            </div>
          </div>
        `;
      }
    }

    /**
     * Load media content for the current note
     * Fetches video_url from student_notes table and displays it securely
     * Checks group-specific access if video_allowed_groups is set
     */
    async function loadMediaContent() {
      const mediaPanelContent = document.getElementById('mediaPanelContent');
      
      // Check if we have noteData with video_url
      if (noteData && noteData.video_url) {
        // Check group-specific access
        const hasGroupAccess = checkVideoGroupAccess(noteData);
        
        if (!hasGroupAccess) {
          // Video exists but not allowed for this group
          mediaPanelContent.innerHTML = `
            <div class="media-item">
              <h4>üìö Study Resources</h4>
              <p style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                üîí Video content not available for your group.
              </p>
            </div>
          `;
          return;
        }
        
        // Use custom video_title if available, otherwise fall back to note title
        const videoTitle = noteData.video_title || noteData.title || 'Study Video';
        const videoEmbed = createProtectedVideoEmbed(noteData.video_url, videoTitle, noteData.video_controls);
        
        mediaPanelContent.innerHTML = videoEmbed;
      } else {
        // No video available - show placeholder
        mediaPanelContent.innerHTML = `
          <div class="media-item">
            <h4>üìö Study Resources</h4>
            <p style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
              No additional media available for this note.
            </p>
          </div>
        `;
      }
    }

    /**
     * Check if current student's group has access to the video
     * Returns true if:
     * - video_allowed_groups is NULL (all groups allowed)
     * - video_allowed_groups is empty array (all groups allowed)
     * - student's group is in video_allowed_groups array
     */
    function checkVideoGroupAccess(note) {
      // If no video, no need to check
      if (!note.video_url) return false;
      
      // If no restriction set (NULL or empty), allow all groups
      if (!note.video_allowed_groups || note.video_allowed_groups.length === 0) {
        return true;
      }
      
      // Get student's group letter
      const studentGroup = currentStudent?.group_letter || 
                          currentStudent?.group_name || 
                          currentStudent?.group || 
                          fallbackStudent?.group_letter ||
                          fallbackStudent?.group_name ||
                          fallbackStudent?.group;
      
      if (!studentGroup) return false;
      
      // Normalize to single letter (handle "Group A" or "A")
      const groupLetter = studentGroup.toString().trim().toUpperCase().replace(/^GROUP\s*/i, '').charAt(0);
      
      // Check if student's group is in allowed list
      return note.video_allowed_groups.some(allowedGroup => {
        const normalizedAllowed = allowedGroup.toString().trim().toUpperCase().replace(/^GROUP\s*/i, '').charAt(0);
        return normalizedAllowed === groupLetter;
      });
    }
    
    function toggleMediaPanel(event) {
      if (event) {
        event.stopPropagation(); // Prevent immediate close from document click
      }
      
      const panel = document.getElementById('mediaPanel');
      panel.classList.toggle('open');
      
      // Clear search when closing
      if (!panel.classList.contains('open')) {
        const searchInput = document.getElementById('mediaSearchInput');
        if (searchInput) {
          searchInput.value = '';
          filterMediaItems();
        }
      }
    }

    // Filter media items based on search input
    function filterMediaItems() {
      const searchInput = document.getElementById('mediaSearchInput');
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      const mediaItems = document.querySelectorAll('.media-item');
      
      mediaItems.forEach(item => {
        const title = item.querySelector('h4')?.textContent.toLowerCase() || '';
        const description = item.querySelector('p')?.textContent.toLowerCase() || '';
        
        if (title.includes(searchTerm) || description.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Show media panel toggle when PDF is loaded
    function showMediaPanelToggle() {
      const toggle = document.getElementById('mediaPanelToggle');
      if (toggle) {
        toggle.style.display = 'flex';
      }
    }

    // Close media panel when clicking outside
    document.addEventListener('click', function(event) {
      const panel = document.getElementById('mediaPanel');
      const toggle = document.getElementById('mediaPanelToggle');
      
      if (panel && panel.classList.contains('open')) {
        // Check if click is outside both panel and toggle button
        if (!panel.contains(event.target) && !toggle.contains(event.target)) {
          panel.classList.remove('open');
        }
      }
    });
  </script>
</body>
</html>
