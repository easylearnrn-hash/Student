<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Protected PDF Viewer - ARNOMA</title>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- PDF.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  <style>
    /* ==========================================================================
       CSS VARIABLES - Liquid Glass Design System
       ========================================================================== */
    :root {
      --bg-base: #020510;
      --bg-gradient-start: #030a1f;
      --bg-gradient-end: #050d2c;
      --panel-light: rgba(37, 56, 117, 0.85);
      --panel-dark: rgba(16, 24, 47, 0.92);
      --glass-border: rgba(125, 211, 252, 0.35);
      --accent-primary: #7dd3fc;
      --accent-secondary: #c084fc;
      --accent-tertiary: #f9a8d4;
      --glow-blue: rgba(125, 211, 252, 0.65);
      --glow-purple: rgba(192, 132, 252, 0.6);
      --text-strong: #f8fbff;
      --text-muted: rgba(255, 255, 255, 0.7);
      --card-shadow: 0 30px 120px rgba(3, 6, 19, 0.65);
      --panel-blur: 8px;
      --modal-blur: 14px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 80, 0.95));
      min-height: 100vh;
      padding: 30px;
      overflow-x: hidden;
      position: relative;
      
      /* Disable text selection - CRITICAL */
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      -webkit-touch-callout: none !important;
    }

    /* Liquid Glass Background Effect */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(102,126,234,0.12) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(118,75,162,0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    /* Force disable selection on all elements */
    * {
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
    
    .viewer-container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(16, 24, 47, 0.75);
      border: 1px solid rgba(125, 211, 252, 0.25);
      border-radius: 24px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      position: relative;
      z-index: 1;
    }
    
    .viewer-header {
      background: linear-gradient(135deg, rgba(125, 211, 252, 0.15), rgba(192, 132, 252, 0.15));
      border-bottom: 1px solid rgba(125, 211, 252, 0.2);
      color: var(--text-strong);
      padding: 28px 36px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .viewer-header h1 {
      font-size: 26px;
      font-weight: 700;
      background: linear-gradient(120deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }
    
    .viewer-header .student-name {
      font-size: 18px;
      color: var(--text-muted);
      font-weight: 500;
      margin-top: 6px;
    }
    
    .viewer-controls {
      background: rgba(37, 56, 117, 0.4);
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      padding: 18px 36px;
      border-bottom: 1px solid rgba(125, 211, 252, 0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .control-btn {
      background: rgba(125, 211, 252, 0.1);
      border: 1px solid rgba(125, 211, 252, 0.3);
      padding: 10px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--accent-primary);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    
    .control-btn:hover:not(:disabled) {
      background: rgba(125, 211, 252, 0.2);
      border-color: var(--accent-primary);
      box-shadow: 0 8px 24px rgba(125, 211, 252, 0.3);
      transform: translateY(-2px);
    }

    .control-btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .control-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: rgba(125, 211, 252, 0.05);
      border-color: rgba(125, 211, 252, 0.1);
    }
    
    .print-btn {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
      color: #6ee7b7;
      border-color: rgba(16, 185, 129, 0.4);
    }
    
    .print-btn:hover {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3));
      border-color: #10b981;
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
    }
    
    .page-info {
      font-size: 14px;
      color: var(--text-strong);
      font-weight: 600;
      padding: 8px 16px;
      background: rgba(125, 211, 252, 0.08);
      border-radius: 8px;
      border: 1px solid rgba(125, 211, 252, 0.2);
    }
    
    .pdf-content {
      padding: 36px;
      background: rgba(2, 5, 16, 0.3);
      min-height: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      position: relative;
    }
    
    .page-container {
      position: relative;
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
      margin-bottom: 24px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(125, 211, 252, 0.1);
    }

    .page-screenshot-frame {
      position: relative;
      width: 100%;
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(125, 211, 252, 0.08);
      background-repeat: no-repeat;
      background-position: top center;
      background-size: contain;
    }

    .page-screenshot-image {
      width: 100%;
      height: auto;
      display: block;
      background: #ffffff;
    }

    .page-screenshot-canvas {
      display: none;
    }

    .page-screenshot-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
      background: rgba(2, 6, 23, 0.65);
      color: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(125, 211, 252, 0.35);
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.45);
    }
    
    .page-canvas {
      display: block;
      max-width: 100%;
      height: auto;
      pointer-events: none; /* Prevent any interaction with canvas */
      
      /* High-quality rendering settings */
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      image-rendering: high-quality;
      -ms-interpolation-mode: bicubic;
    }
    
    .watermark-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px;
    }
    
    .watermark-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      opacity: 0.25;
      transform: rotate(-45deg) translateX(40px);
      width: 120%;
      max-width: none;
    }
    
    .watermark-logo {
      font-size: 200px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
      letter-spacing: 12px;
      margin: 0;
      line-height: 1;
    }
    
    .watermark-text {
      font-size: 48px;
      font-weight: 700;
      background: linear-gradient(120deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      line-height: 1.8;
      margin: 0;
    }
    
    .watermark-info {
      display: none;
    }
    
    .loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 40px;
      gap: 24px;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(125, 211, 252, 0.2);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 16px;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .error-message {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
      color: #fca5a5;
      padding: 24px 32px;
      border-radius: 16px;
      text-align: center;
      margin: 48px;
      border: 1px solid rgba(239, 68, 68, 0.3);
      backdrop-filter: blur(var(--panel-blur));
      -webkit-backdrop-filter: blur(var(--panel-blur));
      font-weight: 500;
    }
    
    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .zoom-level {
      font-size: 14px;
      color: var(--text-strong);
      font-weight: 600;
      min-width: 60px;
      text-align: center;
      padding: 6px 12px;
      background: rgba(125, 211, 252, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(125, 211, 252, 0.2);
    }
    
    /* ==========================================================================
       RESPONSIVE DESIGN
       ========================================================================== */
    
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }

      .viewer-header {
        padding: 20px 24px;
      }

      .viewer-header h1 {
        font-size: 22px;
      }

      .viewer-controls {
        padding: 16px 20px;
        flex-direction: column;
        gap: 12px;
      }

      .control-group {
        width: 100%;
        justify-content: space-between;
      }

      .pdf-content {
        padding: 20px 16px;
      }

      .watermark-overlay {
        padding: 40px;
      }

      .watermark-logo {
        font-size: 120px;
        letter-spacing: 8px;
      }

      .watermark-text {
        font-size: 32px;
      }

      .watermark-info {
        font-size: 16px;
      }
    }

    /* ==========================================================================
       PRINT STYLES - ANTI-PDF-SAVE PROTECTION
       ========================================================================== */
    
    @page {
      size: auto;
      margin: 0;
    }

    @media print {
      body {
        background: white;
        padding: 0;
        margin: 0;
      }

      body::before {
        display: none;
      }
      
      .viewer-header,
      .viewer-controls {
        display: none !important;
      }
      
      .viewer-container {
        box-shadow: none;
        border-radius: 0;
        background: white;
        border: none;
      }
      
      .pdf-content {
        padding: 0;
        background: white;
      }
      
      .page-container {
        page-break-after: always;
        page-break-inside: avoid;
        box-shadow: none;
        margin: 0;
        padding: 0;
        border: none;
        border-radius: 0;
        background: white;
        position: relative;
        width: 100%;
        height: auto;
      }
      
      .page-container:last-child {
        page-break-after: auto;
      }
      
      /* CRITICAL: Watermark must appear prominently in print */
      .watermark-overlay {
        display: flex !important;
        opacity: 1 !important;
        z-index: 9999 !important;
        pointer-events: none !important;
        background: transparent !important; /* FIXED: Transparent so content shows through */
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
      }
      
      .watermark-content {
        opacity: 0.25 !important; /* Match screen opacity */
        transform: rotate(-45deg) translateX(40px) !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 24px !important;
        width: 120% !important;
        max-width: none !important;
      }
      
      .watermark-logo {
        font-size: 200px !important;
        font-weight: 900 !important;
        background: linear-gradient(135deg, #667eea, #764ba2) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
        letter-spacing: 12px !important;
        margin: 0 !important;
        line-height: 1 !important;
      }
      
      .watermark-text {
        font-size: 48px !important;
        font-weight: 700 !important;
        background: linear-gradient(120deg, #667eea, #764ba2) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
        text-align: center !important;
        line-height: 1.8 !important;
        margin: 0 !important;
      }

      /* Corner watermarks for better coverage on white areas */
      .watermark-corner-tl {
        justify-content: flex-start !important;
        align-items: flex-start !important;
        padding: 20px !important;
      }

      .watermark-corner-tr {
        justify-content: flex-end !important;
        align-items: flex-start !important;
        padding: 20px !important;
      }

      .watermark-corner-bl {
        justify-content: flex-start !important;
        align-items: flex-end !important;
        padding: 20px !important;
      }

      .watermark-corner-br {
        justify-content: flex-end !important;
        align-items: flex-end !important;
        padding: 20px !important;
      }

      .watermark-content-small {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        gap: 4px !important;
        text-align: center !important;
        transform: none !important;
        opacity: 0.25 !important; /* Match screen opacity */
      }

      .watermark-content-small div {
        color: #667eea !important; /* Solid color instead of gradient */
        background: none !important;
      }
      
      /* üîí PRINT PROTECTION: Show high-quality content with prominent watermark */
      /* Convert canvas to images for Safari compatibility */
      .page-image {
        display: block !important;
        max-width: 100% !important;
        width: 100% !important;
        height: auto !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        page-break-inside: avoid !important;
      }

      .page-screenshot-frame {
        border: none;
        border-radius: 0;
        box-shadow: none;
        position: relative;
        width: 100%;
        height: auto;
        display: block !important;
        page-break-inside: avoid !important;
      }

      .page-screenshot-badge {
        display: none !important; /* Hide badge in print */
      }
      
      .page-canvas-screen {
        display: none !important;
      }

      .page-screenshot-canvas {
        display: none !important;
      }

      .page-screenshot-image {
        display: block !important;
        max-width: 100% !important;
        width: 100% !important;
        height: auto !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        page-break-inside: avoid !important;
        opacity: 1 !important;
        visibility: visible !important;
        position: relative !important;
        z-index: 1 !important;
        object-fit: contain !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* Ensure all images print */
      img {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* Watermark ensures attribution even if saved as PDF */
    }

    /* ==========================================================================
       MEDIA PANEL - For GIFs, Videos, Interactive Content
       ========================================================================== */
    .media-panel {
      position: fixed;
      right: -420px;
      top: 80px;
      bottom: 80px;
      width: 400px;
      background: rgba(16, 24, 47, 0.95);
      border: 1px solid rgba(125, 211, 252, 0.3);
      border-right: none;
      border-radius: 24px 0 0 24px;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .media-panel.open {
      right: 0;
    }

    .media-panel-toggle {
      position: fixed;
      right: 30px;
      bottom: 30px;
      width: 64px;
      height: 64px;
      background: rgba(16, 24, 47, 0.85);
      border: 2px solid rgba(125, 211, 252, 0.5);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 8px 24px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(125, 211, 252, 0.3),
        inset 0 1px 2px rgba(255, 255, 255, 0.1);
      z-index: 999;
      overflow: hidden;
    }

    .media-panel-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(125, 211, 252, 0.15), 
        rgba(192, 132, 252, 0.15));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .media-panel-toggle:hover::before {
      opacity: 1;
    }

    .media-panel-toggle:hover {
      transform: translateY(-4px);
      border-color: var(--accent-primary);
      box-shadow: 
        0 12px 32px rgba(0, 0, 0, 0.5),
        0 0 30px rgba(125, 211, 252, 0.6),
        inset 0 1px 3px rgba(255, 255, 255, 0.2);
    }

    .media-panel-toggle:active {
      transform: translateY(-2px);
    }

    /* Camera Icon SVG */
    .media-panel-toggle svg {
      width: 28px;
      height: 28px;
      fill: none;
      stroke: var(--accent-primary);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .media-panel-toggle:hover svg {
      stroke: var(--accent-secondary);
      transform: scale(1.1);
    }

    .media-panel-header {
      padding: 24px;
      background: linear-gradient(135deg, rgba(125, 211, 252, 0.1), rgba(192, 132, 252, 0.1));
      border-bottom: 1px solid rgba(125, 211, 252, 0.2);
    }

    .media-panel-header h3 {
      color: var(--text-strong);
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 16px 0;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .media-search-box {
      position: relative;
      width: 100%;
    }

    .media-search-box input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      background: rgba(37, 56, 117, 0.4);
      border: 1px solid rgba(125, 211, 252, 0.3);
      border-radius: 12px;
      color: var(--text-strong);
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .media-search-box input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .media-search-box input:focus {
      outline: none;
      border-color: var(--accent-primary);
      background: rgba(37, 56, 117, 0.6);
      box-shadow: 0 0 0 3px rgba(125, 211, 252, 0.1);
    }

    .media-search-icon {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.5);
      font-size: 16px;
      pointer-events: none;
    }

    .media-panel-content {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .media-panel-content::-webkit-scrollbar {
      width: 8px;
    }

    .media-panel-content::-webkit-scrollbar-track {
      background: rgba(125, 211, 252, 0.05);
      border-radius: 4px;
    }

    .media-panel-content::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 4px;
    }

    .media-item {
      margin-bottom: 24px;
      background: rgba(37, 56, 117, 0.3);
      border: 1px solid rgba(125, 211, 252, 0.2);
      border-radius: 16px;
      padding: 16px;
      transition: all 0.2s ease;
    }

    .media-item:hover {
      background: rgba(37, 56, 117, 0.4);
      border-color: rgba(125, 211, 252, 0.4);
      transform: translateX(-4px);
    }

    .media-item h4 {
      color: var(--accent-primary);
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
    }

    .media-item img, .media-item video {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(125, 211, 252, 0.2);
    }

    .media-item p {
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.6;
      margin: 0;
    }

    .media-item a {
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .media-item a:hover {
      color: var(--accent-secondary);
      text-decoration: underline;
    }

    /* Protected YouTube Video Container */
    .protected-video-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      margin-bottom: 12px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(125, 211, 252, 0.2);
      background: rgba(0, 0, 0, 0.4);
    }

    .protected-video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
      pointer-events: auto;
    }

    .video-unavailable {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-muted);
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }

    /* Custom HTML5 Video Player */
    .custom-video-player {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      margin-bottom: 12px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(125, 211, 252, 0.3);
      background: rgba(0, 0, 0, 0.9);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .custom-video-player video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }

    .video-controls-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
      padding: 20px 16px 16px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 10;
    }

    .custom-video-player:hover .video-controls-overlay,
    .video-controls-overlay.show {
      opacity: 1;
    }

    .video-controls-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .video-play-btn {
      background: rgba(125, 211, 252, 0.2);
      border: 1px solid rgba(125, 211, 252, 0.4);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--accent-primary);
      font-size: 18px;
      flex-shrink: 0;
    }

    .video-play-btn:hover {
      background: rgba(125, 211, 252, 0.3);
      border-color: var(--accent-primary);
      transform: scale(1.05);
    }

    .video-progress-container {
      flex: 1;
      height: 6px;
      background: rgba(125, 211, 252, 0.2);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .video-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      width: 0%;
      transition: width 0.1s linear;
      border-radius: 3px;
      position: relative;
    }

    .video-progress-bar::after {
      content: '';
      position: absolute;
      right: -6px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: var(--accent-primary);
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(125, 211, 252, 0.6);
    }

    .video-time {
      color: var(--text-strong);
      font-size: 13px;
      font-weight: 600;
      min-width: 90px;
      text-align: center;
      flex-shrink: 0;
    }

    .video-volume-btn {
      background: rgba(125, 211, 252, 0.2);
      border: 1px solid rgba(125, 211, 252, 0.4);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--accent-primary);
      font-size: 18px;
      flex-shrink: 0;
    }

    .video-volume-btn:hover {
      background: rgba(125, 211, 252, 0.3);
      border-color: var(--accent-primary);
    }

    .video-settings-btn {
      background: rgba(125, 211, 252, 0.2);
      border: 1px solid rgba(125, 211, 252, 0.4);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--accent-primary);
      font-size: 18px;
      flex-shrink: 0;
      position: relative;
    }

    .video-settings-btn:hover {
      background: rgba(125, 211, 252, 0.3);
      border-color: var(--accent-primary);
    }

    .video-fullscreen-btn {
      background: rgba(125, 211, 252, 0.2);
      border: 1px solid rgba(125, 211, 252, 0.4);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--accent-primary);
      font-size: 18px;
      flex-shrink: 0;
    }

    .video-fullscreen-btn:hover {
      background: rgba(125, 211, 252, 0.3);
      border-color: var(--accent-primary);
    }

    .video-settings-menu {
      position: absolute;
      bottom: 50px;
      right: 0;
      background: rgba(16, 24, 47, 0.98);
      border: 1px solid rgba(125, 211, 252, 0.3);
      border-radius: 12px;
      padding: 12px;
      min-width: 180px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      display: none;
      z-index: 20;
    }

    .video-settings-menu.show {
      display: block;
    }

    .video-settings-option {
      padding: 10px 12px;
      color: var(--text-strong);
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .video-settings-option:hover {
      background: rgba(125, 211, 252, 0.15);
    }

    .video-settings-option.active {
      background: rgba(125, 211, 252, 0.2);
      color: var(--accent-primary);
    }

    .video-loading-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
    }

    .video-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(125, 211, 252, 0.2);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* ==========================================================================
       CUSTOM ALERT MODAL
       ========================================================================== */
    .custom-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .custom-alert-modal {
      background: rgba(16, 24, 47, 0.95);
      border: 2px solid rgba(125, 211, 252, 0.4);
      border-radius: 24px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(var(--modal-blur));
      -webkit-backdrop-filter: blur(var(--modal-blur));
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    .custom-alert-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 20px;
    }

    .custom-alert-title {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .custom-alert-message {
      color: var(--text-muted);
      font-size: 16px;
      line-height: 1.8;
      text-align: center;
      margin-bottom: 30px;
    }

    .custom-alert-button {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      border-radius: 12px;
      padding: 14px 32px;
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(125, 211, 252, 0.3);
    }

    .custom-alert-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(125, 211, 252, 0.5);
    }

    .custom-alert-button:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="viewer-container">
    <div class="viewer-header">
      <div>
        <h1 id="noteTitle">Loading PDF...</h1>
        <div class="student-name" id="studentName"></div>
      </div>
    </div>
    
    <div class="viewer-controls" id="viewerControls" style="display: none;">
      <div class="control-group">
        <button class="control-btn" id="prevPage" onclick="changePage(-1)">‚óÄ Previous</button>
        <span class="page-info">
          Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <button class="control-btn" id="nextPage" onclick="changePage(1)">Next ‚ñ∂</button>
      </div>
      
      <div class="control-group">
        <div class="zoom-controls">
          <button class="control-btn" onclick="changeZoom(-0.1)">-</button>
          <span class="zoom-level" id="zoomLevel">150%</span>
          <button class="control-btn" onclick="changeZoom(0.1)">+</button>
        </div>
  <button class="control-btn print-btn" id="printButton" onclick="printNote()">üñ®Ô∏è Print</button>
      </div>
    </div>
    
    <div class="pdf-content" id="pdfContent">
      <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingStatus">Loading protected PDF...</div>
      </div>
    </div>
  </div>

  <!-- Floating Media Button -->
  <button class="media-panel-toggle" id="mediaPanelToggle" onclick="toggleMediaPanel()" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
      <circle cx="12" cy="13" r="4"></circle>
    </svg>
  </button>

  <!-- Media Panel -->
  <div class="media-panel" id="mediaPanel">
    <div class="media-panel-header">
      <h3>üìö Study Resources</h3>
      <div class="media-search-box">
        <input 
          type="text" 
          id="mediaSearchInput" 
          placeholder="Search resources..." 
          oninput="filterMediaItems()"
        >
        <span class="media-search-icon">üîç</span>
      </div>
    </div>
    <div class="media-panel-content" id="mediaPanelContent">
      <!-- Media items will be loaded here -->
    </div>
  </div>

  <script>
    // ============================================================
    // CONSOLE PROTECTION - Filter out Drive URL leaks
    // ============================================================
    
    (function() {
      const originalError = console.error;
      const originalWarn = console.warn;
      const originalLog = console.log;
      
      // Keywords that indicate Drive/video URL exposure
      const blockedPatterns = [
        /drive\.google\.com/i,
        /youtube\.com/i,
        /youtu\.be/i,
        /allow-popups/i,
        /sandboxed frame/i,
        /file\/d\//i,
        /\?t=/i
      ];
      
      function shouldBlock(args) {
        const message = args.join(' ');
        return blockedPatterns.some(pattern => pattern.test(message));
      }
      
      console.error = function(...args) {
        if (!shouldBlock(args)) {
          originalError.apply(console, args);
        }
      };
      
      console.warn = function(...args) {
        if (!shouldBlock(args)) {
          originalWarn.apply(console, args);
        }
      };
      
      console.log = function(...args) {
        if (!shouldBlock(args)) {
          originalLog.apply(console, args);
        }
      };
    })();
    
    // ============================================================
    // SUPABASE CONFIGURATION
    // ============================================================
    
    const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ============================================================
    // PDF.js CONFIGURATION
    // ============================================================
    
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // ============================================================
    // VERSION & DEBUG
    // ============================================================
    
    const VIEWER_VERSION = 'v2.1.0-signed-urls';
    console.log('üîµ PDF Viewer Version:', VIEWER_VERSION);
    console.log('üìÖ Loaded at:', new Date().toISOString());
    
    // ============================================================
    // GLOBAL VARIABLES
    // ============================================================
    
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let zoomLevel = 1.5; // 150% initial zoom
    let currentStudent = null;
    let fallbackStudent = null;
    let noteData = null;
    let currentLoadingMessage = 'Loading protected PDF...';
    let isPreparingPrint = false;

    function updateLoadingStatus(message) {
      currentLoadingMessage = message;
      const statusEl = document.getElementById('loadingStatus');
      if (statusEl) {
        statusEl.textContent = message;
      }
    }

    function showLoadingScreen(message = currentLoadingMessage) {
      updateLoadingStatus(message);
      const loadingEl = document.getElementById('loadingScreen');
      if (loadingEl) {
        loadingEl.style.display = 'flex';
      }
    }

    function hideLoadingScreen() {
      const loadingEl = document.getElementById('loadingScreen');
      if (loadingEl) {
        loadingEl.style.display = 'none';
      }
    }

    const getStudentDisplayName = () => {
      return (currentStudent && currentStudent.name) || (fallbackStudent && fallbackStudent.name) || 'Authorized Student';
    };

    const getStudentDisplayGroup = () => {
      return (currentStudent && (currentStudent.group || currentStudent.group_name)) || (fallbackStudent && (fallbackStudent.group || fallbackStudent.group_name)) || 'N/A';
    };
    
    // ============================================================
    // DISABLE COPY/DOWNLOAD PROTECTION - ENHANCED
    // ============================================================
    
    // Disable right-click completely
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }, true);
    
    // Disable ALL keyboard shortcuts for save/copy/inspect
    document.addEventListener('keydown', (e) => {
      // Disable save shortcuts
      if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable copy shortcuts
      if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable select all
      if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'A')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Disable print shortcut (we have our own)
      if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
        e.preventDefault();
        e.stopPropagation();
        printNote(); // Use our protected print instead
        return false;
      }
      
      // Disable DevTools shortcuts
      if (e.key === 'F12' || 
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'i')) ||
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'J' || e.key === 'j')) ||
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'C' || e.key === 'c')) ||
          ((e.ctrlKey || e.metaKey) && (e.key === 'u' || e.key === 'U'))) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);
    
    // Disable text selection via mouse
    document.addEventListener('selectstart', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Disable drag-and-drop
    document.addEventListener('dragstart', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Disable copy event
    document.addEventListener('copy', (e) => {
      e.preventDefault();
      e.clipboardData.setData('text/plain', '');
      return false;
    }, true);
    
    // Disable cut event
    document.addEventListener('cut', (e) => {
      e.preventDefault();
      return false;
    }, true);
    
    // Monitor for DevTools (basic detection)
    let devtoolsOpen = false;
    const detectDevTools = () => {
      const threshold = 160;
      if (window.outerWidth - window.innerWidth > threshold || 
          window.outerHeight - window.innerHeight > threshold) {
        if (!devtoolsOpen) {
          devtoolsOpen = true;
          showCustomAlert();
        }
      } else {
        devtoolsOpen = false;
      }
    };
    setInterval(detectDevTools, 1000);
    
    // ============================================================
    // INITIALIZATION
    // ============================================================
    
    (async function init() {
      try {
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const pdfUrl = urlParams.get('url');
        const noteTitle = urlParams.get('title') || 'Class Notes';
        const noteId = urlParams.get('note'); // Legacy support
        const studentName = urlParams.get('studentName'); // Passed from portal
        const studentGroup = urlParams.get('studentGroup'); // Passed from portal
        const studentIdParam = urlParams.get('studentId');
        const classDateOverride = urlParams.get('classDate'); // üî• Group-specific post date from portal
        const parsedStudentId = studentIdParam && !Number.isNaN(Number(studentIdParam))
          ? Number(studentIdParam)
          : null;
        const urlGroupLetter = studentGroup
          ? studentGroup.toString().trim().toUpperCase().replace(/^GROUP\s*/i, '').charAt(0)
          : null;
        
        if (!pdfUrl && !noteId) {
          showError('No note specified');
          return;
        }
        
        // Check if student info was passed via URL (for impersonation or direct links)
        if (studentName) {
          fallbackStudent = {
            id: parsedStudentId || undefined,
            name: studentName,
            group_name: studentGroup,
            group: studentGroup,
            group_letter: urlGroupLetter || undefined
          };
          currentStudent = fallbackStudent;
        }
        
        // Check authentication (support both regular auth and impersonation)
        // First check for impersonation token (if student info wasn't passed via URL)
        if (!currentStudent || !currentStudent.id) {
          const impersonationToken = sessionStorage.getItem('impersonation_token');
        if (impersonationToken) {
          try {
            const tokenData = JSON.parse(impersonationToken);
            const { data: student, error: studentError } = await supabaseClient
              .from('students')
              .select('*')
              .eq('id', tokenData.studentId)
              .single();              if (student && !studentError) {
                currentStudent = student;
              }
            } catch (e) {
              console.error('Error reading impersonation token:', e);
            }
          }
        }
        
        // If no impersonation, check regular auth session
        if (!currentStudent || !currentStudent.id) {
          const { data: { session }, error: authError } = await supabaseClient.auth.getSession();
          
          if (authError || !session) {
            showError('Please log in to view this note');
            window.location.href = 'index.html';
            return;
          }
          
          // Get current student data by email
          const { data: student, error: studentError } = await supabaseClient
            .from('students')
            .select('*')
            .eq('email', session.user.email)
            .single();
          
          if (studentError || !student) {
            showError('Student profile not found');
            return;
          }
          
          currentStudent = student;
        }
        
        if (!currentStudent) {
          showError('Student profile not found');
          return;
        }
  document.getElementById('studentName').textContent = getStudentDisplayName();
        document.getElementById('noteTitle').textContent = noteTitle.replace(/\.pdf$/i, '');
        
        // Create mock note data for watermarking
        noteData = {
          title: noteTitle,
          class_date: new Date().toISOString()
        };
        
        // If URL provided directly (from new group notes system)
        if (pdfUrl) {
          document.getElementById('viewerControls').style.display = 'flex';
        showMediaPanelToggle();
          
          // CRITICAL: Fetch note data from database to verify group access
          if (noteId) {
            try {
              updateLoadingStatus('Locating note details...');
              const { data: note, error: noteError } = await supabaseClient
                .from('student_notes')
                .select('*')
                .eq('id', noteId)
                .single();
              
              if (noteError || !note) {
                console.error('Note not found in database:', noteError);
                showError('‚ùå Note not found in database');
                return;
              }
              
              // ============================================================
              // GROUP ACCESS VALIDATION - CRITICAL SECURITY CHECK
              // ============================================================
              
              // Normalize student's group (handle group_letter, group_name, group)
              const studentGroup = (
                currentStudent.group_letter || 
                currentStudent.group_name || 
                currentStudent.group || 
                ''
              ).toString().trim().toUpperCase().replace(/^GROUP\s*/i, '');
              const normalizedGroupName = studentGroup ? `Group ${studentGroup}` : '';
              
              updateLoadingStatus('Confirming group permissions...');
              console.log('üîê Group Access Check:');
              console.log('  Student Group:', studentGroup);
              console.log('  Student ID:', currentStudent.id);
              console.log('  Note ID:', noteId);
              
              // Check if student has access via note_free_access table
              // (either group access or individual access)
              // Build query based on available data
              let query = supabaseClient
                .from('note_free_access')
                .select('*')
                .eq('note_id', noteId);
              
              // Build OR condition: check group OR individual access
              const orConditions = [];
              if (studentGroup) {
                orConditions.push(`group_letter.eq.${studentGroup}`);
              }
              if (currentStudent.id) {
                orConditions.push(`student_id.eq.${currentStudent.id}`);
              }
              
              // Apply OR filter if we have conditions
              if (orConditions.length > 0) {
                query = query.or(orConditions.join(','));
              }
              
              const { data: accessGrants, error: accessError } = await query;
              let permissionGrants = [];
              let hasPermissionAccess = false;
              
              if (accessError) {
                console.error('‚ùå Error checking note access:', accessError);
                showError('‚ùå Error checking note access permissions');
                return;
              }
              
              try {
                const individualPromise = currentStudent.id
                  ? supabaseClient
                      .from('student_note_permissions')
                      .select('id, student_id, group_name, is_accessible')
                      .eq('note_id', noteId)
                      .eq('student_id', currentStudent.id)
                      .eq('is_accessible', true)
                  : Promise.resolve({ data: [], error: null });
                
                const groupPromise = normalizedGroupName
                  ? supabaseClient
                      .from('student_note_permissions')
                      .select('id, student_id, group_name, is_accessible')
                      .eq('note_id', noteId)
                      .is('student_id', null)
                      .eq('group_name', normalizedGroupName)
                      .eq('is_accessible', true)
                  : Promise.resolve({ data: [], error: null });
                
                const [individualResult, groupResult] = await Promise.all([individualPromise, groupPromise]);
                const individualPerms = individualResult?.data || [];
                const groupPerms = groupResult?.data || [];
                const permissionErrors = [individualResult?.error, groupResult?.error].filter(Boolean);
                if (permissionErrors.length > 0) {
                  throw permissionErrors[0];
                }
                
                if (individualPerms.length > 0) {
                  permissionGrants = permissionGrants.concat(individualPerms);
                }
                if (groupPerms.length > 0) {
                  permissionGrants = permissionGrants.concat(groupPerms);
                }
                hasPermissionAccess = permissionGrants.length > 0;
              } catch (permissionCheckError) {
                console.error('‚ùå Permission verification failed:', permissionCheckError);
                showError('‚ùå Error checking note access permissions');
                return;
              }
              
              const hasFreeAccess = Array.isArray(accessGrants) && accessGrants.length > 0;
              
              // If no access grants found, deny access
              if (!hasFreeAccess && !hasPermissionAccess) {
                console.error('‚ùå No access granted! Student:', studentGroup, 'Note ID:', noteId);
                showError(`üö´ Access Denied: You don't have permission to view this note.`);
                return;
              }
              
              console.log('‚úÖ Group access verified:', {
                freeAccessGrants: accessGrants?.length || 0,
                permissionGrants: permissionGrants.length
              });
              
              // üîí NOTE: video_allowed_groups check is handled in loadMediaContent()
              // The note PDF is always accessible if student has free/permission access
              // But videos are blocked if: (1) note is free OR (2) student not in video_allowed_groups
              
              // Check if note requires payment (FREE access overrides payment enforcement)
              if (note.requires_payment && !hasFreeAccess) {
                // üî• FIX: Use group-specific date from URL if provided, otherwise fall back to note.class_date
                const checkDate = classDateOverride || (note.class_date ? note.class_date.split('T')[0] : null);
                console.log('üí≥ Checking payment requirement for class date:', checkDate);
                console.log('   - Date source:', classDateOverride ? 'URL (group-specific)' : 'note.class_date (global)');
                
                // Check ALL THREE payment sources (like student portal does)
                // 1. Manual payment records
                // 2. Automated payments (Zelle/Venmo)
                // 3. Credit payments (paid from student balance)
                updateLoadingStatus('Confirming payment status...');
                const [manualResult, autoResult, creditResult] = await Promise.all([
                  supabaseClient
                    .from('payment_records')
                    .select('date, status')
                    .eq('student_id', currentStudent.id)
                    .eq('status', 'paid'),
                  supabaseClient
                    .from('payments')
                    .select('for_class')
                    .or(`student_id.eq.${currentStudent.id},linked_student_id.eq.${currentStudent.id}`),
                  supabaseClient
                    .from('credit_payments')
                    .select('class_date')
                    .eq('student_id', currentStudent.id)
                ]);
                const manualPayments = manualResult?.data || [];
                const autoPayments = autoResult?.data || [];
                const creditPayments = creditResult?.data || [];
                
                console.log('üí∞ Payment sources loaded:', {
                  manual: manualPayments.length,
                  auto: autoPayments.length,
                  credit: creditPayments.length
                });
                
                // Merge payment dates from ALL sources
                const paidDates = new Set();
                
                // Add manual payment dates
                if (manualPayments) {
                  manualPayments.forEach(p => {
                    if (p.date) paidDates.add(p.date.split('T')[0]);
                  });
                }
                
                // Add automated payment dates (using for_class field)
                if (autoPayments) {
                  autoPayments.forEach(p => {
                    if (p.for_class) paidDates.add(p.for_class.split('T')[0]);
                  });
                }
                
                // Add credit payment dates
                if (creditPayments) {
                  creditPayments.forEach(p => {
                    if (p.class_date) {
                      const dateStr = p.class_date.split('T')[0];
                      paidDates.add(dateStr);
                      console.log('  ‚úÖ Added credit payment for:', dateStr);
                    }
                  });
                }
                
                // Check if student paid for this note's class date
                // üî• FIX: Use the override date (group-specific) instead of note.class_date
                const noteDate = classDateOverride || (note.class_date ? note.class_date.split('T')[0] : null);
                const hasPaidForThisDate = noteDate && paidDates.has(noteDate);
                
                console.log('üí∞ Payment check:', {
                  noteDate,
                  dateSource: classDateOverride ? 'URL (group-specific)' : 'note.class_date (global)',
                  totalPaidDates: paidDates.size,
                  hasPaidForThisDate,
                  paidDates: Array.from(paidDates).sort()
                });
                
                if (!hasPaidForThisDate) {
                  console.error('‚ùå Payment required but not found for date:', noteDate);
                  showError('üîí This note is locked. Payment required to access.');
                  return;
                }
                console.log('‚úÖ Payment verified for date:', noteDate);
              } else if (note.requires_payment && hasFreeAccess) {
                console.log('üÜì FREE ACCESS: Skipping payment verification for note', noteId);
              }
              
              // Determine how the student gained access (paid vs free)
              const accessMode = note.requires_payment
                ? (hasFreeAccess ? 'free-grant' : 'paid')
                : 'free-note';

              // Store full note data (include access mode for media rules)
              noteData = {
                ...noteData,
                ...note,
                video_url: note.video_url,
                video_allowed_groups: note.video_allowed_groups,
                video_controls: note.video_controls,
                video_title: note.video_title,
                title: note.title,
                accessMode,
                hasFreeAccess,
                hasPermissionAccess
              };
              
            } catch (e) {
              console.error('Error validating note access:', e);
              showError('Failed to validate access to this note');
              return;
            }
          } else {
            // No noteId provided - can't validate group access
            console.warn('‚ö†Ô∏è No noteId provided - skipping group validation');
          }
          
          // Check if it's a storage path or a full URL
          if (pdfUrl.startsWith('http://') || pdfUrl.startsWith('https://')) {
            // It's already a full URL, use it directly
            showLoadingScreen('Fetching note...');
            await loadPDFFromURL(pdfUrl);
          } else {
            // It's a storage path, create signed URL from student-notes bucket
            showLoadingScreen('Fetching note...');
            await loadPDFFromStorage(pdfUrl);
          }
          
          // Load media content after PDF is loaded
          await loadMediaContent();
          return;
        }
        
        // Legacy: Load from student_notes table
        if (noteId) {
          const { data: note, error: noteError } = await supabaseClient
            .from('student_notes')
            .select('*')
            .eq('id', noteId)
            .single();
          
          if (noteError || !note) {
            showError('Note not found');
            return;
          }
          
          noteData = note;
          
          // ============================================================
          // GROUP ACCESS VALIDATION - CRITICAL SECURITY CHECK
          // ============================================================
          
          // Normalize student's group (handle group_letter, group_name, group)
          const studentGroup = (
            currentStudent.group_letter || 
            currentStudent.group_name || 
            currentStudent.group || 
            ''
          ).toString().trim().toUpperCase().replace(/^GROUP\s*/i, '');
          
          // Normalize note's group (handle group_letter, group_name, group)
          const noteGroup = (
            note.group_letter || 
            note.group_name || 
            note.group || 
            ''
          ).toString().trim().toUpperCase().replace(/^GROUP\s*/i, '');
          
          console.log('üîê Group Access Check (Legacy):');
          console.log('  Student Group:', studentGroup);
          console.log('  Note Group:', noteGroup);
          
          // Verify student is in the correct group
          if (noteGroup && studentGroup !== noteGroup) {
            console.error('‚ùå Group mismatch! Student:', studentGroup, 'Note:', noteGroup);
            showError(`üö´ Access Denied: This note is for Group ${noteGroup}. You are in Group ${studentGroup}.`);
            return;
          }
          
          console.log('‚úÖ Group access verified (legacy path)');
          
          // Check if note requires payment
          if (note.requires_payment) {
            const { data: payments, error: paymentError } = await supabaseClient
              .from('payment_records')
              .select('*')
              .eq('student_id', currentStudent.id)
              .eq('status', 'paid')
              .limit(1);
            
            if (paymentError || !payments || payments.length === 0) {
              showError('üîí This note is locked. Payment required to access.');
              return;
            }
          }
          
          document.getElementById('noteTitle').textContent = (note.title || 'Class Notes').replace(/\.pdf$/i, '');
          await loadPDF(note.pdf_url);
          
          // Load media content (videos) for this note
          await loadMediaContent();
        }
        
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to load note: ' + error.message);
      }
    })();
    
    // ============================================================
    // PDF LOADING & RENDERING
    // ============================================================
    
    async function loadPDFFromURL(pdfUrl) {
      try {
  showLoadingScreen('Connecting to secure PDF...');
        
        console.log('üîó Loading PDF from URL:', pdfUrl);
        
        // Load PDF directly from URL
        const loadingTask = pdfjsLib.getDocument({
          url: pdfUrl,
          withCredentials: false
        });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        
        // Update UI
  document.getElementById('totalPages').textContent = totalPages;
  hideLoadingScreen();
        document.getElementById('viewerControls').style.display = 'flex';
        showMediaPanelToggle();
        
        // Render first page
        await renderPage(1);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF: ' + error.message);
      }
    }
    
    async function loadPDFFromStorage(pdfPath) {
      try {
        console.log('üîç Loading PDF from storage path:', pdfPath);
        console.log('üóÇÔ∏è Bucket: student-notes');
        console.log('üìç Full storage reference: student-notes/' + pdfPath);
        
        if (!pdfPath || typeof pdfPath !== 'string' || pdfPath.trim() === '') {
          throw new Error('Invalid PDF path provided');
        }
        
  showLoadingScreen('Building secure link to storage...');
        
        // Get public URL (bucket is public)
        const { data: publicUrlData, error: urlError } = supabaseClient.storage
          .from('student-notes')
          .getPublicUrl(pdfPath);
        
        if (urlError) {
          console.error('‚ùå Error generating public URL:', urlError);
          throw new Error(`Failed to generate URL: ${urlError.message || 'Unknown error'}`);
        }
        
        if (!publicUrlData || !publicUrlData.publicUrl) {
          throw new Error('Public URL was not generated');
        }
        
        const pdfUrl = publicUrlData.publicUrl;
        console.log('‚úÖ Created public URL for:', pdfPath);
        console.log('üîó URL:', pdfUrl);
        
        // Load PDF from public URL
        const loadingTask = pdfjsLib.getDocument({
          url: pdfUrl,
          withCredentials: false,
          // Add error handling for PDF.js loading
          httpHeaders: {},
          withCredentials: false,
          isEvalSupported: false,
          cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
          cMapPacked: true,
          rangeChunkSize: 65536,
          useSystemFonts: true,
          useWorkerFetch: true,
          disableAutoFetch: false,
          disableStream: false
        });
        
        // Handle PDF.js specific loading errors
        loadingTask.onProgress = function(progressData) {
          const percent = Math.round((progressData.loaded / progressData.total) * 100);
          updateLoadingStatus(`Decrypting and securing note... ${percent}%`);
          console.log(`Loading PDF: ${percent}%`);
        };
        
        pdfDoc = await loadingTask.promise;
        
        if (!pdfDoc) {
          throw new Error('PDF document failed to load');
        }
        
        totalPages = pdfDoc.numPages;
        
        if (!totalPages || totalPages < 1) {
          throw new Error('Invalid PDF: No pages found');
        }
        
        // Update UI
  document.getElementById('totalPages').textContent = totalPages;
  hideLoadingScreen();
        document.getElementById('viewerControls').style.display = 'flex';
        showMediaPanelToggle();
        
        // Render first page
        await renderPage(1);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF: ' + error.message + '. Please ensure the file exists in storage.');
      }
    }
    
    async function loadPDF(pdfPath) {
      try {
        console.log('üîç Loading PDF from storage path (legacy):', pdfPath);
        
        // Try signed URL first
        await loadPDFFromStorage(pdfPath);
        
      } catch (error) {
        console.error('PDF loading error:', error);
        showError('Failed to load PDF. The file may not exist in storage. Please contact your administrator.');
      }
    }
    
    async function renderPage(pageNum) {
      try {
        // Validate inputs
        if (!pdfDoc) {
          throw new Error('PDF document not loaded');
        }
        
        if (!pageNum || pageNum < 1 || pageNum > totalPages) {
          throw new Error(`Invalid page number: ${pageNum}. Valid range: 1-${totalPages}`);
        }
        
        const page = await pdfDoc.getPage(pageNum);
        
        if (!page) {
          throw new Error(`Failed to load page ${pageNum}`);
        }
        
        // High-quality rendering: 3x scale for retina displays
        const scale = zoomLevel * 3.0;
        const viewport = page.getViewport({ scale: scale });
        
        if (!viewport) {
          throw new Error('Failed to create viewport');
        }
        
        // Create canvas for this page
        const canvas = document.createElement('canvas');
        canvas.className = 'page-canvas';
        const context = canvas.getContext('2d');
        
        if (!context) {
          throw new Error('Failed to get canvas context');
        }
        
        // Set high-resolution canvas dimensions
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        // Scale down display size while maintaining quality
        canvas.style.width = (viewport.width / 3) + 'px';
        canvas.style.height = (viewport.height / 3) + 'px';
        
        // Render PDF page with high quality
        const renderTask = page.render({
          canvasContext: context,
          viewport: viewport
        });
        
        await renderTask.promise;
        
        // Create page container with watermark
        const pageContainer = document.createElement('div');
        pageContainer.className = 'page-container';
        
        // Add watermark overlay with ARNOMA logo and student info
        const studentNameSafe = escapeHtml(getStudentDisplayName());
        const studentGroupSafe = escapeHtml(getStudentDisplayGroup());
        const watermark = document.createElement('div');
        watermark.className = 'watermark-overlay';
        watermark.innerHTML = `
          <div class="watermark-content">
            <div class="watermark-logo">ARNOMA</div>
            <div class="watermark-text">
              ${studentNameSafe}<br>
              Group ${studentGroupSafe}
            </div>
          </div>
        `;
        
        pageContainer.appendChild(canvas);
        pageContainer.appendChild(watermark);
        
        // Clear and add to content
        const content = document.getElementById('pdfContent');
        content.innerHTML = '';
        content.appendChild(pageContainer);
        
        // Update page number
        currentPage = pageNum;
        document.getElementById('currentPage').textContent = currentPage;
        
        // Update button states
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
        
      } catch (error) {
        console.error('Page rendering error:', error);
        showError('Failed to render page: ' + error.message);
      }
    }
    
    // ============================================================
    // NAVIGATION CONTROLS
    // ============================================================
    
    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= totalPages) {
        renderPage(newPage);
      }
    }
    
    function changeZoom(delta) {
      zoomLevel = Math.max(0.5, Math.min(2.5, zoomLevel + delta));
      document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
      renderPage(currentPage);
    }
    
    // ============================================================
    // PRINT FUNCTION (WITH WATERMARK) - Safari Compatible
    // ============================================================
    
    async function printNote() {
      if (isPreparingPrint) {
        return;
      }

      if (!pdfDoc || totalPages === 0) {
        alert('Still preparing this note. Please try printing again in a moment.');
        return;
      }

      // Show custom copyright alert before printing
      await showPrintWarning();

      isPreparingPrint = true;
      const printButton = document.getElementById('printButton');
      const originalButtonLabel = printButton ? printButton.innerHTML : null;

      if (printButton) {
        printButton.disabled = true;
        printButton.innerHTML = 'Preparing‚Ä¶';
      }

      const content = document.getElementById('pdfContent');
      if (!content) {
        console.error('Print error: pdfContent container missing');
        if (printButton && originalButtonLabel !== null) {
          printButton.innerHTML = originalButtonLabel;
          printButton.disabled = false;
        }
        isPreparingPrint = false;
        return;
      }

      const placeholder = document.createElement('div');
      placeholder.className = 'loading-text';
      placeholder.textContent = 'Preparing secure print version‚Ä¶';
      content.innerHTML = '';
      content.appendChild(placeholder);

      const studentNameSafe = escapeHtml(getStudentDisplayName());
      const studentGroupSafe = escapeHtml(getStudentDisplayGroup());

      try {
        const pagesFragment = document.createDocumentFragment();
        const imageElements = [];
        const printScale = Math.min(3, Math.max(zoomLevel * 2, 2.2));

        // Use data URLs instead of blob URLs for better Safari print compatibility
        const canvasToDataUrl = (baseCanvas) => {
          try {
            // Try PNG first for better quality
            return baseCanvas.toDataURL('image/png', 0.95);
          } catch (error) {
            console.warn('PNG conversion failed, falling back to JPEG:', error);
            // Fallback to JPEG if PNG fails
            return baseCanvas.toDataURL('image/jpeg', 0.92);
          }
        };

        for (let i = 1; i <= totalPages; i++) {
          const page = await pdfDoc.getPage(i);
          const viewport = page.getViewport({ scale: printScale });
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');

          canvas.height = viewport.height;
          canvas.width = viewport.width;

          await page.render({
            canvasContext: context,
            viewport
          }).promise;

          const screenshotDataUrl = canvasToDataUrl(canvas);

          const imageElement = document.createElement('img');
          imageElement.decoding = 'sync';
          imageElement.loading = 'eager';
          imageElement.src = screenshotDataUrl;
          imageElement.className = 'page-image page-screenshot-image';
          imageElement.style.width = '100%';
          imageElement.style.height = 'auto';
          imageElement.style.display = 'block';
          imageElement.style.opacity = '1';
          imageElement.style.visibility = 'visible';
          imageElement.alt = `Protected ARNOMA note page ${i}`;
          imageElement.setAttribute('aria-hidden', 'true');

          imageElements.push(imageElement);
          // No need to track URLs since we're using data URLs

          const printCanvasCopy = document.createElement('canvas');
          printCanvasCopy.width = canvas.width;
          printCanvasCopy.height = canvas.height;
          printCanvasCopy.className = 'page-canvas page-screenshot-canvas';
          printCanvasCopy.style.width = '100%';
          printCanvasCopy.style.height = 'auto';
          const copyContext = printCanvasCopy.getContext('2d');
          if (copyContext) {
            copyContext.drawImage(canvas, 0, 0, canvas.width, canvas.height);
          }

          const pageContainer = document.createElement('div');
          pageContainer.className = 'page-container';

          const screenshotFrame = document.createElement('div');
          screenshotFrame.className = 'page-screenshot-frame';
          screenshotFrame.appendChild(imageElement);
          screenshotFrame.appendChild(printCanvasCopy);

          const screenshotBadge = document.createElement('div');
          screenshotBadge.className = 'page-screenshot-badge';
          screenshotBadge.textContent = `Screenshot ‚Äì Page ${i}`;
          screenshotFrame.appendChild(screenshotBadge);

          const watermark = document.createElement('div');
          watermark.className = 'watermark-overlay';
          watermark.innerHTML = `
            <div class="watermark-content">
              <div class="watermark-logo">ARNOMA</div>
              <div class="watermark-text">
                ${studentNameSafe}<br>
                Group ${studentGroupSafe}<br>
                <span style="font-size: 0.7em; opacity: 0.8;">NOT FOR REDISTRIBUTION</span>
              </div>
            </div>
          `;

          // Add additional corner watermarks for better coverage
          const topLeftWatermark = document.createElement('div');
          topLeftWatermark.className = 'watermark-overlay watermark-corner-tl';
          topLeftWatermark.innerHTML = `
            <div class="watermark-content-small">
              <div style="font-size: 32px; font-weight: 900;">ARNOMA</div>
              <div style="font-size: 14px; font-weight: 600;">${studentNameSafe}</div>
            </div>
          `;

          const topRightWatermark = document.createElement('div');
          topRightWatermark.className = 'watermark-overlay watermark-corner-tr';
          topRightWatermark.innerHTML = `
            <div class="watermark-content-small">
              <div style="font-size: 32px; font-weight: 900;">ARNOMA</div>
              <div style="font-size: 14px; font-weight: 600;">${studentNameSafe}</div>
            </div>
          `;

          const bottomLeftWatermark = document.createElement('div');
          bottomLeftWatermark.className = 'watermark-overlay watermark-corner-bl';
          bottomLeftWatermark.innerHTML = `
            <div class="watermark-content-small">
              <div style="font-size: 32px; font-weight: 900;">ARNOMA</div>
              <div style="font-size: 14px; font-weight: 600;">${studentNameSafe}</div>
            </div>
          `;

          const bottomRightWatermark = document.createElement('div');
          bottomRightWatermark.className = 'watermark-overlay watermark-corner-br';
          bottomRightWatermark.innerHTML = `
            <div class="watermark-content-small">
              <div style="font-size: 32px; font-weight: 900;">ARNOMA</div>
              <div style="font-size: 14px; font-weight: 600;">${studentNameSafe}</div>
            </div>
          `;

          pageContainer.appendChild(screenshotFrame);
          pageContainer.appendChild(watermark);
          pageContainer.appendChild(topLeftWatermark);
          pageContainer.appendChild(topRightWatermark);
          pageContainer.appendChild(bottomLeftWatermark);
          pageContainer.appendChild(bottomRightWatermark);
          pagesFragment.appendChild(pageContainer);
        }

        content.innerHTML = '';
        content.appendChild(pagesFragment);

        await Promise.all(imageElements.map(waitForImageLoad));

        let afterPrintHandled = false;
        const finalizePrint = () => {
          if (afterPrintHandled) return;
          afterPrintHandled = true;
          renderPage(currentPage);
          if (printButton && originalButtonLabel !== null) {
            printButton.innerHTML = originalButtonLabel;
            printButton.disabled = false;
          }
          isPreparingPrint = false;
          // No URL cleanup needed for data URLs
        };

        window.addEventListener('afterprint', finalizePrint, { once: true });

        setTimeout(() => {
          window.print();
          setTimeout(finalizePrint, 400);
        }, 250);
      } catch (error) {
        console.error('Print error:', error);
        alert('Failed to prepare this note for printing. Please try again.');
        if (printButton && originalButtonLabel !== null) {
          printButton.innerHTML = originalButtonLabel;
          printButton.disabled = false;
        }
        isPreparingPrint = false;
        renderPage(currentPage);
      }

      function finalizePrintCleanupUrls(urls = []) {
        // No cleanup needed for data URLs
        return;
      }
    }

    function obfuscateCanvasForPrint(sourceCanvas) {
      try {
        const pixelationFactor = 2.8; // Higher value => more pixelation
        const downscaledWidth = Math.max(1, Math.round(sourceCanvas.width / pixelationFactor));
        const downscaledHeight = Math.max(1, Math.round(sourceCanvas.height / pixelationFactor));
        
        const pixelatedCanvas = document.createElement('canvas');
        pixelatedCanvas.width = downscaledWidth;
        pixelatedCanvas.height = downscaledHeight;
        const pixelCtx = pixelatedCanvas.getContext('2d');
        disableImageSmoothing(pixelCtx);
        pixelCtx.drawImage(sourceCanvas, 0, 0, downscaledWidth, downscaledHeight);
        
        const outputCanvas = document.createElement('canvas');
        outputCanvas.width = sourceCanvas.width;
        outputCanvas.height = sourceCanvas.height;
        const outputCtx = outputCanvas.getContext('2d');
        disableImageSmoothing(outputCtx);
        outputCtx.drawImage(
          pixelatedCanvas,
          0,
          0,
          downscaledWidth,
          downscaledHeight,
          0,
          0,
          outputCanvas.width,
          outputCanvas.height
        );

        applyNoiseOverlay(outputCtx, outputCanvas.width, outputCanvas.height);
        drawMicroGrid(outputCtx, outputCanvas.width, outputCanvas.height);

        return outputCanvas;
      } catch (error) {
        console.warn('Raster obfuscation fallback (canvas locked):', error);
        return sourceCanvas;
      }
    }

    function disableImageSmoothing(ctx) {
      if (!ctx) return;
      ctx.imageSmoothingEnabled = false;
      ctx.mozImageSmoothingEnabled = false;
      ctx.webkitImageSmoothingEnabled = false;
      ctx.msImageSmoothingEnabled = false;
    }

    function applyNoiseOverlay(ctx, width, height) {
      try {
        const noiseTile = 96;
        const noiseCanvas = document.createElement('canvas');
        noiseCanvas.width = noiseTile;
        noiseCanvas.height = noiseTile;
        const noiseCtx = noiseCanvas.getContext('2d');
        const imageData = noiseCtx.createImageData(noiseTile, noiseTile);
        const buffer = imageData.data;
        
        for (let i = 0; i < buffer.length; i += 4) {
          const shade = 215 + Math.floor(Math.random() * 35); // 215-249 range
          buffer[i] = shade;
          buffer[i + 1] = shade;
          buffer[i + 2] = shade;
          buffer[i + 3] = Math.floor(Math.random() * 45); // alpha 0-45
        }
        
        noiseCtx.putImageData(imageData, 0, 0);
        const pattern = ctx.createPattern(noiseCanvas, 'repeat');
        if (pattern) {
          ctx.save();
          ctx.globalAlpha = 0.18;
          ctx.fillStyle = pattern;
          ctx.fillRect(0, 0, width, height);
          ctx.restore();
        }
      } catch (error) {
        console.warn('Noise overlay skipped:', error);
      }
    }

    function drawMicroGrid(ctx, width, height) {
      ctx.save();
      ctx.globalAlpha = 0.08;
      ctx.strokeStyle = 'rgba(15, 23, 42, 0.45)';
      ctx.lineWidth = 0.75;
      const spacing = 12;
      for (let x = 0; x <= width; x += spacing) {
        ctx.beginPath();
        ctx.moveTo(x + 0.5, 0);
        ctx.lineTo(x + 0.5, height);
        ctx.stroke();
      }
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.25)';
      for (let y = 0; y <= height; y += spacing) {
        ctx.beginPath();
        ctx.moveTo(0, y + 0.5);
        ctx.lineTo(width, y + 0.5);
        ctx.stroke();
      }
      ctx.restore();
    }
    
    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================
    
    function escapeHtml(value = '') {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function waitForImageLoad(img) {
      if (!img) return Promise.resolve();
      if (typeof img.decode === 'function') {
        return img.decode().catch(() => {});
      }
      if (img.complete) {
        return Promise.resolve();
      }
      return new Promise((resolve) => {
        img.onload = () => resolve();
        img.onerror = () => resolve();
      });
    }

    function showError(message) {
      const content = document.getElementById('pdfContent');
      content.innerHTML = `<div class="error-message">${message}</div>`;
    }
    
    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { 
        month: 'long', 
        day: 'numeric', 
        year: 'numeric' 
      });
    }

    // Custom Alert Function
    function showCustomAlert() {
      const studentName = getStudentDisplayName();
      
      const overlay = document.createElement('div');
      overlay.className = 'custom-alert-overlay';
      overlay.innerHTML = `
        <div class="custom-alert-modal">
          <div class="custom-alert-icon">‚ö†Ô∏è</div>
          <div class="custom-alert-title">ATTENTION</div>
          <div class="custom-alert-message">
            This document belongs to <strong>ARNOMA</strong> and is provided exclusively for <strong>${studentName}</strong>.<br><br>
            Kindly respect the copyright and refrain from sharing it with others.<br><br>
            Thank you for your understanding.
          </div>
          <button class="custom-alert-button" onclick="this.closest('.custom-alert-overlay').remove()">
            I Understand
          </button>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      // Close on overlay click
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
    }

    // Print Warning Function - Shows alert and waits for user confirmation
    function showPrintWarning() {
      return new Promise((resolve) => {
        const studentName = getStudentDisplayName();
        
        const overlay = document.createElement('div');
        overlay.className = 'custom-alert-overlay';
        overlay.innerHTML = `
          <div class="custom-alert-modal">
            <div class="custom-alert-icon">‚ö†Ô∏è</div>
            <div class="custom-alert-title">ATTENTION</div>
            <div class="custom-alert-message">
              This document belongs to <strong>ARNOMA</strong> and is provided exclusively for <strong>${studentName}</strong>.<br><br>
              Kindly respect the copyright and refrain from sharing it with others.<br><br>
              Thank you for your understanding.
            </div>
            <button class="custom-alert-button" id="printWarningBtn">
              I Understand
            </button>
          </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Resolve promise and remove overlay when button is clicked
        const button = overlay.querySelector('#printWarningBtn');
        button.addEventListener('click', () => {
          overlay.remove();
          resolve();
        });
        
        // Prevent closing on overlay click for print warning
        overlay.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      });
    }

    // ============================================================
    // MEDIA PANEL FUNCTIONS
    // ============================================================
    
    /**
     * Extract YouTube video ID from various URL formats
     * Supports: youtube.com/watch?v=..., youtu.be/..., youtube.com/embed/...
     * CRITICAL: Never expose the full URL to the student - only use for iframe src
     */
    function extractYouTubeVideoId(url) {
      if (!url) return null;
      
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
        /^([a-zA-Z0-9_-]{11})$/ // Raw video ID
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      
      return null;
    }

    /**
     * Extract Google Drive file ID from various URL formats
     * Supports: drive.google.com/file/d/{id}/view, drive.google.com/open?id={id}
     */
    function extractGoogleDriveFileId(url) {
      if (!url) return null;
      
      const patterns = [
        /\/file\/d\/([a-zA-Z0-9_-]+)/, // /file/d/{fileId}/view or /file/d/{fileId}/edit
        /id=([a-zA-Z0-9_-]+)/, // ?id={fileId}
        /\/open\?id=([a-zA-Z0-9_-]+)/, // /open?id={fileId}
        /^([a-zA-Z0-9_-]{25,})$/ // Raw file ID (typically 25+ chars)
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      
      return null;
    }

    /**
     * Detect video source type (YouTube or Google Drive)
     */
    function detectVideoSource(url) {
      if (!url) return null;
      
      if (url.includes('youtube.com') || url.includes('youtu.be')) {
        return 'youtube';
      }
      
      if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
        return 'googledrive';
      }
      
      // Try to detect by ID pattern
      const youtubeId = extractYouTubeVideoId(url);
      if (youtubeId) return 'youtube';
      
      const driveId = extractGoogleDriveFileId(url);
      if (driveId) return 'googledrive';
      
      return null;
    }

    /**
     * Create a protected YouTube iframe embed
     * MAXIMUM SECURITY:
     * - No URL exposure anywhere (sandboxed iframe)
     * - Custom controls based on admin settings
     * - No right-click, inspect, or dev tools access to URL
     * - Privacy-enhanced mode (youtube-nocookie.com)
     */
    function createProtectedYouTubeEmbed(videoId, title = 'Study Video', controls = null) {
      if (!videoId) {
        return `
          <div class="media-item">
            <h4>üé• ${title}</h4>
            <div class="protected-video-container">
              <div class="video-unavailable">
                ‚ö†Ô∏è Video unavailable<br>
                <small>Invalid video link</small>
              </div>
            </div>
          </div>
        `;
      }
      
      // CRITICAL SECURITY: Use autoplay=1 to skip the red YouTube play button
      // When autoplay is enabled, video starts immediately with NO branding overlay
      // Combined with mute=1, this provides silent autoplay which students can unmute
      
      const embedUrl = `https://www.youtube-nocookie.com/embed/${videoId}?` + 
        'autoplay=1&' +                         // Autoplay to skip red button
        'mute=1&' +                             // Muted autoplay (required by browsers)
        'controls=0&' +                         // ZERO controls = NO YouTube branding
        'rel=0&' +                              // No related videos
        'modestbranding=1&' +                   // Minimal branding
        'showinfo=0&' +                         // No video info
        'fs=0&' +                               // NO fullscreen button
        'disablekb=1&' +                        // NO keyboard shortcuts
        'iv_load_policy=3&' +                   // No annotations
        'playsinline=1&' +                      // Inline playback
        'loop=0&' +                             // No loop
        'enablejsapi=0&' +                      // No JS API access
        'origin=' + window.location.origin;     // Restrict to our domain only
      
      return `
        <div class="media-item">
          <h4>üé• ${title}</h4>
          <div class="protected-video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; pointer-events: auto;">
            <iframe 
              src="${embedUrl}"
              title="Protected Video"
              frameborder="0"
              allow="autoplay; encrypted-media"
              sandbox="allow-scripts allow-same-origin"
              loading="lazy"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; pointer-events: auto;"
              oncontextmenu="return false;"
            ></iframe>
            <!-- Overlay to block YouTube branding that might appear -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 60px; pointer-events: none; z-index: 1;"></div>
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 60px; pointer-events: none; z-index: 1; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);"></div>
          </div>
          <p style="color: var(--accent-primary); font-size: 12px; margin-top: 8px; text-align: center;">
            üîí <strong>Protected ARNOMA Content</strong> - Sharing prohibited<br>
            <small style="opacity: 0.7;">Video starts muted - click to unmute and control</small>
          </p>
        </div>
      `;
    }

    /**
     * Create custom HTML5 video player with Google Drive source
     * MAXIMUM SECURITY & FLEXIBILITY:
     * - Uses signed Supabase URLs (stored from Drive, never exposed)
     * - Complete control over UI (no external branding)
     * - Custom controls (play, pause, volume, speed, quality, fullscreen)
     * - URL never visible to student (blob URLs or signed URLs)
     */
    function createCustomVideoPlayer(videoUrl, title = 'Study Video', videoId = null) {
      const playerId = `video-player-${Date.now()}`;
      
      return `
        <div class="media-item">
          <h4>üé• ${title}</h4>
          <div class="custom-video-player" id="${playerId}-container">
            <video 
              id="${playerId}"
              preload="metadata"
              playsinline
              controlsList="nodownload nofullscreen noremoteplayback"
              disablePictureInPicture
              oncontextmenu="return false;"
            >
              <source src="${videoUrl}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
            
            <div class="video-loading-overlay" id="${playerId}-loading" style="display: none;">
              <div class="video-spinner"></div>
            </div>
            
            <div class="video-controls-overlay" id="${playerId}-controls">
              <div class="video-controls-row">
                <button class="video-play-btn" id="${playerId}-play" onclick="togglePlayPause('${playerId}')">
                  ‚ñ∂Ô∏è
                </button>
                
                <div class="video-progress-container" id="${playerId}-progress-container" onclick="seekVideo(event, '${playerId}')">
                  <div class="video-progress-bar" id="${playerId}-progress"></div>
                </div>
                
                <div class="video-time" id="${playerId}-time">0:00 / 0:00</div>
                
                <button class="video-volume-btn" id="${playerId}-volume" onclick="toggleMute('${playerId}')">
                  üîä
                </button>
                
                <button class="video-settings-btn" id="${playerId}-settings" onclick="toggleSettings('${playerId}')">
                  ‚öôÔ∏è
                  <div class="video-settings-menu" id="${playerId}-settings-menu">
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 0.5)">
                      Speed: 0.5x
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 0.75)">
                      Speed: 0.75x
                    </div>
                    <div class="video-settings-option active" onclick="setPlaybackSpeed('${playerId}', 1)">
                      Speed: 1x ‚úì
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 1.25)">
                      Speed: 1.25x
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 1.5)">
                      Speed: 1.5x
                    </div>
                    <div class="video-settings-option" onclick="setPlaybackSpeed('${playerId}', 2)">
                      Speed: 2x
                    </div>
                  </div>
                </button>
                
                <button class="video-fullscreen-btn" id="${playerId}-fullscreen" onclick="toggleFullscreen('${playerId}')">
                  ‚õ∂
                </button>
              </div>
            </div>
          </div>
          <p style="color: var(--accent-primary); font-size: 12px; margin-top: 8px; text-align: center;">
            üîí <strong>Protected ARNOMA Content</strong> - Sharing prohibited
          </p>
        </div>
      `;
    }

    // Video player control functions
    function togglePlayPause(playerId) {
      const video = document.getElementById(playerId);
      const playBtn = document.getElementById(`${playerId}-play`);
      
      if (video.paused) {
        video.play();
        playBtn.textContent = '‚è∏Ô∏è';
      } else {
        video.pause();
        playBtn.textContent = '‚ñ∂Ô∏è';
      }
    }

    function toggleMute(playerId) {
      const video = document.getElementById(playerId);
      const volumeBtn = document.getElementById(`${playerId}-volume`);
      
      video.muted = !video.muted;
      volumeBtn.textContent = video.muted ? 'üîá' : 'üîä';
    }

    function toggleSettings(playerId) {
      const settingsMenu = document.getElementById(`${playerId}-settings-menu`);
      settingsMenu.classList.toggle('show');
      
      // Close menu when clicking outside
      if (settingsMenu.classList.contains('show')) {
        setTimeout(() => {
          document.addEventListener('click', function closeSettings(e) {
            if (!settingsMenu.contains(e.target) && !e.target.closest(`#${playerId}-settings`)) {
              settingsMenu.classList.remove('show');
              document.removeEventListener('click', closeSettings);
            }
          });
        }, 10);
      }
    }

    function setPlaybackSpeed(playerId, speed) {
      const video = document.getElementById(playerId);
      const settingsMenu = document.getElementById(`${playerId}-settings-menu`);
      
      video.playbackRate = speed;
      
      // Update active state
      settingsMenu.querySelectorAll('.video-settings-option').forEach(opt => {
        opt.classList.remove('active');
        if (opt.textContent.includes(`${speed}x`)) {
          opt.classList.add('active');
          opt.innerHTML = opt.innerHTML.replace('‚úì', '') + ' ‚úì';
        } else {
          opt.innerHTML = opt.innerHTML.replace(' ‚úì', '');
        }
      });
      
      settingsMenu.classList.remove('show');
    }

    function toggleFullscreen(playerId) {
      const container = document.getElementById(`${playerId}-container`);
      
      if (!document.fullscreenElement) {
        if (container.requestFullscreen) {
          container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
          container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
          container.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    }

    function seekVideo(event, playerId) {
      const video = document.getElementById(playerId);
      const progressContainer = document.getElementById(`${playerId}-progress-container`);
      
      const rect = progressContainer.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      const percentage = clickX / rect.width;
      
      video.currentTime = percentage * video.duration;
    }

    function formatVideoTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }

    // Initialize video player event listeners
    function initializeVideoPlayer(playerId) {
      const video = document.getElementById(playerId);
      if (!video) return;
      
      const playBtn = document.getElementById(`${playerId}-play`);
      const progressBar = document.getElementById(`${playerId}-progress`);
      const timeDisplay = document.getElementById(`${playerId}-time`);
      const loadingOverlay = document.getElementById(`${playerId}-loading`);
      const controlsOverlay = document.getElementById(`${playerId}-controls`);
      
      // Show loading spinner
      video.addEventListener('waiting', () => {
        loadingOverlay.style.display = 'block';
      });
      
      video.addEventListener('canplay', () => {
        loadingOverlay.style.display = 'none';
      });
      
      // Update progress bar and time
      video.addEventListener('timeupdate', () => {
        const percentage = (video.currentTime / video.duration) * 100;
        progressBar.style.width = `${percentage}%`;
        
        timeDisplay.textContent = `${formatVideoTime(video.currentTime)} / ${formatVideoTime(video.duration)}`;
      });
      
      // Update play button on play/pause
      video.addEventListener('play', () => {
        playBtn.textContent = '‚è∏Ô∏è';
      });
      
      video.addEventListener('pause', () => {
        playBtn.textContent = '‚ñ∂Ô∏è';
      });
      
      // Show controls on hover or touch
      let controlsTimeout;
      const showControls = () => {
        controlsOverlay.classList.add('show');
        clearTimeout(controlsTimeout);
        controlsTimeout = setTimeout(() => {
          if (!video.paused) {
            controlsOverlay.classList.remove('show');
          }
        }, 3000);
      };
      
      video.addEventListener('mousemove', showControls);
      video.addEventListener('touchstart', showControls);
      
      // Click video to play/pause
      video.addEventListener('click', () => {
        togglePlayPause(playerId);
      });
      
      // Prevent right-click
      video.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        return false;
      });
    }

    /**
     * Create a protected Google Drive video embed with fullscreen support
     * MAXIMUM SECURITY + FULL FEATURES:
     * - Settings: Quality, Speed, Subtitles (native Drive controls)
     * - Play/Pause, Mute, Fullscreen (enabled)
     * - No URL exposure (sandboxed iframe)
     * - No download button (controlled by Drive sharing settings)
     */
    function createProtectedGoogleDriveEmbed(fileId, title = 'Study Video') {
      if (!fileId) {
        return `
          <div class="media-item">
            <h4>üé• ${title}</h4>
            <div class="protected-video-container">
              <div class="video-unavailable">
                ‚ö†Ô∏è Video unavailable<br>
                <small>Invalid Google Drive link</small>
              </div>
            </div>
          </div>
        `;
      }
      
      // CRITICAL SECURITY: Google Drive preview mode with fullscreen enabled
      // Students CANNOT access the file ID through iframe sandbox
      const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
      const playerId = `drive-player-${Date.now()}`;
      
      return `
        <div class="media-item">
          <h4>üé• ${title}</h4>
          <div class="protected-video-container" id="${playerId}-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px;">
            <iframe 
              id="${playerId}"
              src="${embedUrl}"
              title="Protected Video"
              frameborder="0"
              allow="autoplay; encrypted-media"
              allowfullscreen
              webkitallowfullscreen
              mozallowfullscreen
              sandbox="allow-scripts allow-same-origin"
              loading="lazy"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 12px;"
              oncontextmenu="return false;"
            ></iframe>
          </div>
          <p style="color: var(--accent-primary); font-size: 12px; margin-top: 8px; text-align: center;">
            üîí <strong>Protected ARNOMA Content</strong> - Sharing prohibited<br>
            <small style="opacity: 0.7;">Click ‚öôÔ∏è in video for quality & speed ‚Ä¢ Click ‚õ∂ for fullscreen</small>
          </p>
        </div>
      `;
    }

    /**
     * Create protected video embed (auto-detects YouTube or Google Drive)
     * - YouTube: Uses iframe with maximum security parameters
     * - Google Drive: Uses custom HTML5 player with signed URLs
     */
    function createProtectedVideoEmbed(videoUrl, title = 'Study Video', controls = null) {
      const source = detectVideoSource(videoUrl);
      
      if (source === 'youtube') {
        const videoId = extractYouTubeVideoId(videoUrl);
        return createProtectedYouTubeEmbed(videoId, title, controls);
      } else if (source === 'googledrive') {
        // For Google Drive, use custom HTML5 player
        // Admin stores Drive URL in database, we display with custom controls
        const fileId = extractGoogleDriveFileId(videoUrl);
        
        // Use iframe embed method (students can't download from preview mode)
        return createProtectedGoogleDriveEmbed(fileId, title);
      } else {
        return `
          <div class="media-item">
            <h4>üé• ${title}</h4>
            <div class="protected-video-container">
              <div class="video-unavailable">
                ‚ö†Ô∏è Video unavailable<br>
                <small>Unsupported video source. Use YouTube or Google Drive links.</small>
              </div>
            </div>
          </div>
        `;
      }
    }

    /**
     * Load media content for the current note
     * Fetches video_url from student_notes table and displays it securely
     * üîí CRITICAL SECURITY RULES:
     * 1. If note requires_payment = false (FREE) ‚Üí NO VIDEO ACCESS for anyone
     * 2. If note requires_payment = true AND student paid AND in video_allowed_groups ‚Üí Video access
     * 3. PDF is always accessible if student has note access (free or paid)
     */
    async function loadMediaContent() {
      const mediaPanelContent = document.getElementById('mediaPanelContent');
      
      try {
        const accessMode = noteData?.accessMode || 'unknown';
        const isFreeAccess = accessMode === 'free-note' || accessMode === 'free-grant';

        // üîí CRITICAL RULE: If note is FREE or accessed via free grant, BLOCK all media access
        // Videos are ONLY for PAID students in allowed groups
        if (isFreeAccess) {
          console.log('üîí MEDIA BLOCKED:', {
            reason: accessMode === 'free-note' ? 'Note is free' : 'Free access grant',
            accessMode,
            noteId: noteData?.id,
            student: currentStudent?.name || currentStudent?.id
          });
          mediaPanelContent.innerHTML = `
            <div class="media-item">
              <h4>üìö Study Resources</h4>
              <p style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                üîí Video content is only available to paid students in approved groups.
              </p>
            </div>
          `;
          return;
        }
        
        // üîí STEP 1: Check group access for PAID notes
        const hasGroupAccess = checkVideoGroupAccess(noteData);
        
        if (!hasGroupAccess) {
          // Group restriction: Student's group NOT in video_allowed_groups
          console.log('üîí MEDIA ACCESS DENIED:', {
            studentGroup: currentStudent?.group_letter || currentStudent?.group_name,
            allowedGroups: noteData?.video_allowed_groups,
            noteId: noteData?.id,
            requiresPayment: noteData?.requires_payment
          });
          
          mediaPanelContent.innerHTML = `
            <div class="media-item">
              <h4>üìö Study Resources</h4>
              <p style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                üîí Media content not available for your group.
              </p>
            </div>
          `;
          return;
        }
        
        console.log('‚úÖ MEDIA ACCESS GRANTED:', {
          studentGroup: currentStudent?.group_letter || currentStudent?.group_name,
          allowedGroups: noteData?.video_allowed_groups,
          requiresPayment: noteData?.requires_payment,
          noteId: noteData?.id,
          accessMode
        });
        
        if (!hasGroupAccess) {
          // Group restriction: Student's group NOT in video_allowed_groups
          console.log('üîí MEDIA ACCESS DENIED:', {
            studentGroup: currentStudent?.group_letter || currentStudent?.group_name,
            allowedGroups: noteData?.video_allowed_groups,
            noteId: noteData?.id
          });
          
          mediaPanelContent.innerHTML = `
            <div class="media-item">
              <h4>üìö Study Resources</h4>
              <p style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                üîí Media content not available for your group.
              </p>
            </div>
          `;
          return;
        }
        
        // üîí STEP 2: If group access passed, load media from pdf_media table
        let mediaHTML = '';
        
        // Load media items from pdf_media table
        const { data: mediaItems, error: mediaError } = await supabaseClient
          .from('pdf_media')
          .select('*')
          .eq('note_id', noteData.id)
          .order('created_at', { ascending: true });
        
        if (mediaError) {
          console.error('‚ùå Error loading media:', mediaError);
        }
        
        // Render media items (GIFs, videos, links)
        if (mediaItems && mediaItems.length > 0) {
          console.log(`‚úÖ Loaded ${mediaItems.length} media items for note ${noteData.id} (Group ${currentStudent?.group_letter || currentStudent?.group_name} access)`);
          
          mediaItems.forEach(item => {
            if (item.type === 'image') {
              mediaHTML += `
                <div class="media-item">
                  <h4>üì∏ ${item.title}</h4>
                  ${item.description ? `<p>${item.description}</p>` : ''}
                  <div style="margin-top: 12px;">
                    <img src="${item.url}" alt="${item.title}" style="max-width: 100%; border-radius: 8px;">
                  </div>
                </div>
              `;
            } else if (item.type === 'video') {
              const videoEmbed = createProtectedVideoEmbed(item.url, item.title, true);
              mediaHTML += `
                <div class="media-item">
                  <h4>üé¨ ${item.title}</h4>
                  ${item.description ? `<p>${item.description}</p>` : ''}
                  ${videoEmbed}
                </div>
              `;
            } else if (item.type === 'link') {
              mediaHTML += `
                <div class="media-item">
                  <h4>üîó ${item.title}</h4>
                  ${item.description ? `<p>${item.description}</p>` : ''}
                  <div style="margin-top: 12px;">
                    <a href="${item.url}" target="_blank" rel="noopener noreferrer" 
                       style="color: var(--accent-primary); text-decoration: none;">
                      Open Link ‚Üí
                    </a>
                  </div>
                </div>
              `;
            }
          });
        }
        
        // Legacy: Also check for old video_url field in student_notes
        if (noteData && noteData.video_url) {
          const videoTitle = noteData.video_title || noteData.title || 'Study Video';
          const videoEmbed = createProtectedVideoEmbed(noteData.video_url, videoTitle, noteData.video_controls);
          mediaHTML += `
            <div class="media-item">
              <h4>üé¨ ${videoTitle}</h4>
              ${videoEmbed}
            </div>
          `;
        }
        
        // Display media or show "no media" message
        if (mediaHTML) {
          mediaPanelContent.innerHTML = mediaHTML;
        } else {
          mediaPanelContent.innerHTML = `
            <div class="media-item">
              <h4>üìö Study Resources</h4>
              <p style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                No additional media available for this note.
              </p>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('‚ùå Error loading media content:', error);
        mediaPanelContent.innerHTML = `
          <div class="media-item">
            <h4>‚ùå Error</h4>
            <p style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
              Failed to load media content.
            </p>
          </div>
        `;
      }
    }

    /**
     * Check if current student's group has access to media for this note
     * Returns true if:
     * - video_allowed_groups is NULL (all groups allowed)
     * - video_allowed_groups is empty array (all groups allowed)
     * - student's group is in video_allowed_groups array
     * 
     * üîí CRITICAL: This controls access to ALL media (video_url + pdf_media items)
     */
    function checkVideoGroupAccess(note) {
      // If no restriction set (NULL or empty), allow all groups
      if (!note.video_allowed_groups || note.video_allowed_groups.length === 0) {
        console.log('‚úÖ No group restrictions - allowing all groups');
        return true;
      }
      
      // Get student's group letter
      const studentGroup = currentStudent?.group_letter || 
                          currentStudent?.group_name || 
                          currentStudent?.group || 
                          fallbackStudent?.group_letter ||
                          fallbackStudent?.group_name ||
                          fallbackStudent?.group;
      
      if (!studentGroup) {
        console.log('‚ùå Student has no group assigned');
        return false;
      }
      
      // Normalize to single letter (handle "Group A" or "A")
      const groupLetter = studentGroup.toString().trim().toUpperCase().replace(/^GROUP\s*/i, '').charAt(0);
      
      console.log('üîç Checking group access:', {
        studentGroup: groupLetter,
        allowedGroups: note.video_allowed_groups,
        noteId: note.id
      });
      
      // Check if student's group is in allowed list
      const hasAccess = note.video_allowed_groups.some(allowedGroup => {
        const normalizedAllowed = allowedGroup.toString().trim().toUpperCase().replace(/^GROUP\s*/i, '').charAt(0);
        return normalizedAllowed === groupLetter;
      });
      
      if (hasAccess) {
        console.log(`‚úÖ Group ${groupLetter} HAS ACCESS to note ${note.id}`);
      } else {
        console.log(`üîí Group ${groupLetter} BLOCKED from note ${note.id} (allowed: ${note.video_allowed_groups.join(', ')})`);
      }
      
      return hasAccess;
    }
    
    function toggleMediaPanel(event) {
      if (event) {
        event.stopPropagation(); // Prevent immediate close from document click
      }
      
      const panel = document.getElementById('mediaPanel');
      panel.classList.toggle('open');
      
      // Clear search when closing
      if (!panel.classList.contains('open')) {
        const searchInput = document.getElementById('mediaSearchInput');
        if (searchInput) {
          searchInput.value = '';
          filterMediaItems();
        }
      }
    }

    // Filter media items based on search input
    function filterMediaItems() {
      const searchInput = document.getElementById('mediaSearchInput');
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      const mediaItems = document.querySelectorAll('.media-item');
      
      mediaItems.forEach(item => {
        const title = item.querySelector('h4')?.textContent.toLowerCase() || '';
        const description = item.querySelector('p')?.textContent.toLowerCase() || '';
        
        if (title.includes(searchTerm) || description.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Show media panel toggle when PDF is loaded
    function showMediaPanelToggle() {
      document.getElementById('mediaPanelToggle').style.display = 'flex';
    }

    // Close media panel when clicking outside
    document.addEventListener('click', function(event) {
      const panel = document.getElementById('mediaPanel');
      const toggle = document.getElementById('mediaPanelToggle');
      
      if (panel && panel.classList.contains('open')) {
        // Check if click is outside both panel and toggle button
        if (!panel.contains(event.target) && !toggle.contains(event.target)) {
          panel.classList.remove('open');
        }
      }
    });

    // ============================================================
    // GLOBAL ERROR HANDLERS - ROBUSTNESS
    // ============================================================
    
    // Catch all unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      console.error('‚ùå Unhandled Promise Rejection:', event.reason);
      showError('An unexpected error occurred: ' + (event.reason?.message || event.reason || 'Unknown error'));
      event.preventDefault();
    });
    
    // Catch all uncaught errors
    window.addEventListener('error', function(event) {
      console.error('‚ùå Uncaught Error:', event.error);
      
      // Don't show error for script loading failures (CDN issues)
      if (event.message && event.message.includes('Script error')) {
        console.warn('Script loading error detected, but PDF viewer may still work');
        return;
      }
      
      showError('An unexpected error occurred. Please refresh the page.');
      event.preventDefault();
    });
    
    // Monitor PDF.js worker errors
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    
    // Verify critical dependencies on load
    if (typeof window.supabase === 'undefined') {
      showError('‚ùå CRITICAL: Supabase SDK failed to load. Please check your internet connection and refresh.');
    }
    
    if (typeof pdfjsLib === 'undefined') {
      showError('‚ùå CRITICAL: PDF.js library failed to load. Please check your internet connection and refresh.');
    }
    
    console.log('‚úÖ Protected PDF Viewer initialized with robust error handling');
  </script>
</body>
</html>
