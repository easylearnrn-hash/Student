<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>üìö ARNOMA Notes Manager</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="shared-auth.js"></script>
  <script src="shared-dialogs.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      min-height: 100vh;
      padding: 40px 20px;
      color: white;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(118, 75, 162, 0.12) 0%, transparent 50%);
      animation: gradientShift 20s ease infinite;
      z-index: -1;
    }

    @keyframes gradientShift {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.85; transform: scale(1.1); }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* ===== HEADER ===== */
    .header {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(var(--modal-blur));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, #8ab4ff, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-primary {
      padding: 11px 24px;
      background: rgba(16, 185, 129, 0.15);
      border: 2px solid rgba(16, 185, 129, 0.4);
      border-radius: 12px;
      color: #6ee7b7;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .btn-primary:hover {
      background: rgba(16, 185, 129, 0.25);
      border-color: #10b981;
      transform: translateY(-2px);
      box-shadow: 0 0 25px rgba(16, 185, 129, 0.4);
    }

    .btn-secondary {
      padding: 11px 24px;
      background: rgba(59, 130, 246, 0.15);
      border: 2px solid rgba(59, 130, 246, 0.4);
      border-radius: 12px;
      color: #93c5fd;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      background: rgba(59, 130, 246, 0.25);
      border-color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 0 25px rgba(59, 130, 246, 0.4);
    }

    .btn-danger {
      padding: 8px 16px;
      background: rgba(239, 68, 68, 0.15);
      border: 2px solid rgba(239, 68, 68, 0.4);
      border-radius: 10px;
      color: #fca5a5;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.25);
      border-color: #ef4444;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
    }

    .logout-btn {
      padding: 8px 16px;
      background: rgba(239, 68, 68, 0.15);
      border: 2px solid rgba(239, 68, 68, 0.4);
      border-radius: 10px;
      color: #fca5a5;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ===== TAB NAVIGATION ===== */
    .tab-nav {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 14px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: rgba(102, 126, 234, 0.2);
      border-color: rgba(102, 126, 234, 0.6);
      color: #8ab4ff;
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    }

    .tab-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== UPLOAD SECTION ===== */
    .upload-card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(var(--modal-blur));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 30px;
      margin-top: 20px;
    }

    .upload-card h3 {
      font-size: 20px;
      color: #8ab4ff;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 8px;
    }

    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: white;
      font-size: 14px;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: rgba(102, 126, 234, 0.6);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* ===== FILE UPLOAD ===== */
    .file-drop-zone {
      border: 2px dashed rgba(102, 126, 234, 0.4);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: rgba(102, 126, 234, 0.05);
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-drop-zone:hover {
      border-color: rgba(102, 126, 234, 0.8);
      background: rgba(102, 126, 234, 0.1);
    }

    .file-drop-zone.drag-over {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }

    .file-drop-zone .icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .file-drop-zone .text {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    .file-list {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .file-item-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .file-item-name {
      color: white;
      font-size: 14px;
      font-weight: 500;
    }

    .file-item-size {
      color: rgba(255, 255, 255, 0.5);
      font-size: 12px;
    }

    .file-item-remove {
      padding: 6px 12px;
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 6px;
      color: #fca5a5;
      font-size: 12px;
      cursor: pointer;
    }

    .file-item-remove:hover {
      background: rgba(239, 68, 68, 0.25);
    }

    /* ===== PROGRESS BAR ===== */
    .upload-progress {
      margin-top: 20px;
      display: none;
    }

    .upload-progress.active {
      display: block;
    }

    .progress-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      width: 0%;
      transition: width 0.3s;
    }

    .progress-text {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
    }

    /* ===== NOTES LIBRARY ===== */
    .library-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
    }

    .system-filter {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-chip {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-chip.active {
      background: rgba(102, 126, 234, 0.2);
      border-color: rgba(102, 126, 234, 0.6);
      color: #8ab4ff;
    }

    .filter-chip:hover:not(.active) {
      background: rgba(255, 255, 255, 0.08);
    }

    .notes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .note-card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(var(--modal-blur));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      padding: 20px;
      transition: all 0.3s;
    }

    .note-card:hover {
      transform: translateY(-4px);
      border-color: rgba(102, 126, 234, 0.4);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
    }

    .note-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .note-card-title {
      font-size: 16px;
      font-weight: 600;
      color: white;
      margin-bottom: 4px;
    }

    .note-card-system {
      font-size: 12px;
      color: rgba(138, 180, 255, 0.8);
      font-weight: 600;
    }

    .note-card-body {
      margin-bottom: 12px;
    }

    .note-card-desc {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 8px;
    }

    .note-card-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
    }

    .note-card-actions {
      display: flex;
      gap: 8px;
    }

    .note-action-btn {
      flex: 1;
      padding: 8px;
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.4);
      border-radius: 8px;
      color: #93c5fd;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .note-action-btn:hover {
      background: rgba(59, 130, 246, 0.25);
    }

    .note-action-btn.danger {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.4);
      color: #fca5a5;
    }

    .note-action-btn.danger:hover {
      background: rgba(239, 68, 68, 0.25);
    }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.5);
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state .text {
      font-size: 16px;
    }

    /* ===== LOADING ===== */
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.7);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(102, 126, 234, 0.2);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== TOGGLE SWITCH ===== */
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      display: inline-block;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 34px;
      transition: 0.3s;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 2px;
      bottom: 2px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle-switch input:checked + .toggle-slider {
      background: rgba(16, 185, 129, 0.3);
      border-color: #10b981;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
      background: #10b981;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .header-top {
        flex-direction: column;
        gap: 16px;
      }

      .tab-nav {
        flex-direction: column;
      }

      .notes-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
<style>:root{--panel-blur:8px;--card-blur:8px;--modal-blur:14px;--list-blur:0px;}</style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-top">
        <div>
          <h1 class="page-title">üìö Notes Manager</h1>
          <div style="font-size: 14px; color: rgba(138, 180, 255, 0.7); margin-top: 4px;">
            Upload and organize notes by NCLEX systems
          </div>
        </div>
        <div class="header-actions">
          <button class="btn-secondary" onclick="window.location.href='Student-Portal-Admin.html'">
            ‚Üê Back to Admin
          </button>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('single')">
          üìÑ Single Upload
        </button>
        <button class="tab-btn" onclick="switchTab('bulk')">
          üì¶ Bulk Upload
        </button>
        <button class="tab-btn" onclick="switchTab('library')">
          üìö Notes Library
        </button>
      </div>
    </div>

    <!-- TAB 1: Single Upload -->
    <div id="tab-single" class="tab-content active">
      <div class="upload-card">
        <h3>üì§ Upload Single Note</h3>
        <form id="singleUploadForm" onsubmit="handleSingleUpload(event)">
          <div class="form-group">
            <label>üìã System/Topic *</label>
            <select id="singleSystem" required>
              <option value="">Select System</option>
              <option value="Medical Terminology">Medical Terminology</option>
              <option value="Human Anatomy">Human Anatomy</option>
              <option value="Medication Suffixes and Drug Classes">Medication Suffixes and Drug Classes</option>
              <option value="Cardiovascular System">Cardiovascular System</option>
              <option value="Endocrine System">Endocrine System</option>
              <option value="Gastrointestinal & Hepatic System">Gastrointestinal & Hepatic System</option>
              <option value="Respiratory System">Respiratory System</option>
              <option value="Renal">Renal</option>
              <option value="Fluids, Electrolytes & Nutrition">Fluids, Electrolytes & Nutrition</option>
              <option value="Eye Disorders">Eye Disorders</option>
              <option value="EENT">EENT</option>
              <option value="Burns and Skin">Burns and Skin</option>
              <option value="Reproductive and Sexual Health System">Reproductive and Sexual Health System</option>
              <option value="Maternal Health">Maternal Health</option>
              <option value="Pediatrics">Pediatrics</option>
              <option value="Medical-Surgical Care">Medical-Surgical Care</option>
              <option value="Mental Health">Mental Health</option>
              <option value="Autoimmune & Infectious Disorders">Autoimmune & Infectious Disorders</option>
              <option value="Neurology">Neurology</option>
              <option value="Cancer">Cancer</option>
              <option value="Musculoskeletal Disorders">Musculoskeletal Disorders</option>
              <option value="Psycho-Social Aspects">Psycho-Social Aspects</option>
              <option value="Nursing Skills and Fundamentals">Nursing Skills and Fundamentals</option>
              <option value="Pharmacology">Pharmacology</option>
            </select>
          </div>

          <div class="form-group">
            <label>üìù Title *</label>
            <input type="text" id="singleTitle" required placeholder="e.g., Cardiovascular System - Week 5">
          </div>

          <div class="form-group">
            <label>üìÑ Description (Optional)</label>
            <textarea id="singleDescription" placeholder="Add any additional details about this note..."></textarea>
          </div>

          <div class="form-group">
            <label>üìÖ Class Date *</label>
            <input type="date" id="singleClassDate" required>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; justify-content: space-between;">
              <span>üîí Requires Payment to View</span>
              <label class="toggle-switch" style="margin: 0;">
                <input type="checkbox" id="singleRequiresPayment" checked>
                <span class="toggle-slider"></span>
              </label>
            </label>
            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 8px;">
              When enabled, students must have paid to access this note
            </div>
          </div>

          <div class="form-group">
            <label>üé• Video URL (Optional)</label>
            <input type="text" id="singleVideoUrl" placeholder="YouTube or Google Drive video link">
            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 8px;">
              üîí Video will be protected - students cannot see or share the URL<br>
              ‚úÖ Supports: YouTube & Google Drive videos
            </div>
          </div>

          <div class="form-group" id="videoTitleContainer" style="display: none;">
            <label>üìù Video Title (Optional)</label>
            <input type="text" id="singleVideoTitle" placeholder="e.g., Cardiovascular System Overview">
            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 8px;">
              Leave empty to use the PDF note title
            </div>
          </div>

          <div class="form-group" id="videoControlsContainer" style="display: none;">
            <label>üéõÔ∏è Video Controls (What features to show?)</label>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="videoAllowSettings" value="settings" checked style="cursor: pointer;">
                <span>‚öôÔ∏è Settings (Quality, Speed, Subtitles)</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="videoAllowPlay" value="play" checked style="cursor: pointer;">
                <span>‚ñ∂Ô∏è Play/Pause</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="videoAllowMute" value="mute" checked style="cursor: pointer;">
                <span>ÔøΩ Mute</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="videoAllowFullscreen" value="fullscreen" checked style="cursor: pointer;">
                <span>‚õ∂ Fullscreen</span>
              </label>
            </div>
            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 8px;">
              ‚ÑπÔ∏è Uncheck features you want to hide from students
            </div>
          </div>

          <div class="form-group" id="videoGroupAccessContainer" style="display: none;">
            <label>üë• Video Access (Which groups can see the video?)</label>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="videoGroupA" value="A" style="cursor: pointer;">
                <span>Group A</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="videoGroupB" value="B" style="cursor: pointer;">
                <span>Group B</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="videoGroupC" value="C" style="cursor: pointer;">
                <span>Group C</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="videoGroupD" value="D" style="cursor: pointer;">
                <span>Group D</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="videoGroupE" value="E" style="cursor: pointer;">
                <span>Group E</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="videoGroupF" value="F" style="cursor: pointer;">
                <span>Group F</span>
              </label>
            </div>
            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 8px;">
              ‚ÑπÔ∏è Leave all unchecked to allow ALL groups. Check specific groups to restrict access.
            </div>
          </div>

          <div class="form-group">
            <label>üìé PDF File *</label>
            <div class="file-drop-zone" id="singleDropZone" onclick="document.getElementById('singleFileInput').click()">
              <input type="file" id="singleFileInput" accept=".pdf" style="display: none;" onchange="handleSingleFileSelect(event)">
              <div class="icon">üìÑ</div>
              <div class="text">Click to browse or drag and drop PDF file</div>
            </div>
            <div id="singleFileList" class="file-list"></div>
          </div>

          <div class="upload-progress" id="singleProgress">
            <div class="progress-bar">
              <div class="progress-fill" id="singleProgressFill"></div>
            </div>
            <div class="progress-text" id="singleProgressText">Uploading...</div>
          </div>

          <button type="submit" class="btn-primary" id="singleUploadBtn" style="width: 100%; margin-top: 20px;">
            üì§ Upload Note
          </button>
        </form>
      </div>
    </div>

    <!-- TAB 2: Bulk Upload -->
    <div id="tab-bulk" class="tab-content">
      <div class="upload-card">
        <h3>üì¶ Bulk Upload Notes</h3>
        <p style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin-bottom: 20px;">
          Upload multiple PDF files at once for the same system. All files will be organized in the same folder.
        </p>

        <form id="bulkUploadForm" onsubmit="handleBulkUpload(event)">
          <div class="form-group">
            <label>üìã System/Topic *</label>
            <select id="bulkSystem" required>
              <option value="">Select System</option>
              <option value="Medical Terminology">Medical Terminology</option>
              <option value="Human Anatomy">Human Anatomy</option>
              <option value="Medication Suffixes and Drug Classes">Medication Suffixes and Drug Classes</option>
              <option value="Cardiovascular System">Cardiovascular System</option>
              <option value="Endocrine System">Endocrine System</option>
              <option value="Gastrointestinal & Hepatic System">Gastrointestinal & Hepatic System</option>
              <option value="Respiratory System">Respiratory System</option>
              <option value="Renal">Renal</option>
              <option value="Fluids, Electrolytes & Nutrition">Fluids, Electrolytes & Nutrition</option>
              <option value="Eye Disorders">Eye Disorders</option>
              <option value="EENT">EENT</option>
              <option value="Burns and Skin">Burns and Skin</option>
              <option value="Reproductive and Sexual Health System">Reproductive and Sexual Health System</option>
              <option value="Maternal Health">Maternal Health</option>
              <option value="Pediatrics">Pediatrics</option>
              <option value="Medical-Surgical Care">Medical-Surgical Care</option>
              <option value="Mental Health">Mental Health</option>
              <option value="Autoimmune & Infectious Disorders">Autoimmune & Infectious Disorders</option>
              <option value="Neurology">Neurology</option>
              <option value="Cancer">Cancer</option>
              <option value="Musculoskeletal Disorders">Musculoskeletal Disorders</option>
              <option value="Psycho-Social Aspects">Psycho-Social Aspects</option>
              <option value="Nursing Skills and Fundamentals">Nursing Skills and Fundamentals</option>
              <option value="Pharmacology">Pharmacology</option>
            </select>
          </div>

          <div class="form-group">
            <label>üìÖ Class Date (applies to all files) *</label>
            <input type="date" id="bulkClassDate" required>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; justify-content: space-between;">
              <span>üîí Requires Payment to View (applies to all)</span>
              <label class="toggle-switch" style="margin: 0;">
                <input type="checkbox" id="bulkRequiresPayment" checked>
                <span class="toggle-slider"></span>
              </label>
            </label>
          </div>

          <div class="form-group">
            <label>üìé Select Multiple PDF Files *</label>
            <div class="file-drop-zone" id="bulkDropZone" onclick="document.getElementById('bulkFileInput').click()">
              <input type="file" id="bulkFileInput" accept=".pdf" multiple style="display: none;" onchange="handleBulkFileSelect(event)">
              <div class="icon">üì¶</div>
              <div class="text">Click to browse or drag and drop multiple PDF files</div>
              <div style="font-size: 12px; color: rgba(255, 255, 255, 0.4); margin-top: 8px;">
                You can select up to 50 files at once
              </div>
            </div>
            <div id="bulkFileList" class="file-list"></div>
          </div>

          <div class="upload-progress" id="bulkProgress">
            <div class="progress-bar">
              <div class="progress-fill" id="bulkProgressFill"></div>
            </div>
            <div class="progress-text" id="bulkProgressText">Uploading 0/0 files...</div>
          </div>

          <button type="submit" class="btn-primary" id="bulkUploadBtn" style="width: 100%; margin-top: 20px;">
            üì¶ Upload All Files
          </button>
        </form>
      </div>
    </div>

    <!-- TAB 3: Notes Library -->
    <div id="tab-library" class="tab-content">
      <div class="library-header">
        <h3 style="color: #8ab4ff; margin: 0;">üìö All Notes</h3>
        <div style="display: flex; gap: 12px; align-items: center;">
          <input 
            type="text" 
            id="searchInput" 
            placeholder="üîç Search notes by title or description..." 
            oninput="filterNotes()"
            style="padding: 8px 16px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: white; min-width: 300px;"
          />
          <select id="systemFilter" onchange="filterNotes()" style="padding: 8px 16px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: white;">
            <option value="">All Systems</option>
          <option value="Medical Terminology">Medical Terminology</option>
          <option value="Human Anatomy">Human Anatomy</option>
          <option value="Medication Suffixes and Drug Classes">Medication Suffixes and Drug Classes</option>
          <option value="Cardiovascular System">Cardiovascular System</option>
          <option value="Endocrine System">Endocrine System</option>
          <option value="Gastrointestinal & Hepatic System">Gastrointestinal & Hepatic System</option>
          <option value="Respiratory System">Respiratory System</option>
          <option value="Renal">Renal</option>
          <option value="Fluids, Electrolytes & Nutrition">Fluids, Electrolytes & Nutrition</option>
          <option value="Eye Disorders">Eye Disorders</option>
          <option value="EENT">EENT</option>
          <option value="Burns and Skin">Burns and Skin</option>
          <option value="Reproductive and Sexual Health System">Reproductive and Sexual Health System</option>
          <option value="Maternal Health">Maternal Health</option>
          <option value="Pediatrics">Pediatrics</option>
          <option value="Medical-Surgical Care">Medical-Surgical Care</option>
          <option value="Mental Health">Mental Health</option>
          <option value="Autoimmune & Infectious Disorders">Autoimmune & Infectious Disorders</option>
          <option value="Neurology">Neurology</option>
          <option value="Cancer">Cancer</option>
          <option value="Musculoskeletal Disorders">Musculoskeletal Disorders</option>
          <option value="Psycho-Social Aspects">Psycho-Social Aspects</option>
          <option value="Nursing Skills and Fundamentals">Nursing Skills and Fundamentals</option>
          <option value="Pharmacology">Pharmacology</option>
        </select>
        </div>
      </div>

      <!-- Bulk Delete Controls -->
      <div style="display: flex; gap: 12px; align-items: center; padding: 16px; background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; margin-bottom: 16px;" id="bulkDeleteControls">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="selectAllNotes" onchange="toggleSelectAll()" style="width: 18px; height: 18px; cursor: pointer;">
          <span style="color: #fca5a5; font-weight: 600;">Select All</span>
        </label>
        <div style="flex: 1;"></div>
        <span id="selectedCount" style="color: #fca5a5;">0 selected</span>
        <button onclick="bulkDeleteNotes()" id="bulkDeleteBtn" disabled style="padding: 8px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; opacity: 0.5;">
          üóëÔ∏è Delete Selected
        </button>
      </div>

      <div class="notes-grid" id="notesGrid">
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading notes...</div>
        </div>
      </div>
      <input 
        type="file" 
        id="replaceFileInput" 
        accept=".pdf" 
        style="display: none;" 
        onchange="handleReplaceFile(event)"
      />
    </div>
  </div>

    <script>
    // ===== SUPABASE CONFIGURATION =====
    const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const BUCKET_NAME = 'student-notes';

  let singleFile = null;
  let bulkFiles = [];
  let allNotes = [];
  let replaceTarget = null;

    // ===== INITIALIZATION =====
    (async function init() {
      try {
        const session = window.ArnomaAuth
          ? await window.ArnomaAuth.ensureSession(supabase, { redirectToLogin: true })
          : (await supabase.auth.getSession()).data.session;

        if (!session) {
          window.location.href = 'index.html';
          return;
        }

        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('singleClassDate').value = today;
        document.getElementById('bulkClassDate').value = today;

        // Setup drag & drop
        setupDragAndDrop();
        setupVideoGroupToggle();

        // Load notes if on library tab
        if (document.getElementById('tab-library').classList.contains('active')) {
          await loadNotes();
        }
      } catch (error) {
        console.error('Init error:', error);
        alert('Failed to initialize: ' + error.message);
      }
    })();

    // ===== VIDEO GROUP ACCESS TOGGLE =====
    function setupVideoGroupToggle() {
      const videoUrlInput = document.getElementById('singleVideoUrl');
      const groupAccessContainer = document.getElementById('videoGroupAccessContainer');
      const controlsContainer = document.getElementById('videoControlsContainer');
      const videoTitleContainer = document.getElementById('videoTitleContainer');
      
      videoUrlInput.addEventListener('input', function() {
        if (this.value.trim()) {
          groupAccessContainer.style.display = 'block';
          controlsContainer.style.display = 'block';
          videoTitleContainer.style.display = 'block';
        } else {
          groupAccessContainer.style.display = 'none';
          controlsContainer.style.display = 'none';
          videoTitleContainer.style.display = 'none';
          // Uncheck all groups when video URL is cleared
          ['A', 'B', 'C', 'D', 'E', 'F'].forEach(letter => {
            document.getElementById(`videoGroup${letter}`).checked = false;
          });
        }
      });
    }

    // ===== GET SELECTED VIDEO CONTROLS =====
    function getSelectedVideoControls() {
      const videoUrl = document.getElementById('singleVideoUrl').value.trim();
      if (!videoUrl) return null; // No video = no controls needed
      
      const controls = {};
      controls.settings = document.getElementById('videoAllowSettings')?.checked || false;
      controls.play = document.getElementById('videoAllowPlay')?.checked || false;
      controls.mute = document.getElementById('videoAllowMute')?.checked || false;
      controls.fullscreen = document.getElementById('videoAllowFullscreen')?.checked || false;
      
      return controls;
    }

    // ===== GET SELECTED VIDEO GROUPS =====
    function getSelectedVideoGroups() {
      const videoUrl = document.getElementById('singleVideoUrl').value.trim();
      if (!videoUrl) return null; // No video = no restrictions
      
      const selectedGroups = [];
      ['A', 'B', 'C', 'D', 'E', 'F'].forEach(letter => {
        if (document.getElementById(`videoGroup${letter}`).checked) {
          selectedGroups.push(letter);
        }
      });
      
      // If no groups selected, return null (all groups allowed)
      // If specific groups selected, return array
      return selectedGroups.length > 0 ? selectedGroups : null;
    }

    // ===== EMAIL NOTIFICATION FOR NEW NOTES =====
    async function sendNoteNotificationEmail(categoryName, noteTitle) {
      console.log('üöÄ EMAIL FUNCTION CALLED!');
      console.log('üìù Category:', categoryName);
      console.log('üìù Note Title:', noteTitle);
      console.log('üîó SUPABASE_URL:', SUPABASE_URL);
      console.log('üîë Has SUPABASE_ANON_KEY:', !!SUPABASE_ANON_KEY);
      
      try {
        console.log(`üìß Fetching ALL active students for note notification...`);
        // Get ALL active students (notes are assigned to groups later in Group-Notes)
        const { data: students, error: studentsError } = await supabase
          .from('students')
          .select('email, name, group_name')
          .eq('show_in_grid', true)
          .not('email', 'is', null);

        if (studentsError) {
          console.error('‚ùå Error fetching students:', studentsError);
          throw studentsError;
        }
        
        if (!students || students.length === 0) {
          console.warn(`‚ö†Ô∏è No students found with email addresses`);
          return;
        }

        console.log(`‚úÖ Found ${students.length} active students:`, students.map(s => s.name));
        console.log(`üì® Sending ${students.length} email notifications...`);

        // Send email to each student
        let successCount = 0;
        let failCount = 0;
        
        for (const student of students) {
          if (!student.email) {
            console.warn(`‚ö†Ô∏è Skipping ${student.name} - no email address`);
            continue;
          }

          console.log(`üì§ Sending email to ${student.name} (${student.email})...`);

          const emailHTML = `
              <!DOCTYPE html>
              <html>
              <head>
                <meta charset="UTF-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <title>ARNOMA NCLEX-RN Email</title>
                <style>
                  * { box-sizing: border-box; }
                  body {
                    margin: 0;
                    padding: 0;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 40px 20px;
                  }
                  .email-wrapper {
                    max-width: 600px;
                    margin: 0 auto;
                  }
                  .email-container {
                    background-color: #ffffff;
                    border-radius: 16px;
                    overflow: hidden;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                  }
                  .email-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 45px 35px 35px;
                    text-align: center;
                  }
                  .email-header img {
                    width: 140px;
                    height: 140px;
                    margin-bottom: 15px;
                    filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.7)) drop-shadow(0 0 12px rgba(255, 255, 255, 0.4)) drop-shadow(0 0 3px rgba(255, 255, 255, 0.8));
                  }
                  .email-header h1 {
                    color: #fff;
                    margin: 0;
                    font-size: 28px;
                    letter-spacing: -0.5px;
                  }
                  .email-body {
                    padding: 35px;
                    color: #333;
                    font-size: 16px;
                    line-height: 1.6;
                  }
                  .email-body p {
                    margin: 0 0 16px 0;
                  }
                  .info-box {
                    background-color: #f6f8fe;
                    border-left: 3px solid #3b82f6;
                    border-radius: 10px;
                    padding: 14px 18px;
                    font-size: 15px;
                    line-height: 1.5;
                    color: #1e293b;
                    margin: 20px 0;
                    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
                  }
                  .info-box p {
                    margin: 6px 0;
                    text-align: left;
                  }
                  .email-footer {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: #fff;
                    text-align: center;
                    padding: 30px 20px;
                  }
                </style>
              </head>
              <body>
                <div class="email-wrapper">
                  <div class="email-container">
                    
                    <div class="email-header">
                      <img src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png" alt="ARNOMA Logo" />
                      <h1>New Class Note Posted</h1>
                    </div>

                    <div class="email-body">
                      <p>Dear <strong>${student.name || 'Nurse'}</strong>,</p>

                      <p>Yohoo! One down üéâ</p>

                      <p>Another class note has just been posted by your instructor.</p>

                      <div class="info-box">
                        <p><strong>New Note Available:</strong></p>
                        <p><a href="https://easylearnrn-hash.github.io/Student/index.html" style="color: #3b82f6; text-decoration: none; font-weight: 600;">${noteTitle}</a></p>
                        <p><strong>Category:</strong> ${categoryName}</p>
                      </div>

                      <p>Every class you complete brings you <strong>one step closer</strong> to your goal. Note by note, you are building the <strong>knowledge and confidence</strong> needed to succeed.</p>

                      <p><strong>Stay consistent</strong>, trust yourself, and remember <strong>why you started</strong>. Progress adds up faster than you think.</p>

                      <p>Log in to your student portal to view the new note and <strong>keep moving forward</strong>.</p>

                      <p>Your future is taking shape ‚Äî <strong>one lesson at a time</strong>.</p>

                      <p>Best regards,<br /><strong>ARNOMA Team</strong></p>
                    </div>

                    <div class="email-footer">
                      <p><strong style="font-size: 18px">ARNOMA ‚Äì NCLEX RN</strong></p>
                      <p style="font-size: 14px">Professional NCLEX Preparation & Medical Education</p>
                      <p style="font-size: 13px">nclex.rn@arnoma.us<br />richy@arnoma.us<br />909-808-1818</p>
                      <p style="font-size: 12px; color: #e5e7eb">¬© 2025 ARNOMA. All rights reserved.</p>
                    </div>

                  </div>
                </div>
              </body>
              </html>
            `;

          const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            },
            body: JSON.stringify({
              to: student.email,
              subject: 'New Class Note Posted ‚Äî Keep Going! üåü',
              html: emailHTML
            })
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error(`‚ùå Failed to send email to ${student.email}:`, response.status, errorText);
            try {
              const errorJSON = JSON.parse(errorText);
              console.error(`‚ùå Parsed error:`, errorJSON);
            } catch (e) {
              console.error(`‚ùå Raw error text:`, errorText);
            }
            failCount++;
          } else {
            const result = await response.json();
            console.log(`‚úÖ Email sent successfully to ${student.name} (${student.email})`, result);
            successCount++;
          }
        }

        console.log(`üìä Email notification summary: ${successCount} sent, ${failCount} failed`);
        if (failCount > 0) {
          throw new Error(`Failed to send ${failCount} of ${students.length} emails`);
        }
      } catch (error) {
        console.error('‚ùå Email notification error:', error);
        throw error;
      }
    }

    // ===== TAB SWITCHING =====
    async function switchTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');

      // Load notes when switching to library
      if (tab === 'library') {
        await loadNotes();
      }
    }

    // ===== DRAG & DROP SETUP =====
    function setupDragAndDrop() {
      const zones = [
        { zone: 'singleDropZone', input: 'singleFileInput', multi: false },
        { zone: 'bulkDropZone', input: 'bulkFileInput', multi: true }
      ];

      zones.forEach(({ zone, input, multi }) => {
        const dropZone = document.getElementById(zone);
        const fileInput = document.getElementById(input);

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
        });

        dropZone.addEventListener('drop', function(e) {
          const dt = e.dataTransfer;
          const files = dt.files;

          if (multi) {
            handleBulkFileSelect({ target: { files } });
          } else {
            handleSingleFileSelect({ target: { files } });
          }
        }, false);
      });
    }

    // ===== SINGLE FILE HANDLING =====
    function handleSingleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.type !== 'application/pdf') {
        alert('Please select a PDF file');
        return;
      }

      if (file.size > 50 * 1024 * 1024) {
        alert('File size must be less than 50MB');
        return;
      }

      singleFile = file;
      displaySingleFile();
    }

    function displaySingleFile() {
      const fileList = document.getElementById('singleFileList');
      fileList.innerHTML = `
        <div class="file-item">
          <div class="file-item-info">
            <div>üìÑ</div>
            <div>
              <div class="file-item-name">${singleFile.name}</div>
              <div class="file-item-size">${formatFileSize(singleFile.size)}</div>
            </div>
          </div>
          <button type="button" class="file-item-remove" onclick="removeSingleFile()">‚úï Remove</button>
        </div>
      `;
    }

    function removeSingleFile() {
      singleFile = null;
      document.getElementById('singleFileList').innerHTML = '';
      document.getElementById('singleFileInput').value = '';
    }

    // ===== BULK FILE HANDLING =====
    async function handleBulkFileSelect(event) {
      const files = Array.from(event.target.files);
      
      // Validate files
      const validFiles = [];
      for (const file of files) {
        if (file.type !== 'application/pdf') {
          await customAlert('Invalid File', `${file.name} is not a PDF file`);
          continue;
        }
        if (file.size > 50 * 1024 * 1024) {
          await customAlert('File Too Large', `${file.name} is larger than 50MB`);
          continue;
        }
        validFiles.push(file);
      }

      if (validFiles.length === 0) return;

      bulkFiles = [...bulkFiles, ...validFiles];
      if (bulkFiles.length > 50) {
        alert('Maximum 50 files allowed');
        bulkFiles = bulkFiles.slice(0, 50);
      }

      displayBulkFiles();
    }

    function displayBulkFiles() {
      const fileList = document.getElementById('bulkFileList');
      fileList.innerHTML = bulkFiles.map((file, index) => `
        <div class="file-item">
          <div class="file-item-info">
            <div>üìÑ</div>
            <div>
              <div class="file-item-name">${file.name}</div>
              <div class="file-item-size">${formatFileSize(file.size)}</div>
            </div>
          </div>
          <button type="button" class="file-item-remove" onclick="removeBulkFile(${index})">‚úï</button>
        </div>
      `).join('');
    }

    function removeBulkFile(index) {
      bulkFiles.splice(index, 1);
      displayBulkFiles();
      if (bulkFiles.length === 0) {
        document.getElementById('bulkFileInput').value = '';
      }
    }

    // ===== SINGLE UPLOAD =====
    async function handleSingleUpload(event) {
      event.preventDefault();
      
      console.log('üöÄ ====== SINGLE UPLOAD STARTED ======');

      if (!singleFile) {
        alert('Please select a PDF file');
        return;
      }

      const btn = document.getElementById('singleUploadBtn');
      const progress = document.getElementById('singleProgress');
      const progressFill = document.getElementById('singleProgressFill');
      const progressText = document.getElementById('singleProgressText');

      try {
        console.log('üìù Starting upload process...');
        btn.disabled = true;
        btn.textContent = '‚è≥ Uploading...';
        progress.classList.add('active');

        const systemName = document.getElementById('singleSystem').value;
        const title = document.getElementById('singleTitle').value;
        const description = document.getElementById('singleDescription').value;
        const classDate = document.getElementById('singleClassDate').value;
        
        console.log('üìã Upload details:', { systemName, title, classDate });
        const requiresPayment = document.getElementById('singleRequiresPayment').checked;
        const videoUrl = document.getElementById('singleVideoUrl').value.trim() || null;
        const videoTitle = document.getElementById('singleVideoTitle').value.trim() || null;
        const videoAllowedGroups = getSelectedVideoGroups(); // ‚úÖ NEW: Get selected groups

        // Upload to storage
        progressFill.style.width = '30%';
        progressText.textContent = 'Uploading to storage...';

        const timestamp = Date.now();
        // Use hyphens everywhere for clean URLs (no spaces)
        const folderName = systemName.replace(/\s+/g, '-');
        const baseFileName = `${systemName}_${classDate}_${timestamp}`.replace(/\s+/g, '-');
        const filePath = `${folderName}/${baseFileName}.pdf`;

        console.log('üì§ Uploading to storage:', { bucket: BUCKET_NAME, path: filePath, size: singleFile.size });

        const { data: uploadData, error: uploadError } = await supabase.storage
          .from(BUCKET_NAME)
          .upload(filePath, singleFile, {
            cacheControl: '3600',
            upsert: false
          });

        console.log('üì§ Upload result:', { data: uploadData, error: uploadError });

        if (uploadError) {
          console.error('‚ùå Storage upload failed:', uploadError);
          throw uploadError;
        }

        console.log('‚úÖ File uploaded to storage successfully');

        // Save to database
        progressFill.style.width = '70%';
        progressText.textContent = 'Saving to database...';

        const videoControls = getSelectedVideoControls(); // Get selected controls

        const { error: dbError } = await supabase
          .from('student_notes')
          .insert({
            title,
            description,
            group_name: systemName,
            category: systemName, // ‚úÖ NEW: Link note to system via category column
            class_date: classDate,
            pdf_url: filePath,
            file_name: singleFile.name,
            file_size: singleFile.size,
            requires_payment: requiresPayment,
            video_url: videoUrl, // ‚úÖ NEW: Protected video URL (YouTube or Google Drive)
            video_title: videoTitle, // ‚úÖ NEW: Custom video name
            video_allowed_groups: videoAllowedGroups, // ‚úÖ NEW: Group access restrictions
            video_controls: videoControls, // ‚úÖ NEW: Video player controls configuration
            is_system_note: true,
            deleted: false
          });

        console.log('üíæ Database insert result:', { dbError });
        
        if (dbError) {
          console.error('‚ùå Database error:', dbError);
          throw dbError;
        }

        console.log('‚úÖ Database insert successful!');

        progressFill.style.width = '100%';
        progressText.textContent = '‚úÖ Upload complete!';
        
        console.log('üìä Upload process completed, moving to email notification...');

        // Send email notification to students in the group
        console.log('üìß ====== STARTING EMAIL NOTIFICATION PROCESS ======');
        console.log('üìß About to call sendNoteNotificationEmail()');
        console.log('üìß systemName:', systemName);
        console.log('üìß title:', title);
        
        try {
          console.log('üìß Inside try block, calling function now...');
          await sendNoteNotificationEmail(systemName, title);
          console.log('‚úÖ Email notifications sent successfully!');
          alert('‚úÖ Note uploaded successfully!\nüìß Email notifications sent to all students in the group.');
        } catch (emailError) {
          console.error('‚ùå Email notification failed:', emailError);
          console.error('‚ùå Error stack:', emailError.stack);
          alert('‚úÖ Note uploaded successfully!\n‚ö†Ô∏è Note: Email notifications failed to send. Please check console for details.');
        }
        
        // Reset form
        document.getElementById('singleUploadForm').reset();
        removeSingleFile();
        document.getElementById('singleClassDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('singleRequiresPayment').checked = true;
        
        // Hide group selector and uncheck all groups
        document.getElementById('videoGroupAccessContainer').style.display = 'none';
        ['A', 'B', 'C', 'D', 'E', 'F'].forEach(letter => {
          document.getElementById(`videoGroup${letter}`).checked = false;
        });

        // Reload notes if on library tab
        if (document.getElementById('tab-library').classList.contains('active')) {
          await loadNotes();
        }
        
        console.log('‚úÖ ====== UPLOAD PROCESS FULLY COMPLETE ======');

      } catch (error) {
        console.error('‚ùå ====== UPLOAD ERROR CAUGHT ======');
        console.error('‚ùå Upload error:', error);
        console.error('‚ùå Error stack:', error.stack);
        alert('Upload failed: ' + error.message);
      } finally {
        console.log('üîÑ Finally block executing...');
        btn.disabled = false;
        btn.textContent = 'üì§ Upload Note';
        setTimeout(() => {
          progress.classList.remove('active');
          progressFill.style.width = '0%';
        }, 2000);
      }
    }

    // ===== BULK UPLOAD =====
    async function handleBulkUpload(event) {
      event.preventDefault();

      if (bulkFiles.length === 0) {
        alert('Please select at least one PDF file');
        return;
      }

      const btn = document.getElementById('bulkUploadBtn');
      const progress = document.getElementById('bulkProgress');
      const progressFill = document.getElementById('bulkProgressFill');
      const progressText = document.getElementById('bulkProgressText');

      try {
        btn.disabled = true;
        btn.textContent = '‚è≥ Uploading...';
        progress.classList.add('active');

        const systemName = document.getElementById('bulkSystem').value;
        const classDate = document.getElementById('bulkClassDate').value;
        const requiresPayment = document.getElementById('bulkRequiresPayment').checked;

        let uploaded = 0;
        const total = bulkFiles.length;

        for (const file of bulkFiles) {
          progressText.textContent = `Uploading ${uploaded + 1}/${total}: ${file.name}`;
          progressFill.style.width = `${(uploaded / total) * 100}%`;

          const timestamp = Date.now() + uploaded; // Ensure unique filenames
          // Use hyphens everywhere for clean URLs (no spaces)
          const folderName = systemName.replace(/\s+/g, '-');
          const baseFileName = `${systemName}_${classDate}_${timestamp}`.replace(/\s+/g, '-');
          const filePath = `${folderName}/${baseFileName}.pdf`;

          // Upload to storage
          const { error: uploadError } = await supabase.storage
            .from(BUCKET_NAME)
            .upload(filePath, file, {
              cacheControl: '3600',
              upsert: false
            });

          if (uploadError) throw uploadError;

          // Save to database
          const { error: dbError } = await supabase
            .from('student_notes')
            .insert({
              title: file.name.replace('.pdf', ''),
              description: `Bulk uploaded - ${systemName}`,
              group_name: systemName,
              category: systemName, // ‚úÖ NEW: Link note to system via category column
              class_date: classDate,
              pdf_url: filePath,
              file_name: file.name,
              file_size: file.size,
              requires_payment: requiresPayment,
              is_system_note: true,
              deleted: false
            });

          if (dbError) throw dbError;

          uploaded++;
        }

        progressFill.style.width = '100%';
        progressText.textContent = `‚úÖ All ${total} files uploaded!`;

        // Send email notification to students
        console.log('üìß Starting email notification process for bulk upload...');
        try {
          await sendNoteNotificationEmail(systemName, `${total} new note(s)`);
          console.log('‚úÖ Email notifications sent successfully!');
          await customAlert('Upload Complete', `‚úÖ Successfully uploaded ${total} file${total === 1 ? '' : 's'}!\nüìß Email notifications sent to all students.`);
        } catch (emailError) {
          console.error('‚ùå Email notification failed:', emailError);
          await customAlert('Upload Complete', `‚úÖ Successfully uploaded ${total} file${total === 1 ? '' : 's'}!\n‚ö†Ô∏è Note: Email notifications failed to send.`);
        }

        // Reset form
        document.getElementById('bulkUploadForm').reset();
        bulkFiles = [];
        displayBulkFiles();
        document.getElementById('bulkFileInput').value = '';
        document.getElementById('bulkClassDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('bulkRequiresPayment').checked = true;

        // Reload notes if on library tab
        if (document.getElementById('tab-library').classList.contains('active')) {
          await loadNotes();
        }

      } catch (error) {
        console.error('Bulk upload error:', error);
        alert('Bulk upload failed: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üì¶ Upload All Files';
        setTimeout(() => {
          progress.classList.remove('active');
          progressFill.style.width = '0%';
        }, 2000);
      }
    }

    // ===== LOAD NOTES =====
    async function loadNotes() {
      const grid = document.getElementById('notesGrid');
      grid.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading notes...</div></div>';

      try {
        const { data: notes, error } = await supabase
          .from('student_notes')
          .select('*')
          .eq('deleted', false)
          .eq('is_system_note', true)
          .order('class_date', { ascending: false });

        if (error) throw error;

        allNotes = notes || [];
        filterNotes();

      } catch (error) {
        console.error('Load notes error:', error);
        grid.innerHTML = `
          <div class="empty-state">
            <div class="icon">‚ùå</div>
            <div class="text">Failed to load notes: ${error.message}</div>
          </div>
        `;
      }
    }

    // ===== FILTER NOTES =====
    function filterNotes() {
      const grid = document.getElementById('notesGrid');
      const systemFilter = document.getElementById('systemFilter').value;
      const searchInput = document.getElementById('searchInput').value.toLowerCase();

      let filtered = allNotes;

      // Filter by system
      if (systemFilter) {
        filtered = filtered.filter(note => note.group_name === systemFilter);
      }

      // Filter by search text
      if (searchInput) {
        filtered = filtered.filter(note => {
          const title = (note.title || '').toLowerCase();
          const description = (note.description || '').toLowerCase();
          const system = (note.group_name || '').toLowerCase();
          return title.includes(searchInput) || 
                 description.includes(searchInput) || 
                 system.includes(searchInput);
        });
      }

      if (filtered.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="icon">üì≠</div>
            <div class="text">No notes found${systemFilter ? ` for ${systemFilter}` : ''}${searchInput ? ` matching "${searchInput}"` : ''}</div>
          </div>
        `;
        return;
      }

      grid.innerHTML = filtered.map(note => `
        <div class="note-card" data-note-id="${note.id}">
          <div class="note-card-header">
            <label style="display: flex; align-items: center; cursor: pointer; margin-right: 12px;">
              <input 
                type="checkbox" 
                class="note-checkbox" 
                data-note-id="${note.id}"
                onchange="updateSelectedCount()"
                style="width: 18px; height: 18px; cursor: pointer;"
              >
            </label>
            <div style="flex: 1;">
              <div class="note-card-title">${note.title}</div>
              <div class="note-card-system">${note.group_name}</div>
            </div>
          </div>
          <div class="note-card-body">
            <div class="note-card-desc">${note.description || 'No description'}</div>
            <div class="note-card-meta">
              <span>üìÖ ${new Date(note.class_date).toLocaleDateString()}</span>
              <span>${note.requires_payment ? 'üîí Paid' : 'üîì Free'}</span>
              <span>üì¶ ${formatFileSize(note.file_size)}</span>
            </div>
          </div>
          <div class="note-card-actions">
            <button class="note-action-btn" onclick="viewNote('${note.pdf_url}')">
              üëÅÔ∏è View
            </button>
            <button class="note-action-btn" onclick="openReplaceFileDialog(${note.id}, '${encodeURIComponent(note.pdf_url || '')}', '${note.title.replace(/'/g, "\\'")}')">
              ‚ôªÔ∏è Replace PDF
            </button>
            <button class="note-action-btn danger" onclick="deleteNote(${note.id}, '${note.title.replace(/'/g, "\\'")}')">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    // ===== VIEW NOTE =====
    async function viewNote(filePath) {
      try {
        console.log('Attempting to view file at path:', filePath);
        
        const { data, error } = await supabase.storage
          .from(BUCKET_NAME)
          .createSignedUrl(filePath, 3600);

        if (error) {
          console.error('Storage error:', error);
          throw error;
        }
        
        console.log('Signed URL created:', data.signedUrl);
        window.open(data.signedUrl, '_blank');
      } catch (error) {
        console.error('Full error:', error);
        await customAlert('Error', 'Failed to view note: ' + error.message + '\nPath: ' + filePath);
      }
    }

    // ===== REPLACE NOTE FILE =====
    function openReplaceFileDialog(noteId, encodedPdfUrl, title) {
      const pdfUrl = decodeURIComponent(encodedPdfUrl || '');
      if (!pdfUrl) {
        alert('This note is missing a file path. Please delete and re-upload it instead.');
        return;
      }

      replaceTarget = { noteId, pdfUrl, title };
      const input = document.getElementById('replaceFileInput');
      if (!input) {
        alert('Replace input not found. Please reload the page and try again.');
        return;
      }

      input.value = '';
      input.click();
    }

    async function handleReplaceFile(event) {
      const file = event.target.files[0];

      if (!file) {
        replaceTarget = null;
        return;
      }

      if (!replaceTarget) {
        alert('Select a note to replace before choosing a file.');
        event.target.value = '';
        return;
      }

      if (file.type !== 'application/pdf') {
        alert('Please select a PDF file.');
        event.target.value = '';
        replaceTarget = null;
        return;
      }

      if (file.size > 50 * 1024 * 1024) {
        await customAlert('File Too Large', 'Files larger than 50MB are not supported.');
        event.target.value = '';
        replaceTarget = null;
        return;
      }

      const confirmed = await customConfirm('Replace PDF', `Replace "${replaceTarget.title}" with "${file.name}"?`);
      if (!confirmed) {
        event.target.value = '';
        replaceTarget = null;
        return;
      }

      try {
        const { error: uploadError } = await supabase.storage
          .from(BUCKET_NAME)
          .upload(replaceTarget.pdfUrl, file, {
            cacheControl: '3600',
            upsert: true
          });

        if (uploadError) throw uploadError;

        const { error: dbError } = await supabase
          .from('student_notes')
          .update({
            file_name: file.name,
            file_size: file.size
          })
          .eq('id', replaceTarget.noteId);

        if (dbError) throw dbError;

        const note = allNotes.find(n => n.id === replaceTarget.noteId);
        if (note) {
          note.file_name = file.name;
          note.file_size = file.size;
        }

        filterNotes();
        alert('‚úÖ PDF replaced successfully!');
      } catch (error) {
        console.error('Replace file error:', error);
        alert('Failed to replace PDF: ' + error.message);
      } finally {
        event.target.value = '';
        replaceTarget = null;
      }
    }

    // ===== DELETE NOTE =====
    async function deleteNote(noteId, title) {
      if (!confirm(`Are you sure you want to delete "${title}"?`)) return;

      try {
        // Get file path
        const { data: note, error: fetchError } = await supabase
          .from('student_notes')
          .select('pdf_url')
          .eq('id', noteId)
          .single();

        if (fetchError) throw fetchError;

        // Delete from storage
        if (note?.pdf_url) {
          const { error: storageError } = await supabase.storage
            .from(BUCKET_NAME)
            .remove([note.pdf_url]);

          if (storageError) console.warn('Storage delete warning:', storageError);
        }

        // Mark as deleted in database
        const { error: deleteError } = await supabase
          .from('student_notes')
          .update({ deleted: true })
          .eq('id', noteId);

        if (deleteError) throw deleteError;

        alert('‚úÖ Note deleted successfully!');
        await loadNotes();

      } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete note: ' + error.message);
      }
    }

    // ===== UTILITIES =====
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // ===== BULK DELETE =====
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllNotes');
      const checkboxes = document.querySelectorAll('.note-checkbox');
      
      checkboxes.forEach(cb => {
        const noteCard = cb.closest('.note-card');
        // Only toggle if the note card is visible (not hidden by search)
        if (noteCard && noteCard.style.display !== 'none') {
          cb.checked = selectAll.checked;
        }
      });
      
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.note-checkbox:checked');
      const count = checkboxes.length;
      const countEl = document.getElementById('selectedCount');
      const deleteBtn = document.getElementById('bulkDeleteBtn');
      const selectAll = document.getElementById('selectAllNotes');
      
      countEl.textContent = `${count} selected`;
      deleteBtn.disabled = count === 0;
      deleteBtn.style.opacity = count === 0 ? '0.5' : '1';
      deleteBtn.style.cursor = count === 0 ? 'not-allowed' : 'pointer';
      
      // Update select all checkbox state - only consider VISIBLE checkboxes
      const allVisibleCheckboxes = Array.from(document.querySelectorAll('.note-checkbox')).filter(cb => {
        const noteCard = cb.closest('.note-card');
        return noteCard && noteCard.style.display !== 'none';
      });
      const visibleCheckedCount = allVisibleCheckboxes.filter(cb => cb.checked).length;
      
      selectAll.checked = allVisibleCheckboxes.length > 0 && visibleCheckedCount === allVisibleCheckboxes.length;
      selectAll.indeterminate = visibleCheckedCount > 0 && visibleCheckedCount < allVisibleCheckboxes.length;
    }

    async function bulkDeleteNotes() {
      const checkboxes = document.querySelectorAll('.note-checkbox:checked');
      const noteIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.noteId));
      
      if (noteIds.length === 0) {
        alert('Please select notes to delete');
        return;
      }
      
      if (!confirm(`Delete ${noteIds.length} note(s)?\n\nThis will permanently remove the selected notes and their files from storage.`)) {
        return;
      }
      
      try {
        const deleteBtn = document.getElementById('bulkDeleteBtn');
        deleteBtn.textContent = '‚è≥ Deleting...';
        deleteBtn.disabled = true;
        
        let deleted = 0;
        let failed = 0;
        
        for (const noteId of noteIds) {
          try {
            // Get note details
            const note = allNotes.find(n => n.id === noteId);
            
            // Try to delete from storage (may fail if file doesn't exist)
            if (note?.pdf_url) {
              const { error: storageError } = await supabase.storage
                .from(BUCKET_NAME)
                .remove([note.pdf_url]);
              
              if (storageError) console.warn(`Storage delete warning for note ${noteId}:`, storageError);
            }
            
            // Mark as deleted in database
            const { error: deleteError } = await supabase
              .from('student_notes')
              .update({ deleted: true })
              .eq('id', noteId);
            
            if (deleteError) throw deleteError;
            
            deleted++;
          } catch (error) {
            console.error(`Failed to delete note ${noteId}:`, error);
            failed++;
          }
        }
        
        alert(`‚úÖ Deleted ${deleted} note(s)${failed > 0 ? `\n‚ùå Failed: ${failed}` : ''}`);
        
        // Uncheck select all
        document.getElementById('selectAllNotes').checked = false;
        
        // Reload notes
        await loadNotes();
        
      } catch (error) {
        console.error('Bulk delete error:', error);
        alert('Failed to delete notes: ' + error.message);
      } finally {
        const deleteBtn = document.getElementById('bulkDeleteBtn');
        deleteBtn.textContent = 'üóëÔ∏è Delete Selected';
        updateSelectedCount();
      }
    }


    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        supabase.auth.signOut();
        window.location.href = 'index.html';
      }
    }
  </script>
</body>
</html>

