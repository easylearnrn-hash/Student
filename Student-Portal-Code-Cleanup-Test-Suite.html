<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßπ HTML Code Cleanup Test Suite (Universal)</title>
    <script src="https://cdn.jsdelivr.net/npm/acorn@8.11.2/dist/acorn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/acorn-walk@8.3.0/dist/walk.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.6s ease-in;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .metric-card h3 {
            font-size: 0.85rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-card .label {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .issue-list {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
        }

        .issue-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #f5576c;
        }

        .issue-item.warning {
            border-left-color: #ffc107;
        }

        .issue-item.info {
            border-left-color: #4facfe;
        }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .issue-type {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .issue-severity {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .severity-critical {
            background: rgba(245, 87, 108, 0.3);
            color: #f5576c;
        }

        .severity-warning {
            background: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .severity-info {
            background: rgba(79, 172, 254, 0.3);
            color: #4facfe;
        }

        .issue-details {
            font-size: 0.85rem;
            line-height: 1.5;
            opacity: 0.9;
        }

        .issue-location {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 8px;
            display: inline-block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .test-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            padding: 5px;
            margin-bottom: 3px;
            display: flex;
            gap: 10px;
        }

        .log-entry.success { color: #38ef7d; }
        .log-entry.error { color: #f5576c; }
        .log-entry.warning { color: #ffc107; }
        .log-entry.info { color: #4facfe; }

        .timestamp {
            opacity: 0.7;
            min-width: 80px;
        }

        .summary-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .summary-box h3 {
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .file-input-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-area:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
        }

        .file-input-area input {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload Animation */
        @keyframes uploadPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 8px 32px 0 rgba(102, 126, 234, 0.6);
            }
        }

        @keyframes uploadSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .uploading {
            animation: uploadPulse 1.5s ease-in-out infinite;
            border-color: rgba(102, 126, 234, 0.8) !important;
        }

        .upload-success {
            animation: uploadSuccess 0.5s ease-out;
            border-color: rgba(56, 239, 125, 0.8) !important;
            background: rgba(56, 239, 125, 0.1) !important;
        }

        .file-stats {
            animation: fadeIn 0.5s ease-out;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßπ Universal HTML Code Cleanup Test Suite</h1>
            <p>Automated Code Quality Analysis for Any HTML File</p>
        </div>

        <!-- Metrics Dashboard -->
        <div class="glass-panel">
            <h2 style="margin-bottom: 15px;">üìä Detection Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Total Issues</h3>
                    <div class="value" style="color: #f5576c;" id="totalIssues">0</div>
                    <div class="label">Found</div>
                </div>
                <div class="metric-card">
                    <h3>Critical</h3>
                    <div class="value" style="color: #f5576c;" id="criticalIssues">0</div>
                    <div class="label">Must Fix</div>
                </div>
                <div class="metric-card">
                    <h3>Warnings</h3>
                    <div class="value" style="color: #ffc107;" id="warningIssues">0</div>
                    <div class="label">Should Fix</div>
                </div>
                <div class="metric-card">
                    <h3>Code Health</h3>
                    <div class="value" id="codeHealth">0%</div>
                    <div class="label">Score</div>
                </div>
                <div class="metric-card">
                    <h3>Lines Scanned</h3>
                    <div class="value" id="linesScanned">0</div>
                    <div class="label">Total</div>
                </div>
                <div class="metric-card">
                    <h3>Functions</h3>
                    <div class="value" id="functionCount">0</div>
                    <div class="label">Detected</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
            </div>
        </div>

        <!-- File Upload -->
        <div class="glass-panel">
            <h2 style="margin-bottom: 15px;">üìÅ Load HTML File</h2>
            <div class="file-input-area" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept=".html" onchange="loadFile(event)">
                <p style="font-size: 1.2rem; margin-bottom: 10px;">üìÑ Click to upload any HTML file</p>
                <p style="opacity: 0.8; font-size: 0.9rem;">Works with: student-portal.html, Calendar.html, Test-Manager.html, etc.</p>
            </div>
            <div id="fileStats"></div>
            <div>
                <button class="btn btn-primary" onclick="runAllTests()">üîç Run Full Analysis</button>
                <button class="btn btn-success" onclick="exportReport()">üíæ Export Report</button>
                <button class="btn btn-danger" onclick="clearResults()">üóëÔ∏è Clear Results</button>
            </div>
        </div>

        <!-- Test Categories -->
        <div class="glass-panel">
            <h2 style="margin-bottom: 15px;">üß™ Test Categories</h2>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('all')">All Issues</div>
                <div class="tab" onclick="switchTab('unused')">Unused Code</div>
                <div class="tab" onclick="switchTab('duplicates')">Duplicates</div>
                <div class="tab" onclick="switchTab('forbidden')">Forbidden Code</div>
                <div class="tab" onclick="switchTab('dom')">DOM Issues</div>
                <div class="tab" onclick="switchTab('log')">Test Log</div>
            </div>

            <div id="tab-all" class="tab-content active">
                <h3 style="margin-bottom: 15px;">All Detected Issues</h3>
                <div class="issue-list" id="allIssuesList"></div>
            </div>

            <div id="tab-unused" class="tab-content">
                <h3 style="margin-bottom: 15px;">Unused Code Detection</h3>
                <div class="issue-list" id="unusedIssuesList"></div>
            </div>

            <div id="tab-duplicates" class="tab-content">
                <h3 style="margin-bottom: 15px;">Duplicate Logic Detection</h3>
                <div class="issue-list" id="duplicateIssuesList"></div>
            </div>

            <div id="tab-forbidden" class="tab-content">
                <h3 style="margin-bottom: 15px;">Forbidden Code Patterns</h3>
                <div class="issue-list" id="forbiddenIssuesList"></div>
            </div>

            <div id="tab-dom" class="tab-content">
                <h3 style="margin-bottom: 15px;">DOM & CSS Issues</h3>
                <div class="issue-list" id="domIssuesList"></div>
            </div>

            <div id="tab-log" class="tab-content">
                <h3 style="margin-bottom: 15px;">Test Execution Log</h3>
                <div class="test-log" id="testLog"></div>
            </div>
        </div>

        <!-- Summary Report -->
        <div class="glass-panel">
            <h2>üìã Cleanup Summary</h2>
            <div class="summary-box" id="summaryBox">
                <p style="text-align: center; opacity: 0.7;">Run analysis to generate summary...</p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let fileContent = '';
        let fileName = '';
        let allIssues = [];
        let astTree = null;

        // Issue tracking
        const issues = {
            unused: [],
            duplicates: [],
            forbidden: [],
            dom: [],
            deadCode: []
        };

        // Load file
        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) {
                log('‚ùå No file selected', 'error');
                return;
            }

            if (!file.name.endsWith('.html')) {
                log('‚ùå Please select an HTML file', 'error');
                return;
            }

            fileName = file.name;
            const dropArea = document.querySelector('.file-input-area');
            const fileStats = document.getElementById('fileStats');
            
            // Start upload animation
            dropArea.classList.add('uploading');
            log(`<span class="spinner"></span>Reading ${fileName}...`, 'info');
            
            const reader = new FileReader();
            
            reader.onerror = function() {
                dropArea.classList.remove('uploading');
                log('‚ùå Failed to read file', 'error');
            };
            
            reader.onload = function(e) {
                fileContent = e.target.result;
                const lineCount = fileContent.split('\n').length;
                const sizeKB = (fileContent.length / 1024).toFixed(2);
                
                // Success animation
                dropArea.classList.remove('uploading');
                dropArea.classList.add('upload-success');
                setTimeout(() => dropArea.classList.remove('upload-success'), 500);
                
                // Show file stats with animation
                if (fileStats) {
                    fileStats.innerHTML = `
                        <div class="file-stats">
                            <strong>‚úÖ ${fileName}</strong><br>
                            üìä Size: ${sizeKB} KB | üìÑ Lines: ${lineCount.toLocaleString()}
                        </div>
                    `;
                }
                
                log(`‚úÖ Loaded ${fileName} (${fileContent.length.toLocaleString()} characters)`, 'success');
                log(`‚ÑπÔ∏è File contains ${lineCount.toLocaleString()} lines`, 'info');
                updateMetric('linesScanned', lineCount);
            };
            
            reader.readAsText(file);
        }

        // Drag and drop support
        function setupDragDrop() {
            const dropArea = document.querySelector('.file-input-area');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.style.borderColor = 'rgba(255, 255, 255, 0.8)';
                    dropArea.style.background = 'rgba(255, 255, 255, 0.1)';
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    dropArea.style.background = 'transparent';
                }, false);
            });

            dropArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const file = files[0];
                    if (!file) return;

                    if (!file.name.endsWith('.html')) {
                        log('‚ùå Please select an HTML file', 'error');
                        return;
                    }

                    fileName = file.name;
                    const fileStats = document.getElementById('fileStats');
                    
                    // Start upload animation
                    dropArea.classList.add('uploading');
                    log(`<span class="spinner"></span>Reading ${fileName}...`, 'info');
                    
                    const reader = new FileReader();
                    
                    reader.onerror = function() {
                        dropArea.classList.remove('uploading');
                        log('‚ùå Failed to read file', 'error');
                    };
                    
                    reader.onload = function(e) {
                        fileContent = e.target.result;
                        const lineCount = fileContent.split('\n').length;
                        const sizeKB = (fileContent.length / 1024).toFixed(2);
                        
                        // Success animation
                        dropArea.classList.remove('uploading');
                        dropArea.classList.add('upload-success');
                        setTimeout(() => dropArea.classList.remove('upload-success'), 500);
                        
                        // Show file stats with animation
                        if (fileStats) {
                            fileStats.innerHTML = `
                                <div class="file-stats">
                                    <strong>‚úÖ ${fileName}</strong><br>
                                    üìä Size: ${sizeKB} KB | üìÑ Lines: ${lineCount.toLocaleString()}
                                </div>
                            `;
                        }
                        
                        log(`‚úÖ Loaded ${fileName} (${fileContent.length.toLocaleString()} characters)`, 'success');
                        log(`‚ÑπÔ∏è File contains ${lineCount.toLocaleString()} lines`, 'info');
                        updateMetric('linesScanned', lineCount);
                    };
                    
                    reader.readAsText(file);
                }
            }, false);
        }

        // Logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="timestamp">${timestamp}</span><span>${message}</span>`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Update metrics
        function updateMetric(metricId, value) {
            const element = document.getElementById(metricId);
            if (element) {
                element.textContent = value;
            }
        }

        // Add issue
        function addIssue(category, type, message, location, severity = 'critical') {
            const issue = {
                category,
                type,
                message,
                location,
                severity,
                timestamp: new Date().toISOString()
            };
            
            issues[category].push(issue);
            allIssues.push(issue);
            
            updateMetric('totalIssues', allIssues.length);
            updateMetric('criticalIssues', allIssues.filter(i => i.severity === 'critical').length);
            updateMetric('warningIssues', allIssues.filter(i => i.severity === 'warning').length);
            
            const health = Math.max(0, 100 - (allIssues.length * 2));
            updateMetric('codeHealth', health + '%');
        }

        // Display issues
        function displayIssues() {
            // Clear all lists (check if elements exist first)
            ['all', 'unused', 'duplicates', 'forbidden', 'dom'].forEach(cat => {
                const element = document.getElementById(`${cat}IssuesList`);
                if (element) {
                    element.innerHTML = '';
                }
            });

            // Display all issues
            allIssues.forEach(issue => {
                const issueElement = createIssueElement(issue);
                const allList = document.getElementById('allIssuesList');
                if (allList) {
                    allList.appendChild(issueElement);
                }
                
                if (issue.category !== 'deadCode') {
                    const categoryList = document.getElementById(`${issue.category}IssuesList`);
                    if (categoryList) {
                        categoryList.appendChild(issueElement.cloneNode(true));
                    }
                }
            });

            generateSummary();
        }

        // Create issue element
        function createIssueElement(issue) {
            const div = document.createElement('div');
            div.className = `issue-item ${issue.severity === 'warning' ? 'warning' : issue.severity === 'info' ? 'info' : ''}`;
            
            div.innerHTML = `
                <div class="issue-header">
                    <div class="issue-type">${issue.type}</div>
                    <div class="issue-severity severity-${issue.severity}">${issue.severity.toUpperCase()}</div>
                </div>
                <div class="issue-details">${issue.message}</div>
                <div class="issue-location">üìç ${issue.location}</div>
            `;
            
            return div;
        }

        // Generate summary
        function generateSummary() {
            const summaryBox = document.getElementById('summaryBox');
            
            if (allIssues.length === 0) {
                summaryBox.innerHTML = '<p style="text-align: center; color: #38ef7d; font-size: 1.2rem;">‚úÖ NO ISSUES FOUND! Code is clean!</p>';
                return;
            }

            const summary = `
                <div class="summary-item">
                    <span>Total Issues Found:</span>
                    <strong style="color: #f5576c;">${allIssues.length}</strong>
                </div>
                <div class="summary-item">
                    <span>Unused Code:</span>
                    <strong>${issues.unused.length}</strong>
                </div>
                <div class="summary-item">
                    <span>Duplicate Logic:</span>
                    <strong>${issues.duplicates.length}</strong>
                </div>
                <div class="summary-item">
                    <span>Forbidden Patterns:</span>
                    <strong>${issues.forbidden.length}</strong>
                </div>
                <div class="summary-item">
                    <span>DOM Issues:</span>
                    <strong>${issues.dom.length}</strong>
                </div>
                <div class="summary-item">
                    <span>Dead Code Paths:</span>
                    <strong>${issues.deadCode.length}</strong>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <strong style="color: #f5576c;">‚ö†Ô∏è ACTION REQUIRED:</strong>
                    <p style="margin-top: 10px; line-height: 1.6;">
                        ${allIssues.length} issue(s) detected. Review each item above and remove or fix the problematic code.
                        Re-run this test suite after cleanup until you achieve 0 issues.
                    </p>
                </div>
            `;
            
            summaryBox.innerHTML = summary;
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Export report
        function exportReport() {
            const report = {
                fileName: fileName,
                timestamp: new Date().toISOString(),
                summary: {
                    totalIssues: allIssues.length,
                    critical: allIssues.filter(i => i.severity === 'critical').length,
                    warnings: allIssues.filter(i => i.severity === 'warning').length,
                    codeHealth: Math.max(0, 100 - (allIssues.length * 2))
                },
                issues: allIssues,
                categories: issues
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Generate filename based on uploaded HTML file
            // Example: "student-portal.html" ‚Üí "student-portal-cleanup-report-1702234567890.json"
            const baseFileName = fileName.replace('.html', '');
            a.download = `${baseFileName}-cleanup-report-${Date.now()}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log(`Report exported as: ${baseFileName}-cleanup-report-${Date.now()}.json`, 'success');
        }

        // Clear results
        function clearResults() {
            allIssues = [];
            Object.keys(issues).forEach(key => issues[key] = []);
            
            ['all', 'unused', 'duplicates', 'forbidden', 'dom'].forEach(cat => {
                document.getElementById(`${cat}IssuesList`).innerHTML = '';
            });
            
            document.getElementById('testLog').innerHTML = '';
            document.getElementById('summaryBox').innerHTML = '<p style="text-align: center; opacity: 0.7;">Run analysis to generate summary...</p>';
            
            updateMetric('totalIssues', 0);
            updateMetric('criticalIssues', 0);
            updateMetric('warningIssues', 0);
            updateMetric('codeHealth', '0%');
            
            log('Results cleared', 'info');
        }

        // ============================================================
        // TEST 1: UNUSED VARIABLES & FUNCTIONS
        // ============================================================
        function detectUnusedCode() {
            log('üîç Test 1: Detecting unused variables and functions...', 'info');
            
            if (!fileContent) {
                log('No file loaded', 'error');
                return;
            }

            // Extract JavaScript code from HTML
            const scriptMatches = fileContent.matchAll(/<script[^>]*>([\s\S]*?)<\/script>/gi);
            let jsCode = '';
            for (const match of scriptMatches) {
                jsCode += match[1] + '\n';
            }

            // Find all variable declarations
            const varRegex = /(?:let|const|var)\s+([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=/g;
            const variables = new Set();
            let match;
            
            while ((match = varRegex.exec(jsCode)) !== null) {
                variables.add(match[1]);
            }

            // Find all function declarations
            const funcRegex = /function\s+([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\(/g;
            const functions = new Set();
            
            while ((match = funcRegex.exec(jsCode)) !== null) {
                functions.add(match[1]);
            }

            updateMetric('functionCount', functions.size);

            // Check for unused variables
            variables.forEach(varName => {
                const usageRegex = new RegExp(`\\b${varName}\\b`, 'g');
                const matches = jsCode.match(usageRegex);
                
                if (matches && matches.length <= 1) { // Only declaration, no usage
                    const lineNumber = getLineNumber(jsCode, varName);
                    addIssue(
                        'unused',
                        'Unused Variable',
                        `Variable "${varName}" is declared but never used`,
                        `Line ${lineNumber}`,
                        'warning'
                    );
                }
            });

            // Check for unused functions
            functions.forEach(funcName => {
                // Skip if it's an event handler or exported
                if (funcName.startsWith('on') || funcName === 'init' || funcName === 'main') {
                    return;
                }

                const usageRegex = new RegExp(`\\b${funcName}\\s*\\(`, 'g');
                const matches = jsCode.match(usageRegex);
                
                if (matches && matches.length <= 1) { // Only declaration, no calls
                    const lineNumber = getLineNumber(jsCode, funcName);
                    addIssue(
                        'unused',
                        'Unused Function',
                        `Function "${funcName}" is defined but never called`,
                        `Line ${lineNumber}`,
                        'critical'
                    );
                }
            });

            log(`‚úÖ Found ${variables.size} variables and ${functions.size} functions`, 'success');
        }

        // ============================================================
        // TEST 2: DUPLICATE LOGIC DETECTION
        // ============================================================
        function detectDuplicates() {
            log('üîç Test 2: Detecting duplicate logic...', 'info');
            
            if (!fileContent) {
                log('No file loaded', 'error');
                return;
            }

            // Extract all function bodies
            const funcRegex = /function\s+([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\([^)]*\)\s*{([^}]*)}/g;
            const functions = [];
            let match;

            const scriptMatches = fileContent.matchAll(/<script[^>]*>([\s\S]*?)<\/script>/gi);
            let jsCode = '';
            for (const scriptMatch of scriptMatches) {
                jsCode += scriptMatch[1] + '\n';
            }

            while ((match = funcRegex.exec(jsCode)) !== null) {
                functions.push({
                    name: match[1],
                    body: match[2].trim(),
                    fullMatch: match[0]
                });
            }

            // Hash and compare function bodies
            const bodyMap = new Map();
            
            functions.forEach((func, index) => {
                const normalizedBody = func.body.replace(/\s+/g, ' ').toLowerCase();
                const hash = simpleHash(normalizedBody);
                
                if (bodyMap.has(hash)) {
                    const original = bodyMap.get(hash);
                    const line1 = getLineNumber(jsCode, original.name);
                    const line2 = getLineNumber(jsCode, func.name);
                    
                    addIssue(
                        'duplicates',
                        'Duplicate Function',
                        `Function "${func.name}" appears to be a duplicate of "${original.name}"`,
                        `Lines ${line1} and ${line2}`,
                        'critical'
                    );
                } else {
                    bodyMap.set(hash, func);
                }
            });

            log(`‚úÖ Analyzed ${functions.length} functions for duplicates`, 'success');
        }

        // ============================================================
        // TEST 3: FORBIDDEN CODE PATTERNS
        // ============================================================
        function detectForbiddenCode() {
            log('üîç Test 3: Detecting forbidden code patterns...', 'info');
            
            if (!fileContent) {
                log('No file loaded', 'error');
                return;
            }

            const forbiddenPatterns = [
                { pattern: /\/\/\s*old/gi, name: '// old comments', severity: 'critical' },
                { pattern: /\/\/\s*deprecated/gi, name: '// deprecated comments', severity: 'critical' },
                { pattern: /console\.log\(/g, name: 'console.log()', severity: 'warning' },
                { pattern: /console\.debug\(/g, name: 'console.debug()', severity: 'warning' },
                { pattern: /debugger;/g, name: 'debugger statement', severity: 'critical' },
                { pattern: /test-\w+/g, name: 'test- prefixes', severity: 'warning' },
                { pattern: /TODO:/gi, name: 'TODO comments', severity: 'info' },
                { pattern: /FIXME:/gi, name: 'FIXME comments', severity: 'warning' },
                { pattern: /HACK:/gi, name: 'HACK comments', severity: 'warning' },
                { pattern: /2025-10-03/g, name: 'Hardcoded date (2025-10-03)', severity: 'critical' },
                { pattern: /resolveNotesOld/g, name: 'Old resolver function', severity: 'critical' },
                { pattern: /\/\/\s*temporary/gi, name: '// temporary comments', severity: 'critical' },
                { pattern: /alert\(/g, name: 'alert() calls', severity: 'warning' },
                { pattern: /var\s+/g, name: 'var declarations (use let/const)', severity: 'info' }
            ];

            forbiddenPatterns.forEach(({ pattern, name, severity }) => {
                let match;
                const matches = [];
                
                while ((match = pattern.exec(fileContent)) !== null) {
                    matches.push(match);
                }

                matches.forEach(m => {
                    const lineNumber = getLineNumber(fileContent, m[0], m.index);
                    addIssue(
                        'forbidden',
                        'Forbidden Pattern',
                        `Found forbidden pattern: ${name}`,
                        `Line ${lineNumber}`,
                        severity
                    );
                });
            });

            log('‚úÖ Forbidden pattern scan complete', 'success');
        }

        // ============================================================
        // TEST 4: DOM & CSS ISSUES
        // ============================================================
        function detectDOMIssues() {
            log('üîç Test 4: Detecting DOM and CSS issues...', 'info');
            
            if (!fileContent) {
                log('No file loaded', 'error');
                return;
            }

            // Check for duplicate IDs
            const idRegex = /id=["']([^"']+)["']/g;
            const ids = new Map();
            let match;

            while ((match = idRegex.exec(fileContent)) !== null) {
                const id = match[1];
                if (ids.has(id)) {
                    ids.get(id).push(getLineNumber(fileContent, match[0], match.index));
                } else {
                    ids.set(id, [getLineNumber(fileContent, match[0], match.index)]);
                }
            }

            ids.forEach((lines, id) => {
                if (lines.length > 1) {
                    addIssue(
                        'dom',
                        'Duplicate ID',
                        `ID "${id}" appears ${lines.length} times (must be unique)`,
                        `Lines ${lines.join(', ')}`,
                        'critical'
                    );
                }
            });

            // Check for potential memory leaks (event listeners without cleanup)
            const eventListeners = fileContent.match(/addEventListener\(/g);
            const removeListeners = fileContent.match(/removeEventListener\(/g);
            
            if (eventListeners && removeListeners) {
                const ratio = removeListeners.length / eventListeners.length;
                if (ratio < 0.3) {
                    addIssue(
                        'dom',
                        'Potential Memory Leak',
                        `Found ${eventListeners.length} addEventListener calls but only ${removeListeners.length} removeEventListener calls`,
                        'Global',
                        'warning'
                    );
                }
            }

            log('‚úÖ DOM analysis complete', 'success');
        }

        // ============================================================
        // TEST 5: DEAD CODE PATH DETECTION
        // ============================================================
        function detectDeadCodePaths() {
            log('üîç Test 5: Detecting dead code paths...', 'info');
            
            if (!fileContent) {
                log('No file loaded', 'error');
                return;
            }

            // Check for unreachable code after return
            const unreachableRegex = /return[^;]*;\\s*\\n\\s*(?!})[a-zA-Z]/g;
            let match;

            while ((match = unreachableRegex.exec(fileContent)) !== null) {
                const lineNumber = getLineNumber(fileContent, match[0], match.index);
                addIssue(
                    'deadCode',
                    'Unreachable Code',
                    'Code appears after return statement (will never execute)',
                    `Line ${lineNumber}`,
                    'critical'
                );
            }

            // Check for always-false conditions
            const alwaysFalseRegex = /if\\s*\\(\\s*false\\s*\\)/g;
            while ((match = alwaysFalseRegex.exec(fileContent)) !== null) {
                const lineNumber = getLineNumber(fileContent, match[0], match.index);
                addIssue(
                    'deadCode',
                    'Dead Code Path',
                    'Condition is always false (code block never executes)',
                    `Line ${lineNumber}`,
                    'critical'
                );
            }

            log('‚úÖ Dead code path detection complete', 'success');
        }

        // ============================================================
        // HELPER FUNCTIONS
        // ============================================================
        function getLineNumber(text, searchString, startIndex = 0) {
            const index = startIndex || text.indexOf(searchString);
            if (index === -1) return 'Unknown';
            
            const lines = text.substring(0, index).split('\n');
            return lines.length;
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        // ============================================================
        // MAIN TEST RUNNER
        // ============================================================
        async function runAllTests() {
            if (!fileContent) {
                alert('Please load a file first!');
                return;
            }

            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log('üöÄ Starting Full Code Cleanup Analysis', 'info');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

            // Clear previous results
            allIssues = [];
            Object.keys(issues).forEach(key => issues[key] = []);

            // Run all tests
            const tests = [
                { name: 'Unused Code Detection', fn: detectUnusedCode, progress: 20 },
                { name: 'Duplicate Logic Detection', fn: detectDuplicates, progress: 40 },
                { name: 'Forbidden Code Patterns', fn: detectForbiddenCode, progress: 60 },
                { name: 'DOM & CSS Issues', fn: detectDOMIssues, progress: 80 },
                { name: 'Dead Code Paths', fn: detectDeadCodePaths, progress: 100 }
            ];

            for (const test of tests) {
                log(`Running: ${test.name}...`, 'info');
                await new Promise(resolve => setTimeout(resolve, 100));
                test.fn();
                updateProgress(test.progress);
            }

            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log(`‚úÖ Analysis complete! Found ${allIssues.length} issues`, allIssues.length === 0 ? 'success' : 'error');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

            displayIssues();
        }

        function updateProgress(percent) {
            const fill = document.getElementById('progressFill');
            fill.style.width = `${percent}%`;
            fill.textContent = `${percent}%`;
        }

        // Initialize
        window.addEventListener('load', () => {
            log('üßπ Universal HTML Code Cleanup Test Suite loaded and ready', 'success');
            log('üìÅ Upload any HTML file to begin analysis', 'info');
            log('üí° Works with: student-portal.html, Calendar.html, Test-Manager.html, etc.', 'info');
            setupDragDrop();
        });
    </script>
</body>
</html>
